/*!
 * Copyright (c) 2020 Melown Technologies SE
 *  *  For terms of use, see accompanying vts-core file.
 *  *  For 3rd party libraries licenses, see 3rdpartylicenses.txt.
 * 
 */
var vts=function(e){var t={};function r(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(i,a,function(t){return e[t]}.bind(null,a));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=15)}([function(e,t,r){"use strict";r.d(t,"c",(function(){return i})),r.d(t,"d",(function(){return s})),r.d(t,"e",(function(){return a})),r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return o}));var i={create:function(e){var t=new Array(2);return e&&(t[0]=e[0],t[1]=e[1]),t}},a={create:function(e){var t=new Array(4);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},dot2:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]},dot3:function(e,t,r,i,a,s){return e[0]*(t[r]-i)+e[1]*(t[r+1]-a)+e[2]*(t[r+2]-s)+e[3]}},s={create:function(e){var t=new Array(3);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},add:function(e,t,r){return r&&e!=r?(r[0]=e[0]+t[0],r[1]=e[1]+t[1],r[2]=e[2]+t[2],r):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},subtract:function(e,t,r){return r&&e!=r?(r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],r):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},negate:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},scale:function(e,t,r){return r&&e!=r?(r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t,r):(e[0]*=t,e[1]*=t,e[2]*=t,e)},normalize:function(e,t){t||(t=e);var r=e[0],i=e[1],a=e[2],s=Math.sqrt(r*r+i*i+a*a);return s?1==s?(t[0]=r,t[1]=i,t[2]=a,t):(s=1/s,t[0]=r*s,t[1]=i*s,t[2]=a*s,t):(t[0]=0,t[1]=0,t[2]=0,t)},normalize2:function(e,t,r){var i=e[t],a=e[t+1],s=e[t+2],n=Math.sqrt(i*i+a*a+s*s);return n?1==n?(r[0]=i,r[1]=a,r[2]=s,r):(n=1/n,r[0]=i*n,r[1]=a*n,void(r[2]=s*n)):(r[0]=0,r[1]=0,r[2]=0,r)},normalize3:function(e,t,r,i){var a=e[t],s=e[t+1],n=e[t+2],o=Math.sqrt(a*a+s*s+n*n);return o?1==o?(r[i]=a,r[i+1]=s,r[i+2]=n,r):(o=1/o,r[i]=a*o,r[i+1]=s*o,void(r[i+2]=n*o)):(r[i]=0,r[i+1]=0,r[i+2]=0,r)},normalize4:function(e,t){t||(t=e);var r=e[0],i=e[1],a=e[2],s=Math.sqrt(r*r+i*i+a*a);if(!s)return t[0]=0,t[1]=0,t[2]=0,t;if(1==s)return t[0]=r,t[1]=i,t[2]=a,t;var n=s;return s=1/s,t[0]=r*s,t[1]=i*s,t[2]=a*s,n},cross:function(e,t,r){r||(r=e);var i=e[0],a=e[1];e=e[2];var s=t[0],n=t[1];return t=t[2],r[0]=a*t-e*n,r[1]=e*s-i*t,r[2]=i*n-a*s,r},length:function(e){var t=e[0],r=e[1];return e=e[2],Math.sqrt(t*t+r*r+e*e)},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dot2:function(e,t,r){return e[0]*t[r]+e[1]*t[r+1]+e[2]*t[r+2]},dot3:function(e,t,r,i){return e[t]*r[i]+e[t+1]*r[i+1]+e[t+2]*r[i+2]},distance:function(e,t){var r=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(r*r+i*i+a*a)},squareDistance:function(e,t){var r=t[0]-e[0],i=t[1]-e[1],a=t[2]-e[2];return r*r+i*i+a*a},direction:function(e,t,r){r||(r=e);var i=e[0]-t[0],a=e[1]-t[1];return e=e[2]-t[2],(t=Math.sqrt(i*i+a*a+e*e))?(t=1/t,r[0]=i*t,r[1]=a*t,r[2]=e*t,r):(r[0]=0,r[1]=0,r[2]=0,r)},lerp:function(e,t,r,i){return i||(i=e),i[0]=e[0]+r*(t[0]-e[0]),i[1]=e[1]+r*(t[1]-e[1]),i[2]=e[2]+r*(t[2]-e[2]),i},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"}},n={create:function(e){var t=new Array(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},transpose:function(e,t){if(!t||e==t){var r=e[1],i=e[2],a=e[5];return e[1]=e[3],e[2]=e[6],e[3]=r,e[5]=e[7],e[6]=i,e[7]=a,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},toMat4:function(e,t){return t||(t=o.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},multiplyVec3:function(e,t,r){r||(r=t);var i=t[0],a=t[1];return t=t[2],r[0]=e[0]*i+e[3]*a+e[6]*t,r[1]=e[1]*i+e[4]*a+e[7]*t,r[2]=e[2]*i+e[5]*a+e[8]*t,r},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"}},o={create:function(e){var t=new Array(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},transpose:function(e,t){if(!t||e==t){var r=e[1],i=e[2],a=e[3],s=e[6],n=e[7],o=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=r,e[6]=e[9],e[7]=e[13],e[8]=i,e[9]=s,e[11]=e[14],e[12]=a,e[13]=n,e[14]=o,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},determinant:function(e){var t=e[0],r=e[1],i=e[2],a=e[3],s=e[4],n=e[5],o=e[6],h=e[7],l=e[8],u=e[9],d=e[10],c=e[11],p=e[12],f=e[13],m=e[14];return p*u*o*a-l*f*o*a-p*n*d*a+s*f*d*a+l*n*m*a-s*u*m*a-p*u*i*h+l*f*i*h+p*r*d*h-t*f*d*h-l*r*m*h+t*u*m*h+p*n*i*c-s*f*i*c-p*r*o*c+t*f*o*c+s*r*m*c-t*n*m*c-l*n*i*(e=e[15])+s*u*i*e+l*r*o*e-t*u*o*e-s*r*d*e+t*n*d*e},inverse:function(e,t){t||(t=e);var r=e[0],i=e[1],a=e[2],s=e[3],n=e[4],o=e[5],h=e[6],l=e[7],u=e[8],d=e[9],c=e[10],p=e[11],f=e[12],m=e[13],g=e[14],v=e[15],y=r*o-i*n,b=r*h-a*n,x=r*l-s*n,S=i*h-a*o,M=i*l-s*o,w=a*l-s*h,T=u*m-d*f,A=u*g-c*f,C=u*v-p*f,F=d*g-c*m,P=d*v-p*m,L=c*v-p*g,E=1/(y*L-b*P+x*F+S*C-M*A+w*T);return t[0]=(o*L-h*P+l*F)*E,t[1]=(-i*L+a*P-s*F)*E,t[2]=(m*w-g*M+v*S)*E,t[3]=(-d*w+c*M-p*S)*E,t[4]=(-n*L+h*C-l*A)*E,t[5]=(r*L-a*C+s*A)*E,t[6]=(-f*w+g*x-v*b)*E,t[7]=(u*w-c*x+p*b)*E,t[8]=(n*P-o*C+l*T)*E,t[9]=(-r*P+i*C-s*T)*E,t[10]=(f*M-m*x+v*y)*E,t[11]=(-u*M+d*x-p*y)*E,t[12]=(-n*F+o*A-h*T)*E,t[13]=(r*F-i*A+a*T)*E,t[14]=(-f*S+m*b-g*y)*E,t[15]=(u*S-d*b+c*y)*E,t},toRotationMat:function(e,t){return t||(t=o.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},toMat3:function(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},toInverseMat3:function(e,t){var r=e[0],i=e[1],a=e[2],s=e[4],o=e[5],h=e[6],l=e[8],u=e[9],d=e[10],c=d*o-h*u,p=-d*s+h*l,f=u*s-o*l,m=r*c+i*p+a*f;return m?(m=1/m,t||(t=n.create()),t[0]=c*m,t[1]=(-d*i+a*u)*m,t[2]=(h*i-a*o)*m,t[3]=p*m,t[4]=(d*r-a*l)*m,t[5]=(-h*r+a*s)*m,t[6]=f*m,t[7]=(-u*r+i*l)*m,t[8]=(o*r-i*s)*m,t):null},multiply:function(e,t,r){r||(r=e);var i=e[0],a=e[1],s=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],d=e[8],c=e[9],p=e[10],f=e[11],m=e[12],g=e[13],v=e[14];e=e[15];var y=t[0],b=t[1],x=t[2],S=t[3],M=t[4],w=t[5],T=t[6],A=t[7],C=t[8],F=t[9],P=t[10],L=t[11],E=t[12],N=t[13],B=t[14];return t=t[15],r[0]=y*i+b*o+x*d+S*m,r[1]=y*a+b*h+x*c+S*g,r[2]=y*s+b*l+x*p+S*v,r[3]=y*n+b*u+x*f+S*e,r[4]=M*i+w*o+T*d+A*m,r[5]=M*a+w*h+T*c+A*g,r[6]=M*s+w*l+T*p+A*v,r[7]=M*n+w*u+T*f+A*e,r[8]=C*i+F*o+P*d+L*m,r[9]=C*a+F*h+P*c+L*g,r[10]=C*s+F*l+P*p+L*v,r[11]=C*n+F*u+P*f+L*e,r[12]=E*i+N*o+B*d+t*m,r[13]=E*a+N*h+B*c+t*g,r[14]=E*s+N*l+B*p+t*v,r[15]=E*n+N*u+B*f+t*e,r},multiplyVec3:function(e,t,r){r||(r=t);var i=t[0],a=t[1];return t=t[2],r[0]=e[0]*i+e[4]*a+e[8]*t+e[12],r[1]=e[1]*i+e[5]*a+e[9]*t+e[13],r[2]=e[2]*i+e[6]*a+e[10]*t+e[14],r},multiplyVec4:function(e,t,r){r||(r=t);var i=t[0],a=t[1],s=t[2];return t=t[3],r[0]=e[0]*i+e[4]*a+e[8]*s+e[12]*t,r[1]=e[1]*i+e[5]*a+e[9]*s+e[13]*t,r[2]=e[2]*i+e[6]*a+e[10]*s+e[14]*t,r[3]=e[3]*i+e[7]*a+e[11]*s+e[15]*t,r},translate:function(e,t,r){var i=t[0],a=t[1];if(t=t[2],!r||e==r)return e[12]=e[0]*i+e[4]*a+e[8]*t+e[12],e[13]=e[1]*i+e[5]*a+e[9]*t+e[13],e[14]=e[2]*i+e[6]*a+e[10]*t+e[14],e[15]=e[3]*i+e[7]*a+e[11]*t+e[15],e;var s=e[0],n=e[1],o=e[2],h=e[3],l=e[4],u=e[5],d=e[6],c=e[7],p=e[8],f=e[9],m=e[10],g=e[11];return r[0]=s,r[1]=n,r[2]=o,r[3]=h,r[4]=l,r[5]=u,r[6]=d,r[7]=c,r[8]=p,r[9]=f,r[10]=m,r[11]=g,r[12]=s*i+l*a+p*t+e[12],r[13]=n*i+u*a+f*t+e[13],r[14]=o*i+d*a+m*t+e[14],r[15]=h*i+c*a+g*t+e[15],r},scale:function(e,t,r){var i=t[0],a=t[1];return t=t[2],r&&e!=r?(r[0]=e[0]*i,r[1]=e[1]*i,r[2]=e[2]*i,r[3]=e[3]*i,r[4]=e[4]*a,r[5]=e[5]*a,r[6]=e[6]*a,r[7]=e[7]*a,r[8]=e[8]*t,r[9]=e[9]*t,r[10]=e[10]*t,r[11]=e[11]*t,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r):(e[0]*=i,e[1]*=i,e[2]*=i,e[3]*=i,e[4]*=a,e[5]*=a,e[6]*=a,e[7]*=a,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e)},rotate:function(e,t,r,i){var a=r[0],s=r[1];r=r[2];var n=Math.sqrt(a*a+s*s+r*r);if(!n)return null;1!=n&&(a*=n=1/n,s*=n,r*=n);var o=Math.sin(t),h=Math.cos(t),l=1-h;t=e[0],n=e[1];var u=e[2],d=e[3],c=e[4],p=e[5],f=e[6],m=e[7],g=e[8],v=e[9],y=e[10],b=e[11],x=a*a*l+h,S=s*a*l+r*o,M=r*a*l-s*o,w=a*s*l-r*o,T=s*s*l+h,A=r*s*l+a*o,C=a*r*l+s*o;return a=s*r*l-a*o,s=r*r*l+h,i?e!=i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[0]=t*x+c*S+g*M,i[1]=n*x+p*S+v*M,i[2]=u*x+f*S+y*M,i[3]=d*x+m*S+b*M,i[4]=t*w+c*T+g*A,i[5]=n*w+p*T+v*A,i[6]=u*w+f*T+y*A,i[7]=d*w+m*T+b*A,i[8]=t*C+c*a+g*s,i[9]=n*C+p*a+v*s,i[10]=u*C+f*a+y*s,i[11]=d*C+m*a+b*s,i},rotateX:function(e,t,r){var i=Math.sin(t);t=Math.cos(t);var a=e[4],s=e[5],n=e[6],o=e[7],h=e[8],l=e[9],u=e[10],d=e[11];return r?e!=r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[4]=a*t+h*i,r[5]=s*t+l*i,r[6]=n*t+u*i,r[7]=o*t+d*i,r[8]=a*-i+h*t,r[9]=s*-i+l*t,r[10]=n*-i+u*t,r[11]=o*-i+d*t,r},rotateY:function(e,t,r){var i=Math.sin(t);t=Math.cos(t);var a=e[0],s=e[1],n=e[2],o=e[3],h=e[8],l=e[9],u=e[10],d=e[11];return r?e!=r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=a*t+h*-i,r[1]=s*t+l*-i,r[2]=n*t+u*-i,r[3]=o*t+d*-i,r[8]=a*i+h*t,r[9]=s*i+l*t,r[10]=n*i+u*t,r[11]=o*i+d*t,r},rotateZ:function(e,t,r){var i=Math.sin(t);t=Math.cos(t);var a=e[0],s=e[1],n=e[2],o=e[3],h=e[4],l=e[5],u=e[6],d=e[7];return r?e!=r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=a*t+h*i,r[1]=s*t+l*i,r[2]=n*t+u*i,r[3]=o*t+d*i,r[4]=a*-i+h*t,r[5]=s*-i+l*t,r[6]=n*-i+u*t,r[7]=o*-i+d*t,r},frustum:function(e,t,r,i,a,s,n){n||(n=o.create());var h=t-e,l=i-r,u=s-a;return n[0]=2*a/h,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*a/l,n[6]=0,n[7]=0,n[8]=(t+e)/h,n[9]=(i+r)/l,n[10]=-(s+a)/u,n[11]=-1,n[12]=0,n[13]=0,n[14]=-s*a*2/u,n[15]=0,n},perspective:function(e,t,r,i,a){return t*=e=r*Math.tan(e*Math.PI/360),o.frustum(-t,t,-e,e,r,i,a)},ortho:function(e,t,r,i,a,s,n){n||(n=o.create());var h=t-e,l=i-r,u=s-a;return n[0]=2/h,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/u,n[11]=0,n[12]=-(e+t)/h,n[13]=-(i+r)/l,n[14]=-(s+a)/u,n[15]=1,n},lookAt:function(e,t,r,i){i||(i=o.create());var a=e[0],s=e[1];e=e[2];var n=r[0],h=r[1],l=r[2];r=t[1];var u,d,c,p,f=t[2];return a==t[0]&&s==r&&e==f?o.identity(i):(r=a-t[0],f=s-t[1],t=e-t[2],u=h*(t*=p=1/Math.sqrt(r*r+f*f+t*t))-l*(f*=p),l=l*(r*=p)-n*t,n=n*f-h*r,(p=Math.sqrt(u*u+l*l+n*n))?(u*=p=1/p,l*=p,n*=p):n=l=u=0,h=f*n-t*l,d=t*u-r*n,c=r*l-f*u,(p=Math.sqrt(h*h+d*d+c*c))?(h*=p=1/p,d*=p,c*=p):c=d=h=0,i[0]=u,i[1]=h,i[2]=r,i[3]=0,i[4]=l,i[5]=d,i[6]=f,i[7]=0,i[8]=n,i[9]=c,i[10]=t,i[11]=0,i[12]=-(u*a+l*s+n*e),i[13]=-(h*a+d*s+c*e),i[14]=-(r*a+f*s+t*e),i[15]=1,i)},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var i=r(2),a=r(3),s=i.a,n=a.a,o={useCredentials:!1,instanceCounter:0,validateBool:function(e,t){return"boolean"==typeof e?e:t},validateNumber:function(e,t,r,i){return"number"==typeof e?s.clamp(e,t,r):i},validateNumberArray:function(e,t,r,i,a){if(Array.isArray(e)&&e.length==t){for(var n=0;n<t;n++)e[n]=s.clamp(e[n],r[n],i[n]);return e}return a},validateString:function(e,t){return"string"==typeof e?e:t},padNumber:function(e,t){return e<0?(t--,(e=-e+"").length>=t?"-"+e:"-"+(new Array(t-e.length+1).join("0")+e)):(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e},decodeFloat16:function(e){var t=(31744&e)>>10,r=1023&e;return(e>>15?-1:1)*(t?31===t?r?NaN:1/0:Math.pow(2,t-15)*(1+r/1024):r/1024*6103515625e-14)},simpleFmtObj:function(e,t){return e&&""!=e?e.replace(/\{([$a-zA-Z0-9][$a-zA-Z0-9]*)\}/g,(function(e,r){return r in t?t[r]:e})):""},simpleWikiLinks:function(e,t){return e&&""!=e?o.simpleFmtObj(e,{copy:"&copy;",Y:(new Date).getFullYear()}).replace(/\[([^\]]*)\]/g,(function(e,r){var i=(r=r.trim()).split(" ");return-1!=i[0].indexOf("//")?t?i.length>1?""+r.substring(i[0].length):""+i[0]:i.length>1?"<a href="+i[0]+' target="blank">'+r.substring(i[0].length)+"</a>":"<a href="+i[0]+' target="blank">'+i[0]+"</a>":r})):""},simpleFmtObjOrCall:function(e,t,r){return e&&""!=e?e.replace(/\{([$a-zA-Z(-9][$a-zA-Z(-9]*)\}/g,(function(e,i){return i in t?t[i]:r(i)})):""},getABGRFromHexaCode:function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[4],16),parseInt(t[3],16),parseInt(t[2],16),parseInt(t[1],16)]:[0,0,0,255]},stringifyFunction:function(e){return"("+e+").call(self);"},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},fitToPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},getHash:function(e){if(!e||0===e.length)return 0;for(var t=0,r=0,i=e.length;r<i;r++)t=(t<<5)-t+e.charCodeAt(r),t|=0;return t},convertRGB2YCbCr:function(e,t,r){return[.299*e+.587*t+.114*r+0,-.169*e+-.331*t+.5*r+128,.5*e+-.419*t+-.081*r+128]},convertYCbCr2RGB:function(e,t,r){return[1*e+0*(t-128)+1.4*(r-128),1*e+-.343*(t-128)+-.711*(r-128),1*e+1.765*(t-128)+0*(r-128)]},convertHSL2RGB:function(e,t,r){var i,a,s,n,o,h;return(e/=60)<0&&(e=6- -e%6),e%=6,t=Math.max(0,Math.min(1,t/100)),r=Math.max(0,Math.min(1,r/100)),h=(o=(1-Math.abs(2*r-1))*t)*(1-Math.abs(e%2-1)),e<1?(i=o,a=h,s=0):e<2?(i=h,a=o,s=0):e<3?(i=0,a=o,s=h):e<4?(i=0,a=h,s=o):e<5?(i=h,a=0,s=o):(i=o,a=0,s=h),[i+(n=r-o/2),a+n,s+n]},getHashColor:function(e){var t=o.getHash(e),r=o.convertRGB2YCbCr(255&t,t>>8&255,t>>16&255);return r[0]=s.clamp(r[0],50,200),o.convertRGB2YCbCr(r[0],r[1],r[2])},getHashColor2:function(e){var t=Math.floor(e/18),r=50;return t>=1&&(r=t%2?50+10*r%30:50-10*(r-1)%30),t=e%18*20,o.convertHSL2RGB(t,100,r)},loadText:function(e,t,r,i,a){o.loadJSON(e,t,r,!0,i,a)},loadXML:function(e,t,r,i,a){o.loadJSON(e,(function(e){e=(new DOMParser).parseFromString(e,"text/xml"),t&&t(e)}),r,!0,i,a)},loadJSON:function(e,t,r,i,a,s){var n=new XMLHttpRequest;n.onreadystatechange=function(){switch(n.readyState){case 0:case 1:case 2:case 3:break;case 4:if(n.status>=400||0==n.status){r&&r(n.status);break}var a=n.response,s=a;if(!i)try{s=JSON.parse(a)}catch(t){return console.log("JSON Parse Error ("+e+"): "+(t.message?t.message:"")),void(r&&r(n.status))}t&&t(s)}}.bind(this),n.open("GET",e,!0),n.withCredentials=a,s&&s.token&&n.setRequestHeader("Accept","token/"+s.token+", */*"),s&&s.charset&&n.overrideMimeType("text/xml; charset="+s.charset),n.send("")},loadBinary:function(e,t,r,i,a,s){var n=new XMLHttpRequest;n.onreadystatechange=function(){switch(n.readyState){case 0:case 1:case 2:case 3:break;case 4:if(n.status>=400||0==n.status){r&&r(n.status);break}var e=n.response;if(!e){r&&r();break}t&&t(e);break;default:r&&r()}}.bind(this),n.open("GET",e,!0),n.responseType=s||"arraybuffer",n.withCredentials=i,a&&a.token&&n.setRequestHeader("Accept","token/"+a.token+", */*"),n.send("")},headRequest:function(e,t,r,i,a){var s=new XMLHttpRequest;s.onreadystatechange=function(){switch(s.readyState){case 0:case 1:case 2:case 3:break;case 4:null!=t&&t(s.getAllResponseHeaders(),s.status);break;default:null!=r&&r()}}.bind(this),s.onerror=function(){null!=r&&r()}.bind(this),s.open("HEAD",e,!0),s.withCredentials=i,a&&a.token&&s.setRequestHeader("Accept","token/"+a.token+", */*"),s.send("")},loadImage:function(e,t,r,i,a){var s=new Image;return s.onerror=r,s.onload=t,a||(s.crossOrigin=i?"use-credentials":"anonymous"),s.src=e,s},getParamsFromUrl:function(e){return n.getParamsFromUrl(e)}},h="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;o.unint8ArrayToString=function(e){if(h)return h.decode(e);var t="",r=new Uint8Array(e.byteLength);r.set(e);for(var i=new Uint32Array(r.buffer),a=0,s=i.length;a<s;++a){var n=i[a];n<=65535?t+=String.fromCharCode(n):(n-=65536,t+=String.fromCharCode(55296+(n>>10),56320+(1023&n)))}return t}},function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var i=r(0).b,a={isEqual:function(e,t,r){return Math.abs(e-t)<r},clamp:function(e,t,r){return e<t?e=t:e>r&&(e=r),e},radians:function(e){return e*Math.PI/180},degrees:function(e){return e/Math.PI*180},mix:function(e,t,r){return e+(t-e)*r},frustumMatrix:function(e,t,r,a,s,n){var o=t-e,h=a-r,l=n-s,u=i.create([2*s/o,0,(t+e)/o,0,0,2*s/h,(a+r)/h,0,0,0,-(n+s)/l,-2*n*s/l,0,0,-1,0]);return i.transpose(u),u},perspectiveMatrix:function(e,t,r,i){var s=r*Math.tan(e*Math.PI/180),n=s*t;return a.frustumMatrix(-n,n,-s,s,r,i)},orthographicMatrix:function(e,t,r,a){var s=.5*e*t,n=.5*e,o=a-r,h=i.create([1/s,0,0,0,0,1/n,0,0,0,0,-2/o,-(a+r)/o,0,0,0,1]);return i.transpose(h),h},rotationMatrix:function(e,t){var r=Math.cos(t),i=Math.sin(t);switch(e){case 0:return[1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1];case 1:return[r,0,i,0,0,1,0,0,-i,0,r,0,0,0,0,1];default:return[r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1]}},scaleMatrix:function(e,t,r){return[e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1]},scaleMatrixf:function(e){return a.scaleMatrix(e,e,e)},translationMatrix:function(e,t,r){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1]},translationMatrix2f:function(e){return a.translationMatrix(e[0],e[1],0)},translationMatrix3f:function(e){return a.translationMatrix(e[0],e[1],e[2])}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var i={isSameOrigin:function(e){if("string"!=typeof e)return!1;var t=document.location.hostname;return i.parse(e).hostname===t},parse:function(e){if("string"!=typeof e)return null;var t=document.createElement("a");return t.href=e,t},getParamsFromUrl:function(e){var t={},r=i.parse(e).search.substring(1).split("&");if(1!=r.length||""!=r[0])for(var a=0;a<r.length;a++){var s=r[a].split("=");if(void 0===t[s[0]])t[s[0]]=s[1];else if("string"==typeof t[s[0]]){var n=[t[s[0]],s[1]];t[s[0]]=n}else t[s[0]].push(s[1])}return t},getHost:function(e){var t=document.createElement("a");return t.href=e,t.hostname},getSchema:function(e){if(-1!=e.indexOf("http://"))return"http:";if(-1!=e.indexOf("https://"))return"https:";var t=document.createElement("a");return t.href=e,t.protocol},getOrigin:function(e){var t=document.createElement("a");return t.href=e,t.origin?t.origin:t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")},getBase:function(e){return e.split("?")[0].split("/").slice(0,-1).join("/")+"/"},makeAbsolute:function(e){var t=document.createElement("a");return t.href=e,t.href},getProcessUrl:function(e,t){if(!e||!t)return e;e=e.trim(),t=t.trim();var r=i.getBase(t),a=i.getSchema(t),s=i.getOrigin(t);return-1!=e.indexOf("://")?e:0==e.indexOf("//")?a+e:0==e.indexOf("/")?s+e:r+e}}},function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var i={initialized:!1,init:function(){var e=i;e.browser=e.searchString(e.dataBrowser)||"An unknown browser",e.version=e.searchVersion(navigator.userAgent.toLowerCase())||e.searchVersion(navigator.appVersion)||"an unknown version",e.OS=e.searchString(e.dataOS)||"an unknown os: ua: "+navigator.userAgent+" pl: "+navigator.platform,e.mobile="iphone/ipod"==e.OS||"android"==e.OS||"ipad"==e.OS||"windows ce"==e.OS||"windows phone"==e.OS||"kindle"==e.OS,e.mobileAndroid="android"==e.OS,e.initialized=!0},getBrowser:function(){return i.initialized||i.init(),i.browser},getBrowserVersion:function(){return i.initialized||i.init(),i.browser},getOS:function(){return i.initialized||i.init(),i.browser},isMobile:function(){return i.initialized||i.init(),i.mobile},isAndroid:function(){return i.initialized||i.init(),i.mobileAndroid},searchString:function(e){for(var t=i,r=0;r<e.length;r++){var a=e[r].string,s=e[r].prop;if(t.versionSearchString=e[r].versionSearch||e[r].identity,a){if(-1!=a.toLowerCase().indexOf(e[r].subString))return null!=e[r].version&&(t.version=e[r].version),e[r].identity}else if(s)return e[r].identity}},searchVersion:function(e){var t=i;if(null!=t.version)return t.version;var r=e.indexOf(t.versionSearchString);return-1!=r?parseFloat(e.substring(r+t.versionSearchString.length+1)):void 0},dataBrowser:[{string:navigator.userAgent,subString:"chrome",identity:"chrome"},{string:navigator.userAgent,subString:"firefox",identity:"firefox"},{string:navigator.vendor,subString:"apple",identity:"safari",versionSearch:"version"},{prop:window.opera,identity:"opera",versionSearch:"version"},{string:navigator.vendor,subString:"icab",identity:"icab"},{string:navigator.vendor,subString:"kde",identity:"konqueror"},{string:navigator.vendor,subString:"camino",identity:"camino"},{string:navigator.userAgent,subString:"netscape",identity:"netscape"},{string:navigator.userAgent,subString:"msie",identity:"explorer",versionSearch:"msie"},{string:navigator.userAgent,subString:"trident/",identity:"explorer",version:"11"},{string:navigator.userAgent,subString:"edge/",identity:"explorer",version:"12"},{string:navigator.userAgent,subString:"omniweb",versionSearch:"omniweb/",identity:"omniweb"},{string:navigator.userAgent,subString:"silk",versionSearch:"silk/",identity:"silk"},{string:navigator.userAgent,subString:"gecko",identity:"mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"mozilla",identity:"netscape",versionSearch:"mozilla"}],dataOS:[{string:navigator.userAgent,subString:"windows ce",identity:"windows ce"},{string:navigator.userAgent,subString:"windows phone",identity:"windows phone"},{string:navigator.platform,subString:"win",identity:"windows"},{string:navigator.platform,subString:"mac",identity:"mac"},{string:navigator.userAgent,subString:"iphone",identity:"iphone/ipod"},{string:navigator.userAgent,subString:"ipod",identity:"iphone/ipod"},{string:navigator.userAgent,subString:"ipad",identity:"ipad"},{string:navigator.userAgent,subString:"android",identity:"android"},{string:navigator.userAgent,subString:"silk",identity:"kindle"},{string:navigator.userAgent,subString:"blackberry",identity:"blackberry"},{string:navigator.platform,subString:"linux",identity:"linux"}]}},function(e,t,r){var i;!function(r){"use strict";var a,s,n,o={};o.Constants={},o.Math={},o.Accumulator={},(a=o.Constants).WGS84={a:6378137,f:1/298.257223563},a.version={major:1,minor:50,patch:0},a.version_string="1.50",(s=o.Math).digits=53,s.epsilon=Math.pow(.5,s.digits-1),s.degree=Math.PI/180,s.sq=function(e){return e*e},s.hypot=Math.hypot||function(e,t){var r,i;return e=Math.abs(e),t=Math.abs(t),r=Math.max(e,t),i=Math.min(e,t)/(r||1),r*Math.sqrt(1+i*i)},s.cbrt=Math.cbrt||function(e){var t=Math.pow(Math.abs(e),1/3);return e>0?t:e<0?-t:e},s.log1p=Math.log1p||function(e){var t=1+e,r=t-1;return 0===r?e:e*Math.log(t)/r},s.atanh=Math.atanh||function(e){var t=Math.abs(e);return t=s.log1p(2*t/(1-t))/2,e>0?t:e<0?-t:e},s.copysign=function(e,t){return Math.abs(e)*(t<0||0===t&&1/t<0?-1:1)},s.sum=function(e,t){var r=e+t,i=r-t,a=r-i;return{s:r,t:-((i-=e)+(a-=t))}},s.polyval=function(e,t,r,i){for(var a=e<0?0:t[r++];--e>=0;)a=a*i+t[r++];return a},s.AngRound=function(e){if(0===e)return e;var t=1/16,r=Math.abs(e);return r=r<t?t-(t-r):r,e<0?-r:r},s.remainder=function(e,t){return(e%=t)<-t/2?e+t:e<t/2?e:e-t},s.AngNormalize=function(e){return-180==(e=s.remainder(e,360))?180:e},s.LatFix=function(e){return Math.abs(e)>90?Number.NaN:e},s.AngDiff=function(e,t){var r=s.sum(s.AngNormalize(-e),s.AngNormalize(t)),i=s.AngNormalize(r.s),a=r.t;return s.sum(180===i&&a>0?-180:i,a)},s.sincosd=function(e){var t,r,i,a,s,n;switch(t=e%360,t-=90*(r=0+Math.round(t/90)),t*=this.degree,i=Math.sin(t),a=Math.cos(t),3&r){case 0:s=i,n=a;break;case 1:s=a,n=-i;break;case 2:s=-i,n=-a;break;default:s=-a,n=i}return 0!==e&&(s+=0,n+=0),{s:s,c:n}},s.atan2d=function(e,t){var r,i,a=0;switch(Math.abs(e)>Math.abs(t)&&(r=t,t=e,e=r,a=2),t<0&&(t=-t,++a),i=Math.atan2(e,t)/this.degree,a){case 1:i=(e>=0?180:-180)-i;break;case 2:i=90-i;break;case 3:i=-90+i}return i},function(e,t){e.Accumulator=function(e){this.Set(e)},e.Accumulator.prototype.Set=function(t){t||(t=0),t.constructor===e.Accumulator?(this._s=t._s,this._t=t._t):(this._s=t,this._t=0)},e.Accumulator.prototype.Add=function(e){var r=t.sum(e,this._t),i=t.sum(r.s,this._s);r=r.t,this._s=i.s,this._t=i.t,0===this._s?this._s=r:this._t+=r},e.Accumulator.prototype.Sum=function(t){var r;return t?((r=new e.Accumulator(this)).Add(t),r._s):this._s},e.Accumulator.prototype.Negate=function(){this._s*=-1,this._t*=-1},e.Accumulator.prototype.Remainder=function(e){this._s=t.remainder(this._s,e),this.Add(0)}}(o.Accumulator,o.Math),o.Geodesic={},o.GeodesicLine={},o.PolygonArea={},function(e,t,r,i,a){var s,n,o,h,l,u,d,c,p,f,m,g=20+i.digits+10,v=i.epsilon,y=200*v,b=Math.sqrt(v),x=v*y,S=1e3*b;e.tiny_=Math.sqrt(Number.MIN_VALUE),e.nC1_=6,e.nC1p_=6,e.nC2_=6,e.nC3_=6,e.nC4_=6,s=e.nC3_*(e.nC3_-1)/2,n=e.nC4_*(e.nC4_+1)/2,e.CAP_C1=1,e.CAP_C1p=2,e.CAP_C2=4,e.CAP_C3=8,e.CAP_C4=16,e.NONE=0,e.ARC=64,e.LATITUDE=128,e.LONGITUDE=256|e.CAP_C3,e.AZIMUTH=512,e.DISTANCE=1024|e.CAP_C1,e.STANDARD=e.LATITUDE|e.LONGITUDE|e.AZIMUTH|e.DISTANCE,e.DISTANCE_IN=2048|e.CAP_C1|e.CAP_C1p,e.REDUCEDLENGTH=4096|e.CAP_C1|e.CAP_C2,e.GEODESICSCALE=8192|e.CAP_C1|e.CAP_C2,e.AREA=16384|e.CAP_C4,e.ALL=32671,e.LONG_UNROLL=32768,e.OUT_MASK=32640|e.LONG_UNROLL,e.SinCosSeries=function(e,t,r,i){var a=i.length,s=a-(e?1:0),n=2*(r-t)*(r+t),o=1&s?i[--a]:0,h=0;for(s=Math.floor(s/2);s--;)o=n*(h=n*o-h+i[--a])-o+i[--a];return e?2*t*r*o:r*(o-h)},o=function(e,t){var r,a,s,n,o,h,l,u,d,c,p,f,m=i.sq(e),g=i.sq(t),v=(m+g-1)/6;return 0===g&&v<=0?r=0:(h=v,(o=(a=m*g/4)*(a+2*(n=v*(s=i.sq(v)))))>=0?(l=a+n,l+=l<0?-Math.sqrt(o):Math.sqrt(o),h+=(u=i.cbrt(l))+(0!==u?s/u:0)):(d=Math.atan2(Math.sqrt(-o),-(a+n)),h+=2*v*Math.cos(d/3)),c=Math.sqrt(i.sq(h)+g),f=((p=h<0?g/(c-h):h+c)-g)/(2*c),r=p/(Math.sqrt(p+i.sq(f))+f)),r},h=[1,4,64,0,256],e.A1m1f=function(e){var t=Math.floor(3);return(i.polyval(t,h,0,i.sq(e))/h[t+1]+e)/(1-e)},l=[-1,6,-16,32,-9,64,-128,2048,9,-16,768,3,-5,512,-7,1280,-7,2048],e.C1f=function(t,r){var a,s,n=i.sq(t),o=t,h=0;for(a=1;a<=e.nC1_;++a)s=Math.floor((e.nC1_-a)/2),r[a]=o*i.polyval(s,l,h,n)/l[h+s+1],h+=s+2,o*=t},u=[205,-432,768,1536,4005,-4736,3840,12288,-225,116,384,-7173,2695,7680,3467,7680,38081,61440],e.C1pf=function(t,r){var a,s,n=i.sq(t),o=t,h=0;for(a=1;a<=e.nC1p_;++a)s=Math.floor((e.nC1p_-a)/2),r[a]=o*i.polyval(s,u,h,n)/u[h+s+1],h+=s+2,o*=t},d=[-11,-28,-192,0,256],e.A2m1f=function(e){var t=Math.floor(3);return(i.polyval(t,d,0,i.sq(e))/d[t+1]-e)/(1+e)},c=[1,2,16,32,35,64,384,2048,15,80,768,7,35,512,63,1280,77,2048],e.C2f=function(t,r){var a,s,n=i.sq(t),o=t,h=0;for(a=1;a<=e.nC2_;++a)s=Math.floor((e.nC2_-a)/2),r[a]=o*i.polyval(s,c,h,n)/c[h+s+1],h+=s+2,o*=t},e.Geodesic=function(e,t){if(this.a=e,this.f=t,this._f1=1-this.f,this._e2=this.f*(2-this.f),this._ep2=this._e2/i.sq(this._f1),this._n=this.f/(2-this.f),this._b=this.a*this._f1,this._c2=(i.sq(this.a)+i.sq(this._b)*(0===this._e2?1:(this._e2>0?i.atanh(Math.sqrt(this._e2)):Math.atan(Math.sqrt(-this._e2)))/Math.sqrt(Math.abs(this._e2))))/2,this._etol2=.1*b/Math.sqrt(Math.max(.001,Math.abs(this.f))*Math.min(1,1-this.f/2)/2),!(isFinite(this.a)&&this.a>0))throw new Error("Equatorial radius is not positive");if(!(isFinite(this._b)&&this._b>0))throw new Error("Polar semi-axis is not positive");this._A3x=new Array(6),this._C3x=new Array(s),this._C4x=new Array(n),this.A3coeff(),this.C3coeff(),this.C4coeff()},p=[-3,128,-2,-3,64,-1,-3,-1,16,3,-1,-2,8,1,-1,2,1,1],e.Geodesic.prototype.A3coeff=function(){var e,t,r=0,a=0;for(e=5;e>=0;--e)t=Math.min(6-e-1,e),this._A3x[a++]=i.polyval(t,p,r,this._n)/p[r+t+1],r+=t+2},f=[3,128,2,5,128,-1,3,3,64,-1,0,1,8,-1,1,4,5,256,1,3,128,-3,-2,3,64,1,-3,2,32,7,512,-10,9,384,5,-9,5,192,7,512,-14,7,512,21,2560],e.Geodesic.prototype.C3coeff=function(){var t,r,a,s=0,n=0;for(t=1;t<e.nC3_;++t)for(r=e.nC3_-1;r>=t;--r)a=Math.min(e.nC3_-r-1,r),this._C3x[n++]=i.polyval(a,f,s,this._n)/f[s+a+1],s+=a+2},m=[97,15015,1088,156,45045,-224,-4784,1573,45045,-10656,14144,-4576,-858,45045,64,624,-4576,6864,-3003,15015,100,208,572,3432,-12012,30030,45045,1,9009,-2944,468,135135,5792,1040,-1287,135135,5952,-11648,9152,-2574,135135,-64,-624,4576,-6864,3003,135135,8,10725,1856,-936,225225,-8448,4992,-1144,225225,-1440,4160,-4576,1716,225225,-136,63063,1024,-208,105105,3584,-3328,1144,315315,-128,135135,-2560,832,405405,128,99099],e.Geodesic.prototype.C4coeff=function(){var t,r,a,s=0,n=0;for(t=0;t<e.nC4_;++t)for(r=e.nC4_-1;r>=t;--r)a=e.nC4_-r-1,this._C4x[n++]=i.polyval(a,m,s,this._n)/m[s+a+1],s+=a+2},e.Geodesic.prototype.A3f=function(e){return i.polyval(5,this._A3x,0,e)},e.Geodesic.prototype.C3f=function(t,r){var a,s,n=1,o=0;for(a=1;a<e.nC3_;++a)s=e.nC3_-a-1,n*=t,r[a]=n*i.polyval(s,this._C3x,o,t),o+=s+1},e.Geodesic.prototype.C4f=function(t,r){var a,s,n=1,o=0;for(a=0;a<e.nC4_;++a)s=e.nC4_-a-1,r[a]=n*i.polyval(s,this._C4x,o,t),o+=s+1,n*=t},e.Geodesic.prototype.Lengths=function(t,r,i,a,s,n,o,h,l,u,d,c,p){var f,m,g,v,y={},b=0,x=0,S=0,M=0;if((d&=e.OUT_MASK)&(e.DISTANCE|e.REDUCEDLENGTH|e.GEODESICSCALE)&&(S=e.A1m1f(t),e.C1f(t,c),d&(e.REDUCEDLENGTH|e.GEODESICSCALE)&&(M=e.A2m1f(t),e.C2f(t,p),b=S-M,M=1+M),S=1+S),d&e.DISTANCE)f=e.SinCosSeries(!0,n,o,c)-e.SinCosSeries(!0,i,a,c),y.s12b=S*(r+f),d&(e.REDUCEDLENGTH|e.GEODESICSCALE)&&(x=b*r+(S*f-M*(e.SinCosSeries(!0,n,o,p)-e.SinCosSeries(!0,i,a,p))));else if(d&(e.REDUCEDLENGTH|e.GEODESICSCALE)){for(m=1;m<=e.nC2_;++m)p[m]=S*c[m]-M*p[m];x=b*r+(e.SinCosSeries(!0,n,o,p)-e.SinCosSeries(!0,i,a,p))}return d&e.REDUCEDLENGTH&&(y.m0=b,y.m12b=h*(a*n)-s*(i*o)-a*o*x),d&e.GEODESICSCALE&&(g=a*o+i*n,v=this._ep2*(l-u)*(l+u)/(s+h),y.M12=g+(v*n-o*x)*i/s,y.M21=g-(v*i-a*x)*n/h),y},e.Geodesic.prototype.InverseStart=function(t,r,a,s,n,h,l,u,d,c,p){var f,m,g,v,b,x,M,w,T,A,C,F,P,L,E,N,B,I,k,R,_={},z=s*r-n*t,U=n*r+s*t;return _.sig12=-1,f=s*r,f+=n*t,(m=U>=0&&z<.5&&n*l<.5)?(v=i.sq(t+s),v/=v+i.sq(r+n),_.dnm=Math.sqrt(1+this._ep2*v),g=l/(this._f1*_.dnm),b=Math.sin(g),x=Math.cos(g)):(b=u,x=d),_.salp1=n*b,_.calp1=x>=0?z+n*t*i.sq(b)/(1+x):f-n*t*i.sq(b)/(1-x),w=i.hypot(_.salp1,_.calp1),T=t*s+r*n*x,m&&w<this._etol2?(_.salp2=r*b,_.calp2=z-r*s*(x>=0?i.sq(b)/(1+x):1-x),M=i.hypot(_.salp2,_.calp2),_.salp2/=M,_.calp2/=M,_.sig12=Math.atan2(w,T)):Math.abs(this._n)>.1||T>=0||w>=6*Math.abs(this._n)*Math.PI*i.sq(r)||(R=Math.atan2(-u,-d),this.f>=0?(L=(P=i.sq(t)*this._ep2)/(2*(1+Math.sqrt(1+P))+P),A=R/(F=this.f*r*this.A3f(L)*Math.PI),C=f/(F*r)):(E=n*r-s*t,N=Math.atan2(f,E),C=l/(F=((A=(B=this.Lengths(this._n,Math.PI+N,t,-r,a,s,n,h,r,n,e.REDUCEDLENGTH,c,p)).m12b/(r*n*B.m0*Math.PI)-1)<-.01?f/A:-this.f*i.sq(r)*Math.PI)/r)),C>-y&&A>-1-S?this.f>=0?(_.salp1=Math.min(1,-A),_.calp1=-Math.sqrt(1-i.sq(_.salp1))):(_.calp1=Math.max(A>-y?0:-1,A),_.salp1=Math.sqrt(1-i.sq(_.calp1))):(I=o(A,C),k=F*(this.f>=0?-A*I/(1+I):-C*(1+I)/I),b=Math.sin(k),x=-Math.cos(k),_.salp1=n*b,_.calp1=f-n*t*i.sq(b)/(1-x))),_.salp1<=0?(_.salp1=1,_.calp1=0):(M=i.hypot(_.salp1,_.calp1),_.salp1/=M,_.calp1/=M),_},e.Geodesic.prototype.Lambda12=function(t,r,a,s,n,o,h,l,u,d,c,p,f,m){var g,v,y,b,x,S,M,w,T,A,C,F,P,L={};return 0===t&&0===l&&(l=-e.tiny_),v=h*r,y=i.hypot(l,h*t),L.ssig1=t,b=v*t,L.csig1=x=l*r,g=i.hypot(L.ssig1,L.csig1),L.ssig1/=g,L.csig1/=g,L.salp2=n!==r?v/n:h,L.calp2=n!==r||Math.abs(s)!==-t?Math.sqrt(i.sq(l*r)+(r<-t?(n-r)*(r+n):(t-s)*(t+s)))/n:Math.abs(l),L.ssig2=s,S=v*s,L.csig2=M=L.calp2*n,g=i.hypot(L.ssig2,L.csig2),L.ssig2/=g,L.csig2/=g,L.sig12=Math.atan2(Math.max(0,L.csig1*L.ssig2-L.ssig1*L.csig2),L.csig1*L.csig2+L.ssig1*L.ssig2),w=Math.max(0,x*S-b*M),T=x*M+b*S,C=Math.atan2(w*d-T*u,T*d+w*u),F=i.sq(y)*this._ep2,L.eps=F/(2*(1+Math.sqrt(1+F))+F),this.C3f(L.eps,m),A=e.SinCosSeries(!0,L.ssig2,L.csig2,m)-e.SinCosSeries(!0,L.ssig1,L.csig1,m),L.domg12=-this.f*this.A3f(L.eps)*v*(L.sig12+A),L.lam12=C+L.domg12,c&&(0===L.calp2?L.dlam12=-2*this._f1*a/t:(P=this.Lengths(L.eps,L.sig12,L.ssig1,L.csig1,a,L.ssig2,L.csig2,o,r,n,e.REDUCEDLENGTH,p,f),L.dlam12=P.m12b,L.dlam12*=this._f1/(L.calp2*n))),L},e.Geodesic.prototype.Inverse=function(t,r,a,s,n){var o,h;return n||(n=e.STANDARD),n===e.LONG_UNROLL&&(n|=e.STANDARD),n&=e.OUT_MASK,h=(o=this.InverseInt(t,r,a,s,n)).vals,n&e.AZIMUTH&&(h.azi1=i.atan2d(o.salp1,o.calp1),h.azi2=i.atan2d(o.salp2,o.calp2)),h},e.Geodesic.prototype.InverseInt=function(t,r,a,s,n){var o,h,l,u,d,c,p,f,m,y,b,S,M,w,T,A,C,F,P,L,E,N,B,I,k,R,_,z,U,D,O,V,G,j,H,q,W,J,Z,Y,K,X,Q,$,ee,te,re,ie,ae,se,ne,oe,he,le,ue,de,ce,pe,fe,me,ge,ve,ye,be,xe,Se={};if(Se.lat1=t=i.LatFix(t),Se.lat2=a=i.LatFix(a),t=i.AngRound(t),a=i.AngRound(a),h=(o=i.AngDiff(r,s)).t,o=o.s,n&e.LONG_UNROLL?(Se.lon1=r,Se.lon2=r+o+h):(Se.lon1=i.AngNormalize(r),Se.lon2=i.AngNormalize(s)),o=(l=o>=0?1:-1)*i.AngRound(o),h=i.AngRound(180-o-l*h),T=o*i.degree,A=(u=i.sincosd(o>90?h:o)).s,C=(o>90?-1:1)*u.c,(d=Math.abs(t)<Math.abs(a)?-1:1)<0&&(l*=-1,u=t,t=a,a=u),t*=c=t<0?1:-1,a*=c,u=i.sincosd(t),p=this._f1*u.s,f=u.c,p/=u=i.hypot(p,f),f/=u,f=Math.max(e.tiny_,f),u=i.sincosd(a),m=this._f1*u.s,y=u.c,m/=u=i.hypot(m,y),y/=u,y=Math.max(e.tiny_,y),f<-p?y===f&&(m=m<0?p:-p):Math.abs(m)===-p&&(y=f),M=Math.sqrt(1+this._ep2*i.sq(p)),w=Math.sqrt(1+this._ep2*i.sq(m)),B=new Array(e.nC1_+1),I=new Array(e.nC2_+1),k=new Array(e.nC3_),(R=-90===t||0===A)&&(L=A,N=0,z=p,U=(P=C)*f,D=m,O=(E=1)*y,F=Math.atan2(Math.max(0,U*D-z*O),U*O+z*D),b=(_=this.Lengths(this._n,F,z,U,M,D,O,w,f,y,n|e.DISTANCE|e.REDUCEDLENGTH,B,I)).s12b,S=_.m12b,n&e.GEODESICSCALE&&(Se.M12=_.M12,Se.M21=_.M21),F<1||S>=0?(F<3*e.tiny_&&(F=S=b=0),S*=this._b,b*=this._b,Se.a12=F/i.degree):R=!1),ce=2,!R&&0===p&&(this.f<=0||h>=180*this.f))P=E=0,L=N=1,b=this.a*T,F=G=T/this._f1,S=this._b*Math.sin(F),n&e.GEODESICSCALE&&(Se.M12=Se.M21=Math.cos(F)),Se.a12=o/this._f1;else if(!R)if(F=(_=this.InverseStart(p,f,M,m,y,w,T,A,C,B,I)).sig12,L=_.salp1,P=_.calp1,F>=0)N=_.salp2,E=_.calp2,j=_.dnm,b=F*this._b*j,S=i.sq(j)*this._b*Math.sin(F/j),n&e.GEODESICSCALE&&(Se.M12=Se.M21=Math.cos(F/j)),Se.a12=F/i.degree,G=T/(this._f1*j);else{for(H=0,q=e.tiny_,W=1,J=e.tiny_,Z=-1,Y=!1,K=!1;H<g&&(X=(_=this.Lambda12(p,f,M,m,y,w,L,P,A,C,H<20,B,I,k)).lam12,N=_.salp2,E=_.calp2,F=_.sig12,z=_.ssig1,U=_.csig1,D=_.ssig2,O=_.csig2,V=_.eps,fe=_.domg12,Q=_.dlam12,!K&&Math.abs(X)>=(Y?8:1)*v);++H)X>0&&(H<20||P/L>Z/J)?(J=L,Z=P):X<0&&(H<20||P/L<W/q)&&(q=L,W=P),H<20&&Q>0&&($=-X/Q,ee=Math.sin($),(re=L*(te=Math.cos($))+P*ee)>0&&Math.abs($)<Math.PI)?(P=P*te-L*ee,L=re,L/=u=i.hypot(L,P),P/=u,Y=Math.abs(X)<=16*v):(L=(q+J)/2,P=(W+Z)/2,L/=u=i.hypot(L,P),P/=u,Y=!1,K=Math.abs(q-L)+(W-P)<x||Math.abs(L-J)+(P-Z)<x);ie=n|(n&(e.REDUCEDLENGTH|e.GEODESICSCALE)?e.DISTANCE:e.NONE),b=(_=this.Lengths(V,F,z,U,M,D,O,w,f,y,ie,B,I)).s12b,S=_.m12b,n&e.GEODESICSCALE&&(Se.M12=_.M12,Se.M21=_.M21),S*=this._b,b*=this._b,Se.a12=F/i.degree,n&e.AREA&&(be=Math.sin(fe),ce=A*(xe=Math.cos(fe))-C*be,pe=C*xe+A*be)}return n&e.DISTANCE&&(Se.s12=0+b),n&e.REDUCEDLENGTH&&(Se.m12=0+S),n&e.AREA&&(ae=L*f,0!==(se=i.hypot(P,L*p))&&0!==ae?(z=p,U=P*f,D=m,O=E*y,V=(oe=i.sq(se)*this._ep2)/(2*(1+Math.sqrt(1+oe))+oe),he=i.sq(this.a)*se*ae*this._e2,z/=u=i.hypot(z,U),U/=u,D/=u=i.hypot(D,O),O/=u,le=new Array(e.nC4_),this.C4f(V,le),ue=e.SinCosSeries(!1,z,U,le),de=e.SinCosSeries(!1,D,O,le),Se.S12=he*(de-ue)):Se.S12=0,!R&&ce>1&&(ce=Math.sin(G),pe=Math.cos(G)),!R&&pe>-.7071&&m-p<1.75?(fe=1+pe,me=1+f,ge=1+y,ne=2*Math.atan2(ce*(p*ge+m*me),fe*(p*m+me*ge))):(ye=E*P+N*L,0===(ve=N*P-E*L)&&ye<0&&(ve=e.tiny_*P,ye=-1),ne=Math.atan2(ve,ye)),Se.S12+=this._c2*ne,Se.S12*=d*l*c,Se.S12+=0),d<0&&(u=L,L=N,N=u,u=P,P=E,E=u,n&e.GEODESICSCALE&&(u=Se.M12,Se.M12=Se.M21,Se.M21=u)),{vals:Se,salp1:L*=d*l,calp1:P*=d*c,salp2:N*=d*l,calp2:E*=d*c}},e.Geodesic.prototype.GenDirect=function(r,i,a,s,n,o){return o?o===e.LONG_UNROLL&&(o|=e.STANDARD):o=e.STANDARD,s||(o|=e.DISTANCE_IN),new t.GeodesicLine(this,r,i,a,o).GenPosition(s,n,o)},e.Geodesic.prototype.Direct=function(e,t,r,i,a){return this.GenDirect(e,t,r,!1,i,a)},e.Geodesic.prototype.ArcDirect=function(e,t,r,i,a){return this.GenDirect(e,t,r,!0,i,a)},e.Geodesic.prototype.Line=function(e,r,i,a){return new t.GeodesicLine(this,e,r,i,a)},e.Geodesic.prototype.DirectLine=function(e,t,r,i,a){return this.GenDirectLine(e,t,r,!1,i,a)},e.Geodesic.prototype.ArcDirectLine=function(e,t,r,i,a){return this.GenDirectLine(e,t,r,!0,i,a)},e.Geodesic.prototype.GenDirectLine=function(r,i,a,s,n,o){var h;return o||(o=e.STANDARD|e.DISTANCE_IN),s||(o|=e.DISTANCE_IN),(h=new t.GeodesicLine(this,r,i,a,o)).GenSetDistance(s,n),h},e.Geodesic.prototype.InverseLine=function(r,a,s,n,o){var h,l,u;return o||(o=e.STANDARD|e.DISTANCE_IN),h=this.InverseInt(r,a,s,n,e.ARC),u=i.atan2d(h.salp1,h.calp1),o&e.OUT_MASK&e.DISTANCE_IN&&(o|=e.DISTANCE),(l=new t.GeodesicLine(this,r,a,u,o,h.salp1,h.calp1)).SetArc(h.vals.a12),l},e.Geodesic.prototype.Polygon=function(e){return new r.PolygonArea(this,e)},e.WGS84=new e.Geodesic(a.WGS84.a,a.WGS84.f)}(o.Geodesic,o.GeodesicLine,o.PolygonArea,o.Math,o.Constants),function(e,t,r){t.GeodesicLine=function(t,i,a,s,n,o,h){var l,u,d,c,p,f;n||(n=e.STANDARD|e.DISTANCE_IN),this.a=t.a,this.f=t.f,this._b=t._b,this._c2=t._c2,this._f1=t._f1,this.caps=n|e.LATITUDE|e.AZIMUTH|e.LONG_UNROLL,this.lat1=r.LatFix(i),this.lon1=a,void 0===o||void 0===h?(this.azi1=r.AngNormalize(s),l=r.sincosd(r.AngRound(this.azi1)),this.salp1=l.s,this.calp1=l.c):(this.azi1=s,this.salp1=o,this.calp1=h),l=r.sincosd(r.AngRound(this.lat1)),d=this._f1*l.s,u=l.c,d/=l=r.hypot(d,u),u/=l,u=Math.max(e.tiny_,u),this._dn1=Math.sqrt(1+t._ep2*r.sq(d)),this._salp0=this.salp1*u,this._calp0=r.hypot(this.calp1,this.salp1*d),this._ssig1=d,this._somg1=this._salp0*d,this._csig1=this._comg1=0!==d||0!==this.calp1?u*this.calp1:1,l=r.hypot(this._ssig1,this._csig1),this._ssig1/=l,this._csig1/=l,this._k2=r.sq(this._calp0)*t._ep2,c=this._k2/(2*(1+Math.sqrt(1+this._k2))+this._k2),this.caps&e.CAP_C1&&(this._A1m1=e.A1m1f(c),this._C1a=new Array(e.nC1_+1),e.C1f(c,this._C1a),this._B11=e.SinCosSeries(!0,this._ssig1,this._csig1,this._C1a),p=Math.sin(this._B11),f=Math.cos(this._B11),this._stau1=this._ssig1*f+this._csig1*p,this._ctau1=this._csig1*f-this._ssig1*p),this.caps&e.CAP_C1p&&(this._C1pa=new Array(e.nC1p_+1),e.C1pf(c,this._C1pa)),this.caps&e.CAP_C2&&(this._A2m1=e.A2m1f(c),this._C2a=new Array(e.nC2_+1),e.C2f(c,this._C2a),this._B21=e.SinCosSeries(!0,this._ssig1,this._csig1,this._C2a)),this.caps&e.CAP_C3&&(this._C3a=new Array(e.nC3_),t.C3f(c,this._C3a),this._A3c=-this.f*this._salp0*t.A3f(c),this._B31=e.SinCosSeries(!0,this._ssig1,this._csig1,this._C3a)),this.caps&e.CAP_C4&&(this._C4a=new Array(e.nC4_),t.C4f(c,this._C4a),this._A4=r.sq(this.a)*this._calp0*this._salp0*t._e2,this._B41=e.SinCosSeries(!1,this._ssig1,this._csig1,this._C4a)),this.a13=this.s13=Number.NaN},t.GeodesicLine.prototype.GenPosition=function(t,i,a){var s,n,o,h,l,u,d,c,p,f,m,g,v,y,b,x,S,M,w,T,A,C,F,P,L,E,N={};return a?a===e.LONG_UNROLL&&(a|=e.STANDARD):a=e.STANDARD,a&=this.caps&e.OUT_MASK,N.lat1=this.lat1,N.azi1=this.azi1,N.lon1=a&e.LONG_UNROLL?this.lon1:r.AngNormalize(this.lon1),t?N.a12=i:N.s12=i,t||this.caps&e.DISTANCE_IN&e.OUT_MASK?(h=0,l=0,t?(s=i*r.degree,n=(F=r.sincosd(i)).s,o=F.c):(c=i/(this._b*(1+this._A1m1)),p=Math.sin(c),f=Math.cos(c),s=c-((h=-e.SinCosSeries(!0,this._stau1*f+this._ctau1*p,this._ctau1*f-this._stau1*p,this._C1pa))-this._B11),n=Math.sin(s),o=Math.cos(s),Math.abs(this.f)>.01&&(u=this._ssig1*o+this._csig1*n,d=this._csig1*o-this._ssig1*n,h=e.SinCosSeries(!0,u,d,this._C1a),s-=((1+this._A1m1)*(s+(h-this._B11))-i/this._b)/Math.sqrt(1+this._k2*r.sq(u)),n=Math.sin(s),o=Math.cos(s))),u=this._ssig1*o+this._csig1*n,d=this._csig1*o-this._ssig1*n,w=Math.sqrt(1+this._k2*r.sq(u)),a&(e.DISTANCE|e.REDUCEDLENGTH|e.GEODESICSCALE)&&((t||Math.abs(this.f)>.01)&&(h=e.SinCosSeries(!0,u,d,this._C1a)),l=(1+this._A1m1)*(h-this._B11)),v=this._calp0*u,0===(y=r.hypot(this._salp0,this._calp0*d))&&(y=d=e.tiny_),S=this._salp0,M=this._calp0*d,t&&a&e.DISTANCE&&(N.s12=this._b*((1+this._A1m1)*s+l)),a&e.LONGITUDE&&(b=this._salp0*u,x=d,g=r.copysign(1,this._salp0),m=((a&e.LONG_UNROLL?g*(s-(Math.atan2(u,d)-Math.atan2(this._ssig1,this._csig1))+(Math.atan2(g*b,x)-Math.atan2(g*this._somg1,this._comg1))):Math.atan2(b*this._comg1-x*this._somg1,x*this._comg1+b*this._somg1))+this._A3c*(s+(e.SinCosSeries(!0,u,d,this._C3a)-this._B31)))/r.degree,N.lon2=a&e.LONG_UNROLL?this.lon1+m:r.AngNormalize(r.AngNormalize(this.lon1)+r.AngNormalize(m))),a&e.LATITUDE&&(N.lat2=r.atan2d(v,this._f1*y)),a&e.AZIMUTH&&(N.azi2=r.atan2d(S,M)),a&(e.REDUCEDLENGTH|e.GEODESICSCALE)&&(T=e.SinCosSeries(!0,u,d,this._C2a),A=(1+this._A2m1)*(T-this._B21),C=(this._A1m1-this._A2m1)*s+(l-A),a&e.REDUCEDLENGTH&&(N.m12=this._b*(w*(this._csig1*u)-this._dn1*(this._ssig1*d)-this._csig1*d*C)),a&e.GEODESICSCALE&&(F=this._k2*(u-this._ssig1)*(u+this._ssig1)/(this._dn1+w),N.M12=o+(F*u-d*C)*this._ssig1/this._dn1,N.M21=o-(F*this._ssig1-this._csig1*C)*u/w)),a&e.AREA&&(P=e.SinCosSeries(!1,u,d,this._C4a),0===this._calp0||0===this._salp0?(L=S*this.calp1-M*this.salp1,E=M*this.calp1+S*this.salp1):(L=this._calp0*this._salp0*(o<=0?this._csig1*(1-o)+n*this._ssig1:n*(this._csig1*n/(1+o)+this._ssig1)),E=r.sq(this._salp0)+r.sq(this._calp0)*this._csig1*d),N.S12=this._c2*Math.atan2(L,E)+this._A4*(P-this._B41)),t||(N.a12=s/r.degree),N):(N.a12=Number.NaN,N)},t.GeodesicLine.prototype.Position=function(e,t){return this.GenPosition(!1,e,t)},t.GeodesicLine.prototype.ArcPosition=function(e,t){return this.GenPosition(!0,e,t)},t.GeodesicLine.prototype.GenSetDistance=function(e,t){e?this.SetArc(t):this.SetDistance(t)},t.GeodesicLine.prototype.SetDistance=function(t){var r;this.s13=t,r=this.GenPosition(!1,this.s13,e.ARC),this.a13=0+r.a12},t.GeodesicLine.prototype.SetArc=function(t){var r;this.a13=t,r=this.GenPosition(!0,this.a13,e.DISTANCE),this.s13=0+r.s12}}(o.Geodesic,o.GeodesicLine,o.Math),function(e,t,r,i){var a,s,n,o;a=function(e,t){var i;return e=r.AngNormalize(e),t=r.AngNormalize(t),i=r.AngDiff(e,t).s,e<=0&&t>0&&i>0?1:t<=0&&e>0&&i<0?-1:0},s=function(e,t){return((t%=720)<=0&&t>-360||t>360?1:0)-((e%=720)<=0&&e>-360||e>360?1:0)},n=function(e,t,r,i,a){return e.Remainder(t),1&r&&e.Add((e.Sum()<0?1:-1)*t/2),i||e.Negate(),a?e.Sum()>t/2?e.Add(-t):e.Sum()<=-t/2&&e.Add(+t):e.Sum()>=t?e.Add(-t):e.Sum()<0&&e.Add(+t),0+e.Sum()},o=function(e,t,i,a,s){return e=r.remainder(e,t),1&i&&(e+=(e<0?1:-1)*t/2),a||(e*=-1),s?e>t/2?e-=t:e<=-t/2&&(e+=t):e>=t?e-=t:e<0&&(e+=t),0+e},e.PolygonArea=function(e,r){this._geod=e,this.a=this._geod.a,this.f=this._geod.f,this._area0=4*Math.PI*e._c2,this.polyline=r||!1,this._mask=t.LATITUDE|t.LONGITUDE|t.DISTANCE|(this.polyline?t.NONE:t.AREA|t.LONG_UNROLL),this.polyline||(this._areasum=new i.Accumulator(0)),this._perimetersum=new i.Accumulator(0),this.Clear()},e.PolygonArea.prototype.Clear=function(){this.num=0,this._crossings=0,this.polyline||this._areasum.Set(0),this._perimetersum.Set(0),this._lat0=this._lon0=this.lat=this.lon=Number.NaN},e.PolygonArea.prototype.AddPoint=function(e,t){var r;0===this.num?(this._lat0=this.lat=e,this._lon0=this.lon=t):(r=this._geod.Inverse(this.lat,this.lon,e,t,this._mask),this._perimetersum.Add(r.s12),this.polyline||(this._areasum.Add(r.S12),this._crossings+=a(this.lon,t)),this.lat=e,this.lon=t),++this.num},e.PolygonArea.prototype.AddEdge=function(e,t){var r;this.num&&(r=this._geod.Direct(this.lat,this.lon,e,t,this._mask),this._perimetersum.Add(t),this.polyline||(this._areasum.Add(r.S12),this._crossings+=s(this.lon,r.lon2)),this.lat=r.lat2,this.lon=r.lon2),++this.num},e.PolygonArea.prototype.Compute=function(e,t){var r,s,o={number:this.num};return this.num<2?(o.perimeter=0,this.polyline||(o.area=0),o):this.polyline?(o.perimeter=this._perimetersum.Sum(),o):(r=this._geod.Inverse(this.lat,this.lon,this._lat0,this._lon0,this._mask),o.perimeter=this._perimetersum.Sum(r.s12),(s=new i.Accumulator(this._areasum)).Add(r.S12),o.area=n(s,this._area0,this._crossings+a(this.lon,this._lon0),e,t),o)},e.PolygonArea.prototype.TestPoint=function(e,t,r,i){var s,n,h,l,u={number:this.num+1};if(0===this.num)return u.perimeter=0,this.polyline||(u.area=0),u;for(u.perimeter=this._perimetersum.Sum(),n=this.polyline?0:this._areasum.Sum(),h=this._crossings,l=0;l<(this.polyline?1:2);++l)s=this._geod.Inverse(0===l?this.lat:e,0===l?this.lon:t,0!==l?this._lat0:e,0!==l?this._lon0:t,this._mask),u.perimeter+=s.s12,this.polyline||(n+=s.S12,h+=a(0===l?this.lon:t,0!==l?this._lon0:t));return this.polyline||(u.area=o(n,this._area0,h,r,i)),u},e.PolygonArea.prototype.TestEdge=function(e,t,r,i){var n,h,l,u={number:this.num?this.num+1:0};return 0===this.num?u:(u.perimeter=this._perimetersum.Sum()+t,this.polyline||(h=this._areasum.Sum(),l=this._crossings,h+=(n=this._geod.Direct(this.lat,this.lon,e,t,this._mask)).S12,l+=s(this.lon,n.lon2),l+=a(n.lon2,this._lon0),n=this._geod.Inverse(n.lat2,n.lon2,this._lat0,this._lon0,this._mask),u.perimeter+=n.s12,h+=n.S12,u.area=o(h,this._area0,l,r,i)),u)}}(o.PolygonArea,o.Geodesic,o.Math,o.Accumulator),o.DMS={},function(e){var t,r,i,a,s=["degrees","minutes","seconds"];t=function(e,t){return e.indexOf(t.toUpperCase())},r=function(e,t){return String("0000").substr(0,Math.max(0,Math.min(4,t-e.length)))+e},e.NONE=0,e.LATITUDE=1,e.LONGITUDE=2,e.AZIMUTH=3,e.DEGREE=0,e.MINUTE=1,e.SECOND=2,e.Decode=function(r){var a,s,n,o,h,l,u,d,c=r,p=0,f=0,m=e.NONE;for(a=(c=c.replace(/\u2212/g,"-").replace(/\u00b0/g,"d").replace(/\u00ba/g,"d").replace(/\u2070/g,"d").replace(/\u02da/g,"d").replace(/\u2032/g,"'").replace(/\u00b4/g,"'").replace(/\u2019/g,"'").replace(/\u2033/g,'"').replace(/\u201d/g,'"').replace(/\u00a0/g,"").replace(/\u202f/g,"").replace(/\u2007/g,"").replace(/''/g,'"').trim()).length,l=0;l<a;l=d,++f)if(u=l,0===f&&t("SNWE",c.charAt(u))>=0&&++u,(f>0||u<a&&t("-+",c.charAt(u))>=0)&&++u,(s=c.substr(u,a-u).indexOf("-"))<0?s=a:s+=u,(n=c.substr(u,a-u).indexOf("+"))<0?n=a:n+=u,d=Math.min(s,n),p+=(o=i(c.substr(l,d-l))).val,h=o.ind,m===e.NONE)m=h;else if(h!==e.NONE&&m!==h)throw new Error("Incompatible hemisphere specifies in "+c.substr(0,d));if(0===f)throw new Error("Empty or incomplete DMS string "+c);return{val:p,ind:m}},i=function(r){var i,n,o,h,l,u,d,c,p,f,m,g,v,y,b,x,S={},M="";do{if(i=1,n=0,o=r.length,h=e.NONE,l=-1,o>n&&(l=t("SNWE",r.charAt(n)))>=0&&(h=2&l?e.LONGITUDE:e.LATITUDE,i=1&l?1:-1,++n),o>n&&(l=t("SNWE",r.charAt(o-1)))>=0&&l>=0){if(h!==e.NONE){M=r.charAt(n-1).toUpperCase()===r.charAt(o-1).toUpperCase()?"Repeated hemisphere indicators "+r.charAt(n-1)+" in "+r.substr(n-1,o-n+1):"Contradictory hemisphere indicators "+r.charAt(n-1)+" and "+r.charAt(o-1)+" in "+r.substr(n-1,o-n+1);break}h=2&l?e.LONGITUDE:e.LATITUDE,i=1&l?1:-1,--o}if(o>n&&(l=t("-+",r.charAt(n)))>=0&&l>=0&&(i*=l?1:-1,++n),o===n){M="Empty or incomplete DMS string "+r;break}for(u=[0,0,0],d=[0,0,0],c=0,p=0,f=0,m=0,g=n,v=!1,y=0,b=0;g<o;)if(x=r.charAt(g++),(l=t("0123456789",x))>=0)++m,y>0?++y:(p=10*p+l,++b);else if("."===x){if(v){M="Multiple decimal points in "+r.substr(n,o-n);break}v=!0,y=1}else{if(!((l=t("D'\":",x))>=0)){if(t("-+",x)>=0){M="Internal sign in DMS string "+r.substr(n,o-n);break}M="Illegal character "+x+" in DMS string "+r.substr(n,o-n);break}if(l>=3){if(g===o){M="Illegal for colon to appear at the end of "+r.substr(n,o-n);break}l=c}if(l===c-1){M="Repeated "+s[l]+" component in "+r.substr(n,o-n);break}if(l<c){M=s[l]+" component follows "+s[c-1]+" component in "+r.substr(n,o-n);break}if(0===m){M="Missing numbers in "+s[l]+" component of "+r.substr(n,o-n);break}y>0&&(f=parseFloat(r.substr(g-b-y-1,b+y)),p=0),u[l]=p,d[l]=p+f,g<o&&(c=l+1,p=f=0,m=y=b=0)}if(M.length)break;if(t("D'\":",r.charAt(g-1))<0){if(c>=3){M="Extra text following seconds in DMS string "+r.substr(n,o-n);break}if(0===m){M="Missing numbers in trailing component of "+r.substr(n,o-n);break}y>0&&(f=parseFloat(r.substr(g-b-y,b+y)),p=0),u[c]=p,d[c]=p+f}if(v&&0===y){M="Decimal point in non-terminal component of "+r.substr(n,o-n);break}if(u[1]>=60||d[1]>60){M="Minutes "+d[1]+" not in range [0,60)";break}if(u[2]>=60||d[2]>60){M="Seconds "+d[2]+" not in range [0,60)";break}return S.ind=h,S.val=i*(d[2]?(60*(60*d[0]+d[1])+d[2])/3600:d[1]?(60*d[0]+d[1])/60:d[0]),S}while(0);if(S.val=a(r),0===S.val)throw new Error(M);return S.ind=e.NONE,S},a=function(e){var t,r,i,a;return e.length<3?0:(r="-"===(t=e.toUpperCase().replace(/0+$/,"")).charAt(0)?-1:1,i="-"===t.charAt(0)||"+"===t.charAt(0)?1:0,(a=t.length-1)+1<i+3?0:"NAN"===(t=t.substr(i,a+1-i))||"1.#QNAN"===t||"1.#SNAN"===t||"1.#IND"===t||"1.#R"===t?Number.NaN:"INF"===t||"1.#INF"===t?r*Number.POSITIVE_INFINITY:0)},e.DecodeLatLon=function(t,r,i){var a,s,n={},o=e.Decode(t),h=e.Decode(r),l=o.val,u=o.ind,d=h.val,c=h.ind;if(i||(i=!1),u===e.NONE&&c===e.NONE?(u=i?e.LONGITUDE:e.LATITUDE,c=i?e.LATITUDE:e.LONGITUDE):u===e.NONE?u=e.LATITUDE+e.LONGITUDE-c:c===e.NONE&&(c=e.LATITUDE+e.LONGITUDE-u),u===c)throw new Error("Both "+t+" and "+r+" interpreted as "+(u===e.LATITUDE?"latitudes":"longitudes"));if(a=u===e.LATITUDE?l:d,s=u===e.LATITUDE?d:l,Math.abs(a)>90)throw new Error("Latitude "+a+" not in [-90,90]");return n.lat=a,n.lon=s,n},e.DecodeAngle=function(t){var r=e.Decode(t),i=r.val;if(r.ind!==e.NONE)throw new Error("Arc angle "+t+" includes a hemisphere N/E/W/S");return i},e.DecodeAzimuth=function(t){var r=e.Decode(t),i=r.val;if(r.ind===e.LATITUDE)throw new Error("Azimuth "+t+" has a latitude hemisphere N/S");return i},e.Encode=function(t,i,a,s){var n,o,h,l,u,d,c,p,f,m=1;if(s||(s=e.NONE),!isFinite(t))return String(t<0?"-inf":t>0?"inf":"nan");for(a=Math.min(15-2*i,a),n=0;n<i;++n)m*=60;for(n=0;n<a;++n)m*=10;for(s===e.AZIMUTH&&(t-=360*Math.floor(t/360)),l=((t*=o=t<0?-1:1)-(h=Math.floor(t)))*m+.5,l=(u=Math.floor(l))===l&&1==(1&u)?u-1:u,l/=m,(l=Math.floor((t-h)*m+.5)/m)>=1&&(h+=1,l-=1),d=[l,0,0],n=1;n<=i;++n)c=Math.floor(d[n-1]),p=d[n-1]-c,d[n]=60*p,d[n-1]=c;switch(d[0]+=h,f="",s===e.NONE&&o<0&&(f+="-"),i){case e.DEGREE:f+=r(d[0].toFixed(a),s===e.NONE?0:1+Math.min(s,2)+a+(a?1:0))+"'\"".charAt(0);break;default:switch(f+=r(d[0].toFixed(0),s===e.NONE?0:1+Math.min(s,2))+"'\"".charAt(0),i){case e.MINUTE:f+=r(d[1].toFixed(a),2+a+(a?1:0))+"'\"".charAt(1);break;case e.SECOND:f+=r(d[1].toFixed(0),2)+"'\"".charAt(1),f+=r(d[2].toFixed(a),2+a+(a?1:0))+"'\"".charAt(2)}}return s!==e.NONE&&s!==e.AZIMUTH&&(f+="SNWE".charAt((s===e.LATITUDE?0:2)+(o<0?0:1))),f}}(o.DMS),n=o,e.exports?e.exports=n:void 0===(i=function(){return n}.apply(t,[]))||(e.exports=i)}()},function(e,t,r){"use strict";var i=484813681109536e-20,a=Math.PI/2,s=void 0===Number.EPSILON?1e-10:Number.EPSILON,n=.017453292519943295,o=57.29577951308232,h=Math.PI/4,l=2*Math.PI,u=3.14159265359,d={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},c={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},p=/[\s_\-\/\(\)]/g;function f(e,t){if(e[t])return e[t];for(var r,i=Object.keys(e),a=t.toLowerCase().replace(p,""),s=-1;++s<i.length;)if((r=i[s]).toLowerCase().replace(p,"")===a)return e[r]}var m=function(e){var t,r,i,a={},s=e.split("+").map((function(e){return e.trim()})).filter((function(e){return e})).reduce((function(e,t){var r=t.split("=");return r.push(!0),e[r[0].toLowerCase()]=r[1],e}),{}),o={proj:"projName",datum:"datumCode",rf:function(e){a.rf=parseFloat(e)},lat_0:function(e){a.lat0=e*n},lat_1:function(e){a.lat1=e*n},lat_2:function(e){a.lat2=e*n},lat_ts:function(e){a.lat_ts=e*n},lon_0:function(e){a.long0=e*n},lon_1:function(e){a.long1=e*n},lon_2:function(e){a.long2=e*n},alpha:function(e){a.alpha=parseFloat(e)*n},lonc:function(e){a.longc=e*n},x_0:function(e){a.x0=parseFloat(e)},y_0:function(e){a.y0=parseFloat(e)},k_0:function(e){a.k0=parseFloat(e)},k:function(e){a.k0=parseFloat(e)},a:function(e){a.a=parseFloat(e)},b:function(e){a.b=parseFloat(e)},r_a:function(){a.R_A=!0},zone:function(e){a.zone=parseInt(e,10)},south:function(){a.utmSouth=!0},towgs84:function(e){a.datum_params=e.split(",").map((function(e){return parseFloat(e)}))},to_meter:function(e){a.to_meter=parseFloat(e)},units:function(e){a.units=e;var t=f(c,e);t&&(a.to_meter=t.to_meter)},from_greenwich:function(e){a.from_greenwich=e*n},pm:function(e){var t=f(d,e);a.from_greenwich=(t||parseFloat(e))*n},nadgrids:function(e){"@null"===e?a.datumCode="none":a.nadgrids=e},axis:function(e){3===e.length&&-1!=="ewnsud".indexOf(e.substr(0,1))&&-1!=="ewnsud".indexOf(e.substr(1,1))&&-1!=="ewnsud".indexOf(e.substr(2,1))&&(a.axis=e)}};for(t in s)r=s[t],t in o?"function"==typeof(i=o[t])?i(r):a[i]=r:a[t]=r;return"string"==typeof a.datumCode&&"WGS84"!==a.datumCode&&(a.datumCode=a.datumCode.toLowerCase()),a},g=function(e){return new M(e).output()},v=/\s/,y=/[A-Za-z]/,b=/[A-Za-z84]/,x=/[,\]]/,S=/[\d\.E\-\+]/;function M(e){if("string"!=typeof e)throw new Error("not a string");this.text=e.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=1}function w(e,t,r){Array.isArray(t)&&(r.unshift(t),t=null);var i=t?{}:e,a=r.reduce((function(e,t){return T(t,e),e}),i);t&&(e[t]=a)}function T(e,t){if(Array.isArray(e)){var r=e.shift();if("PARAMETER"===r&&(r=e.shift()),1===e.length)return Array.isArray(e[0])?(t[r]={},void T(e[0],t[r])):void(t[r]=e[0]);if(e.length)if("TOWGS84"!==r){if("AXIS"===r)return r in t||(t[r]=[]),void t[r].push(e);var i;switch(Array.isArray(r)||(t[r]={}),r){case"UNIT":case"PRIMEM":case"VERT_DATUM":return t[r]={name:e[0].toLowerCase(),convert:e[1]},void(3===e.length&&T(e[2],t[r]));case"SPHEROID":case"ELLIPSOID":return t[r]={name:e[0],a:e[1],rf:e[2]},void(4===e.length&&T(e[3],t[r]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return e[0]=["name",e[0]],void w(t,r,e);default:for(i=-1;++i<e.length;)if(!Array.isArray(e[i]))return T(e,t[r]);return w(t,r,e)}}else t[r]=e;else t[r]=!0}else t[e]=!0}M.prototype.readCharicter=function(){var e=this.text[this.place++];if(4!==this.state)for(;v.test(e);){if(this.place>=this.text.length)return;e=this.text[this.place++]}switch(this.state){case 1:return this.neutral(e);case 2:return this.keyword(e);case 4:return this.quoted(e);case 5:return this.afterquote(e);case 3:return this.number(e);case-1:return}},M.prototype.afterquote=function(e){if('"'===e)return this.word+='"',void(this.state=4);if(x.test(e))return this.word=this.word.trim(),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in afterquote yet, index '+this.place)},M.prototype.afterItem=function(e){return","===e?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=1)):"]"===e?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=1,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},M.prototype.number=function(e){if(!S.test(e)){if(x.test(e))return this.word=parseFloat(this.word),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in number yet, index '+this.place)}this.word+=e},M.prototype.quoted=function(e){'"'!==e?this.word+=e:this.state=5},M.prototype.keyword=function(e){if(b.test(e))this.word+=e;else{if("["===e){var t=[];return t.push(this.word),this.level++,null===this.root?this.root=t:this.currentObject.push(t),this.stack.push(this.currentObject),this.currentObject=t,void(this.state=1)}if(!x.test(e))throw new Error("havn't handled \""+e+'" in keyword yet, index '+this.place);this.afterItem(e)}},M.prototype.neutral=function(e){if(y.test(e))return this.word=e,void(this.state=2);if('"'===e)return this.word="",void(this.state=4);if(S.test(e))return this.word=e,void(this.state=3);if(!x.test(e))throw new Error("havn't handled \""+e+'" in neutral yet, index '+this.place);this.afterItem(e)},M.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function A(e){return.017453292519943295*e}var C=function(e){var t=g(e),r=t.shift(),i=t.shift();t.unshift(["name",i]),t.unshift(["type",r]);var a={};return T(t,a),function(e){if("GEOGCS"===e.type?e.projName="longlat":"LOCAL_CS"===e.type?(e.projName="identity",e.local=!0):"object"==typeof e.PROJECTION?e.projName=Object.keys(e.PROJECTION)[0]:e.projName=e.PROJECTION,e.AXIS){for(var t="",r=0,i=e.AXIS.length;r<i;++r){var a=e.AXIS[r][0].toLowerCase();-1!==a.indexOf("north")?t+="n":-1!==a.indexOf("south")?t+="s":-1!==a.indexOf("east")?t+="e":-1!==a.indexOf("west")&&(t+="w")}2===t.length&&(t+="u"),3===t.length&&(e.axis=t)}e.UNIT&&(e.units=e.UNIT.name.toLowerCase(),"metre"===e.units&&(e.units="meter"),e.UNIT.convert&&("GEOGCS"===e.type?e.DATUM&&e.DATUM.SPHEROID&&(e.to_meter=e.UNIT.convert*e.DATUM.SPHEROID.a):e.to_meter=e.UNIT.convert));var s=e.GEOGCS;function n(t){return t*(e.to_meter||1)}"GEOGCS"===e.type&&(s=e),s&&(s.DATUM?e.datumCode=s.DATUM.name.toLowerCase():e.datumCode=s.name.toLowerCase(),"d_"===e.datumCode.slice(0,2)&&(e.datumCode=e.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==e.datumCode&&"new_zealand_1949"!==e.datumCode||(e.datumCode="nzgd49"),"wgs_1984"!==e.datumCode&&"world_geodetic_system_1984"!==e.datumCode||("Mercator_Auxiliary_Sphere"===e.PROJECTION&&(e.sphere=!0),e.datumCode="wgs84"),"_ferro"===e.datumCode.slice(-6)&&(e.datumCode=e.datumCode.slice(0,-6)),"_jakarta"===e.datumCode.slice(-8)&&(e.datumCode=e.datumCode.slice(0,-8)),~e.datumCode.indexOf("belge")&&(e.datumCode="rnb72"),s.DATUM&&s.DATUM.SPHEROID&&(e.ellps=s.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===e.ellps.toLowerCase().slice(0,13)&&(e.ellps="intl"),e.a=s.DATUM.SPHEROID.a,e.rf=parseFloat(s.DATUM.SPHEROID.rf,10)),s.DATUM&&s.DATUM.TOWGS84&&(e.datum_params=s.DATUM.TOWGS84),~e.datumCode.indexOf("osgb_1936")&&(e.datumCode="osgb36"),~e.datumCode.indexOf("osni_1952")&&(e.datumCode="osni52"),(~e.datumCode.indexOf("tm65")||~e.datumCode.indexOf("geodetic_datum_of_1965"))&&(e.datumCode="ire65"),"ch1903+"===e.datumCode&&(e.datumCode="ch1903"),~e.datumCode.indexOf("israel")&&(e.datumCode="isr93")),e.b&&!isFinite(e.b)&&(e.b=e.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_2","Standard_Parallel_2"],["false_easting","False_Easting"],["false_northing","False_Northing"],["central_meridian","Central_Meridian"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",A],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",A],["x0","false_easting",n],["y0","false_northing",n],["long0","central_meridian",A],["lat0","latitude_of_origin",A],["lat0","standard_parallel_1",A],["lat1","standard_parallel_1",A],["lat2","standard_parallel_2",A],["azimuth","Azimuth"],["alpha","azimuth",A],["srsCode","name"]].forEach((function(t){return r=e,a=(i=t)[0],s=i[1],void(!(a in r)&&s in r&&(r[a]=r[s],3===i.length&&(r[a]=i[2](r[a]))));var r,i,a,s})),e.long0||!e.longc||"Albers_Conic_Equal_Area"!==e.projName&&"Lambert_Azimuthal_Equal_Area"!==e.projName||(e.long0=e.longc),e.lat_ts||!e.lat1||"Stereographic_South_Pole"!==e.projName&&"Polar Stereographic (variant B)"!==e.projName||(e.lat0=A(e.lat1>0?90:-90),e.lat_ts=e.lat1)}(a),a};function F(e){var t=this;if(2===arguments.length){var r=arguments[1];"string"==typeof r?"+"===r.charAt(0)?F[e]=m(arguments[1]):F[e]=C(arguments[1]):F[e]=r}else if(1===arguments.length){if(Array.isArray(e))return e.map((function(e){Array.isArray(e)?F.apply(t,e):F(e)}));if("string"==typeof e){if(e in F)return F[e]}else"EPSG"in e?F["EPSG:"+e.EPSG]=e:"ESRI"in e?F["ESRI:"+e.ESRI]=e:"IAU2000"in e?F["IAU2000:"+e.IAU2000]=e:console.log(e);return}}!function(e){e("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),e("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),e("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),e.WGS84=e["EPSG:4326"],e["EPSG:3785"]=e["EPSG:3857"],e.GOOGLE=e["EPSG:3857"],e["EPSG:900913"]=e["EPSG:3857"],e["EPSG:102113"]=e["EPSG:3857"]}(F);var P=F;var L=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];var E=function(e){return function(e){return"string"==typeof e}(e)?function(e){return e in P}(e)?P[e]:function(e){return L.some((function(t){return e.indexOf(t)>-1}))}(e)?C(e):function(e){return"+"===e[0]}(e)?m(e):void 0:e},N=function(e,t){var r,i;if(e=e||{},!t)return e;for(i in t)void 0!==(r=t[i])&&(e[i]=r);return e},B=function(e,t,r){var i=e*t;return r/Math.sqrt(1-i*i)},I=function(e){return e<0?-1:1},k=function(e){return Math.abs(e)<=u?e:e-I(e)*l},R=function(e,t,r){var i=e*r,s=.5*e;return i=Math.pow((1-i)/(1+i),s),Math.tan(.5*(a-t))/i},_=function(e,t){for(var r,i,s=.5*e,n=a-2*Math.atan(t),o=0;o<=15;o++)if(r=e*Math.sin(n),n+=i=a-2*Math.atan(t*Math.pow((1-r)/(1+r),s))-n,Math.abs(i)<=1e-10)return n;return-9999};function z(e){return e}var U=[{init:function(){var e=this.b/this.a;this.es=1-e*e,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=B(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(e){var t,r,i=e.x,n=e.y;if(n*o>90&&n*o<-90&&i*o>180&&i*o<-180)return null;if(Math.abs(Math.abs(n)-a)<=s)return null;if(this.sphere)t=this.x0+this.a*this.k0*k(i-this.long0),r=this.y0+this.a*this.k0*Math.log(Math.tan(h+.5*n));else{var l=Math.sin(n),u=R(this.e,n,l);t=this.x0+this.a*this.k0*k(i-this.long0),r=this.y0-this.a*this.k0*Math.log(u)}return e.x=t,e.y=r,e},inverse:function(e){var t,r,i=e.x-this.x0,s=e.y-this.y0;if(this.sphere)r=a-2*Math.atan(Math.exp(-s/(this.a*this.k0)));else{var n=Math.exp(-s/(this.a*this.k0));if(-9999===(r=_(this.e,n)))return null}return t=k(this.long0+i/(this.a*this.k0)),e.x=t,e.y=r,e},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:z,inverse:z,names:["longlat","identity"]}],D={},O=[];function V(e,t){var r=O.length;return e.names?(O[r]=e,e.names.forEach((function(e){D[e.toLowerCase()]=r})),this):(console.log(t),!0)}var G={start:function(){U.forEach(V)},add:V,get:function(e){if(!e)return!1;var t=e.toLowerCase();return void 0!==D[t]&&O[D[t]]?O[D[t]]:void 0}},j={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},H=j.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};j.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var q={};q.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},q.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},q.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},q.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},q.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},q.potsdam={towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},q.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},q.hermannskogel={towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},q.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},q.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},q.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},q.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},q.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},q.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},q.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},q.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var W=function(e,t,r,a,s,n){var o={};return o.datum_type=void 0===e||"none"===e?5:4,t&&(o.datum_params=t.map(parseFloat),0===o.datum_params[0]&&0===o.datum_params[1]&&0===o.datum_params[2]||(o.datum_type=1),o.datum_params.length>3&&(0===o.datum_params[3]&&0===o.datum_params[4]&&0===o.datum_params[5]&&0===o.datum_params[6]||(o.datum_type=2,o.datum_params[3]*=i,o.datum_params[4]*=i,o.datum_params[5]*=i,o.datum_params[6]=o.datum_params[6]/1e6+1))),o.a=r,o.b=a,o.es=s,o.ep2=n,o};function J(e,t){if(!(this instanceof J))return new J(e);t=t||function(e){if(e)throw e};var r=E(e);if("object"==typeof r){var i=J.projections.get(r.projName);if(i){if(r.datumCode&&"none"!==r.datumCode){var a=f(q,r.datumCode);a&&(r.datum_params=a.towgs84?a.towgs84.split(","):null,r.ellps=a.ellipse,r.datumName=a.datumName?a.datumName:r.datumCode)}r.k0=r.k0||1,r.axis=r.axis||"enu",r.ellps=r.ellps||"wgs84";var n,o,h,l,u,d,c,p=function(e,t,r,i,a){if(!e){var n=f(j,i);n||(n=H),e=n.a,t=n.b,r=n.rf}return r&&!t&&(t=(1-1/r)*e),(0===r||Math.abs(e-t)<s)&&(a=!0,t=e),{a:e,b:t,rf:r,sphere:a}}(r.a,r.b,r.rf,r.ellps,r.sphere),m=(n=p.a,o=p.b,p.rf,h=r.R_A,d=((l=n*n)-(u=o*o))/l,c=0,h?(l=(n*=1-d*(.16666666666666666+d*(.04722222222222222+.022156084656084655*d)))*n,d=0):c=Math.sqrt(d),{es:d,e:c,ep2:(l-u)/u}),g=r.datum||W(r.datumCode,r.datum_params,p.a,p.b,m.es,m.ep2);N(this,r),N(this,i),this.a=p.a,this.b=p.b,this.rf=p.rf,this.sphere=p.sphere,this.es=m.es,this.e=m.e,this.ep2=m.ep2,this.datum=g,this.init(),t(null,this)}else t(e)}else t(e)}J.projections=G,J.projections.start();var Z=J;function Y(e,t,r){var i,s,n,o,h=e.x,l=e.y,u=e.z?e.z:0;if(l<-a&&l>-1.001*a)l=-a;else if(l>a&&l<1.001*a)l=a;else if(l<-a||l>a)return null;return h>Math.PI&&(h-=2*Math.PI),s=Math.sin(l),o=Math.cos(l),n=s*s,{x:((i=r/Math.sqrt(1-t*n))+u)*o*Math.cos(h),y:(i+u)*o*Math.sin(h),z:(i*(1-t)+u)*s}}function K(e,t,r,i){var s,n,o,h,l,u,d,c,p,f,m,g,v,y,b,x=e.x,S=e.y,M=e.z?e.z:0;if(s=Math.sqrt(x*x+S*S),n=Math.sqrt(x*x+S*S+M*M),s/r<1e-12){if(y=0,n/r<1e-12)return a,b=-i,{x:e.x,y:e.y,z:e.z}}else y=Math.atan2(S,x);o=M/n,c=(h=s/n)*(1-t)*(l=1/Math.sqrt(1-t*(2-t)*h*h)),p=o*l,v=0;do{v++,u=t*(d=r/Math.sqrt(1-t*p*p))/(d+(b=s*c+M*p-d*(1-t*p*p))),g=(m=o*(l=1/Math.sqrt(1-u*(2-u)*h*h)))*c-(f=h*(1-u)*l)*p,c=f,p=m}while(g*g>1e-24&&v<30);return{x:y,y:Math.atan(m/Math.abs(f)),z:b}}function X(e){return 1===e||2===e}var Q=function(e,t,r){return function(e,t){return e.datum_type===t.datum_type&&(!(e.a!==t.a||Math.abs(e.es-t.es)>5e-11)&&(1===e.datum_type?e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]:2!==e.datum_type||e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]&&e.datum_params[3]===t.datum_params[3]&&e.datum_params[4]===t.datum_params[4]&&e.datum_params[5]===t.datum_params[5]&&e.datum_params[6]===t.datum_params[6]))}(e,t)||5===e.datum_type||5===t.datum_type?r:e.es!==t.es||e.a!==t.a||X(e.datum_type)||X(t.datum_type)?(r=Y(r,e.es,e.a),X(e.datum_type)&&(r=function(e,t,r){if(1===t)return{x:e.x+r[0],y:e.y+r[1],z:e.z+r[2]};if(2===t){var i=r[0],a=r[1],s=r[2],n=r[3],o=r[4],h=r[5],l=r[6];return{x:l*(e.x-h*e.y+o*e.z)+i,y:l*(h*e.x+e.y-n*e.z)+a,z:l*(-o*e.x+n*e.y+e.z)+s}}}(r,e.datum_type,e.datum_params)),X(t.datum_type)&&(r=function(e,t,r){if(1===t)return{x:e.x-r[0],y:e.y-r[1],z:e.z-r[2]};if(2===t){var i=r[0],a=r[1],s=r[2],n=r[3],o=r[4],h=r[5],l=r[6],u=(e.x-i)/l,d=(e.y-a)/l,c=(e.z-s)/l;return{x:u+h*d-o*c,y:-h*u+d+n*c,z:o*u-n*d+c}}}(r,t.datum_type,t.datum_params)),K(r,t.es,t.a,t.b)):r},$=function(e,t,r){var i,a,s,n=r.x,o=r.y,h=r.z||0,l={};for(s=0;s<3;s++)if(!t||2!==s||void 0!==r.z)switch(0===s?(i=n,a="x"):1===s?(i=o,a="y"):(i=h,a="z"),e.axis[s]){case"e":l[a]=i;break;case"w":l[a]=-i;break;case"n":l[a]=i;break;case"s":l[a]=-i;break;case"u":void 0!==r[a]&&(l.z=i);break;case"d":void 0!==r[a]&&(l.z=-i);break;default:return null}return l},ee=function(e){var t={x:e[0],y:e[1]};return e.length>2&&(t.z=e[2]),e.length>3&&(t.m=e[3]),t};function te(e,t,r){var i;return Array.isArray(r)&&(r=ee(r)),e.datum&&t.datum&&function(e,t){return(1===e.datum.datum_type||2===e.datum.datum_type)&&"WGS84"!==t.datumCode||(1===t.datum.datum_type||2===t.datum.datum_type)&&"WGS84"!==e.datumCode}(e,t)&&(r=te(e,i=new Z("WGS84"),r),e=i),"enu"!==e.axis&&(r=$(e,!1,r)),"longlat"===e.projName?(r.x*=n,r.y*=n):e.isGeocent?(e.to_meter&&(r.x*=e.to_meter,r.y*=e.to_meter,r.z*=e.to_meter),r=K(r,t.es,t.a,t.b)):(e.to_meter&&(r.x*=e.to_meter,r.y*=e.to_meter),r=e.inverse(r)),e.from_greenwich&&(r.x+=e.from_greenwich),r=Q(e.datum,t.datum,r),t.from_greenwich&&(r.x-=t.from_greenwich),"longlat"===t.projName?(r.x*=o,r.y*=o):t.isGeocent?(r=Y(r,t.es,t.a),t.to_meter&&(r.x/=t.to_meter,r.y/=t.to_meter,r.z/=t.to_meter)):(t.forward(r),t.to_meter&&(r.x/=t.to_meter,r.y/=t.to_meter)),"enu"!==t.axis?$(t,!0,r):r}var re=Z("WGS84");function ie(e,t,r){var i;return Array.isArray(r)?(i=te(e,t,r),3===r.length?[i.x,i.y,i.z]:[i.x,i.y]):te(e,t,r)}function ae(e){return e instanceof Z?e:e.oProj?e.oProj:Z(e)}var se=function(e,t,r,i){if(i)return e;e=ae(e);var a,s=!1;return void 0===t?(t=e,e=re,s=!0):(void 0!==t.x||Array.isArray(t))&&(r=t,t=e,e=re,s=!0),t=ae(t),r?ie(e,t,r):(a={forward:function(r){return ie(e,t,r)},inverse:function(r){return ie(t,e,r)},info:function(){return{a:t.a,b:t.b,ra:t.R_A,"proj-name":t.projName}}},s&&(a.oProj=t),a)},ne=73,oe=79,he={forward:le,inverse:function(e){var t=pe(ge(e.toUpperCase()));if(t.lat&&t.lon)return[t.lon,t.lat,t.lon,t.lat];return[t.left,t.bottom,t.right,t.top]},toPoint:ue};function le(e,t){return t=t||5,function(e,t){var r="00000"+e.easting,i="00000"+e.northing;return e.zoneNumber+e.zoneLetter+(p=e.easting,f=e.northing,m=e.zoneNumber,g=me(m),v=Math.floor(p/1e5),y=Math.floor(f/1e5)%20,a=v,s=y,n=g,o=n-1,h="AJSAJS".charCodeAt(o),l="AFAFAF".charCodeAt(o),u=h+a-1,d=l+s,c=!1,u>90&&(u=u-90+65-1,c=!0),(u===ne||h<ne&&u>ne||(u>ne||h<ne)&&c)&&u++,(u===oe||h<oe&&u>oe||(u>oe||h<oe)&&c)&&++u===ne&&u++,u>90&&(u=u-90+65-1),d>86?(d=d-86+65-1,c=!0):c=!1,(d===ne||l<ne&&d>ne||(d>ne||l<ne)&&c)&&d++,(d===oe||l<oe&&d>oe||(d>oe||l<oe)&&c)&&++d===ne&&d++,d>86&&(d=d-86+65-1),String.fromCharCode(u)+String.fromCharCode(d))+r.substr(r.length-5,t)+i.substr(i.length-5,t);var a,s,n,o,h,l,u,d,c;var p,f,m,g,v,y}(function(e){var t,r,i,a,s,n,o,h=e.lat,l=e.lon,u=6378137,d=de(h),c=de(l);o=Math.floor((l+180)/6)+1,180===l&&(o=60);h>=56&&h<64&&l>=3&&l<12&&(o=32);h>=72&&h<84&&(l>=0&&l<9?o=31:l>=9&&l<21?o=33:l>=21&&l<33?o=35:l>=33&&l<42&&(o=37));n=de(6*(o-1)-180+3),.006739496752268451,t=u/Math.sqrt(1-.00669438*Math.sin(d)*Math.sin(d)),r=Math.tan(d)*Math.tan(d),i=.006739496752268451*Math.cos(d)*Math.cos(d),a=Math.cos(d)*(c-n),s=u*(.9983242984503243*d-.002514607064228144*Math.sin(2*d)+2639046602129982e-21*Math.sin(4*d)-3.418046101696858e-9*Math.sin(6*d));var p=.9996*t*(a+(1-r+i)*a*a*a/6+(5-18*r+r*r+72*i-.39089081163157013)*a*a*a*a*a/120)+5e5,f=.9996*(s+t*Math.tan(d)*(a*a/2+(5-r+9*i+4*i*i)*a*a*a*a/24+(61-58*r+r*r+600*i-2.2240339282485886)*a*a*a*a*a*a/720));h<0&&(f+=1e7);return{northing:Math.round(f),easting:Math.round(p),zoneNumber:o,zoneLetter:fe(h)}}({lat:e[1],lon:e[0]}),t)}function ue(e){var t=pe(ge(e.toUpperCase()));return t.lat&&t.lon?[t.lon,t.lat]:[(t.left+t.right)/2,(t.top+t.bottom)/2]}function de(e){return e*(Math.PI/180)}function ce(e){return e/Math.PI*180}function pe(e){var t=e.northing,r=e.easting,i=e.zoneLetter,a=e.zoneNumber;if(a<0||a>60)return null;var s,n,o,h,l,u,d,c,p=6378137,f=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),m=r-5e5,g=t;i<"N"&&(g-=1e7),u=6*(a-1)-180+3,c=(d=g/.9996/6367449.145945056)+(3*f/2-27*f*f*f/32)*Math.sin(2*d)+(21*f*f/16-55*f*f*f*f/32)*Math.sin(4*d)+151*f*f*f/96*Math.sin(6*d),s=p/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),n=Math.tan(c)*Math.tan(c),o=.006739496752268451*Math.cos(c)*Math.cos(c),h=.99330562*p/Math.pow(1-.00669438*Math.sin(c)*Math.sin(c),1.5),l=m/(.9996*s);var v=c-s*Math.tan(c)/h*(l*l/2-(5+3*n+10*o-4*o*o-.06065547077041606)*l*l*l*l/24+(61+90*n+298*o+45*n*n-1.6983531815716497-3*o*o)*l*l*l*l*l*l/720);v=ce(v);var y,b=(l-(1+2*n+o)*l*l*l/6+(5-2*o+28*n-3*o*o+.05391597401814761+24*n*n)*l*l*l*l*l/120)/Math.cos(c);if(b=u+ce(b),e.accuracy){var x=pe({northing:e.northing+e.accuracy,easting:e.easting+e.accuracy,zoneLetter:e.zoneLetter,zoneNumber:e.zoneNumber});y={top:x.lat,right:x.lon,bottom:v,left:b}}else y={lat:v,lon:b};return y}function fe(e){var t="Z";return 84>=e&&e>=72?t="X":72>e&&e>=64?t="W":64>e&&e>=56?t="V":56>e&&e>=48?t="U":48>e&&e>=40?t="T":40>e&&e>=32?t="S":32>e&&e>=24?t="R":24>e&&e>=16?t="Q":16>e&&e>=8?t="P":8>e&&e>=0?t="N":0>e&&e>=-8?t="M":-8>e&&e>=-16?t="L":-16>e&&e>=-24?t="K":-24>e&&e>=-32?t="J":-32>e&&e>=-40?t="H":-40>e&&e>=-48?t="G":-48>e&&e>=-56?t="F":-56>e&&e>=-64?t="E":-64>e&&e>=-72?t="D":-72>e&&e>=-80&&(t="C"),t}function me(e){var t=e%6;return 0===t&&(t=6),t}function ge(e){if(e&&0===e.length)throw"MGRSPoint coverting from nothing";for(var t,r=e.length,i=null,a="",s=0;!/[A-Z]/.test(t=e.charAt(s));){if(s>=2)throw"MGRSPoint bad conversion from: "+e;a+=t,s++}var n=parseInt(a,10);if(0===s||s+3>r)throw"MGRSPoint bad conversion from: "+e;var o=e.charAt(s++);if(o<="A"||"B"===o||"Y"===o||o>="Z"||"I"===o||"O"===o)throw"MGRSPoint zone letter "+o+" not handled: "+e;i=e.substring(s,s+=2);for(var h=me(n),l=function(e,t){var r="AJSAJS".charCodeAt(t-1),i=1e5,a=!1;for(;r!==e.charCodeAt(0);){if(++r===ne&&r++,r===oe&&r++,r>90){if(a)throw"Bad character: "+e;r=65,a=!0}i+=1e5}return i}(i.charAt(0),h),u=function(e,t){if(e>"V")throw"MGRSPoint given invalid Northing "+e;var r="AFAFAF".charCodeAt(t-1),i=0,a=!1;for(;r!==e.charCodeAt(0);){if(++r===ne&&r++,r===oe&&r++,r>86){if(a)throw"Bad character: "+e;r=65,a=!0}i+=1e5}return i}(i.charAt(1),h);u<ve(o);)u+=2e6;var d=r-s;if(d%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+e;var c,p,f,m=d/2,g=0,v=0;return m>0&&(c=1e5/Math.pow(10,m),p=e.substring(s,s+m),g=parseFloat(p)*c,f=e.substring(s+m),v=parseFloat(f)*c),{easting:g+l,northing:v+u,zoneLetter:o,zoneNumber:n,accuracy:c}}function ve(e){var t;switch(e){case"C":t=11e5;break;case"D":t=2e6;break;case"E":t=28e5;break;case"F":t=37e5;break;case"G":t=46e5;break;case"H":t=55e5;break;case"J":t=64e5;break;case"K":t=73e5;break;case"L":t=82e5;break;case"M":t=91e5;break;case"N":t=0;break;case"P":t=8e5;break;case"Q":t=17e5;break;case"R":t=26e5;break;case"S":t=35e5;break;case"T":t=44e5;break;case"U":t=53e5;break;case"V":t=62e5;break;case"W":t=7e6;break;case"X":t=79e5;break;default:t=-1}if(t>=0)return t;throw"Invalid zone letter: "+e}function ye(e,t,r){if(!(this instanceof ye))return new ye(e,t,r);if(Array.isArray(e))this.x=e[0],this.y=e[1],this.z=e[2]||0;else if("object"==typeof e)this.x=e.x,this.y=e.y,this.z=e.z||0;else if("string"==typeof e&&void 0===t){var i=e.split(",");this.x=parseFloat(i[0],10),this.y=parseFloat(i[1],10),this.z=parseFloat(i[2],10)||0}else this.x=e,this.y=t,this.z=r||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}ye.fromMGRS=function(e){return new ye(ue(e))},ye.prototype.toMGRS=function(e){return le([this.x,this.y],e)};var be=ye,xe=r(9),Se=.01068115234375,Me=function(e){var t=[];t[0]=1-e*(.25+e*(.046875+e*(.01953125+e*Se))),t[1]=e*(.75-e*(.046875+e*(.01953125+e*Se)));var r=e*e;return t[2]=r*(.46875-e*(.013020833333333334+.007120768229166667*e)),r*=e,t[3]=r*(.3645833333333333-.005696614583333333*e),t[4]=r*e*.3076171875,t},we=function(e,t,r,i){return r*=t,t*=t,i[0]*e-r*(i[1]+t*(i[2]+t*(i[3]+t*i[4])))},Te=function(e,t,r){for(var i=1/(1-t),a=e,n=20;n;--n){var o=Math.sin(a),h=1-t*o*o;if(a-=h=(we(a,o,Math.cos(a),r)-e)*(h*Math.sqrt(h))*i,Math.abs(h)<s)return a}return a};var Ae={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=Me(this.es),this.ml0=we(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(e){var t,r,i,a=e.x,n=e.y,o=k(a-this.long0),h=Math.sin(n),l=Math.cos(n);if(this.es){var u=l*o,d=Math.pow(u,2),c=this.ep2*Math.pow(l,2),p=Math.pow(c,2),f=Math.abs(l)>s?Math.tan(n):0,m=Math.pow(f,2),g=Math.pow(m,2);t=1-this.es*Math.pow(h,2),u/=Math.sqrt(t);var v=we(n,h,l,this.en);r=this.a*(this.k0*u*(1+d/6*(1-m+c+d/20*(5-18*m+g+14*c-58*m*c+d/42*(61+179*g-g*m-479*m)))))+this.x0,i=this.a*(this.k0*(v-this.ml0+h*o*u/2*(1+d/12*(5-m+9*c+4*p+d/30*(61+g-58*m+270*c-330*m*c+d/56*(1385+543*g-g*m-3111*m))))))+this.y0}else{var y=l*Math.sin(o);if(Math.abs(Math.abs(y)-1)<s)return 93;if(r=.5*this.a*this.k0*Math.log((1+y)/(1-y))+this.x0,i=l*Math.cos(o)/Math.sqrt(1-Math.pow(y,2)),(y=Math.abs(i))>=1){if(y-1>s)return 93;i=0}else i=Math.acos(i);n<0&&(i=-i),i=this.a*this.k0*(i-this.lat0)+this.y0}return e.x=r,e.y=i,e},inverse:function(e){var t,r,i,n,o=(e.x-this.x0)*(1/this.a),h=(e.y-this.y0)*(1/this.a);if(this.es)if(t=this.ml0+h/this.k0,r=Te(t,this.es,this.en),Math.abs(r)<a){var l=Math.sin(r),u=Math.cos(r),d=Math.abs(u)>s?Math.tan(r):0,c=this.ep2*Math.pow(u,2),p=Math.pow(c,2),f=Math.pow(d,2),m=Math.pow(f,2);t=1-this.es*Math.pow(l,2);var g=o*Math.sqrt(t)/this.k0,v=Math.pow(g,2);i=r-(t*=d)*v/(1-this.es)*.5*(1-v/12*(5+3*f-9*c*f+c-4*p-v/30*(61+90*f-252*c*f+45*m+46*c-v/56*(1385+3633*f+4095*m+1574*m*f)))),n=k(this.long0+g*(1-v/6*(1+2*f+c-v/20*(5+28*f+24*m+8*c*f+6*c-v/42*(61+662*f+1320*m+720*m*f))))/u)}else i=a*I(h),n=0;else{var y=Math.exp(o/this.k0),b=.5*(y-1/y),x=this.lat0+h/this.k0,S=Math.cos(x);t=Math.sqrt((1-Math.pow(S,2))/(1+Math.pow(b,2))),i=Math.asin(t),h<0&&(i=-i),n=0===b&&0===S?0:k(Math.atan2(b,S)+this.long0)}return e.x=n,e.y=i,e},names:["Transverse_Mercator","Transverse Mercator","tmerc"]},Ce=function(e){var t=Math.exp(e);return t=(t-1/t)/2},Fe=function(e,t){e=Math.abs(e),t=Math.abs(t);var r=Math.max(e,t),i=Math.min(e,t)/(r||1);return r*Math.sqrt(1+Math.pow(i,2))},Pe=function(e){var t=Math.abs(e);return t=function(e){var t=1+e,r=t-1;return 0===r?e:e*Math.log(t)/r}(t*(1+t/(Fe(1,t)+1))),e<0?-t:t},Le=function(e,t){for(var r,i=2*Math.cos(2*t),a=e.length-1,s=e[a],n=0;--a>=0;)r=i*s-n+e[a],n=s,s=r;return t+r*Math.sin(2*t)},Ee=function(e,t,r){for(var i,a,s=Math.sin(t),n=Math.cos(t),o=Ce(r),h=function(e){var t=Math.exp(e);return t=(t+1/t)/2}(r),l=2*n*h,u=-2*s*o,d=e.length-1,c=e[d],p=0,f=0,m=0;--d>=0;)i=f,a=p,c=l*(f=c)-i-u*(p=m)+e[d],m=u*f-a+l*p;return[(l=s*h)*c-(u=n*o)*m,l*m+u*c]};var Ne={init:function(){if(void 0===this.es||this.es<=0)throw new Error("incorrect elliptical usage");this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var e=this.es/(1+Math.sqrt(1-this.es)),t=e/(2-e),r=t;this.cgb[0]=t*(2+t*(-2/3+t*(t*(116/45+t*(26/45+t*(-2854/675)))-2))),this.cbg[0]=t*(t*(2/3+t*(4/3+t*(-82/45+t*(32/45+t*(4642/4725)))))-2),r*=t,this.cgb[1]=r*(7/3+t*(t*(-227/45+t*(2704/315+t*(2323/945)))-1.6)),this.cbg[1]=r*(5/3+t*(-16/15+t*(-13/9+t*(904/315+t*(-1522/945))))),r*=t,this.cgb[2]=r*(56/15+t*(-136/35+t*(-1262/105+t*(73814/2835)))),this.cbg[2]=r*(-26/15+t*(34/21+t*(1.6+t*(-12686/2835)))),r*=t,this.cgb[3]=r*(4279/630+t*(-332/35+t*(-399572/14175))),this.cbg[3]=r*(1237/630+t*(t*(-24832/14175)-2.4)),r*=t,this.cgb[4]=r*(4174/315+t*(-144838/6237)),this.cbg[4]=r*(-734/315+t*(109598/31185)),r*=t,this.cgb[5]=r*(601676/22275),this.cbg[5]=r*(444337/155925),r=Math.pow(t,2),this.Qn=this.k0/(1+t)*(1+r*(1/4+r*(1/64+r/256))),this.utg[0]=t*(t*(2/3+t*(-37/96+t*(1/360+t*(81/512+t*(-96199/604800)))))-.5),this.gtu[0]=t*(.5+t*(-2/3+t*(5/16+t*(41/180+t*(-127/288+t*(7891/37800)))))),this.utg[1]=r*(-1/48+t*(-1/15+t*(437/1440+t*(-46/105+t*(1118711/3870720))))),this.gtu[1]=r*(13/48+t*(t*(557/1440+t*(281/630+t*(-1983433/1935360)))-.6)),r*=t,this.utg[2]=r*(-17/480+t*(37/840+t*(209/4480+t*(-5569/90720)))),this.gtu[2]=r*(61/240+t*(-103/140+t*(15061/26880+t*(167603/181440)))),r*=t,this.utg[3]=r*(-4397/161280+t*(11/504+t*(830251/7257600))),this.gtu[3]=r*(49561/161280+t*(-179/168+t*(6601661/7257600))),r*=t,this.utg[4]=r*(-4583/161280+t*(108847/3991680)),this.gtu[4]=r*(34729/80640+t*(-3418889/1995840)),r*=t,this.utg[5]=r*(-20648693/638668800),this.gtu[5]=.6650675310896665*r;var i=Le(this.cbg,this.lat0);this.Zb=-this.Qn*(i+function(e,t){for(var r,i=2*Math.cos(t),a=e.length-1,s=e[a],n=0;--a>=0;)r=i*s-n+e[a],n=s,s=r;return Math.sin(t)*r}(this.gtu,2*i))},forward:function(e){var t=k(e.x-this.long0),r=e.y;r=Le(this.cbg,r);var i=Math.sin(r),a=Math.cos(r),s=Math.sin(t),n=Math.cos(t);r=Math.atan2(i,n*a),t=Math.atan2(s*a,Fe(i,a*n)),t=Pe(Math.tan(t));var o,h,l=Ee(this.gtu,2*r,2*t);return r+=l[0],t+=l[1],Math.abs(t)<=2.623395162778?(o=this.a*(this.Qn*t)+this.x0,h=this.a*(this.Qn*r+this.Zb)+this.y0):(o=1/0,h=1/0),e.x=o,e.y=h,e},inverse:function(e){var t,r,i=(e.x-this.x0)*(1/this.a),a=(e.y-this.y0)*(1/this.a);if(a=(a-this.Zb)/this.Qn,i/=this.Qn,Math.abs(i)<=2.623395162778){var s=Ee(this.utg,2*a,2*i);a+=s[0],i+=s[1],i=Math.atan(Ce(i));var n=Math.sin(a),o=Math.cos(a),h=Math.sin(i),l=Math.cos(i);a=Math.atan2(n*l,Fe(h,l*o)),i=Math.atan2(h,l*o),t=k(i+this.long0),r=Le(this.cgb,a)}else t=1/0,r=1/0;return e.x=t,e.y=r,e},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc"]};var Be={init:function(){var e=function(e,t){if(void 0===e){if((e=Math.floor(30*(k(t)+Math.PI)/Math.PI)+1)<0)return 0;if(e>60)return 60}return e}(this.zone,this.long0);if(void 0===e)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(e)-183)*n,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Ne.init.apply(this),this.forward=Ne.forward,this.inverse=Ne.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"},Ie=function(e,t){return Math.pow((1-e)/(1+e),t)};var ke={init:function(){var e=Math.sin(this.lat0),t=Math.cos(this.lat0);t*=t,this.rc=Math.sqrt(1-this.es)/(1-this.es*e*e),this.C=Math.sqrt(1+this.es*t*t/(1-this.es)),this.phic0=Math.asin(e/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+h)/(Math.pow(Math.tan(.5*this.lat0+h),this.C)*Ie(this.e*e,this.ratexp))},forward:function(e){var t=e.x,r=e.y;return e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*r+h),this.C)*Ie(this.e*Math.sin(r),this.ratexp))-a,e.x=this.C*t,e},inverse:function(e){for(var t=e.x/this.C,r=e.y,i=Math.pow(Math.tan(.5*r+h)/this.K,1/this.C),s=20;s>0&&(r=2*Math.atan(i*Ie(this.e*Math.sin(e.y),-.5*this.e))-a,!(Math.abs(r-e.y)<1e-14));--s)e.y=r;return s?(e.x=t,e.y=r,e):null},names:["gauss"]};var Re={init:function(){ke.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(e){var t,r,i,a;return e.x=k(e.x-this.long0),ke.forward.apply(this,[e]),t=Math.sin(e.y),r=Math.cos(e.y),i=Math.cos(e.x),a=this.k0*this.R2/(1+this.sinc0*t+this.cosc0*r*i),e.x=a*r*Math.sin(e.x),e.y=a*(this.cosc0*t-this.sinc0*r*i),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){var t,r,i,a,s;if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,s=Math.sqrt(e.x*e.x+e.y*e.y)){var n=2*Math.atan2(s,this.R2);t=Math.sin(n),r=Math.cos(n),a=Math.asin(r*this.sinc0+e.y*t*this.cosc0/s),i=Math.atan2(e.x*t,s*this.cosc0*r-e.y*this.sinc0*t)}else a=this.phic0,i=0;return e.x=i,e.y=a,ke.inverse.apply(this,[e]),e.x=k(e.x+this.long0),e},names:["Stereographic_North_Pole","Oblique_Stereographic","Polar_Stereographic","sterea","Oblique Stereographic Alternative"]};var _e={init:function(){this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=s&&(this.k0=.5*(1+I(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=s&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=s&&(this.k0=.5*this.cons*B(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/R(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=B(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-a,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(e){var t,r,i,n,o,h,l=e.x,u=e.y,d=Math.sin(u),c=Math.cos(u),p=k(l-this.long0);return Math.abs(Math.abs(l-this.long0)-Math.PI)<=s&&Math.abs(u+this.lat0)<=s?(e.x=NaN,e.y=NaN,e):this.sphere?(t=2*this.k0/(1+this.sinlat0*d+this.coslat0*c*Math.cos(p)),e.x=this.a*t*c*Math.sin(p)+this.x0,e.y=this.a*t*(this.coslat0*d-this.sinlat0*c*Math.cos(p))+this.y0,e):(r=2*Math.atan(this.ssfn_(u,d,this.e))-a,n=Math.cos(r),i=Math.sin(r),Math.abs(this.coslat0)<=s?(o=R(this.e,u*this.con,this.con*d),h=2*this.a*this.k0*o/this.cons,e.x=this.x0+h*Math.sin(l-this.long0),e.y=this.y0-this.con*h*Math.cos(l-this.long0),e):(Math.abs(this.sinlat0)<s?(t=2*this.a*this.k0/(1+n*Math.cos(p)),e.y=t*i):(t=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*i+this.cosX0*n*Math.cos(p))),e.y=t*(this.cosX0*i-this.sinX0*n*Math.cos(p))+this.y0),e.x=t*n*Math.sin(p)+this.x0,e))},inverse:function(e){var t,r,i,n,o;e.x-=this.x0,e.y-=this.y0;var h=Math.sqrt(e.x*e.x+e.y*e.y);if(this.sphere){var l=2*Math.atan(h/(.5*this.a*this.k0));return t=this.long0,r=this.lat0,h<=s?(e.x=t,e.y=r,e):(r=Math.asin(Math.cos(l)*this.sinlat0+e.y*Math.sin(l)*this.coslat0/h),t=Math.abs(this.coslat0)<s?this.lat0>0?k(this.long0+Math.atan2(e.x,-1*e.y)):k(this.long0+Math.atan2(e.x,e.y)):k(this.long0+Math.atan2(e.x*Math.sin(l),h*this.coslat0*Math.cos(l)-e.y*this.sinlat0*Math.sin(l))),e.x=t,e.y=r,e)}if(Math.abs(this.coslat0)<=s){if(h<=s)return r=this.lat0,t=this.long0,e.x=t,e.y=r,e;e.x*=this.con,e.y*=this.con,i=h*this.cons/(2*this.a*this.k0),r=this.con*_(this.e,i),t=this.con*k(this.con*this.long0+Math.atan2(e.x,-1*e.y))}else n=2*Math.atan(h*this.cosX0/(2*this.a*this.k0*this.ms1)),t=this.long0,h<=s?o=this.X0:(o=Math.asin(Math.cos(n)*this.sinX0+e.y*Math.sin(n)*this.cosX0/h),t=k(this.long0+Math.atan2(e.x*Math.sin(n),h*this.cosX0*Math.cos(n)-e.y*this.sinX0*Math.sin(n)))),r=-1*_(this.e,Math.tan(.5*(a+o)));return e.x=t,e.y=r,e},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)"],ssfn_:function(e,t,r){return t*=r,Math.tan(.5*(a+e))*Math.pow((1-t)/(1+t),.5*r)}};var ze={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),r=this.a,i=1/this.rf,a=2*i-Math.pow(i,2),s=this.e=Math.sqrt(a);this.R=this.k0*r*Math.sqrt(1-a)/(1-a*Math.pow(t,2)),this.alpha=Math.sqrt(1+a/(1-a)*Math.pow(Math.cos(e),4)),this.b0=Math.asin(t/this.alpha);var n=Math.log(Math.tan(Math.PI/4+this.b0/2)),o=Math.log(Math.tan(Math.PI/4+e/2)),h=Math.log((1+s*t)/(1-s*t));this.K=n-this.alpha*o+this.alpha*s/2*h},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),r=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),i=-this.alpha*(t+r)+this.K,a=2*(Math.atan(Math.exp(i))-Math.PI/4),s=this.alpha*(e.x-this.lambda0),n=Math.atan(Math.sin(s)/(Math.sin(this.b0)*Math.tan(a)+Math.cos(this.b0)*Math.cos(s))),o=Math.asin(Math.cos(this.b0)*Math.sin(a)-Math.sin(this.b0)*Math.cos(a)*Math.cos(s));return e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,e.x=this.R*n+this.x0,e},inverse:function(e){for(var t=e.x-this.x0,r=e.y-this.y0,i=t/this.R,a=2*(Math.atan(Math.exp(r/this.R))-Math.PI/4),s=Math.asin(Math.cos(this.b0)*Math.sin(a)+Math.sin(this.b0)*Math.cos(a)*Math.cos(i)),n=Math.atan(Math.sin(i)/(Math.cos(this.b0)*Math.cos(i)-Math.sin(this.b0)*Math.tan(a))),o=this.lambda0+n/this.alpha,h=0,l=s,u=-1e3,d=0;Math.abs(l-u)>1e-7;){if(++d>20)return;h=1/this.alpha*(Math.log(Math.tan(Math.PI/4+s/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(l))/2)),u=l,l=2*Math.atan(Math.exp(h))-Math.PI/2}return e.x=o,e.y=l,e},names:["somerc"]};var Ue={init:function(){this.no_off=this.no_off||!1,this.no_rot=this.no_rot||!1,isNaN(this.k0)&&(this.k0=1);var e=Math.sin(this.lat0),t=Math.cos(this.lat0),r=this.e*e;this.bl=Math.sqrt(1+this.es/(1-this.es)*Math.pow(t,4)),this.al=this.a*this.bl*this.k0*Math.sqrt(1-this.es)/(1-r*r);var i,a,s=R(this.e,this.lat0,e),n=this.bl/t*Math.sqrt((1-this.es)/(1-r*r));if(n*n<1&&(n=1),isNaN(this.longc)){var o=R(this.e,this.lat1,Math.sin(this.lat1)),h=R(this.e,this.lat2,Math.sin(this.lat2));this.lat0>=0?this.el=(n+Math.sqrt(n*n-1))*Math.pow(s,this.bl):this.el=(n-Math.sqrt(n*n-1))*Math.pow(s,this.bl);var l=Math.pow(o,this.bl),u=Math.pow(h,this.bl);a=.5*((i=this.el/l)-1/i);var d=(this.el*this.el-u*l)/(this.el*this.el+u*l),c=(u-l)/(u+l),p=k(this.long1-this.long2);this.long0=.5*(this.long1+this.long2)-Math.atan(d*Math.tan(.5*this.bl*p)/c)/this.bl,this.long0=k(this.long0);var f=k(this.long1-this.long0);this.gamma0=Math.atan(Math.sin(this.bl*f)/a),this.alpha=Math.asin(n*Math.sin(this.gamma0))}else i=this.lat0>=0?n+Math.sqrt(n*n-1):n-Math.sqrt(n*n-1),this.el=i*Math.pow(s,this.bl),a=.5*(i-1/i),this.gamma0=Math.asin(Math.sin(this.alpha)/n),this.long0=this.longc-Math.asin(a*Math.tan(this.gamma0))/this.bl;this.no_off?this.uc=0:this.lat0>=0?this.uc=this.al/this.bl*Math.atan2(Math.sqrt(n*n-1),Math.cos(this.alpha)):this.uc=-1*this.al/this.bl*Math.atan2(Math.sqrt(n*n-1),Math.cos(this.alpha))},forward:function(e){var t,r,i,n=e.x,o=e.y,l=k(n-this.long0);if(Math.abs(Math.abs(o)-a)<=s)i=o>0?-1:1,r=this.al/this.bl*Math.log(Math.tan(h+i*this.gamma0*.5)),t=-1*i*a*this.al/this.bl;else{var u=R(this.e,o,Math.sin(o)),d=this.el/Math.pow(u,this.bl),c=.5*(d-1/d),p=.5*(d+1/d),f=Math.sin(this.bl*l),m=(c*Math.sin(this.gamma0)-f*Math.cos(this.gamma0))/p;r=Math.abs(Math.abs(m)-1)<=s?Number.POSITIVE_INFINITY:.5*this.al*Math.log((1-m)/(1+m))/this.bl,t=Math.abs(Math.cos(this.bl*l))<=s?this.al*this.bl*l:this.al*Math.atan2(c*Math.cos(this.gamma0)+f*Math.sin(this.gamma0),Math.cos(this.bl*l))/this.bl}return this.no_rot?(e.x=this.x0+t,e.y=this.y0+r):(t-=this.uc,e.x=this.x0+r*Math.cos(this.alpha)+t*Math.sin(this.alpha),e.y=this.y0+t*Math.cos(this.alpha)-r*Math.sin(this.alpha)),e},inverse:function(e){var t,r;this.no_rot?(r=e.y-this.y0,t=e.x-this.x0):(r=(e.x-this.x0)*Math.cos(this.alpha)-(e.y-this.y0)*Math.sin(this.alpha),t=(e.y-this.y0)*Math.cos(this.alpha)+(e.x-this.x0)*Math.sin(this.alpha),t+=this.uc);var i=Math.exp(-1*this.bl*r/this.al),n=.5*(i-1/i),o=.5*(i+1/i),h=Math.sin(this.bl*t/this.al),l=(h*Math.cos(this.gamma0)+n*Math.sin(this.gamma0))/o,u=Math.pow(this.el/Math.sqrt((1+l)/(1-l)),1/this.bl);return Math.abs(l-1)<s?(e.x=this.long0,e.y=a):Math.abs(l+1)<s?(e.x=this.long0,e.y=-1*a):(e.y=_(this.e,u),e.x=k(this.long0-Math.atan2(n*Math.cos(this.gamma0)-h*Math.sin(this.gamma0),Math.cos(this.bl*t/this.al))/this.bl)),e},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","omerc"]};var De={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<s)){var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),r=Math.cos(this.lat1),i=B(this.e,t,r),a=R(this.e,this.lat1,t),n=Math.sin(this.lat2),o=Math.cos(this.lat2),h=B(this.e,n,o),l=R(this.e,this.lat2,n),u=R(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>s?this.ns=Math.log(i/h)/Math.log(a/l):this.ns=t,isNaN(this.ns)&&(this.ns=t),this.f0=i/(this.ns*Math.pow(a,this.ns)),this.rh=this.a*this.f0*Math.pow(u,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(e){var t=e.x,r=e.y;Math.abs(2*Math.abs(r)-Math.PI)<=s&&(r=I(r)*(a-2*s));var i,n,o=Math.abs(Math.abs(r)-a);if(o>s)i=R(this.e,r,Math.sin(r)),n=this.a*this.f0*Math.pow(i,this.ns);else{if((o=r*this.ns)<=0)return null;n=0}var h=this.ns*k(t-this.long0);return e.x=this.k0*(n*Math.sin(h))+this.x0,e.y=this.k0*(this.rh-n*Math.cos(h))+this.y0,e},inverse:function(e){var t,r,i,s,n,o=(e.x-this.x0)/this.k0,h=this.rh-(e.y-this.y0)/this.k0;this.ns>0?(t=Math.sqrt(o*o+h*h),r=1):(t=-Math.sqrt(o*o+h*h),r=-1);var l=0;if(0!==t&&(l=Math.atan2(r*o,r*h)),0!==t||this.ns>0){if(r=1/this.ns,i=Math.pow(t/(this.a*this.f0),r),-9999===(s=_(this.e,i)))return null}else s=-a;return n=k(l/this.ns+this.long0),e.x=n,e.y=s,e},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_2SP","lcc"]};var Oe={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(e){var t,r,i,a,s,n,o,h=e.x,l=e.y,u=k(h-this.long0);return t=Math.pow((1+this.e*Math.sin(l))/(1-this.e*Math.sin(l)),this.alfa*this.e/2),r=2*(Math.atan(this.k*Math.pow(Math.tan(l/2+this.s45),this.alfa)/t)-this.s45),i=-u*this.alfa,a=Math.asin(Math.cos(this.ad)*Math.sin(r)+Math.sin(this.ad)*Math.cos(r)*Math.cos(i)),s=Math.asin(Math.cos(r)*Math.sin(i)/Math.cos(a)),n=this.n*s,o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(a/2+this.s45),this.n),e.y=o*Math.cos(n)/1,e.x=o*Math.sin(n)/1,this.czech||(e.y*=-1,e.x*=-1),e},inverse:function(e){var t,r,i,a,s,n,o,h=e.x;e.x=e.y,e.y=h,this.czech||(e.y*=-1,e.x*=-1),s=Math.sqrt(e.x*e.x+e.y*e.y),a=Math.atan2(e.y,e.x)/Math.sin(this.s0),i=2*(Math.atan(Math.pow(this.ro0/s,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),t=Math.asin(Math.cos(this.ad)*Math.sin(i)-Math.sin(this.ad)*Math.cos(i)*Math.cos(a)),r=Math.asin(Math.cos(i)*Math.sin(a)/Math.cos(t)),e.x=this.long0-r/this.alfa,n=t,o=0;var l=0;do{e.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(t/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(n))/(1-this.e*Math.sin(n)),this.e/2))-this.s45),Math.abs(n-e.y)<1e-10&&(o=1),n=e.y,l+=1}while(0===o&&l<15);return l>=15?null:e},names:["Krovak","krovak"]},Ve=function(e,t,r,i,a){return e*a-t*Math.sin(2*a)+r*Math.sin(4*a)-i*Math.sin(6*a)},Ge=function(e){return 1-.25*e*(1+e/16*(3+1.25*e))},je=function(e){return.375*e*(1+.25*e*(1+.46875*e))},He=function(e){return.05859375*e*e*(1+.75*e)},qe=function(e){return e*e*e*(35/3072)},We=function(e,t,r){var i=t*r;return e/Math.sqrt(1-i*i)},Je=function(e){return Math.abs(e)<a?e:e-I(e)*Math.PI},Ze=function(e,t,r,i,a){var s,n;s=e/t;for(var o=0;o<15;o++)if(s+=n=(e-(t*s-r*Math.sin(2*s)+i*Math.sin(4*s)-a*Math.sin(6*s)))/(t-2*r*Math.cos(2*s)+4*i*Math.cos(4*s)-6*a*Math.cos(6*s)),Math.abs(n)<=1e-10)return s;return NaN};var Ye={init:function(){this.sphere||(this.e0=Ge(this.es),this.e1=je(this.es),this.e2=He(this.es),this.e3=qe(this.es),this.ml0=this.a*Ve(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(e){var t,r,i=e.x,a=e.y;if(i=k(i-this.long0),this.sphere)t=this.a*Math.asin(Math.cos(a)*Math.sin(i)),r=this.a*(Math.atan2(Math.tan(a),Math.cos(i))-this.lat0);else{var s=Math.sin(a),n=Math.cos(a),o=We(this.a,this.e,s),h=Math.tan(a)*Math.tan(a),l=i*Math.cos(a),u=l*l,d=this.es*n*n/(1-this.es);t=o*l*(1-u*h*(1/6-(8-h+8*d)*u/120)),r=this.a*Ve(this.e0,this.e1,this.e2,this.e3,a)-this.ml0+o*s/n*u*(.5+(5-h+6*d)*u/24)}return e.x=t+this.x0,e.y=r+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,r,i=e.x/this.a,n=e.y/this.a;if(this.sphere){var o=n+this.lat0;t=Math.asin(Math.sin(o)*Math.cos(i)),r=Math.atan2(Math.tan(i),Math.cos(o))}else{var h=this.ml0/this.a+n,l=Ze(h,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(l)-a)<=s)return e.x=this.long0,e.y=a,n<0&&(e.y*=-1),e;var u=We(this.a,this.e,Math.sin(l)),d=u*u*u/this.a/this.a*(1-this.es),c=Math.pow(Math.tan(l),2),p=i*this.a/u,f=p*p;t=l-u*Math.tan(l)/d*p*p*(.5-(1+3*c)*p*p/24),r=p*(1-f*(c/3+(1+3*c)*c*f/15))/Math.cos(l)}return e.x=k(r+this.long0),e.y=Je(t),e},names:["Cassini","Cassini_Soldner","cass"]},Ke=function(e,t){var r;return e>1e-7?(1-e*e)*(t/(1-(r=e*t)*r)-.5/e*Math.log((1-r)/(1+r))):2*t};var Xe={init:function(){var e,t=Math.abs(this.lat0);if(Math.abs(t-a)<s?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(t)<s?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=Ke(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(e){var t,r=[];return r[0]=.3333333333333333*e,t=e*e,r[0]+=.17222222222222222*t,r[1]=.06388888888888888*t,t*=e,r[0]+=.10257936507936508*t,r[1]+=.0664021164021164*t,r[2]=.016415012942191543*t,r}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),e=Math.sin(this.lat0),this.sinb1=Ke(this.e,e)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*e*e)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(e){var t,r,i,n,o,l,u,d,c,p,f=e.x,m=e.y;if(f=k(f-this.long0),this.sphere){if(o=Math.sin(m),p=Math.cos(m),i=Math.cos(f),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((r=this.mode===this.EQUIT?1+p*i:1+this.sinph0*o+this.cosph0*p*i)<=s)return null;t=(r=Math.sqrt(2/r))*p*Math.sin(f),r*=this.mode===this.EQUIT?o:this.cosph0*o-this.sinph0*p*i}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(i=-i),Math.abs(m+this.phi0)<s)return null;r=h-.5*m,t=(r=2*(this.mode===this.S_POLE?Math.cos(r):Math.sin(r)))*Math.sin(f),r*=i}}else{switch(u=0,d=0,c=0,i=Math.cos(f),n=Math.sin(f),o=Math.sin(m),l=Ke(this.e,o),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(u=l/this.qp,d=Math.sqrt(1-u*u)),this.mode){case this.OBLIQ:c=1+this.sinb1*u+this.cosb1*d*i;break;case this.EQUIT:c=1+d*i;break;case this.N_POLE:c=a+m,l=this.qp-l;break;case this.S_POLE:c=m-a,l=this.qp+l}if(Math.abs(c)<s)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:c=Math.sqrt(2/c),r=this.mode===this.OBLIQ?this.ymf*c*(this.cosb1*u-this.sinb1*d*i):(c=Math.sqrt(2/(1+d*i)))*u*this.ymf,t=this.xmf*c*d*n;break;case this.N_POLE:case this.S_POLE:l>=0?(t=(c=Math.sqrt(l))*n,r=i*(this.mode===this.S_POLE?c:-c)):t=r=0}}return e.x=this.a*t+this.x0,e.y=this.a*r+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,r,i,n,o,h,l,u,d,c,p=e.x/this.a,f=e.y/this.a;if(this.sphere){var m,g=0,v=0;if((r=.5*(m=Math.sqrt(p*p+f*f)))>1)return null;switch(r=2*Math.asin(r),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(v=Math.sin(r),g=Math.cos(r)),this.mode){case this.EQUIT:r=Math.abs(m)<=s?0:Math.asin(f*v/m),p*=v,f=g*m;break;case this.OBLIQ:r=Math.abs(m)<=s?this.phi0:Math.asin(g*this.sinph0+f*v*this.cosph0/m),p*=v*this.cosph0,f=(g-Math.sin(r)*this.sinph0)*m;break;case this.N_POLE:f=-f,r=a-r;break;case this.S_POLE:r-=a}t=0!==f||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(p,f):0}else{if(l=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(p/=this.dd,f*=this.dd,(h=Math.sqrt(p*p+f*f))<s)return e.x=0,e.y=this.phi0,e;n=2*Math.asin(.5*h/this.rq),i=Math.cos(n),p*=n=Math.sin(n),this.mode===this.OBLIQ?(l=i*this.sinb1+f*n*this.cosb1/h,o=this.qp*l,f=h*this.cosb1*i-f*this.sinb1*n):(l=f*n/h,o=this.qp*l,f=h*i)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(f=-f),!(o=p*p+f*f))return e.x=0,e.y=this.phi0,e;l=1-o/this.qp,this.mode===this.S_POLE&&(l=-l)}t=Math.atan2(p,f),u=Math.asin(l),d=this.apa,c=u+u,r=u+d[0]*Math.sin(c)+d[1]*Math.sin(c+c)+d[2]*Math.sin(c+c+c)}return e.x=k(this.long0+t),e.y=r,e},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4},Qe=function(e){return Math.abs(e)>1&&(e=e>1?1:-1),Math.asin(e)};var $e={init:function(){Math.abs(this.lat1+this.lat2)<s||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=B(this.e3,this.sin_po,this.cos_po),this.qs1=Ke(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=B(this.e3,this.sin_po,this.cos_po),this.qs2=Ke(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Ke(this.e3,this.sin_po,this.cos_po),Math.abs(this.lat1-this.lat2)>s?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(e){var t=e.x,r=e.y;this.sin_phi=Math.sin(r),this.cos_phi=Math.cos(r);var i=Ke(this.e3,this.sin_phi,this.cos_phi),a=this.a*Math.sqrt(this.c-this.ns0*i)/this.ns0,s=this.ns0*k(t-this.long0),n=a*Math.sin(s)+this.x0,o=this.rh-a*Math.cos(s)+this.y0;return e.x=n,e.y=o,e},inverse:function(e){var t,r,i,a,s,n;return e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns0>=0?(t=Math.sqrt(e.x*e.x+e.y*e.y),i=1):(t=-Math.sqrt(e.x*e.x+e.y*e.y),i=-1),a=0,0!==t&&(a=Math.atan2(i*e.x,i*e.y)),i=t*this.ns0/this.a,this.sphere?n=Math.asin((this.c-i*i)/(2*this.ns0)):(r=(this.c-i*i)/this.ns0,n=this.phi1z(this.e3,r)),s=k(a/this.ns0+this.long0),e.x=s,e.y=n,e},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(e,t){var r,i,a,n,o=Qe(.5*t);if(e<s)return o;for(var h=e*e,l=1;l<=25;l++)if(o+=n=.5*(a=1-(i=e*(r=Math.sin(o)))*i)*a/Math.cos(o)*(t/(1-h)-r/a+.5/e*Math.log((1-i)/(1+i))),Math.abs(n)<=1e-7)return o;return null}};var et={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(e){var t,r,i,a,n,o,h,l=e.x,u=e.y;return i=k(l-this.long0),t=Math.sin(u),r=Math.cos(u),a=Math.cos(i),1,(n=this.sin_p14*t+this.cos_p14*r*a)>0||Math.abs(n)<=s?(o=this.x0+1*this.a*r*Math.sin(i)/n,h=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*r*a)/n):(o=this.x0+this.infinity_dist*r*Math.sin(i),h=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*r*a)),e.x=o,e.y=h,e},inverse:function(e){var t,r,i,a,s,n;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(t=Math.sqrt(e.x*e.x+e.y*e.y))?(a=Math.atan2(t,this.rc),r=Math.sin(a),i=Math.cos(a),n=Qe(i*this.sin_p14+e.y*r*this.cos_p14/t),s=Math.atan2(e.x*r,t*this.cos_p14*i-e.y*this.sin_p14*r),s=k(this.long0+s)):(n=this.phic0,s=0),e.x=s,e.y=n,e},names:["gnom"]};var tt={init:function(){this.sphere||(this.k0=B(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t,r,i=e.x,a=e.y,s=k(i-this.long0);if(this.sphere)t=this.x0+this.a*s*Math.cos(this.lat_ts),r=this.y0+this.a*Math.sin(a)/Math.cos(this.lat_ts);else{var n=Ke(this.e,Math.sin(a));t=this.x0+this.a*this.k0*s,r=this.y0+this.a*n*.5/this.k0}return e.x=t,e.y=r,e},inverse:function(e){var t,r;return e.x-=this.x0,e.y-=this.y0,this.sphere?(t=k(this.long0+e.x/this.a/Math.cos(this.lat_ts)),r=Math.asin(e.y/this.a*Math.cos(this.lat_ts))):(r=function(e,t){var r=1-(1-e*e)/(2*e)*Math.log((1-e)/(1+e));if(Math.abs(Math.abs(t)-r)<1e-6)return t<0?-1*a:a;for(var i,s,n,o,h=Math.asin(.5*t),l=0;l<30;l++)if(s=Math.sin(h),n=Math.cos(h),o=e*s,h+=i=Math.pow(1-o*o,2)/(2*n)*(t/(1-e*e)-s/(1-o*o)+.5/e*Math.log((1-o)/(1+o))),Math.abs(i)<=1e-10)return h;return NaN}(this.e,2*e.y*this.k0/this.a),t=k(this.long0+e.x/(this.a*this.k0))),e.x=t,e.y=r,e},names:["cea"]};var rt={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,r=e.y,i=k(t-this.long0),a=Je(r-this.lat0);return e.x=this.x0+this.a*i*this.rc,e.y=this.y0+this.a*a,e},inverse:function(e){var t=e.x,r=e.y;return e.x=k(this.long0+(t-this.x0)/(this.a*this.rc)),e.y=Je(this.lat0+(r-this.y0)/this.a),e},names:["Equirectangular","Equidistant_Cylindrical","eqc"]};var it={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Ge(this.es),this.e1=je(this.es),this.e2=He(this.es),this.e3=qe(this.es),this.ml0=this.a*Ve(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,r,i,a=e.x,n=e.y,o=k(a-this.long0);if(i=o*Math.sin(n),this.sphere)Math.abs(n)<=s?(t=this.a*o,r=-1*this.a*this.lat0):(t=this.a*Math.sin(i)/Math.tan(n),r=this.a*(Je(n-this.lat0)+(1-Math.cos(i))/Math.tan(n)));else if(Math.abs(n)<=s)t=this.a*o,r=-1*this.ml0;else{var h=We(this.a,this.e,Math.sin(n))/Math.tan(n);t=h*Math.sin(i),r=this.a*Ve(this.e0,this.e1,this.e2,this.e3,n)-this.ml0+h*(1-Math.cos(i))}return e.x=t+this.x0,e.y=r+this.y0,e},inverse:function(e){var t,r,i,a,n,o,h,l,u;if(i=e.x-this.x0,a=e.y-this.y0,this.sphere)if(Math.abs(a+this.a*this.lat0)<=s)t=k(i/this.a+this.long0),r=0;else{var d;for(o=this.lat0+a/this.a,h=i*i/this.a/this.a+o*o,l=o,n=20;n;--n)if(l+=u=-1*(o*(l*(d=Math.tan(l))+1)-l-.5*(l*l+h)*d)/((l-o)/d-1),Math.abs(u)<=s){r=l;break}t=k(this.long0+Math.asin(i*Math.tan(l)/this.a)/Math.sin(r))}else if(Math.abs(a+this.ml0)<=s)r=0,t=k(this.long0+i/this.a);else{var c,p,f,m,g;for(o=(this.ml0+a)/this.a,h=i*i/this.a/this.a+o*o,l=o,n=20;n;--n)if(g=this.e*Math.sin(l),c=Math.sqrt(1-g*g)*Math.tan(l),p=this.a*Ve(this.e0,this.e1,this.e2,this.e3,l),f=this.e0-2*this.e1*Math.cos(2*l)+4*this.e2*Math.cos(4*l)-6*this.e3*Math.cos(6*l),l-=u=(o*(c*(m=p/this.a)+1)-m-.5*c*(m*m+h))/(this.es*Math.sin(2*l)*(m*m+h-2*o*m)/(4*c)+(o-m)*(c*f-2/Math.sin(2*l))-f),Math.abs(u)<=s){r=l;break}c=Math.sqrt(1-this.es*Math.pow(Math.sin(r),2))*Math.tan(r),t=k(this.long0+Math.asin(i*c/this.a)/Math.sin(r))}return e.x=t,e.y=r,e},names:["Polyconic","poly"]};var at={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(e){var t,r=e.x,a=e.y-this.lat0,s=r-this.long0,n=a/i*1e-5,o=s,h=1,l=0;for(t=1;t<=10;t++)h*=n,l+=this.A[t]*h;var u,d=l,c=o,p=1,f=0,m=0,g=0;for(t=1;t<=6;t++)u=f*d+p*c,p=p*d-f*c,f=u,m=m+this.B_re[t]*p-this.B_im[t]*f,g=g+this.B_im[t]*p+this.B_re[t]*f;return e.x=g*this.a+this.x0,e.y=m*this.a+this.y0,e},inverse:function(e){var t,r,a=e.x,s=e.y,n=a-this.x0,o=(s-this.y0)/this.a,h=n/this.a,l=1,u=0,d=0,c=0;for(t=1;t<=6;t++)r=u*o+l*h,l=l*o-u*h,u=r,d=d+this.C_re[t]*l-this.C_im[t]*u,c=c+this.C_im[t]*l+this.C_re[t]*u;for(var p=0;p<this.iterations;p++){var f,m=d,g=c,v=o,y=h;for(t=2;t<=6;t++)f=g*d+m*c,m=m*d-g*c,g=f,v+=(t-1)*(this.B_re[t]*m-this.B_im[t]*g),y+=(t-1)*(this.B_im[t]*m+this.B_re[t]*g);m=1,g=0;var b=this.B_re[1],x=this.B_im[1];for(t=2;t<=6;t++)f=g*d+m*c,m=m*d-g*c,g=f,b+=t*(this.B_re[t]*m-this.B_im[t]*g),x+=t*(this.B_im[t]*m+this.B_re[t]*g);var S=b*b+x*x;d=(v*b+y*x)/S,c=(y*b-v*x)/S}var M=d,w=c,T=1,A=0;for(t=1;t<=9;t++)T*=M,A+=this.D[t]*T;var C=this.lat0+A*i*1e5,F=this.long0+w;return e.x=F,e.y=C,e},names:["New_Zealand_Map_Grid","nzmg"]};var st={init:function(){},forward:function(e){var t=e.x,r=e.y,i=k(t-this.long0),a=this.x0+this.a*i,s=this.y0+this.a*Math.log(Math.tan(Math.PI/4+r/2.5))*1.25;return e.x=a,e.y=s,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=k(this.long0+e.x/this.a),r=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Math.PI/4);return e.x=t,e.y=r,e},names:["Miller_Cylindrical","mill"]};var nt={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=Me(this.es)},forward:function(e){var t,r,i=e.x,a=e.y;if(i=k(i-this.long0),this.sphere){if(this.m)for(var n=this.n*Math.sin(a),o=20;o;--o){var h=(this.m*a+Math.sin(a)-n)/(this.m+Math.cos(a));if(a-=h,Math.abs(h)<s)break}else a=1!==this.n?Math.asin(this.n*Math.sin(a)):a;t=this.a*this.C_x*i*(this.m+Math.cos(a)),r=this.a*this.C_y*a}else{var l=Math.sin(a),u=Math.cos(a);r=this.a*we(a,l,u,this.en),t=this.a*i*u/Math.sqrt(1-this.es*l*l)}return e.x=t,e.y=r,e},inverse:function(e){var t,r,i,n;return e.x-=this.x0,i=e.x/this.a,e.y-=this.y0,t=e.y/this.a,this.sphere?(t/=this.C_y,i/=this.C_x*(this.m+Math.cos(t)),this.m?t=Qe((this.m*t+Math.sin(t))/this.n):1!==this.n&&(t=Qe(Math.sin(t)/this.n)),i=k(i+this.long0),t=Je(t)):(t=Te(e.y/this.a,this.es,this.en),(n=Math.abs(t))<a?(n=Math.sin(t),r=this.long0+e.x*Math.sqrt(1-this.es*n*n)/(this.a*Math.cos(t)),i=k(r)):n-s<a&&(i=this.long0)),e.x=i,e.y=t,e},names:["Sinusoidal","sinu"]};var ot={init:function(){},forward:function(e){for(var t=e.x,r=e.y,i=k(t-this.long0),a=r,n=Math.PI*Math.sin(r),o=0;;o++){var h=-(a+Math.sin(a)-n)/(1+Math.cos(a));if(a+=h,Math.abs(h)<s)break}a/=2,Math.PI/2-Math.abs(r)<s&&(i=0);var l=.900316316158*this.a*i*Math.cos(a)+this.x0,u=1.4142135623731*this.a*Math.sin(a)+this.y0;return e.x=l,e.y=u,e},inverse:function(e){var t,r;e.x-=this.x0,e.y-=this.y0,r=e.y/(1.4142135623731*this.a),Math.abs(r)>.999999999999&&(r=.999999999999),t=Math.asin(r);var i=k(this.long0+e.x/(.900316316158*this.a*Math.cos(t)));i<-Math.PI&&(i=-Math.PI),i>Math.PI&&(i=Math.PI),r=(2*t+Math.sin(2*t))/Math.PI,Math.abs(r)>1&&(r=1);var a=Math.asin(r);return e.x=i,e.y=a,e},names:["Mollweide","moll"]};var ht={init:function(){Math.abs(this.lat1+this.lat2)<s||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Ge(this.es),this.e1=je(this.es),this.e2=He(this.es),this.e3=qe(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=B(this.e,this.sinphi,this.cosphi),this.ml1=Ve(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<s?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=B(this.e,this.sinphi,this.cosphi),this.ml2=Ve(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Ve(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(e){var t,r=e.x,i=e.y;if(this.sphere)t=this.a*(this.g-i);else{var a=Ve(this.e0,this.e1,this.e2,this.e3,i);t=this.a*(this.g-a)}var s=this.ns*k(r-this.long0),n=this.x0+t*Math.sin(s),o=this.y0+this.rh-t*Math.cos(s);return e.x=n,e.y=o,e},inverse:function(e){var t,r,i,a;e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns>=0?(r=Math.sqrt(e.x*e.x+e.y*e.y),t=1):(r=-Math.sqrt(e.x*e.x+e.y*e.y),t=-1);var s=0;if(0!==r&&(s=Math.atan2(t*e.x,t*e.y)),this.sphere)return a=k(this.long0+s/this.ns),i=Je(this.g-r/this.a),e.x=a,e.y=i,e;var n=this.g-r/this.a;return i=Ze(n,this.e0,this.e1,this.e2,this.e3),a=k(this.long0+s/this.ns),e.x=a,e.y=i,e},names:["Equidistant_Conic","eqdc"]};var lt={init:function(){this.R=this.a},forward:function(e){var t,r,i=e.x,n=e.y,o=k(i-this.long0);Math.abs(n)<=s&&(t=this.x0+this.R*o,r=this.y0);var h=Qe(2*Math.abs(n/Math.PI));(Math.abs(o)<=s||Math.abs(Math.abs(n)-a)<=s)&&(t=this.x0,r=n>=0?this.y0+Math.PI*this.R*Math.tan(.5*h):this.y0+Math.PI*this.R*-Math.tan(.5*h));var l=.5*Math.abs(Math.PI/o-o/Math.PI),u=l*l,d=Math.sin(h),c=Math.cos(h),p=c/(d+c-1),f=p*p,m=p*(2/d-1),g=m*m,v=Math.PI*this.R*(l*(p-g)+Math.sqrt(u*(p-g)*(p-g)-(g+u)*(f-g)))/(g+u);o<0&&(v=-v),t=this.x0+v;var y=u+p;return v=Math.PI*this.R*(m*y-l*Math.sqrt((g+u)*(u+1)-y*y))/(g+u),r=n>=0?this.y0+v:this.y0-v,e.x=t,e.y=r,e},inverse:function(e){var t,r,i,a,n,o,h,l,u,d,c,p;return e.x-=this.x0,e.y-=this.y0,c=Math.PI*this.R,n=(i=e.x/c)*i+(a=e.y/c)*a,c=3*(a*a/(l=-2*(o=-Math.abs(a)*(1+n))+1+2*a*a+n*n)+(2*(h=o-2*a*a+i*i)*h*h/l/l/l-9*o*h/l/l)/27)/(u=(o-h*h/3/l)/l)/(d=2*Math.sqrt(-u/3)),Math.abs(c)>1&&(c=c>=0?1:-1),p=Math.acos(c)/3,r=e.y>=0?(-d*Math.cos(p+Math.PI/3)-h/3/l)*Math.PI:-(-d*Math.cos(p+Math.PI/3)-h/3/l)*Math.PI,t=Math.abs(i)<s?this.long0:k(this.long0+Math.PI*(n-1+Math.sqrt(1+2*(i*i-a*a)+n*n))/2/i),e.x=t,e.y=r,e},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]};var ut={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t,r,i,n,o,h,l,u,d,c,p,f,m,g,v,y,b,x,S,M,w,T,A=e.x,C=e.y,F=Math.sin(e.y),P=Math.cos(e.y),L=k(A-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=s?(e.x=this.x0+this.a*(a-C)*Math.sin(L),e.y=this.y0-this.a*(a-C)*Math.cos(L),e):Math.abs(this.sin_p12+1)<=s?(e.x=this.x0+this.a*(a+C)*Math.sin(L),e.y=this.y0+this.a*(a+C)*Math.cos(L),e):(x=this.sin_p12*F+this.cos_p12*P*Math.cos(L),b=(y=Math.acos(x))/Math.sin(y),e.x=this.x0+this.a*b*P*Math.sin(L),e.y=this.y0+this.a*b*(this.cos_p12*F-this.sin_p12*P*Math.cos(L)),e):(t=Ge(this.es),r=je(this.es),i=He(this.es),n=qe(this.es),Math.abs(this.sin_p12-1)<=s?(o=this.a*Ve(t,r,i,n,a),h=this.a*Ve(t,r,i,n,C),e.x=this.x0+(o-h)*Math.sin(L),e.y=this.y0-(o-h)*Math.cos(L),e):Math.abs(this.sin_p12+1)<=s?(o=this.a*Ve(t,r,i,n,a),h=this.a*Ve(t,r,i,n,C),e.x=this.x0+(o+h)*Math.sin(L),e.y=this.y0+(o+h)*Math.cos(L),e):(l=F/P,u=We(this.a,this.e,this.sin_p12),d=We(this.a,this.e,F),c=Math.atan((1-this.es)*l+this.es*u*this.sin_p12/(d*P)),S=0===(p=Math.atan2(Math.sin(L),this.cos_p12*Math.tan(c)-this.sin_p12*Math.cos(L)))?Math.asin(this.cos_p12*Math.sin(c)-this.sin_p12*Math.cos(c)):Math.abs(Math.abs(p)-Math.PI)<=s?-Math.asin(this.cos_p12*Math.sin(c)-this.sin_p12*Math.cos(c)):Math.asin(Math.sin(L)*Math.cos(c)/Math.sin(p)),f=this.e*this.sin_p12/Math.sqrt(1-this.es),y=u*S*(1-(M=S*S)*(v=(m=this.e*this.cos_p12*Math.cos(p)/Math.sqrt(1-this.es))*m)*(1-v)/6+(w=M*S)/8*(g=f*m)*(1-2*v)+(T=w*S)/120*(v*(4-7*v)-3*f*f*(1-7*v))-T*S/48*g),e.x=this.x0+y*Math.sin(p),e.y=this.y0+y*Math.cos(p),e))},inverse:function(e){var t,r,i,n,o,h,l,u,d,c,p,f,m,g,v,y,b,x,S,M,w,T;if(e.x-=this.x0,e.y-=this.y0,this.sphere){if((t=Math.sqrt(e.x*e.x+e.y*e.y))>2*a*this.a)return;return r=t/this.a,i=Math.sin(r),n=Math.cos(r),o=this.long0,Math.abs(t)<=s?h=this.lat0:(h=Qe(n*this.sin_p12+e.y*i*this.cos_p12/t),l=Math.abs(this.lat0)-a,o=Math.abs(l)<=s?this.lat0>=0?k(this.long0+Math.atan2(e.x,-e.y)):k(this.long0-Math.atan2(-e.x,e.y)):k(this.long0+Math.atan2(e.x*i,t*this.cos_p12*n-e.y*this.sin_p12*i))),e.x=o,e.y=h,e}return u=Ge(this.es),d=je(this.es),c=He(this.es),p=qe(this.es),Math.abs(this.sin_p12-1)<=s?(f=this.a*Ve(u,d,c,p,a),t=Math.sqrt(e.x*e.x+e.y*e.y),h=Ze((f-t)/this.a,u,d,c,p),o=k(this.long0+Math.atan2(e.x,-1*e.y)),e.x=o,e.y=h,e):Math.abs(this.sin_p12+1)<=s?(f=this.a*Ve(u,d,c,p,a),t=Math.sqrt(e.x*e.x+e.y*e.y),h=Ze((t-f)/this.a,u,d,c,p),o=k(this.long0+Math.atan2(e.x,e.y)),e.x=o,e.y=h,e):(t=Math.sqrt(e.x*e.x+e.y*e.y),v=Math.atan2(e.x,e.y),m=We(this.a,this.e,this.sin_p12),y=Math.cos(v),x=-(b=this.e*this.cos_p12*y)*b/(1-this.es),S=3*this.es*(1-x)*this.sin_p12*this.cos_p12*y/(1-this.es),T=1-x*(w=(M=t/m)-x*(1+x)*Math.pow(M,3)/6-S*(1+3*x)*Math.pow(M,4)/24)*w/2-M*w*w*w/6,g=Math.asin(this.sin_p12*Math.cos(w)+this.cos_p12*Math.sin(w)*y),o=k(this.long0+Math.asin(Math.sin(v)*Math.sin(w)/Math.cos(g))),h=Math.atan((1-this.es*T*this.sin_p12/Math.sin(g))*Math.tan(g)/(1-this.es)),e.x=o,e.y=h,e)},names:["Azimuthal_Equidistant","aeqd"]};var dt={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,r,i,a,n,o,h,l=e.x,u=e.y;return i=k(l-this.long0),t=Math.sin(u),r=Math.cos(u),a=Math.cos(i),1,((n=this.sin_p14*t+this.cos_p14*r*a)>0||Math.abs(n)<=s)&&(o=1*this.a*r*Math.sin(i),h=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*r*a)),e.x=o,e.y=h,e},inverse:function(e){var t,r,i,n,o,h,l;return e.x-=this.x0,e.y-=this.y0,t=Math.sqrt(e.x*e.x+e.y*e.y),r=Qe(t/this.a),i=Math.sin(r),n=Math.cos(r),h=this.long0,Math.abs(t)<=s?(l=this.lat0,e.x=h,e.y=l,e):(l=Qe(n*this.sin_p14+e.y*i*this.cos_p14/t),o=Math.abs(this.lat0)-a,Math.abs(o)<=s?(h=this.lat0>=0?k(this.long0+Math.atan2(e.x,-e.y)):k(this.long0-Math.atan2(-e.x,e.y)),e.x=h,e.y=l,e):(h=k(this.long0+Math.atan2(e.x*i,t*this.cos_p14*n-e.y*this.sin_p14*i)),e.x=h,e.y=l,e))},names:["ortho"]};function ct(e){return e}var pt={init:function(){this.isGeocent=!0},forward:ct,inverse:ct,names:["geocent"]},ft=1,mt=2,gt=3,vt=4,yt=5,bt=6,xt=1,St=2,Mt=3,wt=4;function Tt(e,t,r,i){var n;return e<s?(i.value=xt,n=0):(n=Math.atan2(t,r),Math.abs(n)<=h?i.value=xt:n>h&&n<=a+h?(i.value=St,n-=a):n>a+h||n<=-(a+h)?(i.value=Mt,n=n>=0?n-u:n+u):(i.value=wt,n+=a)),n}function At(e,t){var r=e+t;return r<-u?r+=l:r>+u&&(r-=l),r}var Ct,Ft={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=a-h/2?this.face=yt:this.lat0<=-(a-h/2)?this.face=bt:Math.abs(this.long0)<=h?this.face=ft:Math.abs(this.long0)<=a+h?this.face=this.long0>0?mt:vt:this.face=gt,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(e){var t,r,i,s,n,o,l={x:0,y:0},d={value:0};if(e.x-=this.long0,t=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(e.y)):e.y,r=e.x,this.face===yt)s=a-t,r>=h&&r<=a+h?(d.value=xt,i=r-a):r>a+h||r<=-(a+h)?(d.value=St,i=r>0?r-u:r+u):r>-(a+h)&&r<=-h?(d.value=Mt,i=r+a):(d.value=wt,i=r);else if(this.face===bt)s=a+t,r>=h&&r<=a+h?(d.value=xt,i=-r+a):r<h&&r>=-h?(d.value=St,i=-r):r<-h&&r>=-(a+h)?(d.value=Mt,i=-r-a):(d.value=wt,i=r>0?-r+u:-r-u);else{var c,p,f,m,g,v;this.face===mt?r=At(r,+a):this.face===gt?r=At(r,+u):this.face===vt&&(r=At(r,-a)),m=Math.sin(t),g=Math.cos(t),v=Math.sin(r),c=g*Math.cos(r),p=g*v,f=m,this.face===ft?i=Tt(s=Math.acos(c),f,p,d):this.face===mt?i=Tt(s=Math.acos(p),f,-c,d):this.face===gt?i=Tt(s=Math.acos(-c),f,-p,d):this.face===vt?i=Tt(s=Math.acos(-p),f,c,d):(s=i=0,d.value=xt)}return o=Math.atan(12/u*(i+Math.acos(Math.sin(i)*Math.cos(h))-a)),n=Math.sqrt((1-Math.cos(s))/(Math.cos(o)*Math.cos(o))/(1-Math.cos(Math.atan(1/Math.cos(i))))),d.value===St?o+=a:d.value===Mt?o+=u:d.value===wt&&(o+=1.5*u),l.x=n*Math.cos(o),l.y=n*Math.sin(o),l.x=l.x*this.a+this.x0,l.y=l.y*this.a+this.y0,e.x=l.x,e.y=l.y,e},inverse:function(e){var t,r,i,s,n,o,h,l,d,c,p,f,m={lam:0,phi:0},g={value:0};if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,r=Math.atan(Math.sqrt(e.x*e.x+e.y*e.y)),t=Math.atan2(e.y,e.x),e.x>=0&&e.x>=Math.abs(e.y)?g.value=xt:e.y>=0&&e.y>=Math.abs(e.x)?(g.value=St,t-=a):e.x<0&&-e.x>=Math.abs(e.y)?(g.value=Mt,t=t<0?t+u:t-u):(g.value=wt,t+=a),d=u/12*Math.tan(t),n=Math.sin(d)/(Math.cos(d)-1/Math.sqrt(2)),o=Math.atan(n),(h=1-(i=Math.cos(t))*i*(s=Math.tan(r))*s*(1-Math.cos(Math.atan(1/Math.cos(o)))))<-1?h=-1:h>1&&(h=1),this.face===yt)l=Math.acos(h),m.phi=a-l,g.value===xt?m.lam=o+a:g.value===St?m.lam=o<0?o+u:o-u:g.value===Mt?m.lam=o-a:m.lam=o;else if(this.face===bt)l=Math.acos(h),m.phi=l-a,g.value===xt?m.lam=-o+a:g.value===St?m.lam=-o:g.value===Mt?m.lam=-o-a:m.lam=o<0?-o-u:-o+u;else{var v,y,b;d=(v=h)*v,y=(d+=(b=d>=1?0:Math.sqrt(1-d)*Math.sin(o))*b)>=1?0:Math.sqrt(1-d),g.value===St?(d=y,y=-b,b=d):g.value===Mt?(y=-y,b=-b):g.value===wt&&(d=y,y=b,b=-d),this.face===mt?(d=v,v=-y,y=d):this.face===gt?(v=-v,y=-y):this.face===vt&&(d=v,v=y,y=-d),m.phi=Math.acos(-b)-a,m.lam=Math.atan2(y,v),this.face===mt?m.lam=At(m.lam,-a):this.face===gt?m.lam=At(m.lam,-u):this.face===vt&&(m.lam=At(m.lam,+a))}return 0!==this.es&&(c=m.phi<0?1:0,p=Math.tan(m.phi),f=this.b/Math.sqrt(p*p+this.one_minus_f_squared),m.phi=Math.atan(Math.sqrt(this.a*this.a-f*f)/(this.one_minus_f*f)),c&&(m.phi=-m.phi)),m.lam+=this.long0,e.x=m.lam,e.y=m.phi,e},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]};se.defaultDatum="WGS84",se.Proj=Z,se.WGS84=new se.Proj("WGS84"),se.Point=be,se.toPoint=ee,se.defs=P,se.transform=te,se.mgrs=he,se.version=xe.a,(Ct=se).Proj.projections.add(Ae),Ct.Proj.projections.add(Ne),Ct.Proj.projections.add(Be),Ct.Proj.projections.add(Re),Ct.Proj.projections.add(_e),Ct.Proj.projections.add(ze),Ct.Proj.projections.add(Ue),Ct.Proj.projections.add(De),Ct.Proj.projections.add(Oe),Ct.Proj.projections.add(Ye),Ct.Proj.projections.add(Xe),Ct.Proj.projections.add($e),Ct.Proj.projections.add(et),Ct.Proj.projections.add(tt),Ct.Proj.projections.add(rt),Ct.Proj.projections.add(it),Ct.Proj.projections.add(at),Ct.Proj.projections.add(st),Ct.Proj.projections.add(nt),Ct.Proj.projections.add(ot),Ct.Proj.projections.add(ht),Ct.Proj.projections.add(lt),Ct.Proj.projections.add(ut),Ct.Proj.projections.add(dt),Ct.Proj.projections.add(pt),Ct.Proj.projections.add(Ft);t.a=se},function(e,t,r){"use strict";r.d(t,"a",(function(){return vs})),r.d(t,"c",(function(){return ys})),r.d(t,"b",(function(){return bs}));var i=r(6),a=r(0),s=r(1),n=r(4),o=function(e,t,r){this.map=e,this.parse(t,r)};o.prototype.parse=function(e,t){if(this.freeLayers=e.freeLayers||{},this.surfaces={},this.options=e.options||{},e.surfaces){var r=e.surfaces;if(Array.isArray(r))for(var i=0,a=r.length;i<a;i++)this.surfaces[r[i]]=[];else this.surfaces=r}if(!this.freeLayers||Array.isArray(this.freeLayers))this.freeLayers={};else if(this.freeLayers=JSON.parse(JSON.stringify(this.freeLayers)),t)for(var s in this.freeLayers){var n=this.freeLayers[s];"string"==typeof n.style&&(n.style=this.processUrl(n.style,""))}this.surfaces=JSON.parse(JSON.stringify(this.surfaces)),this.options=JSON.parse(JSON.stringify(this.options))},o.prototype.processUrl=function(e,t){return e?"string"!=typeof e||-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.map.url.baseUrlSchema+e:0==e.indexOf("/")?this.map.url.baseUrlOrigin+e:this.map.url.baseUrl+e:t},o.prototype.getInfo=function(){var e={surfaces:JSON.parse(JSON.stringify(this.surfaces)),freeLayers:JSON.parse(JSON.stringify(this.freeLayers)),options:JSON.parse(JSON.stringify(this.options))};this.map.renderer;if(this.map.renderer.getSuperElevationState()){var t=this.map.renderer.getSuperElevation();e.options={superelevation:[[t[0],t[2]],[t[1],t[3]]]}}return e};var h=o,l=s.a,u=function(e,t,r,i,a,s,n,o,h,l){this.gpu=e,this.gl=e.gl,this.texture=null,this.framebuffer=null,this.size=0,this.fileSize=i,this.width=0,this.height=0,this.repeat=s||!1,this.filter=n||"linear",this.image=null,this.loaded=!1,this.trilinear=!1,this.core=r,null!=t&&this.load(t,h,l,a,o)};u.prototype.kill=function(){this.gl.deleteTexture(this.texture),this.texture=null},u.prototype.getSize=function(){return this.size},u.prototype.createFromData=function(e,t,r,i,a){var s=this.gl;this.texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.texture),a?(a=s.REPEAT,this.repeat=!0):a=s.CLAMP_TO_EDGE,s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,a),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,a);var n=!1;switch(i){case"linear":s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);break;case"trilinear":s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),n=!0;break;default:s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST)}s.pixelStorei(s.UNPACK_ALIGNMENT,1),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,s.UNSIGNED_BYTE,r),n&&s.generateMipmap(s.TEXTURE_2D),s.bindTexture(s.TEXTURE_2D,null),this.width=e,this.height=t,this.size=e*t*4,this.loaded=!0},u.prototype.createFromImage=function(e,t,r,i){var a=this.gl,s=e.naturalWidth,n=e.naturalHeight,o=e;this.texture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.texture),r?(r=a.REPEAT,this.repeat=!0):r=a.CLAMP_TO_EDGE,a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,r),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,r);var h=!1;switch(this.filter=t,t){case"linear":a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);break;case"trilinear":a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),h=!0;break;default:a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST)}if((this.repeat||h)&&(!l.isPowerOfTwo(s)||!l.isPowerOfTwo(n))){s=l.nearestPowerOfTwo(s),n=l.nearestPowerOfTwo(n);var u=document.createElement("canvas");u.width=s,u.height=n,u.getContext("2d").drawImage(e,0,0,s,n),o=u}var d=this.gpu;d.anisoLevel&&a.texParameterf(a.TEXTURE_2D,d.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,d.anisoLevel),!0!==d.noTextures&&(a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,o),h&&a.generateMipmap(a.TEXTURE_2D)),a.bindTexture(a.TEXTURE_2D,null),this.width=s,this.height=n,this.size=s*n*4,this.loaded=!0},u.prototype.load=function(e,t,r,i,a){this.image=l.loadImage(e,function(){null!=this.core&&this.core.killed||(this.createFromImage(this.image,this.filter,this.repeat),a||(this.image=null),t?t():this.core.map&&this.core.map.markDirty&&this.core.map.markDirty())}.bind(this),function(){null!=this.core&&this.core.killed||r&&r()}.bind(this),null,i)},u.prototype.createFramebufferFromData=function(e,t,r){var i=this.gl,a=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,a),a.width=e,a.height=t;var s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.pixelStorei(i.UNPACK_ALIGNMENT,1),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,r);var n=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,n),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,n),this.width=e,this.height=t,this.size=e*t*4,this.texture=s,this.renderbuffer=n,this.framebuffer=a,i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null)},u.prototype.createFramebuffer=function(e,t){if(null!=this.texture){var r=this.gl,i=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,i),i.width=e,i.height=t,r.bindTexture(r.TEXTURE_2D,this.texture);var a=r.createRenderbuffer();r.bindRenderbuffer(r.RENDERBUFFER,a),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e,t),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.texture,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,a),r.bindTexture(r.TEXTURE_2D,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null),this.framebuffer=i,this.renderbuffer=a}},u.prototype.readFramebufferPixels=function(e,t,r,i,a,s){if(null!=this.texture){this.gpu.bindTexture(this),a||this.gpu.setFramebuffer(this);var n=this.gl;return s||(s=new Uint8Array(r*i*4)),n.readPixels(e,t,r,i,n.RGBA,n.UNSIGNED_BYTE,s),a||this.gpu.setFramebuffer(null),s}};var c=u,p=r(2),f=a.d,m=c,g=p.a,v=[[-1,-1,0,0],[0,-1,.5,1],[1,-1,1,0],[-1,0,0,.5],[0,0,.5,.5],[1,0,1,.5],[-1,1,0,1],[0,1,.5,0],[1,1,1,1]],y=[[0,1,3],[2,1,5],[6,3,7],[8,7,5]],b=function(e,t,r){this.map=e,this.id=r,this.parent=t,this.viewCounter=e.viewCounter,this.drawCounter=0,this.childrenReadyCount=0,this.renderReady=!1,this.geodataCounter=0,this.gridRenderCounter=0,this.texelSize=1,this.texelSize2=1,this.distance=1,this.tiltAngle=1,this.seCounter=0,this.metanode=null,this.lastMetanode=null,this.boundmetaresources=null,this.surface=null,this.surfaceMesh=null,this.surfaceGeodata=null,this.surfaceGeodataView=null,this.surfaceTextures=[],this.resourceSurface=null,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.resetDrawCommands=!1,this.drawCommands=[[],[],[]],this.bounds={},this.boundLayers={},this.boundTextures={},this.updateBounds=!0,this.hmap=null,this.heightMap=null,this.drawCommands=[[],[],[]],this.imageryCredits={},this.glueImageryCredits={},this.mapdataCredits={},this.resources=this.map.resourcesTree.findNode(r,!0),this.metaresources=this.map.resourcesTree.findAgregatedNode(r,5,!0),this.boundresources=this.map.resourcesTree.findAgregatedNode(r,8,!0),this.children=[null,null,null,null]};b.prototype.kill=function(){for(var e=0;e<4;e++)null!=this.children[e]&&this.children[e].kill();this.resources=null,this.metaresources=null,this.metanode=null,this.surface=null,this.surfaceMesh=null,this.surfaceTextures=[],this.surfaceGeodata=null,this.surfaceGeodataView=null,this.resourceSurface=null,this.bounds={},this.boundLayers={},this.boundTextures={},this.updateBounds=!0,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.renderReady=!1,this.lastSurface=null,this.lastState=null,this.lastRenderState=null,this.hmap=null,this.heightMap=null,this.drawCommands=[[],[],[]],this.imageryCredits={},this.glueImageryCredits={},this.mapdataCredits={},this.verifyChildren=!1,this.children=[null,null,null,null];var t=this.parent;this.parent=null,null!=t&&t.removeChild(this)},b.prototype.validate=function(){null==this.metaresources||this.metaresources.getMetatile(this.surface,null,this)},b.prototype.viewSwitched=function(){for(var e in this.lastSurface=this.surface,this.lastState={surfaceMesh:this.surfaceMesh,surfaceTextures:this.surfaceTextures,boundTextures:this.boundTextures,surfaceGeodata:this.surfaceGeodata,surfaceGeodataView:this.surfaceGeodataView,resourceSurface:this.resourceSurface},this.drawCommands[0].length>0?this.lastRenderState={drawCommands:this.drawCommands,imageryCredits:this.imageryCredits,mapdataCredits:this.mapdataCredits}:this.lastRenderState=null,this.verifyChildren=!0,this.renderReady=!1,this.lastMetanode=this.metanode,this.metanode=null,this.map.config.mapSoftViewSwitch||(this.metanode&&(this.metanode.border=null,this.metanode.border2=null,this.metanode.border3=null,this.metanode.borderNodes=null,this.metanode.borderReady=null),this.lastState=null,this.lastRenderState=null,this.lastMetanode=null,this.metanode=null,this.gridPoints=null),this.bounds)this.bounds[e]={sequence:[],alpha:[],transparent:!1,viewCoutner:0};this.boundLayers={},this.boundTextures={},this.updateBounds=!0,this.transparentBounds=!1,this.surface=null,this.surfaceMesh=null,this.surfaceTextures=[],this.surfaceGeodata=null,this.surfaceGeodataView=null,this.resourceSurface=null,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.virtualSurfacesUncomplete=!1,this.drawCommands=[[],[],[]],this.imageryCredits={},this.glueImageryCredits={},this.mapdataCredits={}},b.prototype.restoreLastState=function(){this.lastState&&(this.surfaceMesh=this.lastState.surfaceMesh,this.surfaceTextures=this.lastState.surfaceTextures,this.boundTextures=this.lastState.boundTextures,this.surfaceGeodata=this.lastState.surfaceGeodata,this.surfaceGeodataView=this.lastState.surfaceGeodataView,this.resourceSurface=this.lastState.resourceSurface,this.lastSurface=null,this.lastState=null,this.lastResourceSurface=null)},b.prototype.addChild=function(e){if(!this.children[e]){var t=this.id,r=[t[0]+1,t[1]<<1,t[2]<<1];switch(e){case 1:r[1]++;break;case 2:r[2]++;break;case 3:r[1]++,r[2]++}this.children[e]=new b(this.map,this,r)}},b.prototype.removeChildByIndex=function(e){null!=this.children[e]&&(this.children[e].kill(),this.children[e]=null)},b.prototype.removeChild=function(e){for(var t=0;t<4;t++)this.children[t]==e&&(this.children[t].kill(),this.children[t]=null)},b.prototype.isMetanodeReady=function(e,t,r){if((this.map.viewCounter!=this.viewCoutner&&(this.viewSwitched(),this.viewCoutner=this.map.viewCounter,this.map.markDirty()),!r)&&((this.virtualSurfacesUncomplete||null==this.surface&&0==this.virtualSurfaces.length)&&this.checkSurface(e,t),(null==this.metanode||this.lastMetanode)&&!this.virtualSurfacesUncomplete&&!(this.checkMetanode(e,t)||null!=this.metanode&&this.lastMetanode)))return!1;if(null==this.metanode)return!1;if(this.metanode.metatile.used(),this.lastSurface&&this.lastSurface==this.surface&&(this.lastSurface=null,this.restoreLastState()),this.surface&&(this.surface.virtual?(this.resourceSurface=this.surface.getSurface(this.metanode.sourceReference),this.resourceSurface||(this.resourceSurface=this.surface)):this.resourceSurface=this.surface),this.seCounter!=this.map.renderer.seCounter){var i=this.map.renderer;this.seCounter=i.seCounter;var a=this.metanode;i.useSuperElevation?(a.minZ=i.getSuperElevatedHeight(a.minZ2),a.maxZ=i.getSuperElevatedHeight(a.maxZ2)):(a.minZ=a.minZ2,a.maxZ=a.maxZ2),i.seCounter>0&&(this.gridPoints=null,a.border=null,a.border2=null,a.border3=null,a.borderReady=!1,a.generateCullingHelpers())}return!0},b.prototype.checkSurface=function(e,t){if(this.surface=null,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.virtualSurfacesUncomplete=!1,e.freeLayerSurface)this.surface=e.freeLayerSurface;else{for(var r=e.surfaceSequence,i=0,a=r.length;i<a;i++){var s=r[i][0],n=r[i][1];if(s.hasTile2(this.id)[0]){if(this.id[0]>0){var o=this.parent;if(o){if(o.virtualSurfacesUncomplete)return this.virtualSurfacesUncomplete=!0,void(this.virtualSurfaces=[]);var h=o.metaresources.getMetatile(s,null,this);if(!h)continue;if(!h.isReady(t)){this.virtualSurfacesUncomplete=!0;continue}var l=h.getNode(o.id);if(!l)continue;if(!l.hasChildById(this.id))continue}}this.virtualSurfaces.push([s,n])}}this.virtualSurfaces.length>1?this.virtual=!0:this.surface=this.virtualSurfaces[0]?this.virtualSurfaces[0][0]:null}},b.prototype.checkMetanode=function(e,t){if(this.virtual){if(!this.isVirtualMetanodeReady(e,t))return!1;this.metanode=this.createVirtualMetanode(e,t),this.lastMetanode=null,this.map.markDirty()}var r=this.surface;if(null==r)return!1;var i=this.metaresources.getMetatile(r,!0,this);if(!i.isReady(t))return!1;if(this.virtual||(this.metanode=i.getNode(this.id),this.lastMetanode=null,this.map.markDirty()),null!=this.metanode){this.metanode.tile=this,this.lastMetanode=null,this.map.markDirty();for(var a=0;a<4;a++)this.metanode.hasChild(a)?this.addChild(a):this.removeChildByIndex(a)}return!0},b.prototype.isVirtualMetanodeReady=function(e,t){for(var r=this.virtualSurfaces,i=0,a=0,s=r.length;a<s;a++){var n=r[a][0];this.metaresources.getMetatile(n,!0,this).isReady(t)&&i++}return i==s},b.prototype.createVirtualMetanode=function(e,t){var r,i,a,s,n,o=this.virtualSurfaces,h=null;for(r=0,i=o.length;r<i;r++){a=o[r][0];var l=o[r][1];if((s=this.metaresources.getMetatile(a,null,this)).isReady(t)&&null!=(n=s.getNode(this.id))){if(l!=n.alien)continue;if(!l&&a.glue&&!n.hasGeometry()&&n.internalTextureCount>0){var u=n.internalTextureCount-1;u=this.map.getSurface(a.id[u]).viewSurfaceIndex;for(var d=!1,c=r;c<i;c++)if(o[c].viewSurfaceIndex<=u){d=c>r,r=c-1;break}if(d)continue}if(n.hasGeometry()){h=n.clone(),this.surface=a;break}}}for(r=0,i=o.length;r<i;r++)a=o[r][0],(s=this.metaresources.getMetatile(a,null,this)).isReady(t)&&null!=(n=s.getNode(this.id))&&(h?(h.flags|=240&n.flags,s.useVersion<4&&(h.bbox.min[0]=Math.min(h.bbox.min[0],n.bbox.min[0]),h.bbox.min[1]=Math.min(h.bbox.min[1],n.bbox.min[1]),h.bbox.min[2]=Math.min(h.bbox.min[2],n.bbox.min[2]),h.bbox.max[0]=Math.max(h.bbox.max[0],n.bbox.max[0]),h.bbox.max[1]=Math.max(h.bbox.max[1],n.bbox.max[1]),h.bbox.max[2]=Math.max(h.bbox.max[2],n.bbox.max[2]))):(h=n.clone(),this.surface=a));return h&&h.generateCullingHelpers(!0),h},b.prototype.bboxVisible=function(e,t,r,i){var a=this.map,s=a.camera;if(e[0]<a.measure.minDivisionNodeDepth)return!0;if(!a.config.mapDisableCulling&&a.isGeocent&&i){var n=i.diskPos,o=s.position,h=[n[0]-o[0],n[1]-o[1],n[2]-o[2]],l=f.normalize4(h)*s.distanceFactor,u=f.dot(h,i.diskNormal);if(this.tiltAngle=u,l>15e4&&u>i.diskAngle)return!1}return i.metatile.useVersion>=4?s.camera.pointsVisible(i.bbox2,r):!a.isGeocent||!a.config.mapPreciseBBoxTest||e[0]<4?s.camera.bboxVisible(t,r):s.camera.pointsVisible(i.bbox2,r)},b.prototype.insideCone=function(e,t,r){return!!this.map.isGeocent&&Math.acos(f.dot(e,r.diskNormal))<t+r.diskAngle2A},b.prototype.getPixelSize=function(e,t,r,i,a){var s=e.min,n=e.max,o=s[0]-r[0],h=s[1]-r[1],l=n[0]-r[0],u=s[1]-r[1],d=n[0]-r[0],c=n[1]-r[1],p=s[0]-r[0],f=n[1]-r[1],m=s[2]-r[2],g=n[2]-r[2];if(r[0]>s[0]&&r[0]<n[0]&&r[1]>s[1]&&r[1]<n[1]&&r[2]>s[2]&&r[2]<n[2])return a?[Number.POSITIVE_INFINITY,.1]:Number.POSITIVE_INFINITY;var v=0,y=this.map.camera.camera;return v=0<h?0<o?0>g?y.scaleFactor([o,h,g],a):0<m?y.scaleFactor([o,h,m],a):y.scaleFactor([o,h,.5*(m+g)],a):0>l?0>g?y.scaleFactor([l,u,g],a):0<m?y.scaleFactor([l,u,m],a):y.scaleFactor([l,u,.5*(m+g)],a):0>g?y.scaleFactor([.5*(o+l),u,g],a):0<m?y.scaleFactor([.5*(o+l),u,m],a):y.scaleFactor([.5*(o+l),u,.5*(m+g)],a):0>f?0<p?0>g?y.scaleFactor([p,f,g],a):0<m?y.scaleFactor([p,f,m],a):y.scaleFactor([p,f,.5*(m+g)],a):0>d?0>g?y.scaleFactor([d,c,g],a):0<m?y.scaleFactor([d,c,m],a):y.scaleFactor([d,c,.5*(m+g)],a):0>g?y.scaleFactor([.5*(p+d),c,g],a):0<m?y.scaleFactor([.5*(p+d),c,m],a):y.scaleFactor([.5*(p+d),c,.5*(m+g)],a):0<p?0>g?y.scaleFactor([o,.5*(u+c),g],a):0<m?y.scaleFactor([o,.5*(u+c),m],a):y.scaleFactor([o,.5*(u+c),.5*(m+g)],a):0>d?0>g?y.scaleFactor([l,.5*(u+c),g],a):0<m?y.scaleFactor([l,.5*(u+c),m],a):y.scaleFactor([l,.5*(u+c),.5*(m+g)],a):0>g?y.scaleFactor([.5*(o+l),.5*(u+c),g],a):0<m?y.scaleFactor([.5*(o+l),.5*(u+c),m],a):y.scaleFactor([.5*(o+l),.5*(u+c),.5*(m+g)],a),a?[v[0]*t,v[1]]:v*t},b.prototype.getPixelSize3Old=function(e,t,r){var i=this.map.camera,a=i.geocentDistance*r-e.diskDistance;a<0&&(a=-a);var s=f.dot(i.geocentNormal,e.diskNormal);if(s<e.diskAngle2){var n=Math.acos(s);n-=Math.acos(e.diskAngle2);var o=Math.tan(n)*e.diskDistance;a=Math.sqrt(o*o+a*a)}return[(r=i.camera.scaleFactor2(a))*t,a]},b.prototype.getPixelSize3=function(e,t){var r,i=this.map.camera,a=i.geocentDistance,s=f.dot(i.geocentNormal,e.diskNormal),n=a-(e.diskDistance+(e.maxZ-e.minZ));if(s<e.diskAngle2){var o=Math.acos(s);o-=e.diskAngle2A;var h=Math.tan(o)*e.diskDistance;n<0?(r=a-e.diskDistance)<0?(n=-r,n=Math.sqrt(h*h+n*n)):n=h:n=Math.sqrt(h*h+n*n)}else if(n<0){if(!((r=a-e.diskDistance)<0))return[Number.POSITIVE_INFINITY,.1];n=-r}return[i.camera.scaleFactor2(n)*t,n]},b.prototype.updateTexelSize=function(){var e,t,r,i,a=this.map,s=a.draw,n=a.camera,o=s.texelSizeFit,h=this.metanode,l=a.camera.position,u=a.isGeocent&&(a.config.mapPreciseDistanceTest||h.metatile.useVersion>=4);if(h.hasGeometry()){var d=Number.POSITIVE_INFINITY;if(h.usedTexelSize()?d=s.ndcToScreenPixel*h.pixelSize:h.usedDisplaySize()&&(d=s.ndcToScreenPixel*(h.bbox.maxSize/h.displaySize)),n.camera.ortho){var c=n.camera.getViewHeight();e=[2*d/c,c]}else h.usedDisplaySize()?u?(d=s.isGeocent?s.ndcToScreenPixel*(h.diskAngle2A*s.planetRadius*1.41421356236/h.displaySize):s.ndcToScreenPixel*(h.bbox.maxSize/h.displaySize),e=this.getPixelSize3(h,d)):(d=s.ndcToScreenPixel*(h.bbox.maxSize/256),t=h.displaySize/256*n.distance,r=n.vector,i=[l[0]-r[0]*t,l[1]-r[1]*t,l[2]-r[2]*t],e=this.getPixelSize(h.bbox,d,i,i,!0)):!u&&o>1.1?(d=s.ndcToScreenPixel*h.pixelSize*(o/1.1),t=o/1.1*n.distance,r=n.vector,i=[l[0]-r[0]*t,l[1]-r[1]*t,l[2]-r[2]*t],e=this.getPixelSize(h.bbox,d,i,i,!0)):e=u?this.getPixelSize3(h,d):this.getPixelSize(h.bbox,d,l,l,!0)}else(e=u?this.getPixelSize3(h,1,1):this.getPixelSize(h.bbox,1,l,l,!0))[0]=Number.POSITIVE_INFINITY;if(this.texelSize=e[0],this.distance=e[1],a.config.mapDegradeHorizon&&!(s.degradeHorizonFactor<1)){var p=a.config.mapDegradeHorizonParams,f=p[1],m=p[2],g=s.degradeHorizonFactor*s.degradeHorizonTiltFactor,v=this.distance*n.distanceFactor;v<f?g=1:v>f&&v<m&&(g=1+(v-f)/(m-f)*(g-1)),g=Math.max(g,1);var y=n.perceivedDistance,b=p[3];y>b?g=1:y<b&&g>1&&(g=1+(g-1)*(1-y/b)),this.texelSize/=g}},b.prototype.drawGrid=function(e,t,r,i,a){if(!((this.texelSize==Number.POSITIVE_INFINITY||this.texelSize>4.4)&&this.metanode&&this.metanode.hasChildren())&&this.metanode){var s,n,o,h,l=this.map;if(!l.draw.gridSkipped){t?(s=t[0],n=t[1][0],o=t[1][1]):(s=(h=l.measure.getSpatialDivisionNodeAndExtents(this.id))[0],n=h[1][0],o=h[1][1]);var u=[.5*(o[0]+n[0]),.5*(o[1]+n[1])],d=l.referenceFrame.hasPoles;if(r=r||this.metanode.diskAngle2,d&&!s.isPole&&Math.acos(r)>.1*Math.PI)return r=Math.cos(.5*Math.acos(r)),this.drawGrid(e,[s,[[n[0],n[1]],[u[0],u[1]]]],r,!1,!0),this.drawGrid(e,[s,[[u[0],n[1]],[o[0],u[1]]]],r,!1,!0),this.drawGrid(e,[s,[[n[0],u[1]],[u[0],o[1]]]],r,!1,!0),void this.drawGrid(e,[s,[[u[0],u[1]],[o[0],o[1]]]],r,!1,!0);var c=s.extents.ur[1]-s.extents.ll[1],p=this.distance,f=Math.log(5*c/p)/l.log2;f=Math.max(0,f-8+s.id[0]);var m,b,x,S=l.draw,M=e[0],w=(M=e[0],e[1]),T=e[2],A=S.planeBuffer,C=S.gridFlat,F=S.gridGlues,P=this.gridPoints,L=l.config.mapGridSurrogatez;if(!P){m=L?this.metanode.surrogatez:this.metanode.minZ;var E=s.getPhysicalCoords([o[0],o[1],m],!0),N=s.getPhysicalCoords([o[0],n[1],m],!0),B=s.getPhysicalCoords([n[0],n[1],m],!0),I=s.getPhysicalCoords([n[0],o[1],m],!0),k=s.getPhysicalCoords([u[0],o[1],m],!0),R=s.getPhysicalCoords([u[0],n[1],m],!0),_=s.getPhysicalCoords([n[0],u[1],m],!0),z=s.getPhysicalCoords([o[0],u[1],m],!0);if(u[2]=m,u=s.getPhysicalCoords(u,!0),t)A[0]=I[0]-M,A[1]=I[1]-w,A[2]=I[2]-T,A[3]=k[0]-M,A[4]=k[1]-w,A[5]=k[2]-T,A[6]=E[0]-M,A[7]=E[1]-w,A[8]=E[2]-T,A[9]=_[0]-M,A[10]=_[1]-w,A[11]=_[2]-T,A[12]=u[0]-M,A[13]=u[1]-w,A[14]=u[2]-T,A[15]=z[0]-M,A[16]=z[1]-w,A[17]=z[2]-T,A[18]=B[0]-M,A[19]=B[1]-w,A[20]=B[2]-T,A[21]=R[0]-M,A[22]=R[1]-w,A[23]=R[2]-T,A[24]=N[0]-M,A[25]=N[1]-w,A[26]=N[2]-T;else{P=[I[0],I[1],I[2],k[0],k[1],k[2],E[0],E[1],E[2],_[0],_[1],_[2],u[0],u[1],u[2],z[0],z[1],z[2],B[0],B[1],B[2],R[0],R[1],R[2],N[0],N[1],N[2]];this.gridPoints=P}}if(!C){var U,D,O,V=this.metanode,G=V.border,j=V.borderNodes,H=l.tree,q=this.id;G||(V.border=new Array(9),V.borderNodes=new Array(9),G=V.border,j=V.borderNodes,G[4]=L?V.surrogatez:V.minZ);var W=v,J=!1;if(!V.borderReady)for(U=0;U<9;U++)4==U||j[U]||((O=H.getNodeById([q[0],q[1]+W[U][0],q[2]+W[U][1]],!0))?(j[U]=O,G[U]=L?O.surrogatez:O.minZ):(G[U]=G[4],J=!0));var Z=V.border2;if(m=L?V.surrogatez:V.minZ,Z&&V.borderReady||(Z=[.25*(G[0]+G[1]+G[3]+G[4])-m,.5*(G[1]+G[4])-m,.25*(G[2]+G[1]+G[5]+G[4])-m,.5*(G[3]+G[4])-m,G[4]-m,.5*(G[5]+G[4])-m,.25*(G[6]+G[7]+G[3]+G[4])-m,.5*(G[7]+G[4])-m,.25*(G[8]+G[7]+G[5]+G[4])-m],V.border2=Z),J||(V.borderReady=!0),i)return;if(F){var Y=y,K=this.nodeTable;for(K||(K=new Array(9),this.nodeTable=K),U=0,D=W.length;U<D;U++)4!=U&&(K[U]=H.getRenderedNodeById([q[0],q[1]+W[U][0],q[2]+W[U][1]],S.drawCounter));var X=V.border3;for(X||(X=new Array(9),V.border3=X),U=0,D=Y.length;U<D;U++){for(var Q=K[Y[U][0]],$=1;$<3;$++)(O=K[Y[U][$]])&&(Q?O.id[0]<Q.id[0]&&(Q=O):Q=O);K[Y[U][0]]=Q}for(U=0,D=W.length;U<D;U++)if(O=K[U],4!=U&&O&&O.id[0]<q[0]){var ee;switch(U){case 0:ee=[V.llx,V.lly];break;case 1:ee=[.5*(V.urx+V.llx),V.lly];break;case 2:ee=[V.urx,V.lly];break;case 3:ee=[V.llx,.5*(V.ury+V.lly)];break;case 5:ee=[V.urx,.5*(V.ury+V.lly)];break;case 6:ee=[V.llx,V.ury];break;case 7:ee=[.5*(V.urx+V.llx),V.ury];break;case 8:ee=[V.urx,V.ury]}O.border2||O.tile.drawGrid(e,t,r,!0),O.border2?V.border3[U]=O.getGridHeight(ee,O.border2,3)+(L?O.surrogatez:O.minZ)-m:Z[U]}else V.border3[U]=Z[U]}}var te=l.renderer,re=te.camera.getModelviewMatrix(),ie=te.camera.getProjectionMatrix();if(P&&(A[0]=P[0]-M,A[1]=P[1]-w,A[2]=P[2]-T,A[3]=P[3]-M,A[4]=P[4]-w,A[5]=P[5]-T,A[6]=P[6]-M,A[7]=P[7]-w,A[8]=P[8]-T,A[9]=P[9]-M,A[10]=P[10]-w,A[11]=P[11]-T,A[12]=P[12]-M,A[13]=P[13]-w,A[14]=P[14]-T,A[15]=P[15]-M,A[16]=P[16]-w,A[17]=P[17]-T,A[18]=P[18]-M,A[19]=P[19]-w,A[20]=P[20]-T,A[21]=P[21]-M,A[22]=P[22]-w,A[23]=P[23]-T,A[24]=P[24]-M,A[25]=P[25]-w,A[26]=P[26]-T),d&&!l.poleRadius&&1==s.id[0]&&!s.isPole){var ae=s.getPhysicalCoords([s.extents.ur[0],s.extents.ur[1],0]);l.poleRadius=Math.sqrt(ae[0]*ae[0]+ae[1]*ae[1]),l.poleRadiusFactor=8*Math.pow(2,552058/l.poleRadius)}b=1;var se=""!=l.config.mapGridTextureLayer;if(se){if(!this.gridTexture){var ne=l.boundLayers[l.config.mapGridTextureLayer],oe=this;if(!ne||oe<ne.lodRange[0])se=!1;else{for(var he=g.clamp(oe.id[0]-l.config.mapGridTextureLevel,ne.lodRange[0],ne.lodRange[3]);oe.id[0]>he;)oe=oe.parent;this.gridTexture=this.resources.getTexture("gmap#"+l.config.mapGridTextureLayer,null,{sourceTile:oe,layer:ne,tile:this},null,null,null)}}se&&!this.gridTexture.isReady(!1,0,!1)&&(se=!1)}var le=te.onlyDepth;if(d&&s.isPole)b=l.poleRadiusFactor,x=le?te.progPlane2D:te.progPlane2,te.gpu.useProgram(x,["aPosition","aTexCoord"]),x.setVec4("uParams4",[-M,-w,l.poleRadius,0]);else if(C)x=te.progPlane,te.gpu.useProgram(x,["aPosition","aTexCoord"]);else x=le?te.progPlane3D:te.progPlane3,te.gpu.useProgram(x,["aPosition","aTexCoord"]),G=F?V.border3:V.border2,x.setFloatArray("uHeights",G),x.setVec3("uVector",V.diskNormal);x.setMat4("uMV",re),x.setMat4("uProj",ie),x.setFloatArray("uPoints",A);var ue=s.gridStep1*b,de=1/(o[0]-n[0]),ce=1/(n[1]-o[1]),pe=ue/((s.extents.ur[0]-s.extents.ll[0])*de),fe=ue/((s.extents.ur[1]-s.extents.ll[1])*ce),me=(n[0]-s.extents.ll[0])*de*pe,ge=(o[1]-s.extents.ll[1])*ce*fe;if(se){te.gpu.bindTexture(this.gridTexture.getGpuTexture()),x.setVec4("uParams",[ue*b,S.fogDensity,1/15,s.gridStep2*b]);var ve=this.gridTexture.getTransform();x.setVec4("uParams3",[ve[2],ve[3],ve[0],ve[1]]),x.setVec4("uParams2",[0,0,0,0])}else te.gpu.bindTexture(te.heightmapTexture),x.setVec4("uParams",[ue*b,S.fogDensity,1/15,s.gridStep2*b]),x.setVec4("uParams3",[ge-Math.floor(ge),me-Math.floor(me),fe,pe]),x.setVec4("uParams2",[0,0,s.gridBlend,0]);x.setVec4("uFogColor",S.atmoColor),te.planeMesh.draw(x,"aPosition","aTexCoord"),this.map.stats.drawnFaces+=te.planeMesh.polygons}}},b.prototype.drawHmapTile=function(e,t,r,i,a){if(this.metanode){var s,n,o,h,l=this.map,u=l.renderer;u.progHmapPlane||u.initProceduralShaders(),t?(s=t[0],n=t[1][0],o=t[1][1]):(s=(h=l.measure.getSpatialDivisionNodeAndExtents(this.id))[0],n=h[1][0],o=h[1][1]);var d=[.5*(o[0]+n[0]),.5*(o[1]+n[1])],c=l.referenceFrame.hasPoles;if(r=r||this.metanode.diskAngle2,c&&!s.isPole&&Math.acos(r)>.1*Math.PI)return r=Math.cos(.5*Math.acos(r)),this.drawHmapTile(e,[s,[[n[0],n[1]],[d[0],d[1]]]],r),this.drawHmapTile(e,[s,[[d[0],n[1]],[o[0],d[1]]]],r),this.drawHmapTile(e,[s,[[n[0],d[1]],[d[0],o[1]]]],r),void this.drawHmapTile(e,[s,[[d[0],d[1]],[o[0],o[1]]]],r);var p=s.extents.ur[1]-s.extents.ll[1],g=this.distance,v=Math.log(5*p/g)/l.log2;v=Math.max(0,v-8+s.id[0]);var y,b,x=l.draw,S=e[0],M=(S=e[0],e[1]),w=e[2],T=x.planeBuffer,A=this.gridPoints;l.config.mapGridSurrogatez;if(!A){0;var C=s.getPhysicalCoords([o[0],o[1],0],!0),F=s.getPhysicalCoords([o[0],n[1],0],!0),P=s.getPhysicalCoords([n[0],n[1],0],!0),L=s.getPhysicalCoords([n[0],o[1],0],!0),E=s.getPhysicalCoords([d[0],o[1],0],!0),N=s.getPhysicalCoords([d[0],n[1],0],!0),B=s.getPhysicalCoords([n[0],d[1],0],!0),I=s.getPhysicalCoords([o[0],d[1],0],!0);if(d[2]=0,d=s.getPhysicalCoords(d,!0),t)T[0]=L[0]-S,T[1]=L[1]-M,T[2]=L[2]-w,T[3]=E[0]-S,T[4]=E[1]-M,T[5]=E[2]-w,T[6]=C[0]-S,T[7]=C[1]-M,T[8]=C[2]-w,T[9]=B[0]-S,T[10]=B[1]-M,T[11]=B[2]-w,T[12]=d[0]-S,T[13]=d[1]-M,T[14]=d[2]-w,T[15]=I[0]-S,T[16]=I[1]-M,T[17]=I[2]-w,T[18]=P[0]-S,T[19]=P[1]-M,T[20]=P[2]-w,T[21]=N[0]-S,T[22]=N[1]-M,T[23]=N[2]-w,T[24]=F[0]-S,T[25]=F[1]-M,T[26]=F[2]-w;else{A=[L[0],L[1],L[2],E[0],E[1],E[2],C[0],C[1],C[2],B[0],B[1],B[2],d[0],d[1],d[2],I[0],I[1],I[2],P[0],P[1],P[2],N[0],N[1],N[2],F[0],F[1],F[2]];this.gridPoints=A}}var k=u.camera.getModelviewMatrix(),R=u.camera.getProjectionMatrix();if(A&&(T[0]=A[0]-S,T[1]=A[1]-M,T[2]=A[2]-w,T[3]=A[3]-S,T[4]=A[4]-M,T[5]=A[5]-w,T[6]=A[6]-S,T[7]=A[7]-M,T[8]=A[8]-w,T[9]=A[9]-S,T[10]=A[10]-M,T[11]=A[11]-w,T[12]=A[12]-S,T[13]=A[13]-M,T[14]=A[14]-w,T[15]=A[15]-S,T[16]=A[16]-M,T[17]=A[17]-w,T[18]=A[18]-S,T[19]=A[19]-M,T[20]=A[20]-w,T[21]=A[21]-S,T[22]=A[22]-M,T[23]=A[23]-w,T[24]=A[24]-S,T[25]=A[25]-M,T[26]=A[26]-w),c&&!l.poleRadius&&1==s.id[0]&&!s.isPole){var _=s.getPhysicalCoords([s.extents.ur[0],s.extents.ur[1],0]);l.poleRadius=Math.sqrt(_[0]*_[0]+_[1]*_[1]),l.poleRadiusFactor=8*Math.pow(2,552058/l.poleRadius)}var z=this.metanode,U=x.debug.drawTestMode;if(y=1,c&&s.isPole)y=l.poleRadiusFactor,b=u.progPlane2,u.gpu.useProgram(b,["aPosition","aTexCoord"]),b.setVec4("uParams4",[-S,-M,l.poleRadius,0]);else{switch(U){default:case 0:b=u.progHmapPlane;break;case 1:b=u.progHmapPlane2;break;case 2:b=u.progHmapPlane5;break;case 3:b=u.progHmapPlane6;break;case 4:b=u.progHmapPlane7;break;case 8:b=u.progHmapPlane4;break;case 9:b=1==i?u.progHmapPlane3:u.progHmapPlane8}if(3!=U&&4!=U||u.ntextures||(u.ntextures=[new m(u.gpu,"./textures/test/test001.png",u.core,null),new m(u.gpu,"./textures/test/test002.png",u.core,null),new m(u.gpu,"./textures/test003.jpg",u.core,null),new m(u.gpu,"./textures/download.png",u.core,null),new m(u.gpu,"./textures/test009.jpg",u.core,null),new m(u.gpu,"./textures/test004.jpg",u.core,null),new m(u.gpu,"./textures/test005.jpg",u.core,null),new m(u.gpu,"./textures/nor_sand.jpg",u.core,null),new m(u.gpu,"./textures/test007.jpg",u.core,null),new m(u.gpu,"./textures/test008.jpg",u.core,null),new m(u.gpu,"./textures/download (1).png",u.core,null),new m(u.gpu,"./textures/test010.jpg",u.core,null),new m(u.gpu,"./textures/test011.jpg",u.core,null),new m(u.gpu,"./textures/test012.jpg",u.core,null),new m(u.gpu,"./textures/test013.jpg",u.core,null),new m(u.gpu,"./textures/test014.jpg",u.core,null),new m(u.gpu,"./textures/test015.jpg",u.core,null),new m(u.gpu,"./textures/test016.jpg",u.core,null),new m(u.gpu,"./textures/test017.jpg",u.core,null),new m(u.gpu,"./textures/test018.jpg",u.core,null)]),u.gpu.useProgram(b,["aPosition"]),b.setVec3("uVector",z.diskNormal),A){var D=[A[15]-A[12],A[16]-A[13],A[17]-A[14]],O=[A[21]-A[12],A[22]-A[13],A[23]-A[14]];f.normalize(D),f.normalize(O);var V=z.diskNormal.slice(),G=(k=l.camera.camera.modelview,vts.mat3.create());vts.mat4.toInverseMat3(k,G),vts.mat3.transpose(G),vts.mat3.multiplyVec3(G,O),vts.mat3.multiplyVec3(G,V),vts.mat3.multiplyVec3(G,D);var j=[D[0],D[1],D[2],O[0],O[1],O[2],V[0],V[1],V[2]];b.setMat3("uSpace",j)}}b.setMat4("uMV",k),b.setMat4("uProj",R),b.setFloatArray("uPoints",T);var H=s.gridStep1*y;if(b.setVec4("uParams",[H*y,x.fogDensity,1/127,s.gridStep2*y]),U>=3&&U<=4)b.setVec4("uParams3",[1,1,0,0]);else if(a)b.setVec4("uParams3",a.getTransform());else{var q=1/(o[0]-n[0]),W=1/(n[1]-o[1]),J=H/((s.extents.ur[0]-s.extents.ll[0])*q),Z=H/((s.extents.ur[1]-s.extents.ll[1])*W),Y=(n[0]-s.extents.ll[0])*q*J,K=(o[1]-s.extents.ll[1])*W*Z;b.setVec4("uParams3",[Z,J,K-Math.floor(K),Y-Math.floor(Y)])}if(b.setVec4("uParams2",[0,0,s.gridBlend,0]),b.setVec4("uFogColor",x.atmoColor),this.hmap.extraBound?(z=this.hmap.extraBound.sourceTile.metanode,b.setVec3("uHeights",[z.minHeight,z.maxHeight,1/z.pixelSize]),b.setVec4("uTransform",this.hmap.getTransform())):(b.setVec3("uHeights",[z.minHeight,z.maxHeight,1/z.pixelSize]),b.setVec4("uTransform",[1,1,0,0])),U>=3&&U<=4){if(!u.ntextures[x.debug.drawTestData].loaded)return;u.gpu.bindTexture(u.ntextures[x.debug.drawTestData])}else a?u.gpu.bindTexture(a.getGpuTexture()):u.gpu.bindTexture(u.heightmapTexture);b.setSampler("uSampler",0),u.gpu.bindTexture(this.hmap.getGpuTexture(),1),b.setSampler("uSampler2",1),u.planeMesh2.draw(b,"aPosition"),this.map.stats.drawnFaces+=u.planeMesh2.polygons}};var x=b,S=a.d,M=x,w=function(e,t,r){this.map=e,this.camera=e.camera,this.rootId=[0,0,0],this.freeLayer=t,this.freeLayerSurface=r,this.metaBinaryOrder=this.map.referenceFrame.params.metaBinaryOrder,this.surfaceTree=new M(this.map,null,this.rootId),this.surfaceSequence=[],this.surfaceOnlySequence=[],this.config=this.map.config,this.cameraPos=[0,0,0],this.worldPos=[0,0,0],this.ndcToScreenPixel=1,this.counter=0};w.prototype.kill=function(){this.surfaceTree=null,this.metastorageTree=null,this.surfaceTracer=null,this.heightTracer=null},w.prototype.findSurfaceTile=function(e){for(var t=this.surfaceTree,r=e[0];r>0;r--){var i=1<<r-1,a=0;if(0!=(e[1]&i)&&(a+=1),0!=(e[2]&i)&&(a+=2),!(t=t.children[a]))return null}return t},w.prototype.findNavTile=function(e){var t=this.surfaceTree;if(0==e[0])return t.metanode&&t.metanode.hasNavtile()?t:null;for(var r=null,i=e[0];i>0;i--){var a=1<<i-1,s=0;if(0!=(e[1]&a)&&(s+=1),0!=(e[2]&a)&&(s+=2),!(t=t.children[s]))return r;t.metanode&&t.metanode.hasNavtile()&&(r=t)}return r},w.prototype.draw=function(e){this.cameraPos=[0,0,0],this.worldPos=[0,0,0];var t=this.map,r=t.draw;this.ndcToScreenPixel=r.ndcToScreenPixel;var i=t.getPhysicalSrs().periodicity;if(!this.freeLayerSurface||!this.freeLayerSurface.geodata||0==r.drawChannel)if(null!=i)this.drawSurface([0,0,0]),"X"==i.type&&(this.drawSurface([i.period,0,0],e),this.drawSurface([-i.period,0,0],e));else switch(this.freeLayerSurface&&this.freeLayerSurface.geodata?t.config.mapGeodataLoadMode:t.config.mapLoadMode){case"topdown":t.config.mapSplitMeshes?this.drawSurfaceWithSpliting([0,0,0],e):this.drawSurface([0,0,0],e);break;case"downtop":this.drawSurfaceDownTop([0,0,0],e);break;case"fit":this.drawSurfaceFit([0,0,0],e);break;case"fitonly":this.drawSurfaceFitOnly([0,0,0],e)}},w.prototype.updateNodeHeightExtents=function(e,t){if(!t.heightReady&&t.metatile.useVersion<4){for(var r=e.parent;r;){var i=r.metanode;if(i.hasNavtile()){t.minHeight=i.minHeight,t.maxHeight=i.maxHeight,t.minZ=i.minZ,t.maxZ=i.maxZ,t.minZ2=i.minZ2,t.maxZ2=i.maxZ2,t.generateCullingHelpers();break}r=r.parent}t.heightReady=!0}},w.prototype.logTileInfo=function(e,t,r){if(e&&t){var i=e.bboxVisible(e.id,t.bbox,r,t);e.updateTexelSize(),console.log("tile: "+JSON.stringify(e.id)+" visible: "+i+" texelsize: "+e.texelSize+" center: "+JSON.stringify(t.diskPos)+" vec: "+t.diskNormal+"ang: "+t.diskAngle+" dist: "+t.diskDistance)}},w.prototype.drawSurface=function(e,t){this.counter++;var r=this.surfaceTree;if(r.isMetanodeReady(this,0)){var i=this.map,a=r.metanode,s=i.camera.position;if(r.bboxVisible(r.id,a.bbox,s,a)){r.updateTexelSize();var n=(this.freeLayerSurface,1),o=i.draw,h=o.drawTiles,l=o.drawBuffer,u=o.processBuffer,d=o.processBuffer2,c=0,p=0,f=0,m=0,g=0;u[0]=r,p=1;var v=o.texelSizeFit,y=o.replay,b=y.storeNodes||y.storeFreeNodes,x=y.nodeBuffer;o.drawCounter++;var S,M,w,T=1,A=1,C=1,F=o.drawCounter;do{var P=0;for(f=0,S=p-1;S>=0;S--)if((a=(r=u[S]).metanode)&&(T++,a.metatile.drawCounter!=F&&(a.metatile.drawCounter=F,A++)),r.bboxVisible(r.id,a.bbox,s,a))if(C++,r.texelSize!=Number.POSITIVE_INFINITY&&r.texelSize>P&&(P=r.texelSize),b&&x.push(r),r.texelSize<=v)m+=g=o.getDrawCommandsGpuSize(r.drawCommands[o.drawChannel]||r.lastRenderState.drawCommands[o.drawChannel]),g,r.drawCounter=o.drawCounter,l[c]=r,c++;else{m+=g=o.getDrawCommandsGpuSize(r.drawCommands[o.drawChannel]||r.lastRenderState.drawCommands[o.drawChannel]);var L=0,E=0,N=[];for(M=0;M<4;M++){var B=r.children[M];if(B&&(L++,B.isMetanodeReady(this,B.id[0]))){this.updateNodeHeightExtents(B,B.metanode),B.updateTexelSize(1);var I=B.id[0]*n*B.distance;r.surface&&B.metanode.hasGeometry()?h.drawSurfaceTile(B,B.metanode,s,B.texelSize,I,!0,!1,!0)&&(E++,N.push(B)):(E++,N.push(B))}}if(/*!(gpuNeeded > gpuMax) &&*/L>0&&L==E){do{var k=!0;for(M=0,w=N.length-1;M<w;M++)if(N[M].distance>N[M+1].distance){var R=N[M];N[M]=N[M+1],N[M+1]=R,k=!1}}while(!k);for(M=0,w=N.length;M<w;M++)d[f]=N[M],f++}else g,r.drawCounter=o.drawCounter,l[c]=r,c++}var _=u;u=d,d=_,p=f}while(p>0);if(t)this.storeDrawBufferGeometry(c);else{0>o.bestMeshTexelSize&&(o.bestMeshTexelSize=0);var z=i.stats;z.usedNodes=C,z.processedNodes=T,z.processedMetatiles=A,z.gpuNeeded=m,this.processDrawBuffer(o,h,s,i,z,!1,!1,y,l,c,!0)}}}},w.prototype.drawSurfaceWithSpliting=function(e,t){this.counter++;var r=this.surfaceTree;if(r.isMetanodeReady(this,0)){var i=this.map,a=r.metanode,s=i.camera.position;if(r.bboxVisible(r.id,a.bbox,s,a)){r.updateTexelSize();var n=(this.freeLayerSurface,1),o=i.draw,h=o.drawTiles,l=o.drawBuffer,u=o.processBuffer,d=o.processBuffer2,c=0,p=0,f=0,m=0,g=0;u[0]=r,p=1;var v=o.texelSizeFit,y=o.replay,b=y.storeNodes||y.storeFreeNodes,x=y.nodeBuffer;o.drawCounter++;var S,M,w,T=1,A=1,C=1,F=o.drawCounter;do{var P=0;for(f=0,S=p-1;S>=0;S--)if((a=(r=u[S]).metanode)&&(T++,a.metatile.drawCounter!=F&&(a.metatile.drawCounter=F,A++)),r.splitMask=null,r.visibleCounter==F||r.bboxVisible(r.id,a.bbox,s,a))if(C++,r.texelSize!=Number.POSITIVE_INFINITY&&r.texelSize>P&&(P=r.texelSize),b&&x.push(r),r.texelSize<=v)r.skipRenderCounter!=F&&(m+=g=o.getDrawCommandsGpuSize(r.drawCommands[o.drawChannel]||r.lastRenderState.drawCommands[o.drawChannel]),g,r.drawCounter=F,l[c]=r,c++);else{m+=g=o.getDrawCommandsGpuSize(r.drawCommands[o.drawChannel]||r.lastRenderState.drawCommands[o.drawChannel]);var L=0,E=[],N=[1,1,1,1],B=!1;for(M=0;M<4;M++){var I=r.children[M];if(I)if(L++,I.skipRenderCounter=r.skipRenderCounter,I.isMetanodeReady(this,I.id[0])){if(this.updateNodeHeightExtents(I,I.metanode),I.updateTexelSize(1),!I.bboxVisible(I.id,I.metanode.bbox,s,I.metanode))continue;I.visibleCounter=o.drawCounter;var k=I.id[0]*n*I.distance;r.surface&&I.metanode.hasGeometry()?h.drawSurfaceTile(I,I.metanode,s,I.texelSize,k,!0,!1,!0)?(E.push(I),N[M]=0):(E.push(I),I.skipRenderCounter=F,B=!0):E.push(I)}else B=!0}if(E.length>0){do{var R=!0;for(M=0,w=E.length-1;M<w;M++)if(E[M].distance>E[M+1].distance){var _=E[M];E[M]=E[M+1],E[M+1]=_,R=!1}}while(!R);for(M=0,w=E.length;M<w;M++)d[f]=E[M],f++}(0==L||B)&&r.skipRenderCounter!=F&&(g,r.splitMask=B?N:null,r.drawCounter=F,l[c]=r,c++)}var z=u;u=d,d=z,p=f}while(p>0);if(t)this.storeDrawBufferGeometry(c);else{0>o.bestMeshTexelSize&&(o.bestMeshTexelSize=0);var U=i.stats;U.usedNodes=C,U.processedNodes=T,U.processedMetatiles=A,U.gpuNeeded=m,this.processDrawBuffer(o,h,s,i,U,!1,!1,y,l,c,!0)}}}},w.prototype.drawSurfaceFitOnly=function(e,t,r){this.counter++;var i=this.surfaceTree;if(i.isMetanodeReady(this,0)){var a=this.map,s=i.metanode,n=a.camera.position;if(i.bboxVisible(i.id,s.bbox,n,s)){i.updateTexelSize();var o=a.draw,h=o.drawTiles,l=o.drawBuffer,u=o.processBuffer,d=o.processBuffer2,c=0,p=0,f=0;u[0]=i,p=1;var m=o.texelSizeFit,g=a.draw.replay,v=g.storeNodes||g.storeFreeNodes,y=g.nodeBuffer;o.drawCounter++;var b,x,S,M=1,w=1,T=1,A=o.drawCounter;do{var C=0;for(f=0,b=p-1;b>=0;b--)if((s=(i=u[b]).metanode)&&(w++,s.metatile.drawCounter!=A&&(s.metatile.drawCounter=A,T++)),i.bboxVisible(i.id,s.bbox,n,s))if(M++,v&&y.push(i),i.texelSize!=Number.POSITIVE_INFINITY&&i.texelSize>C&&(C=i.texelSize),i.texelSize<=m)i.drawCounter=o.drawCounter,l[c]=i,c++;else{var F=0,P=0,L=[];for(x=0;x<4;x++){var E=i.children[x];E&&(F++,E.isMetanodeReady(this,E.id[0])&&(this.updateNodeHeightExtents(E,E.metanode),E.updateTexelSize(),L.push(E),P++))}if(F>0&&(!r||F==P)){do{var N=!0;for(x=0,S=L.length-1;x<S;x++)if(L[x].distance>L[x+1].distance){var B=L[x];L[x]=L[x+1],L[x+1]=B,N=!1}}while(!N);for(x=0,S=L.length;x<S;x++)d[f]=L[x],f++}else i.drawCounter=o.drawCounter,l[c]=i,c++}var I=u;u=d,d=I,p=f}while(p>0);if(t){if(r){I=o.drawBuffer2;o.drawBuffer2=o.drawBuffer,o.drawBuffer=I}else this.storeDrawBufferGeometry(c);return c}var k=a.stats;k.usedNodes=M,k.processedNodes=w,k.processedMetatiles=T,this.processDrawBuffer(o,h,n,a,k,!1,!1,g,l,c,!0)}}},w.prototype.drawSurfaceFit=function(e,t){this.counter++;var r=this.surfaceTree;if(r.isMetanodeReady(this,0)){var i=this.map,a=r.metanode,s=i.camera.position;if(r.bboxVisible(r.id,a.bbox,s,a)){r.updateTexelSize();var n=r.surface?r.surface.geodata:null,o=r.surface.maxLod||r.surface.lodRange[1],h=r.surface?r.surface.free:null,l=!n&&!h&&i.config.mapHeightfiledWhenUnloaded,u=4,d=2e3;this.freeLayerSurface&&(u=0,d=.1);var c=i.draw,p=c.drawTiles,f=c.replay,m=c.drawBuffer,g=c.processBuffer,v=c.processBuffer2,y=0,b=0,x=0;g[0]=[r,0],b=1;var S=c.texelSizeFit,M=f.storeNodes||f.storeFreeNodes,w=f.nodeBuffer;c.drawCounter++;var T,A,C,F,P,L,E,N,B=1,I=1,k=1,R=c.drawCounter,_=i.config.mapMaxHiresLodLevels,z=!1;do{var U=0;for(x=0,T=b-1;T>=0;T--){var D=g[T];r=D[0];var O=D[1];if(r.childrenReadyCount=0,O>=_)l&&(E=(L=r).parent,L.id[0]>3&&0!=O&&E&&0==E.childrenReadyCount&&(N=E.children,O>=1&&L.parent&&(N[0]&&0!=N[0].childrenReadyCount||N[1]&&0!=N[1].childrenReadyCount||N[2]&&0!=N[2].childrenReadyCount||N[3]&&0!=N[3].childrenReadyCount)||(L=L.parent)),L.drawCounter==c.drawCounter||L.parent&&L.parent.drawCounter==c.drawCounter||(L.drawCounter=c.drawCounter,m[y]=[L,!0],y++,z=!0));else{if((a=r.metanode)&&(I++,a.metatile.drawCounter!=R&&(a.metatile.drawCounter=R,k++)),r.bboxVisible(r.id,a.bbox,s,a)){B++,r.texelSize!=Number.POSITIVE_INFINITY&&r.texelSize>U&&(U=r.texelSize),M&&w.push(r);var V=x,G=y;if(!a.hasChildren()||r.texelSize<=S||n&&r.id[0]>=o)if(P=(r.id[0]+u)*d*r.distance,a.hasChildren()&&!p.drawSurfaceTile(r,r.metanode,s,r.texelSize,P,!0,O>0,!0)){for(O++,A=0;A<4;A++)(F=r.children[A])&&F.isMetanodeReady(this,F.id[0],!0)&&(this.updateNodeHeightExtents(F,F.metanode),F.updateTexelSize(),p.drawSurfaceTile(F,F.metanode,s,F.texelSize,P,!0,O>0,!0)?(r.childrenReadyCount++,F.drawCounter=c.drawCounter,m[y]=[F,!1],y++):(v[x]=[F,O],x++));V==x&&G==y&&O--}else r.drawCounter=c.drawCounter,m[y]=[r,!1],y++;else if(0==O&&a.hasGeometry()&&r.texelSize<=2*S){var j=0,H=0,q=[];for(A=0;A<4;A++)(F=r.children[A])&&(j++,F.isMetanodeReady(this,F.id[0])&&(this.updateNodeHeightExtents(F,F.metanode),F.updateTexelSize(),P=(F.id[0]+u)*d*F.distance,p.drawSurfaceTile(F,F.metanode,s,F.texelSize,P,!0,!0,!0)&&(H++,q.push(F))));if(j>0&&j==H){do{var W=!0;for(A=0,C=q.length-1;A<C;A++)if(q[A].distance>q[A+1].distance){var J=q[A];q[A]=q[A+1],q[A+1]=J,W=!1}}while(!W);for(A=0,C=q.length;A<C;A++)v[x]=[q[A],O],x++}else if(P=(r.id[0]+u)*d*r.distance,p.drawSurfaceTile(r,r.metanode,s,r.texelSize,P,!0,!0,!0))for(r.drawCounter=c.drawCounter,m[y]=[r,!1],y++,A=0;A<4;A++)(F=r.children[A])&&F.isMetanodeReady(this,F.id[0])&&(P=(F.id[0]+u)*d*F.distance,p.drawSurfaceTile(F,F.metanode,s,F.texelSize,P,!0,!1,!0));else for(A=0;A<4;A++)(F=r.children[A])&&F.isMetanodeReady(this,F.id[0])&&(this.updateNodeHeightExtents(F,F.metanode),F.updateTexelSize(),v[x]=[F,O],x++)}else for(A=0;A<4;A++)(F=r.children[A])&&F.isMetanodeReady(this,F.id[0])&&(this.updateNodeHeightExtents(F,F.metanode),F.updateTexelSize(),v[x]=[F,O],x++)}l&&V==x&&G==y&&(E=(L=r).parent,L.id[0]>3&&0!=O&&E&&0==E.childrenReadyCount&&(N=E.children,O>=1&&L.parent&&(N[0]&&0!=N[0].childrenReadyCount||N[1]&&0!=N[1].childrenReadyCount||N[2]&&0!=N[2].childrenReadyCount||N[3]&&0!=N[3].childrenReadyCount)||(L=L.parent)),L&&L.drawCounter!=c.drawCounter&&(L.drawCounter=c.drawCounter,m[y]=[L,!0],y++,z=!0))}}var Z=g;g=v,v=Z,b=x}while(b>0);if(t)this.storeDrawBufferGeometry(y);else{var Y=i.stats;Y.usedNodes=B,Y.processedNodes=I,Y.processedMetatiles=k,this.processDrawBuffer(c,p,s,i,Y,l,z,f,m,y)}}}},w.prototype.drawSurfaceDownTop=function(e,t){this.counter++;var r=this.map,i=r.camera.position,a=this.surfaceTree;if(a.isMetanodeReady(this,0)){a.updateTexelSize();var s=a,n=a.metanode;if(a.bboxVisible(a.id,n.bbox,i,n)){var o,h,l=(O=r.draw).drawTiles,u=O.drawBuffer,d=O.drawBuffer2,c=0,p=!1,f=O.texelSizeFit,m=0,g=O.processBuffer,v=O.processBuffer2,y=0,b=0;g[0]=a,y=1;f=O.texelSizeFit;O.drawCounter++;var x,S,M,w,T,A=(G=r.draw.replay).storeNodes||G.storeFreeNodes,C=G.nodeBuffer,F=O.drawCounter;p=!1;do{var P=0;for(b=0,x=y-1;x>=0;x--)if((n=(a=g[x]).metanode)&&(n.metatile.drawCounter!=F&&(n.metatile.drawCounter=F)),a.bboxVisible(a.id,n.bbox,i,n))if(A&&C.push(a),a.texelSize!=Number.POSITIVE_INFINITY&&a.texelSize>P&&(P=a.texelSize),a.texelSize<=f)a.drawCounter=F,u[c]=a,c++;else{var L=0,E=0,N=[];for(S=0;S<4;S++){var B;(B=a.children[S])&&(L++,B.isMetanodeReady(this,B.id[0])&&(this.updateNodeHeightExtents(B,B.metanode),B.updateTexelSize(),N.push(B),E++))}if(L>0&&L==E){do{var I=!0;for(S=0,M=N.length-1;S<M;S++)if(N[S].distance>N[S+1].distance){var k=N[S];N[S]=N[S+1],N[S+1]=k,I=!1}}while(!I);for(S=0,M=N.length;S<M;S++)v[b]=N[S],b++}else a.drawCounter=F,u[c]=[a,!0],c++}var R=g;g=v,v=R,y=b}while(y>0);if(0!=c){R=O.drawBuffer2;O.drawBuffer2=O.drawBuffer,O.drawBuffer=R,u=O.drawBuffer;d=O.drawBuffer2;var _=c;c=0;var z=4,U=2e3;this.freeLayerSurface&&(z=0,U=.1);var D=function(){var e=!1;if(a!=s){for(h=a.parent;h!=s;){if(o=(h.id[0]+z)*U,l.drawSurfaceTile(h,h.metanode,i,h.texelSize,o,!0,!0,!1)){u[c]=[h,!1],h.drawCounter=F,e=!0;for(var t=0;t<4;t++)(B=h.children[t])&&B.isMetanodeReady(this,B.id[0])&&(l.drawSurfaceTile(B,B.metanode,i,B.texelSize,o,!0,!1,!1)||m++);break}h=h.parent}e||(o=(a.id[0]+z)*U,l.drawSurfaceTile(a,a.metanode,i,a.texelSize,o,!0,!1,!1)?(u[c]=[a,!1],a.drawCounter=F):(u[c]=[a,!0],a.drawCounter=F,m++))}};for(x=_-1;x>=0;x--){if((w=d[x])[1]){if(!(a=w[0]).isMetanodeReady(this,a.id[0]))continue;u[c]=[a,!0],p=!0,o=20,D()}else n=(a=w).metanode,u[c]=[a,!1],o=(a.id[0]+z)*U,l.drawSurfaceTile(a,a.metanode,i,a.texelSize,o,!0,!1,!1)?a.drawCounter=F:(D(),m++);c++}R=d;d=u,u=R;_=c;for(c=0,x=0;x<_;x++){if(w=d[x],T=!1,(a=w[0])!=s)for(h=a.parent;h!=s;){if(h.drawCounter==F){T=!0;break}h=h.parent}T||(u[c]=d[x],c++)}if(0==m)for(x=0;x<c;x++)if(w=u[x],T=!1,(a=w[0])!=s)for(h=a.parent;h!=s&&(o=(100-a.id[0]+z)*U,l.drawSurfaceTile(h,h.metanode,i,h.texelSize,o,!0,!1,!1));)h=h.parent;var O,V=r.stats,G=(l=(O=r.draw).drawTiles,O.replay),j=a.surface?a.surface.geodata:null,H=a.surface?a.surface.free:null,q=!j&&!H&&r.config.mapHeightfiledWhenUnloaded;this.processDrawBuffer(O,l,i,r,V,q,p,G,u,c)}}}},w.prototype.processDrawBuffer=function(e,t,r,i,a,s,n,o,h,l,u){if(o.storeTiles||o.storeFreeTiles){e.tileBuffer[0]||(e.tileBuffer[0]=[]);var d=e.tileBuffer[0];for(y=l-1;y>=0;y--)d.push(h[y])}var c,p,f,m,g,v,y,b,x,M=!this.freeLayerSurface&&2==i.config.mapFeatureStickMode[0],w=-999999,T=999999,A=i.renderer;this.camera.getMvpMatrix();i.gpuCache.skipCostCheck=!0;var C=s&&i.config.mapGridUnderSurface>0&&n;if(C){for(y=l-1;y>=0;y--)h[y][0].drawGrid(r);i.renderer.gpu.clear(!0,!1)}for(y=l-1;y>=0;y--){var F=h[y];if(x=(b=u?F:F[0]).metanode,M&&x&&(p=x.diskPos,c=A.cameraPosition,f=[p[0]-c[0],p[1]-c[1],p[2]-c[2]],m=S.normalize4(f),(g=-S.dot(f,x.diskNormal))<0&&(g=0),g=1-g,v=A.camera.fovDist/m*g,x.minZ*v<T&&(T=x.minZ*v),x.maxZ*v>w&&(w=x.maxZ*v)),u){if(a.gpuRenderUsed>=e.maxGpuUsed)break;t.drawSurfaceTile(b,b.metanode,r,b.texelSize,0,!1,!1)}else C?F[1]||a.gpuRenderUsed>=e.maxGpuUsed?t.debug.drawBBoxes&&t.drawTileInfo(b,b.metanode,r):t.drawSurfaceTile(b,b.metanode,r,b.texelSize,0,!1,!1):s&&F[1]||a.gpuRenderUsed>=e.maxGpuUsed?(t.debug.drawBBoxes&&t.drawTileInfo(b,b.metanode,r),b.drawGrid(r)):F[1]||t.drawSurfaceTile(b,b.metanode,r,b.texelSize,0,!1,!1)}M&&(A.gridHmax=w,A.gridHmin=T),i.gpuCache.skipCostCheck=!1,i.gpuCache.checkCost()},w.prototype.storeDrawBufferGeometry=function(e){var t=this.map.draw.drawBuffer;this.storeGeometry(t,e)},w.prototype.storeGeometry=function(e,t){var r=this.map,i=e;r.storedTilesRes=new Array(t);for(var a=t-1;a>=0;a--){var s=i[a];if(s.metanode&&s.surface&&s.metanode.hasGeometry()&&s.surfaceMesh&&s.surfaceMesh.isReady(!0,0,!0)){for(var n=s.surfaceMesh,o=[],h=0,l=n.submeshes.length;h<l;h++){for(var u=n.submeshes[h],d=u.vertices.slice(),c=u.bbox.min,p=u.bbox.max,f=[p[0]-c[0],p[1]-c[1],p[2]-c[2]],m=0,g=d.length;m<g;m+=3)d[m]=d[m]*f[0]+c[0],d[m+1]=d[m+1]*f[1]+c[1],d[m+2]=d[m+2]*f[2]+c[2];o.push({bbox:[c.slice(),p.slice()],vertices:d})}r.storedTilesRes[a]={id:s.id.slice(),type:"mesh",submeshes:o}}}},w.prototype.traceHeight=function(e,t,r){if(e){this.params=t;var i=r?this.traceHeightTileByNodeOnly:this.traceHeightTileByMap;(1!=e.id[0]||(this.traceHeightTile(e.parent,0,!0),e.parent.metanode))&&this.traceHeightTile(e,0,!1,i)}},w.prototype.traceHeightTile=function(e,t,r,i){if(null!=e)if(e.isMetanodeReady(this,0)&&!r){if(e.metanode.metatile.used(),e.lastSurface&&e.lastSurface==e.surface&&(e.lastSurface=null,e.restoreLastState()),i(e,this.params,t)){var a=this.traceHeightChild(e,this.params),s=e.children[a];s||(this.params.finalNode=!0),this.traceHeightTile(s,0,!1,i)}}else this.params.waitingForNode=!0},w.prototype.traceHeightChild=function(e,t){var r=t.coords,i=t.extents,a=[.5*(i.ll[0]+i.ur[0]),.5*(i.ll[1]+i.ur[1])],s=r[0]>=a[0],n=r[1]>=a[1];return s?(i.ll[0]=a[0],n?i.ll[1]=a[1]:i.ur[1]=a[1]):(i.ur[0]=a[0],n?i.ll[1]=a[1]:i.ur[1]=a[1]),s?n?1:3:n?0:2},w.prototype.traceHeightTileByMap=function(e,t){if(!e||e.id[0]>t.desiredLod&&t.heightMap)return!1;var r=e.metanode;if(!r)return!1;if(!r.hasNavtile())return t.heightMap||(t.metanode=r),!0;if(t.bestHeightMap=e.id[0],e.heightMap){if(e.heightMap.isReady(null,null,!0))return t.parent={metanode:t.metanode,heightMap:t.heightMap,heightMapExtents:t.heightMapExtents},t.metanode=r,t.heightMap=e.heightMap,t.heightMapExtents={ll:t.extents.ll.slice(),ur:t.extents.ur.slice()},e.id[0]!=t.desiredLod}else{if(!e.surface||!e.resourceSurface)return!1;if(!e.resourceSurface.getNavUrl)return!1;var i=e.resourceSurface.getNavUrl(e.id);e.heightMap=e.resources.getTexture(i,!0)}return!1},w.prototype.traceHeightTileByNodeOnly=function(e,t){if(!e||e.id[0]>t.desiredLod)return!1;var r=e.metanode;return!!r&&(t.parent={metanode:t.metanode},t.metanode=r,e.id[0]!=t.desiredLod)},w.prototype.getNodeById=function(e,t){var r=this.surfaceTree;if(null!=r){for(var i=e[0];i>0;i--){var a=1<<i-1,s=0;if(0!=(e[1]&a)&&(s+=1),0!=(e[2]&a)&&(s+=2),!r.children[s]){if(!r.isMetanodeReady(this,0,t))return null;if(!r.metanode.hasChild(s))return null;r.addChild(s)}r=r.children[s]}if(r&&r.isMetanodeReady(this,0,t)){var n=r.metanode;return r.metanode.metatile.used(),n}}},w.prototype.getRenderedNodeById=function(e,t){var r=this.surfaceTree;if(null!=r){if(r.drawCounter==t){if(!r.isMetanodeReady(this,0))return;return r.metanode}for(var i=e[0];i>0;i--){var a=1<<i-1,s=0;if(0!=(e[1]&a)&&(s+=1),0!=(e[2]&a)&&(s+=2),!r.children[s]){if(!r.isMetanodeReady(this,0))return;if(!r.metanode.hasChild(s))return}if((r=r.children[s]).drawCounter==t){if(!r.isMetanodeReady(this,0))return;return r.metanode}if(1==i)return r.metanode}}},w.prototype.chekTileMesh=function(e){if(this.params.loadMeshes||this.params.loadTextures){var t=this.config.mapNoTextures;this.config.mapNoTextures=!this.params.loadTextures,this.map.draw.drawTiles.drawSurfaceTile(e,e.metanode,this.map.renderer.cameraPosition,e.texelSize,0,!0,!1,!0)||(this.params.loaded=!1),this.config.mapNoTextures=t}},w.prototype.traceAreaTiles=function(e,t,r){if(null!=e){if(!e.isMetanodeReady(this,0)||r)return this.params.loaded=!1,void e.isMetanodeReady(this,0);if(e.metanode.metatile.used(),e.lastSurface&&e.lastSurface==e.surface&&(e.lastSurface=null,e.restoreLastState()),e.insideCone(this.params.coneVec,this.params.coneAngle,e.metanode)){if("lod"==this.params.mode?e.id[0]>=this.params.limit:e.metanode.pixelSize<=this.params.limit)return this.chekTileMesh(e),void this.params.areaTiles.push(e);if(e.metanode.hasChildren())for(var i=0;i<4;i++)this.traceAreaTiles(e.children[i],t,r);else this.chekTileMesh(e),this.params.areaTiles.push(e)}}};var T=w,A=s.a,C=c,F=function(e,t,r,i,a){this.map=e,this.stats=e.stats,this.tile=i,this.internal=a,this.image=null,this.imageData=null,this.imageExtents=null,this.gpuTexture=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.neverReady=!1,this.mapLoaderUrl=t,this.type=r||!1,this.statsCounter=0,this.checkStatus=0,this.checkType=null,this.checkValue=null,this.fastHeaderCheck=!1,this.gpuSize=0,this.fileSize=0,this.cacheItem=null,this.gpuCacheItem=null};F.prototype.kill=function(){this.killImage(),this.killGpuTexture(),this.mask&&(this.mask.killImage(),this.mask.killGpuTexture())},F.prototype.killImage=function(e){this.image=null,this.imageData=null,!0!==e&&this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),this.mask&&this.mask.killImage(),this.gpuTexture||(this.loadState=0),this.cacheItem=null},F.prototype.killGpuTexture=function(e){null!=this.gpuTexture&&(this.stats.gpuTextures-=this.gpuTexture.size,this.gpuTexture.kill(),this.stats.graphsFluxTexture[1][0]++,this.stats.graphsFluxTexture[1][1]+=this.gpuTexture.size,this.mask&&this.mask.killGpuTexture()),this.gpuTexture=null,!0!==e&&this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.image||this.imageData||(this.loadState=0),this.gpuCacheItem=null},F.prototype.isReady=function(e,t,r,i){var a=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||a,this.neverReady)return!1;switch(i.checkType){case 2:case 3:case 4:if(2!=this.checkStatus){if(this.checkType=i.checkType,this.checkValue=i.checkValue,0==this.checkStatus)this.scheduleHeadRequest(t,4==this.checkType);else if(3==this.checkStatus)this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleHeadRequest(t,4==this.checkType);else if(-1==this.checkStatus&&i.extraInfo)for(i.extraBound||(i.extraBound={tile:i.extraInfo.tile,layer:i.extraInfo.layer},i.setBoundTexture(i.extraBound.tile.parent,i.extraBound.layer));i.extraBound.texture.extraBound||-1==i.extraBound.texture.checkStatus;)i.setBoundTexture(i.extraBound.sourceTile.parent,i.extraBound.layer);return!1}}if(2==this.loadState){var s;if(!e&&this.cacheItem&&this.map.resourcesCache.updateItem(this.cacheItem),r)return 1==this.type&&(this.imageData||(s=performance.now(),this.buildHeightMap(),this.stats.renderBuild+=performance.now()-s)),!0;if(1==this.type)this.imageData||(s=performance.now(),this.buildHeightMap(),this.stats.renderBuild+=performance.now()-s);else{if(!this.gpuTexture){if(this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed)return!1;if(a)return!1;s=performance.now(),this.buildGpuTexture(),this.stats.renderBuild+=performance.now()-s}!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem)}return!0}return 0==this.loadState?e||this.scheduleLoad(t):3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t),!1},F.prototype.scheduleLoad=function(e,t){this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this,t),e,this.tile,this.internal?"texture-in":"texture-ex")},F.prototype.onLoad=function(e,t,r,i){this.mapLoaderCallLoaded=r,this.mapLoaderCallError=i;var a=this.onLoadError.bind(this),s=this.onLoaded.bind(this);e?this.checkStatus=1:this.loadState=1,this.map.config.mapXhrImageLoad?this.map.loader.processLoadBinary(t,this.onBinaryLoaded.bind(this),a,null,"texture"):this.image=A.loadImage(t,s,a,!!this.map.core.tokenCookieHost&&-1!=t.indexOf(this.map.core.tokenCookieHost))},F.prototype.onLoadError=function(e){this.map.killed||(e&&window.URL.revokeObjectURL(this.image.src),this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},F.prototype.onBinaryLoaded=function(e,t,r){if(this.fastHeaderCheck&&this.checkType&&1!=this.checkType&&(this.onHeadLoaded(null,e,null),-1==this.checkStatus))this.mapLoaderCallLoaded();else{if(t)return this.onLoaded(!1,e),void(this.fileSize=r);if(this.fileSize=e.size,this.map.config.mapAsyncImageDecode)createImageBitmap(e).then(this.onLoaded.bind(this,!1));else{var i=new Image;i.onerror=this.onLoadError.bind(this,!0,null),i.onload=this.onLoaded.bind(this,!0,null),this.image=i,i.src=window.URL.createObjectURL(e)}}},F.prototype.onLoaded=function(e,t){if(!this.map.killed){e&&window.URL.revokeObjectURL(this.image.src),t&&(this.image=t,this.image.naturalWidth=t.width,this.image.naturalHeight=t.height);var r=this.image.naturalWidth*this.image.naturalHeight*(this.heightMap,3);this.gpuSize=this.image.naturalWidth*this.image.naturalHeight*4,this.cacheItem=this.map.resourcesCache.insert(this.killImage.bind(this,!0),r),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},F.prototype.scheduleHeadRequest=function(e,t){this.map.config.mapXhrImageLoad&&this.fastHeaderCheck?this.scheduleLoad(e,!0):this.map.loader.load(this.mapLoaderUrl,this.onLoadHead.bind(this,t),e,this.tile,this.internal,this.internal?"texture-in":"texture-ex")},F.prototype.onLoadHead=function(e,t,r,i){this.mapLoaderCallLoaded=r,this.mapLoaderCallError=i;var a=this.onLoadHeadError.bind(this,e),s=this.onHeadLoaded.bind(this,e);this.checkStatus=1,e?this.map.loader.processLoadBinary(t,onLoad,a,null,"texture"):A.headRequest(t,s,a,!!A.useCredentials&&-1!=this.mapLoaderUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams,"blob")},F.prototype.onLoadHeadError=function(){this.map.killed||(this.checkStatus=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},F.prototype.onHeadLoaded=function(e,t,r){if(!this.map.killed)if(this.checkStatus=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.map.config.mapXhrImageLoad&&this.fastHeaderCheck)switch(this.checkType){case 4:t&&t.size==this.checkValue&&(this.checkStatus=-1);break;case 2:t&&t.type==this.checkValue&&(this.checkStatus=-1);break;case 3:r&&-1!=this.checkValue.indexOf(r)&&(this.checkStatus=-1)}else{switch(this.checkType){case 4:t&&t.byteLength==this.checkValue&&(this.checkStatus=-1);break;case 2:t&&-1!=t.indexOf(this.checkValue)&&(this.checkStatus=-1);break;case 3:r&&-1!=this.checkValue.indexOf(r)&&(this.checkStatus=-1)}this.mapLoaderCallLoaded()}},F.prototype.buildGpuTexture=function(){if(this.map.config.mapCheckTextureSize&&(this.image.naturalWidth>1024||this.image.naturalHeight>1024)){console.log("very large texture: "+this.image.naturalWidth+"x"+this.image.naturalHeight+" "+this.mapLoaderUrl);for(var e=new Uint8Array(1024),t=0;t<16;t++)for(var r=0;r<16;r++){var i=4*(16*t+r);e[i]=0,e[i+1]=0,e[i+2]=0,e[i+3]=255}return this.gpuTexture=new C(this.map.renderer.gpu),this.gpuTexture.createFromData(16,16,e),this.gpuTexture.width=this.image.naturalWidth,this.gpuTexture.height=this.image.naturalHeight,void(this.gpuSize=0)}this.gpuTexture=new C(this.map.renderer.gpu,null,this.map.core),this.gpuTexture.createFromImage(this.image,2==this.type?"nearest":"linear",!1),this.gpuSize=this.gpuTexture.getSize(),this.stats.gpuTextures+=this.gpuSize,this.stats.graphsFluxTexture[0][0]++,this.stats.graphsFluxTexture[0][1]+=this.gpuSize,this.gpuCacheItem=this.map.gpuCache.insert(this.killGpuTexture.bind(this,!0),this.gpuSize)},F.prototype.buildHeightMap=function(){var e=document.createElement("canvas");e.width=this.image.naturalWidth,e.height=this.image.naturalHeight;var t=e.getContext("2d");t.drawImage(this.image,0,0),this.imageData=t.getImageData(0,0,this.image.naturalWidth,this.image.naturalHeight).data,this.imageExtents=[this.image.naturalWidth,this.image.naturalHeight],this.image=null},F.prototype.getGpuTexture=function(){return this.gpuTexture},F.prototype.getHeightMapValue=function(e,t){return this.imageData?this.imageData[4*(t*this.imageExtents[0]+e)]:0};var P=F,L=P,E=function(e,t,r,i,a,s,n){if(this.map=e,this.stats=e.stats,this.tile=s,this.internal=n,this.mainTexture=s?s.resources.getSubtexture(this,t,r,s,n):new L(e,t,r,s,n),this.maskTexture=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.neverReady=!1,this.maskTexture=null,this.mapLoaderUrl=t,this.type=r||0,this.extraBound=i,this.extraInfo=a,this.statsCounter=0,this.checkStatus=0,this.checkType=null,this.checkValue=null,this.fastHeaderCheck=!1,this.fileSize=0,a&&a.layer){var o=a.layer;if(o.availability)switch(this.checkType=o.availability.type,this.checkType){case 2:this.checkValue=o.availability.mime;break;case 3:this.checkValue=o.availability.codes;break;case 4:this.checkValue=o.availability.size}}};E.prototype.kill=function(){this.mainTexture.killImage(),this.mainTexture.killGpuTexture(),this.mainTexture=null,this.maskTexture&&(this.maskTexture.killImage(),this.maskTexture.killGpuTexture())},E.prototype.killImage=function(){this.mainTexture.killImage(),this.maskTexture&&this.maskTexture.killImage()},E.prototype.killGpuTexture=function(){this.mainTexture.killGpuTexture(),this.maskTexture&&this.maskTexture.killGpuTexture()},E.prototype.setBoundTexture=function(e,t,r){if(e){if(r){if(this.extraBound.sourceTile=e,this.extraBound.hmap=r,!e.hmap){var i=e.resourceSurface.getHMapUrl(e.id,!0);e.hmap=e.resources.getTexture(i,null,null,{tile:e,hmap:r},this.tile,this.internal)}this.extraBound.texture=e.hmap}else if(t){if(this.extraBound.sourceTile=e,this.extraBound.layer=t,!e.boundTextures[t.id]){e.boundLayers[t.id]=t;i=t.getUrl(e.id);e.boundTextures[t.id]=e.resources.getTexture(i,null,null,{tile:e,layer:t},this.tile,this.internal)}this.extraBound.texture=e.boundTextures[t.id]}this.extraBound.transform=this.map.draw.drawTiles.getTileTextureTransform(e,this.extraBound.tile),this.map.markDirty()}},E.prototype.isReady=function(e,t,r){var i,a=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||a,this.neverReady)return!1;if(this.extraBound){if(this.extraBound.texture){for(;this.extraBound.texture.extraBound||-1==this.extraBound.texture.checkStatus;){if(i=this.extraBound.sourceTile.parent,this.extraBound.hmap){if(!i||i.id[0]<1)return this.neverReady=!0,this.extraBound.tile.resetDrawCommands=!0,this.map.markDirty(),!1}else if(this.extraBound.layer&&i.id[0]<this.extraBound.layer.lodRange[0])return this.neverReady=!0,this.extraBound.tile.resetDrawCommands=!0,this.map.markDirty(),!1;this.setBoundTexture(i,this.extraBound.layer)}var s=this.extraBound.texture.isReady(e,t,r);return s&&this.checkMask&&(this.extraBound.tile.resetDrawCommands=null!=this.extraBound.texture.getMaskTexture(),this.checkMask=!1),s}return this.setBoundTexture(this.extraBound.sourceTile,this.extraBound.layer,this.extraBound.hmap),this.isReady(e,t,r)}switch(this.checkType){case 1:if(2!=this.checkStatus){if(0==this.checkStatus&&this.extraInfo&&this.extraInfo.tile){var n=this.extraInfo.tile.boundmetaresources;n||(n=this.map.resourcesTree.findAgregatedNode(this.extraInfo.tile.id,8),this.extraInfo.tile.boundmetaresources=n);var o=this.extraInfo.layer,h=this.extraInfo.metaPath;this.extraInfo.metaPath||(h=o.getMetatileUrl(n.id),this.extraInfo.metaPath=h);var l=n.getTexture(h,!0,null,null,this.tile,this.internal);if(this.maskTexture)this.maskTexture.isReady(e,t,r,this)&&(this.checkStatus=2);else if(l.isReady(e,t,r)){var u=this.extraInfo.tile,d=l.getHeightMapValue(255&u.id[1],255&u.id[2]);this.checkStatus=128&d?2:-1,2==this.checkStatus&&(64&d||(h=o.getMaskUrl(u.id),this.maskTexture=u.resources.getTexture(h,null,null,null,this.tile,this.internal),this.checkStatus=0)),u.resetDrawCommands=!0,this.map.markDirty()}}if(-1==this.checkStatus){if(!this.extraBound){if((i=this.extraInfo.tile.parent).id[0]<this.extraInfo.layer.lodRange[0])return this.neverReady=!0,this.extraInfo.tile.resetDrawCommands=!0,this.map.markDirty(),!1;this.extraBound={tile:this.extraInfo.tile,layer:this.extraInfo.layer},this.setBoundTexture(this.extraBound.tile.parent,this.extraBound.layer),this.checkMask=!0}for(;this.extraBound.texture.extraBound||-1==this.extraBound.texture.checkStatus;){if((i=this.extraBound.sourceTile.parent).id[0]<this.extraBound.layer.lodRange[0])return this.neverReady=!0,this.extraBound.tile.resetDrawCommands=!0,this.map.markDirty(),!1;this.setBoundTexture(i,this.extraBound.layer)}}return!1}}var c=!0;return this.maskTexture&&(c=this.maskTexture.isReady(e,t,r,this)),this.mainTexture.isReady(e,t,r,this)&&c},E.prototype.isMaskPosible=function(){var e=this;return this.extraBound&&this.extraBound.texture&&(e=this.extraBound.texture),1==e.checkType},E.prototype.isMaskInfoReady=function(){var e=this;return this.extraBound&&this.extraBound.texture&&(e=this.extraBound.texture),1!=e.checkType||!(!this.maskTexture&&2!=e.checkStatus&&-1!=e.checkStatus)},E.prototype.getGpuTexture=function(){return this.extraBound?this.extraBound.texture?this.extraBound.texture.getGpuTexture():null:this.mainTexture.getGpuTexture()},E.prototype.getMaskTexture=function(){return this.extraBound&&this.extraBound.texture?this.extraBound.texture.getMaskTexture():this.maskTexture},E.prototype.getGpuMaskTexture=function(){return this.extraBound?this.extraBound.texture&&this.extraBound.texture.maskTexture?this.extraBound.texture.getGpuMaskTexture():null:this.maskTexture?this.maskTexture.getGpuTexture():null},E.prototype.getGpuSize=function(){return(this.mainTexture&&this.mainTexture.gpuSize?this.mainTexture.gpuSize:0)+(this.maskTexture&&this.maskTexture.gpuSize?this.maskTexture.gpuSize:0)},E.prototype.getImageData=function(){return this.mainTexture.imageData},E.prototype.getImageExtents=function(){return this.mainTexture.imageExtents},E.prototype.getHeightMapValue=function(e,t){return this.mainTexture.getHeightMapValue(e,t)},E.prototype.getTransform=function(){return this.extraBound?this.extraBound.texture?this.extraBound.transform:null:[1,1,0,0]};var N=E,B=function(e,t,r,i,a,s){this.min=[],this.max=[],this.min[0]=null!=e?e:Number.POSITIVE_INFINITY,this.min[1]=null!=t?t:Number.POSITIVE_INFINITY,this.min[2]=null!=r?r:Number.POSITIVE_INFINITY,this.max[0]=null!=i?i:Number.NEGATIVE_INFINITY,this.max[1]=null!=a?a:Number.NEGATIVE_INFINITY,this.max[2]=null!=s?s:Number.NEGATIVE_INFINITY,this.updateMaxSize()};B.prototype.clone=function(){return new B(this.min[0],this.min[1],this.min[2],this.max[0],this.max[1],this.max[2])},B.prototype.side=function(e){return this.max[e]-this.min[e]},B.prototype.updateMaxSize=function(){this.maxSize=Math.abs(Math.max(this.max[0]-this.min[0],this.max[1]-this.min[1],this.max[2]-this.min[2]))},B.prototype.center=function(e){return null!=e?(e[0]=.5*(this.min[0]+this.max[0]),e[1]=.5*(this.min[1]+this.max[1]),e):(this.middle||(this.middle=[.5*(this.min[0]+this.max[0]),.5*(this.min[1]+this.max[1]),.5*(this.min[2]+this.max[2])],isNaN(this.middle[0])&&(this.middle[0]=0),isNaN(this.middle[1])&&(this.middle[1]=0),isNaN(this.middle[2])&&(this.middle[2]=0)),this.middle)},B.prototype.translateXY=function(e){return new B(this.min[0]-e[0],this.min[1]-e[1],this.min[2],this.max[0]-e[0],this.max[1]-e[1],this.max[2])};var I=B,k=a.d,R=a.b,_=I,z=p.a,U=s.a,D=function(e,t,r,i){this.metatile=e,this.map=e.map,this.id=t,this.credits=[],this.alien=!1,this.ready=!1,this.heightReady=!1,this.divisionNode=i,this.diskPos=new Array(3),this.diskDistance=1,this.diskNormal=new Array(3),this.diskAngle=1,this.diskAngle2=1,this.diskAngle2A=1,this.bbox2=new Array(24),r&&this.parseMetanode(r)};D.prototype.kill=function(){},D.prototype.hasChild=function(e){return 0!=(this.flags&1<<e+4)},D.prototype.hasChildById=function(e){var t=e[1]-(this.id[1]<<1),r=e[2]-(this.id[2]<<1);return this.hasChild((r<<1)+t)},D.prototype.hasChildren=function(){return 0!=(240&this.flags)},D.prototype.parseExtentBits=function(e,t,r){for(var i=0,a=0,s=t;a<s;a++){var n=7&r;e[r>>3]&1<<7-n&&(i|=1<<s-a-1),r++}return i/=(1<<s)-1},D.prototype.hasGeometry=function(){return 0!=(1&this.flags)},D.prototype.hasNavtile=function(){return 0!=(2&this.flags)},D.prototype.usedTexelSize=function(){return 0!=(4&this.flags)},D.prototype.usedDisplaySize=function(){return 0!=(8&this.flags)},D.prototype.parseMetanode=function(e){var t=e.data,r=this.metatile.version;if(this.flags=t.getUint8(e.index,!0),e.index+=1,r<5){for(var i=6*(this.id[0]+2)+7>>3,a=this.map.metanodeBuffer,s=0,n=i;s<n;s++)a[s]=t.getUint8(e.index,!0),e.index+=1;var o=this.id[0]+2,h=[0,0,0],l=[0,0,0],u=0,d=this.map.spaceExtentSize,c=this.map.spaceExtentOffset;for(s=0;s<3;s++)h[s]=this.parseExtentBits(a,o,u)*d[s]+c[s],u+=o,l[s]=this.parseExtentBits(a,o,u)*d[s]+c[s],u+=o;var p=0;for(s=0,n=a.length;s<n;s++)p+=a[s];0==p&&(h[0]=Number.POSITIVE_INFINITY,h[1]=Number.POSITIVE_INFINITY,h[2]=Number.POSITIVE_INFINITY,l[0]=Number.NEGATIVE_INFINITY,l[1]=Number.NEGATIVE_INFINITY,l[2]=Number.NEGATIVE_INFINITY),this.bbox=new _(h[0],h[1],h[2],l[0],l[1],l[2])}r>=4&&(this.minZ=t.getFloat32(e.index,!0),e.index+=4,this.maxZ=t.getFloat32(e.index,!0),e.index+=4,this.surrogatez=t.getFloat32(e.index,!0),e.index+=4),this.internalTextureCount=t.getUint8(e.index,!0),e.index+=1,this.pixelSize=U.decodeFloat16(t.getUint16(e.index,!0)),e.index+=2,this.displaySize=t.getUint16(e.index,!0),e.index+=2,this.displaySize=this.metatile.surface.displaySize,0==(4&this.flags)&&(this.pixelSize=Number.POSITIVE_INFINITY),0==(8&this.flags)&&(this.displaySize=256),this.minHeight=t.getInt16(e.index,!0),e.index+=2,this.maxHeight=t.getInt16(e.index,!0),e.index+=2,r<4&&(this.minZ=this.minHeight,this.maxZ=this.maxHeight,this.surrogatez=this.minHeight),this.minZ2=this.minZ,this.maxZ2=this.maxZ,this.metatile.version>=3&&(128&this.metatile.flags?(this.sourceReference=t.getUint16(e.index,!0),e.index+=2):64&this.metatile.flags&&(this.sourceReference=t.getUint8(e.index,!0),e.index+=1)),this.heightReady=this.hasNavtile(),this.alien=!1,this.generateCullingHelpers()},D.prototype.clone=function(){var e=new D(this.metatile,this.id);e.flags=this.flags,e.minHeight=this.minHeight,e.maxHeight=this.maxHeight,e.minZ=this.minZ,e.maxZ=this.maxZ,e.minZ2=this.minZ2,e.maxZ2=this.maxZ2,e.llx=this.llx,e.lly=this.lly,e.urx=this.urx,e.ury=this.ury,e.surrogatez=this.surrogatez,e.internalTextureCount=this.internalTextureCount,e.pixelSize=this.pixelSize,e.displaySize=this.displaySize,e.ready=this.ready,e.stream=this.stream,e.heightReady=this.heightReady,e.credits=new Array(this.credits.length);for(var t=0,r=this.credits.length;t<r;t++)e.credits[t]=this.credits[t];return this.bbox&&(e.bbox=this.bbox.clone()),e.diskPos=this.diskPos,e.diskNormal=this.diskNormal,e.diskAngle=this.diskAngle,e.diskAngle2=this.diskAngle2,e.diskAngle2A=this.diskAngle2A,e.diskDistance=this.diskDistance,e.bbox2=this.bbox2,e.divisionNode=this.divisionNode,this.plane&&(e.plane=this.plane.slice()),e},D.prototype.generateCullingHelpers=function(e){this.ready=!0;var t=this.map,r=t.draw,i=t.isGeocent,a=this.metatile.useVersion;if(!(this.id[0]<t.measure.minDivisionNodeDepth||!i&&a<4)&&(t.config.mapPreciseCulling||a>=4)){if(e)return;var s,n,o,h,l,u=r.tmpVec3;if(this.id[0]>t.measure.maxDivisionNodeDepth){var d=r.tmpVec5;if(!(s=t.measure.getSpatialDivisionNodeFromId(this.id)))return;t.measure.getSpatialDivisionNodeAndExtents2(this.id,d,s),n=d[1],o=d[2],h=d[3],l=d[4],this.divisionNode=s}else{var c=t.measure.getSpatialDivisionNodeAndExtents(this.id);if(!(s=c?c[0]:null))return;n=c[1][0][0],o=c[1][0][1],h=c[1][1][0],l=c[1][1][1],this.divisionNode=s}this.llx=n,this.lly=o,this.urx=h,this.ury=l;var p=this.minZ;u[0]=.5*(h+n),u[1]=.5*(l+o),u[2]=p,s.getPhysicalCoordsFast(u,!0,this.diskPos,0,0),i?(this.diskDistance=k.length(this.diskPos),k.normalize(this.diskPos,this.diskNormal)):(this.diskNormal[0]=0,this.diskNormal[1]=0,this.diskNormal[2]=1);var f=this.diskNormal;u[0]=h,u[1]=l,u[2]=p;var m,g,v=this.bbox2;if(s.getPhysicalCoordsFast(u,!0,v,0,0),u[1]=o,s.getPhysicalCoordsFast(u,!0,v,0,3),u[0]=n,s.getPhysicalCoordsFast(u,!0,v,0,6),u[1]=l,s.getPhysicalCoordsFast(u,!0,v,0,9),!i)return m=this.maxZ-p,v[12]=v[0],v[13]=v[1],v[14]=v[2]+m,v[15]=v[3],v[16]=v[4],v[17]=v[5]+m,v[18]=v[6],v[19]=v[7],v[20]=v[8]+m,v[21]=v[9],v[22]=v[10],void(v[23]=v[11]+m);var y,b,x,S,M,w=k.dot;if(t.config.mapPreciseBBoxTest||a>=4)if(m=this.maxZ-p,this.id[0]<=3){(g=k.normalize2)(v,0,u),y=w(f,u),g(v,3,u),b=w(f,u),g(v,6,u),x=w(f,u),g(v,9,u),S=w(f,u),M=Math.min(y,b,x,S),u[0]=.5*(h+n),u[1]=l,u[2]=p,s.getPhysicalCoordsFast(u,!0,v,0,12),u[1]=o,s.getPhysicalCoordsFast(u,!0,v,0,15),u[0]=h,u[1]=.5*(l+o),s.getPhysicalCoordsFast(u,!0,v,0,18),u[0]=n,s.getPhysicalCoordsFast(u,!0,v,0,21);var T=this.diskPos,A=Math.max(v[0],v[3],v[6],v[9],v[12],v[15],v[18],v[21],T[0]),C=Math.min(v[0],v[3],v[6],v[9],v[12],v[15],v[18],v[21],T[0]),F=Math.max(v[1],v[4],v[7],v[10],v[13],v[16],v[19],v[22],T[1]),P=Math.min(v[1],v[4],v[7],v[10],v[13],v[16],v[19],v[22],T[1]),L=Math.max(v[2],v[5],v[8],v[11],v[14],v[17],v[20],v[23],T[2]),E=Math.min(v[2],v[5],v[8],v[11],v[14],v[17],v[20],v[23],T[2]);this.id[0]<=1&&(u[0]=h+.25*(n-h),u[1]=.5*(l+o),s.getPhysicalCoordsFast(u,!0,v,0,12),u[0]=h+.75*(n-h),s.getPhysicalCoordsFast(u,!0,v,0,15),u[0]=.5*(h+n),u[1]=l+.25*(o-l),s.getPhysicalCoordsFast(u,!0,v,0,18),u[1]=l+.75*(o-l),s.getPhysicalCoordsFast(u,!0,v,0,21),A=Math.max(A,v[12],v[15],v[18],v[21]),C=Math.min(C,v[12],v[15],v[18],v[21]),F=Math.max(F,v[13],v[16],v[19],v[22]),P=Math.min(P,v[13],v[16],v[19],v[22]),L=Math.max(L,v[14],v[17],v[20],v[23]),E=Math.min(E,v[14],v[17],v[20],v[23]),M=-1),v[0]=C,v[1]=P,v[2]=E,v[3]=A,v[4]=P,v[5]=E,v[6]=A,v[7]=F,v[8]=E,v[9]=C,v[10]=F,v[11]=E,v[12]=C,v[13]=P,v[14]=L,v[15]=A,v[16]=P,v[17]=L,v[18]=A,v[19]=F,v[20]=L,v[21]=C,v[22]=F,v[23]=L}else{if(g=k.normalize3,w=k.dot2,g(v,0,v,12),y=w(f,v,12),g(v,3,v,15),b=w(f,v,15),g(v,6,v,18),x=w(f,v,18),g(v,9,v,21),S=w(f,v,21),M=Math.min(y,b,x,S),this.id[0]<=8){u=this.diskPos;var N=.024*(5-(this.id[0]-4));v[0]+=(v[0]-u[0])*N,v[1]+=(v[1]-u[1])*N,v[2]+=(v[2]-u[2])*N,v[3]+=(v[3]-u[0])*N,v[4]+=(v[4]-u[1])*N,v[5]+=(v[5]-u[2])*N,v[6]+=(v[6]-u[0])*N,v[7]+=(v[7]-u[1])*N,v[8]+=(v[8]-u[2])*N,v[9]+=(v[9]-u[0])*N,v[10]+=(v[10]-u[1])*N,v[11]+=(v[11]-u[2])*N}m+=r.planetRadius-r.planetRadius*M,v[12]=v[0]+v[12]*m,v[13]=v[1]+v[13]*m,v[14]=v[2]+v[14]*m,v[15]=v[3]+v[15]*m,v[16]=v[4]+v[16]*m,v[17]=v[5]+v[17]*m,v[18]=v[6]+v[18]*m,v[19]=v[7]+v[19]*m,v[20]=v[8]+v[20]*m,v[21]=v[9]+v[21]*m,v[22]=v[10]+v[22]*m,v[23]=v[11]+v[23]*m}else(g=k.normalize2)(v,0,u),y=w(f,u),g(v,3,u),b=w(f,u),g(v,6,u),x=w(f,u),g(v,9,u),S=w(f,u),M=Math.min(y,b,x,S);this.diskAngle=Math.cos(Math.max(0,.5*Math.PI-Math.acos(M))),this.diskAngle2=M,this.diskAngle2A=Math.acos(M)}},D.prototype.getWorldMatrix=function(e,t){var r=t;return null!=r?(r[0]=this.bbox.side(0),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=this.bbox.side(1),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=this.bbox.side(2),r[11]=0,r[12]=this.bbox.min[0]-e[0],r[13]=this.bbox.min[1]-e[1],r[14]=this.bbox.min[2]-e[2],r[15]=1):(r=R.create(),R.multiply(z.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),z.scaleMatrix(this.bbox.side(0),this.bbox.side(1),this.bbox.side(2)),r)),r},D.prototype.drawBBox=function(e){if(this.metatile.useVersion>=4)return this.drawBBox2(e);var t=this.map.renderer;t.gpu.useProgram(t.progBBox,["aPosition"]);var r=R.create(),i=R.create();R.multiply(t.camera.getModelviewMatrix(),this.getWorldMatrix(e),i);var a=t.camera.getProjectionMatrix();R.multiply(a,i,r),t.progBBox.setMat4("uMVP",r),t.bboxMesh.draw(t.progBBox,"aPosition")},D.prototype.drawBBox2=function(){for(var e=this.bbox2,t=this.map.draw.bboxBuffer,r=this.map.camera.position,i=this.map.renderer,a=i.progBBox2,s=0;s<24;s+=3)t[s]=e[s]-r[0],t[s+1]=e[s+1]-r[1],t[s+2]=e[s+2]-r[2];i.gpu.useProgram(a,["aPosition"]),a.setFloatArray("uPoints",t);var n=i.camera.getMvpMatrix();a.setMat4("uMVP",n),i.bboxMesh2.draw(a,"aPosition")},D.prototype.drawPlane=function(e,t){var r=this.map.renderer,i=this.map.draw.planeBuffer,a=this.plane;if(a){r.gpu.useProgram(r.progPlane,["aPosition","aTexCoord"]);var s=R.create(),n=r.camera.getModelviewMatrix(),o=r.camera.getProjectionMatrix();R.multiply(o,n,s);for(var h=e[0],l=e[1],u=e[2],d=0;d<9;d++){var c=3*d;i[c]=a[c]-h,i[c+1]=a[c+1]-l,i[c+2]=a[c+2]-u}var p=r.progPlane;p.setMat4("uMV",n),p.setMat4("uProj",o),p.setFloatArray("uPoints",i);var f=Math.max(10,t.distance+20),m=Math.log(f)/Math.log(8),g=m-Math.floor(m);p.setVec4("uParams",[4,0,1/15,8]),p.setVec4("uParams2",[0,0,g,0]),r.gpu.bindTexture(r.heightmapTexture),r.planeMesh.draw(r.progPlane,"aPosition","aTexCoord")}},D.prototype.getGridHeight=function(e,t,r){var i=e[0]-this.llx,a=e[1]-this.lly,s=r-1,n=r-1;(i=s*(i/(this.urx-this.llx)))<0&&(i=0),(a=n*(a/(this.ury-this.lly)))<0&&(a=0),i>s&&(i=s),a>n&&(a=n);var o=Math.floor(i),h=Math.floor(a),l=i-o,u=a-h,d=h*r,c=h==n?d:d+r,p=o==s?o:o+1,f=t[d+o],m=t[d+p],g=t[c+o],v=f+(m-f)*l;return v+(g+(t[c+p]-g)*l-v)*u};var O=D,V=(s.a,O),G=function(e,t,r){this.metaresources=e,this.map=e.map,this.surface=t,this.id=e.id,this.tile=r,this.nodes=[],this.drawCounter=0,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.size=0,this.cacheItem=null};G.prototype.kill=function(e){!0!==e&&null!=this.cacheItem&&this.map.metatileCache.remove(this.cacheItem),this.metaresources&&this.metaresources.removeMetatile(this),this.loadState=0,this.surface=0,this.cacheItem=null,this.nodes=[]},G.prototype.clone=function(e){var t=new G(this.metaresources,e);return t.nodes=this.nodes,t.loadState=this.loadState,t.nodes=this.nodes,t.size=this.size,t.lod=this.lod,t.metatileIdx=this.metatileIdx,t.metatileIdy=this.metatileIdy,t.offsetx=this.offsetx,t.offsety=this.offsety,t.sizex=this.sizex,t.sizey=this.sizey,t.version=this.version,t.credits=this.credits,this.version<2?t.nodeSize=this.nodeSize:(t.flags=this.flags,t.creditCount=this.creditCount,t.flagPlanes=this.flagPlanes),t.cacheItem=this.map.metatileCache.insert(t.kill.bind(t,!0),t.size),t},G.prototype.isReady=function(e){return 2==this.loadState||(0==this.loadState&&(3==this.loadState?this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(e):this.scheduleLoad(e)),!1)},G.prototype.used=function(){null!=this.cacheItem&&this.map.metatileCache.updateItem(this.cacheItem)},G.prototype.getNode=function(e){var t=e[1]-this.id[1]-this.offsetx,r=e[2]-this.id[2]-this.offsety;if(t<0||r<0||t>=this.sizex||r>=this.sizey)return null;var i=this.nodes[this.sizex*r+t];if(!i){var a=this.sizex*r+t,s={data:this.data,index:this.metanodesIndex+a*this.metanodeSize};i=new V(this,[this.lod,this.metatileIdx+this.offsetx+t,this.metatileIdy+this.offsety+r],s,this.divisionNode),this.nodes[a]=i,this.applyMetanodeCredits(t,r),this.applyMetatanodeBitplanes(t,r)}return i},G.prototype.scheduleLoad=function(){null==this.mapLoaderUrl&&(this.mapLoaderUrl=this.surface.getMetaUrl(this.id)),this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),null,this.tile,"metatile")},G.prototype.onLoad=function(e,t,r){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=r,this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"metadata"),this.loadState=1},G.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},G.prototype.onLoaded=function(e,t){if(!this.map.killed){if(!t)return this.map.markDirty(),void this.map.addProcessingTask(this.onLoaded.bind(this,e,!0));e=new DataView(e),this.size+=4*e.byteLength,this.data=e;var r=performance.now();this.parseMetatatile({data:e,index:0}),this.map.stats.renderBuild+=performance.now()-r,this.cacheItem=this.map.metatileCache.insert(this.kill.bind(this,!0),this.size),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},G.prototype.parseMetatatile=function(e){var t=e.data,r="";r+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,r+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,"MT"==r&&(this.version=t.getUint16(e.index,!0),e.index+=2,this.version>5||(this.lod=t.getUint8(e.index,!0),e.index+=1,this.metatileIdx=t.getUint32(e.index,!0),e.index+=4,this.metatileIdy=t.getUint32(e.index,!0),e.index+=4,this.offsetx=t.getUint16(e.index,!0),e.index+=2,this.offsety=t.getUint16(e.index,!0),e.index+=2,this.sizex=t.getUint16(e.index,!0),e.index+=2,this.sizey=t.getUint16(e.index,!0),e.index+=2,this.flagPlanes=new Array(8),this.version<2?(this.nodeSize=t.getUint8(e.index,!0),e.index+=1):(this.flags=t.getUint8(e.index,!0),e.index+=1,this.creditCount=t.getUint8(e.index,!0),e.index+=1,this.parseFlagPlanes(e)),this.parseMetatatileCredits(e),this.parseMetatatileNodes(e),this.useVersion=this.map.config.mapForceMetatileV3&&this.version<5?3:this.version))},G.prototype.parseFlagPlanes=function(e){for(var t=e.data,r=this.sizex*this.sizey+7>>3,i=0;i<6;i++)if(0!=(this.flags&1<<i)){for(var a=new Uint8Array(r),s=0;s<r;s++)a[s]=t.getUint8(e.index,!0),e.index+=1;this.flagPlanes[i]=a}},G.prototype.parseMetatatileCredits=function(e){var t=e.data;if(this.version<2&&(this.creditCount=t.getUint8(e.index,!0),e.index+=1,this.creditSize=t.getUint16(e.index,!0),e.index+=2),0!=this.creditCount){var r=this.sizex*this.sizey+7>>3;this.credits=new Array(this.creditCount);for(var i=0,a=this.credits.length;i<a;i++){var s=t.getUint16(e.index,!0);e.index+=2;for(var n=new Uint8Array(r),o=0;o<r;o++)n[o]=t.getUint8(e.index,!0),e.index+=1;var h=this.map.getCreditByNumber(s),l=h?h.key:null;this.credits[i]={creditId:l,creditMask:n}}}else this.credits=[]},G.prototype.applyMetatatileBitplanes=function(){for(var e=0;e<1;e++)if(this.flagPlanes[e])for(var t=this.flagPlanes[e],r=0;r<this.sizey;r++)for(var i=0;i<this.sizex;i++){var a=this.sizex*r+i,s=1<<(7&a);if(t[a>>=3]&s)switch(e){case 0:this.nodes[r*this.sizex+i].alien=!0}}},G.prototype.applyMetatanodeBitplanes=function(e,t){for(var r=0;r<1;r++)if(this.flagPlanes[r]){var i=this.flagPlanes[r],a=this.sizex*t+e,s=1<<(7&a);if(i[a>>=3]&s)switch(r){case 0:this.nodes[t*this.sizex+e].alien=!0}}},G.prototype.applyMetatatileCredits=function(){for(var e=0;e<this.sizey;e++)for(var t=0;t<this.sizex;t++){var r=this.sizex*e+t,i=1<<(7&r);r>>=3;for(var a=0,s=this.credits.length;a<s;a++)if(this.credits[a].creditMask[r]&i){var n=this.credits[a].creditId;n&&this.nodes[e*this.sizex+t].credits.push(n)}}},G.prototype.applyMetanodeCredits=function(e,t){var r=this.sizex*t+e,i=1<<(7&r);r>>=3;for(var a=0,s=this.credits.length;a<s;a++)if(this.credits[a].creditMask[r]&i){var n=this.credits[a].creditId;n&&this.nodes[t*this.sizex+e].credits.push(n)}},G.prototype.parseMetatatileNodes=function(e){this.metanodesIndex=e.index,this.metanodeSize=10,this.version>=5?this.metanodeSize+=12:(this.metanodeSize+=Math.floor((6*(this.id[0]+2)+7)/8),4==this.version&&(this.metanodeSize+=12)),this.version>=3&&(128&this.flags?this.metanodeSize+=2:64&this.flags&&(this.metanodeSize+=1)),this.lod>=this.map.measure.minDivisionNodeDepth?(this.divisionNode=this.map.measure.getSpatialDivisionNodeAndExtents([this.lod,this.metatileIdx+this.offsetx,this.metatileIdy+this.offsety]),this.divisionNode&&(this.divisionNode=this.divisionNode[0])):this.divisionNode=null,this.nodes=new Array(this.sizex*this.sizey)};var j=G,H=function(e,t,r,i,a,s,n){this.gpu=e,this.gl=e.gl,this.bbox=t.bbox,this.fileSize=r,this.core=i,this.vertexBuffer=null,this.uvBuffer=null,this.uv2Buffer=null,this.use16bit=!!s,this.verticesUnnormalized=!!n,this.size=0;var o=t.vertices,h=t.uvs,l=t.uvs2,u=t.indices,d=t.vertexSize||3,c=t.uvSize||2,p=t.uv2Size||2,f=this.gl;if(o&&f){this.vertexBuffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.vertexBuffer),f.bufferData(f.ARRAY_BUFFER,a?o:new Float32Array(o),f.STATIC_DRAW),this.vertexBuffer.itemSize=d,this.vertexBuffer.numItems=o.length/d,null!=h&&(this.uvBuffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.uvBuffer),f.bufferData(f.ARRAY_BUFFER,a?h:new Float32Array(h),f.STATIC_DRAW),this.uvBuffer.itemSize=c,this.uvBuffer.numItems=h.length/c),null!=l&&(this.uv2Buffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.uv2Buffer),f.bufferData(f.ARRAY_BUFFER,a?l:new Float32Array(l),f.STATIC_DRAW),this.uv2Buffer.itemSize=p,this.uv2Buffer.numItems=l.length/p),null!=u&&(this.indexBuffer=f.createBuffer(),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this.indexBuffer),f.bufferData(f.ELEMENT_ARRAY_BUFFER,a?u:new Uint16Array(u),f.STATIC_DRAW),this.indexBuffer.itemSize=1,this.indexBuffer.numItems=u.length);var m=this.use16bit?2:4;this.size=this.vertexBuffer.numItems*d*m,this.size+=h?this.uvBuffer.numItems*c*m:0,this.size+=l?this.uv2Buffer.numItems*p*m:0,this.size+=u?2*u.length:0,this.polygons=u?u.length/3:this.vertexBuffer.numItems/3,this.valid=!0}};H.prototype.kill=function(){this.gl&&this.valid&&(this.vertexBuffer&&this.gl.deleteBuffer(this.vertexBuffer),this.uvBuffer&&this.gl.deleteBuffer(this.uvBuffer),this.uv2Buffer&&this.gl.deleteBuffer(this.uv2Buffer),this.indexBuffer&&this.gl.deleteBuffer(this.indexBuffer),this.vertexBuffer=null,this.uvBuffer=null,this.uv2Buffer=null,this.indexBuffer=null)},H.prototype.draw=function(e,t,r,i,a,s){var n=this.gl;if(null!=n&&this.valid){if(this.use16bit){var o=e.getAttribute(t);if(n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.vertexAttribPointer(o,this.vertexBuffer.itemSize,n.UNSIGNED_SHORT,!this.verticesUnnormalized,0,0),this.uvBuffer&&r){var h=e.getAttribute(r);n.bindBuffer(n.ARRAY_BUFFER,this.uvBuffer),n.vertexAttribPointer(h,this.uvBuffer.itemSize,n.UNSIGNED_SHORT,!0,0,0)}if(this.uv2Buffer&&i){var l=e.getAttribute(i);n.bindBuffer(n.ARRAY_BUFFER,this.uv2Buffer),n.vertexAttribPointer(l,this.uv2Buffer.itemSize,n.UNSIGNED_SHORT,!0,0,0)}}else{o=e.getAttribute(t);if(n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.vertexAttribPointer(o,this.vertexBuffer.itemSize,n.FLOAT,!1,0,0),this.uvBuffer&&r){h=e.getAttribute(r);n.bindBuffer(n.ARRAY_BUFFER,this.uvBuffer),n.vertexAttribPointer(h,this.uvBuffer.itemSize,n.FLOAT,!1,0,0)}if(this.uv2Buffer&&i){l=e.getAttribute(i);n.bindBuffer(n.ARRAY_BUFFER,this.uv2Buffer),n.vertexAttribPointer(l,this.uv2Buffer.itemSize,n.FLOAT,!1,0,0)}}if(a&&a){var u=e.getAttribute(a);-1!=u&&(n.bindBuffer(n.ARRAY_BUFFER,this.gpu.barycentricBuffer),n.vertexAttribPointer(u,this.gpu.barycentricBuffer.itemSize,n.FLOAT,!1,0,0))}this.indexBuffer?(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer),s||n.drawElements(n.TRIANGLES,this.indexBuffer.numItems,n.UNSIGNED_SHORT,0)):s||n.drawArrays(n.TRIANGLES,0,this.vertexBuffer.numItems)}},H.prototype.getSize=function(){return this.size},H.prototype.getBBox=function(){return this.bbox},H.prototype.getPolygons=function(){return this.polygons};var q=H,W=a.b,J=p.a,Z=q,Y=I,K=function(e,t){this.generateLines=!0,this.map=e.map,this.vertices=null,this.internalUVs=null,this.externalUVs=null,this.indices=null,this.mesh=e,this.statsCounter=0,this.valid=!0,this.killed=!1,this.use16bit=e.use16bit,this.texture=null,this.bbox=new Y,this.size=0,this.faces=0,this.uvArea=0,this.uvAreaComputed=!1,this.flagsInternalTexcoords=1,this.flagsExternalTexcoords=2,this.flagsPerVertexUndulation=4,this.flagsTextureMode=8,t&&this.parseSubmesh(t)};K.prototype.kill=function(){this.killed=!0,this.vertices=null,this.internalUVs=null,this.externalUVs=null,this.indices=null,this.texture&&(this.texture.kill(),this.texture=null)},K.prototype.parseSubmesh=function(e){this.parseHeader(e),this.mesh.version>=3?this.parseVerticesAndFaces2(e):this.parseVerticesAndFaces(e)},K.prototype.parseHeader=function(e){var t=e.data;this.flags=t.getUint8(e.index,!0),e.index+=1,this.mesh.version>1?(this.surfaceReference=t.getUint8(e.index,!0),e.index+=1):this.surfaceReference=0,this.textureLayer=t.getUint16(e.index,!0),e.index+=2,this.textureLayer2=this.textureLayer;var r=this.bbox.min,i=this.bbox.max;r[0]=t.getFloat64(e.index,!0),e.index+=8,r[1]=t.getFloat64(e.index,!0),e.index+=8,r[2]=t.getFloat64(e.index,!0),e.index+=8,i[0]=t.getFloat64(e.index,!0),e.index+=8,i[1]=t.getFloat64(e.index,!0),e.index+=8,i[2]=t.getFloat64(e.index,!0),e.index+=8,this.bbox.updateMaxSize()},K.prototype.parseVerticesAndFaces=function(e){var t=e.data,r=e.index,i=e.uint8Data,a=t.getUint16(r,!0);r+=2,a||(this.valid=!1);var s=null,n=null,o=this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,h=this.use16bit?new Uint16Array(3*a):new Float32Array(3*a);this.flags&this.flagsExternalTexcoords&&(n=!!o||(this.use16bit?new Uint16Array(2*a):new Float32Array(2*a)));var l,u,d=this.use16bit?1:1/65535,c=0,p=0;for(l=0;l<a;l++)h[c]=(i[r]+(i[r+1]<<8))*d,h[c+1]=(i[r+2]+(i[r+3]<<8))*d,h[c+2]=(i[r+4]+(i[r+5]<<8))*d,c+=3,n?(o||(n[p]=(i[r+6]+(i[r+7]<<8))*d,n[p+1]=(65535-(i[r+8]+(i[r+9]<<8)))*d,p+=2),r+=10):r+=6;if(this.tmpVertices=h,this.tmpExternalUVs=n,this.flags&this.flagsInternalTexcoords){var f=t.getUint16(r,!0);for(r+=2,s=this.use16bit?new Uint16Array(2*f):new Float32Array(2*f),l=0,u=2*f;l<u;l+=2)s[l]=(i[r]+(i[r+1]<<8))*d,s[l+1]=(65535-(i[r+2]+(i[r+3]<<8)))*d,r+=4;this.tmpInternalUVs=s}var m=t.getUint16(r,!0);r+=2;var g=null;s=null,n=null;var v=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&!(this.flags&this.flagsInternalTexcoords),y=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,b=v||y;b?g=new Uint16Array(3*m):(h=this.use16bit?new Uint16Array(3*m*3):new Float32Array(3*m*3),this.flags&this.flagsInternalTexcoords&&(s=this.use16bit?new Uint16Array(3*m*2):new Float32Array(3*m*2)),!o&&this.flags&this.flagsExternalTexcoords&&(n=this.use16bit?new Uint16Array(3*m*2):new Float32Array(3*m*2)));var x,S,M,w,T,A,C,F=this.tmpVertices,P=this.tmpExternalUVs,L=this.tmpInternalUVs;for(v&&(h=this.tmpVertices,n=this.tmpExternalUVs),y&&(h=this.use16bit?new Uint16Array(L.length/2*3):new Float32Array(L.length/2*3),s=this.tmpInternalUVs),l=0;l<m;l++)x=i[r]+(i[r+1]<<8),S=i[r+2]+(i[r+3]<<8),M=i[r+4]+(i[r+5]<<8),b?(c=3*l,null!=s?(w=i[r+6]+(i[r+7]<<8),T=i[r+8]+(i[r+9]<<8),A=i[r+10]+(i[r+11]<<8),h[3*w]=F[3*x],h[3*w+1]=F[3*x+1],h[3*w+2]=F[3*x+2],h[3*T]=F[3*S],h[3*T+1]=F[3*S+1],h[3*T+2]=F[3*S+2],h[3*A]=F[3*M],h[3*A+1]=F[3*M+1],h[3*A+2]=F[3*M+2],g[c]=w,g[c+1]=T,g[c+2]=A,r+=12):(g[c]=x,g[c+1]=S,g[c+2]=M,r+=6)):(C=3*x,h[c=9*l]=F[C],h[c+1]=F[C+1],h[c+2]=F[C+2],C=3*S,h[c+3]=F[C],h[c+4]=F[C+1],h[c+5]=F[C+2],C=3*M,h[c+6]=F[C],h[c+7]=F[C+1],h[c+8]=F[C+2],null!=n&&(n[c=6*l]=P[2*x],n[c+1]=P[2*x+1],n[c+2]=P[2*S],n[c+3]=P[2*S+1],n[c+4]=P[2*M],n[c+5]=P[2*M+1]),null!=s?(x=i[r+6]+(i[r+7]<<8),S=i[r+8]+(i[r+9]<<8),M=i[r+10]+(i[r+11]<<8),r+=12,s[c=6*l]=L[2*x],s[c+1]=L[2*x+1],s[c+2]=L[2*S],s[c+3]=L[2*S+1],s[c+4]=L[2*M],s[c+5]=L[2*M+1]):r+=6);this.vertices=h,this.internalUVs=s,this.externalUVs=n,this.indices=g,this.tmpVertices=null,this.tmpInternalUVs=null,this.tmpExternalUVs=null,e.index=r,this.size=this.vertices.byteLength,this.internalUVs&&(this.size+=this.internalUVs.byteLength),this.externalUVs&&(this.size+=this.externalUVs.byteLength),this.indices&&(this.size+=this.indices.byteLength),this.faces=m},K.prototype.parseWord=function(e,t){var r=e[t[1]];128&r?(t[0]=127&r|e[t[1]+1]<<7,t[1]+=2):(t[0]=r,t[1]++)},K.prototype.parseDelta=function(e,t){var r=e[t[1]];128&r?1&(r=127&r|e[t[1]+1]<<7)?(t[0]=-(1+(r>>1)),t[1]+=2):(t[0]=r>>1,t[1]+=2):1&r?(t[0]=-(1+(r>>1)),t[1]++):(t[0]=r>>1,t[1]++)},K.prototype.parseVerticesAndFaces2=function(e){var t=e.data,r=e.index,i=e.uint8Data,a=this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,s=t.getUint16(r,!0);r+=2;var n=t.getUint16(r,!0);r+=2,s||(this.valid=!1);var o,h,l,u,d=this.bbox.center(),c=this.bbox.maxSize,p=1/n,f=null,m=this.use16bit?new Uint16Array(3*s):new Float32Array(3*s),g=0,v=0,y=0,b=d[0],x=d[1],S=d[2],M=this.bbox.min[0],w=this.bbox.min[1],T=this.bbox.min[2],A=1/(this.bbox.max[0]-this.bbox.min[0]),C=1/(this.bbox.max[1]-this.bbox.min[1]),F=1/(this.bbox.max[2]-this.bbox.min[2]),P=[0,r];if(this.use16bit)for(h=0;h<s;h++)this.parseDelta(i,P),g+=P[0],this.parseDelta(i,P),v+=P[0],this.parseDelta(i,P),y+=P[0],(u=(g*p*c+b-M)*A)<0&&(u=0),u>1&&(u=1),m[o=3*h]=65535*u,(u=(v*p*c+x-w)*C)<0&&(u=0),u>1&&(u=1),m[o+1]=65535*u,(u=(y*p*c+S-T)*F)<0&&(u=0),u>1&&(u=1),m[o+2]=65535*u;else for(h=0;h<s;h++)this.parseDelta(i,P),g+=P[0],this.parseDelta(i,P),v+=P[0],this.parseDelta(i,P),y+=P[0],m[o=3*h]=(g*p*c+b-M)*A,m[o+1]=(v*p*c+x-w)*C,m[o+2]=(y*p*c+S-T)*F;if(r=P[1],this.flags&this.flagsExternalTexcoords)if(n=t.getUint16(r,!0),r+=2,P[1]=r,a)for(h=0;h<s;h++)this.parseDelta(i,P),this.parseDelta(i,P);else if(p=this.use16bit?65535/n:1/n,f=this.use16bit?new Uint16Array(2*s):new Float32Array(2*s),g=0,v=0,this.use16bit)for(h=0;h<s;h++){this.parseDelta(i,P),g+=P[0],this.parseDelta(i,P),v+=P[0],(u=g*p)<0&&(u=0),u>65535&&(u=65535),f[L=2*h]=u,(u=v*p)<0&&(u=0),u>65535&&(u=65535),f[L+1]=65535-u}else for(h=0;h<s;h++){var L;this.parseDelta(i,P),g+=P[0],this.parseDelta(i,P),v+=P[0],f[L=2*h]=g*p,f[L+1]=1-v*p}if(r=P[1],this.tmpVertices=m,this.tmpExternalUVs=f,this.flags&this.flagsInternalTexcoords){var E=t.getUint16(r,!0);r+=2;var N=t.getUint16(r,!0);r+=2;var B=t.getUint16(r,!0);r+=2;var I=this.use16bit?65536/N:1/N,k=this.use16bit?65536/B:1/B;g=0,v=0;var R=this.use16bit?new Uint16Array(2*E):new Float32Array(2*E);if(P[1]=r,this.use16bit)for(h=0,l=2*E;h<l;h+=2)this.parseDelta(i,P),g+=P[0],this.parseDelta(i,P),v+=P[0],(u=g*I)<0&&(u=0),u>65535&&(u=65535),R[h]=u,(u=v*k)<0&&(u=0),u>65535&&(u=65535),R[h+1]=65535-u;else for(h=0,l=2*E;h<l;h+=2)this.parseDelta(i,P),g+=P[0],this.parseDelta(i,P),v+=P[0],R[h]=g*I,R[h+1]=1-v*k;r=P[1],this.tmpInternalUVs=R}var _=t.getUint16(r,!0);r+=2;var z=null;R=null,f=null;var U=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&!(this.flags&this.flagsInternalTexcoords),D=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,O=U||D;O?z=new Uint16Array(3*_):(m=this.use16bit?new Uint16Array(3*_*3):new Float32Array(3*_*3),this.flags&this.flagsInternalTexcoords&&(R=this.use16bit?new Uint16Array(3*_*2):new Float32Array(3*_*2)),!a&&this.flags&this.flagsExternalTexcoords&&(f=this.use16bit?new Uint16Array(3*_*2):new Float32Array(3*_*2)));var V,G,j,H,q,W,J=this.tmpVertices,Z=this.tmpExternalUVs,Y=this.tmpInternalUVs,K=0;for(P[1]=r,h=0;h<_;h++)if(this.parseWord(i,P),V=K-P[0],P[0]||K++,this.parseWord(i,P),G=K-P[0],P[0]||K++,this.parseWord(i,P),j=K-P[0],P[0]||K++,O)z[o=3*h]=V,z[o+1]=G,z[o+2]=j;else{var X=3*V;m[o=9*h]=J[X],m[o+1]=J[X+1],m[o+2]=J[X+2],X=3*G,m[o+3]=J[X],m[o+4]=J[X+1],m[o+5]=J[X+2],X=3*j,m[o+6]=J[X],m[o+7]=J[X+1],m[o+8]=J[X+2],null!=f&&(f[o=6*h]=Z[2*V],f[o+1]=Z[2*V+1],f[o+2]=Z[2*G],f[o+3]=Z[2*G+1],f[o+4]=Z[2*j],f[o+5]=Z[2*j+1])}if(U&&(m=this.tmpVertices,f=this.tmpExternalUVs),D&&(m=this.use16bit?new Uint16Array(Y.length/2*3):new Float32Array(Y.length/2*3),R=this.tmpInternalUVs),K=0,null!=R)for(h=0;h<_;h++)this.parseWord(i,P),V=K-P[0],P[0]||K++,this.parseWord(i,P),G=K-P[0],P[0]||K++,this.parseWord(i,P),j=K-P[0],P[0]||K++,D?(H=3*z[o=3*h],q=3*z[o+1],W=3*z[o+2],m[3*V]=J[H],m[3*V+1]=J[H+1],m[3*V+2]=J[H+2],m[3*G]=J[q],m[3*G+1]=J[q+1],m[3*G+2]=J[q+2],m[3*j]=J[W],m[3*j+1]=J[W+1],m[3*j+2]=J[W+2],z[o]=V,z[o+1]=G,z[o+2]=j):(R[o=6*h]=Y[2*V],R[o+1]=Y[2*V+1],R[o+2]=Y[2*G],R[o+3]=Y[2*G+1],R[o+4]=Y[2*j],R[o+5]=Y[2*j+1]);r=P[1],this.vertices=m,this.internalUVs=R,this.externalUVs=f,this.indices=z,this.tmpVertices=null,this.tmpInternalUVs=null,this.tmpExternalUVs=null,e.index=r,this.size=this.vertices.byteLength,this.internalUVs&&(this.size+=this.internalUVs.byteLength),this.externalUVs&&(this.size+=this.externalUVs.byteLength),this.indices&&(this.size+=this.indices.byteLength),this.faces=_},K.prototype.getSize=function(){return this.size},K.prototype.getFileSize=function(){return this.fileSize},K.prototype.buildGpuMesh=function(){return new Z(this.map.renderer.gpu,{bbox:this.bbox,vertices:this.vertices,uvs:this.internalUVs,uvs2:this.externalUVs,indices:this.indices},1,this.map.core,!0,this.use16bit)},K.prototype.computeUVArea=function(e){var t=this.internalUVs||this.externalUVs,r=0,i=e.width/65535,a=e.height/65535,s=function(e,r,s){var n=(t[r]-t[e])*i,o=(t[r+1]-t[e+1])*a,h=Math.sqrt(n*n+o*o);n=(t[s]-t[r])*i,o=(t[s+1]-t[r+1])*a;var l=Math.sqrt(n*n+o*o);n=(t[e]-t[s])*a,o=(t[e+1]-t[s+1])*a;var u=Math.sqrt(n*n+o*o),d=.5*(h+l+u);return Math.sqrt(Math.max(0,d*(d-h)*(d-l)*(d-u)))};if(t){var n=this.indices;if(n)for(var o=0,h=0,l=this.faces;o<l;o++,h+=3)r+=s(2*n[3*o],2*n[3*o+1],2*n[3*o+2]);else for(o=0,h=0,l=this.faces;o<l;o++,h+=3)r+=s(3*o*2,3*o*2+1,3*o*2+2)}this.uvAreaComputed=!0,this.uvArea=r},K.prototype.getWorldMatrix=function(e,t){var r=t;return r?(r[0]=this.bbox.side(0),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=this.bbox.side(1),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=this.bbox.side(2),r[11]=0,r[12]=this.bbox.min[0]-e[0],r[13]=this.bbox.min[1]-e[1],r[14]=this.bbox.min[2]-e[2],r[15]=1):(r=W.create(),W.multiply(J.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),J.scaleMatrix(this.bbox.side(0),this.bbox.side(1),this.bbox.side(2)),r)),r},K.prototype.getWorldMatrixSE=function(e,t){var r=t;return r?(r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=this.bbox.min[0]-e[0],r[13]=this.bbox.min[1]-e[1],r[14]=this.bbox.min[2]-e[2],r[15]=1):r=J.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),r},K.prototype.drawBBox=function(e){var t=this.map.renderer;t.gpu.useProgram(t.progBBox,["aPosition"]);var r=W.create(),i=W.create();W.multiply(t.camera.getModelviewMatrix(),this.getWorldMatrix(e),i);var a=t.camera.getProjectionMatrix();W.multiply(a,i,r),t.progBBox.setMat4("uMVP",r),t.bboxMesh.draw(t.progBBox,"aPosition")};var X=K,Q=function(e,t,r,i){this.gpu=e,this.gl=e.gl,this.vertex=t,this.fragment=r,this.program=null,this.uniformLocationCache=[],this.attributeLocationCache=[],this.m=new Float32Array(16),this.ready=!1,this.createProgram(t,r),this.variants=i||[],this.programs={}};Q.prototype.createShader=function(e,t){var r,i=this.gl;if(!e||!i)return null;if(r=!0!==t?i.createShader(i.FRAGMENT_SHADER):i.createShader(i.VERTEX_SHADER),i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){var a=i.getShaderInfoLog(r);return console.log("An error occurred compiling the "+(!0!==t?"fragment":"vertex")+" shaders: "+a),this.gpu.renderer.core.callListener("renderer-shader-error",{where:"compilation",info:a}),null}return r},Q.prototype.createProgram=function(e,t){var r=this.gl;if(null!=r){var i=this.createShader(e,!0),a=this.createShader(t,!1);if(i&&a){var s=r.createProgram();r.attachShader(s,i),r.attachShader(s,a),r.linkProgram(s),r.getProgramParameter(s,r.LINK_STATUS)||(console.log("Unable to initialize the shader program."),this.gpu.renderer.core.callListener("renderer-shader-error",{where:"linking"})),r.useProgram(s),this.program=s,this.ready=!0}}},Q.prototype.setSampler=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniform1i(i,t)}},Q.prototype.isReady=function(e,t){return this.ready},Q.prototype.setMat4=function(e,t,r){var i=this.gl;if(null!=i&&null!=this.program){var a=this.getUniform(e);if(null!=a)if(r){r=2*(1+r)-1;var s=this.m;s[0]=t[0],s[1]=t[1],s[2]=t[2]*r,s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6]*r,s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10]*r,s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14]*r,s[15]=t[15],i.uniformMatrix4fv(a,!1,s)}else i.uniformMatrix4fv(a,!1,t)}},Q.prototype.setMat3=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniformMatrix3fv(i,!1,t)}},Q.prototype.setVec2=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniform2fv(i,t)}},Q.prototype.setVec3=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniform3fv(i,t)}},Q.prototype.setVec4=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniform4fv(i,t)}},Q.prototype.setFloat=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniform1f(i,t)}},Q.prototype.setFloatArray=function(e,t){var r=this.gl;if(null!=r&&null!=this.program){var i=this.getUniform(e);null!=i&&r.uniform1fv(i,t)}},Q.prototype.getAttribute=function(e){var t=this.gl;if(null!=t&&null!=this.program){var r=this.attributeLocationCache[e];return null==r&&(r=t.getAttribLocation(this.program,e),this.attributeLocationCache[e]=r),r}},Q.prototype.getUniform=function(e){var t=this.gl;if(null!=t&&null!=this.program){var r=this.uniformLocationCache[e];return null==r&&(r=t.getUniformLocation(this.program,e),this.uniformLocationCache[e]=r),r}};var $=Q,ee={bboxVertexShader:"attribute vec3 aPosition;\nuniform mat4 uMVP;\nvoid main(){ \ngl_Position = uMVP * vec4(aPosition, 1.0);\n}",bbox2VertexShader:"attribute vec3 aPosition;\nuniform mat4 uMVP;\nuniform float uPoints[8*3];\nvoid main(){ \nint index = int(aPosition.z) * 3; \ngl_Position = uMVP * vec4(uPoints[index], uPoints[index+1], uPoints[index+2], 1.0);\n}",bboxFragmentShader:"precision mediump float;\nvoid main() {\ngl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\n}",text2VertexShader:"attribute vec4 aPosition;\nvoid main(){ \n}",lineVertexShader:"#ifndef dataPoints2\nuniform mat4 uMVP;\n#else\nuniform mat4 uMV, uProj;\n#endif\n#ifdef pixelLine\n#ifdef dataPoints2\nattribute vec3 aPosition;\n#else\nattribute vec4 aPosition;\nattribute vec4 aNormal;\n#endif\n#ifdef dataPoints\nuniform vec3 uScale;\nuniform vec3 uPoints[32];\n#else\nuniform vec2 uScale;\n#endif\n#ifdef dataPoints2\nvec4 getClippedPixelLinePoint(vec3 p1, vec3 p2, vec3 params) {\nvec2 pp1, pp2, n;\nvec4 wp0 = (uMV * vec4(p1.xyz, 1.0)), pp0, pp3;\nfloat near = gl_DepthRange.near + 0.1;\nif (params.y < 0.0) {\nif (wp0.z > -near) return vec4(8.0, 0.0, 0.0, 1.0);\npp0 = uProj * wp0;\nif (params.y == -1.0) return pp0;\nreturn pp0 + vec4((vec3(-sin(params.z)*uScale.x*uScale.z*pp0.w, cos(params.z)*uScale.y*uScale.z*pp0.w, 0.0)), 0.0);\n} else {\nvec3 p2 = uPoints[int(params.y)];\nvec4 wp3 = (uMV * vec4(p2.xyz, 1.0));\nif (wp0.z > -near) {\nvec3 dir = (wp3.xyz - wp0.xyz);\nfloat l = length(dir);\ndir = normalize(dir);\nfloat denominator = -dir.z;\nif (abs(denominator) < 0.0000001) return vec4(8.0, 0.0, 0.0, 1.0);\nfloat t = (near + wp0.z) / denominator;\nif (t < 0.0 || t > l) return vec4(8.0, 0.0, 0.0, 1.0);\nwp0.xyz = wp0.xyz + (dir * t);\n}\npp0 = uProj * wp0;\npp3 = uProj * wp3;\npp1 = pp0.xy / pp0.w;\npp2 = pp3.xy / pp3.w;\nn = normalize(pp2 - pp1);\nreturn pp0 + vec4((vec3(-n.y*uScale.x*params.z*uScale.z*pp0.w, n.x*uScale.y*params.z*uScale.z*pp0.w, 0.0)), 0.0);\n}\n}\n#endif\n#else\n#ifdef lineLabel2\nattribute vec2 aPosition;\nuniform vec4 uData[DSIZE];\nuniform float uFile;\nvarying vec2 vTexCoord;\n#else\n#ifdef lineLabel\nattribute vec4 aPosition;\nattribute vec4 aTexCoord;\nuniform vec4 uVec;\nuniform float uFile;\nvarying vec2 vTexCoord;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef dynamicWidth\nattribute vec4 aNormal;\nuniform vec4 uParams;\n#endif\n#endif\n#endif\n#ifdef applySE\nuniform mat4 uParamsSE;\n#endif\n#ifdef withElements\nattribute float aElement;\nvarying float vElement;\n#endif\nvoid main() {\n#ifdef withElements\nvElement = aElement;\n#endif\n#ifdef dataPoints\nvec3 p1 = uPoints[int(aPosition.x)];\n#else \n#ifndef lineLabel2\nvec3 p1 = aPosition.xyz;\n#endif\n#endif\n#ifdef pixelLine\n#ifndef dataPoints\nvec3 p2 = aNormal.xyz;\n#endif\n#endif\n#ifdef applySE\nvec3 geoPos2 = p1.xyz*vec3(uParamsSE[0][3],uParamsSE[1][0],uParamsSE[1][1]);\nvec3 geoPos = geoPos2+vec3(uParamsSE[0][0],uParamsSE[0][1],uParamsSE[0][2]);\ngeoPos.z *= uParamsSE[3][3];\nfloat ll = length(geoPos);\nvec3 v = geoPos * (1.0/(ll+0.0001));\nfloat h = ll - uParamsSE[3][2];\nfloat h2 = clamp(h, uParamsSE[2][1], uParamsSE[2][3]);\nfloat h3 = h;\nh *= (uParamsSE[2][2] + ((h2 - uParamsSE[2][1]) * uParamsSE[3][0]) * uParamsSE[3][1]);\ngeoPos2.xyz += v * (h - h3);\n#ifdef pixelLine\nvec4 pp0 = uMVP * vec4(geoPos2, 1.0);\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uScale.x*pp0.w, aNormal.y*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\ngeoPos2 = p2.xyz*vec3(uParamsSE[0][3],uParamsSE[1][0],uParamsSE[1][1]);\ngeoPos = geoPos2+vec3(uParamsSE[0][0],uParamsSE[0][1],uParamsSE[0][2]);\ngeoPos.z *= uParamsSE[3][3];\nll = length(geoPos);\nv = geoPos * (1.0/(ll+0.0001));\nh = ll - uParamsSE[3][2];\nh2 = clamp(h, uParamsSE[2][1], uParamsSE[2][3]);\nh3 = h;\nh *= (uParamsSE[2][2] + ((h2 - uParamsSE[2][1]) * uParamsSE[3][0]) * uParamsSE[3][1]);\ngeoPos2.xyz += v * (h - h3);\nvec4 pp3 = uMVP * vec4(geoPos2, 1.0);\nvec2 pp1 = pp0.xy / pp0.w;\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uScale.x*aNormal.w*pp0.w, n.x*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n#else\n#ifdef lineLabel\nvTexCoord = aTexCoord.xy;\nif (dot(uVec.xyz, vec3(aTexCoord.z, aTexCoord.w, aPosition.w)) < 0.0) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\nfloat file = floor(aTexCoord.y/4.0);\nvTexCoord.y = mod(aTexCoord.y,4.0);\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\ngl_Position = uMVP * vec4(geoPos2, 1.0);\n}\n}\n#else\ngl_Position = uMVP * vec4(geoPos2, 1.0);\n#endif\n#endif\n#else\n#ifdef pixelLine\n#ifdef dataPoints2\nvec3 p2 = uPoints[int(aPosition.y)];\ngl_Position = getClippedPixelLinePoint(p1.xyz, p2.xyz, aPosition.xyz);\n#else\nvec4 pp0 = (uMVP * vec4(p1.xyz, 1.0));\n#ifdef dataPoints\nif (aPosition.y < 0.0) {\nif (aPosition.y == -1.0) {\ngl_Position = pp0;\n} else {\ngl_Position = pp0 + vec4((vec3(-sin(aPosition.z)*uScale.x*uScale.z, cos(aPosition.z)*uScale.y*uScale.z, 0.0)), 0.0);\n}\n} else {\nvec3 p2 = uPoints[int(aPosition.y)];\nvec4 pp3 = (uMVP * vec4(p2.xyz, 1.0));\nvec2 pp1 = pp0.xy / pp0.w;\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uScale.x*aPosition.z*uScale.z, n.x*uScale.y*aPosition.z*uScale.z, 0.0)), 0.0);\n}\n#else\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uScale.x*pp0.w, aNormal.y*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\nvec4 pp3 = (uMVP * vec4(p2.xyz, 1.0));\nvec2 pp1 = pp0.xy / pp0.w;\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uScale.x*aNormal.w*pp0.w, n.x*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n#endif\n#endif\n#else\n#ifdef lineLabel2\nint index = int(aPosition.x) * 3;\nvec4 data = uData[index];\nvec4 data2 = uData[index+1];\nvec4 data3 = uData[index+2];\nvec3 pos = vec3(data[0],data[1],data[2]);\nvec4 q = vec4(data[3],data2[0],data2[1],data2[2]);\nvec2 factor = vec2(data2[3],data3[0]);\nvec2 uv = vec2(data3[1],data3[2]);\nfloat duv = data3[3];\nfloat x=q[0], y=q[1], z=q[2], w=q[3];\nfloat x2=x+x, y2=y+y, z2=z+z, xx=x*x2, yx=y*x2, yy=y*y2;\nfloat zx=z*x2, zy=z*y2, zz=z*z2, wx=w*x2, wy=w*y2, wz=w*z2;\nvec3 right = vec3(1.0-yy-zz, yx-wz, zx+wy) * factor.x;\nvec3 up = vec3(yx+wz, 1.0-xx-zz, zy-wx) * (-factor.y);\nfloat file = floor(uv.y/4.0);\nuv.y = (uv.y-file*4.0);\nint corner = int(aPosition.y);\nif (corner==1){ pos+=right; uv.x+=floor(duv)*(1.0/1024.0);  }\nif (corner==2){ pos+=right; pos+=up; uv.x+=floor(duv)*(1.0/1024.0); uv.y+=fract(duv); }\nif (corner==3){ pos+=up; uv.y+=fract(duv); }\nvTexCoord = uv;\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\ngl_Position = uMVP * vec4(pos.xyz, 1.0);\n}\n#else\n#ifdef lineLabel\nvTexCoord = aTexCoord.xy;\nif (dot(uVec.xyz, vec3(aTexCoord.z, aTexCoord.w, aPosition.w)) < 0.0) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\nfloat file = floor(aTexCoord.y/4.0);\nvTexCoord.y = mod(aTexCoord.y,4.0);\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\ngl_Position = uMVP * vec4(aPosition.xyz, 1.0);\n}\n}\n#else\n#ifdef dynamicWidth\ngl_Position = uMVP * vec4(aPosition.xyz + aNormal.xyz*(abs(aNormal.w)*uParams[3]), 1.0);\n#else\ngl_Position = uMVP * vec4(aPosition, 1.0);\n#endif\n#endif\n#endif\n#endif\n#endif\n}",lineFragmentShader:"precision mediump float;\nuniform vec4 uColor;\n#ifdef withElements\nvarying float vElement;\n#endif\nvoid main() {\n#ifdef withElements\ngl_FragColor.xyz = fract(vec3(1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vElement) + (-0.5/255.0);\ngl_FragColor.w = 1.0;\n#else\ngl_FragColor = uColor;\n#endif\n}",tlineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying vec2 vTexCoord;\nvoid main(){ \nvec4 p=vec4(aPosition.xyz, 1.0);\np.xyz+=aNormal.xyz*(abs(aNormal.w)*uParams[3]);\nif (aNormal.w < 0.0){\nvTexCoord=vec2(abs(aPosition.w)*uParams[0], (uParams[1]+uParams[2])*0.5);\n} else {\nvTexCoord=vec2(abs(aPosition.w)*uParams[0], aPosition.w < 0.0 ? uParams[1] : uParams[2]);\n}\ngl_Position = uMVP * p;\n}",etlineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nattribute float aElement;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying float vElement;\nvoid main(){ \nvec4 p=vec4(aPosition.xyz, 1.0);\np.xyz+=aNormal.xyz*(abs(aNormal.w)*uParams[3]);\nvElement = aElement;\ngl_Position = uMVP * p;\n}",tplineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying vec2 vTexCoord;\nvoid main(){ \nvec4 pp0 = (uMVP * vec4(aPosition.xyz, 1.0));\nvTexCoord=vec2(abs(aPosition.w)*uParams[0], aPosition.w < 0.0 ? uParams[1] : uParams[2]);\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uParams[3]*uScale.x*pp0.w, aNormal.y*uParams[3]*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\nvec2 pp1 = pp0.xy / pp0.w;\nvec4 pp3 = (uMVP * vec4(aNormal.xyz, 1.0));\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uParams[3]*uScale.x*aNormal.w*pp0.w, n.x*uParams[3]*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n}",etplineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nattribute float aElement;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying float vElement;\nvoid main(){ \nvec4 pp0 = (uMVP * vec4(aPosition.xyz, 1.0));\nvElement = aElement;\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uParams[3]*uScale.x*pp0.w, aNormal.y*uParams[3]*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\nvec2 pp1 = pp0.xy / pp0.w;\nvec4 pp3 = (uMVP * vec4(aNormal.xyz, 1.0));\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uParams[3]*uScale.x*aNormal.w*pp0.w, n.x*uParams[3]*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n}",tlineFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform vec4 uColor2;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 c=texture2D(uSampler, vTexCoord)*uColor;\ngl_FragColor = c;\n}",tblineFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform vec4 uColor2;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 c1=texture2D(uSampler, vTexCoord)*uColor;\nvec4 c2=uColor2,c=c1;\nc.xyz*=c.w; c2.xyz*=c2.w;\nc=mix(c,c2,1.0-c.w);\nc.xyz/=(c.w+0.00001);\nc.w=max(c1.w,c2.w);\ngl_FragColor = c;\n}",polygonVertexShader:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uMVP;\nuniform mat4 uRot;\nuniform vec4 uColor;\nvarying vec4 vColor;\nvoid main(){ \nfloat l = dot((uRot*vec4(aNormal,1.0)).xyz, vec3(0.0,0.0,1.0)) * 0.5;\nvec3 c = uColor.xyz;\nc = (l > 0.0) ? mix(c,vec3(1.0,1.0,1.0),l) : mix(vec3(0.0,0.0,0.0),c,1.0+l);\nvColor = vec4(c, uColor.w);\ngl_Position = uMVP * vec4(aPosition, 1.0);\n}",polygonFragmentShader:"precision mediump float;\nvarying vec4 vColor;\nvoid main() {\ngl_FragColor = vColor;\n}",iconVertexShader:"attribute vec4 aPosition;\nattribute vec4 aTexCoord;\nattribute vec3 aOrigin;\nuniform mat4 uMVP;\nuniform vec4 uScale;\nvarying vec2 vTexCoord;\nvoid main(){ \nvTexCoord = aTexCoord.xy * uScale[2];\nvec4 pos = (uMVP * vec4(aOrigin, 1.0));\ngl_Position = pos + vec4(aPosition.x*uScale.x*pos.w, (aPosition.y+uScale.w)*uScale.y*pos.w, 0.0, 0.0);\n}",icon2VertexShader:"attribute vec4 aPosition;\nattribute vec4 aTexCoord;\nattribute vec3 aOrigin;\nuniform mat4 uMVP;\nuniform vec4 uScale;\nuniform float uFile;\nvarying vec2 vTexCoord;\nvoid main(){ \nvTexCoord = aTexCoord.xy * uScale[2];\nfloat file = floor(aTexCoord.y/4.0);\nvTexCoord.y = mod(aTexCoord.y,4.0);\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\nvec4 pos = (uMVP * vec4(aOrigin, 1.0));\ngl_Position = pos + vec4(aPosition.x*uScale.x*pos.w, (aPosition.y+uScale.w)*uScale.y*pos.w, 0.0, 0.0);\n}}",icon3VertexShader:"attribute vec2 aPosition;\nuniform mat4 uProjectionMatrix;\nuniform vec4 uScale;\nuniform vec3 uOrigin;\nuniform vec4 uData[DSIZE];\nuniform float uFile;\nvarying vec2 vTexCoord;\nvoid main(){ \nint index = int(aPosition.x);\nvec4 data = uData[index];\nvec4 data2 = uData[index+1];\nvec4 v;\nint corner = int(aPosition.y);\nif (corner==0) v = vec4(data.x, data.y, data2.x, data2.y);\nif (corner==1) v = vec4(data.z, data.y, data2.z, data2.y);\nif (corner==2) v = vec4(data.z, data.w, data2.z, data2.w);\nif (corner==3) v = vec4(data.x, data.w, data2.x, data2.w);\nvTexCoord = vec2(v.z, v.w);\nfloat file = floor(v.w/4.0);\nvTexCoord.y = (v.w-file*4.0);\nif (file != floor(uFile)) {\ngl_Position = uProjectionMatrix * vec4(2.0, 0.0, 0.0, 2.0);\n}else{\nvec4 pos = (uProjectionMatrix * vec4(uOrigin.xyz, 1.0));\ngl_Position = pos + vec4(v.x*uScale.x*pos.w, v.y*uScale.y*pos.w, 0.0, 0.0);\n}}",textFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 c=texture2D(uSampler, vTexCoord);\nif(c.w < 0.01){ discard; }\ngl_FragColor = c*uColor;\n}",text2FragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform vec2 uParams;\nvarying vec2 vTexCoord;\nfloat round(float x) { return floor(x + 0.5); }\nvoid main() {\nvec2 uv=(vTexCoord);\nuv.y=fract(uv.y);\nvec4 c=texture2D(uSampler, uv);\nfloat r = 0.0;\nint i=int(floor(vTexCoord.y));\nif (i == 0) r=c.x;else\nif (i == 1) r=c.y;else\nif (i == 2) r=c.z;else\nif (i == 3) r=c.w;\nfloat u_buffer = uParams[0];\nfloat u_gamma = uParams[1];\nfloat alpha = uColor.a * smoothstep(u_buffer - u_gamma, u_buffer + u_gamma, r);\nif(alpha < 0.01){ discard; }\ngl_FragColor = vec4(uColor.rgb, alpha);\n}",skydomeVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMVP;\nvarying vec2 vTexCoord;\nvoid main(){ \ngl_Position = uMVP * vec4(aPosition, 1.0);\nvTexCoord = aTexCoord;\n}",skydomeFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nvarying vec2 vTexCoord;\nconst vec4 gray = vec4(0.125, 0.125, 0.125, 1.0);\nvoid main() {\nfloat fade = smoothstep(0.51, 0.55, vTexCoord.t);\ngl_FragColor = mix(texture2D(uSampler, vTexCoord), gray, fade);\n}",stardomeFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uSampler, vTexCoord);\n}",atmoVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform mat3 uNorm;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\nvoid main(){ \nvec4 camSpacePos = uMV * vec4(aPosition, 1.0);\ngl_Position = uProj * camSpacePos;\nvec4 c = uMV * vec4(aPosition, 1.0);\nvNormal = (aPosition.xyz - vec3(0.5));\nvPosition = camSpacePos;\n}",atmoFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uParams;\nuniform vec4 uParams2;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nuniform vec4 uFogColor;\nuniform vec4 uFogColor2;\nvoid main() {\nfloat l = dot(normalize(vNormal),-uParams2.xyz);\nl = (1.0-pow(abs(l),uParams.x));\nvec4 c = mix(uFogColor2, uFogColor, l);\ngl_FragColor = vec4(c.xyz, c.w*l);\n}",atmoFragmentShader2:"precision mediump float;\nuniform sampler2D uSampler;\nuniform float uNFactor;\nuniform vec2 uRadius;\nuniform vec3 uPos;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nuniform vec4 uFogColor;\nvoid main() {\nvec3 ldir = normalize(-vPosition.xyz);\nvec3 diff = uPos;\nfloat a = dot(ldir, ldir);\nfloat b = 2 * dot(ldir, diff);\nfloat c = dot(diff, diff) - (uRadius[0] * uRadius[0]);\nfloat i = 0;\nfloat discr = b * b - 4 * a * c;\nif (discr > 0.0) {}\n}\ngl_FragColor = uFogColor;\n}",atmoVertexShader3:"attribute vec3 aPosition;\nuniform mat4 uMV, uProj;\nuniform vec4 uParams;\nuniform vec4 uParams2;\nvarying vec2 vTexcoords;\nvoid main(){ \ngl_Position = uProj * (uMV * vec4(aPosition, 1.0));\nvec3 position = (aPosition.xyz - vec3(0.5)) * vec3(uParams.w * 2.0);\nvec4 camPos = uParams2;\nfloat SurfaceRadius = uParams.x;\nfloat AtmosphereRadius = uParams.y;\nfloat StretchAmt = uParams.z;\nfloat camHeight = length(camPos.xyz);\nvec3 camToPos = position - camPos.xyz;\nfloat farDist = length(camToPos);\nfloat altitude = max(0.0,camHeight - SurfaceRadius);\nfloat horizonDist = sqrt((altitude*altitude) + (2.0 * SurfaceRadius * altitude));\nfloat maxDot = horizonDist / camHeight;\naltitude = max(0.0,camHeight - AtmosphereRadius);\nhorizonDist = sqrt((altitude*altitude) + (2.0 * AtmosphereRadius * altitude));\nfloat tweakAmount = 0.1;\nfloat minDot = max(tweakAmount,horizonDist / camHeight);\nfloat minDot2 = ((camHeight - SurfaceRadius) * (1.0 / (AtmosphereRadius  - SurfaceRadius))) - (1.0 - tweakAmount);\nminDot = min(minDot, minDot2);\nfloat posDot = dot(camToPos / farDist,-camPos.xyz / camHeight) - minDot;\nfloat height = posDot * (1.0 / (maxDot - minDot));\nvTexcoords.y = height;\nheight -= min(0.0,minDot2 + ((1.0 + StretchAmt) * minDot2));\nvTexcoords.x = height;\n}",atmoFragmentShader3:"precision mediump float;\nvarying vec2 vTexcoords;\nuniform vec4 uParams3;\nuniform vec4 uFogColor;\nuniform vec4 uFogColor2;\nconst vec4 fogColor3 = vec4(0.0/255.0, 0.0/255.0, 0.0/255.0, 1.0);\nvoid main() {\nfloat l = vTexcoords.y;\nif (l > uParams3.z){ discard; } else {\nfloat l2 = clamp((l*l)*0.9+0.1, 0.0, 1.5);\nvec4 c = mix(uFogColor2, uFogColor, l2);\ngl_FragColor = vec4(c.xyz, c.w*l);\nif (l > uParams3.x){ gl_FragColor.xyz = mix(gl_FragColor.xyz, fogColor3.xyz, (l-uParams3.x)*uParams3.y); }\n}}",heightmapVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform float uFogDensity;\nuniform mat4 uGridMat;\nuniform float uGridStep1, uGridStep2;\nconst int HMSize = 5;\nconst float HMSize1 = float(HMSize-1);\nuniform float uHeight[HMSize*HMSize];\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vFogFactor;\nfloat round(float x) { return floor(x + 0.5); }\nvoid main() {\nvec3 pos = aPosition;\nfloat z = uHeight[int(round(pos.y*HMSize1)*float(HMSize) + round(pos.x*HMSize1))];\nvec4 camSpacePos = uMV * vec4(pos.xy, z, 1.0);\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvFogFactor = exp(uFogDensity * camDist);\nvec4 gridCoord = uGridMat * vec4(pos, 1.0);\nvTexCoord1 = aTexCoord;\nvTexCoord1 = gridCoord.xy * vec2(uGridStep1);\nvTexCoord2 = gridCoord.xy * vec2(uGridStep2);\n}",heightmapFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform float uGridBlend;\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vFogFactor;\nuniform vec4 uFogColor;\nvoid main() {\nvec4 gridColor = mix(texture2D(uSampler, vTexCoord1), texture2D(uSampler, vTexCoord2), uGridBlend);\ngl_FragColor = mix(uFogColor, gridColor, vFogFactor);\n}",heightmapDepthVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform float uFogDensity;\nuniform mat4 uGridMat;\nuniform float uGridStep1, uGridStep2;\nconst int HMSize = 5;\nconst float HMSize1 = float(HMSize-1);\nuniform float uHeight[HMSize*HMSize];\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vDepth;\nfloat round(float x) { return floor(x + 0.5); }\nvoid main() {\nvec3 pos = aPosition;\nfloat z = uHeight[int(round(pos.y*HMSize1)*float(HMSize) + round(pos.x*HMSize1))];\nvec4 camSpacePos = uMV * vec4(pos.xy, z, 1.0);\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvDepth = camDist;\nvec4 gridCoord = uGridMat * vec4(pos, 1.0);\nvTexCoord1 = aTexCoord;\nvTexCoord1 = gridCoord.xy * vec2(uGridStep1);\nvTexCoord2 = gridCoord.xy * vec2(uGridStep2);\n}",heightmapDepthFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform float uGridBlend;\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vDepth;\nvoid main() {\ngl_FragColor = fract(vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vDepth) + (-0.5/255.0);\n}",quadPoint:"vec3 quadPoint(int i1, int i2, int i3, float t, float t2) {\nfloat p1x = uPoints[i1], p1y = uPoints[i1+1], p1z = uPoints[i1+2];\nfloat p3x = uPoints[i3], p3y = uPoints[i3+1], p3z = uPoints[i3+2];\nfloat p2x = 2.0*uPoints[i2]-p1x*0.5-p3x*0.5;\nfloat p2y = 2.0*uPoints[i2+1]-p1y*0.5-p3y*0.5;\nfloat p2z = 2.0*uPoints[i2+2]-p1z*0.5-p3z*0.5;\nreturn vec3(t2*t2*p1x+2.0*t2*t*p2x+t*t*p3x, t2*t2*p1y+2.0*t2*t*p2y+t*t*p3y, t2*t2*p1z+2.0*t2*t*p2z+t*t*p3z); }\n"};ee.planeVertexShader="attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform vec4 uParams;\nuniform vec4 uParams3;\nuniform float uPoints[9*3];\n#ifndef poles\nuniform vec3 uVector;\nuniform float uHeights[9];\n#endif\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvarying float vFogFactor;\n"+ee.quadPoint+"#ifndef poles\nfloat linearHeight(float x, float y) {\nint ix = int(x);\nint iy = int(y);\nint index = (2-iy)*3+ix;\nint index2 = (2-(iy+1))*3+ix;\nfloat fx = fract(x);\nfloat fy = fract(y);\nfloat w0 = (uHeights[index] + (uHeights[index+1] - uHeights[index])*fx);\nfloat w1 = (uHeights[index2] + (uHeights[index2+1] - uHeights[index2])*fx);\nreturn (w0 + (w1 - w0)*fy);\n}\n#endif\nvoid main() {\nvec3 indices = aPosition;\nfloat t = aPosition.y * uParams[2];\nfloat tt = t;\nfloat t2 = (1.0-t);\nvec3 p1 = quadPoint(0, 3, 6, t, t2);\nvec3 p2 = quadPoint(9, 9+3, 9+6, t, t2);\nvec3 p3 = quadPoint(18, 18+3, 18+6, t, t2);\nt = aPosition.x * uParams[2];\nfloat tt2 = t;\nt2 = (1.0-t);\nfloat p2x = 2.0*p2.x-p1.x*0.5-p3.x*0.5;\nfloat p2y = 2.0*p2.y-p1.y*0.5-p3.y*0.5;\nfloat p2z = 2.0*p2.z-p1.z*0.5-p3.z*0.5;\nvec4 p = vec4(t2*t2*p1.x+2.0*t2*t*p2x+t*t*p3.x, t2*t2*p1.y+2.0*t2*t*p2y+t*t*p3.y, t2*t2*p1.z+2.0*t2*t*p2z+t*t*p3.z, 1);\n#ifndef poles\n#ifndef flat\np.xyz += uVector * linearHeight(tt*2.0, tt2*2.0);\n#endif\n#endif\nvec4 camSpacePos = uMV * p;\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\n#ifdef depth\nvFogFactor = camDist;\n#else\nvFogFactor = exp(uParams[1] * camDist);\n#endif\nvec2 uv;\nuv.x = aTexCoord.y * uParams3[2] + uParams3[0];\nuv.y = (1.0-aTexCoord.x) * uParams3[3] + uParams3[1];\nvTexCoord = uv;\nvTexCoord2 = p.xy;\n}",ee.planeFragmentShader="precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uParams2;\n#ifdef poles\nuniform vec4 uParams4;\nvarying vec2 vTexCoord2;\n#endif\nvarying vec2 vTexCoord;\nvarying float vFogFactor;\nuniform vec4 uFogColor;\nvoid main() {\n#ifdef poles\nif (length(uParams4.xy - vTexCoord2.xy) > uParams4.z){ discard; }\n#endif\n#ifdef depth\ngl_FragColor = fract(vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vFogFactor) + (-0.5/255.0);\n#else\nvec4 c = mix(texture2D(uSampler, vTexCoord), texture2D(uSampler, vTexCoord*8.0), uParams2[2]);\ngl_FragColor = mix(uFogColor, c, vFogFactor);\n#endif\n}",ee.getHFNormal="vec3 getHFNormal(vec2 uv, float texelSize, float heightDelta) {\nvec4 h;\nh[0] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0,-1.0))).r * heightDelta;\nh[1] = texture2D(uSampler2, uv + (texelSize * vec2(-1.0, 0.0))).r * heightDelta;\nh[2] = texture2D(uSampler2, uv + (texelSize * vec2( 1.0, 0.0))).r * heightDelta;\nh[3] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0, 1.0))).r * heightDelta;\nreturn normalize(vec3(h[1] - h[2], h[3] - h[0], 2.0));}\n",ee.getHFNormal2="vec2 getHFNormal2(vec2 uv, float texelSize, float heightDelta) {\nvec4 h;\nh[0] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0,-1.0))).r * heightDelta;\nh[1] = texture2D(uSampler2, uv + (texelSize * vec2(-1.0, 0.0))).r * heightDelta;\nh[2] = texture2D(uSampler2, uv + (texelSize * vec2( 1.0, 0.0))).r * heightDelta;\nh[3] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0, 1.0))).r * heightDelta;\nreturn vec2(h[1] - h[2], h[3] - h[0]);}\n",ee.planeVertex4Shader="#define newspace\nuniform sampler2D uSampler2;\nattribute vec3 aPosition;\nuniform mat4 uMV, uProj;\nuniform vec4 uParams;\nuniform vec4 uParams3;\nuniform float uPoints[9*3];\nuniform vec3 uVector;\nuniform vec3 uHeights;\nuniform vec4 uTransform;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvarying vec3 vBarycentric;\n#ifdef newspace\nvarying mat3 vTBN;\n#else\nvarying vec3 vNormal;\n#endif\nvarying float vFogFactor;\n"+ee.quadPoint+ee.getHFNormal+ee.getHFNormal2+"void main() {\nvec3 indices = aPosition;\nfloat t = aPosition.y * uParams[2];\nfloat tt = t;\nfloat t2 = (1.0-t);\nvec3 p1 = quadPoint(0, 3, 6, t, t2);\nvec3 p2 = quadPoint(9, 9+3, 9+6, t, t2);\nvec3 p3 = quadPoint(18, 18+3, 18+6, t, t2);\nt = aPosition.x * uParams[2];\nfloat tt2 = t;\nt2 = (1.0-t);\nfloat p2x = 2.0*p2.x-p1.x*0.5-p3.x*0.5;\nfloat p2y = 2.0*p2.y-p1.y*0.5-p3.y*0.5;\nfloat p2z = 2.0*p2.z-p1.z*0.5-p3.z*0.5;\nvec4 p = vec4(t2*t2*p1.x+2.0*t2*t*p2x+t*t*p3.x, t2*t2*p1.y+2.0*t2*t*p2y+t*t*p3.y, t2*t2*p1.z+2.0*t2*t*p2z+t*t*p3.z, 1);\nvec2 uv2 = vec2(tt, 1.0-tt2);\nuv2 = vec2(uTransform[0] * uv2[0] + uTransform[2], uTransform[1] * uv2[1] + uTransform[3]);\np.xyz += uVector * (uHeights[0] + (uHeights[1]-uHeights[0])*texture2D(uSampler2, uv2).x);\nvec4 camSpacePos = uMV * p;\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvFogFactor = exp(uParams[1] * camDist);\nvec2 uv = vec2(tt, 1.0-tt2);\nuv.x = uv.x * uParams3[0] + uParams3[2];\nuv.y = uv.y * uParams3[1] + uParams3[3];\nvTexCoord = uv;\nvBarycentric = camSpacePos.xyz;\n#ifdef newspace\nvec2 d = getHFNormal2(uv2, 1.0/(128.0), (uHeights[1]-uHeights[0]) * uHeights[2]);\nvec3 T = vec3(2.0,0.0,-d.x); vec3 B = vec3(0.0,2.0,-d.y);\nvTBN = mat3(normalize(T), normalize(B), cross(T,B));\n#else\nvec3 n = getHFNormal(uv2, 1.0/(128.0), (uHeights[1]-uHeights[0]) * uHeights[2]);\nvNormal = normalize(n);\n#endif\n}",ee.planeFragmentShader2="precision mediump float;\n#extension GL_OES_standard_derivatives : enable\n#define newspace\nuniform sampler2D uSampler;\nuniform vec4 uParams2;\nuniform mat3 uSpace;\nvarying vec2 vTexCoord;\nvarying float vFogFactor;\nvarying vec3 vBarycentric;\n#ifdef newspace\nvarying mat3 vTBN;\n#else\nvarying vec3 vNormal;\n#endif\nuniform vec4 uFogColor;\nvoid main() {\nvec3 ldir = normalize(-vBarycentric);\n#ifdef flat\nvec3 nx = dFdx(vBarycentric);\nvec3 ny = dFdy(vBarycentric);\nvec3 normal2 = normalize(cross(nx,ny));\nvec4 c2 = vec4(vec3(max(0.0,normal2.z*(204.0/255.0))+(32.0/255.0)),1.0);\n#else\n#ifdef newspace\n#ifdef nmix\nvec3 normal = vTBN * normalize((texture2D(uSampler, vTexCoord).xyz-0.5)*2.0);\n#else\nvec3 normal = vTBN * vec3(0.0,0.0,1.0);\n#endif\n#else\nvec3 normal = vNormal;\n#endif\nnormal = normalize(uSpace * normal);\nvec3 eyeDir = ldir;\nvec3 refDir = reflect(-ldir, normal);\nfloat specW = min(1.0, pow(max(dot(refDir, eyeDir), 0.0), 90.0));\nfloat diffW = min(1.0, max(dot(normal, ldir), 0.0));\nfloat lcolor = (dot(normal, ldir) + 1.0) * 0.5;\n#ifdef normals\nvec4 c2 = vec4(normal*0.5+0.5,1.0);\n#else\nvec4 c2 = vec4(vec3(dot(vec3(0.0,0.0,1.0), normal)),1.0);\n#endif\n#endif\n#ifdef grid\nvec4 c = mix(texture2D(uSampler, vTexCoord), texture2D(uSampler, vTexCoord*8.0), uParams2[2]);\nc = mix(c, c2, 0.5);\n#else\n#ifdef exmap\nvec4 c = texture2D(uSampler, vTexCoord);\n#ifdef classmap\nint i = int(c.x*255.0);\nif (i == 1 || i == 2 || i == 5 || i == 6) c = vec4(146.0, 178.0, 144.0, 255.0);\nif (i == 3 || i == 4) c = vec4(94.0, 169.0, 133.0, 255.0);\nif (i == 8 || i == 11) c = vec4(238.0, 221.0, 185.0, 255.0);\nif (i == 7) c = vec4(226.0, 192.0, 154.0, 255.0);\nif (i == 9 || i == 10 || i == 12) c = vec4(250.0, 246.0, 167.0, 255.0);\nif (i == 13 || i == 16) c = vec4(245.0, 236.0, 211.0, 255.0);\nif (i == 14) c = vec4(139.0, 185.0, 166.0, 255.0);\nif (i == 15) c = vec4(199.0, 219.0, 155.0, 255.0);\nif (i == 17) c = vec4(149.0, 132.0, 162.0, 255.0);\nif (i == 18 || i == 0) c = vec4(188.0, 221.0, 255.0, 255.0);\nif (i == 19) c = vec4(255.0, 255.0, 255.0, 255.0);\nc = (c*(1.0/255.0)) * c2;\n#endif\n#else\nvec4 c = c2;\n#endif\n#endif\n#ifdef fog\ngl_FragColor = mix(uFogColor, c, vFogFactor);\n#else\ngl_FragColor = c;\n#endif\n}",ee.tileVertexShader="attribute vec3 aPosition;\n#ifdef onlyFog\nvarying float vFogFactor;\n#else\n#ifdef externalTex\nattribute vec2 aTexCoord2;\n#else\nattribute vec2 aTexCoord;\n#endif\nvarying vec3 vTexCoord;\n#endif\n#ifdef clip4\n#ifndef externalTex\nattribute vec2 aTexCoord2;\n#endif\nvarying vec2 vClipCoord;\n#endif\n#ifdef clip8\n#ifndef externalTex\nattribute vec2 aTexCoord2;\n#endif\nvarying vec3 vClipCoord;\nuniform mat4 uParamsC8;\nfloat getLinePointParametricDist(vec3 c, vec3 v, vec3 p) {\nvec3 w = p - c;\nfloat c1 = dot(w,v);\nif (c1 <= 0.0) return 0.0;\nfloat c2 = dot(v,v);\nif (c2 <= c1) return 1.0;\nreturn c1 / c2;\n}\n#endif\n#ifdef depth\nvarying float vDepth;\n#endif\n#ifdef flatShadeVar\nvarying vec3 vBarycentric;\n#endif\nuniform mat4 uMV, uProj, uParams;\n#ifdef applySE\nuniform mat4 uParamsSE;\n#endif\nvoid main() {\n#ifdef applySE\nvec3 geoPos2 = aPosition*vec3(uParamsSE[0][3],uParamsSE[1][0],uParamsSE[1][1]);\nvec3 geoPos = geoPos2+vec3(uParamsSE[0][0],uParamsSE[0][1],uParamsSE[0][2]);\ngeoPos.z *= uParamsSE[3][3];\nfloat ll = length(geoPos);\nvec3 v = geoPos * (1.0/(ll+0.0001));\nfloat h = ll - uParamsSE[3][2];\nfloat h2 = clamp(h, uParamsSE[2][1], uParamsSE[2][3]);\nfloat h3 = h;\nh *= (uParamsSE[2][2] + ((h2 - uParamsSE[2][1]) * uParamsSE[3][0]) * uParamsSE[3][1]);\ngeoPos2.xyz += v * (h - h3);\nvec4 camSpacePos = uMV * vec4(geoPos2, 1.0);\nfloat l = dot(v, vec3(uParams[1][0],uParams[1][1],uParams[1][2]));\n#else\nvec4 camSpacePos = uMV * vec4(aPosition, 1.0);\nvec3 worldPos = vec3(aPosition.x * uParams[0][2] + uParams[3][1], aPosition.y * uParams[0][3] + uParams[3][2], aPosition.z * uParams[3][0] + uParams[3][3]);\nfloat l = dot(normalize(worldPos.xyz), vec3(uParams[1][0],uParams[1][1],uParams[1][2]));\n#endif\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\n#ifdef depth\nvDepth = camDist;\n#endif\n#ifdef flatShadeVar\nvBarycentric = camSpacePos.xyz;\n#endif\nfloat fogFactor = 1.0-exp(uParams[0][1] * camDist);\nfogFactor = clamp((1.0-abs(l))*uParams[1][3] + fogFactor, 0.0, 1.0);\n#ifdef onlyFog\nvFogFactor = fogFactor;\n#else\nvTexCoord.z = fogFactor;\n#ifdef externalTex\nvTexCoord.xy = vec2(uParams[2][0] * aTexCoord2[0] + uParams[2][2], uParams[2][1] * aTexCoord2[1] + uParams[2][3]);\n#else\nvTexCoord.xy = aTexCoord;\n#endif\n#endif\n#ifdef clip4\nvClipCoord.xy = aTexCoord2.xy;\n#endif\n#ifdef clip8\nvec3 worldPos2 = vec3(aPosition.x * uParams[0][2] + uParamsC8[0][3], aPosition.y * uParams[0][3] + uParamsC8[1][3], aPosition.z * uParams[3][0] + uParamsC8[2][3]);\nvClipCoord.x = getLinePointParametricDist(vec3(uParamsC8[0][0],uParamsC8[0][1],uParamsC8[0][2]), vec3(uParamsC8[1][0],uParamsC8[1][1],uParamsC8[1][2]), worldPos2.xyz);\nvClipCoord.y = getLinePointParametricDist(vec3(uParamsC8[0][0],uParamsC8[0][1],uParamsC8[0][2]), vec3(uParamsC8[2][0],uParamsC8[2][1],uParamsC8[2][2]), worldPos2.xyz);\nvClipCoord.z = 1.0-getLinePointParametricDist(vec3(uParamsC8[0][0],uParamsC8[0][1],uParamsC8[0][2]), vec3(uParamsC8[3][0],uParamsC8[3][1],uParamsC8[3][2]), worldPos2.xyz);\n#endif\n}",ee.tileFragmentShader="precision mediump float;\n#ifdef clip4\nuniform float uClip[4];\nvarying vec2 vClipCoord;\n#endif\n#ifdef clip8\nuniform float uClip[8];\nvarying vec3 vClipCoord;\n#endif\n#ifdef onlyFog\nvarying float vFogFactor;\n#else\nvarying vec3 vTexCoord;\nuniform sampler2D uSampler;\n#ifdef mask\nuniform sampler2D uSampler2;\n#endif\n#endif\n#ifdef depth\nvarying float vDepth;\n#endif\n#ifdef flatShadeVar\nvarying vec3 vBarycentric;\n#ifdef fogAndColor\nuniform vec4 uColor;\n#endif\n#endif\nuniform vec4 uParams2;\nvoid main() {\n#ifdef clip4_nomargin\nif (vClipCoord.y > 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[3] == 0.0) discard;\n} else {\nif (uClip[2] == 0.0) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[1] == 0.0) discard;\n} else {\nif (uClip[0] == 0.0) discard;\n}\n}\n#endif\n#ifdef clip4\nif (vClipCoord.y > 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[3] == 0.0 && !(vClipCoord.x < TMAX && uClip[2] != 0.0) && !(vClipCoord.y < TMAX && uClip[1] != 0.0)) discard;\n} else {\nif (uClip[2] == 0.0 && !(vClipCoord.x > TMIN && uClip[3] != 0.0) && !(vClipCoord.y < TMAX && uClip[0] != 0.0)) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[1] == 0.0 && !(vClipCoord.x < TMAX && uClip[0] != 0.0) && !(vClipCoord.y > TMIN && uClip[3] != 0.0)) discard;\n} else {\nif (uClip[0] == 0.0 && !(vClipCoord.x > TMIN && uClip[1] != 0.0) && !(vClipCoord.y > TMIN && uClip[2] != 0.0)) discard;\n}\n}\n#endif\n#ifdef clip8\nif (vClipCoord.z <= 0.5){\nif (vClipCoord.y <= 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[5] == 0.0) discard;\n} else {\nif (uClip[4] == 0.0) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[7] == 0.0) discard;\n} else {\nif (uClip[6] == 0.0) discard;\n}\n}\n} else {\nif (vClipCoord.y <= 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[1] == 0.0) discard;\n} else {\nif (uClip[0] == 0.0) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[3] == 0.0) discard;\n} else {\nif (uClip[2] == 0.0) discard;\n}\n}\n}\n#endif\n#ifdef flatShadeVar\n#ifdef flatShadeVarFallback\nvec4 flatShadeData = vec4(1.0);\n#else\n#ifdef GL_OES_standard_derivatives\nvec3 nx = dFdx(vBarycentric);\nvec3 ny = dFdy(vBarycentric);\nvec3 normal=normalize(cross(nx,ny));\nvec4 flatShadeData = vec4(vec3(max(0.0,normal.z*(204.0/255.0))+(32.0/255.0)),1.0);\n#else\nvec4 flatShadeData = vec4(1.0);\n#endif\n#endif\n#endif\n#ifdef flatShade\n#ifdef fogAndColor\ngl_FragColor = vec4(uColor.xyz * flatShadeData.xyz, uColor.w);\n#else\ngl_FragColor = vec4(flatShadeData.xyz, 1.0);\n#endif\n#else\nvec4 fogColor = vec4(uParams2.xyz, 1.0);\n#ifdef onlyFog\ngl_FragColor = vec4(fogColor.xyz, vFogFactor);\n#else\n#ifdef depth\ngl_FragColor = fract(vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vDepth) + (-0.5/255.0);\n#else\n#ifdef externalTex\nvec4 c = texture2D(uSampler, vTexCoord.xy);\n__FILTER__vec4 cc = mix(c, fogColor, vTexCoord.z);\n#ifdef mask\nvec4 c2 = texture2D(uSampler2, vTexCoord.xy);\ncc.w = c.w * uParams2.w * c2.x;\n#else\ncc.w = c.w * uParams2.w;\n#endif\ngl_FragColor = cc;\n#else\ngl_FragColor = mix(texture2D(uSampler, vTexCoord.xy), fogColor, vTexCoord.z);\n#endif\n#endif\n#endif\n#endif\n}",ee.shadedMeshVertexShader="attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nuniform mat4 uMV, uProj;\nuniform mat3 uNorm;\nuniform float uFogDensity;\nvarying vec2 vTexCoord;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying float vFogFactor;\nvoid main() {\nvec4 camSpacePos = uMV * vec4(aPosition, 1.0);\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvFogFactor = exp(uFogDensity * camDist);\nvTexCoord = aTexCoord;\nvPosition = camSpacePos;\nvNormal = aNormal * uNorm;\n}",ee.shadedMeshFragmentShader="precision mediump float;\n#ifdef textured\nuniform sampler2D uSampler;\nvarying vec2 vTexCoord;\n#endif\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nuniform mat4 uMaterial;\nvarying float vFogFactor;\nuniform vec4 uFogColor;\nvoid main() {\nvec3 ldir = normalize(-vPosition.xyz);\nvec3 normal = normalize(vNormal);\nvec3 eyeDir = ldir;\nvec3 refDir = reflect(-ldir, normal);\nfloat specW = min(1.0, pow(max(dot(refDir, eyeDir), 0.0), uMaterial[3][0]));\nfloat diffW = min(1.0, max(dot(normal, ldir), 0.0));\nvec4 lcolor = uMaterial[0]+(uMaterial[1]*diffW)+(uMaterial[2]*specW);\n#ifdef textured\nvec4 tcolor = texture2D(uSampler, vTexCoord);\ngl_FragColor = mix(uFogColor, vec4(lcolor.xyz*(1.0/255.0), 1.0) * tcolor, vFogFactor); gl_FragColor.w *= uMaterial[3][1];\n#else\ngl_FragColor = mix(uFogColor, vec4(lcolor.xyz*(1.0/255.0), 1.0), vFogFactor);  gl_FragColor.w = uMaterial[3][1];\n#endif\n}",ee.tileWireFrameBasicShader="precision mediump float;\nuniform vec4 uColor;\nvoid main() {\ngl_FragColor = uColor;\n}",ee.imageVertexShader="\nattribute vec4 aPosition;\nuniform mat4 uProjectionMatrix;\nuniform mat4 uData;\nuniform vec4 uColor;\nuniform float uDepth;\nvarying vec4 vColor;\nvarying vec2 vTexcoords;\nvoid main(void){\nint i=int(aPosition.x);\nvec4 p;\nif(i==0) p = vec4(floor(uData[0][0]+0.1),floor(uData[0][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[0][2], uData[0][3]);\nif(i==1) p = vec4(floor(uData[1][0]+0.1),floor(uData[1][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[1][2], uData[1][3]);\nif(i==2) p = vec4(floor(uData[2][0]+0.1),floor(uData[2][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[2][2], uData[2][3]);\nif(i==3) p = vec4(floor(uData[3][0]+0.1),floor(uData[3][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[3][2], uData[3][3]);\ngl_Position=uProjectionMatrix*p;\nvec4 c=uColor;\nc.w*=1.0;\nvColor=c;\n}",ee.imageFragmentShader="precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTexcoords;\nuniform sampler2D uSampler;\nvoid main(void){\nvec4 c=texture2D(uSampler, vec2(vTexcoords.x, vTexcoords.y) );\nc*=vColor;\nif(c.w < 0.01){ discard; }\ngl_FragColor = c;\n}";var te=ee,re=a.b,ie=I,ae=X,se=(s.a,$),ne=te,oe=function(e,t,r){this.generateLines=!0,this.map=e,this.stats=e.stats,this.mapLoaderUrl=t,this.tile=r,this.use16bit=e.config.map16bitMeshes,this.bbox=new ie,this.size=0,this.gpuSize=0,this.fileSize=0,this.faces=0,this.cacheItem=null,this.gpuCacheItem=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.mBuffer=new Float32Array(16),this.mBuffer2=new Float32Array(16),this.vBuffer=new Float32Array(4),this.submeshes=[],this.gpuSubmeshes=[],this.submeshesKilled=!1};oe.prototype.kill=function(){this.bbox=null,this.killSubmeshes(),this.killGpuSubmeshes()},oe.prototype.killSubmeshes=function(e){for(var t=0,r=this.submeshes.length;t<r;t++)this.submeshes[t].kill();this.submeshesKilled=!0,!0!==e&&this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),0==this.gpuSubmeshes.length&&(this.loadState=0),this.cacheItem=null},oe.prototype.killGpuSubmeshes=function(e){for(var t=0,r=0,i=this.gpuSubmeshes.length;r<i;r++)this.gpuSubmeshes[r].kill(),t+=this.gpuSubmeshes[r].getSize();i>0&&(this.stats.gpuMeshes-=t,this.stats.graphsFluxMesh[1][0]++,this.stats.graphsFluxMesh[1][1]+=t),this.gpuSubmeshes=[],!0!==e&&this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.submeshesKilled&&(this.loadState=0),this.gpuCacheItem=null},oe.prototype.isReady=function(e,t,r){var i=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||i,2==this.loadState){if(this.cacheItem&&this.map.resourcesCache.updateItem(this.cacheItem),r)return!0;if(0==this.gpuSubmeshes.length){if(this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed)return!1;if(i)return!1;var a=performance.now();this.buildGpuSubmeshes(),this.stats.renderBuild+=performance.now()-a}return!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem),!0}return 0==this.loadState?e||this.scheduleLoad(t):3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t),!1},oe.prototype.scheduleLoad=function(e){this.mapLoaderUrl||(this.mapLoaderUrl=this.map.url.makeUrl(this.tile.resourceSurface.meshUrl,{lod:this.tile.id[0],ix:this.tile.id[1],iy:this.tile.id[2]})),this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),e,this.tile,"mesh")},oe.prototype.onLoad=function(e,t,r){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=r,this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"mesh"),this.loadState=1},oe.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},oe.prototype.onLoaded=function(e,t,r){if(!this.map.killed){if(!t)return this.map.markDirty(),void this.map.addProcessingTask(this.onLoaded.bind(this,e,!0,r));var i=performance.now();if(r)this.parseWorkerData(e);else{this.fileSize=e.byteLength;var a={data:new DataView(e),buffer:e,index:0};this.parseMapMesh(a)}this.map.stats.renderBuild+=performance.now()-i,this.submeshesKilled=!1,this.cacheItem=this.map.resourcesCache.insert(this.killSubmeshes.bind(this,!0),this.size),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},oe.prototype.parseWorkerData=function(e){this.faces=e.faces,this.gpuSize=e.gpuSize,this.meanUndulation=e.meanUndulation,this.numSubmeshes=e.numSubmeshes,this.size=e.size,this.version=e.version,this.submeshes=[];for(var t=e.submeshes,r=0,i=t.length;r<i;r++){var a=new ae(this),s=t[r];a.bbox.min=s.bboxMin,a.bbox.max=s.bboxMax,a.externalUVs=s.externalUVs,a.faces=s.faces,a.flags=s.flags,a.gpuSize=s.gpuSize,a.indices=s.indices,a.internalUVs=s.internalUVs,a.size=s.size,a.surfaceReference=s.surfaceReference,a.textureLayer=s.textureLayer,a.textureLayer2=s.textureLayer2,a.vertices=s.vertices,this.submeshes.push(a)}this.bbox.updateMaxSize()},oe.prototype.parseMapMesh=function(e){this.killSubmeshes();var t=e.data,r="";if(t.length<2)return!1;if(r+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,r+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,"ME"!=r)return!1;if(this.version=t.getUint16(e.index,!0),e.index+=2,this.version>3)return!1;e.uint8Data=new Uint8Array(e.buffer),this.meanUndulation=t.getFloat64(e.index,!0),e.index+=8,this.numSubmeshes=t.getUint16(e.index,!0),e.index+=2,this.submeshes=[],this.gpuSize=0,this.faces=0;for(var i=0,a=this.numSubmeshes;i<a;i++){var s=new ae(this,e);s.valid&&(this.submeshes.push(s),this.size+=s.getSize(),this.faces+=s.faces,this.gpuSize+=s.getSize())}this.numSubmeshes=this.submeshes.length},oe.prototype.addSubmesh=function(e){this.submeshes.push(e),this.size+=e.size,this.faces+=e.faces},oe.prototype.buildGpuSubmeshes=function(){var e=0;this.gpuSubmeshes=new Array(this.submeshes.length);for(var t=0,r=this.submeshes.length;t<r;t++)this.gpuSubmeshes[t]=this.submeshes[t].buildGpuMesh(),e+=this.gpuSubmeshes[t].getSize();this.stats.gpuMeshes+=e,this.stats.graphsFluxMesh[0][0]++,this.stats.graphsFluxMesh[0][1]+=e,this.gpuCacheItem=this.map.gpuCache.insert(this.killGpuSubmeshes.bind(this,!0),e),this.gpuSize=e},oe.prototype.generateTileShader=function(e,t,r,i){var a="";i&&(this.map.config.mapSplitMargin?(4==i.length?a+="#define clip4\n":a+="#define clip8\n",a+="#define TMIN "+(.5-this.map.config.mapSplitMargin)+"\n#define TMAX "+(.5+this.map.config.mapSplitMargin)+"\n"):4==i.length?a+="#define clip4_nomargin\n":a+="#define clip8\n"),r&&(a+="#define applySE\n");var s=new se(this.map.renderer.gpu,e[0].vertex.replace("#define variants\n",a),e[0].fragment.replace("#define variants\n",a));return e[t]=s,s},oe.prototype.drawSubmesh=function(e,t,r,i,a,s,n,o,h){null!=this.gpuSubmeshes[t]||null==this.submeshes[t]||this.submeshes[t].killed||(this.gpuSubmeshes[t]=this.submeshes[t].buildGpuMesh());var l=this.submeshes[t],u=this.gpuSubmeshes[t];if(u){var d=this.map.renderer,c=this.map.draw,p=null,f=null,m=null,g=null,v=c.debug.drawWireframe,y=d.useSuperElevation,b=["aPosition"],x=y?4:0;if(o&&(x|=1,6!=i&&5!=i&&(g="aTexCoord2",b.push("aTexCoord2"))),r&&c.debug.meshStats&&(l.uvAreaComputed||l.computeUVArea(r.getGpuTexture()),this.stats.meshesUVArea+=l.uvArea,this.stats.meshesFaces+=l.faces),1==i)(p=d.progDepthTile[x])||(p=this.generateTileShader(d.progDepthTile,x,y,o));else if(2==i)(p=d.progFlatShadeTile[x])||(p=this.generateTileShader(d.progFlatShadeTile,x,y,o));else{if(v>0&&3==i)return;if(1==v||3==v)(p=d.progFlatShadeTile[x])||(p=this.generateTileShader(d.progFlatShadeTile,x,y,o));else switch(i){case 4:case 5:m="aTexCoord",b.push("aTexCoord"),(p=d.progTile[x])||(p=this.generateTileShader(d.progTile,x,y,o));break;case 6:case 7:var S,M,w=d.progTile2;if(r&&(f=r.getGpuMaskTexture())&&(w=d.progTile3),(p=w[x])||(p=this.generateTileShader(w,x,y,o)),s&&(s.shaderFilters||s.shaderFilter))if(n&&s.shaderFilters&&(S=s.shaderFilters[n.id])&&(S.varFlatShade&&(M=!0),S=S.filter),S||(S=s.shaderFilter),S){var T=f?"progTile3":"progTile2";if(y&&(T+="se"),M&&(T+="fs"),o&&(T+="c4"),T+=S,!(p=(d=this.map.renderer).progMap[T])){var A,C=d.gpu,F="";o&&(this.map.config.mapSplitMargin?(F+="#define clip4\n",F+="#define TMIN "+(.5-this.map.config.mapSplitMargin)+"\n#define TMAX "+(.5+this.map.config.mapSplitMargin)+"\n"):F+="#define clip4_nomargin\n");var P="#define externalTex\n"+F+(y?"#define applySE\n":"")+ne.tileVertexShader;A=f?"#define externalTex\n#define mask\n"+F+ne.tileFragmentShader:"#define externalTex\n"+F+ne.tileFragmentShader,M&&(P="#define flatShadeVar\n"+P,A=(A="#extension GL_OES_standard_derivatives : enable\n#define flatShadeVar\n"+A).replace("mediump","highp")),p=new se(C,P,A.replace("__FILTER__",S)),d.progMap[T]=p}}g="aTexCoord2",b.push("aTexCoord2");break;case 3:(p=d.progFogTile[x])||(p=this.generateTileShader(d.progFogTile,x,y,o))}}if(p&&p.isReady()){if(d.gpu.useProgram(p,b,f),r){var L=r.getGpuTexture();if(!L)return;r.statsCoutner!=this.stats.counter&&(r.statsCoutner=this.stats.counter,this.stats.gpuRenderUsed+=L.getSize()),d.gpu.bindTexture(L),f&&d.gpu.bindTexture(f,1)}else if(3!=i&&1!=i&&2!=i)return;var E=this.mBuffer,N=this.mBuffer2;x=this.vBuffer;if(y){N=this.mBuffer;var B=d.superElevation;N[0]=l.bbox.min[0],N[1]=l.bbox.min[1],N[2]=l.bbox.min[2],N[3]=l.bbox.side(0),N[4]=l.bbox.side(1),N[5]=l.bbox.side(2),N[9]=B[0],N[10]=B[1],N[11]=B[2],N[12]=B[6],N[13]=B[5],N[14]=d.earthRadius,N[15]=d.earthERatio,p.setMat4("uParamsSE",N),re.multiply(d.camera.getModelviewFMatrix(),l.getWorldMatrixSE(e,N),E)}else re.multiply(d.camera.getModelviewFMatrix(),l.getWorldMatrix(e,N),E);var I=d.camera.getProjectionFMatrix();if(p.setMat4("uMV",E),c.zbufferOffset?p.setMat4("uProj",I,d.getZoffsetFactor(c.zbufferOffset)):p.setMat4("uProj",I),o){p.setFloatArray("uClip",o);var k=this.map.camera.position,R=h;if(h){N[0]=R[0][0]-k[0],N[1]=R[0][1]-k[1],N[2]=R[0][2]-k[2],N[4]=R[1][0]-R[0][0],N[5]=R[1][1]-R[0][1],N[6]=R[1][2]-R[0][2],N[8]=R[2][0]-R[1][0],N[9]=R[2][1]-R[1][1],N[10]=R[2][2]-R[1][2],N[12]=R[4][0]-R[0][0],N[13]=R[4][1]-R[0][1],N[14]=R[4][2]-R[0][2];var _=l.bbox.min,z=l.bbox.max;N[3]=_[0]-k[0],N[7]=_[1]-k[1],N[11]=_[2]-k[2],p.setMat4("uParamsC8",N)}}if(0==v){var U,D=this.map.camera.vector2,O=c.atmoColor;_=l.bbox.min,z=l.bbox.max;switch(i){case 4:case 3:case 5:N[0]=c.zFactor,N[1]=5==i?0:c.fogDensity,N[2]=z[0]-_[0],N[3]=z[1]-_[1],N[4]=D[0],N[5]=D[1],N[6]=D[2],N[7]=D[3],N[12]=z[2]-_[2],N[13]=_[0],N[14]=_[1],N[15]=_[2],p.setMat4("uParams",N),x[0]=O[0],x[1]=O[1],x[2]=O[2],p.setVec4("uParams2",x);break;case 6:case 7:U=r.getTransform(),N[0]=c.zFactor,N[1]=6==i?c.fogDensity:0,N[2]=z[0]-_[0],N[3]=z[1]-_[1],N[4]=D[0],N[5]=D[1],N[6]=D[2],N[7]=D[3],N[8]=U[0],N[9]=U[1],N[10]=U[2],N[11]=U[3],N[12]=z[2]-_[2],N[13]=_[0],N[14]=_[1],N[15]=_[2],p.setMat4("uParams",N),x[0]=O[0],x[1]=O[1],x[2]=O[2],x[3]=6==i?1:a,p.setVec4("uParams2",x)}}if(l.statsCoutner!=this.stats.counter&&(l.statsCoutner=this.stats.counter,this.stats.gpuRenderUsed+=u.getSize()),u.draw(p,"aPosition",m,g,0!=v?"aBarycentric":null,2==v),1==v||2==v){(p=d.progWireFrameBasic[x])||(p=this.generateTileShader(d.progWireFrameBasic,x,y,o)),d.gpu.useProgram(p,b,f),y&&p.setMat4("uParamsSE",N),p.setMat4("uMV",E),p.setVec4("uColor",[0,0,0,1]),p.setMat4("uProj",I,d.getZoffsetFactor([-.001,0,0])),o&&p.setFloatArray("uClip",o);var V=u.gl;if(u.indexBuffer)for(var G=0,j=2*u.indexBuffer.numItems;G<j;G+=3)V.drawElements(V.LINE_LOOP,3,V.UNSIGNED_SHORT,G);else for(G=0,j=2*u.vertexBuffer.numItems;G<j;G+=3)V.drawArrays(V.LINE_LOOP,G,3)}this.stats.drawnFaces+=this.faces,this.stats.drawCalls++}}};var he=oe,le=a.d,ue=function(e,t){switch(this.map=e,this.data=t,this.camera=e.camera,this.renderer=e.renderer,t.type){case"point-geometry":this.type=1,this.vertexBuffer=this.data.geometryBuffer;break;case"line-geometry":this.type=2,this.vertexBuffer=this.data.geometryBuffer,this.indicesBuffer=this.data.indicesBuffer;break;case"polygon-geometry":this.type=3,this.vertexBuffer=this.data.geometryBuffer,this.surface=this.data.surface,this.borders=this.data.borders}};ue.prototype.getType=function(){switch(this.type){case 1:return"point";case 2:return"line";case 3:return"polygon"}},ue.prototype.getElement=function(e){var t=this.vertexBuffer,r=3*e;switch(this.type){case 1:return[t[r],t[r+1],t[r+2]];case 2:return[[t[r],t[r+1],t[r+2]],[t[r+3],t[r+4],t[r+5]]];case 3:var i=this.surface,a=i[r],s=i[r+1],n=i[r+2];return[[t[a][0],t[a][1],t[a][2]],[t[s][0],t[s][1],t[s][2]],[t[n][0],t[n][1],t[n][2]]]}},ue.prototype.getElements=function(e){switch(this.type){case 1:case 3:return this.surface.length/3;case 2:e=e||0;var t=3*this.indicesBuffer[e],r=e+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[e];return Math.max(0,(r-t)/3-1)}},ue.prototype.getRelationToCanvasPoint=function(e,t,r){var i,a,s,n,o,h,l,u,d,c,p,f,m=this.vertexBuffer,g=3*e;switch(i=this.camera.position,a=this.renderer.getScreenRay(t,r),this.type){case 1:var v,y=[(v=[m[g],m[g+1],m[g+2]])[0]-o[0],v[0]-o[0]];return le.cross(a,y,[0,0,0]),{distance:h=le.length(v),point:v};case 2:var b=[m[g],m[g+1],m[g+2]],x=[m[g+3],m[g+4],m[g+5]];p=a,m=[x[0]-b[0],x[1]-b[1],x[2]-b[2]],f=[i[0]-b[0],i[1]-b[1],i[2]-b[2]],s=le.dot(p,p),n=le.dot(p,m),o=le.dot(m,m),h=le.dot(p,f),l=le.dot(m,f),(u=s*o-n*n)<1e-7?(d=0,c=n>o?h/n:l/o):(d=(n*l-o*h)/u,c=(s*l-n*h)/u);var S=[f[0]+p[0]*d-m[0]*c,f[1]+p[1]*d-m[1]*c,f[2]+p[2]*d-m[2]*c];return{closest:[b[0]+m[0]*c,b[1]+m[1]*c,b[2]+m[2]*c],"line-distance":le.length(S),distance:c,line:[b,x]}}},ue.prototype.getPathElement=function(e,t){if(2!=this.type)return null;var r=3*(this.indicesBuffer[t||0]+e),i=this.vertexBuffer;return[[i[r],i[r+1],i[r+2]],[i[r+3],i[r+4],i[r+5]]]},ue.prototype.getPathPoint=function(e,t){t=t||0;for(var r,i,a=3*this.indicesBuffer[t],s=t+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[t],n=0,o=this.vertexBuffer,h=a;h<s-3;h+=3){if(r=[o[h+3]-o[h],o[h+4]-o[h+1],o[h+5]-o[h+2]],n+(i=le.length(r))>e){var l=(e-n)/i;return[o[h]+r[0]*l,o[h+1]+r[1]*l,o[h+2]+r[2]*l]}n+=i}return[o[s-3],o[s-2],o[s-1]]},ue.prototype.getPathNED=function(e,t,r){r=r||0;for(var i,a,s,n=3*this.indicesBuffer[r],o=r+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[r],h=0,l=this.vertexBuffer,u=n;u<o-5;u+=3){if(a=[l[u+3]-l[u],l[u+4]-l[u+1],l[u+5]-l[u+2]],h+(s=le.length(a))>e){var c=(h+s)/e;i=[l[u]+d[0]*c,l[u+1]+d[1]*c,l[u+2]+d[2]*c];break}h+=s}i||(i=[l[o-3],l[o-2],l[o-1]]);var p=[0,0,0],f=[0,0,0],m=[0,0,0];le.nomalize(a,p),le.nomalize(i,m),le.cross(m,p,f),t&&le.cross(m,f,p);return{east:f,direction:p,north:m,position:i,matrix:[f[0],f[1],f[2],0,m[0],m[1],m[2],0,p[0],p[1],p[2],0,0,0,0,1]}},ue.prototype.getPathLengthToElement=function(e,t){t=t||0;for(var r,i,a=3*this.indicesBuffer[t],s=t+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[t],n=0,o=this.vertexBuffer,h=0,l=a;l<s-5;l+=3){if(r=[o[l+3]-o[l],o[l+4]-o[l+1],o[l+5]-o[l+2]],i=le.length(r),e==h)return{lengthToElement:n,elementLengh:i};h++,n+=i}return n},ue.prototype.getPathLength=function(e){e=e||0;for(var t,r=3*this.indicesBuffer[e],i=e+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[e],a=0,s=this.vertexBuffer,n=r;n<i-5;n+=3)t=[s[n+3]-s[n],s[n+4]-s[n+1],s[n+5]-s[n+2]],a+=le.length(t);return a},ue.prototype.getPathsCount=function(){return 2!=this.type?0:this.indicesBuffer.length},ue.prototype.getSurfaceArea=function(){if(3!=this.type)return 0;if(!this.surfaceArea){var e,t,r,i,a,s,n,o,h,l,u,d=this.vertexBuffer,c=this.surface;this.surfaceArea=0;for(var p=0,f=c.length;p<f;p+=3)e=d[c[p]],t=d[c[p+1]],r=d[c[p+2]],n=t[0]-e[0],o=t[1]-e[1],h=t[2]-e[2],i=Math.sqrt(n*n+o*o+h*h),n=t[0]-r[0],o=t[1]-r[1],h=t[2]-r[2],a=Math.sqrt(n*n+o*o+h*h),n=r[0]-e[0],o=r[1]-e[1],h=r[2]-e[2],l=(i+a+(s=Math.sqrt(n*n+o*o+h*h)))/2,u=Math.sqrt(l*((l-i)*(l-a)*(l-s))),this.surfaceArea+=u}return this.surfaceArea};var de=ue,ce=function(e,t,r,i){this.builder=e,this.map=e.map,this.heightMode=t||"float",this.srs=r,i=i||{},this.groupIdPrefix=i.groupIdPrefix||"",this.dontCreateGroups=i.dontCreateGroups,this.tesselation=i.tesselation};ce.prototype.processGeometry=function(e,t){var r=e.coordinates;if(r)switch(e.type){case"Point":this.builder.addPoint(r,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"MultiPoint":this.builder.addPointArray(r,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"LineString":this.builder.addLineString(r,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"MultiLineString":this.builder.addLineStringArray(r,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"Polygon":r.length>0&&this.builder.addPolygon(r[0],r.length>1?r.slice(1):[],null,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs,this.tesselation);break;case"MultiPolygon":for(var i=0,a=r.length;i<a;i++){var s=r[i];s.length>0&&this.builder.addPolygon(s[0],s.length>1?s.slice(1):[],null,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs,this.tesselation)}break;case"GeometryCollection":var n=e.gemetries;if(n)for(i=0,a=n.length;i<a;i++)this.processGeometry(n[i],t)}},ce.prototype.processFeature=function(e){var t=e.geometry;t&&this.processGeometry(t,e)},ce.prototype.processCollection=function(e){var t=e.features;if(t)for(var r=0,i=t.length;r<i;r++)this.processFeature(t[r])},ce.prototype.processJSON=function(e){if(e)if(e.type)switch(e.type){case"FeatureCollection":this.dontCreateGroups||this.builder.addGroup(""!=this.groupIdPrefix?this.groupIdPrefix:null),this.processCollection(e);break;case"Feature":this.dontCreateGroups||this.builder.addGroup(""!=this.groupIdPrefix?this.groupIdPrefix:null),this.processFeature(e)}else for(var t in e){var r=e[t];switch(this.dontCreateGroups||this.builder.addGroup(this.groupIdPrefix+t),e.type){case"FeatureCollection":this.processCollection(r);break;case"Feature":this.processFeature(r)}}};var pe=ce,fe=function(e,t,r){this.builder=e,this.map=e.map,this.groupIdPrefix=t||"",this.dontCreateGroups=r};fe.prototype.processJSON=function(e){if(e){var t,r,i,a,s,n,o,h,l,u=e.groups,d=this.builder;if(u)for(t=0,r=u.length;t<r;t++){var c=u[t],p=c.bbox,f=c.resolution;if(p&&f){var m=p[0],g=p[1];if(m&&g){this.dontCreateGroups||d.addGroup(this.groupIdPrefix+(c.id||""));var v=(g[0]-m[0])/f,y=(g[1]-m[1])/f,b=(g[2]-m[2])/f,x=c.points;if(x)for(l=x.points,i=0,a=x.length;i<a;i++){var S=x[i],M=S.points,w=new Array(M.length);for(s=0,n=M.length;s<n;s++)o=M[s],w[s]=[m[0]+o[0]*v,m[1]+o[1]*y,m[2]+o[2]*b];d.addPointArray(w,"fix",S.properties,S.id,null,!0)}var T=c.lines;if(T)for(i=0,a=T.length;i<a;i++){var A=T[i],C=A.lines,F=new Array(C.length);for(s=0,n=C.length;s<n;s++){l=C[s],h=new Array(l.length);for(var P=0,L=l.length;P<L;P++)o=l[P],h[P]=[m[0]+o[0]*v,m[1]+o[1]*y,m[2]+o[2]*b];F[s]=h}d.addLineStringArray(F,"fix",A.properties,A.id,null,!0)}var E=c.polygons;if(E){var N={sx:v,sy:y,sz:b,px:m[0],py:m[1],pz:m[2]};for(i=0,a=E.length;i<a;i++){var B=E[i];d.addPolygonRAW(B.vertices,B.surface,B.borders,B.middle,"fix",B.properties,B.id,null,!0,N)}}}}}}};var me=fe,ge=r(3),ve=p.a,ye=a.d,be=s.a,xe=ge.a,Se=function(e,t){this.builder=e,this.map=e.map,this.navSrs=this.map.getNavigationSrs(),this.physSrs=this.map.getPhysicalSrs(),this.srs=this.navSrs,this.rootPath="",this.filesToLoad=0};Se.prototype.processNode=function(e,t,r){var i,a=t.boundingVolume;if(a&&a.region){var s=a.region,n=[ve.degrees(s[0]),ve.degrees(s[1]),s[4]],o=[ve.degrees(s[2]),ve.degrees(s[3]),s[5]],h=[];h[0]=this.physSrs.convertCoordsFrom([n[0],o[1],o[2]],this.srs),h[1]=this.physSrs.convertCoordsFrom([o[0],o[1],o[2]],this.srs),h[2]=this.physSrs.convertCoordsFrom([o[0],n[1],o[2]],this.srs),h[3]=this.physSrs.convertCoordsFrom([n[0],n[1],o[2]],this.srs),h[4]=this.physSrs.convertCoordsFrom([n[0],o[1],n[2]],this.srs),h[5]=this.physSrs.convertCoordsFrom([o[0],o[1],n[2]],this.srs),h[6]=this.physSrs.convertCoordsFrom([o[0],n[1],n[2]],this.srs),h[7]=this.physSrs.convertCoordsFrom([n[0],n[1],n[2]],this.srs);var l=[(h[0][0]+h[1][0]+h[2][0]+h[3][0]+h[4][0]+h[5][0]+h[6][0]+h[7][0])/8,(h[0][1]+h[1][1]+h[2][1]+h[3][1]+h[4][1]+h[5][1]+h[6][1]+h[7][1])/8,(h[0][2]+h[1][2]+h[2][2]+h[3][2]+h[4][2]+h[5][2]+h[6][2]+h[7][2])/8];i={points:h,center:l,radius:ye.length([h[0][0]-l[0],h[0][1]-l[1],h[0][2]-l[2]]),halfAxis:[[.5*(h[1][0]-h[0][0]),.5*(h[1][1]-h[0][1]),.5*(h[1][2]-h[0][2])],[.5*(h[2][0]-h[1][0]),.5*(h[2][1]-h[1][1]),.5*(h[2][2]-h[1][2])],[.5*(h[4][0]-h[0][0]),.5*(h[4][1]-h[0][1]),.5*(h[4][2]-h[0][2])]]}}var u=t.geometricError;r||(e=this.builder.addNode(e,i,u,r));var d=t.content;if(d&&d.uri){var c=d.uri;-1!=(c=xe.getProcessUrl(c,this.rootPath)).indexOf(".json")?this.baseOptions.gradualJSONLoader?this.builder.addLoadNode(e,c):this.loadJSON(c,{internal:!0,node:e}):-1!=c.indexOf(".mesh")&&this.builder.addMesh(e,c)}var p=t.children;if(p)for(var f=0,m=p.length;f<m;f++)this.processNode(e,p[f])},Se.prototype.processJSON=function(e){e&&(this.rootPath=rootPath||"",this.processNode(null,e.root))},Se.prototype.loadJSON=function(e,t,r){this.filesToLoad++,(t=t||{}).internal||(this.onFinished=r,this.baseOptions=t,t={internal:!0,node:null}),be.loadJSON(e,this.onLoaded.bind(this,e,t),this.onError.bind(this,t))},Se.prototype.onLoaded=function(e,t,r){this.rootPath=xe.makeAbsolute(e),this.rootPath=xe.getBase(this.rootPath),this.processNode(t.node,r.root,!!t.node),this.filesToLoad--,!this.filesToLoad&&this.onFinished&&this.onFinished()},Se.prototype.onError=function(){this.filesToLoad--,!this.filesToLoad&&this.onFinished&&this.onFinished()};var Me=Se,we=de,Te=pe,Ae=me,Ce=Me,Fe=a.d,Pe=(a.b,function(e){this.map=e,this.groups=[],this.nodes=[],this.currentGroup=null,this.bboxMin=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],this.bboxMax=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],this.navSrs=this.map.getNavigationSrs(),this.physSrs=this.map.getPhysicalSrs(),this.heightsToProcess=0,this.heightsProcessBuffer=null,this.heightsProcessBufferFirst=null,this.heightsProcessBufferLast=null,this.heightsLod=8,this.heightsSource="heightmap-by-precision",this.updateCallback=null,this.processingHeights=!1,this.processHeightsCalls=[]});Pe.prototype.addToHeightsBuffer=function(e){var t={coords:e,prev:null,next:this.heightsProcessBufferFirst};null!=this.heightsProcessBufferFirst&&(this.heightsProcessBufferFirst.prev=t),this.heightsProcessBufferFirst=t,null==this.heightsProcessBufferLast&&(this.heightsProcessBufferLast=t)},Pe.prototype.removeFromHeightsBuffer=function(e){var t=!1;e==this.heightsProcessBufferFirst&&(this.heightsProcessBufferFirst=e.next,t=!0,null!=this.heightsProcessBufferFirst&&(this.heightsProcessBufferFirst.prev=null)),e==this.heightsProcessBufferLast&&(this.heightsProcessBufferLast=e.prev,t=!0,null!=this.heightsProcessBufferLast&&(this.heightsProcessBufferLast.next=null)),t||(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev))},Pe.prototype.addGroup=function(e){return this.groups.push({points:[],lines:[],polygons:[],id:e}),this.currentGroup=this.groups[this.groups.length-1],this},Pe.prototype.addNode=function(e,t,r,i){var a={meshes:[],precision:r,volume:t,tileset:!!i,nodes:[]};return e||(e=this),e.nodes.push(a),a},Pe.prototype.addMesh=function(e,t){e&&e.meshes.push(t)},Pe.prototype.addLoadNode=function(e,t){e&&(e.loadNodes||(e.loadNodes=[]),e.loadNodes.push(t))},Pe.prototype.addPoint=function(e,t,r,i,a,s){this.currentGroup||this.addGroup("some-group");var n,o={id:i,properties:r};return!t||"float"==t?(n=[e[0],e[1],e[2]||0,o,null,null],this.addToHeightsBuffer(n),o.points=[n],o.floatHeights=!0,o.srs=a||this.navSrs,o.heightsToProcess=1,this.heightsToProcess++):o.points=s?[[e[0],e[1],e[2]]]:[this.physSrs.convertCoordsFrom(e,a||this.navSrs)],this.currentGroup.points.push(o),this},Pe.prototype.addPointArray=function(e,t,r,i,a,s){this.currentGroup||this.addGroup("some-group");var n,o,h,l,u=!t||"float"==t;a=a||this.navSrs;var d={id:i,properties:r},c=new Array(e.length);if(u){for(n=0,o=e.length;n<o;n++)l=[(h=e[n])[0],h[1],h[2]||0,d,null,null],this.addToHeightsBuffer(l),c[n]=l;d.floatHeights=!0,d.srs=a,d.heightsToProcess=o,this.heightsToProcess++}else if(s)for(n=0,o=e.length;n<o;n++)h=e[n],c[n]=[h[0],h[1],h[2]];else for(n=0,o=e.length;n<o;n++)c[n]=this.physSrs.convertCoordsFrom(e[n],a);return d.points=c,this.currentGroup.points.push(d),this},Pe.prototype.addLineString=function(e,t,r,i,a,s){this.currentGroup||this.addGroup("some-group");var n,o,h,l,u=!t||"float"==t;a=a||this.navSrs;var d={id:i,properties:r},c=new Array(e.length);if(u){for(n=0,o=e.length;n<o;n++)l=[(h=e[n])[0],h[1],h[2]||0,d,null,null],this.addToHeightsBuffer(l),c[n]=l;d.floatHeights=!0,d.srs=a,d.heightsToProcess=o,this.heightsToProcess+=o}else if(s)for(n=0,o=e.length;n<o;n++)h=e[n],c[n]=[h[0],h[1],h[2]];else for(n=0,o=e.length;n<o;n++)c[n]=this.physSrs.convertCoordsFrom(e[n],a);return d.lines=[c],this.currentGroup.lines.push(d),this},Pe.prototype.addLineStringArray=function(e,t,r,i,a,s){this.currentGroup||this.addGroup("some-group");var n,o,h,l,u,d,c,p,f=!t||"float"==t;a=a||this.navSrs;var m={id:i,properties:r},g=new Array(e.length);if(f){var v=0;for(h=0,l=e.length;h<l;h++){for(n=e[h],o=new Array(n.length),u=0,d=n.length;u<d;u++)p=[(c=n[u])[0],c[1],c[2]||0,m,null,null],this.addToHeightsBuffer(p),o[u]=p;v+=d,g[h]=o}m.floatHeights=!0,m.srs=a,m.heightsToProcess=v,this.heightsToProcess+=v}else for(h=0,l=e.length;h<l;h++){if(n=e[h],o=new Array(n.length),s)for(u=0,d=n.length;u<d;u++)c=n[u],o[u]=[c[0],c[1],c[2]];else for(u=0,d=n.length;u<d;u++)o[u]=this.physSrs.convertCoordsFrom(n[u],a);g[h]=o}return m.lines=g,this.currentGroup.lines.push(m),this},Pe.prototype.addPolygon=function(e,t,r,i,a,s,n,o){return this.addPolygon3(e,t,r,i,a,s,n,o)},Pe.prototype.getPolygonCenter=function(e,t,r){if(e&&!e.length)return[0,0];var i=0,a=0,s=0;if(t){for(var n=0,o=e.length;n<o;n++){i+=(h=e[n])[0],a+=h[1],s+=h[2]}return[i/o,a/o,s/o]}for(n=0,o=e.length;n<o;n++){var h=e[n],l=r.forward(h);i+=l[0],a+=l[1],s+=l[2]}var u=i/o,d=a/o,c=s/o;return[(h=r.inverse([u,d,c]))[0],h[1],0]},Pe.prototype.insidePolygon=function(e,t,r){for(var i=e[0],a=e[1],s=!1,n=0,o=(r=r||Math.round(t.length/3))-1,h=r;n<h;o=n++){var l=t[3*n],u=t[3*n+1],d=t[3*o],c=t[3*o+1];u>a!=c>a&&i<(d-l)*(a-u)/(c-u)+l&&(s=!s)}return s},Pe.prototype.addPolygon3=function(e,t,r,i,a,s,n,o){n=n||this.navSrs.srsProj4;var h,l,u,d,c,p,f,m,g,v,y,b,x,S,M,w=e,T=(t=t||[],[]),A=[],C=!0,F=0,P=t.length;(o=o||{}).mode=o.mode||"auto","by-length"==o.mode&&(o.length=o.length||2e5);-1!=n.indexOf("+proj=longlat")&&(C=!1,g=this.map.proj4(n,"+proj=geocent +datum=WGS84 +units=m +no_defs"));var L=3*e.length;for(h=0,l=e.length;h<l;h++)e[h][2]=e[h][2]||0;for(h=0,l=t.length;h<l;h++)for(L+=3*(m=t[h]).length,u=0,d=m.length;u<d;u++)m[u][2]=m[u][2]||0;var E,N,B,I=this.getPolygonCenter(e,C,g),k=this.map.measure.getNewNED(I);B=k.direction,E=k.direction,N=k.east,w=new Array(L),y=new Array(L),u=0;var R,_=new Array(t.length+1),z=new Array(e.length);for(_[0]=z,R=g?g.forward(I):I,h=0,l=e.length;h<l;h++)z[h]=h,T=e[h],y[u]=T[0],y[u+1]=T[1],y[u+2]=T[2],g?(A=g.forward(e[h]),T=[N[0]*A[0]+N[1]*A[1]+N[2]*A[2],E[0]*A[0]+E[1]*A[1]+E[2]*A[2],0]):T=A=e[h],(M=(b=A[0]-R[0])*b+(x=A[1]-R[1])*x+(S=A[2]-R[2])*S)>F&&(F=M,e[h]),w[u]=T[0],w[u+1]=T[1],w[u+2]=T[2],u+=3;var U,D,O,V,G,j=0;for(h=0,l=3*e.length;h<l;h+=3)U=w[h],D=w[h+1],h<l-3?(O=w[h+3],V=w[h+4]):(O=w[0],V=w[1]),j+=U*V,j-=O*D;if(j<0){var H=y.slice(),q=w.slice();for(h=0,l=3*e.length;h<l;h+=3)y[h]=H[l-h-3],y[h+1]=H[l-h-2],y[h+2]=H[l-h-1],w[h]=q[l-h-3],w[h+1]=q[l-h-2],w[h+2]=q[l-h-1]}for(new Array(t.length),v=new Array(t.length),h=0,l=t.length;h<l;h++){for(m=t[h],G=Math.round(u/3),v[h]=G,h<P&&(z=new Array(m.length),_[h+1]=z),f=G,c=0,p=m.length;c<p;c++)T=m[c],y[u]=T[0],y[u+1]=T[1],y[u+2]=T[2],g?(A=g.forward(m[c]),T=[N[0]*A[0]+N[1]*A[1]+N[2]*A[2],B[0]*A[0]+B[1]*A[1]+B[2]*A[2],0]):T=m[c],w[u]=T[0],w[u+1]=T[1],w[u+2]=T[2],u+=3,h<P&&(z[c]=f,f++);for(j=0,G*=3,c=0,p=3*m.length;c<p;c+=3)U=w[G+c],D=w[G+c+1],c<p-3?(O=w[G+c+3],V=w[G+c+4]):(O=w[G+0],V=w[G+1]),j+=U*V,j-=O*D;if(j>0){H=y.slice(),q=w.slice();for(c=0,p=3*m.length;c<p;c+=3)y[G+c]=H[G+p-c-3],y[G+c+1]=H[G+p-c-2],y[G+c+2]=H[G+p-c-1],w[G+c]=q[G+p-c-3],w[G+c+1]=q[G+p-c-2],w[G+c+2]=q[G+p-c-1]}}var W,J,Z,Y,K,X,Q,$,ee,te=vts.earcut(w,v,3),re=Number.POSITIVE_INFINITY;switch(o.mode){case"auto":re=Math.sqrt(F)/19;break;case"by-length":re=o.length}var ie,ae=new Array(_.length);for(h=0,l=_.length;h<l;h++)ae[h]=_[h].slice();var se,ne,oe,he,le,ue,de=new Array(196608),ce=new Array(196608),pe=new Array(196608),fe=0,me=0,ge=0,ve=new Array(196608);for(h=0,l=y.length;h<l;h+=3)ve[h]=y[h],ve[h+1]=y[h+1],ve[h+2]=y[h+2];var ye=Math.round(l/3),be=re;for(h=0,l=te.length;h<l;h+=3){W=te[h],J=te[h+1],Z=te[h+2],fe=3;var xe=null,Se=null,Me=null;for(u=0,d=_.length;u<d;u++)for(z=_[u],ie=ae[u],c=0,p=z.length;c<p;c++){var we=c<z.length-1?c+1:0;(W==z[c]&&J==z[we]||W==z[we]&&J==z[c])&&(ie[c]=[z[c]],xe=ie[c]),(J==z[c]&&Z==z[we]||J==z[we]&&Z==z[c])&&(ie[c]=[z[c]],Se=ie[c]),(Z==z[c]&&W==z[we]||W==z[we]&&Z==z[c])&&(ie[c]=[z[c]],Me=ie[c])}de[0]=[W,xe],de[1]=[J,Se],de[2]=[Z,Me];do{for(u=0,d=fe;u<d;u+=3)if(he=de[u][0],le=de[u+1][0],ue=de[u+2][0],xe=de[u][1],Se=de[u+1][1],Me=de[u+2][1],Y=[ve[3*he],ve[3*he+1],ve[3*he+2]],K=[ve[3*le],ve[3*le+1],ve[3*le+2]],X=[ve[3*ue],ve[3*ue+1],ve[3*ue+2]],g&&(Y=g.forward(Y),K=g.forward(K),X=g.forward(X)),se=Fe.length([Y[0]-K[0],Y[1]-K[1],Y[2]-K[2]]),ne=Fe.length([K[0]-X[0],K[1]-X[1],K[2]-X[2]]),oe=Fe.length([X[0]-Y[0],X[1]-Y[1],X[2]-Y[2]]),(f=Math.max(se,ne,oe))<re)pe[ge]=he,pe[ge+1]=le,pe[ge+2]=ue,ge+=3;else{Q=[.5*(Y[0]+K[0]),.5*(Y[1]+K[1]),.5*(Y[2]+K[2])],g&&((Q=g.inverse(Q))[2]=.5*(ve[3*he+2]+ve[3*le+2])),$=[.5*(K[0]+X[0]),.5*(K[1]+X[1]),.5*(K[2]+X[2])],g&&(($=g.inverse($))[2]=.5*(ve[3*le+2]+ve[3*ue+2])),ee=[.5*(X[0]+Y[0]),.5*(X[1]+Y[1]),.5*(X[2]+Y[2])],g&&((ee=g.inverse(ee))[2]=.5*(ve[3*ue+2]+ve[3*he+2]));var Te=3*ye;se==f?(ve[Te]=Q[0],ve[Te+1]=Q[1],ve[Te+2]=Q[2],xe&&(xe[0]=[[xe[0]],[-ye]],xe=xe[0]),ce[f=me]=[he,xe?xe[0]:null],ce[f+1]=[ye,null],ce[f+2]=[ue,Me||null],ce[f+3]=[ye,xe?xe[1]:null],ce[f+4]=[le,Se||null],ce[f+5]=[ue,null]):ne==f?(ve[Te]=$[0],ve[Te+1]=$[1],ve[Te+2]=$[2],Se&&(Se[0]=[[Se[0]],[-ye]],Se=Se[0]),ce[f=me]=[he,xe||null],ce[f+1]=[le,Se?Se[0]:null],ce[f+2]=[ye,null],ce[f+3]=[ye,Se?Se[1]:null],ce[f+4]=[ue,Me||null],ce[f+5]=[he,null]):oe==f&&(ve[Te]=ee[0],ve[Te+1]=ee[1],ve[Te+2]=ee[2],Me&&(Me[0]=[[Me[0]],[-ye]],Me=Me[0]),ce[f=me]=[he,xe||null],ce[f+1]=[le,null],ce[f+2]=[ye,Me?Me[1]:null],ce[f+3]=[ye,null],ce[f+4]=[le,Se||null],ce[f+5]=[ue,Me?Me[0]:null]),ye+=1,me+=6}var Ae=de;de=ce,ce=Ae,fe=me,me=0}while(fe>0);re=be}var Ce=new Array(196608),Pe=0,Le=function(e){for(var t=0,r=e.length;t<r;t++)Array.isArray(e[t])?Le(e[t]):(Ce[Pe]=e[t],Pe++)},Ee=0;for(h=0,l=ae.length;h<l;h++)Le(ae[h]),ae[h]=Ce.slice(Ee,Pe),Ee=Pe;for(te=new Array(fe),h=0,l=ge;h<l;h+=3)te[h]=pe[h],te[h+1]=pe[h+1],te[h+2]=pe[h+2];for(y=new Array(3*ye),u=0,h=0,l=3*ye;h<l;h+=3)y[h]=ve[h],y[h+1]=ve[h+1],y[h+2]=ve[h+2],u++;this.addPolygonRAW(y,te,ae,r,i,a,s,n)},Pe.prototype.addPolygonRAW=function(e,t,r,i,a,s,n,o,h,l){this.currentGroup||this.addGroup("some-group");var u,d,c,p=!a||"float"==a,f=0;o=o||this.navSrs;var m={id:n,properties:s},g=new Array(Math.round(e.length/3));if(p){for(u=0,d=e.length;u<d;u+=3)c=[e[u],e[u+1],e[u+2],m,null,null],this.addToHeightsBuffer(c),g[f++]=c;m.floatHeights=!0,m.srs=o,m.heightsToProcess=g.length,this.heightsToProcess+=g.length}else for(u=0,d=e.length;u<d;u+=3)g[f++]=h?l?[e[u]*l.sx+l.px,e[u+1]*l.sy+l.py,e[u+2]*l.sz+l.pz]:[e[u],e[u+1],e[u+2]]:this.physSrs.convertCoordsFrom(c,o);var v=t.slice(),y=new Array(r.length);for(u=0,d=r.length;u<d;u++)y[u]=r[u].slice();return m.vertices=g,m.surface=v,m.borders=y,this.currentGroup.polygons.push(m),this},Pe.prototype.importVTSGeodata=function(e,t,r){return new Ae(this,t,r).processJSON(e)},Pe.prototype.importGeoJson=function(e,t,r,i){return new Te(this,t,r,i).processJSON(e)},Pe.prototype.import3DTiles=function(e,t){return new Ce(this,t).processJSON(e)},Pe.prototype.load3DTiles=function(e,t,r){new Ce(this,t).loadJSON(e,t,r)},Pe.prototype.load3DTiles2=function(e,t,r){this.binPath=e,onMapLoaded&&onMapLoaded()},Pe.prototype.processHeights=function(e,t,r){if(this.heightsToProcess<=0)r&&r(this);else{this.processingHeights&&this.processHeightsCalls.push(this.processHeights.bind(this,e,t)),this.processingHeights=!0,this.heightsSource=e,this.heightsLod=t;var i,a,s,n,o,h,l,u=this.heightsProcessBufferFirst;if(u){switch(e){case"node-by-precision":o=!0;case"heightmap-by-precision":a=(h=u.coords)[3].srs?this.navSrs.convertCoordsFrom(h,h[3].srs):h,n=this.map.measure.getOptimalHeightLodBySampleSize(a,t);break;case"node-by-lod":o=!0,t-=8;case"heightmap-by-lod":n=t;break;case"none":l=!0}do{h=u.coords,l||null!=h[4]||(a=h[3].srs?this.navSrs.convertCoordsFrom(h,h[3].srs):h,s=this.map.measure.getSpatialDivisionNode(a),h[4]=s[0],h[5]=s[1]),((s=l?[0,!0,!0]:this.map.measure.getSurfaceHeight(h,n,null,h[4],h[5],null,o))[1]||s[2])&&(h[2]+=s[0],this.removeFromHeightsBuffer(u,i),h[3].heightsToProcess--,this.heightsToProcess--,h[3].heightsToProcess<=0&&(h[3].floatHeights=!1),a=[h[0],h[1],h[2]],a=this.physSrs.convertCoordsFrom(a,h[3].srs),h[0]=a[0],h[1]=a[1],h[2]=a[2]),i=u,u=u.next}while(u)}this.heightsToProcess<=0?(this.updateCallback&&this.updateCallback(),this.processingHeights=!1,r&&r(this),this.processHeightsCalls.length>1&&this.processHeightsCalls.shift()()):this.updateCallback||(this.updateCallback=this.map.core.on("map-update",this.processHeights.bind(this,this.heightsSource,this.heightsLod,r)))}},Pe.prototype.extractGeometry=function(e){for(var t,r,i,a,s,n,o=0,h=this.groups.length;o<h;o++){var l,u,d=this.groups[o],c=d.points,p=d.lines,f=d.polygons;for(l=0,u=c.length;l<u;l++)c[l].id==e&&(t=c[l]);for(l=0,u=p.length;l<u;l++)p[l].id==e&&(t=p[l]);for(l=0,u=f.length;l<u;l++)f[l].id==e&&(t=f[l])}if(t){if(t.points){if((g=t.points).length>0)for(i=new Float64Array(3*g.length),o=0,h=g.length;o<h;o++)s=3*o,n=g[o],i[s]=n[0],i[s+1]=n[1],i[s+2]=n[2];return new we(this.map,{type:"point-geometry",id:t.id,geometryBuffer:i})}if(t.lines){if((r=t.lines).length>0){var m=0;for(o=0,h=r.length;o<h;o++)m+=r[o].length;for(i=new Float64Array(3*m),a=new Uint32Array(h),s=0,o=0,h=r.length;o<h;o++){var g;for(l=0,u=(g=r[o]).length;l<u;l++)n=g[l],i[s]=n[0],i[s+1]=n[1],i[s+2]=n[2],s+=3}}return new we(this.map,{type:"line-geometry",id:t.id,geometryBuffer:i,indicesBuffer:a})}return t.vertices?new we(this.map,{type:"polygon-geometry",id:t.id,geometryBuffer:t.vertices,surface:t.surface}):void 0}},Pe.prototype.compileGroup=function(e,t){var r,i,a,s,n,o,h,l,u,d,c,p,f,m=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],g=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],v={},y=e.points,b=e.lines,x=e.polygons;for(v.id=e.id,h=0,l=y.length;h<l;h++)for(u=0,d=(r=y[h].points).length;u<d;u++)(i=r[u])[0]>g[0]&&(g[0]=i[0]),i[1]>g[1]&&(g[1]=i[1]),i[2]>g[2]&&(g[2]=i[2]),i[0]<m[0]&&(m[0]=i[0]),i[1]<m[1]&&(m[1]=i[1]),i[2]<m[2]&&(m[2]=i[2]);for(h=0,l=b.length;h<l;h++)for(u=0,d=(n=b[h].lines).length;u<d;u++)for(c=0,p=(o=n[u]).length;c<p;c++)(i=o[c])[0]>g[0]&&(g[0]=i[0]),i[1]>g[1]&&(g[1]=i[1]),i[2]>g[2]&&(g[2]=i[2]),i[0]<m[0]&&(m[0]=i[0]),i[1]<m[1]&&(m[1]=i[1]),i[2]<m[2]&&(m[2]=i[2]);for(h=0,l=x.length;h<l;h++)for(u=0,d=(r=x[h].vertices).length;u<d;u++)(i=r[u])[0]>g[0]&&(g[0]=i[0]),i[1]>g[1]&&(g[1]=i[1]),i[2]>g[2]&&(g[2]=i[2]),i[0]<m[0]&&(m[0]=i[0]),i[1]<m[1]&&(m[1]=i[1]),i[2]<m[2]&&(m[2]=i[2]);t||(t=Math.max(g[0]-m[0]+1,g[1]-m[1]+1,g[2]-m[2]+1)/.25,t=Math.max(t,1024),t=Math.min(t,2<<20));v.resolution=t;var S=[t/(g[0]-m[0]+1),t/(g[1]-m[1]+1),t/(g[2]-m[2]+1)];for(v.points=new Array(y.length),h=0,l=y.length;h<l;h++){r=(a=y[h]).points;var M=new Array(r.length);for(u=0,d=r.length;u<d;u++)i=r[u],M[u]=[Math.round((i[0]-m[0])*S[0]),Math.round((i[1]-m[1])*S[1]),Math.round((i[2]-m[2])*S[2])];s={points:M},a.id&&(s.id=a.id),a.properties&&(s.properties=a.properties),v.points[h]=s}for(v.lines=new Array(b.length),h=0,l=b.length;h<l;h++){n=(a=b[h]).lines;var w=new Array(n.length);for(u=0,d=n.length;u<d;u++){for(o=n[u],M=new Array(o.length),c=0,p=o.length;c<p;c++)i=o[c],M[c]=[Math.round((i[0]-m[0])*S[0]),Math.round((i[1]-m[1])*S[1]),Math.round((i[2]-m[2])*S[2])];w[u]=M}s={lines:w},a.id&&(s.id=a.id),a.properties&&(s.properties=a.properties),v.lines[h]=s}for(v.polygons=new Array(x.length),h=0,l=x.length;h<l;h++){r=(a=x[h]).vertices;var T=new Array(r.length);for(c=0,u=0,d=r.length;u<d;u++)i=r[u],T[c++]=Math.round((i[0]-m[0])*S[0]),T[c++]=Math.round((i[1]-m[1])*S[1]),T[c++]=Math.round((i[2]-m[2])*S[2]);s={vertices:T,surface:a.surface.slice()},f=a.borders;var A=new Array(f.length);for(u=0,d=A.length;u<d;u++)A[u]=f[u].slice();s.borders=A,a.id&&(s.id=a.id),a.properties&&(s.properties=a.properties),v.polygons[h]=s}return v.bbox=[m,g],g[0]>this.bboxMax[0]&&(this.bboxMax[0]=g[0]),g[1]>this.bboxMax[1]&&(this.bboxMax[1]=g[1]),g[2]>this.bboxMax[2]&&(this.bboxMax[2]=g[2]),m[0]<this.bboxMin[0]&&(this.bboxMin[0]=m[0]),m[1]<this.bboxMin[1]&&(this.bboxMin[1]=m[1]),m[2]<this.bboxMin[2]&&(this.bboxMin[2]=m[2]),v},Pe.prototype.makeGeodata=function(e){this.bboxMin=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],this.bboxMax=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];var t={version:1,groups:[]};this.binPath&&(t.binPath=this.binPath);for(var r=0,i=this.groups.length;r<i;r++)t.groups.push(this.compileGroup(this.groups[r],e));if(this.nodes.length>0)for(t.nodes=[],r=0,i=this.nodes.length;r<i;r++)t.nodes.push(this.nodes[r]);return t},Pe.prototype.makeFreeLayer=function(e,t,r){return r||(r=this.makeGeodata(t)),e||(e={layers:{"my-lines":{filter:["==","#type","line"],line:!0,"line-width":4,"line-color":[255,0,255,255],"zbuffer-offset":[-5,0,0]},"my-points":{filter:["==","#type","point"],point:!0,"point-radius":10,"point-color":[0,0,255,255],"zbuffer-offset":[-5,0,0]}}}),{credits:[],displaySize:1024,extents:{ll:this.bboxMin,ur:this.bboxMax},geodata:r,style:e,type:"geodata"}};var Le=Pe,Ee=I,Ne=s.a,Be=function(e,t,r){this.map=e,this.stats=e.stats,this.mapLoaderUrl=t,this.extraInfo=r,this.bbox=new Ee,this.size=0,this.fileSize=0,this.geodata=null,this.type="geodata",this.cacheItem=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.map.markDirty()};Be.prototype.kill=function(){this.bbox=null,this.killGeodata()},Be.prototype.killGeodata=function(e){this.geodata&&(this.geodata=null),!0!==e&&null!=this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),this.loadState=0,this.size=0,this.fileSize=0,this.cacheItem=null},Be.prototype.isReady=function(e,t,r,i){var a=this.map.stats.gpuRenderUsed>=this.map.maxGpuUsed;if(e=e||a,2==this.loadState)return this.map.resourcesCache.updateItem(this.cacheItem),!0;if(0==this.loadState)if(e);else{if("object"==typeof this.mapLoaderUrl)return this.geodata=i?this.mapLoaderUrl:JSON.stringify(this.mapLoaderUrl),this.loadState=2,this.size=this.geodata.length?this.geodata.length:0,this.cacheItem=this.map.resourcesCache.insert(this.killGeodata.bind(this,!0),this.size),this.map.resourcesCache.updateItem(this.cacheItem),!0;this.scheduleLoad(t)}else 3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t);return!1},Be.prototype.scheduleLoad=function(e){this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),e,this.extraInfo.tile,"geodata")},Be.prototype.onLoad=function(e,t,r){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=r,this.loadState=1,this.map.config.mapGeodataBinaryLoad?this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"geodata"):Ne.loadJSON(e,this.onLoaded.bind(this),this.onLoadError.bind(this),!0,!!Ne.useCredentials&&-1!=this.mapLoaderUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)},Be.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},Be.prototype.onLoaded=function(e){if(!this.map.killed){var t=e.length||e.byteLength;t||(t=0),this.size=t,this.fileSize=t,this.geodata=e,this.cacheItem=this.map.resourcesCache.insert(this.killGeodata.bind(this,!0),t),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}};var Ie=Be,ke=N,Re=P,_e=j,ze=he,Ue=Ie,De=function(e,t,r){this.map=e,this.id=r,this.parent=t,this.metatiles={},this.meshes={},this.textures={},this.subtextures={},this.geodata={},this.credits={},this.children=[null,null,null,null]};De.prototype.kill=function(){for(var e=0;e<4;e++)null!=this.children[e]&&this.children[e].kill();this.children=[null,null,null,null];var t=this.parent;this.parent=null,null!=t&&t.removeChild(this)},De.prototype.addChild=function(e){if(!this.children[e]){var t=this.id,r=[t[0]+1,t[1]<<1,t[2]<<1];switch(e){case 1:r[1]++;break;case 2:r[2]++;break;case 3:r[1]++,r[2]++}this.children[e]=new De(this.map,this,r)}},De.prototype.removeChildByIndex=function(e){null!=this.children[e]&&(this.children[e].kill(),this.children[e]=null)},De.prototype.removeChild=function(e){for(var t=0;t<4;t++)this.children[t]==e&&(this.children[t].kill(),this.children[t]=null)},De.prototype.getMesh=function(e,t){var r=this.meshes[e];return r||(r=new ze(this.map,e,t),this.meshes[e]=r),r},De.prototype.getGeodata=function(e,t){var r=this.geodata[e];return r||(r=new Ue(this.map,e,t),this.geodata[e]=r),r},De.prototype.getTexture=function(e,t,r,i,a,s){var n;if(i&&(i.layer||i.hmap)){var o=e+(i.hmap?"":i.layer.id);(n=this.textures[o])||(n=new ke(this.map,e,t,r,i,a,s),this.textures[o]=n)}else(n=this.textures[e])||(n=new ke(this.map,e,t,r,i,a,s),this.textures[e]=n);return n},De.prototype.getSubtexture=function(e,t,r,i,a,s,n){return(e=this.subtextures[t])||(e=new Re(this.map,t,r,i,a,s,n),this.subtextures[t]=e),e},De.prototype.addMetatile=function(e,t){this.metatiles[e]=t},De.prototype.removeMetatile=function(e){for(var t in this.metatiles)this.metatiles[t]==e&&delete this.metatiles[t]},De.prototype.getMetatile=function(e,t,r){var i,a=this.metatiles;for(var s in a)if(a[s].surface==e)return a[s];var n=e.getMetaUrl(this.id);return a[n]?(i=a[n].clone(e),this.addMetatile(n,i),i):t?(i=new _e(this,e,r),this.addMetatile(n,i),i):null};var Oe=De,Ve=Oe,Ge=function(e){this.map=e,this.tree=new Ve(e,null,[0,0,0])};Ge.prototype.kill=function(){this.tree.kill()},Ge.prototype.findNode=function(e,t){for(var r=this.tree,i=e[0];i>0;i--){var a=1<<i-1,s=0;if(0!=(e[1]&a)&&(s+=1),0!=(e[2]&a)&&(s+=2),!r.children[s]){if(!t)return null;r.addChild(s)}r=r.children[s]}return r},Ge.prototype.findAgregatedNode=function(e,t,r){for(var i=this.tree,a=e[1]>>t<<t,s=e[2]>>t<<t,n=e[0];n>0;n--){var o=1<<n-1,h=0;if(0!=(a&o)&&(h+=1),0!=(s&o)&&(h+=2),!i.children[h]){if(!r)return null;i.addChild(h)}i=i.children[h]}return i};var je=Ge,He=r(5),qe=r.n(He),We=N,Je=p.a,Ze=qe.a,Ye=function(e,t,r){if(this.map=e,this.id=t,this.proj4=e.proj4,this.comment=r.comment||null,this.srsDef=r.srsDef||null,this.srsModifiers=r.srsModifiers||[],this.type=r.type||"projected",this.vdatum=r.vdatum||"orthometric",this.srsDef=r.srsDefEllps||this.srsDef,this.periodicity=this.parsePeriodicity(r.periodicity),this.srsInfo=this.proj4(this.srsDef).info(),this.geoidGrid=null,this.geoidGridMap=null,this.srsProj4=this.proj4(this.srsDef,null,null,!0),this.latlonProj4=null,this.proj4Cache={},r.geoidGrid){var i=r.geoidGrid;if(this.geoidGrid={definition:i.definition||null,srsDefEllps:i.srsDefEllps||null,valueRange:i.valueRange||[0,1]},i.extents?this.geoidGrid.extents={ll:i.extents.ll,ur:i.extents.ur}:this.geoidGrid.extents={ll:[0,0],ur:[1,1]},this.geoidGrid.definition){var a=this.map.url.makeUrl(this.geoidGrid.definition,{},null);this.geoidGridMap=new We(this.map,a,!0)}this.geoidGrid.srsDefEllps&&(this.geoidGrid.srsProj4=this.proj4(this.geoidGrid.srsDefEllps,null,null,!0))}"geographic"==this.type&&(this.spheroid=r.spheroid||null,this.spheroid)};Ye.prototype.parsePeriodicity=function(e){return null==e?null:{type:e.type||"",period:e.period||0}},Ye.prototype.getInfo=function(){return{comment:this.comment,srsDef:this.srsDef,srsModifiers:this.srsModifiers,type:this.type,vdatum:this.vdatum,srsDefEllps:this.srsDef,a:this.srsInfo.a,b:this.srsInfo.b}},Ye.prototype.getSrsInfo=function(){return this.srsInfo},Ye.prototype.isReady=function(){return this.isGeoidGridReady()},Ye.prototype.isGeoidGridReady=function(){return null==this.geoidGrid||null!=this.geoidGridMap&&this.geoidGridMap.isReady()},Ye.prototype.isProjected=function(){return"projected"==this.type},Ye.prototype.getOriginalHeight=function(e){var t=e[2]||0;return t/=this.getVerticalAdjustmentFactor(e),t+=this.getGeoidGridDelta(e)},Ye.prototype.getFinalHeight=function(e){var t=e[2]||0;return t-=this.getGeoidGridDelta(e),t*=this.getVerticalAdjustmentFactor(e)},Ye.prototype.getGeoidGridDelta=function(e){if(null!=this.geoidGridMap&&this.isGeoidGridReady()){var t=this.proj4(this.srsProj4,this.geoidGrid.srsProj4,[e[0],e[1]]),r=t[0]-this.geoidGrid.extents.ll[0],i=this.geoidGrid.extents.ur[1]-t[1],a=this.geoidGridMap.getImageExtents();r*=a[0]/(this.geoidGrid.extents.ur[0]-this.geoidGrid.extents.ll[0]),i*=a[1]/(this.geoidGrid.extents.ur[1]-this.geoidGrid.extents.ll[1]),r=Je.clamp(r,0,a[0]-2),i=Je.clamp(i,0,a[1]-2);var s=Math.floor(r),n=Math.floor(i),o=r-s,h=i-n,l=this.geoidGridMap.getImageData(),u=n*a[0],d=u+a[0],c=l[4*(u+s)],p=l[4*(u+s+1)],f=l[4*(d+s)],m=c+(p-c)*o,g=m+(f+(l[4*(d+s+1)]-f)*o-m)*h;return g=this.geoidGrid.valueRange[0]+g*((this.geoidGrid.valueRange[1]-this.geoidGrid.valueRange[0])/255)}return 0},Ye.prototype.getVerticalAdjustmentFactor=function(e){if(-1!=this.srsModifiers.indexOf("adjustVertical")){var t=this.getSrsInfo(),r="+proj=longlat  +alpha=0 +gamma=0 +a="+t.a+" +b="+t.b+" +x0=0 +y0=0";this.latlonProj4||(this.latlonProj4=this.proj4(r,null,null,!0));var i=this.proj4(this.srsProj4,this.latlonProj4,[e[0],e[1]]),a=new Ze.Geodesic.Geodesic(t.a,t.a/t.b-1).Direct(i[1],i[0],90,1e3);i=[a.lon2,a.lat2];var s=(i=this.proj4(this.latlonProj4,this.srsProj4,i))[0]-e[0],n=i[1]-e[1];return Math.sqrt(s*s+n*n)/1e3}return 1},Ye.prototype.convertCoordsTo=function(e,t,r){if(this.isReady(),"string"!=typeof t){if(t.id==this.id)return e.slice();t.isReady()}var i="string"==typeof t;(e=e.slice())[2]=this.getOriginalHeight(e);var a=i?t:t.srsProj4,s=i?t:t.srsDef,n=this.proj4Cache[s];n||(n=this.proj4(this.srsProj4,a),this.proj4Cache[s]=n);var o=n.forward(e);return r||i||(o[2]=t.getFinalHeight(o)),o},Ye.prototype.convertCoordsToFast=function(e,t,r,i,a,s){var n=t.srsProj4,o=t.srsDef,h=this.proj4Cache[o];h||(h=this.proj4(this.srsProj4,n),this.proj4Cache[o]=h);var l=h.forward(e);i[s]=l[0],i[s+1]=l[1],i[s+2]=l[2],t.geoidGrid&&(i[s+2]-=t.getGeoidGridDelta(e))},Ye.prototype.convertCoordsFrom=function(e,t){if(this.isReady(),"string"!=typeof t){if(t.id==this.id)return e.slice();t.isReady()}e=e.slice(),"string"!=typeof t&&(e[2]=t.getOriginalHeight(e));var r="string"==typeof t?t:t.srsProj4,i="string"==typeof t?t:t.srsDef,a=this.proj4Cache[i];a||(a=this.proj4(this.srsProj4,r),this.proj4Cache[i]=a);var s=a.inverse(e);return s[2]=this.getFinalHeight(s),s},Ye.prototype.phi2z=function(e,t){for(var r,i,a=.5*Math.PI,s=.5*e,n=a-2*Math.atan(t),o=0;o<=15;o++)if(r=e*Math.sin(n),n+=i=a-2*Math.atan(t*Math.pow((1-r)/(1+r),s))-n,Math.abs(i)<=1e-10)return n;return-9999},Ye.prototype.convertMercToWGS=function(e,t,r,i){var a=2*Math.PI,s=.5*Math.PI,n=this.srsProj4,o=e[r]-n.x0,h=e[r+1]-n.y0;if(n.sphere)t[i+1]=s-2*Math.atan(Math.exp(-h/(n.a*n.k0)));else{var l=Math.exp(-h/(n.a*n.k0)),u=this.phi2z(n.e,l);if(t[i+1]=u,-9999===u)return}o=n.long0+o/(n.a*n.k0);t[i]=Math.abs(o)<=3.14159265359?o:o-(o<0?-1:1)*a,t[i+2]=e[r+2]},Ye.prototype.convertWGSToGeocent=function(e,t,r,i,a){var s,n,o,h,l=t.datum,u=.5*Math.PI,d=e[i],c=e[i+1],p=e[i+2];if(c<-u&&c>-1.001*u)c=-u;else if(c>u&&c<1.001*u)c=u;else if(c<-u||c>u)return null;d>Math.PI&&(d-=2*Math.PI),n=Math.sin(c),h=Math.cos(c),o=n*n,s=l.a/Math.sqrt(1-l.es*o),r[a]=(s+p)*h*Math.cos(d),r[a+1]=(s+p)*h*Math.sin(d),r[a+2]=(s*(1-l.es)+p)*n};var Ke=Ye,Xe=function(e,t){this.map=e,this.maxCost=null!=t?t:Number.MAX_VALUE,this.skipCostCheck=!1,this.last=null,this.first=null,this.totalCost=0,this.totalItems=0};Xe.prototype.updateItem=function(e){if(null!=e&&this.first!=e){null!=e.prev&&(e.prev.next=e.next),null!=e.next&&(e.next.prev=e.prev),this.last==e&&(this.last=e.prev);var t=this.first;this.first=e,this.first.next=t,this.first.prev=null,t.prev=this.first}},Xe.prototype.getMaxCost=function(){return this.maxCost},Xe.prototype.setMaxCost=function(e){this.maxCost=e,this.checkCost()},Xe.prototype.clear=function(){for(var e=this.first;null!=e;)null!=e.destructor&&e.destructor(),e=e.next;this.last=null,this.first=null,this.totalCost=0,this.totalItems=0},Xe.prototype.insert=function(e,t){this.totalItems++;var r={destructor:e,cost:t,prev:null,next:this.first};return null!=this.first&&(this.first.prev=r),this.first=r,null==this.last&&(this.last=r),this.totalCost+=t,this.checkCost(),r},Xe.prototype.remove=function(e){this.totalItems++;var t=!1;e==this.first&&(this.first=e.next,t=!0,null!=this.first&&(this.first.prev=null)),e==this.last&&(this.last=e.prev,t=!0,null!=this.last&&(this.last.next=null)),t||(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev)),this.totalCost-=e.cost,e.destructor(),this.checkCost()},Xe.prototype.checkCost=function(){if(!this.skipCostCheck)for(;this.totalCost>this.maxCost;){this.totalItems--;var e=this.last;if(null==e)break;this.last=this.last.prev,null!=this.last&&(this.last.next=null),this.totalCost-=e.cost,e.destructor()}},Xe.prototype.addItem=function(e,t){return this.insert(t,e)},Xe.prototype.removeItem=function(e){return this.remove(e)},Xe.prototype.itemUsed=function(e){return this.updateItem(e)};var Qe=Xe,$e=a.d,et=p.a,tt=function(e){this.map=e,this.camera=e.renderer.camera,this.distance=10,this.distance2=10,this.position=[0,0,0],this.vector=[0,0,1],this.vector2=[0,0,1,1],this.center=[0,0,0],this.height=0,this.terrainHeight=0,this.lastTerrainHeight=0,this.near=2};tt.prototype.update=function(){var e=this.map;e.position.check();var t=e.position.getHeight(),r=e.measure.getOptimalHeightLod(e.position.getCoords(),e.position.getViewExtent(),e.config.mapNavSamplesPerViewExtent),i=e.measure.getSurfaceHeight(e.position.getCoords(),r,!0);e.stats.heightTerrain=i[0],e.stats.heightDelta=t,"float"==e.position.getHeightMode()&&(t+=i[0]),e.renderer.useSuperElevation&&(t=e.renderer.getSuperElevatedHeight(t));var a=e.measure.getPositionCameraInfo(e.position,e.getNavigationSrs().isProjected());this.camera.setPosition(a.orbitCoords),this.camera.setRotationMatrix(a.rotMatrix),this.vector=a.vector,this.vector2=a.vector2,this.position=a.orbitCoords,this.height=a.orbitHeight+t,this.terrainHeight=this.height-i[0],this.distance2=e.position.getViewDistance(),this.distance=Math.max(this.terrainHeight,this.distance2),this.distance=et.clamp(this.distance,.1,this.camera.getFar()),this.distanceFactor=Math.tan(et.radians(.5*e.position.getFov())),this.perceivedDistance=Math.max(this.terrainHeight,this.distance2*this.distanceFactor),e.renderer.cameraDistance=this.distance,e.renderer.viewExtent=e.position.getViewExtent(),this.camera.setViewHeight(e.position.getViewExtent());var s=e.position.getCoords(),n=e.convert.convertCoords([s[0],s[1],t],"navigation","physical");if(this.center=[n[0],n[1],n[2]],n[0]+=a.orbitCoords[0],n[1]+=a.orbitCoords[1],n[2]+=a.orbitCoords[2],this.camera.setPosition([0,0,0]),this.position=n,this.vector2=[-n[0],-n[1],-n[2],1],$e.normalize(this.vector2),this.mapIsProjected=e.getNavigationSrs().isProjected(),this.mapIsProjected)this.vector2[3]=0;else{this.geocentDistance=$e.length(this.position);var o=[0,0,0];$e.normalize(this.position,o),this.geocentNormal=o}var h=Math.max(this.height,this.distance)/6e5,l=Math.max(this.near,this.near*(20*h)),u=10*(h=Math.max(1,h))*6e5;return this.camera.setParams(.5*e.position.getFov(),l,2*u),a},tt.prototype.getCameraHeight=function(){return this.cameraHeight},tt.prototype.getMvpMatrix=function(){return this.camera.getMvpMatrix()},tt.prototype.getRotationMatrix=function(){return this.camera.getRotationMatrix()},tt.prototype.getRotationviewMatrix=function(){return this.camera.getRotationviewMatrix()},tt.prototype.getFar=function(){return this.camera.getFar()},tt.prototype.getFov=function(){return this.camera.getFov()},tt.prototype.getAspect=function(){return this.camera.getAspect()};var rt=tt,it=s.a,at=function(e,t){this.map=e,this.id=t.id||null,this.notice=t.notice||null,this.copyrighted=t.copyrighted||!0,this.url=t.url||null,this.html=it.simpleWikiLinks(this.notice),this.plain=it.simpleWikiLinks(this.notice)};at.prototype.getInfo=function(){return{id:this.id,notice:this.notice,html:this.html,plain:this.plain}};var st=at,nt=s.a,ot=ge.a,ht=st,lt=function(e,t,r){if(this.map=e,this.id=r,this.currentAlpha=1,this.tileSize=[256,256],this.lodRange=[0,100],this.credits=[],this.tileRange=[[0,0],[0,0]],this.jsonUrl=null,this.baseUrl=this.map.url.baseUrl,this.baseUrlSchema=this.map.url.baseUrlSchema,this.baseUrlOrigin=this.map.url.baseUrlOrigin,this.ready=!1,this.dataType=0,this.shaderFilters=null,"esri-world-imagery"==r&&(t.availability={type:"negative-size",size:2521}),"string"==typeof t){this.jsonUrl=this.map.url.processUrl(t),this.baseUrl=ot.getBase(this.jsonUrl),this.baseUrlSchema=ot.getSchema(this.jsonUrl),this.baseUrlOrigin=ot.getOrigin(this.jsonUrl);var i=function(e){this.parseJson(e),this.ready=!0,this.map.refreshView()}.bind(this),a=function(){}.bind(this);nt.loadJSON(this.jsonUrl,i,a,null,!!nt.useCredentials&&-1!=this.jsonUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)}else this.parseJson(t),this.ready=!0};lt.prototype.parseJson=function(e){switch(this.numberId=e.id||null,this.type=e.type||"raster",this.url=this.processUrl(e.url,""),this.tileSize=e.tileSize||[256,256],this.lodRange=e.lodRange||[0,0],this.tileRange=e.tileRange||[[0,0],[0,0]],this.metaUrl=this.processUrl(e.metaUrl),this.maskUrl=this.processUrl(e.maskUrl),this.isTransparent=e.isTransparent||!1,this.options=e.options||{},this.credits=e.credits||[],this.creditsUrl=null,this.shaderFilter=this.options.shaderFilter||null,e.dataType){default:case"color":this.dataType=0;break;case"height":this.dataType=1;break;case"classification":this.dataType=2}if(this.specificity=Math.pow(2,this.lodRange[0])/((this.tileRange[1][0]-this.tileRange[1][0]+1)*(this.tileRange[1][1]-this.tileRange[1][1]+1)),this.availability=e.availability?{}:null,this.availability){var t=e.availability;switch(t.type){case"negative-type":this.availability.type=2;break;case"negative-code":this.availability.type=3;break;case"negative-size":this.availability.type=4}this.availability.mime=t.mime,this.availability.codes=t.codes,this.availability.size=t.size}switch(this.metaUrl&&this.maskUrl&&(this.availability={type:1}),typeof this.credits){case"string":this.creditsUrl=this.credits,this.credits=[];break;case"object":if(!Array.isArray(this.credits)){var r=this.credits;for(var i in this.credits=[],r)this.map.addCredit(i,new ht(this.map,r[i])),this.credits.push(i)}}},lt.prototype.kill=function(){},lt.prototype.setOptions=function(){},lt.prototype.getOptions=function(){return this.getInfo()},lt.prototype.getInfo=function(){return{type:this.type,url:this.url,tileSize:this.tileSize,credits:this.credits,lodRange:this.lodRange,tileRange:this.tileRange,mataUrl:this.metaUrl,maskUrl:this.maskUrl,isTransparent:this.isTransparent}},lt.prototype.processUrl=function(e,t){return e?-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},lt.prototype.hasTile=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var r=e[1]>>t,i=e[2]>>t;return!(e[0]<this.lodRange[0]||e[0]>this.lodRange[1]||r<this.tileRange[0][0]||r>this.tileRange[1][0]||i<this.tileRange[0][1]||i>this.tileRange[1][1])},lt.prototype.hasTileOrInfluence=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var r=e[1]>>t,i=e[2]>>t;return r<this.tileRange[0][0]||r>this.tileRange[1][0]||i<this.tileRange[0][1]||i>this.tileRange[1][1]?0:e[0]>this.lodRange[1]?1:2},lt.prototype.getUrl=function(e,t){return this.map.url.makeUrl(this.url,{lod:e[0],ix:e[1],iy:e[2]},null,t)},lt.prototype.getMetatileUrl=function(e,t){return this.map.url.makeUrl(this.metaUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},lt.prototype.getMaskUrl=function(e,t){return this.map.url.makeUrl(this.maskUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)};var ut=lt,dt=function(e,t,r,i,a,s){this.map=e,this.id=t,this.srs=this.map.getMapsSrs(r),this.extents=i,this.heightRange=a,this.partitioning=s,this.isPole=1==t[0]&&(0==t[1]&&1==t[2]||1==t[1]&&0==t[2])};dt.prototype.getInnerCoords=function(e){return this.srs.convertCoordsFrom(e,this.map.getNavigationSrs())},dt.prototype.getOuterCoords=function(e){return this.srs.convertCoordsTo(e,this.map.getNavigationSrs())},dt.prototype.getPhysicalCoords=function(e,t){return this.srs.convertCoordsTo(e,this.map.getPhysicalSrs(),t)},dt.prototype.getPhysicalCoordsFast=function(e,t,r,i,a){return this.srs.convertCoordsToFast(e,this.map.getPhysicalSrs(),t,r,i,a)},dt.prototype.getExtents=function(e){return this.srs.convertCoordsFrom(e,this.map.getNavigationSrs())};var ct=dt,pt=function(e,t){this.map=e,this.proj4=e.proj4,this.valid=!1,this.id=t.id||null,this.description=t.description||"",this.nodesMap=[];var r=t.model;if(null!=r){if(this.model={physicalSrs:e.getMapsSrs(r.physicalSrs),navigationSrs:e.getMapsSrs(r.navigationSrs),publicSrs:e.getMapsSrs(r.publicSrs)},this.body=t.body?e.getBody(t.body):null,this.params={},null!=t.parameters){var i=t.parameters;this.params.metaBinaryOrder=i.metaBinaryOrder||1,this.params.navDelta=i.navDelta||8}var a=t.division;if(null!=a){this.division={rootLod:a.rootLod||0,arity:a.arity||null,heightRange:a.heightRange||[0,1]};var s=this.parseSpaceExtents(a.extents);this.division.extents=s,e.spaceExtentSize=[s.ur[0]-s.ll[0],s.ur[1]-s.ll[1],s.ur[2]-s.ll[2]],e.spaceExtentOffset=s.ll;var n=a.nodes;if(this.division.nodes=[],null!=n){this.hasPoles=4==n.length;for(var o=0,h=n.length;o<h;o++){var l=this.parseNode(n[o]);this.nodesMap[l.id[0]+"."+l.id[1]+"."+l.id[2]]=l,this.division.nodes.push(l)}this.valid=!0}}}};pt.prototype.getInfo=function(){return{id:this.id,physicalSrs:this.model.physicalSrs.id,navigationSrs:this.model.navigationSrs.id,publicSrs:this.model.publicSrs.id}},pt.prototype.getGlobalHeightRange=function(){return this.division.heightRange},pt.prototype.parseNode=function(e){var t={srs:e.srs,partitioning:e.partitioning};t.extents=this.parseExtents(e.extents);var r=e.id;if(null!=r)return t.id={lod:r.lod||0,position:r.position||[0,0]},new ct(this.map,[t.id.lod,t.id.position[0],t.id.position[1]],t.srs,t.extents,this.heightRange,t.partitioning)},pt.prototype.parseExtents=function(e){return null==e?{ll:[0,0],ur:[1,1]}:{ll:e.ll||[0,0],ur:e.ur||[1,1]}},pt.prototype.parseSpaceExtents=function(e){return null==e?{ll:[0,0,0],ur:[1,1,1]}:{ll:e.ll||[0,0,0],ur:e.ur||[1,1,1]}},pt.prototype.getSpatialDivisionNodes=function(){return this.division.nodes},pt.prototype.convertCoords=function(e,t,r){var i,a;switch(t){case"public":i=this.model.publicSrs;break;case"physical":i=this.model.physicalSrs;break;case"navigation":i=this.model.navigationSrs}switch(r){case"public":a=this.model.publicSrs;break;case"physical":a=this.model.physicalSrs;break;case"navigation":a=this.model.navigationSrs}return i.convertCoordsTo(e,a)};var ft=pt,mt=function(e,t){this.parse(t)};mt.prototype.parse=function(e){this.class=e.class||"",this.comment=e.comment||"",this.parent=e.parent||"",this.atmosphere=e.atmosphere||null,this.atmosphere&&(this.atmosphere.colorHorizon||(this.atmosphere.colorHorizon=[0,0,0,0]),this.atmosphere.colorZenith||(this.atmosphere.colorZenith=[0,0,0,0]),this.atmosphere.thickness||(this.atmosphere.thickness=1e5),this.atmosphere.visibility||(this.atmosphere.visibility=1e5))},mt.prototype.getInfo=function(){return{class:this.class,comment:this.comment,parent:this.parent,atmosphere:JSON.parse(JSON.stringify(this.atmosphere))}};var gt=mt,vt=s.a,yt=function(e,t,r,i){this.generateLines=!0,this.map=e,this.renderer=this.map.renderer,this.stats=e.stats,this.id=t,this.url=null,this.data=null,this.loadState=0,this.size=0,this.fileSize=0,this.freeLayer=i,this.fonts={},this.fontsReady=!1,"object"==typeof r?(this.data=r,this.setFonts(this.data),this.loadState=2,this.map.markDirty()):(this.freeLayer?this.url=this.freeLayer.processUrl(r,""):this.url=this.map.url.processUrl(r),vt.loadJSON(this.url,this.onLoaded.bind(this),this.onLoadError.bind(this),null,!!vt.useCredentials&&-1!=this.url.indexOf(this.map.url.baseUrl),this.map.core.xhrParams),this.loadState=1)};yt.prototype.kill=function(){},yt.prototype.setData=function(e){this.data=e,this.setFonts(e),this.loadState=2,this.checkFonts()},yt.prototype.checkFonts=function(){var e=!0;for(var t in this.fonts)e=e&&this.renderer.getFont(this.fonts[t]).isReady();return this.fontsReady=e,e},yt.prototype.isReady=function(e,t){return 2==this.loadState?!!this.fontsReady||this.checkFonts():(0==this.loadState&&(e||this.scheduleLoad(t)),!1)},yt.prototype.scheduleLoad=function(e){this.map.loader.load(this.url,this.onLoad.bind(this),e)},yt.prototype.onLoad=function(){this.loadState=1},yt.prototype.onLoadError=function(){this.map.killed},yt.prototype.setFonts=function(e){this.fonts=e.fonts||{},this.fonts["#default"]||(this.fonts["#default"]=this.map.core.config.mapDefaultFont)},yt.prototype.onLoaded=function(e){this.map.killed||(this.data=e,this.setFonts(e),this.loadState=2,this.map.markDirty())};var bt=yt,xt=st,St=bt,Mt=T,wt=I,Tt=s.a,At=ge.a,Ct=function(e,t,r){if(this.map=e,this.id=null,this.type="basic",this.metaBinaryOrder=1,this.metaUrl="",this.navUrl="",this.navDelta=1,this.meshUrl="",this.textureUrl="",this.baseUrl=this.map.url.baseUrl,this.baseUrlSchema=this.map.url.baseUrlSchema,this.baseUrlOrigin=this.map.url.baseUrlOrigin,this.lodRange=[0,0],this.tileRange=[[0,0],[0,0]],this.textureLayer=null,this.boundLayerSequence=[],this.glue="glue"==r,this.free="free"==r,this.virtual=!1,this.zFactor=0,this.ready=!1,this.geodataProcessor=null,this.geodataCounter=0,this.geodataNavtileInfo=!1,this.monoGeodata=null,this.monoGeodataView=null,this.monoGeodataCounter=-1,this.creditsNumbers=[],this.surfaceCounter=e.surfaceCounter,e.surfaceCounter++,this.style=null,this.stylesheet=null,this.originalStyle=null,this.originalStylesheet=null,this.styleChanged=!0,this.free?this.tree=new Mt(this.map,!0,this):this.tree=null,"string"==typeof t){this.jsonUrl=this.map.url.processUrl(t),this.baseUrl=At.getBase(this.jsonUrl),this.baseUrlSchema=At.getSchema(this.jsonUrl),this.baseUrlOrigin=At.getOrigin(this.jsonUrl);var i=function(e){this.parseJson(e),this.ready=!0,this.map.refreshView()}.bind(this),a=function(){}.bind(this);Tt.loadJSON(this.jsonUrl,i,a,null,!!Tt.useCredentials&&-1!=this.jsonUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)}else this.parseJson(t),this.ready=!0};Ct.prototype.parseJson=function(e){var t,r;if(this.id=e.id||null,this.type=e.type||"basic",this.metaBinaryOrder=e.metaBinaryOrder||1,this.metaUrl=this.processUrl(e.metaUrl,""),this.navUrl=this.processUrl(e.navUrl,""),this.hmapUrl=this.processUrl(e.hmapUrl,e.navUrl+"00"),this.pipeline=this.map.config.mapForcePipeline?this.map.config.mapForcePipeline:e.pipeline,this.navDelta=e.navDelta||1,this.meshUrl=this.processUrl(e.meshUrl,""),this.textureUrl=this.processUrl(e.textureUrl,""),this.geodataUrl=this.processUrl(e.geodataUrl||e.geodata,""),this.lodRange=e.lodRange||[0,0],this.tileRange=e.tileRange||[[0,0],[0,0]],this.textureLayer=e.textureLayer||null,this.geodata="geodata"==this.type||"geodata-tiles"==this.type,this.credits=e.credits||[],this.creditsUrl=null,this.displaySize=e.displaySize||1024,e.extents){var i=e.extents.ll,a=e.extents.ur;this.extents=new wt(i[0],i[1],i[2],a[0],a[1],a[2])}else this.extents=new wt(0,0,0,1,1,1);switch(this.specificity=Math.pow(2,this.lodRange[0])/((this.tileRange[1][0]-this.tileRange[1][0]+1)*(this.tileRange[1][1]-this.tileRange[1][1]+1)),typeof this.credits){case"string":this.creditsUrl=this.credits,this.credits=[];break;case"object":if(!Array.isArray(this.credits)){var s=this.credits;for(var n in this.credits=[],s)this.map.addCredit(n,new xt(this.map,s[n])),this.credits.push(n)}for(t=0,r=this.credits.length;t<r;t++){var o=this.map.getCreditById(this.credits[t]);this.creditsNumbers.push(o?o.id:null)}}if(this.geodataUrl&&"string"==typeof this.geodataUrl&&-1!=this.geodataUrl.indexOf("{geonavtile}")&&(this.geodataNavtileInfo=!1),this.geodata){var h=e.style;"string"==typeof this.credits&&(h=this.processUrl(h,"")),this.originalStyle=h,h&&(this.setStyle(h),this.originalStylesheet=this.stylesheet)}if(this.surfaceReference=[],this.glue)for(t=0,r=this.id.length;t<r;t++)this.surfaceReference.push(this.map.getSurface(this.id[t]))},Ct.prototype.kill=function(){this.geodataProcessor&&(this.geodataProcessor.kill(),this.geodataProcessor=null),this.geodataUrl=null,this.style=null,this.stylesheet=null,this.originalStyle=null,this.originalStylesheet=null},Ct.prototype.setOptions=function(){},Ct.prototype.getOptions=function(){return this.getInfo()},Ct.prototype.getInfo=function(){return this.geodata?{type:this.type,metaUrl:this.metaUrl,geodataUrl:this.geodataUrl,lodRange:this.lodRange,tileRange:this.tileRange,style:this.originalStyle}:{type:this.type,metaUrl:this.metaUrl,navUrl:this.navUrl,meshUrl:this.meshUrl,textureUrl:this.textureUrl,lodRange:this.lodRange,tileRange:this.tileRange,textureLayer:this.textureLayer}},Ct.prototype.processUrl=function(e,t){return e?"string"!=typeof e||-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},Ct.prototype.hasTile=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var r=e[1]>>t,i=e[2]>>t;return!(e[0]<this.lodRange[0]||e[0]>this.lodRange[1]||r<this.tileRange[0][0]||r>this.tileRange[1][0]||i<this.tileRange[0][1]||i>this.tileRange[1][1])},Ct.prototype.hasTile2=function(e){var t=e[0]-this.lodRange[0],r=t<0;if(e[0]<this.lodRange[0]){t=-t;var i=this.tileRange[0][0]>>t,a=this.tileRange[0][1]>>t,s=this.tileRange[1][0]>>t,n=this.tileRange[1][1]>>t;if(e[0]>this.lodRange[1]||e[1]<i||e[1]>s||e[2]<a||e[2]>n)return[!1,!1]}else{var o=e[1]>>t,h=e[2]>>t;if(e[0]>this.lodRange[1]||o<this.tileRange[0][0]||o>this.tileRange[1][0]||h<this.tileRange[0][1]||h>this.tileRange[1][1])return[!1,!1]}return[!0,r]},Ct.prototype.hasMetatile=function(e){if(e[0]>this.lodRange[1])return!1;var t=e[0]-this.lodRange[0];if(t>=0){var r=e[1]>>t,i=e[2]>>t;if(r<this.tileRange[0][0]||r>this.tileRange[1][0]||i<this.tileRange[0][1]||i>this.tileRange[1][1])return!1}else if(t=-t,e[1]<this.tileRange[0][0]>>t||e[1]>this.tileRange[1][0]>>t||e[2]<this.tileRange[0][1]>>t||e[2]>this.tileRange[1][1]>>t)return!1;return!0},Ct.prototype.setStyle=function(e){if(this.style!=e){var t=e;"object"!=typeof t?t=this.processUrl(t,""):(t=JSON.stringify(t),t="#obj#"+(t=Tt.getHash(t)).toString(16)),this.stylesheet=this.map.getStylesheet(t),this.stylesheet||(this.stylesheet=new St(this.map,t,e,this),this.map.addStylesheet(t,this.stylesheet)),this.style=e,this.styleChanged=!0,this.geodataCounter++,this.map.markDirty()}},Ct.prototype.getSurfaceReference=function(e){return this.surfaceReference[e-1]},Ct.prototype.getMetaUrl=function(e,t){return this.map.url.makeUrl(this.metaUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Ct.prototype.getNavUrl=function(e,t){return this.map.url.makeUrl(this.navUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Ct.prototype.getHMapUrl=function(e,t){return this.map.url.makeUrl(this.hmapUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Ct.prototype.getMeshUrl=function(e,t){return this.map.url.makeUrl(this.meshUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Ct.prototype.getTextureUrl=function(e,t,r){return this.map.url.makeUrl(this.textureUrl,{lod:e[0],ix:e[1],iy:e[2]},t,r)},Ct.prototype.getGeodataUrl=function(e,t,r){return this.map.url.makeUrl(this.geodataUrl,{lod:e[0],ix:e[1],iy:e[2]},t,r)},Ct.prototype.getMonoGeodataUrl=function(e,t){return this.map.url.makeUrl(this.geodataUrl,{},null,t)};var Ft=Ct,Pt=I,Lt=s.a,Et=function(e,t){this.map=e,this.id=null,this.metaUrl="",this.mappingUrl="",this.baseUrl=this.map.url.baseUrl,this.baseUrlSchema=this.map.url.baseUrlSchema,this.baseUrlOrigin=this.map.url.baseUrlOrigin,this.lodRange=[0,0],this.tileRange=[[0,0],[0,0]],this.surfaces=[],this.parseJson(t),this.virtual=!0,this.ready=!1};Et.prototype.parseJson=function(e){if(this.id=e.id||null,this.metaUrl=this.processUrl(e.metaUrl,""),this.mappingUrl=this.processUrl(e.mapping,""),this.lodRange=e.lodRange||[0,0],this.tileRange=e.tileRange||[[0,0],[0,0]],this.strId=this.id?this.id.join(";"):null,this.id){var t=this.id.slice();t.sort(),this.strId=t.join(";")}if(e.extents){var r=e.extents.ll,i=e.extents.ur;this.extents=new Pt(r[0],r[1],r[2],i[0],i[1],i[2])}else this.extents=new Pt(0,0,0,1,1,1);this.specificity=Math.pow(2,this.lodRange[0])/((this.tileRange[1][0]-this.tileRange[1][0]+1)*(this.tileRange[1][1]-this.tileRange[1][1]+1)),Lt.loadBinary(this.mappingUrl,this.onMappingFileLoaded.bind(this),this.onMappingFileLoadError.bind(this),!!Lt.useCredentials&&-1!=this.jsonUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)},Et.prototype.onMappingFileLoaded=function(e){this.parseMappingFile(new DataView(e)),this.ready=!0,this.map.refreshView()},Et.prototype.onMappingFileLoadError=function(){},Et.prototype.parseMappingFile=function(e){var t=0,r="";if(r+=String.fromCharCode(e.getUint8(t,!0)),t+=1,r+=String.fromCharCode(e.getUint8(t,!0)),t+=1,"TM"!=r)return!1;var i=e.getUint16(t,!0);t+=2;for(var a=0;a<i;a++){var s=e.getUint8(t,!0);t+=1;for(var n=[],o=0;o<s;o++){var h=e.getUint16(t,!0);t+=2,(h=this.id[h])&&n.push(h)}1==n.length?this.surfaces.push(this.map.getSurface(n[0])):this.surfaces.push(this.map.getGlue(n.join(";")))}return!0},Et.prototype.getInfo=function(){return{metaUrl:this.metaUrl,mapping:this.mappingUrl,lodRange:this.lodRange,tileRange:this.tileRange}},Et.prototype.processUrl=function(e,t){return e?-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},Et.prototype.hasTile=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var r=e[1]>>t,i=e[2]>>t;return!(e[0]<this.lodRange[0]||e[0]>this.lodRange[1]||r<this.tileRange[0][0]||r>this.tileRange[1][0]||i<this.tileRange[0][1]||i>this.tileRange[1][1])},Et.prototype.hasTile2=function(e){var t=e[0]-this.lodRange[0],r=t<0;if(e[0]<this.lodRange[0]){t=-t;var i=this.tileRange[0][0]>>t,a=this.tileRange[0][1]>>t,s=this.tileRange[1][0]>>t,n=this.tileRange[1][1]>>t;if(e[0]>this.lodRange[1]||e[1]<i||e[1]>s||e[2]<a||e[2]>n)return[!1,!1]}else{var o=e[1]>>t,h=e[2]>>t;if(e[0]>this.lodRange[1]||o<this.tileRange[0][0]||o>this.tileRange[1][0]||h<this.tileRange[0][1]||h>this.tileRange[1][1])return[!1,!1]}return[!0,r]},Et.prototype.hasMetatile=function(e){if(e[0]>this.lodRange[1])return!1;var t=e[0]-this.lodRange[0];if(t>=0){var r=e[1]>>t,i=e[2]>>t;if(r<this.tileRange[0][0]||r>this.tileRange[1][0]||i<this.tileRange[0][1]||i>this.tileRange[1][1])return!1}else if(t=-t,e[1]<this.tileRange[0][0]>>t||e[1]>this.tileRange[1][0]>>t||e[2]<this.tileRange[0][1]>>t||e[2]>this.tileRange[1][1]>>t)return!1;return!0},Et.prototype.getSurface=function(e){return this.surfaces[e-1]},Et.prototype.getMetaUrl=function(e,t){return this.map.url.makeUrl(this.metaUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)};var Nt=st,Bt=ut,It=ft,kt=h,Rt=Ke,_t=gt,zt=Ft,Ut=Et,Dt=bt,Ot=function(e,t){this.map=e,this.mapConfig=t,this.parseConfig()};Ot.prototype.parseConfig=function(){this.parseSrses()&&this.parseBodies()&&this.parseReferenceFrame()&&this.parseCredits()&&this.parseStylesheets()&&this.parseSurfaces()&&this.parseGlues()&&this.parseVirtualSurfaces()&&this.parseBoundLayers()&&this.parseFreeLayers()&&this.parseViews()&&this.parseParams()&&this.parseBrowserOptions();var e=this.map.stats;e.loadedCount=0,e.loadErrorCount=0,e.loadFirst=performance.now(),e.loadLast=this.map.loadFirst},Ot.prototype.afterConfigParsed=function(){null!=this.mapConfig.position&&this.map.setPosition(this.mapConfig.position,!1),this.map.setView(this.map.initialView)},Ot.prototype.parseSrses=function(){var e=this.mapConfig.srses;if(this.map.srses={},null==e)return!1;for(var t in e)this.map.addSrs(t,new Rt(this.map,t,e[t]));return!0},Ot.prototype.parseBodies=function(){var e=this.mapConfig.bodies;if(this.map.bodies={},null==e)return!0;for(var t in e)this.map.addBody(t,new _t(this.map,e[t]));return!0},Ot.prototype.parseReferenceFrame=function(){var e=this.mapConfig.referenceFrame;return null!=e&&(this.map.referenceFrame=new It(this.map,e),!!this.map.referenceFrame.valid)},Ot.prototype.parseCredits=function(){var e=this.mapConfig.credits;if(this.map.credits={},null==e)return!1;for(var t in e)this.map.addCredit(t,new Nt(this.map,e[t]));return!0},Ot.prototype.parseSurfaces=function(){var e=this.mapConfig.surfaces;if(this.map.surfaces=[],null==e)return!1;for(var t=0,r=e.length;t<r;t++){var i=new zt(this.map,e[t]);this.map.addSurface(i.id,i)}return!0},Ot.prototype.parseVirtualSurfaces=function(){var e=this.mapConfig.virtualSurfaces;if(this.map.virtualSurfaces=[],!this.map.config.mapVirtualSurfaces)return!0;if(null==e)return!0;for(var t=0,r=e.length;t<r;t++){var i=new Ut(this.map,e[t]);this.map.virtualSurfaces[i.strId]=i}return!0},Ot.prototype.parseViews=function(){var e=this.mapConfig.namedViews;if(this.map.namedViews=[],e)for(var t in e)this.map.addNamedView(t,new kt(this.map,e[t],!0));var r=this.mapConfig.view;return"string"==typeof r&&(r=this.map.namedViews[r]),!r||(r=new kt(this.map,r,!0),this.map.initialView=r.getInfo(),!0)},Ot.prototype.parseGlues=function(){var e=this.mapConfig.glue;if(this.map.glues=[],null==e)return!0;for(var t=0,r=e.length;t<r;t++){var i=new zt(this.map,e[t],"glue");this.map.addGlue(i.id.join(";"),i)}return!0},Ot.prototype.parseBoundLayers=function(){var e=this.mapConfig.boundLayers;if(this.map.boundLayers=[],null==e)return!0;for(var t in e){var r=new Bt(this.map,e[t],t);this.map.addBoundLayer(t,r)}return!0},Ot.prototype.parseFreeLayers=function(){var e=this.mapConfig.freeLayers;if(this.map.freeLayers=[],null==e)return!0;for(var t in e){var r=new zt(this.map,e[t],"free");this.map.addFreeLayer(t,r)}return!0},Ot.prototype.parseStylesheets=function(){var e=this.mapConfig.stylesheets;if(this.map.stylesheets=[],null==e)return!0;for(var t in e){var r=new Dt(this.map,t,e[t]);this.map.addStylesheet(t,r)}return!0},Ot.prototype.parseParams=function(){return!0},Ot.prototype.parseBrowserOptions=function(){var e=this.mapConfig.browserOptions;return this.map.browserOptions={},null==e||(this.map.browserOptions=JSON.parse(JSON.stringify(e))),!0},Ot.prototype.cloneConfig=function(){return JSON.parse(JSON.stringify(this.mapConfig))};var Vt=Ot,Gt=a.b,jt=p.a,Ht=(qe.a,function(e){this.map=e,this.renderer=e.renderer,this.config=e.config,this.measure=e.measure,this.isProjected=this.map.getNavigationSrs().isProjected()});Ht.prototype.convertCoords=function(e,t,r){return this.map.referenceFrame.convertCoords(e,t,r)},Ht.prototype.movePositionCoordsTo=function(e,t,r,i){var a=e.getCoords();this.map.getNavigationSrs().getSrsInfo();if(i=null==i?1:i,this.isProjected){var s=jt.radians(t),n=[-Math.sin(s),Math.cos(s)];e.setCoords2([a[0]+n[0]*r,a[1]+n[1]*r])}else{var o=this.measure.getGeodesic().Direct(a[1],a[0],t,r);e.setCoords2([o.lon2,o.lat2]);var h=e.getOrientation();h[0]-=(o.azi1-o.azi2)*i,e.setOrientation(h)}return e},Ht.prototype.convertPositionViewMode=function(e,t){if(t==e.pos[0])return e;if("obj"==t){if("float"==e.getHeightMode()){var r=!0;this.convertPositionHeightMode(e,"fix",!0)}var i,a=e.getViewDistance(),s=e.getOrientation(),n=jt.radians(-s[1]),o=a*Math.sin(n);if(a*=Math.cos(n),this.isProjected){var h=jt.radians(s[0]),l=[-Math.sin(h),Math.cos(h)];(i=e.getCoords())[0]=i[0]+l[0]*a,i[1]=i[1]+l[1]*a}else this.movePositionCoordsTo(e,-s[0],a),i=e.getCoords();i[2]-=o,e.setCoords(i),r&&this.convertPositionHeightMode(e,"float",!0)}else"subj"==t&&(i=this.getPositionCameraCoords(e,e.getHeightMode()),e.setCoords(i));return e.pos[0]=t,e},Ht.prototype.convertPositionHeightMode=function(e,t,r){if(e.pos[3]==t)return e;var i=this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent),a=this.measure.getSurfaceHeight(e.getCoords(),i);return a[1],"float"==t?(e.pos[3]=t,e.pos[4]=e.pos[4]-a[0]):"fix"==t&&(e.pos[3]=t,e.pos[4]=e.pos[4]+a[0]),e},Ht.prototype.getPositionCameraCoords=function(e,t){var r=e.getOrientation(),i=Gt.create();Gt.multiply(jt.rotationMatrix(2,jt.radians(-r[0])),jt.rotationMatrix(0,jt.radians(r[1])),i);var a,s,n=0,o=-1;if("obj"==e.getViewMode()){a=e.getCoords(),"float"==e.getHeightMode()&&(o=this.measure.getOptimalHeightLod(a,e.getViewExtent(),this.config.mapNavSamplesPerViewExtent),n=(s=this.measure.getSurfaceHeight(a,o))[0]);var h=this.measure.getPositionCameraInfo(e,this.isProjected);if(this.isProjected)a[0]+=h.orbitCoords[0],a[1]+=h.orbitCoords[1],a[2]+=h.orbitCoords[2]+n;else{var l=this.convertCoords([a[0],a[1],a[2]+n],"navigation","physical");l[0]+=h.orbitCoords[0],l[1]+=h.orbitCoords[1],l[2]+=h.orbitCoords[2],a=this.convertCoords(l,"physical","navigation")}return"fix"==t||(-1==o&&(o=this.measure.getOptimalHeightLod(a,e.getViewExtent(),this.config.mapNavSamplesPerViewExtent)),s=this.measure.getSurfaceHeight(a,o),a[2]-=s[0]),a}return e.getHeightMode()==t?e.getCoords():(o=this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent),s=this.measure.getSurfaceHeight(e.getCoords(),o),a=e.getCoords(),"fix"==t?a[2]+=s[0]:a[2]-=s[0],a)},Ht.prototype.getPositionNavCoordsFromPublic=function(e,t){var r=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var i=this.measure.getSurfaceHeight(e.getCoords(),t);r[2]+=i[0]}return this.convertCoords(r,"public","navigation")},Ht.prototype.getPositionPublicCoords=function(e,t){var r=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var i=this.measure.getSurfaceHeight(e.getCoords(),t);r[2]+=i[0]}return this.convertCoords(r,"navigation","public")},Ht.prototype.getPositionPhysCoords=function(e,t,r){var i=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var a=this.measure.getSurfaceHeight(e.getCoords(),t);i[2]+=a[0]}return this.renderer.useSuperElevation&&r&&(i[2]=this.renderer.getSuperElevatedHeight(i[2])),this.convertCoords(i,"navigation","physical")},Ht.prototype.getPositionCameraSpaceCoords=function(e,t){var r=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var i=this.measure.getSurfaceHeight(e.getCoords(),t);r[2]+=i[0]}this.renderer.useSuperElevation&&(r[2]=this.renderer.getSuperElevatedHeight(r[2]));var a=this.convertCoords(r,"navigation","physical"),s=this.map.camera.position;return a[0]-=s[0],a[1]-=s[1],a[2]-=s[2],a},Ht.prototype.getPositionCanvasCoords=function(e,t,r,i){var a;if(r){var s=this.map.camera.position,n=e.getCoords();this.renderer.useSuperElevation&&!i&&(n=this.renderer.transformPointBySE(n)),a=[n[0]-s[0],n[1]-s[1],n[2]-s[2]]}else a=this.getPositionCameraSpaceCoords(e,t);return this.map.renderer.project2(a,this.map.camera.getMvpMatrix())},Ht.prototype.transformPhysCoordsBySE=function(e){return this.renderer.useSuperElevation?this.renderer.transformPointBySE(e):e},Ht.prototype.convertCoordsFromPhysToNav=function(e,t,r,i){if(e=this.convertCoords(e,"physical","navigation"),this.renderer.useSuperElevation&&i&&(e[2]=this.renderer.getUnsuperElevatedHeight(e[2])),"float"==t){r=null!=r?r:this.measure.getOptimalHeightLod(e,10,this.config.mapNavSamplesPerViewExtent);var a=this.measure.getSurfaceHeight(e,r);e[2]-=a[0]}return e},Ht.prototype.getGeodesicLinePoints=function(e,t,r,i){var a,s,n,o,h,l,u=this.measure.navigationSrsInfo,d=t[0]-e[0],c=t[1]-e[1],p=t[2]-e[2];this.isProjected?(n=Math.sqrt(d*d+c*c+p*p),h=1e6):(n=(s=(a=this.measure.getGeodesic()).Inverse(e[1],e[0],t[1],t[0])).s12,o=s.azi1,h=2*u.a*Math.PI/4007.5*10);for(var f=[e],m=h;m<n;m+=h)l=m/n,this.isProjected?f.push([e[0]+d*l,e[1]+c*l,e[2]+p*l]):(s=a.Direct(e[1],e[0],o,m),f.push([s.lon2,s.lat2,e[2]+p*l]));return f.push(t),f};var qt=Ht,Wt=a.d,Jt=a.b,Zt=p.a,Yt=qe.a,Kt=function(e){this.map=e,this.config=e.config,this.convert=e.convert,this.getPhysicalSrs=this.map.getPhysicalSrs(),this.navigationSrs=this.map.getNavigationSrs(),this.publicSrs=this.map.getPublicSrs(),this.navigationSrsInfo=this.navigationSrs.getSrsInfo(),this.isProjected=this.navigationSrs.isProjected();var t=this.getSpatialDivisionNodeDepths();this.minDivisionNodeDepth=t[0],this.maxDivisionNodeDepth=t[1]};Kt.prototype.getSurfaceAreaGeometry=function(e,t,r,i,a,s){var n=this.map.tree;0==n.surfaceSequence.length&&reurn[[]];var o=this.convert.convertCoords(e,"navigation","physical"),h=[0,0,0];Wt.normalize(o,h);var l=Wt.length(o),u=Math.atan(Math.tan(t/l));return n.params={coneVec:h,coneAngle:u,mode:r,limit:i,loaded:!0,areaTiles:[],loadMeshes:!0===a,loadTextures:!0===s},n.traceAreaTiles(n.surfaceTree,0,!1),[n.params.loaded,n.params.areaTiles]},Kt.prototype.getSurfaceHeight=function(e,t,r,i,a,s,n){var o=this.map.tree;if(0==o.surfaceSequence.length)return[0,!0,!0,null,null,null];if(!i){var h=this.getSpatialDivisionNode(e);i=h[0],a=h[1]}if(this.config.mapHeightLodBlend||(t=Math.floor(t)),n||this.config.mapIgnoreNavtiles)return this.getSurfaceHeightNodeOnly(null,t+8,r,t,null,i,a,s);if(null!=i&&null!==t){var l=o.findSurfaceTile(i.id),u={ll:i.extents.ll.slice(),ur:i.extents.ur.slice()},d={coords:a,desiredLod:Math.ceil(t),extents:u,metanode:null,heightMap:null,heightMapExtents:null,traceHeight:!0,waitingForNode:!1,finalNode:!1,bestHeightMap:999};o.traceHeight(l,d,!1);var c,p,f,m=d.metanode;if(d.heightMap){if(r){var g=this.map.stats;g.heightClass=2,g.heightLod=t,g.heightNode=m.id[0]}var v,y,b,x=m.id[0]>=Math.ceil(t);if(this.config.mapHeightLodBlend&&m.id[0]>0&&d.parent&&d.parent.heightMap&&t<=m.id[0]){y=this.getHeightmapValue(a,d.parent.metanode,d.parent),b=this.getHeightmapValue(a,m,d);var S=t-Math.floor(t);if(f=y+(b-y)*S,s)for(v=new Array(s.length),c=0,p=s.length;c<p;c++){var M=s[c];y=this.getHeightmapValue(M,d.parent.metanode,d.parent),b=this.getHeightmapValue(M,m,d),v[c]=[y+(b-y)*S,x,!0]}}else if(f=this.getHeightmapValue(a,m,d),s)for(v=new Array(s.length),c=0,p=s.length;c<p;c++)b=this.getHeightmapValue(s[c],m,d),v[c]=[b,x,!0];return[f,x,!0,null,null,v]}if(m)return[(x=this.getSurfaceHeightNodeOnly(e,t+8,r,t,null,i,a,s))[0],x[1],x[2],null,null,x[5]]}return[0,!1,!1,null,null,null]},Kt.prototype.getSurfaceHeightNodeOnly=function(e,t,r,i,a,s,n,o){var h,l=this.map.stats,u=this.map.tree;if(0==u.surfaceSequence.length)return[0,!0,!0,null,null,null];if(a)s=a[0],n=a[1];else{if(!s){var d=this.getSpatialDivisionNode(e);s=d[0],n=d[1]}if(o){h=new Array(o.length);for(var c=0,p=o.length;c<p;c++)h[c]=this.getSurfaceHeightNodeOnly(null,t,r,i,a,s,o[c])}}if(this.config.mapHeightLodBlend||(t=Math.floor(t)),!a&&this.config.mapHeightNodeBlend){var f=this.getSurfaceHeightNodeOnly(null,t,r,i,[s,[n[0],n[1],n[2]]]);if(f[2]){var m=f[3].ur[0]-f[3].ll[0],g=f[3].ur[1]-f[3].ll[1],v=(n[0]-f[3].ll[0])/m,y=(n[1]-f[3].ll[1])/g,b=this.getSurfaceHeightNodeOnly(null,t,r,i,[s,[n[0]+m,n[1],n[2]]]),x=this.getSurfaceHeightNodeOnly(null,t,r,i,[s,[n[0],n[1]+g,n[2]]]),S=this.getSurfaceHeightNodeOnly(null,t,r,i,[s,[n[0]+m,n[1]+g,n[2]]]),M=f[0]+(b[0]-f[0])*v;return[M+(x[0]+(S[0]-x[0])*v-M)*y,f[1],f[2],f[3],null,h]}return[f[0],f[1],f[2],f[3],null,h]}if(null!=s&&null!==t){var w=u.findSurfaceTile(s.id),T={ll:s.extents.ll.slice(),ur:s.extents.ur.slice()},A={coords:n,desiredLod:Math.ceil(t),extents:T,metanode:null,heightMap:null,heightMapExtents:null,traceHeight:!0,waitingForNode:!1,finalNode:!1,bestHeightMap:999};u.traceHeight(w,A,!0);var C,F,P=A.metanode;if(null!=P){if(P.bbox.maxSize<8e3?(C=P.bbox.center(),C=this.convert.convertCoords(C,"physical","navigation")):C=[0,0,n[2]],r&&(l.heightClass=1,l.heightLod=i,l.heightNode=P.id[0]),this.config.mapHeightLodBlend&&P.id[0]>0&&A.parent&&A.parent.metanode){F=A.parent.metanode.bbox.maxSize<8e3?this.convert.convertCoords(A.parent.metanode.bbox.center(),"physical","navigation"):[0,0,n[2]];var L=t-Math.floor(t);return[C[2]+(F[2]-C[2])*L,P.id[0]>=Math.floor(t)||A.finalNode,!A.waitingForNode||P.id[0]>=Math.floor(t)||A.finalNode,A.extents,P,h]}return[C[2],P.id[0]>=Math.floor(t)||A.finalNode,!A.waitingForNode||P.id[0]>=Math.floor(t)||A.finalNode,A.extents,P,h]}}return r&&(l.heightClass=0,l.heightLod=i,l.heightNode=0),[0,!1,!1,null,null,h]},Kt.prototype.getHeightmapValue=function(e,t,r){var i=r.heightMap,a=i.getImageData(),s=i.getImageExtents(),n=r.heightMapExtents,o=e[0]-n.ll[0],h=n.ur[1]-e[1],l=s[0]-1,u=s[1]-1;(o=l*(o/(n.ur[0]-n.ll[0])))<0&&(o=0),(h=u*(h/(n.ur[1]-n.ll[1])))<0&&(h=0),o>l&&(o=l),h>u&&(h=u);var d=Math.floor(o),c=Math.floor(h),p=o-d,f=h-c,m=c*s[0],g=c==u?m:m+s[0],v=d==l?d:d+1,y=a[4*(m+d)],b=a[4*(m+v)],x=a[4*(g+d)],S=y+(b-y)*p,M=S+(x+(a[4*(g+v)]-x)*p-S)*f;return M=t.minHeight+(t.maxHeight-t.minHeight)*(M/255)},Kt.prototype.getSpatialDivisionNode=function(e){for(var t=this.map.referenceFrame.getSpatialDivisionNodes(),r=null,i=-1,a=[0,0],s=0,n=t.length;s<n;s++){var o=t[s],h=o.getInnerCoords(e),l=o.extents;h[0]>=l.ll[0]&&h[0]<=l.ur[0]&&h[1]>=l.ll[1]&&h[1]<=l.ur[1]&&o.id[0]>i&&(r=o,i=o.id[0],a=h)}return[r,a]},Kt.prototype.getSpatialDivisionNodeAndExtents=function(e){for(var t,r=this.map.referenceFrame.getSpatialDivisionNodes(),i=null,a=[0,0],s=0,n=r.length;s<n;s++){var o=r[s];if((t=e[0]-o.id[0])>=0){var h=e[1]>>t,l=e[2]>>t;o.id[1]==h&&o.id[2]==l&&(i=o,a=[o.id[1]<<t,o.id[2]<<t])}}if(!i)return null;t=e[0]-i.id[0];var u=1/Math.pow(2,t),d=i.extents.ur,c=i.extents.ll,p=(d[0]-c[0])*u,f=(c[1]-d[1])*u,m=e[1]-a[0],g=e[2]-a[1];return[i,[[c[0]+p*m,d[1]+f*g],[c[0]+p*(m+1),d[1]+f*(g+1)]]]},Kt.prototype.getSpatialDivisionNodeFromId=function(e){var t=e[0]-this.maxDivisionNodeDepth,r=e[1]>>t,i=e[2]>>t;return this.map.referenceFrame.nodesMap[this.maxDivisionNodeDepth+"."+r+"."+i]},Kt.prototype.getSpatialDivisionNodeAndExtents2=function(e,t,r){if(!r)return[null,0,0,0,0];var i=e[0]-r.id[0],a=1/Math.pow(2,i),s=r.extents.ur,n=r.extents.ll,o=(s[0]-n[0])*a,h=(n[1]-s[1])*a,l=e[1]-(r.id[1]<<i),u=e[2]-(r.id[2]<<i);t[0]=r,t[1]=n[0]+o*l,t[2]=s[1]+h*u,t[3]=n[0]+o*(l+1),t[4]=s[1]+h*(u+1)},Kt.prototype.getSpatialDivisionNodeDepths=function(){for(var e=this.map.referenceFrame.getSpatialDivisionNodes(),t=-1,r=Number.MAX_VALUE,i=0,a=e.length;i<a;i++){var s=e[i];s.id[0]<r&&(r=s.id[0]),s.id[0]>t&&(t=s.id[0])}return[r,t]},Kt.prototype.getOptimalHeightLodBySampleSize=function(e,t){var r=this.getSpatialDivisionNode(e)[0];if(null!=r){var i=r.id[0],a=r.extents.ur[1]-r.extents.ll[1],s=Math.log(a/t)/Math.log(2);return s=s-8+i,Math.max(0,s)}return null},Kt.prototype.getOptimalHeightLod=function(e,t,r){var i=this.getSpatialDivisionNode(e)[0];if(null!=i){var a=i.id[0],s=i.extents.ur[1]-i.extents.ll[1],n=Math.log(r*s/t)/Math.log(2);return n=n-8+a,Math.max(0,n)}return null},Kt.prototype.getDistance=function(e,t,r,i){var a=i?this.publicSrs:this.navigationSrs,s=this.getPhysicalSrs.convertCoordsFrom(e,a),n=this.getPhysicalSrs.convertCoordsFrom(t,a),o=n[0]-s[0],h=n[1]-s[1],l=n[2]-s[2],u=Math.sqrt(o*o+h*h+l*l),d=this.navigationSrsInfo;if(this.isProjected)return[Math.sqrt(o*o+h*h),Zt.degrees(Math.atan2(o,h)),u];var c=this.getGeodesic().Inverse(e[1],e[0],t[1],t[0]);return c.s12>2*d.a*Math.PI/4007.5?r?[Math.sqrt(c.s12*c.s12+l*l),-c.azi1,u]:[c.s12,-c.azi1,u]:r?[Math.sqrt(o*o+h*h+l*l),-c.azi1,u]:[c.s12,-c.azi1,u]},Kt.prototype.getGeodesic=function(){var e=this.navigationSrsInfo;return new Yt.Geodesic.Geodesic(e.a,e.a/e.b-1)},Kt.prototype.getAzimuthCorrection=function(e,t){if(!this.getNavigationSrs().isProjected()){var r=this.getGeodesic().Inverse(e[0],e[1],t[0],t[1]),i=r.azi1-r.azi2;return isNaN(i)&&(i=0),i}return 0},Kt.prototype.getNED=function(e){var t,r,i=this.convert.convertCoords([e[0],e[1],0],"navigation","physical");if(this.isProjected)t=this.convert.convertCoords([e[0],e[1]+100,0],"navigation","physical"),r=this.convert.convertCoords([e[0]+100,e[1],0],"navigation","physical");else{var a=e[1]+90-1e-4,s=e[0]+180+1e-4;if(a<0||s>180){var n=this.getGeodesic(),o=n.Direct(e[1],e[0],0,-100);t=this.convert.convertCoords([o.lon2,o.lat2,0],"navigation","physical"),o=n.Direct(e[1],e[0],90,100),r=this.convert.convertCoords([o.lon2,o.lat2,0],"navigation","physical")}else t=this.convert.convertCoords([e[0],e[1]-1e-4,0],"navigation","physical"),r=this.convert.convertCoords([e[0]+1e-4,e[1],0],"navigation","physical")}var h=[t[0]-i[0],t[1]-i[1],t[2]-i[2]],l=[r[0]-i[0],r[1]-i[1],r[2]-i[2]],u=[0,0,0];return Wt.normalize(h),Wt.normalize(l),Wt.cross(h,l,u),Wt.normalize(u),{east:l,direction:h,north:u}},Kt.prototype.getNewNED=function(e,t){var r,i,a=this.convert.convertCoords([e[0],e[1],0],"navigation","physical");if(this.isProjected)r=this.convert.convertCoords([e[0],e[1]+100,0],"navigation","physical"),i=this.convert.convertCoords([e[0]+100,e[1],0],"navigation","physical");else{var s=e[1]+90+1e-4,n=e[0]+180+1e-4;if(s<0||n>180){var o=this.getGeodesic(),h=o.Direct(e[1],e[0],0,-100);r=this.convert.convertCoords([h.lon2,h.lat2,0],"navigation","physical"),h=o.Direct(e[1],e[0],90,-100),i=this.convert.convertCoords([h.lon2,h.lat2,0],"navigation","physical")}else r=this.convert.convertCoords([e[0],e[1]+1e-4,0],"navigation","physical"),i=this.convert.convertCoords([e[0]+1e-4,e[1],0],"navigation","physical")}var l=[r[0]-a[0],r[1]-a[1],r[2]-a[2]],u=[i[0]-a[0],i[1]-a[1],i[2]-a[2]],d=[0,0,0];if(Wt.normalize(l),Wt.normalize(u),Wt.cross(l,u,d),Wt.normalize(d),t){return[u[0],u[1],u[2],0,d[0],d[1],d[2],0,l[0],l[1],l[2],0,0,0,0,1]}return{east:u,direction:l,north:d}},Kt.prototype.getPositionCameraInfo=function(e,t,r){var i=e.getOrientation(),a=e.getViewDistance();r&&(i[1]=Zt.clamp(i[1],-89,90));var s,n,o,h,l,u,d,c,p,f,m,g,v,y=Zt.clamp(i[1],-89.5,89.5),b=Jt.create();Jt.multiply(Zt.rotationMatrix(2,Zt.radians(-i[0])),Zt.rotationMatrix(0,Zt.radians(y)),b),"obj"==e.getViewMode()?(s=[0,-a,0],Jt.multiplyVec3(b,s)):s=[0,0,0];var x={orbitCoords:null,distance:a,rotMatrix:null,vector:null,orbitHeight:s[2]},S=e.getCoords();if(t){b=Jt.create(),Jt.multiply(Zt.rotationMatrix(0,Zt.radians(-y-90)),Zt.rotationMatrix(2,Zt.radians(i[0])),b),o=(n=this.getNED(S)).north,h=n.east,l=n.direction,u=[h[0],h[1],h[2],0,l[0],l[1],l[2],0,o[0],o[1],o[2],0,0,0,0,1],c=[1,0,0],f=[0,1,0],p=[0,0,1],m=[1,0,0],g=[0,0,-1],v=[0,0,0],Wt.cross(m,g,v),Jt.multiplyVec3(b,p),Jt.multiplyVec3(b,c),Jt.multiplyVec3(b,f),Jt.multiplyVec3(b,m),Jt.multiplyVec3(b,g),Jt.multiplyVec3(b,v);var M=0;M=m[0],m[0]=m[1],m[1]=M,M=g[0],g[0]=g[1],g[1]=M,M=v[0],v[0]=v[1],v[1]=M,m[2]=-m[2],g[2]=-g[2],v[2]=-v[2],d=[c[0],c[1],c[2],0,f[0],f[1],f[2],0,p[0],p[1],p[2],0,0,0,0,1],x.vector=Wt.normalize([-s[0],-s[1],-s[2]]),x.vector2=x.vector,x.orbitCoords=s,x.rotMatrix=d}else{o=(n=this.getNED(S)).north,h=n.east,l=n.direction,u=[h[0],h[1],h[2],0,l[0],l[1],l[2],0,o[0],o[1],o[2],0,0,0,0,1];var w=Jt.create();Jt.multiply(Zt.rotationMatrix(0,Zt.radians(-y-90)),Zt.rotationMatrix(2,Zt.radians(i[0])),w),c=[1,0,0],f=[0,1,0],p=[0,0,1],S=e.getCoords();var T=Jt.create();Jt.multiply(Zt.rotationMatrix(0,Zt.radians(S[1]-90)),Zt.rotationMatrix(2,Zt.radians(-S[0]-90)),T),Jt.multiplyVec3(T,p),Jt.multiplyVec3(T,c),Jt.multiplyVec3(T,f),u=[c[0],c[1],c[2],0,f[0],f[1],f[2],0,p[0],p[1],p[2],0,0,0,0,1],v=[1,0,0],m=[0,1,0],g=[0,0,1],Jt.multiplyVec3(u,m),Jt.multiplyVec3(u,g),Jt.multiplyVec3(u,v),Jt.multiplyVec3(w,v),Jt.multiplyVec3(w,m),Jt.multiplyVec3(w,g),d=[v[0],v[1],v[2],0,m[0],m[1],m[2],0,g[0],g[1],g[2],0,0,0,0,1],u=Jt.inverse(u),Jt.multiplyVec3(u,s),x.vector=[-d[2],-d[6],-d[10]]}return x.orbitCoords=s,x.rotMatrix=d,x};var Xt=Kt,Qt=(p.a,a.d),$t=s.a,er=(ge.a,function(){this.bintree=null,this.pathTable=null,this.totalNodes=0,this.pathTableSize=1,this.nodesIndex=0,this.rootSize=1});er.prototype.countNode=function(e,t){this.totalNodes++;var r=e.content;if(r&&r.uri){var i=r.uri.split(".");if(i.length>1){var a=i[i.length-1];i.pop();var s=i.join(".");"json"==a?this.pathTableSize+=s.length+1+4:"mesh"==a&&(this.pathTableSize+=s.length+1)}}var n=e.children;if(n)for(var o=0,h=n.length;o<h;o++)this.countNode(n[o])},er.prototype.processNode=function(e,t,r,i){var a=9*t,s=e.content;if(s&&s.uri){var n=s.uri.split(".");if(n.length>1){var o=n[n.length-1];n.pop();var h=n.join(".");"json"==o?(this.bintree[a]=this.pathTableSize|1<<31,this.pathTableSize+=4):"mesh"==o&&(this.bintree[a]=this.pathTableSize);for(var l=0,u=h.length;l<u;l++)this.pathTable[this.pathTableSize++]=h.charCodeAt(l);this.pathTable[this.pathTableSize++]=0}}var d=e.children;if(d)for(l=0,u=d.length;l<u;l++){var c=d[l],p=c.boundingVolume;if(p){var f=c.extras,m=0;f&&(m=f.ci);if(p.region){this.totalNodes++;var g=this.totalNodes;this.bintree[a+1+m]=g,this.processNode(c,g,r+1)}}}},er.prototype.processJSON=function(e,t){if(e){if(this.rootPath="",this.countNode(e.root),this.bintree=new Uint32Array(9*this.totalNodes),this.pathTable=new Uint8Array(this.pathTableSize+1),this.totalNodes=0,this.pathTableSize=1,t.root){var r=e.extras,i=r.extents,a=[(i[0][0]+i[1][0]+i[2][0]+i[3][0]+i[4][0]+i[5][0]+i[6][0]+i[7][0])/8,(i[0][1]+i[1][1]+i[2][1]+i[3][1]+i[4][1]+i[5][1]+i[6][1]+i[7][1])/8,(i[0][2]+i[1][2]+i[2][2]+i[3][2]+i[4][2]+i[5][2]+i[6][2]+i[7][2])/8],s=[i[1][0]-i[0][0],i[1][1]-i[0][1],i[1][2]-i[0][2]],n=[i[1][0]-i[2][0],i[1][1]-i[2][1],i[1][2]-i[2][2]],o=[i[4][0]-i[0][0],i[4][1]-i[0][1],i[4][2]-i[0][2]];s[0]=-s[0],s[1]=-s[1],s[2]=-s[2],n[0]=-n[0],n[1]=-n[1],n[2]=-n[2];var h=i[1];this.rootPoints=[[h[0],h[1],h[2]],[h[0]+n[0],h[1]+n[1],h[2]+n[2]],[h[0]+n[0]+s[0],h[1]+n[1]+s[1],h[2]+n[2]+s[2]],[h[0]+s[0],h[1]+s[1],h[2]+s[2]],[h[0]+o[0],h[1]+o[1],h[2]+o[2]],[h[0]+n[0]+o[0],h[1]+n[1]+o[1],h[2]+n[2]+o[2]],[h[0]+n[0]+s[0]+o[0],h[1]+n[1]+s[1]+o[1],h[2]+n[2]+s[2]+o[2]],[h[0]+s[0]+o[0],h[1]+s[1]+o[1],h[2]+s[2]+o[2]]],this.rootCenter=a,this.rootRadius=Qt.distance(a,i[0]),this.rootTexelSize=r.nominalResolution*Math.pow(2,r.depth)}else this.rootPoints=[],this.rootCenter=[],this.rootRadius=1,this.rootTexelSize=1;this.processNode(e.root,0,0),this.totalNodes++}},er.prototype.loadJSON=function(e,t,r){$t.loadJSON(e,this.onLoaded.bind(this,t,r),null)},er.prototype.onLoaded=function(e,t,r){this.processJSON(r,e),t&&t(e,{bintree:this.bintree,pathTable:this.pathTable,totalNodes:this.totalNodes,rootSize:this.rootSize,points:this.rootPoints,center:this.rootCenter,radius:this.rootRadius,texelSize:this.rootTexelSize})};var tr=a.d,rr=a.b,ir=I,ar=p.a,sr=s.a,nr=Oe,or=ge.a,hr=function(e,t,r,i,a){this.id=e,this.bbox=null,this.origin=r||[0,0,0],this.gpu=i,this.gl=i.gl,this.renderer=a,this.jobs=[],this.reduced=0,this.geometries={},this.subjob=null,this.mv=new Float32Array(16),this.mvp=new Float32Array(16),this.loadMode=0,this.geFactor=1/16,this.geFactor2=.5,this.geNormalized=!1,null!=t&&null!=t[0]&&null!=t[1]&&(this.bbox=new ir(t[0][0],t[0][1],t[0][2],t[1][0],t[1][1],t[1][2])),this.binFiles=[],this.size=0,this.polygons=0};function lr(e,t){if(null==e||"object"!=typeof e)return this;if(null==e.points)return this;var r=e.points,i=e.color||[255,255,255,255],a=null!=e.depthOffset?e.depthOffset:null,s=e.size||2,n=null==e.screenSpace||e.screenSpace,o=null!=e.depthTest&&e.depthTest,h=null!=e.blend&&e.blend,l=null!=e.writeDepth&&e.writeDepth,u=null!=e.useState&&e.useState;return i=[i[0]*(1/255),i[1]*(1/255),i[2]*(1/255),i[3]*(1/255)],t.draw.drawLineString(r,n,s,i,a,o,h,l,u),this}hr.prototype.kill=function(){for(var e=0,t=this.jobs.length;e<t;e++){var r=this.jobs[e];switch(r.type){case 1:case 11:r.vertexPositionBuffer&&this.gl.deleteBuffer(r.vertexPositionBuffer),r.vertexElementBuffer&&this.gl.deleteBuffer(r.vertexElementBuffer);break;case 3:case 2:case 4:case 5:r.vertexPositionBuffer&&this.gl.deleteBuffer(r.vertexPositionBuffer),r.vertexNormalBuffer&&this.gl.deleteBuffer(r.vertexNormalBuffer),r.vertexElementBuffer&&this.gl.deleteBuffer(r.vertexElementBuffer);break;case 6:r.vertexPositionBuffer&&this.gl.deleteBuffer(r.vertexPositionBuffer),r.vertexTexcoordBuffer&&this.gl.deleteBuffer(r.vertexTexcoordBuffer),r.vertexElementBuffer&&this.gl.deleteBuffer(r.vertexElementBuffer);break;case 7:case 8:r.vertexPositionBuffer&&this.gl.deleteBuffer(r.vertexPositionBuffer),r.vertexTexcoordBuffer&&this.gl.deleteBuffer(r.vertexTexcoordBuffer),r.vertexOriginBuffer&&this.gl.deleteBuffer(r.vertexOriginBuffer),r.vertexElementBuffer&&this.gl.deleteBuffer(r.vertexElementBuffer)}}for(var i in this.geometries){var a=this.geometries[i],s=this.renderer.geometries[i];for(this.geometries[i]=null,e=0,t=a.length;e<t;e++)a[e]==s&&(this.renderer.geometries[i]=null)}},hr.prototype.getSize=function(){return this.size},hr.prototype.getZbufferOffset=function(){return this.size},hr.prototype.addGeometry=function(e){var t=e.id;this.geometries[t]?this.geometries[t].push(e):this.geometries[t]=[e],this.renderer.geometries[t]=e},hr.prototype.convertColor=function(e){var t=1/255;return[e[0]*t,e[1]*t,e[2]*t,e[3]*t]},hr.prototype.addLineJob=function(e){var t=this.gl,r=e.vertexBuffer,i={};if(13==e.type?i.type=11:i.type=1,i.program=this.renderer.progLine,i.color=this.convertColor(e.color),i.zIndex=e["z-index"]+256,i.clickEvent=e["click-event"],i.hoverEvent=e["hover-event"],i.enterEvent=e["enter-event"],i.leaveEvent=e["leave-event"],i.advancedHit=e.advancedHit,i.hitable=e.hitable,i.eventInfo=e.eventInfo,i.style=e.style||0,i.stencil=!1!==e.stencil,i.culling=e.culling||0,i.state=e.state,i.center=e.center,i.lod=e.lod,i.lineWidth=e["line-width"],i.zbufferOffset=e["zbuffer-offset"],i.reduced=!1,i.ready=!0,i.bbox=this.bbox,i.program.isReady()&&(!i.advancedHit||(i.program2=this.renderer.progELine,i.program2.isReady()))){if(i.vertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.vertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),i.vertexPositionBuffer.itemSize=3,i.vertexPositionBuffer.numItems=r.length/3,i.advancedHit){i.program=this.renderer.progLine;var a=e.elementBuffer;i.vertexElementBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.vertexElementBuffer),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),i.vertexElementBuffer.itemSize=1,i.vertexElementBuffer.numItems=a.length}this.jobs.push(i),this.size+=4*r.length,this.polygons+=r.length/9}},hr.prototype.addExtentedLineJob=function(e){var t=this.gl,r=e.vertexBuffer,i=e.normalBuffer,a={};switch(a.type=e.type,a.type){case 6:a.type=3;break;case 7:a.type=2;break;case 9:a.type=4;break;case 10:a.type=5}if(a.color=this.convertColor(e.color),a.zIndex=e["z-index"]+256,a.clickEvent=e["click-event"],a.hoverEvent=e["hover-event"],a.hitable=e.hitable,a.eventInfo=e.eventInfo,a.enterEvent=e["enter-event"],a.leaveEvent=e["leave-event"],a.advancedHit=e.advancedHit,a.widthByRatio="ratio"==e["width-units"],a.state=e.state,a.center=e.center,a.lod=e.lod,a.lineWidth=e["line-width"],a.zbufferOffset=e["zbuffer-offset"],a.reduced=!1,a.ready=!0,a.bbox=this.bbox,null!=e.texture){var s=e.texture,n=s[0];a.texture=[this.renderer.getBitmap(n.url,n.filter||"linear",n.tiled||!1),s[1],s[2],s[3],s[4]];var o=this.convertColor(e.background);0!=o[3]&&(a.background=o)}switch(a.type){case 3:a.program=0!=o[3]?this.renderer.progTBLine:this.renderer.progTLine;break;case 2:a.program=this.renderer.progRLine;break;case 4:a.program=this.renderer.progLine3;break;case 5:a.program=0!=o[3]?this.renderer.progTPBLine:this.renderer.progTPLine}if(a.program.isReady()){if(a.advancedHit){switch(a.type){case 3:a.program2=this.renderer.progETLine;break;case 2:a.program2=this.renderer.progERLine;break;case 4:a.program2=this.renderer.progELine3;break;case 5:a.program2=this.renderer.progETPLine}if(!a.program2.isReady())return}if(a.vertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,a.vertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),a.vertexPositionBuffer.itemSize=4,a.vertexPositionBuffer.numItems=r.length/4,a.vertexNormalBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,a.vertexNormalBuffer),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),a.vertexNormalBuffer.itemSize=4,a.vertexNormalBuffer.numItems=i.length/4,a.advancedHit){var h=e.elementBuffer;a.vertexElementBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,a.vertexElementBuffer),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),a.vertexElementBuffer.itemSize=1,a.vertexElementBuffer.numItems=h.length}this.jobs.push(a),this.size+=4*r.length+4*i.length,this.polygons+=r.length/12}},hr.prototype.processReduce=function(e){if(e.reduce){switch(e.reduce[0]){case"tilt":e.reduce[0]=1;break;case"tilt-cos":e.reduce[0]=2;break;case"tilt-cos2":e.reduce[0]=3;break;case"scr-count":e.reduce[0]=4;break;case"scr-count2":e.reduce[0]=5,this.renderer.drawnGeodataTilesUsed=!0;break;case"scr-count3":e.reduce[0]=6,this.renderer.drawnGeodataTilesUsed=!0;break;case"scr-count4":e.reduce[0]=7;break;case"scr-count5":e.reduce[0]=8;break;case"scr-count6":e.reduce[0]=9;break;case"scr-count7":e.reduce[0]=10;break;case"scr-count8":e.reduce[0]=11}e.reduce[5]=0,e.reduce[6]=0,e.reduce[7]=0,e.reduce[0]>=7&&e.reduce[0]<=11&&(10==e.reduce[0]||11==e.reduce[0]?(e.reduce[1]=Math.abs(e.reduce[1]),e.reduce[3]=e.reduce[1]*e.reduce[2],e.reduce[2]=e.reduce[1],e.reduce[4]=0):(e.reduce[2]=Math.abs(e.reduce[1]),this.renderer.config.mapFeaturesReduceFactor>=1||9==e.reduce[0]?e.reduce[1]=e.reduce[2]:e.reduce[1]=Math.floor(Math.log(500*e.reduce[2])/Math.log(1.0017)+5e3)))}},hr.prototype.addLineLabelJob=function(e){var t=this.gl;if(e.singleBuffer)var r=e.singleBuffer,i=e.singleBuffer2;else var a=e.vertexBuffer,s=e.texcoordsBuffer;var n={type:6};n.program=this.renderer.progText,n.color=this.convertColor(e.color),n.color2=this.convertColor(e.color2),n.outline=e.outline,n.zIndex=e["z-index"]+256,n.visibility=e.visibility,n.culling=e.culling,n.clickEvent=e["click-event"],n.hoverEvent=e["hover-event"],n.enterEvent=e["enter-event"],n.leaveEvent=e["leave-event"],n.hitable=e.hitable,n.eventInfo=e.eventInfo,n.state=e.state,n.center=e.center,n.lod=e.lod,n.labelPoints=e.labelPoints,n.labelIndex=e.labelIndex,n.labelSize=e.labelSize,n.zbufferOffset=e["zbuffer-offset"],n.hysteresis=e.hysteresis,n.noOverlap=e.noOverlap,n.labelPointsBuffer={id:-1,points:[],points2:[]},n.id=n.hysteresis?n.hysteresis[2]:null,n.reduced=!1,n.ready=!0,n.bbox=this.bbox,n.reduce=e.reduce,this.processReduce(n),n.files=e.files||[];var o=e.fonts||["#default"];n.fonts=o;for(var h=0,l=o.length;h<l;h++)o[h]=this.renderer.fonts[o[h]];n.program=this.renderer.progText2,n.program.isReady()&&(r?(n.singleBuffer=r,n.singleBuffer2=i,n.textVector=e.textVector,this.polygons+=r.length/12*2):(n.vertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n.vertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),n.vertexPositionBuffer.itemSize=4,n.vertexPositionBuffer.numItems=a.length/4,n.vertexTexcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n.vertexTexcoordBuffer),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW),n.vertexTexcoordBuffer.itemSize=4,n.vertexTexcoordBuffer.numItems=s.length/4,this.size+=4*a.length+4*s.length,this.polygons+=a.length/12),this.jobs.push(n))},hr.prototype.addIconJob=function(e,t,r){var i=this.gl,a=e.vertexBuffer,s=e.texcoordsBuffer,n=e.originBuffer,o=e.singleBuffer,h=e.stick,l=1/255,u={tile:r};if(u.type=t?8:7,u.program=this.renderer.progIcon,u.color=this.convertColor(e.color),u.zIndex=e["z-index"]+256,u.visibility=e.visibility,u.culling=e.culling,u.clickEvent=e["click-event"],u.hoverEvent=e["hover-event"],u.enterEvent=e["enter-event"],u.leaveEvent=e["leave-event"],u.hitable=e.hitable,u.eventInfo=e.eventInfo,u.state=e.state,u.center=e.center,u.stick=[h[0],h[1],h[2],h[3]*l,h[4]*l,h[5]*l,h[6]*l,h[7]],u.lod=e.lod,u.zbufferOffset=e["zbuffer-offset"],u.hysteresis=e.hysteresis,u.noOverlap=e.noOverlap,u.id=u.hysteresis?u.hysteresis[2]:null,u.reduced=!1,u.ready=!0,u.reduce=e.reduce,this.processReduce(u),u.program.isReady()){if(!0!==t){var d=e.icon;u.texture=this.renderer.getBitmap(null,d.filter||"linear",d.tiled||!1,d.hash,!0),u.files=[]}else{u.color2=this.convertColor(e.color2),u.outline=e.outline,u.size=e.size,u.origin=e.origin,u.files=e.files||[],u.index=e.index||0;var c=e.fonts||["#default"];u.fonts=c,u.gamma=[1.4142*u.outline[2]/u.size,1.4142*u.outline[3]/u.size],u.origin&&(u.origin=new Float32Array(u.origin));for(var p=0,f=c.length;p<f;p++)c[p]=this.renderer.fonts[c[p]];u.program=this.renderer.progIcon2}null==u.visibility||Array.isArray(u.visibility)||(u.visibility=[u.visibility]),o?(u.singleBuffer=o,this.polygons+=2):(u.vertexPositionBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,u.vertexPositionBuffer),i.bufferData(i.ARRAY_BUFFER,a,i.STATIC_DRAW),u.vertexPositionBuffer.itemSize=4,u.vertexPositionBuffer.numItems=a.length/4,u.vertexTexcoordBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,u.vertexTexcoordBuffer),i.bufferData(i.ARRAY_BUFFER,s,i.STATIC_DRAW),u.vertexTexcoordBuffer.itemSize=4,u.vertexTexcoordBuffer.numItems=s.length/4,u.vertexOriginBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,u.vertexOriginBuffer),i.bufferData(i.ARRAY_BUFFER,n,i.STATIC_DRAW),u.vertexOriginBuffer.itemSize=3,u.vertexOriginBuffer.numItems=n.length/3,this.size+=4*u.vertexPositionBuffer.numItems+4*u.vertexOriginBuffer.numItems+4*u.vertexTexcoordBuffer.numItems,this.polygons+=u.vertexPositionBuffer.numItems/12),this.subjobs?this.subjobs.push(u):this.vsjobs?this.vsjobs.push(u):this.jobs.push(u)}},hr.prototype.addPack=function(e){if(this.subjobs.length){for(var t={type:9,subjobs:this.subjobs,culling:180,zIndex:0,ready:!0},r=0,i=t.subjobs.length;r<i;r++){var a=t.subjobs[r];if(a.noOverlap){if(t.noOverlap){var s=t.noOverlap,n=a.noOverlap;n[0]<s[0]&&(s[0]=n[0]),n[1]<s[1]&&(s[1]=n[1]),n[2]>s[2]&&(s[2]=n[2]),n[3]>s[3]&&(s[3]=n[3])}else t.noOverlap=a.noOverlap;a.noOverlap=null}a.culling<=t.culling&&(t.culling=a.culling,a.culling=180),a.visibility&&(t.visibility=a.visibility,a.visibility=null),a.stick&&(t.stick=a.stick,a.stick=[0,0,0,255,255,255,255,0]),a.zIndex>t.zIndex&&(t.zIndex=a.zIndex),a.center&&(t.center=a.center),t.eventInfo=a.eventInfo,t.reduce=a.reduce,t.hysteresis=a.hysteresis,t.id=a.id}this.vsjobs?this.vsjobs.push(t):this.jobs.push(t),this.subjobs=null}else this.subjobs=null},hr.prototype.addVSPoint=function(e,t){var r={tile:t,type:10};r.zIndex=e["z-index"]+256,r.visibility=e.visibility,r.culling=e.culling,r.hitable=!1,r.eventInfo=e.eventInfo,r.state=e.state,r.center=e.center,r.lod=e.lod,r.hysteresis=e.hysteresis,r.id=r.hysteresis?r.hysteresis[2]:null,r.reduced=!1,r.ready=!0,r.reduce=e.reduce,r.vswitch=[],this.vsjob=r},hr.prototype.storeVSJobs=function(e){this.vsjob.vswitch.push([e.viewExtent,this.vsjobs]),this.vsjobs=[]},hr.prototype.addVSwitch=function(){this.vsjob&&this.jobs.push(this.vsjob),this.vsjobs=null},hr.prototype.addMeshJob=function(e,t){var r={type:12};if(r.path=e.path,r.textures=[],r.resources=new nr(this.renderer.core.map,null,null),r.path){var i=r.path.split(".");i.length>1&&(i.pop(),r.texturePath=i.join(".")),r.mesh=r.resources.getMesh(r.path,null)}this.jobs.push(r)},hr.prototype.copyBuffer=function(e,t,r){return new Uint8Array(e.buffer).set(new Uint8Array(t.buffer,r,e.byteLength)),e},hr.prototype.addRenderJob2=function(e,t,r,i){var a,s,n,o;if(i)o=i.type,a=i.data;else{var h=new DataView(e.buffer);o=e[t],t+=1,15!=o&&16!=o&&17!=o&&19!=o&&18!=o&&(n=h.getUint32(t),t+=4,s=sr.unint8ArrayToString(new Uint8Array(e.buffer,t,n)),t+=n,a=JSON.parse(s))}switch(o){case 13:case 6:a.type=o,n=h.getUint32(t),t+=4,a.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.vertexBuffer.byteLength,a.advancedHit&&(n=h.getUint32(t),t+=4,a.elementBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.elementBuffer.byteLength),this.addLineJob(a);break;case 8:case 7:case 9:case 10:a.type=o,n=h.getUint32(t),t+=4,a.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.vertexBuffer.byteLength,n=h.getUint32(t),t+=4,a.normalBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.normalBuffer.byteLength,a.advancedHit&&(n=h.getUint32(t),t+=4,a.elementBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.elementBuffer.byteLength),this.addExtentedLineJob(a);break;case 11:n=h.getUint32(t),t+=4,a.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.vertexBuffer.byteLength,n=h.getUint32(t),t+=4,a.texcoordsBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.texcoordsBuffer.byteLength,this.addLineLabelJob(a);break;case 12:n=h.getUint32(t),t+=4,a.singleBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.singleBuffer.byteLength,n=h.getUint32(t),t+=4,a.singleBuffer2=this.copyBuffer(new Float32Array(n),e,t),t+=a.singleBuffer2.byteLength,this.addLineLabelJob(a);break;case 3:case 1:n=h.getUint32(t),t+=4,a.singleBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.singleBuffer.byteLength,this.addIconJob(a,1==o,r);break;case 4:case 2:n=h.getUint32(t),t+=4,a.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.vertexBuffer.byteLength,n=h.getUint32(t),t+=4,a.originBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.originBuffer.byteLength,n=h.getUint32(t),t+=4,a.texcoordsBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=a.texcoordsBuffer.byteLength,this.addIconJob(a,2==o,r);break;case 5:case 14:n=h.getUint32(t),t+=4,a.geometryBuffer=this.copyBuffer(new Float64Array(n),e,t),t+=a.originBuffer.byteLength,n=h.getUint32(t),t+=4,a.indicesBuffer=this.copyBuffer(new Uint32Array(n),e,t),t+=a.indicesBuffer.byteLength,n=h.getUint32(t),t+=4,this.addGeometry(a);break;case 15:this.subjobs=[],t+=4;break;case 16:this.addPack(),t+=4;break;case 20:this.addVSPoint(a,r);break;case 17:this.vsjobs=[],this.vsjob=null,t+=4;break;case 19:this.addVSwitch(),t+=4;break;case 18:a={viewExtent:h.getUint32(t)},t+=4,this.storeVSJobs(a);break;case 21:var l=a;if(l.nodes=[],l.jobs=[],l.parent=this.currentNode,l.volume){var u=l.volume.points,d=[u[0][0],u[0][1],u[0][2],u[1][0],u[1][1],u[1][2],u[2][0],u[2][1],u[2][2],u[3][0],u[3][1],u[3][2],u[4][0],u[4][1],u[4][2],u[5][0],u[5][1],u[5][2],u[6][0],u[6][1],u[6][2],u[7][0],u[7][1],u[7][2]];l.volume.points2=d}this.rootNode?(this.currentNode.nodes.push(l),this.currentNode=l):(this.rootNode=l,this.currentNode=l,this.oldJobs=this.jobs),this.jobs=l.jobs;break;case 22:this.currentNode.parent?(this.currentNode=this.currentNode.parent,this.jobs=this.currentNode.jobs):(this.currentNode=this.currentNode.parent,this.jobs=this.oldJobs);break;case 23:this.addMeshJob(a,r);break;case 24:this.currentNode&&(this.currentNode.path=a.path)}return t},hr.prototype.addRenderJob=function(e,t){switch(e.type){case"polygon":case"flat-line":this.addLineJob(e);break;case"flat-tline":case"flat-rline":case"pixel-line":case"pixel-tline":this.addExtentedLineJob(e);break;case"line-label":this.addLineLabelJob(e);break;case"icon":this.addIconJob(e);break;case"label":this.addIconJob(e,!0,t);break;case"point-geometry":case"line-geometry":this.addGeometry(e);break;case"pack-begin":this.subjobs=[];break;case"pack-end":this.addPack();break;case"vspoint":this.addVSPoint(e,t);break;case"vswitch-begin":this.vsjobs=[],this.vsjob=null;break;case"vswitch-store":this.storeVSJobs(e);break;case"vswitch-end":this.addVSwitch();break;case"node-begin":this.nodeBegin();break;case"node-end":this.nodeEnd();break;case"mesh":this.addMesh()}},hr.prototype.getNodeLOD=function(e){for(var t=0;e.parent;)t++,e=e.parent;return t},hr.prototype.getNodeTexelSize=function(e,t){var r=e.volume.center,i=this.renderer.cameraPosition,a=tr.length([r[0]-i[0],r[1]-i[1],r[2]-i[2]]);return(a-=e.volume.radius)<=0?[Number.POSITIVE_INFINITY,.1]:[this.renderer.camera.scaleFactor2(a)*t,a]},hr.prototype.drawNodeVolume=function(e,t){var r=this.renderer;lr({points:[e[0],e[1],e[2],e[3],e[0],e[4],e[5],e[6],e[7],e[4]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},r),lr({points:[e[1],e[5]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},r),lr({points:[e[2],e[6]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},r),lr({points:[e[3],e[7]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},r)},hr.prototype.drawNode=function(e,t,r,i){var a=this.renderer,s=this.map.draw.debug,n=e.jobs;if(a.drawnNodes++,s.drawNBBoxes){var o=e.volume.points,h=[255,0,255,255];e.tileset&&(h=[0,255,0,255]),t&&(h=[255,255,0,255]),s.drawSpaceBBox&&e.volume2?this.drawNodeVolume(e.volume2.points,[255,0,0,255]):this.drawNodeVolume(o,h);var l=this.renderer.cameraPosition,u=e.volume.center,d=[l[0]-u[0],l[1]-u[1],l[2]-u[2]];tr.normalize(d),tr.scale(d,e.volume.radius),u=[u[0]+d[0]-l[0],u[1]+d[1]-l[1],u[2]+d[2]-l[2]],u=this.renderer.core.getRendererInterface().getCanvasCoords(u,this.renderer.camera.getMvpMatrix());if(s.drawLods&&(f=""+e.lod,a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]-8),8,f,[1,0,0,1],u[2])),s.drawOctants&&(f=""+e.index,a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+6),8,f,[1,1,0,1],u[2])),s.drawDistance){var c=this.getNodeTexelSize(e,e.precision*a.curSize[0]);f=c[1].toFixed(2)+" "+c[0].toFixed(2)+" "+e.precision.toFixed(3),a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+34),8,f,[.5,.5,1,1],u[2])}if(s.drawFaceCount)(p=n[0]&&12==n[0].type?n[0].mesh:null)&&(f=p.faces+" - "+p.submeshes.length,a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+20),8,f,[0,1,0,1],u[2]));if(s.drawResources&&n[0]&&(f=(this.getGpuSize(n[0])/1048576).toFixed(2)+"MB",a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+6),8,f,[0,1,0,1],u[2])),s.drawSurfaces&&n[0]){var p,f="";if(p=n[0]&&12==n[0].type?n[0].mesh:null){var m=p.mapLoaderUrl,g=(m=m.replace(".mesh","")).split("/");f=g.length>1?g[g.length-2]+"/"+g[g.length-1]:g[0]}a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+20),8,f,[0,1,0,1],u[2])}if(s.drawTextureSize)if(p=n[0]&&12==n[0].type?n[0].mesh:null){var v=p.submeshes;for(x=0,S=v.length;x<S;x++){var y;if(v[x].internalUVs){if(y=n[0].direct?v[x].texture:n[0].textures[x]){var b=y.getGpuTexture();b&&(f="["+x+"]: "+b.width+" x "+b.height,a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+2*(17+4*x*2)),8,f,[1,1,1,1],u[2]))}}else f="["+x+"]: 256 x 256",a.draw.drawText(Math.round(u[0]-.5*a.draw.getTextSize(8,f)),Math.round(u[1]+2*(17+4*x*2)),8,f,[1,1,1,1],u[2])}}}for(var x=0,S=n.length;x<S;x++){var M=n[x];12==M.type&&this.isMeshReady(M,null,null,null,!0,e)&&this.drawMesh(M,e,r,i)}},hr.prototype.isMeshReady=function(e,t,r,i,a,s){var n=e.mesh,o=n.submeshes,h=!0,l=this.map.stats;if(n.isReady(t,r,i)){a||(l.gpuNeeded+=n.gpuSize);for(var u=0,d=o.length;u<d;u++){var c=o[u];if(c.internalUVs){var p;if(e.direct){if(!c.texture){m=(m=n.mapLoaderUrl).replace(".mesh","-"+u+".jpg");var f=new nr(this.renderer.core.map,null,null);c.texture=f.getTexture(m,0,null,null,null,!0)}p=c.texture}else{if(!e.texturePath)continue;if(!e.textures[u]){var m=e.texturePath+"-"+u+".jpg";e.textures[u]=e.resources.getTexture(m,0,null,null,null,!0)}p=e.textures[u]}p.isReady(t,r,i)||(h=!1),a||(l.gpuNeeded+=p.getGpuSize())}}}else h=!1;return h},hr.prototype.getGpuSize=function(e){var t=e.mesh;if(!t)return 0;var r=t.submeshes,i=0;if(t.isReady(!0)){i+=t.gpuSize;for(var a=0,s=r.length;a<s;a++){r[a].internalUVs&&e.texturePath&&e.textures[a]&&(i+=e.textures[a].getGpuSize())}}return i},hr.prototype.drawMesh=function(e,t,r,i){for(var a=e.mesh,s=a.submeshes,n=this.renderer.cameraPosition,o=0,h=s.length;o<h;o++){var l=s[o];e.direct?l.texture&&a.drawSubmesh(n,o,l.texture,4,null,null,null,r,i):e.textures[o]&&a.drawSubmesh(n,o,e.textures[o],4,null,null,null,r,i)}},hr.prototype.traverseBinNode=function(e,t,r,i,a,s,n,o,h,l,u){var d=this.renderer,c=this.renderer.cameraPosition;if(h||d.camera.pointsVisible2(t,c)){var p=9*n,f=o.tree,m=this.getBinNodeTexelSize(r,i,a*d.curSize[0]),g=f[p],v=268435455&g;if(g&1<<31){var y=o.pathTable;if(2!=y[v])return;var b=y[v+1]|y[v+2]<<8|y[v+3]<<16;n=0,v=268435455&(g=(f=(o=this.binFiles[b]).tree)[p=0])}var x=0!=v;if(1==this.loadMode){var S=s*m[1];if(!(f[p+1]||f[p+2]||f[p+3]||f[p+4]||f[p+5]||f[p+6]||f[p+7]||f[p+8])||m[0]<=this.map.draw.texelSizeFit&&(x||!this.map.config.mapTraverseToMeshNode)){if(!u&&this.isBinNodeReady(t,r,n,o,null,S,null,!0)){var M={lod:s,index:e,precision:a,volume:{points:t,center:r,radius:i},jobs:x?[{type:12,mesh:o.meshes[n],direct:!0}]:[]};this.drawNode(M)}}else{var w,T,A,C=[0,0,0,0,0,0,0,0],F=[],P=[],L=!1,E=0,N=this.map.config.mapSplitLods,B=(s+1)*m[1],I=[.5*(t[1][0]-t[0][0]),.5*(t[1][1]-t[0][1]),.5*(t[1][2]-t[0][2])],k=[.5*(t[2][0]-t[1][0]),.5*(t[2][1]-t[1][1]),.5*(t[2][2]-t[1][2])],R=[.5*(t[0][0]-t[4][0]),.5*(t[0][1]-t[4][1]),.5*(t[0][2]-t[4][2])];R[0]=-R[0],R[1]=-R[1],R[2]=-R[2];for(var _=0,z=8;_<z;_++){if(G=f[p+1+_]){var U=9*G;switch(_){case 0:w=-1,T=-1,A=-1;break;case 1:w=0,T=-1,A=-1;break;case 2:w=-1,T=0,A=-1;break;case 3:w=0,T=0,A=-1;break;case 4:w=-1,T=-1,A=0;break;case 5:w=0,T=-1,A=0;break;case 6:w=-1,T=0,A=0;break;case 7:w=0,T=0,A=0}var D=[r[0]+I[0]*w+k[0]*T+R[0]*A,r[1]+I[1]*w+k[1]*T+R[1]*A,r[2]+I[2]*w+k[2]*T+R[2]*A],O=[[D[0],D[1],D[2]],[D[0]+I[0],D[1]+I[1],D[2]+I[2]],[D[0]+I[0]+k[0],D[1]+I[1]+k[1],D[2]+I[2]+k[2]],[D[0]+k[0],D[1]+k[1],D[2]+k[2]],[D[0]+R[0],D[1]+R[1],D[2]+R[2]],[D[0]+I[0]+R[0],D[1]+I[1]+R[1],D[2]+I[2]+R[2]],[D[0]+I[0]+k[0]+R[0],D[1]+I[1]+k[1]+R[1],D[2]+I[2]+k[2]+R[2]],[D[0]+k[0]+R[0],D[1]+k[1]+R[1],D[2]+k[2]+R[2]]],V=[(O[0][0]+O[1][0]+O[2][0]+O[3][0]+O[4][0]+O[5][0]+O[6][0]+O[7][0])/8,(O[0][1]+O[1][1]+O[2][1]+O[3][1]+O[4][1]+O[5][1]+O[6][1]+O[7][1])/8,(O[0][2]+O[1][2]+O[2][2]+O[3][2]+O[4][2]+O[5][2]+O[6][2]+O[7][2])/8];if(F[_]=O,P[_]=V,N)this.getBinNodeTexelSize(V,.5*i,.5*a*d.curSize[0])[0]<=this.map.draw.texelSizeFit?f[U]|=1<<29:f[U]&=~(1<<29);if(!d.camera.pointsVisible2(O,c)){f[U]&=~(1<<30);continue}f[U]|=1<<30,!this.isBinNodeReady(O,V,G,o,null,B,!0,u)||N&&f[p]&1<<29?(L=!0,C[_]=1):E++}}for(_=0,z=8;_<z;_++){var G;if(G=f[p+1+_])if(f[U=9*G]&1<<30&&!(N&&f[U]&1<<29)){var j=u||1==C[_];this.traverseBinNode(_,F[_],P[_],.5*i,.5*a,s+1,G,o,!0,null,j)}}if(L&&!u&&this.isBinNodeReady(t,r,n,o,null,S,null,!0)){M={lod:s,precision:a,index:e,volume:{points:t,center:r,radius:i},jobs:x?[{type:12,mesh:o.meshes[n],direct:!0}]:[]};E>0?this.drawNode(M,null,C,t):this.drawNode(M)}}}}},hr.prototype.getPath=function(e,t){for(var r="";0!=e[t];)(r+=String.fromCharCode(e[t++])).length;return r},hr.prototype.isBinNodeReady=function(e,t,r,i,a,s,n,o){var h=!0,l=i.tree,u=9*r,d=l[u],c=268435455&d;if(d&1<<31){var p=i.pathTable;if(2!=p[c]){if(0==p[c]){p[c]=1,this.binFiles.push({});var f=this.getPath(p,c+4);f=or.getProcessUrl(f,this.rootPath),this.map.loader.processLoadBinary(f+".json",this.onBinFileLoaded.bind(this,{index:this.binFiles.length-1,nodeFile:i.index,nodeOffset:c,root:!1}),null,"text","direct-3dtiles",{root:!1})}return!1}var m=p[c+1]|p[c+2]<<8|p[c+3]<<16;r=0,c=268435455&(d=(l=(i=this.binFiles[m]).tree)[u=0])}if(0!=c){if(!i.meshes[r]){f=this.getPath(i.pathTable,c);f=or.getProcessUrl(f,this.rootPath);var g=new nr(this.renderer.core.map,null,null);i.meshes[r]=g.getMesh(f+".mesh",null)}var v={mesh:i.meshes[r],direct:!0};this.isMeshReady(v,a,s,n,o)||(h=!1)}return h},hr.prototype.getBinNodeTexelSize=function(e,t,r){var i=this.renderer.cameraPosition,a=tr.length([e[0]-i[0],e[1]-i[1],e[2]-i[2]]);return(a-=t)<=0?[Number.POSITIVE_INFINITY,.1]:[this.renderer.camera.scaleFactor2(a)*r*.5,a]},hr.prototype.onBinFileLoaded=function(e,t){var r=this.binFiles[e.index];if(r.loadState=2,r.tree=t.bintree,r.pathTable=t.pathTable,r.rootSize=t.rootSize,r.meshes=new Array(t.totalNodes),r.index=e.index,this.map.stats.octoNodes+=t.totalNodes,this.map.stats.octoNodesMemSize+=r.tree.byteLength+r.pathTable.byteLength+4*r.meshes.length+16+32+24,e.nodeOffset){var i=this.binFiles[e.nodeFile].pathTable;i[e.nodeOffset]=2,i[e.nodeOffset+1]=255&e.index,i[e.nodeOffset+2]=e.index>>8&255,i[e.nodeOffset+3]=e.index>>16&255}e.root&&(this.rootPoints=t.points,this.rootCenter=t.center,this.rootRadius=t.radius,this.rootTexelSize=t.texelSize),this.renderer.core.map.dirty=!0},hr.prototype.draw=function(e,t,r,i,a){if(null==this.id||!1!==this.renderer.layerGroupVisible[this.id]){var s=this.renderer,n=[[s.geoRenderCounter,e,t,this]],o=s.core.map;if(this.map=o,this.binPath){if(0==this.binFiles.length)return this.binFiles.push({loadState:1}),this.rootPath=or.makeAbsolute(this.binPath),this.rootPath=or.getBase(this.rootPath),void o.loader.processLoadBinary(this.binPath,this.onBinFileLoaded.bind(this,{index:0,root:!0}),null,"text","direct-3dtiles",{root:!0});if(1==this.binFiles[0].loadState)return;switch(s.drawnNodes=0,this.map.config.mapLoadMode){case"topdown":this.loadMode=1;break;case"fit":this.loadMode=2;break;case"fitonly":this.loadMode=3}var h=this.binFiles[0];this.traverseBinNode(0,this.rootPoints,this.rootCenter,this.rootRadius,this.rootTexelSize,0,0,h,null,null,null)}if(r){var l=rr.create(),u=rr.create(),d=this.renderer.position,c=this.origin;c=[c[0]-d[0],c[1]-d[1],c[2]],rr.multiply(e,ar.translationMatrix(c[0],c[1],c[2]),u),rr.multiply(t,u,l),e=u,t=l}for(var p=s.cameraPosition,f=s.jobZBuffer,m=s.jobZBufferSize,g=(s.jobZBuffer2,s.jobZBuffer2Size,s.onlyHitLayers),v=0,y=this.jobs.length;v<y;v++){var b=this.jobs[v];if((7==b.type||8==b.type)&&b.visibility>0){var x=b.center;if(tr.length([x[0]-p[0],x[1]-p[1],x[2]-p[2]])>b.visibility)continue}if(!g||b.hitable){b.mv=e,b.mvp=t,b.renderCounter=n,b.tiltAngle=i,b.texelSize=a;var S=b.zIndex;f[S][m[S]]=b,m[S]++}}}};var ur=hr,dr=function(e,t){this.layer=e,this.map=e.map,this.renderer=this.map.renderer,this.killed=!1,this.listener=t,this.busy=!1,this.ready=!0,this.waitingForStylesheet=!1,this.stylesheet=null,this.fonts={},this.processCounter=0;var i=r(13);this.processWorker=new i,this.processWorker.onerror=function(e){throw new Error(e.message+" ("+e.filename+":"+e.lineno+")")},this.processWorker.onmessage=this.onMessage.bind(this),this.processWorker.postMessage({command:"config",data:this.map.config})};dr.prototype.kill=function(){this.killed||(this.killed=!0,null!=this.processWorker&&this.processWorker.terminate())},dr.prototype.isReady=function(){return this.waitingForStylesheet&&(this.waitingForStylesheet=!this.stylesheet.isReady()),(this.ready&&!this.busy||this.killed)&&!this.waitingForStylesheet},dr.prototype.onMessage=function(e,t){if(!this.killed){t||(e=e.data);var r=e.command;if("ready"==r)this.ready=!0;else if("styleDone"==r)this.busy=!1;else if("loadBitmaps"==r){var i=e.bitmaps;for(var a in i){var s=i[a];this.renderer.getBitmap(s.url,s.filter||"linear",s.tiled||!1,s.hash,!0)}}if(null!=this.listener){if("packed-events"==r){for(var n=e.messages,o=0,h=n.length;o<h;o++)this.onMessage(n[o],!0);return}this.listener(r,e)}}},dr.prototype.setListener=function(e){this.listener=e},dr.prototype.sendCommand=function(e,t,r,i){if(!this.killed){this.ready=!1;var a={command:e,data:t};r&&r.id&&(a.lod=r.id[0],a.ix=r.id[1],a.iy=r.id[2],r.metanode&&(a.tileSize=Math.tan(r.metanode.diskAngle2A)*r.metanode.diskDistance,a.pixelSize=.70710678118*a.tileSize/r.metanode.displaySize)),i&&(a.dpr=i),this.processWorker.postMessage(a)}},dr.prototype.setStylesheet=function(e,t){if(this.stylesheet=e,e.isReady()){this.busy=!0;var r=96*(window.devicePixelRatio||1),i=this.map.config,a=i.mapFeaturesReduceParams,s=function(e){return void 0!==e},n=i.mapFeaturesReduceMode;switch(n){case"scr-count1":case"scr-count2":a?(a[0]=s(a[0])?a[0]:1,a[1]=s(a[1])?a[1]:50,a[2]=s(a[2])?a[2]:0):a=[1,50,0],i.mapFeaturesSortByTop="scr-count2"==n;break;case"scr-count4":a?(a[0]=s(a[0])?a[0]:.18,a[1]=s(a[1])?a[1]:0,a[2]=s(a[2])?a[2]:1):a=[.18,0,0],i.mapFeaturesSortByTop=!0;break;case"scr-count5":a?(a[0]=s(a[0])?a[0]:2,a[1]=s(a[1])?a[1]:1,a[2]=s(a[2])?a[2]:1):a=[2,1,0],i.mapFeaturesSortByTop=!0;break;case"scr-count6":case"scr-count7":a?(a[0]=s(a[0])?a[0]:.2,a[1]=s(a[1])?a[1]:0,a[2]=s(a[2])?a[2]:"scr-count6"==n?1:2,a[3]=s(a[3])?a[3]:1,a[4]=s(a[4])?a[4]:1,a[5]=r,i.mapFeaturesSortByTop=!0):a=[.2,0,"scr-count6"==n?1:2,1,1];break;case"scr-count8":a?(a[0]=s(a[0])?a[0]:.2,a[1]=s(a[1])?a[1]:.6,a[2]=s(a[2])?a[2]:11,a[3]=s(a[3])?a[3]:1,a[4]=s(a[4])?a[4]:1e3,a[5]=s(a[5])?a[5]:5,a[6]=r,i.mapFeaturesSortByTop=!0):a=[.2,.6,11,1,1e3,5]}i.mapFeaturesReduceParams=a,i.mapFeaturesReduceFactor=a[2],i.mapFeaturesReduceFactor2=a[3],i.mapFeaturesReduceFactor3=a[4],this.sendCommand("setStylesheet",{data:e.data,geocent:!this.map.getNavigationSrs().isProjected(),metric:i.mapMetricUnits,language:i.mapLanguage,reduceMode:n,reduceParams:i.mapFeaturesReduceParams,log:i.mapLogGeodataStyles});var o=e.fonts,h={};for(var l in o){var u=o[l],d=this.renderer.fonts[u];h[l]=u,d&&this.setFont(u,d)}this.processCounter++,this.sendCommand("setFontMap",{map:h})}else this.waitingForStylesheet=!0},dr.prototype.setFont=function(e,t){this.fonts[e]||(this.fonts[e]=t,this.sendCommand("setFont",{url:e,data:t.data},[t.data]))};var cr=dr,pr=a.b,fr=p.a,mr=s.a,gr=ur,vr=cr,yr=function(e,t,r){if(this.map=e,this.stats=e.stats,this.geodata=t,this.gpu=this.map.renderer.gpu,this.renderer=this.map.renderer,this.gpuGroups=[],this.currentGpuGroup=null,this.tile=r.tile,this.surface=r.surface,this.surface.geodataProcessor)this.surface.styleChanged&&(this.surface.geodataProcessor.setStylesheet(this.surface.stylesheet),this.surface.styleChanged=!1);else{var i=new vr(this,this.onGeodataProcessorMessage.bind(this));i.setStylesheet(this.surface.stylesheet),this.surface.geodataProcessor=i,this.map.geodataProcessors.push(i)}this.geodataProcessor=this.surface.geodataProcessor,this.processing=!1,this.statsCounter=0,this.size=0,this.killed=!1,this.killedByCache=!1,this.ready=!1,this.isReady()};yr.prototype.kill=function(){this.killed=!0,this.geodata=null,this.killGeodataView(!1)},yr.prototype.killGeodataView=function(e){this.killedByCache=e;for(var t=0,r=this.gpuGroups.length;t<r;t++)this.gpuGroups[t].kill();this.gpuGroups=[],!0!==e&&null!=this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.stats.gpuGeodata-=this.size,this.stats.graphsFluxGeodata[1][0]++,this.stats.graphsFluxGeodata[1][1]+=this.size,this.ready=!1,this.size=0,this.gpuCacheItem=null},yr.prototype.processPackedCommands=function(e,t){var r,i,a,s=e.byteLength,n=this.map.config.mapMaxGeodataProcessingTime,o=performance.now(),h=new DataView(e.buffer);do{var l=e[t];switch(t+=1,l){case 9:t+=1,r=h.getUint32(t),t+=4,i=mr.unint8ArrayToString(new Uint8Array(e.buffer,t,r)),t+=r,a=JSON.parse(i),this.currentGpuGroup=new gr(a.id,a.bbox,a.origin,this.gpu,this.renderer),this.gpuGroups.push(this.currentGpuGroup);break;case 10:this.size+=this.currentGpuGroup.size,t+=5;break;case 5:t=this.currentGpuGroup.addRenderJob2(e,t,this.tile);break;case 7:this.map.markDirty(),this.gpuCacheItem=this.map.gpuCache.insert(this.killGeodataView.bind(this,!0),this.size),this.stats.gpuGeodata+=this.size,this.stats.graphsFluxGeodata[0][0]++,this.stats.graphsFluxGeodata[0][1]+=this.size,this.ready=!0,this.processing=!1,t+=5}if(performance.now()-o>n&&t<s)return t}while(t<s);return this.stats.renderBuild+=performance.now()-o,-1},yr.prototype.onGeodataProcessorMessage=function(e,t,r){if(!this.killed&&!this.killedByCache)switch(e){case"addPackedCommands":if(r){var i=this.processPackedCommands(t.buffer,t.index);if(!(i<0))return t.index=i,-123;this.map.markDirty()}else t.index=0,this.map.markDirty(),this.map.addProcessingTask2(this.onGeodataProcessorMessage.bind(this,e,t,!0));break;case"ready":if(this.geodataProcessor.processCounter>0&&(this.geodataProcessor.processCounter--,this.geodataProcessor.processCounter>0)){this.map.markDirty();break}t.geodata&&(this.geodata.geodata=t.geodata),this.geodataProcessor.busy=!1,this.map.markDirty()}},yr.prototype.directParseNode=function(e,t){this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:21,data:{volume:e.volume,precision:e.precision,tileset:e.tileset}});var r,i,a=e.meshes||[];for(r=0,i=a.length;r<i;r++)this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:23,data:{path:a[r]}});var s=e.nodes||[];for(r=0,i=s.length;r<i;r++)this.directParseNode(s[r],t+1);var n=e.loadNodes||[];for(r=0,i=n.length;r<i;r++)this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:24,data:{path:n[r]}});this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:22,data:{}})},yr.prototype.directParse=function(e){if(e)for(var t=e.nodes||[],r=0,i=t.length;r<i;r++)this.currentGpuGroup=new gr(null,null,null,this.gpu,this.renderer),this.gpuGroups.push(this.currentGpuGroup),this.directParseNode(t[r],0),this.size+=this.currentGpuGroup.size},yr.prototype.directBinParse=function(e){this.currentGpuGroup=new gr(null,null,null,this.gpu,this.renderer),this.gpuGroups.push(this.currentGpuGroup),this.currentGpuGroup.binPath=e},yr.prototype.isReady=function(e,t,r){if(this.killed)return!1;var i=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||i,!this.ready&&!this.processing&&!e&&this.surface.stylesheet.isReady()&&this.geodata.isReady(e,t,r,this.surface.options.fastParse)&&this.geodataProcessor.isReady())if(this.surface.options.fastParse)"object"==typeof this.geodata.geodata?this.geodata.geodata.binPath?this.directBinParse(this.geodata.geodata.binPath):this.directParse(this.geodata.geodata):this.directParse(JSON.parse(this.geodata.geodata)),this.map.markDirty(),this.ready=!0;else{var a=this.geodata.geodata;this.processing=!0,this.killedByCache=!1,this.geodataProcessor.setListener(this.onGeodataProcessorMessage.bind(this)),this.map.config.mapGeodataBinaryLoad&&"string"!=typeof a?this.geodataProcessor.sendCommand("processGeodataRaw",a,this.tile,window.devicePixelRatio||1,[a]):this.geodataProcessor.sendCommand("processGeodata",a,this.tile,window.devicePixelRatio||1),this.geodataProcessor.busy=!0}return!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem),this.ready},yr.prototype.getWorldMatrix=function(e,t,r){var i=r;return null!=i?(i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e.min[0]-t[0],i[13]=e.min[1]-t[1],i[14]=e.min[2]-t[2],i[15]=1):(i=pr.create(),pr.multiply(fr.translationMatrix(e.min[0]-t[0],e.min[1]-t[1],e.min[2]-t[2]),fr.scaleMatrix(1,1,1),i)),i},yr.prototype.draw=function(e){if(this.ready){for(var t=this.renderer,r=this.tile?Math.abs(this.tile.tiltAngle):t.cameraTiltFator,i=(t.useSuperElevation,0),a=this.gpuGroups.length;i<a;i++){var s=this.gpuGroups[i];if(s.rootNode||s.binPath)s.draw(o,n,null,r,this.tile?this.tile.texelSize:1);else if(s.jobs.length||s.rootNode){var n=s.mvp,o=s.mv,h=n;pr.multiply(t.camera.getModelviewFMatrix(),this.getWorldMatrix(s.bbox,e,h),o);var l=t.camera.getProjectionFMatrix();pr.multiply(l,o,n),s.draw(o,n,null,r,this.tile?this.tile.texelSize:1),this.stats.drawnFaces+=s.polygons,this.stats.drawCalls+=s.jobs.length}}this.statsCoutner!=this.stats.counter&&(this.statsCoutner=this.stats.counter,this.stats.gpuRenderUsed+=this.size)}return this.ready};var br=yr,xr=br,Sr=s.a,Mr=function(e,t){this.map=e,this.config=e.config,this.isProjected=this.map.getNavigationSrs().isProjected(),this.stats=e.stats,this.draw=t,this.debug=t.debug,this.core=e.core,this.camera=e.camera,this.renderer=e.renderer,this.getTextSize=this.renderer.draw.getTextSize.bind(this.renderer.draw),this.drawText=this.renderer.draw.drawText.bind(this.renderer.draw)};Mr.prototype.drawSurfaceTile=function(e,t,r,i,a,s,n,o){if(this.stats.gpuRenderUsed>=this.draw.maxGpuUsed)return!1;if(e.renderReady=!1,e.surface){if(t.hasGeometry()){if(this.debug.drawBBoxes&&!s&&(!e.surface.geodata&&this.debug.drawGeodataOnly||this.drawTileInfo(e,t,r,e.surfaceMesh,i)),this.debug.heightmapOnly&&!s)return e.surface.geodata||e.drawGrid(r),!0;if(!s&&(this.stats.renderedLods[e.id[0]]++,this.stats.drawnTiles++,e.surface.geodata&&this.renderer.drawnGeodataTilesUsed)){var h=this.renderer.project2([.25*(t.bbox2[12]+t.bbox2[15]+t.bbox2[18]+t.bbox2[21])-r[0],.25*(t.bbox2[13]+t.bbox2[16]+t.bbox2[19]+t.bbox2[22])-r[1],.25*(t.bbox2[14]+t.bbox2[17]+t.bbox2[20]+t.bbox2[23])-r[2]],this.camera.getMvpMatrix());h[0]<0||h[1]<0||h[0]>this.renderer.curSize[0]||h[1]>this.renderer.curSize[1]||(this.stats.drawnGeodataTilesPerLayer++,this.stats.drawnGeodataTilesFactor+=Math.pow(Math.abs(e.tiltAngle*e.texelSize),.5)),this.stats.drawnGeodataTiles++}var l=0;do{if(e.resetDrawCommands){if(e.drawCommands=[[],[],[]],e.updateBounds=!0,e.bounds)for(var u in e.bounds)e.bounds[u].viewCoutner=0;e.resetDrawCommands=!1}var d;if(d=e.surface.geodata?this.drawGeodataTile(e,t,r,i,a,s,n,o):this.drawMeshTile(e,t,r,i,a,s,n,o),++l>10)break}while(e.resetDrawCommands);return d}return!0}if(!s&&e.lastRenderState){var c=this.draw.drawChannel;return this.draw.processDrawCommands(r,e.lastRenderState.drawCommands[c],a,!0,e),this.map.applyCredits(e),!0}},Mr.prototype.drawMeshTile=function(e,t,r,i,a,s,n,o){var h;if(!e.surfaceMesh){if(e.resourceSurface.virtual)return!0;h=e.resourceSurface.getMeshUrl(e.id),e.surfaceMesh=e.resources.getMesh(h,e)}var l,u,d,c=this.draw,p=c.drawChannel,f=!1;if(e.drawCommands[p].length>0&&this.draw.areDrawCommandsReady(e.drawCommands[p],a,n,o))return s||(c.processDrawCommands(r,e.drawCommands[p],a,null,e),this.map.applyCredits(e)),e.lastRenderState=null,!0;if(e.lastRenderState)if(e.surfaceMesh.isReady(!0,a,o)&&e.drawCommands[p].length>0){if(this.draw.areDrawCommandsReady(e.lastRenderState.drawCommands[p],a,n,o))return s||(c.processDrawCommands(r,e.lastRenderState.drawCommands[p],a,!0,e),this.map.applyCredits(e)),!0}else this.draw.areDrawCommandsReady(e.lastRenderState.drawCommands[p],a,n,o)&&(s||(c.processDrawCommands(r,e.lastRenderState.drawCommands[p],a,!0,e),this.map.applyCredits(e)),f=!0);if(e.drawCommands[p].length>0)return!(!this.config.mapHeightfiledWhenUnloaded||s)&&(e.drawGrid(r),!1);if(e.surfaceMesh.isReady(n,a,o)&&!n){var m=e.surfaceMesh.submeshes;e.drawCommands=[[],[],[]],e.imageryCredits={},e.boundsDebug={};var g,v,y,b,x,S,M,w=0;if((M=e.resourceSurface)||(M=e.surface),M.glue){var T=M.id;for(g=0,v=T.length;g<v;g++){var A=this.map.getSurface(T[g]);A&&(w=Math.max(w,A.specificity))}for(x=0,S=t.credits.length;x<S;x++)e.glueImageryCredits[t.credits[x]]=w}else for(w=M.specificity,x=0,S=t.credits.length;x<S;x++)e.imageryCredits[t.credits[x]]=w;for(g=0,v=m.length;g<v;g++){var C=m[g];if(this.debug.drawBBoxes&&this.debug.drawMeshBBox&&!s&&C.drawBBox(r),C.externalUVs){if(e.updateBounds&&(e.updateBounds=!1,this.updateTileBounds(e,m)),M=e.resourceSurface,e.resourceSurface.glue&&(M=e.resourceSurface.getSurfaceReference(C.surfaceReference)),null!=M){var F=e.bounds[M.id];if(F)if(C.externalUVs)if(F.sequence.length>0)if(F.transparent){C.internalUVs&&(null==e.surfaceTextures[g]&&(h=e.resourceSurface.getTextureUrl(e.id,g),e.surfaceTextures[g]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:e.surfaceTextures[g],material:5})),e.drawCommands[0].push({type:1,state:c.drawBlendedTileState});var P=F.sequence;for(y=0,b=P.length;y<b;y++)if(l=e.boundTextures[P[y]]){for(e.boundsDebug[M.id]||(e.boundsDebug[M.id]=[]),e.boundsDebug[M.id].push(P[y]),x=0,S=(d=(u=e.boundLayers[P[y]]).credits).length;x<S;x++)e.imageryCredits[d[x]]=u.specificity;e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:l,alpha:F.alpha[P[y]][1],material:7,layer:u,surface:M})}e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:null,material:3}),e.drawCommands[0].push({type:1,state:c.drawTileState})}else{var L=F.sequence[F.sequence.length-1];if(l=e.boundTextures[L]){for(e.boundsDebug[M.id]||(e.boundsDebug[M.id]=[]),e.boundsDebug[M.id].push(L),x=0,S=(d=(u=e.boundLayers[L]).credits).length;x<S;x++)e.imageryCredits[d[x]]=u.specificity;e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:l,material:6,layer:u,surface:M})}}else if(C.textureLayer){if((u=this.map.getBoundLayerByNumber(C.textureLayer))&&(l=e.boundTextures[u.id])){for(e.boundsDebug[M.id]||(e.boundsDebug[M.id]=[]),e.boundsDebug[M.id].push(u.id),x=0,S=(d=(u=e.boundLayers[u.id]).credits).length;x<S;x++)e.imageryCredits[d[x]]=u.specificity;e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:l,material:6,layer:u,surface:M})}}else C.internalUVs?(null==e.surfaceTextures[g]&&(h=e.resourceSurface.getTextureUrl(e.id,g),e.surfaceTextures[g]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:e.surfaceTextures[g],material:4})):e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:null,material:2});else C.internalUVs&&(null==e.surfaceTextures[g]&&(h=e.resourceSurface.getTextureUrl(e.id,g),e.surfaceTextures[g]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:e.surfaceTextures[g],material:4}))}}else C.internalUVs&&(null==e.surfaceTextures[g]&&(h=e.resourceSurface.getTextureUrl(e.id,g),e.surfaceTextures[g]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:g,texture:e.surfaceTextures[g],material:4}));e.drawCommands[1].push({type:2,mesh:e.surfaceMesh,submesh:g,material:1})}if(M.pipeline>0)for(this.updateTileHmap(e,t),y=0;y<2;y++){var E=e.drawCommands[y];for(g=0,v=E.length;g<v;g++)2==E[g].type&&(E[g].pipeline=M.pipeline,E[g].hmap=e.hmap)}if(e.resetDrawCommands)return!1;if(c.areDrawCommandsReady(e.drawCommands[p],a,n,o)){if(e.resetDrawCommands)return!1;s||(c.processDrawCommands(r,e.drawCommands[p],a,null,e),this.map.applyCredits(e)),e.lastRenderState=null,f=!0}else e.lastRenderState?this.draw.areDrawCommandsReady(e.lastRenderState.drawCommands[p],a,n,o)&&(s||(c.processDrawCommands(r,e.lastRenderState.drawCommands[p],a,!0,e),this.map.applyCredits(e)),f=!0):this.config.mapHeightfiledWhenUnloaded&&!s&&(e.drawGrid(r),f=!(e.drawCommands[p].length>0))}else e.lastRenderState||!this.config.mapHeightfiledWhenUnloaded||s||(e.drawGrid(r),f=!(e.drawCommands[p].length>0));return f},Mr.prototype.drawGeodataTile=function(e,t,r,i,a,s,n,o){if(e.id[0]<=1)return!0;if(null==e.surfaceGeodata){var h;if(e.surface.geodataNavtileInfo){var l=this.tree.findNavTile(e.id);if(l&&l.surface){var u=l.surface.getNavUrl(l.id)+";"+l.id[0]+"-"+l.id[1]+"-"+l.id[2]+";"+l.metanode.minHeight+";"+l.metanode.maxHeight;h=e.surface.getGeodataUrl(e.id,encodeURIComponent(u))}}h||(h=e.resourceSurface.getGeodataUrl(e.id,"")),e.surfaceGeodata=e.resources.getGeodata(h,{tile:e,surface:e.surface})}var d=this.draw.drawChannel;if(e.geodataCounter!=e.surface.geodataCounter&&(e.drawCommands=[[],[],[]],null!=e.surfaceGeodataView&&e.surfaceGeodataView.kill(),e.surfaceGeodataView=null,e.geodataCounter=e.surface.geodataCounter),e.drawCommands[d].length>0&&this.draw.areDrawCommandsReady(e.drawCommands[d],a,n,o))return s||(this.draw.processDrawCommands(r,e.drawCommands[d],a,null,e),this.map.applyCredits(e)),e.lastRenderState=null,!0;if(e.surfaceGeodataView||e.surfaceGeodata.isReady(n,a,o)&&!n&&(e.surfaceGeodataView=new xr(this.map,e.surfaceGeodata,{tile:e,surface:e.surface})),e.surfaceGeodataView){e.mapdataCredits={};for(var c=e.surface?e.surface.specificity:0,p=0,f=t.credits.length;p<f;p++)e.mapdataCredits[t.credits[p]]=c;return e.drawCommands[d][0]={type:3,geodataView:e.surfaceGeodataView},e.surfaceGeodataView.isReady()}return!1},Mr.prototype.updateTileHmap=function(e,t){if(t&&t.hasNavtile()&&e.surface){if(!e.surface||!e.resourceSurface)return!1;if(!e.resourceSurface.getHMapUrl)return!1;var r=e.resourceSurface.getHMapUrl(e.id,!0);e.hmap=e.resources.getTexture(r)}else{for(var i=e.parent,a=null;i&&i.id[0]>0;){if(i.metanode&&i.metanode.hasNavtile()){a={sourceTile:i,sourceTexture:null,hmap:!0,tile:e};break}i=i.parent}if(a){r=e.resourceSurface.getHMapUrl(e.id,!0);e.hmap=e.resources.getTexture(r,null,a,{tile:e,hmap:!0},e,!1),e.hmap.neverReady&&(e.hmap=null)}else e.hmap=null}},Mr.prototype.updateTileBounds=function(e,t){for(var r=0,i=t.length;r<i;r++){var a=t[r];if(a.externalUVs){var s=e.resourceSurface;if(e.resourceSurface.glue&&(s=e.resourceSurface.getSurfaceReference(a.surfaceReference)),s){var n=e.bounds[s.id];n||(n={sequence:[],alpha:[],transparent:!1,viewCoutner:0},e.bounds[s.id]=n),n.viewCoutner!=e.viewCoutner&&this.updateTileSurfaceBounds(e,a,s,n,n.viewCoutner!=e.viewCoutner)}}}for(var o in e.bounds)e.bounds[o].viewCoutner=e.viewCoutner},Mr.prototype.getParentTile=function(e,t){for(;e&&e.id[0]>t;)e=e.parent;return e},Mr.prototype.getTileTextureTransform=function(e,t){var r=t.id[0]-e.id[0],i=e.id[1]<<r,a=e.id[2]<<r,s=1/Math.pow(2,r);return[s,s,(t.id[1]-i)*s,(t.id[2]-a)*s]},Mr.prototype.updateTileSurfaceBounds=function(e,t,r,i,a){var s,n,o,h;if(!this.config.mapNoTextures)if(r.boundLayerSequence.length>0){if(a){i.sequence=[];for(var l=[],u=[],d=0,c=0,p=r.boundLayerSequence.length;c<p;c++)if((o=r.boundLayerSequence[c][0])&&o.ready&&o.hasTileOrInfluence(e.id)&&r.boundLayerSequence[c][1]>0){if(n=null,e.id[0]>o.lodRange[1]&&(n={sourceTile:this.getParentTile(e,o.lodRange[1]),sourceTexture:null,layer:o,tile:e}),(h=e.boundTextures[o.id])||(s=o.getUrl(e.id),1==(h=e.resources.getTexture(s,o.dataType,n,{tile:e,layer:o},e,!1)).checkType&&(h.checkMask=!0),h.isReady(!0),e.boundTextures[o.id]=h),h.neverReady)continue;var f=!1,m=!1;h.isMaskPosible()&&(h.isMaskInfoReady()?h.getMaskTexture()&&(i.transparent=!0,f=!0):(m=!0,f=!0)),u.push(f);var g=!(r.boundLayerSequence[c][1]<1||f||o.isTransparent);if(g&&d++,l.push(g),i.sequence.push(o.id),i.alpha[o.id]=r.boundLayerSequence[c],e.boundLayers[o.id]=o,(i.alpha[o.id][1]<1||o.isTransparent)&&(i.transparent=!0),m)break}if(d>0){for(var v=[],y=i.sequence.length-1;y>=0;y--){var b=i.sequence[y];if(l[y]){v.unshift(b);break}h=e.boundTextures[b],(i.alpha[b][1]<1||e.boundLayers[b].isTransparent||u[y])&&v.unshift(b)}i.sequence=v}}}else null!=r.textureLayer?a&&(o=this.map.getBoundLayerById(r.textureLayer))&&o.hasTileOrInfluence(e.id)&&(n=null,e.id[0]>o.lodRange[1]&&(n={sourceTile:this.getParentTile(e,o.lodRange[1]),sourceTexture:null,layer:o,tile:e}),i.sequence.push(o.id),e.boundLayers[o.id]=o,e.boundTextures[o.id]||(s=o.getUrl(e.id),e.boundTextures[o.id]=e.resources.getTexture(s,o.dataType,n,{tile:e,layer:o},e,!1))):0!=t.textureLayer&&(o=this.map.getBoundLayerByNumber(t.textureLayer))&&o.hasTileOrInfluence(e.id)&&(n=null,e.id[0]>o.lodRange[1]&&(n={sourceTile:this.getParentTile(e,o.lodRange[1]),sourceTexture:null,layer:o,tile:e}),e.boundLayers[o.id]=o,e.boundTextures[o.id]||(s=o.getUrl(e.id),e.boundTextures[o.id]=e.resources.getTexture(s,o.dataType,n,{tile:e,layer:o},e,!1)))},Mr.prototype.drawTileInfo=function(e,t,r,i){var a,s=this.debug;if(s.drawMeshBBox||t.drawBBox(r),t.metatile.useVersion<4){var n=t.bbox.min,o=t.bbox.max;(a=this.core.getRendererInterface().getCanvasCoords([n[0]+.5*(o[0]-n[0])-r[0],n[1]+.5*(o[1]-n[1])-r[1],o[2]-r[2]],this.camera.getMvpMatrix()))[2]=.9992*a[2]}else{var h=t.bbox2[3]-t.bbox2[0],l=t.bbox2[4]-t.bbox2[1],u=t.bbox2[5]-t.bbox2[2],d=Math.sqrt(h*h+l*l+u*u);a=this.core.getRendererInterface().getCanvasCoords([.25*(t.bbox2[12]+t.bbox2[15]+t.bbox2[18]+t.bbox2[21])+t.diskNormal[0]*d*.1-r[0],.25*(t.bbox2[13]+t.bbox2[16]+t.bbox2[19]+t.bbox2[22])+t.diskNormal[1]*d*.1-r[1],.25*(t.bbox2[14]+t.bbox2[17]+t.bbox2[20]+t.bbox2[23])+t.diskNormal[2]*d*.1-r[2]],this.camera.getMvpMatrix())}var c,p,f,m,g=s.debugTextSize;if(s.drawLods&&(c=""+e.id[0],this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]-4*g),4*g,c,[1,0,0,1],a[2])),s.drawIndices&&(c=e.id[1]+" "+e.id[2],this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]-11*g),4*g,c,[0,1,1,1],a[2])),s.drawPositions){var v=t.border2;v&&(c=Math.floor(v[0])+" "+Math.floor(v[1])+" "+Math.floor(v[2])+" "+Math.floor(v[3])+" "+Math.floor(v[4])+" "+Math.floor(v[5])+" "+Math.floor(v[6])+" "+Math.floor(v[7])+" "+Math.floor(v[8]),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+3*g),4*g,c,[0,1,1,1],a[2])),(v=t.border)&&(draw.getDrawCommandsGpuSize(e.drawCommands[draw.drawChannel]||e.lastRenderState.drawCommands[draw.drawChannel]),Math.floor(v[0]),Math.floor(v[1]),Math.floor(v[2]),Math.floor(v[3]),Math.floor(v[4]),Math.floor(v[5]),Math.floor(v[6]),Math.floor(v[7]),Math.floor(v[8]),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[0,1,1,1],a[2]))}if(s.drawResources&&i&&(c=(this.draw.getDrawCommandsGpuSize(e.drawCommands[0]||e.lastRenderState.drawCommands[0])/1048576).toFixed(2)+"MB",this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[0,1,0,1],a[2])),s.drawFaceCount&&i&&(c=i.faces+" - "+i.submeshes.length+(e.surface&&e.surface.glue?" - 1":" - 0"),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[0,1,0,1],a[2])),s.drawGPixelSize&&(c=""+(Math.tan(e.metanode.diskAngle2A)*e.metanode.diskDistance*.70710678118/t.displaySize).toFixed(2),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[0,1,0,1],a[2])),s.drawOrder&&(c=this.drawTileCounter+" cmds: "+e.drawCommands[0].length,this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[0,1,0,1],a[2])),(s.drawSurfaces||s.drawSurfaces2)&&(c=JSON.stringify(e.surface.id),m=s.drawSurfaces2?[(m=Sr.getHashColor2(e.surface.surfaceCounter))[0],m[1],m[2],1]:[1,1,1,1],t.alien&&(c="[A]"+c),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,m,a[2])),s.drawBoundLayers&&e.boundsDebug){var y=e.resourceSurface;if(y.glue)for(p=0,f=y.id.length;p<f;p++)e.boundsDebug[y.id[p]]&&(c="< "+y.id[p]+" >",this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+(10+7*p*2)*g),4*g,c,[1,1,1,1],a[2]),c=JSON.stringify(e.boundsDebug[y.id[p]]),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+(17+7*p*2)*g),4*g,c,[1,1,1,1],a[2]));else e.boundsDebug[y.id]&&(c="< "+y.id+" >",this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[1,1,1,1],a[2]),c=JSON.stringify(e.boundsDebug[y.id]),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+17*g),4*g,c,[1,1,1,1],a[2]))}if(s.drawCredits){for(var b in c="{ ",e.imageryCredits)e.imageryCredits[b]&&(c+=b+":"+e.imageryCredits[b]+", ");for(b in e.glueImageryCredits)e.imageryCredits[b]||(c+=b+":"+e.glueImageryCredits[b]+", ");c+="}",this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+10*g),4*g,c,[1,1,1,1],a[2])}if(s.drawDistance&&(c=e.distance.toFixed(2)+"  "+e.texelSize.toFixed(3)+"  "+t.pixelSize.toFixed(3),c+="--"+e.texelSize2.toFixed(3),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+17*g),4*g,c,[1,0,1,1],a[2])),s.drawNodeInfo){var x=(240&t.flags)>>4;c="v"+t.metatile.version+"-"+t.flags.toString(2)+"-"+(1&x?"1":"0")+(2&x?"1":"0")+(4&x?"1":"0")+(8&x?"1":"0"),c+="-"+t.minHeight+"/"+t.maxHeight+"-"+Math.floor(t.minZ)+"/"+Math.floor(t.maxZ)+"-"+Math.floor(t.surrogatez),this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]-18*g),4*g,c,[1,0,1,1],a[2])}if(s.drawTextureSize&&i){var S=i.submeshes;for(p=0,f=S.length;p<f;p++)if(S[p].internalUVs){var M=e.surfaceTextures[p];if(M){var w=M.getGpuTexture();w&&(c="["+p+"]: "+w.width+" x "+w.height,this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+(17+4*p*2)*g),4*g,c,[1,1,1,1],a[2]))}}else c="["+p+"]: 256 x 256",this.drawText(Math.round(a[0]-.5*this.getTextSize(4*g,c)),Math.round(a[1]+(17+4*p*2)*g),4*g,c,[1,1,1,1],a[2])}};var wr=Mr,Tr=a.d,Ar=p.a,Cr=wr,Fr=br,Pr=Ie,Lr=function(e){this.map=e,this.config=e.config,this.isProjected=e.getNavigationSrs().isProjected(),this.isGeocent=e.isGeocent,this.renderer=e.renderer,this.stats=e.stats,this.camera=e.camera,this.tree=e.tree,this.ndcToScreenPixel=.5*this.renderer.curSize[0],this.debug={heightmapOnly:!1,blendHeightmap:!0,drawBBoxes:!1,drawNBBoxes:!1,drawSpaceBBox:!1,drawMeshBBox:!1,drawLods:!1,drawPositions:!1,drawTexelSize:!1,drawWireframe:0,drawTestMode:0,drawTestData:0,drawFaceCount:!1,drawDistance:!1,drawMaxLod:!1,drawGeodataOnly:!1,drawTextureSize:!1,drawNodeInfo:!1,drawLayers:!0,drawBoundLayers:!1,drawSurfaces:!1,drawCredits:!1,drawOrder:!1,drawOctants:!1,drawLabelBoxes:!1,drawAllLabels:!1,drawHiddenLabels:!1,drawEarth:!0,drawGridCells:!1,drawTileCounter:0,drawPolyWires:!1,drawFog:this.config.mapFog,drawGPixelSize:!1,debugTextSize:2,ignoreTexelSize:!1,maxZoom:!1},this.gridFlat=!1,this.gridGlues=!1,this.gridSkipped=!1,this.atmoColor=[216/255,232/255,243/255,1],this.atmoColor2=[72/255,154/255,1,1],this.atmoHeight=5e4,this.atmoHeightFactor=1,this.atmoDensity=1,this.fogDensity=0,this.zFactor=0,this.zFactor2=.003,this.zbufferOffset=null,this.zShift=0,this.zLastShift=0,this.bestMeshTexelSize=1,this.bestGeodataTexelSize=1,this.log8=Math.log(8),this.log2=Math.log(2),this.geodataTilesPerLayer=0,this.drawCounter=0,this.drawChannel=0,this.drawChannelNames=["base","hit"],this.planetRadius=this.isGeocent?e.getNavigationSrs().getSrsInfo().a:100,this.tileBuffer=new Array(500),this.processBuffer=new Array(6e4),this.processBuffer2=new Array(6e4),this.drawBuffer=new Array(6e4),this.drawBuffer2=new Array(6e4),this.tmpVec3=new Array(3),this.tmpVec5=new Array(5),this.bboxBuffer=new Float32Array(24),this.planeBuffer=new Float32Array(27);var t=this.renderer.gpu;this.drawTileState=t.createState({}),this.drawStardomeState=t.createState({zwrite:!1,ztest:!1}),this.drawBlendedTileState=t.createState({zequal:!0,blend:!0}),this.drawAuraState=t.createState({zwrite:!1,blend:!0}),this.drawAtmoState=t.createState({zwrite:!1,ztest:!1,blend:!0}),this.drawAtmoState2=t.createState({zwrite:!1,ztest:!0,blend:!1}),this.degradeHorizonFactor=0,this.degradeHorizonTiltFactor=0,this.replay={camera:null,drawnTiles:null,drawnFreeTiles:null,nodeBuffer:null,tracedNodes:null,tracedFreeNodes:null,storeTiles:!1,storeFreeTiles:!1,storeNodes:!1,storeFreeNodes:!1,storeLoaded:this.config.mapStoreLoadStats,drawGlobe:!1,drawTiles:!1,drawNodes:!1,drawFreeTiles:!1,drawFreeNodes:!1,drawLoaded:!1,lod:30,singleLod:!1,loadedIndex:0,singleLodedIndex:0,loaded:[],loadFirst:0,loadLast:0},this.drawTiles=new Cr(e,this)};Lr.prototype.drawMap=function(e){var t=this.map,r=this.renderer,i=this.camera,a=this.replay,s=r.gpu,n=this.debug;1!=this.drawChannel&&(s.setViewport(),t.visibleCredits={imagery:{},glueImagery:{},mapdata:{}});var o=this.isProjected;switch(this.config.mapGridMode){case"none":this.gridSkipped=!0,this.gridFlat=!1,this.gridGlues=!1;break;case"flat":this.gridSkipped=!1,this.gridFlat=!0,this.gridGlues=!1;break;case"linear":this.gridSkipped=!1,this.gridFlat=!1,this.gridGlues=!0;break;case"fastlinear":this.gridSkipped=!1,this.gridFlat=!1,this.gridGlues=!1}var h=this.drawTiles,l=i.update();if((r=this.renderer).debugStr="AsyncImageDecode: "+this.config.mapAsyncImageDecode,r.dirty=!0,r.drawFog=this.debug.drawFog,r.debug=this.debug,r.mapHack=t,r.benevolentMargins=this.config.mapBenevolentMargins,this.config.mapForceFrameTime?-1!=this.config.mapForceFrameTime?r.frameTime=this.config.mapForceFrameTime:r.frameTime=0:r.frameTime=this.stats.frameTime,r.hoverFeatureCounter=0,r.hoverFeatureList=t.hoverFeatureList,r.hoverFeature=t.hoverFeature,r.cameraPosition=i.position,r.cameraOrientation=t.position.getOrientation(),r.cameraTiltFator=Math.cos(Ar.radians(r.cameraOrientation[1])),r.cameraVector=i.vector,r.cameraViewExtent=t.position.getViewExtent(),r.cameraViewExtent2=Math.pow(2,Math.max(1,Math.floor(Math.log(t.position.getViewExtent())/Math.log(2)))),r.drawLabelBoxes=this.debug.drawLabelBoxes,r.drawGridCells=this.debug.drawGridCells,r.drawAllLabels=this.debug.drawAllLabels,r.drawHiddenLabels=this.debug.drawHiddenLabels,r.debug=this.debug,r.fmaxDist=Number.NEGATIVE_INFINITY,r.fminDist=Number.POSITIVE_INFINITY,o){var u=Ar.radians(r.cameraOrientation[0]);r.labelVector=[-Math.sin(u),Math.cos(u),0,0,0]}else{var d=l.vector;r.labelVector=[d[0],d[1],d[2],0]}r.distanceFactor=1/Math.max(1,Math.log(i.distance)/Math.log(1.04)),r.tiltFactor=Math.abs(r.cameraOrientation[1]/-90),r.localViewExtentFactor=2*Math.tan(Ar.radians(.5*t.position.getFov())),this.degradeHorizonFactor=200*this.config.mapDegradeHorizonParams[0],this.degradeHorizonTiltFactor=.5*(1+Math.cos(Ar.radians(Math.min(180,Math.abs(2*r.cameraOrientation[1]*3))))),1!=this.drawChannel?2==n.drawWireframe?s.clear(!0,!0,[255,255,255,255]):s.clear(!0,!0,[0,0,0,255]):s.clear(!0,!0,[255,255,255,255]),s.setState(this.drawStardomeState),s.setState(this.drawTileState),this.setupDetailDegradation(),t.loader.setChannel(0),this.zFactor=0,this.ndcToScreenPixel=.5*r.curSize[0],this.updateFogDensity(),this.updateGridFactors(),this.maxGpuUsed=Math.max(3929856,t.gpuCache.getMaxCost()-3929856),this.stats.renderBuild=0,this.drawTileCounter=0;var c,p,f,m,g,v,y,b,x,S,M=i.position;if(t.freeLayersHaveGeodata&&0==this.drawChannel&&r.draw.clearJobBuffer(),this.debug.drawEarth){if((a.storeNodes||a.storeFreeNodes)&&(a.nodeBuffer=[]),a.drawGlobe||a.drawTiles||a.drawFreeTiles||a.drawNodes||a.drawFreeNodes||a.drawLoaded){var w=a.lod,T=a.singleLod;if(a.drawTiles&&a.drawnTiles)for(c=0,p=(v=a.drawnTiles).length;c<p;c++)v[c][1]?(g=v[c][0],h.debug.drawBBoxes&&h.drawTileInfo(g,g.metanode,M),g.drawGrid(M)):(g=v[c][0])&&(T&&g.id[0]==w||!T&&g.id[0]<=w)&&h.drawSurfaceTile(g,g.metanode,M,g.pixelSize,g.priority,!1,!1);if(a.drawFreeTiles&&a.drawnFreeTiles)for(c=0,p=(v=a.drawnFreeTiles).length;c<p;c++)v[c][1]||(g=v[c][0])&&(T&&g.id[0]==w||!T&&g.id[0]<=w)&&h.drawSurfaceTile(g,g.metanode,M,g.pixelSize,g.priority,!1,!1);if(a.drawNodes&&a.tracedNodes){for(v=a.tracedNodes,y=n.drawBBoxes,n.drawBBoxes=!0,c=0,p=v.length;c<p;c++)(g=v[c])&&(T&&g.id[0]==w||!T&&g.id[0]<=w)&&h.drawTileInfo(g,g.metanode,M,g.surfaceMesh,g.pixelSize);n.drawBBoxes=y}if(a.drawFreeNodes&&a.tracedFreeNodes){for(v=a.tracedFreeNodes,y=n.drawBBoxes,n.drawBBoxes=!0,c=0,p=v.length;c<p;c++)g=v[c],(T&&g.id[0]==w||!T&&g.id[0]<=w)&&h.drawTileInfo(g,g.metanode,M,g.surfaceMesh,g.pixelSize);n.drawBBoxes=y}var A=a.loadedIndex,C=a.singleLodedIndex;if(a.drawLoaded&&a.loaded){var F=a.loaded;for(n.drawBBoxes=!0,c=0,p=F.length;c<p;c++){var P=F[c];P&&P.tile&&P.tile.id&&(g=P.tile,(C&&c==A||!C&&c<=A)&&(T&&g.id[0]==w||!T&&g.id[0]<=w)&&g.metanode&&(g.metanode.hasGeometry()?h.drawSurfaceTile(g,g.metanode,M,g.pixelSize,g.priority,!1,!1):h.drawTileInfo(g,g.metanode,M,g.surfaceMesh,g.pixelSize)))}n.drawBBoxes=y}return void((a.drawFreeTiles&&a.drawnFreeTiles||a.drawLoaded&&a.loaded)&&this.freeLayersHaveGeodata&&0==this.drawChannel&&(r.drawnGeodataTiles=this.stats.drawnGeodataTilesPerLayer,r.drawnGeodataTilesFactor=this.stats.drawnGeodataTilesFactor,r.draw.drawGpuJobs()))}for(c=0,p=this.tileBuffer.length;c<p;c++)this.tileBuffer[c]=null;if(this.tree.surfaceSequence.length>0&&this.tree.draw(),a.storeTiles){for(x=[],c=0,p=this.tileBuffer.length;c<p;c++)if(v=this.tileBuffer[c])for(f=0,m=v.length;f<m;f++)x.push(v[f]);a.cameraPos=M,a.drawnTiles=x,a.storeTiles=!1}if(a.storeNodes){for(S=[],c=0,p=a.nodeBuffer.length;c<p;c++)g=a.nodeBuffer[c],S.push(g);a.cameraPos=M,a.tracedNodes=S,a.storeNodes=!1}for(c=0,p=t.freeLayerSequence.length;c<p;c++)(b=t.freeLayerSequence[c]).ready&&b.tree&&(!b.geodata||b.stylesheet&&b.stylesheet.isReady())&&0==this.drawChannel&&(b.zFactor&&(this.zbufferOffset=b.zFactor),"geodata"==b.type?this.drawMonoliticGeodata(b):b.tree.draw(),this.zbufferOffset=null);if(a.storeFreeTiles){for(x=[],c=0,p=this.tileBuffer.length;c<p;c++)if(v=this.tileBuffer[c])for(f=0,m=v.length;f<m;f++)(g=v[f]).surface&&g.surface.free&&x.push(g);a.cameraPos=M,a.drawnFreeTiles=x,a.storeFreeTiles=!1}if(a.storeFreeNodes){for(S=[],c=0,p=a.nodeBuffer.length;c<p;c++)(g=a.nodeBuffer[c]).surface&&g.surface.free&&S.push(g);a.cameraPos=M,a.tracedFreeNodes=S,a.storeFreeNodes=!1}}var L=t.referenceFrame.body;if(1!=this.drawChannel&&!o&&n.drawFog&&(L&&L.atmosphere||"melown2015"==t.referenceFrame.id||"mars-qsc"==t.referenceFrame.id||"earth-qsc"==t.referenceFrame.id)&&r.progAtmo.isReady()&&r.progAtmo2.isReady()){var E=t.getNavigationSrs().getSrsInfo(),N=E.a,B=E.b,I=this.atmoHeight;r.earthRadius=N,r.earthRadius2=B,r.earthERatio=N/B;Tr.normalize(i.position,[0,0,0,0]);var k,R,_=t.getPosition(),z=1-Ar.clamp(Math.max(.1*I,i.geocentDistance-N)/(10*I),0,1),U=Math.max(2,128*z);U=[2,(N+I)/N*2,.25,(N+I)/N*2];var D=1/N*2;k=[i.position[0]*D,i.position[1]*D,i.position[2]*D,1];var O=N/(.5*_.getViewExtent()/Math.tan(Ar.radians(.5*_.getFov()))+N);R=[Ar.mix(4.4,1.01,O),1,Ar.mix(5,1.05,O),0],s.setState(this.drawAuraState),r.draw.drawBall([-i.position[0],-i.position[1],-i.position[2]],N+I,B+I,r.progAtmo,U,k,R,this.atmoColor,this.atmoColor2),s.setState(this.drawTileState)}n.drawEarth&&(e||t.freeLayersHaveGeodata&&0==this.drawChannel&&(r.drawnGeodataTiles=this.stats.drawnGeodataTilesPerLayer,r.drawnGeodataTilesFactor=this.stats.drawnGeodataTilesFactor,r.draw.drawGpuJobs())),this.config.mapForceFrameTime&&-1!=this.config.mapForceFrameTime&&(r.frameTime=0,this.config.mapForceFrameTime=-1)},Lr.prototype.drawToTexture=function(e){this.renderer.switchToFramebuffer("texture",e),this.drawChannel=0,this.map.renderSlots.processRenderSlots(),this.renderer.switchToFramebuffer("base")},Lr.prototype.drawHitmap=function(){this.drawChannel=1,this.renderer.switchToFramebuffer("depth"),this.map.renderSlots.processRenderSlots(),this.renderer.switchToFramebuffer("base"),this.renderer.hitmapMode>2&&this.renderer.copyHitmap(),this.drawChannel=0,this.map.hitMapDirty=!1},Lr.prototype.drawGeodataHitmap=function(){this.renderer.gpu.setState(this.drawTileState),this.renderer.switchToFramebuffer("geo"),this.renderer.draw.drawGpuJobs(),this.renderer.advancedPassNeeded&&(this.renderer.switchToFramebuffer("geo2"),this.renderer.draw.drawGpuJobs()),this.renderer.switchToFramebuffer("base"),this.map.geoHitMapDirty=!1},Lr.prototype.getDrawCommandsGpuSize=function(e){for(var t=0,r=0,i=e.length;r<i;r++){var a=e[r];switch(a.type){case 2:var s=a.mesh,n=this.config.mapNoTextures?0:a.texture;s&&(t+=s.gpuSize),n&&(t+=n.getGpuSize());break;case 3:var o=a.geodataView;o&&(t+=o.size)}}return t},Lr.prototype.areDrawCommandsReady=function(e,t,r,i){for(var a=!0,s=!!i,n=0,o=e.length;n<o;n++){var h=e[n];switch(h.type){case 2:if(h.pipeline){var l=h.hmap;if(l&&l.isReady(r,t)||(a=!1),9==this.debug.drawTestMode){var u=h.texture;(p=!!this.config.mapNoTextures||(!u||u&&u.isReady(r,t,s)))||(a=!1)}break}var d=h.mesh,c=(u=h.texture,d&&d.isReady(r,t,s)),p=!!this.config.mapNoTextures||(!u||u&&u.isReady(r,t,s));c&&p||(a=!1);break;case 3:var f=h.geodataView;f&&f.isReady(r,t,s)||(a=!1)}}return a},Lr.prototype.processDrawCommands=function(e,t,r,i,a){t.length>0&&this.drawTileCounter++;for(var s=0,n=t.length;s<n;s++){var o=t[s];switch(o.type){case 1:this.renderer.gpu.setState(o.state);break;case 2:var h=o.pipeline;if(h){var l=o.hmap;if(9==this.debug.drawTestMode){var u=o.texture;(d=!!this.config.mapNoTextures||(!u||u&&u.isReady(i,r)))&&l&&l.isReady(i,r)&&a.drawHmapTile(e,null,null,h,u)}else l&&l.isReady(i,r)&&a.drawHmapTile(e,null,null,h);return}var d,c=o.mesh,p=(u=o.texture,c&&c.isReady(i,r));if(this.config.mapNoTextures?(d=!0,u=null):d=!u||u&&u.isReady(i,r),p&&d)if(this.debug.drawBBoxes&&this.debug.drawMeshBBox&&c.submeshes[o.submesh].drawBBox(e),u)c.drawSubmesh(e,o.submesh,u,o.material,o.alpha,o.layer,o.surface,a.splitMask);else{var f=o.material;switch(f){case 6:case 4:f=2}c.drawSubmesh(e,o.submesh,u,f,o.alpha,o.layer,o.surface,a.splitMask)}break;case 3:var m=o.geodataView;m&&m.isReady(i,r,!0)&&m.draw(e)}}},Lr.prototype.drawMonoliticGeodata=function(e){var t;if(e&&0==this.drawChannel&&(this.camera.camera.bboxVisible(e.extents,this.camera.position)&&(null==e.monoGeodata&&(t="object"==typeof e.geodataUrl?e.geodataUrl:e.getMonoGeodataUrl(e.id),e.monoGeodata=new Pr(this.map,t,{tile:null,surface:e})),e.monoGeodataCounter!=e.geodataCounter&&(e.monoGeodataView=null,e.monoGeodataCounter=e.geodataCounter),e.monoGeodata.isReady(null,null,null,e.options.fastParse)&&(e.monoGeodataView||(e.monoGeodataView=new Fr(this.map,e.monoGeodata,{tile:null,surface:e})),e.monoGeodataView.isReady())))){for(var r=this.map.visibleCredits.mapdata,i=0,a=e.credits.length;i<a;i++){var s=e.credits[i],n=r[s];r[s]=n?10>n?10:n:10}e.monoGeodataView.draw(this.camera.position)}},Lr.prototype.updateFogDensity=function(){var e=this.map.getPosition().getOrientation(),t=this.camera.getFar(),r=Math.max(5,-e[1])/90,i=Math.log(.05)/(this.atmoDensity*t*this.atmoHeightFactor*Math.max(1,1e-4*this.camera.height)*r);i*=5/(Math.min(5e4,Math.max(this.camera.distance,1e3))/5e3),this.debug.drawFog||(i=0),this.fogDensity=i,this.renderer.fogDensity=i},Lr.prototype.updateGridFactors=function(){for(var e=this.map.referenceFrame.getSpatialDivisionNodes(),t=0,r=e.length;t<r;t++){var i=e[t],a=Math.max(10,this.camera.distance+20),s=2*(i.extents.ur[0]-i.extents.ll[0]),n=Math.log(Math.min(s,a))/this.log8;n=Math.log(s)/this.log8-n,i.gridBlend=n-Math.floor(n),n=Math.floor(Math.floor(n))+1,i.gridStep1=Math.pow(8,n),i.gridStep2=8*i.gridStep1}},Lr.prototype.setupDetailDegradation=function(e){var t=0;this.map.mobile&&(t=this.config.mapMobileDetailDegradation),e&&(t+=e);this.texelSizeFit=this.config.mapTexelSizeFit*Math.pow(2,t)*1};var Er=Lr,Nr=s.a,Br=function(e,t){if(this.map=e,this.core=e.core,this.killed=!1,this.config=e.config,this.maxThreads=t||1,this.usedThreads=0,this.maxPending=2*this.maxThreads,this.fadeout=.95,this.pending=[[],[]],this.channel=0,this.downloading=[],this.downloadingTime=[],this.workerTask={},this.lastDownloadTime=0,this.downloaded=0,this.processWorker=null,this.updateThreadCount(),this.config.mapSeparateLoader){var i=r(14);this.processWorker=new i,this.processWorker.onerror=function(e){throw new Error(e.message+" ("+e.filename+":"+e.lineno+")")},this.processWorker.onmessage=this.onWorkerMessage.bind(this),this.processWorker.postMessage({command:"config",data:this.config})}};Br.prototype.updateThreadCount=function(){this.maxThreads=this.config.mapDownloadThreads,this.maxPending=Math.max(20,2*this.maxThreads),this.fadeout=(this.maxPending-1)/this.maxPending},Br.prototype.setChannel=function(e){this.channel=e},Br.prototype.onWorkerMessage=function(e,t){if(!this.killed){t||(e=e.data);var r=e.command;if("packed-events"!=r){var i=e.path,a=this.workerTask[i];if(a){switch(r){case"on-loaded":if(a.onLoaded)switch(a.kind){case"direct-texture":a.onLoaded(e.data,!0,e.filesize);break;case"direct-mesh":a.onLoaded(e.data,!1,!0,e.filesize);break;case"texture":a.onLoaded(new Blob([e.data]));break;default:a.onLoaded(e.data)}break;case"on-error":a.onError&&a.onError()}delete this.workerTask[i]}}else for(var s=e.messages,n=0,o=s.length;n<o;n++)this.onWorkerMessage(s[n],!0)}},Br.prototype.processLoadBinary=function(e,t,r,i,a,s){var n=!!Nr.useCredentials&&-1!=this.mapLoaderUrl.indexOf(this.map.url.baseUrl);if(this.processWorker){switch(a){case"texture":this.config.mapAsyncImageDecode&&(i="blob",a="direct-texture");break;case"mesh":this.config.mapParseMeshInWorker&&(a="direct-mesh")}switch(a){case"texture":case"direct-texture":case"mesh":case"direct-mesh":case"metadata":case"geodata":case"direct-3dtiles":this.workerTask[e]={onLoaded:t,onError:r,kind:a},this.processWorker.postMessage({command:"load-binary",path:e,withCredentials:n,xhrParams:this.map.core.xhrParams,responseType:i,kind:a,options:s});break;default:Nr.loadBinary(e,t,r,n,this.map.core.xhrParams,i)}}else"texture"==a&&this.config.mapAsyncImageDecode&&(i="blob"),Nr.loadBinary(e,t,r,n,this.map.core.xhrParams,i)},Br.prototype.load=function(e,t,r,i,a){var s=this.downloading.indexOf(e);if(-1==s){var n=this.pending[this.channel];-1!=(s=this.map.searchArrayIndexById(n,e))?n[s].priority=r:n.unshift({id:e,call:t,priority:r||0,tile:i,kind:a});do{for(var o=!0,h=0,l=n.length-1;h<l;h++)if(n[h].priority>n[h+1].priority){var u=n[h];n[h]=n[h+1],n[h+1]=u,o=!1}}while(!o);n.length>this.maxPending&&n.pop()}},Br.prototype.remove=function(e){var t=this.map.searchArrayIndexById(this.pending[this.channel],e);-1!=t&&this.pending[this.channel].splice(t,1)},Br.prototype.onLoaded=function(e){var t=this.downloading.indexOf(e.id),r=performance.now(),i=this.map.stats;this.map.draw.replay.storeLoaded&&this.map.draw.replay.loaded.push({url:e.id,kind:e.kind,tile:e.tile,priority:e.priority,time:r,duration:r-this.downloadingTime[t],interval:r-this.lastDownloadTime,threads:this.downloading.length}),this.downloading.splice(t,1),this.downloadingTime.splice(t,1),this.lastDownloadTime=r,this.usedThreads--,this.map.markDirty(),this.update(!0),i.loadedCount++,i.loadLast=r},Br.prototype.onLoadError=function(e){var t=this.downloading.indexOf(e.id),r=performance.now(),i=this.map.stats;this.map.draw.replay.storeLoaded&&this.map.draw.replay.loaded.push({url:e.id,kind:e.kind,tile:e.tile,priority:e.priority,time:r,duration:r-this.downloadingTime[t],interval:r-this.lastDownloadTime,threads:this.downloading.length}),this.downloading.splice(t,1),this.downloadingTime.splice(t,1),this.lastDownloadTime=r,this.usedThreads--,this.map.markDirty(),this.update(!0),i.loadErrorCount++,i.loadLast=r},Br.prototype.updateChannel=function(e){var t=this.pending[e];this.updateThreadCount();for(var r=0,i=t.length;r<i;r++)t[r].priority*=this.fadeout;for(var a=performance.now();t.length>0&&this.usedThreads<this.maxThreads;){var s=t.shift();-1==this.downloading.indexOf(s.id)&&null!=s.call&&(this.downloading.push(s.id),this.downloadingTime.push(a),this.usedThreads++,this.downloaded++,s.call(s.id,this.onLoaded.bind(this,s),this.onLoadError.bind(this,s)))}},Br.prototype.update=function(e){if(!this.map.loaderSuspended&&!this.core.contextLost){!e&&this.processWorker&&this.config.mapPackLoaderEvents&&this.downloading.length&&this.processWorker.postMessage({command:"tick"});for(var t=this.pending.length-1;t>=0;t--)if(this.pending[t].length>0){this.updateChannel(t);break}}};var Ir=Br,kr=p.a,Rr=function(e){e instanceof Rr?this.pos=e.pos.slice():(this.pos=null!=e&&e instanceof Array?e.slice():[],this.validate())};Rr.prototype.clone=function(){return new Rr(this.pos)},Rr.prototype.getCoords=function(){return[this.pos[1],this.pos[2],this.pos[4]]},Rr.prototype.getCoords2=function(){return[this.pos[1],this.pos[2]]},Rr.prototype.setCoords=function(e){return this.pos[1]=e[0],this.pos[2]=e[1],this.pos[4]=e[2],this},Rr.prototype.setCoords2=function(e){return this.pos[1]=e[0],this.pos[2]=e[1],this},Rr.prototype.getHeight=function(){return this.pos[4]},Rr.prototype.setHeight=function(e){return this.pos[4]=e,this},Rr.prototype.getOrientation=function(){return[this.pos[5],this.pos[6],this.pos[7]]},Rr.prototype.setOrientation=function(e){return this.pos[5]=e[0],this.pos[6]=e[1],this.pos[7]=e[2],this},Rr.prototype.getFov=function(){return this.pos[9]},Rr.prototype.setFov=function(e){return this.pos[9]=e,this},Rr.prototype.getViewExtent=function(){return this.pos[8]},Rr.prototype.setViewExtent=function(e){return this.pos[8]=e,this},Rr.prototype.getViewDistance=function(){return.5*this.getViewExtent()/Math.tan(kr.radians(.5*this.getFov()))},Rr.prototype.getViewMode=function(){return this.pos[0]},Rr.prototype.getHeightMode=function(){return this.pos[3]},Rr.prototype.check=function(){this.getViewMode(),this.pos[6]=kr.clamp(this.pos[6],-90,90),this.pos[5]=this.pos[5]%360,this.pos[7]=this.pos[7]%360},Rr.prototype.isSame=function(e){return e=e.pos,this.pos[0]==e[0]&&kr.isEqual(this.pos[1],e[1],1e-7)&&kr.isEqual(this.pos[2],e[2],1e-7)&&this.pos[3]==e[3]&&kr.isEqual(this.pos[4],e[4],.001)&&kr.isEqual(this.pos[5],e[5],.001)&&kr.isEqual(this.pos[6],e[6],.001)&&kr.isEqual(this.pos[7],e[7],.001)&&kr.isEqual(this.pos[8],e[8],.001)&&kr.isEqual(this.pos[9],e[9],.001)},Rr.prototype.validate=function(){var e=this.pos;"fixed"==e[0]&&(e[0]="obj",e[9]=e[8],e[8]=e[7],e[7]=e[6],e[6]=e[5],e[5]=e[4],e[4]=e[3],e[3]="fix"),e[0]="obj"==e[0]||"subj"==e[0]?e[0]:"obj",e[1]=null!=e[1]?e[1]:0,e[2]=null!=e[2]?e[2]:0,e[3]="fix"==e[3]||"fixed"==e[3]||"float"==e[3]?e[3]:"float",e[4]=null!=e[4]?e[4]:0,e[5]=null!=e[5]?e[5]:0,e[6]=null!=e[6]?e[6]:-90,e[7]=null!=e[7]?e[7]:0,e[8]=null!=e[8]?e[8]:900,e[9]=null!=e[9]?e[9]:45,e[3]="fixed"==e[3]?"fix":e[3]},Rr.prototype.toString=function(){var e=this.pos;return e[0]+", "+e[1].toFixed(0)+", "+e[2].toFixed(0)+", "+e[3]+", "+e[4].toFixed(0)+", "+e[5].toFixed(0)+", "+e[6].toFixed(0)+", "+e[7].toFixed(0)+", , "+e[8].toFixed(0)+", "+e[9].toFixed(0)},Rr.prototype.toArray=function(){return this.pos.slice()};var _r=Rr,zr=function(e){this.map=e,this.draw=e.draw,this.renderer=e.renderer,this.config=e.config,this.renderSlots=[]};zr.prototype.createRenderSlot=function(e,t,r){return{id:e,callback:t,enabled:r}},zr.prototype.addRenderSlot=function(e,t,r){this.renderSlots.push(this.createRenderSlot(e,t,r))},zr.prototype.getRenderSlotIndex=function(e){return this.map.searchArrayIndexById(this.renderSlots,e)},zr.prototype.checkRenderSlotId=function(e){return"after-map-render"==e?"map":e},zr.prototype.moveRenderSlotBefore=function(e,t){var r=this.getRenderSlotIndex(this.checkRenderSlotId(e)),i=this.getRenderSlotIndex(t);-1!=r&&-1!=i&&i!=r-1&&this.renderSlots.splice(i,0,this.renderSlots.splice(r,1)[0])},zr.prototype.moveRenderSlotAfter=function(e,t){var r=this.getRenderSlotIndex(this.checkRenderSlotId(e)),i=this.getRenderSlotIndex(t);-1!=r&&-1!=i&&i!=r+1&&(i++,this.renderSlots.splice(i,0,this.renderSlots.splice(r,1)[0]))},zr.prototype.removeRenderSlot=function(e){var t=this.getRenderSlotIndex(e);-1!=t&&this.renderSlots.splice(t,1)},zr.prototype.setRenderSlotEnabled=function(e,t){var r=this.getRenderSlotIndex(e);-1!=r&&(this.renderSlots[r].enabled=t)},zr.prototype.getRenderSlotEnabled=function(e){var t=this.getRenderSlotIndex(e);return-1!=t&&this.renderSlots[t].enabled},zr.prototype.processRenderSlots=function(){1!=this.draw.drawChannel&&this.renderer.gpu.setViewport();for(var e=0,t=this.renderSlots.length;e<t;e++){var r=this.renderSlots[e];r.enabled&&r.callback&&(this.renderer.gpu.setState(this.draw.drawTileState),r.callback(this.draw.drawChannelNames[this.draw.drawChannel]))}};var Ur=zr,Dr=function(e){this.map=e,this.core=e.core,this.inspector=e.core.inspector,this.drawnTiles=0,this.drawnGeodataTiles=0,this.drawnGeodataTilesFactor=0,this.drawnGeodataTilesPerLayer=0,this.drawnFaces=0,this.drawCalls=0,this.usedNodes=0,this.processedNodes=0,this.processedMetatiles=0,this.counter=0,this.statsCycle=0,this.fps=0,this.frameTime=0,this.renderTime=0,this.renderTimeTmp=0,this.renderTimeBegin=0,this.renderBuild=0,this.lastRenderTime=0,this.lastFrameTime=0,this.renderedLods=new Array(32),this.debugIds={},this.recordGraphs=!1,this.graphsTimeIndex=0,this.graphsLastTimeIndex=0,this.graphsTimeSamples=900,this.graphsRenderTimes=new Array(this.graphsTimeSamples),this.graphsCreateMeshTimes=new Array(this.graphsTimeSamples),this.graphsCreateGpuMeshTimes=new Array(this.graphsTimeSamples),this.graphsCreateTextureTimes=new Array(this.graphsTimeSamples),this.graphsFrameTimes=new Array(this.graphsTimeSamples),this.graphsCpuMemoryMetatiles=new Array(this.graphsTimeSamples),this.graphsCpuMemoryUsed=new Array(this.graphsTimeSamples),this.graphsGpuMemoryTextures=new Array(this.graphsTimeSamples),this.graphsGpuMemoryMeshes=new Array(this.graphsTimeSamples),this.graphsGpuMemoryGeodata=new Array(this.graphsTimeSamples),this.graphsGpuMemoryRender=new Array(this.graphsTimeSamples),this.graphsPolygons=new Array(this.graphsTimeSamples),this.graphsLODs=new Array(this.graphsTimeSamples),this.graphsBuild=new Array(this.graphsTimeSamples),this.graphsFluxTextures=new Array(this.graphsTimeSamples),this.graphsFluxMeshes=new Array(this.graphsTimeSamples),this.graphsFluxGeodatas=new Array(this.graphsTimeSamples),this.graphsFluxTexture=[[0,0],[0,0]],this.graphsFluxMesh=[[0,0],[0,0]],this.graphsFluxGeodata=[[0,0],[0,0]],this.graphsCreateTextureTime=0,this.graphsCreateGpuMeshTime=0,this.graphsCreateMeshTime=0,this.resetGraphs(),this.meshesFaces=0,this.meshesUVArea=0,this.gpuMeshes=0,this.gpuTextures=0,this.gpuGeodata=0,this.gpuUsed=0,this.resourcesUsed=0,this.metaUsed=0,this.gpuRenderUsed=0,this.loadedCount=0,this.loadErrorCount=0,this.loadFirst=0,this.loadLast=0,this.gpuNeeded=0,this.gpuNeeded2=0,this.octoNodes=0,this.octoNodesMemSize=0,this.heightClass=0,this.heightLod=0,this.heightNode=0,this.heightTerrain=0,this.heightDelta=0,this.debugStr=null};Dr.prototype.resetGraphs=function(){this.graphsTimeIndex=0;for(var e=0;e<this.graphsTimeSamples;e++)this.graphsRenderTimes[e]=0,this.graphsCreateMeshTimes[e]=0,this.graphsCreateGpuMeshTimes[e]=0,this.graphsCreateTextureTimes[e]=0,this.graphsFrameTimes[e]=0,this.graphsCpuMemoryUsed[e]=0,this.graphsCpuMemoryMetatiles[e]=0,this.graphsGpuMemoryTextures[e]=0,this.graphsGpuMemoryMeshes[e]=0,this.graphsGpuMemoryGeodata[e]=0,this.graphsGpuMemoryRender[e]=0,this.graphsPolygons[e]=0,this.graphsLODs[e]=[0,[]],this.graphsBuild[e]=0,this.graphsFluxTextures[e]=[[0,0],[0,0]],this.graphsFluxMeshes[e]=[[0,0],[0,0]],this.graphsFluxGeodatas[e]=[[0,0],[0,0]]},Dr.prototype.begin=function(e){if(e){this.drawnTiles=0,this.drawnGeodataTiles=0,this.drawnGeodataTilesFactor=0,this.drawnGeodataTilesPerLayer=0,this.drawCalls=0,this.drawnFaces=0,this.gpuRenderUsed=0,this.gpuNeeded=0,this.usedNodes=0,this.processedNodes=0,this.processedMetatiles=0,this.meshesFaces=0,this.meshesUVArea=0;for(var t=0,r=this.renderedLods.length;t<r;t++)this.renderedLods[t]=0}this.debugIds={},this.counter++,this.statsCycle++,this.renderTimeBegin=performance.now(),e&&(this.lastFrameTime&&(this.frameTime=this.renderTimeBegin-this.lastFrameTime),this.lastFrameTime=this.renderTimeBegin)},Dr.prototype.end=function(e){var t=performance.now()-this.renderTimeBegin;if(e?(this.renderTimeTmp+=t,this.lastRenderTime=t):this.renderTimeTmp+=this.lastRenderTime,this.recordGraphs){var r=this.graphsTimeIndex;this.graphsRenderTimes[r]=t,this.graphsCreateMeshTimes[r]=0,this.graphsCreateGpuMeshTimes[r]=0,this.graphsCreateTextureTimes[r]=0,this.graphsFrameTimes[r]=this.frameTime,this.graphsCpuMemoryUsed[r]=this.map.resourcesCache.totalCost,this.graphsCpuMemoryMetatiles[r]=this.map.metatileCache.totalCost,this.graphsGpuMemoryTextures[r]=this.gpuTextures,this.graphsGpuMemoryMeshes[r]=this.gpuMeshes,this.graphsGpuMemoryGeodata[r]=this.gpuGeodata,this.graphsGpuMemoryRender[r]=this.gpuRenderUsed,this.graphsPolygons[r]=this.drawnFaces,this.graphsFluxTextures[r]=[[this.graphsFluxTexture[0][0],this.graphsFluxTexture[0][1]],[this.graphsFluxTexture[1][0],this.graphsFluxTexture[1][1]]],this.graphsFluxMeshes[r]=[[this.graphsFluxMesh[0][0],this.graphsFluxMesh[0][1]],[this.graphsFluxMesh[1][0],this.graphsFluxMesh[1][1]]],this.graphsFluxGeodatas[r]=[[this.graphsFluxGeodata[0][0],this.graphsFluxGeodata[0][1]],[this.graphsFluxGeodata[1][0],this.graphsFluxGeodata[1][1]]],this.graphsLODs[r]=[this.drawnTiles,this.renderedLods.slice()],this.graphsBuild[r]=this.renderBuild,this.graphsTimeIndex=(this.graphsTimeIndex+1)%this.graphsTimeSamples,this.inspector&&this.inspector.graphs&&this.inspector.graphs.updateGraphs(this)}this.statsCycle%50==0&&(this.renderTime=this.renderTimeTmp/100,this.fps=1e3/this.renderTime,this.renderTimeTmp=0,this.inspector&&this.inspector.stats&&(this.gpuUsed=this.map.gpuCache.totalCost,this.resourcesUsed=this.map.resourcesCache.totalCost,this.metaUsed=this.map.metatileCache.totalCost,this.inspector.stats.updateStatsPanel(this))),this.graphsFluxTexture=[[0,0],[0,0]],this.graphsFluxMesh=[[0,0],[0,0]],this.graphsFluxGeodata=[[0,0],[0,0]],this.debugStr=this.map.renderer.debugStr};var Or=Dr,Vr=function(e){this.map=e};Vr.prototype.generateSurfaceSequence=function(){var e=this.map.currentView,t=this.map.tree;if(t){t.surfaceSequence=[],t.surfaceSequenceIndices=[],t.surfaceOnlySequence=[];var r,i,a,s,n,o,h,l,u={},d=0,c=[],p=[];for(l in e.surfaces)(r=this.map.getSurface(l))&&(p.push(r.id),d++,u[l]=r.index+1,c.push([[r.index+1],r,!0,!1]));if(d>=1&&(p.sort(),p=p.join(";"),(r=this.map.virtualSurfaces[p])&&(c=[[[r.index+1],r,!0,!1]],d=1)),d>1){var f=[];for(l in this.map.glues)if((i=this.map.glues[l])&&i.id){var m=i.id;if(m.length<=d){var g=!1;for(o=0,h=m.length;o<h;o++)if(!u[m[o]]){g=!0;break}if(!g){for(a=[],o=0,h=m.length;o<h;o++)a.unshift(u[m[o]]);f.push([a,i,!1,!1])}}}for(s=0,n=f.length;s<n;s++){var v=f[s];(i=v[1]).flagProper=!0,i.flagAlien=!0,i.flagProper&&c.push(v),i.flagAlien&&(a=v[0].slice(1),c.push([a,v[1],!1,!0]))}do{var y=!0;for(s=0,n=c.length-1;s<n;s++){var b=c[s][0],x=c[s+1][0],S=!1;for(o=0,h=Math.min(b.length,x.length);o<h;o++)if(b[o]<x[o]||o==h-1&&b[o]==x[o]&&x.length>b.length){S=!0;break}if(S){var M=c[s];c[s]=c[s+1],c[s+1]=M,y=!1}}}while(!y);var w=d-1;for(s=0,n=c.length;s<n;s++)t.surfaceSequence.push([c[s][1],c[s][3]]),c[s][1].viewSurfaceIndex=w,c[s][2]&&(w--,t.surfaceOnlySequence.push(c[s][1]))}else 1==d&&(t.surfaceSequence.push([c[0][1],c[0][3]]),c[0][1].viewSurfaceIndex=d-1,t.surfaceOnlySequence=[c[0][1]]);for(l in this.map.freeLayersHaveGeodata=!1,e.freeLayers){var T=this.map.getFreeLayer(l);T&&(T.surfaceSequence=[T],T.surfaceOnlySequence=[T],T.geodata&&(this.map.freeLayersHaveGeodata=!0))}this.map.renderer.draw.clearJobBuffer()}},Vr.prototype.generateBoundLayerSequence=function(){var e,t,r,i,a,s,n=this.map.currentView,o=this.map.boundLayers;for(var h in o)o[h].shaderFilters=null;for(h in n.surfaces){var l=n.surfaces[h],u=this.map.getSurface(h);if(null!=u)for(u.boundLayerSequence=[],i=0,a=l.length;i<a;i++)"string"==typeof(e=l[i])?(t=this.map.getBoundLayerById(e))&&u.boundLayerSequence.push([t,1]):(t=this.map.getBoundLayerById(e.id))&&(r=1,void 0!==e.alpha&&(r=parseFloat(e.alpha)),u.boundLayerSequence.push([t,r]),(s=e.options||e).shaderVarFlatShade&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].varFlatShade=s.shaderVarFlatShade),s.shaderFilter&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].filter=s.shaderFilter))}for(h in n.freeLayers){var d=n.freeLayers[h],c=this.map.getFreeLayer(h);if(null!=c&&c.ready){c.options=d.options||{},c.boundLayerSequence=[];var p=d.boundLayers;if(p&&Array.isArray(p))for(i=0,a=p.length;i<a;i++)"string"==typeof(e=p[i])?(t=this.map.getBoundLayerById(e))&&c.boundLayerSequence.push([t,1]):(t=this.map.getBoundLayerById(e.id))&&(r=1,void 0!==e.alpha&&(r=parseFloat(e.alpha)),c.boundLayerSequence.push([t,r]),e.shaderVarFlatShade&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].varFlatShade=e.shaderVarFlatShade),e.shaderFilter&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].filter=e.shaderFilter))}}};var Gr=Vr,jr=r(11),Hr=a.d,qr=s.a,Wr=n.a,Jr=h,Zr=T,Yr=je,Kr=Ke,Xr=Qe,Qr=rt,$r=Vt,ei=qt,ti=Xt,ri=Er,ii=Ir,ai=_r,si=Ur,ni=Or,oi=Gr,hi=jr.a,li=c,ui=function(e,t,r,i,a){this.config=i||{},this.setConfigParams(i),this.setLoaderParams(t,a),this.core=e,this.proj4=this.core.getProj4(),this.coreConfig=e.coreConfig,this.killed=!1,this.config=i||{},this.loaderSuspended=!1,this.url=new hi(this,r),this.position=new ai(["obj",0,0,"fix",0,0,0,0,0,0]),this.lastPosition=this.position.clone(),this.srses={},this.bodies={},this.referenceFrame={},this.credits={},this.creditsByNumber={},this.surfaces={},this.virtualSurfaces={},this.glues={},this.freeLayers={},this.boundLayers={},this.stylesheets={},this.processingTasks=[],this.processingTasks2=[],this.geodataProcessors=[],this.surfaceSequence=new oi(this),this.initialView=null,this.currentView=new Jr(this,{}),this.currentViewString="",this.namedViews={},this.viewCounter=0,this.srsReady=!1,this.surfaceCounter=0,this.freeLayerSequence=[],this.freeLayersHaveGeodata=!1,this.visibleCredits={imagery:{},glueImagery:{},mapdata:{}},this.mobile=!1,this.metanodeBuffer=new Uint8Array(1024),this.gpuCache=new Xr(this,1024*this.config.mapGPUCache*1024),this.resourcesCache=new Xr(this,1024*this.config.mapCache*1024),this.metatileCache=new Xr(this,1024*this.config.mapMetatileCache*1024),this.setupMobileMode(this.config.mapMobileMode),this.setupCache(),this.loader=new ii(this,this.config.mapDownloadThreads),this.renderer=this.core.renderer,this.camera=new Qr(this),this.stats=new ni(this),this.resourcesTree=new Yr(this),this.mapConfig=new $r(this,t),this.convert=new ei(this),this.measure=new ti(this),this.convert.measure=this.measure,this.isGeocent=!this.getNavigationSrs().isProjected(),this.tree=new Zr(this,!1),this.mapConfig.afterConfigParsed(),this.updateCoutner=0,this.dirty=!0,this.dirtyCountdown=0,this.hitMapDirty=!0,this.geoHitMapDirty=!0,this.clickEvent=null,this.hoverEvent=null,this.hoverFeature=null,this.hoverFeatureId=null,this.lastHoverFeature=null,this.lastHoverFeatureId=null,this.hoverFeatureCounter=0,this.hoverFeatureList=[],this.draw=new ri(this),this.draw.setupDetailDegradation();var s,n=this.referenceFrame.body;if(n&&n.atmosphere)s=n.atmosphere.colorHorizon,this.draw.atmoColor=[s[0]/255,s[1]/255,s[2]/255,s[3]/255],s=n.atmosphere.colorZenith,this.draw.atmoColor2=[s[0]/255,s[1]/255,s[2]/255,s[3]/255],this.draw.atmoHeight=n.atmosphere.thickness/1e5*5e4,this.draw.atmoDensity=n.atmosphere.visibility/1e5*(1e5/n.atmosphere.thickness);else switch(this.referenceFrame.id){case"melown2015":case"earth-qsc":this.draw.atmoColor=[216/255,232/255,243/255,1],this.draw.atmoColor2=[72/255,154/255,1,1],this.draw.atmoHeight=5e4;break;case"mars-qsc":this.draw.atmoColor=[1,187/255,157/255,1],this.draw.atmoColor2=[1,155/255,113/255,1],this.draw.atmoHeight=25e3,this.draw.atmoDensity=4}this.draw.atmoHeightFactor=this.draw.atmoHeight/5e4,this.renderSlots=new si(this),this.renderSlots.addRenderSlot("map",this.drawMap.bind(this),!0)};ui.prototype.kill=function(){for(var e in this.killed=!0,this.tree&&this.tree.kill(),this.freeLayers){var t=this.freeLayers[e];t&&t.tree&&t.tree.kill()}this.gpuCache.clear(),this.resourcesCache.clear(),this.metatileCache.clear(),null!=this.renderer&&(this.renderer.kill(),this.renderer=null)},ui.prototype.setupMobileMode=function(){this.mobile=this.config.mapMobileMode,!this.mobile&&this.config.mapMobileModeAutodect&&(this.mobile=Wr.isMobile()),this.setupCache()},ui.prototype.setupCache=function(){if(this.resourcesCache){var e=1/(this.mobile?Math.pow(2,Math.max(0,this.config.mapMobileDetailDegradation-1)):1);e=.5*(e+1/(this.mobile?Math.pow(2,this.config.mapMobileDetailDegradation):1)),this.resourcesCache.setMaxCost(1024*this.config.mapCache*1024*e),this.gpuCache.setMaxCost(1024*this.config.mapGPUCache*1024*e),this.metatileCache.setMaxCost(1024*this.config.mapMetatileCache*1024*(e<.8?.5:1))}},ui.prototype.getCoreInterface=function(){return this.core.interface},ui.prototype.getRendererInterface=function(){return this.core.interface.getRendererInterface()},ui.prototype.setOption=function(){},ui.prototype.getOption=function(){},ui.prototype.addSrs=function(e,t){this.srses[e]=t},ui.prototype.getSrs=function(e){return this.srses[e]},ui.prototype.getSrses=function(){return this.getMapKeys(this.srses)},ui.prototype.addBody=function(e,t){this.bodies[e]=t},ui.prototype.getBody=function(e){return this.bodies[e]},ui.prototype.getBodies=function(){return this.getMapKeys(this.bodies)},ui.prototype.setReferenceFrame=function(e){this.referenceFrame=e},ui.prototype.addCredit=function(e,t){this.credits[e]=t,this.creditsByNumber[t.id]=t,t.key=e},ui.prototype.getCreditByNumber=function(e){return this.creditsByNumber[e]},ui.prototype.getCreditById=function(e){return this.credits[e]},ui.prototype.getCredits=function(){return this.getMapKeys(this.credits)},ui.prototype.getVisibleCredits=function(){var e,t,r,i,a=this.visibleCredits.imagery,s=this.visibleCredits.glueImagery,n=[],o=[];for(var h in s)a[h]||(a[h]=s[h]);for(h in this.visibleCredits.glueImagery={},a)n.push(h),o.push(a[h]);do{for(i=!0,e=0,t=o.length-1;e<t;e++)o[e]<o[e+1]&&(r=o[e],o[e]=o[e+1],o[e+1]=r,r=n[e],n[e]=n[e+1],n[e+1]=r,i=!1)}while(!i);var l=this.visibleCredits.mapdata,u=[],d=[];for(h in l)u.push(h),d.push(l[h]);do{for(i=!0,e=0,t=d.length-1;e<t;e++)d[e]<d[e+1]&&(r=d[e],d[e]=d[e+1],d[e+1]=r,r=u[e],u[e]=u[e+1],u[e+1]=r,i=!1)}while(!i);return{"3D":[],imagery:n,mapdata:u}},ui.prototype.addSurface=function(e,t){this.surfaces.push(t),t.index=this.surfaces.length-1},ui.prototype.getSurface=function(e){return this.searchArrayById(this.surfaces,e)},ui.prototype.getSurfaces=function(){for(var e=[],t=0,r=this.surfaces.length;t<r;t++)e.push(this.surfaces[t].id);return e},ui.prototype.addGlue=function(e,t){this.glues[e]=t},ui.prototype.getGlue=function(e){return this.glues[e]},ui.prototype.addBoundLayer=function(e,t){this.boundLayers[e]=t},ui.prototype.setBoundLayerOptions=function(e,t){this.boundLayers[e]&&this.boundLayers[e].setOptions(t)},ui.prototype.getBoundLayerOptions=function(e){return this.boundLayers[e]?this.boundLayers[e].getOptions():null},ui.prototype.removeBoundLayer=function(e){this.boundLayers[e]&&(this.boundLayers[e].kill(),this.boundLayers[e]=null)},ui.prototype.getBoundLayerByNumber=function(e){var t=this.boundLayers;for(var r in t)if(t[r].numberId==e)return t[r];return null},ui.prototype.getBoundLayerById=function(e){return this.boundLayers[e]},ui.prototype.getBoundLayers=function(){return this.getMapKeys(this.boundLayers)},ui.prototype.addFreeLayer=function(e,t){this.freeLayers[e]=t,this.setView(this.getView()),this.markDirty()},ui.prototype.removeFreeLayer=function(e){this.freeLayers[e]&&(this.freeLayers[e].kill(),this.freeLayers[e]=null,this.setView(this.getView()),this.markDirty())},ui.prototype.setFreeLayerOptions=function(e,t){this.freeLayers[e]&&this.freeLayers[e].setOptions(t)},ui.prototype.getFreeLayerOptions=function(e){return this.freeLayers[e]?this.freeLayers[e].getOptions():null},ui.prototype.getFreeLayer=function(e){return this.freeLayers[e]},ui.prototype.getFreeLayers=function(){var e=[];for(var t in this.freeLayers)e.push(t);return e},ui.prototype.getMapsSrs=function(e){return null==e?null:-1!=e.indexOf("+proj")?new Kr(this,{srsDef:e}):this.srses[e]},ui.prototype.addNamedView=function(e,t){this.namedViews[e]=t},ui.prototype.getNamedView=function(e){return this.namedViews[e]},ui.prototype.getNamedViews=function(){return this.getMapKeys(this.namedViews)},ui.prototype.setView=function(e,t,r){if(null!=e){if(r&&this.convert){var i=this.getPosition();i=this.convert.convertPositionHeightMode(i,"fix",!0),this.setPosition(i)}if("string"==typeof e)if("{"==(e=e.trim()).charAt(0))try{e=JSON.parse(e)}catch(e){return}else{if(!(e=this.getNamedView(e)))return;e=e.getInfo()}var a={};e.surfaces&&(a.surfaces=e.surfaces),e.freeLayers&&(a.freeLayers=e.freeLayers),a=JSON.stringify(a);var s=this.renderer;if(e.options){var n=e.options.superelevation;n&&n[0]&&n[1]&&n[0].length>=2&&n[1].length>=2?(s.setSuperElevationState(!0),s.setSuperElevation(n[0][0],n[1][0],n[0][1],n[1][1])):s.setSuperElevationState(!1)}else s.setSuperElevationState(!1);(a!=this.currentViewString||t)&&(this.currentView.parse(e),this.currentViewString=a,this.viewCounter++,s.draw.clearJobHBuffer()),this.surfaceSequence.generateSurfaceSequence(),this.surfaceSequence.generateBoundLayerSequence(),this.refreshFreelayesInView(),this.markDirty()}},ui.prototype.addStylesheet=function(e,t){this.stylesheets[e]=t},ui.prototype.getStylesheet=function(e){return this.stylesheets[e]},ui.prototype.getStylesheets=function(){var e=[];for(var t in this.stylesheets)e.push(t);return e},ui.prototype.getStylesheetData=function(e){var t=this.getStylesheet(e);return t?{url:t.url,data:t.data}:{url:null,data:{}}},ui.prototype.setStylesheetData=function(e,t){var r=this.getStylesheet(e);if(this.renderer.draw.clearJobHBuffer(),r)for(var i in t&&r.setData(t),this.freeLayers){var a=this.getFreeLayer(i);a&&a.geodata&&a.stylesheet==r&&(a.geodataProcessor&&a.geodataProcessor.setStylesheet(a.stylesheet),a.geodataCounter++)}this.markDirty()},ui.prototype.getView=function(){return this.currentView.getInfo()},ui.prototype.refreshFreelayesInView=function(){var e=this.currentView.freeLayers;for(var t in this.freeLayerSequence=[],e){var r=this.getFreeLayer(t);r&&(r.zFactor=e[t].depthOffset,r.maxLod=e[t].maxLod,this.freeLayerSequence.push(r),e[t].style?r.setStyle(e[t].style):r.setStyle(r.originalStyle))}},ui.prototype.refreshView=function(){this.viewCounter++,this.surfaceSequence.generateSurfaceSequence(),this.surfaceSequence.generateBoundLayerSequence(),this.refreshFreelayesInView(),this.markDirty()},ui.prototype.searchArrayIndexById=function(e,t){for(var r=0,i=e.length;r<i;r++)if(e[r].id==t)return r;return-1},ui.prototype.searchArrayById=function(e,t){for(var r=0,i=e.length;r<i;r++)if(e[r].id==t)return e[r];return null},ui.prototype.searchMapByInnerId=function(e,t){for(var r in e)if(e[r].id==t)return e[r];return null},ui.prototype.getMapKeys=function(e){var t=[];for(var r in e)t.push(r);return t},ui.prototype.getMapIds=function(e){var t=[];for(var r in e)t.push(r.id);return t},ui.prototype.setPosition=function(e){this.position=new ai(e),this.markDirty()},ui.prototype.isReferenceFrameReady=function(){return this.referenceFrame.model.physicalSrs.isReady()&&this.referenceFrame.model.publicSrs.isReady()&&this.referenceFrame.model.navigationSrs.isReady()},ui.prototype.getPhysicalSrs=function(){return this.referenceFrame.model.physicalSrs},ui.prototype.getPublicSrs=function(){return this.referenceFrame.model.publicSrs},ui.prototype.getNavigationSrs=function(){return this.referenceFrame.model.navigationSrs},ui.prototype.getPosition=function(){return this.position.clone()},ui.prototype.setLoaderParams=function(e,t){var r=[];e&&e.browserOptions&&r.push(e.browserOptions),t&&r.push(t);for(var i=0,a=r.length;i<a;i++){var s=r[i];for(var n in s)switch(n){case"mapSeparateLoader":case"mapGeodataBinaryLoad":case"mapPackLoaderEvents":case"mapParseMeshInWorker":case"mapPackGeodataEvents":this.setConfigParam(n,s[n])}}},ui.prototype.setConfigParams=function(e){if("object"==typeof e&&null!==e)for(var t in e)this.setConfigParam(t,e[t])},ui.prototype.setConfigParam=function(e,t){switch(e){case"map":this.config.map=qr.validateString(t,null);break;case"mapCache":this.config.mapCache=qr.validateNumber(t,10,Number.MAXINTEGER,900),this.setupCache();break;case"mapGPUCache":this.config.mapGPUCache=qr.validateNumber(t,10,Number.MAXINTEGER,360),this.setupCache();break;case"mapMetatileCache":this.config.mapMetatileCache=qr.validateNumber(t,10,Number.MAXINTEGER,60),this.setupCache();break;case"mapTexelSizeFit":this.config.mapTexelSizeFit=qr.validateNumber(t,1e-4,Number.MAXINTEGER,1.1);break;case"mapDownloadThreads":this.config.mapDownloadThreads=qr.validateNumber(t,1,Number.MAXINTEGER,6);break;case"mapMaxProcessingTime":this.config.mapMaxProcessingTime=qr.validateNumber(t,1,Number.MAXINTEGER,50);break;case"mapMaxGeodataProcessingTime":this.config.mapMaxGeodataProcessingTime=qr.validateNumber(t,1,Number.MAXINTEGER,10);break;case"mapMobileMode":this.config.mapMobileMode=qr.validateBool(t,!1),this.setupMobileMode();break;case"mapMobileModeAutodect":this.config.mapMobileModeAutodect=qr.validateBool(t,!1);break;case"mapMobileDetailDegradation":this.config.mapMobileDetailDegradation=qr.validateNumber(t,1,Number.MAXINTEGER,2);break;case"mapNavSamplesPerViewExtent":this.config.mapNavSamplesPerViewExtent=qr.validateNumber(t,1e-11,Number.MAXINTEGER,4);break;case"mapFog":this.config.mapFog=qr.validateBool(t,!1),this.draw&&(this.draw.debug.drawFog=this.config.mapFog,this.dirty=!0);break;case"mapFlatshade":this.config.mapFlatshade=qr.validateBool(t,!1),this.draw&&(this.draw.debug.drawWireframe=this.config.mapFlatshade?3:0,this.dirty=!0);break;case"mapIgnoreNavtiles":this.config.mapIgnoreNavtiles=qr.validateBool(t,!1);break;case"mapAllowHires":this.config.mapAllowHires=qr.validateBool(t,!0);break;case"mapAllowLowres":this.config.mapAllowLowres=qr.validateBool(t,!0);break;case"mapAllowSmartSwitching":this.config.mapAllowSmartSwitching=qr.validateBool(t,!0);break;case"mapDisableCulling":this.config.mapDisableCulling=qr.validateBool(t,!1);break;case"mapPreciseCulling":this.config.mapPreciseCulling=qr.validateBool(t,!1);break;case"mapHeightLodBlend":this.config.mapHeightLodBlend=qr.validateBool(t,!0);break;case"mapHeightNodeBlend":this.config.mapHeightNodeBlend=qr.validateBool(t,!0);break;case"mapBasicTileSequence":this.config.mapBasicTileSequence=qr.validateBool(t,!0);break;case"mapSmartNodeParsing":this.config.mapSmartNodeParsing=qr.validateBool(t,!0);break;case"mapStoreLoadStats":this.config.mapStoreLoadStats=qr.validateBool(t,!0),this.draw&&this.draw.replay&&(this.draw.replay.storeLoaded=this.config.mapStoreLoadStats);break;case"mapXhrImageLoad":this.config.mapXhrImageLoad=qr.validateBool(t,!1);break;case"mapLoadMode":this.config.mapLoadMode=qr.validateString(t,"topdown");break;case"mapGeodataLoadMode":this.config.mapGeodataLoadMode=qr.validateString(t,"fit");break;case"mapGridMode":this.config.mapGridMode=qr.validateString(t,"linear");break;case"mapGridSurrogatez":this.config.mapGridSurrogatez=qr.validateBool(t,!1);break;case"mapGridUnderSurface":this.config.mapGridUnderSurface=qr.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,0);break;case"mapGridTextureLevel":this.config.mapGridTextureLevel=qr.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,-1);break;case"mapGridTextureLayer":this.config.mapGridTextureLayer=qr.validateString(t,"");break;case"mapPreciseBBoxTest":this.config.mapPreciseBBoxTest=qr.validateBool(t,!0);break;case"mapPreciseDistanceTest":this.config.mapPreciseDistanceTest=qr.validateBool(t,!1);break;case"mapHeightfiledWhenUnloaded":this.config.mapHeightfiledWhenUnloaded=qr.validateBool(t,!1);break;case"mapForceMetatileV3":this.config.mapForceMetatileV3=qr.validateBool(t,!1);break;case"mapVirtualSurfaces":this.config.mapVirtualSurfaces=qr.validateBool(t,!0);break;case"mapDegradeHorizon":this.config.mapDegradeHorizon=qr.validateBool(t,!0);break;case"mapDegradeHorizonParams":this.config.mapDegradeHorizonParams=qr.validateNumberArray(t,4,[0,1,1,1],[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],[1,3e3,15e3,7e3]);break;case"mapRefreshCycles":this.config.mapRefreshCycles=qr.validateNumber(t,0,Number.MAXINTEGER,3);break;case"mapDefaultFont":this.config.mapDefaultFont=qr.validateString(t,"");break;case"mapMetricUnits":this.config.mapMetricUnits=qr.validateBool(t,!0);break;case"mapLanguage":this.config.mapLanguage=qr.validateString(t,"en");break;case"mapNoTextures":this.config.mapNoTextures=this.config.mapDisableCulling=qr.validateBool(t,!1);break;case"mapForceFrameTime":this.config.mapForceFrameTime=qr.validateNumber(t,-1,Number.MAXINTEGER,0);break;case"mapForcePipeline":this.config.mapForcePipeline=qr.validateNumber(t,0,Number.MAXINTEGER,0);break;case"mapFeatureGridCells":this.config.mapFeatureGridCells=qr.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,0);break;case"mapFeaturesPerSquareInch":this.config.mapFeaturesPerSquareInch=qr.validateNumber(t,1e-6,Number.MAXINTEGER,0);break;case"mapFeaturesSortByTop":this.config.mapFeaturesSortByTop=qr.validateBool(t,!1);break;case"mapFeaturesReduceParams":this.config.mapFeaturesReduceParams=t;break;case"mapLogGeodataStyles":this.config.mapLogGeodataStyles=qr.validateBool(t,!0);break;case"map16bitMeshes":this.config.map16bitMeshes=qr.validateBool(t,!1);break;case"mapOnlyOneUVs":this.config.mapOnlyOneUVs=qr.validateBool(t,!1);break;case"mapIndexBuffers":this.config.mapIndexBuffers=qr.validateBool(t,!1);break;case"mapSoftViewSwitch":this.config.mapSoftViewSwitch=qr.validateBool(t,!0);break;case"mapAsyncImageDecode":this.config.mapAsyncImageDecode=!(!qr.validateBool(t,!1)||"undefined"==typeof createImageBitmap);break;case"mapFeatureStickMode":this.config.mapFeatureStickMode=qr.validateNumberArray(t,2,[0,1],[Number.MAX_VALUE,Number.MAX_VALUE],[0,1]);break;case"mapSeparateLoader":this.config.mapSeparateLoader=qr.validateBool(t,!0);break;case"mapGeodataBinaryLoad":this.config.mapGeodataBinaryLoad=qr.validateBool(t,!0);break;case"mapPackLoaderEvents":this.config.mapPackLoaderEvents=qr.validateBool(t,!0);break;case"mapParseMeshInWorker":this.config.mapParseMeshInWorker=qr.validateBool(t,!0);break;case"mapPackGeodataEvents":this.config.mapPackGeodataEvents=qr.validateBool(t,!0);break;case"mapSortHysteresis":this.config.mapSortHysteresis=qr.validateBool(t,!1);break;case"mapHysteresisWait":this.config.mapHysteresisWait=qr.validateNumber(t,0,Number.MAXINTEGER,0);break;case"mapBenevolentMargins":this.config.mapBenevolentMargins=qr.validateBool(t,!1);break;case"mapCheckTextureSize":this.config.mapCheckTextureSize=qr.validateBool(t,!1);break;case"mapTraverseToMeshNode":this.config.mapTraverseToMeshNode=qr.validateBool(t,!0);break;case"mapNormalizeOctantTexelSize":this.config.mapNormalizeOctantTexelSize=qr.validateBool(t,!0);break;case"mapDMapSize":this.config.mapDMapSize=qr.validateNumber(t,16,Number.MAXINTEGER,512);break;case"mapDMapMode":this.config.mapDMapMode=qr.validateNumber(t,1,Number.MAXINTEGER,1);break;case"mapSplitSpace":this.config.mapSplitSpace=t;break;case"mario":this.config.mario=qr.validateBool(t,!0);break;case"mapFeaturesReduceMode":"auto"==(t=qr.validateString(t,"scr-count4"))&&(t="scr-count2"),"legacy"==t&&(t="scr-count2"),"gridcells"==t&&(t="scr-count4"),"singlepass"==t&&(t="scr-count5"),"margin"==t&&(t="scr-count6"),this.config.mapFeaturesReduceMode=t}},ui.prototype.getConfigParam=function(e){switch(e){case"map":return this.config.map;case"mapCache":return this.config.mapCache;case"mapGPUCache":return this.config.mapGPUCache;case"mapMetatileCache":return this.config.mapMetatileCache;case"mapTexelSizeFit":return this.config.mapTexelSizeFit;case"mapDownloadThreads":return this.config.mapDownloadThreads;case"mapMaxProcessingTime":return this.config.mapMaxProcessingTime;case"mapMaxGeodataProcessingTime":return this.config.mapMaxGeodataProcessingTime;case"mapMobileMode":return this.config.mapMobileMode;case"mapMobileModeAutodect":return this.config.mapMobileModeAutodect;case"mapMobileDetailDegradation":return this.config.mapMobileDetailDegradation;case"mapNavSamplesPerViewExtent":return this.config.mapNavSamplesPerViewExtent;case"mapFog":return this.config.mapFog;case"mapFlatshade":return this.config.mapFlatshade;case"mapIgnoreNavtiles":return this.config.mapIgnoreNavtiles;case"mapAllowHires":return this.config.mapAllowHires;case"mapAllowLowres":return this.config.mapAllowLowres;case"mapAllowSmartSwitching":return this.config.mapAllowSmartSwitching;case"mapDisableCulling":return this.config.mapDisableCulling;case"mapPreciseCulling":return this.config.mapPreciseCulling;case"mapHeightLodBlend":return this.config.mapHeightLodBlend;case"mapHeightNodeBlend":return this.config.mapHeightNodeBlend;case"mapBasicTileSequence":return this.config.mapBasicTileSequence;case"mapSmartNodeParsing":return this.config.mapSmartNodeParsing;case"mapStoreLoadStats":return this.config.mapStoreLoadStats;case"mapXhrImageLoad":return this.config.mapXhrImageLoad;case"mapLoadMode":return this.config.mapLoadMode;case"mapGeodataLoadMode":return this.config.mapGeodataLoadMode;case"mapGridMode":return this.config.mapGridMode;case"mapGridSurrogatez":return this.config.mapGridSurrogatez;case"mapGridUnderSurface":return this.config.mapGridUnderSurface;case"mapGridTextureLevel":return this.config.mapGridTextureLevel;case"mapGridTextureLayer":return this.config.mapGridTextureLayer;case"mapPreciseBBoxTest":return this.config.mapPreciseBBoxTest;case"mapPreciseDistanceTest":return this.config.mapPreciseDistanceTest;case"mapHeightfiledWhenUnloaded":return this.config.mapHeightfiledWhenUnloaded;case"mapForceMetatileV3":return this.config.mapForceMetatileV3;case"mapVirtualSurfaces":return this.config.mapVirtualSurfaces;case"mapDegradeHorizon":return this.config.mapDegradeHorizon;case"mapDegradeHorizonParams":return this.config.mapDegradeHorizonParams;case"mapRefreshCycles":return this.config.mapRefreshCycles;case"mapDefaultFont":return this.config.mapDefaultFont;case"mapMetricUnits":return this.config.mapMetricUnits;case"mapLanguage":return this.config.mapLanguage;case"mapNoTextures":return this.config.mapNoTextures;case"mapForceFrameTime":return this.config.mapForceFrameTime;case"mapForcePipeline":return this.config.mapForcePipeline;case"mapFeatureGridCells":return this.config.mapFeatureGridCells;case"mapFeaturesPerSquareInch":return this.config.mapFeaturesPerSquareInch;case"mapFeaturesSortByTop":return this.config.mapFeaturesSortByTop;case"mapFeaturesReduceMode":return this.config.mapFeaturesReduceMode;case"mapFeaturesReduceParams":return this.config.mapFeaturesReduceParams;case"mapLogGeodataStyles":return this.config.mapLogGeodataStyles;case"map16bitMeshes":return this.config.map16bitMeshes;case"mapOnlyOneUVs":return this.config.mapOnlyOneUVs;case"mapIndexBuffers":return this.config.mapIndexBuffers;case"mapSoftViewSwitch":return this.config.mapSoftViewSwitch;case"mapAsyncImageDecode":return this.config.mapAsyncImageDecode;case"mapFeatureStickMode":return this.config.mapFeatureStickMode;case"mapSeparateLoader":return this.config.mapSeparateLoader;case"mapGeodataBinaryLoad":return this.config.mapGeodataBinaryLoad;case"mapPackLoaderEvents":return this.config.mapPackLoaderEvents;case"mapParseMeshInWorker":return this.config.mapParseMeshInWorker;case"mapPackGeodataEvents":return this.config.mapPackGeodataEvents;case"mapSortHysteresis":return this.config.mapSortHysteresis;case"mapHysteresisWait":return this.config.mapHysteresisWait;case"mapBenevolentMargins":return this.config.mapBenevolentMargins;case"mapDMapSize":return this.config.mapDMapSize;case"mapDMapMode":return this.config.mapDMapMode;case"mario":return this.config.mario}},ui.prototype.click=function(e,t,r){this.clickEvent=[e,t,r]},ui.prototype.hover=function(e,t,r,i){this.hoverEvent=[e,t,r,i]},ui.prototype.markDirty=function(){this.dirty=!0,this.hitMapDirty=!0,this.geoHitMapDirty=!0},ui.prototype.getScreenRay=function(e,t){return this.renderer.getScreenRay(e,t)},ui.prototype.renderToImage=function(e){var t=this.renderer.gpu.canvas,r=t.width,i=t.height,a=qr.fitToPowerOfTwo(r),s=qr.fitToPowerOfTwo(i),n=new Uint8Array(a*s*4);(e=new li(this.renderer.gpu)).createFromData(a,s,n),e.createFramebuffer(a,s),this.draw.drawToTexture(e),n=e.readFramebufferPixels(0,0,r,i),e.kill();for(var o=new Uint8Array(r*i*4),h=0;h<i;h++)for(var l=h*r*4,u=(i-h-1)*r*4,d=0;d<r;d++)o[u]=n[l],o[u+1]=n[l+1],o[u+2]=n[l+2],o[u+3]=n[l+3],l+=4,u+=4;return{width:r,height:i,data:o}},ui.prototype.getScreenDepth=function(e,t,r){if(r){var i,a,s=this.camera.position,n=this.renderer.getScreenRay(e,t);if(this.getNavigationSrs().isProjected()){var o=[0,0,Math.min(-1e3,this.referenceFrame.getGlobalHeightRange()[0])],h=[0,0,1];return a=Hr.dot(h,n),i=[o[0]-s[0],o[1]-s[1],o[2]-s[2]],(f=Hr.dot(i,h)/a)>=0?[!0,f]:[!1,1]}var l=this.getNavigationSrs().getSrsInfo().b+this.referenceFrame.getGlobalHeightRange()[0],u=[s[0],s[1],s[2]];i=Hr.dot(n,n);var d=2*Hr.dot(n,u);if((a=d*d-4*i*(Hr.dot(u,u)-l*l))>0){var c=(-d-(a=Math.sqrt(a)))/(2*i),p=(-d+a)/(2*i),f=c<p?c:p;return[!0,f]}return[!1,1]}if(this.hitMapDirty){var m=this.draw.ndcToScreenPixel;this.draw.drawHitmap(),this.draw.ndcToScreenPixel=m;var g=this.renderer.curSize[0],v=this.renderer.curSize[1],y=new Float32Array(16);y[0]=2/g,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=-2/v,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[10]=1,y[11]=0,y[12]=.5*-g*y[0],y[13]=.5*-v*y[5],y[14]=0,y[15]=1,this.renderer.imageProjectionMatrix=y,this.renderer.camera.update()}return this.renderer.getDepth(e,t)},ui.prototype.getHitCoords=function(e,t,r,i){this.hitMapDirty&&this.draw.drawHitmap();var a,s,n,o=this.renderer.hitTest(e,t),h=!1,l=this.camera.position,u=o[4];if(this.getNavigationSrs().isProjected()){var d=[0,0,Math.min(-1e3,this.referenceFrame.getGlobalHeightRange()[0])],c=[0,0,1];n=Hr.dot(c,u),s=[d[0]-l[0],d[1]-l[1],d[2]-l[2]],(y=Hr.dot(s,c)/n)>=0&&(!o[3]||y<o[5])&&(a=[u[0]*y+l[0],u[1]*y+l[1],u[2]*y+l[2]],h=!0)}else{var p=this.getNavigationSrs().getSrsInfo().b+this.referenceFrame.getGlobalHeightRange()[0],f=[l[0],l[1],l[2]];s=Hr.dot(u,u);var m=2*Hr.dot(u,f);if((n=m*m-4*s*(Hr.dot(f,f)-p*p))>0){var g=(-m-(n=Math.sqrt(n)))/(2*s),v=(-m+n)/(2*s),y=g<v?g:v;(!o[3]||y<o[5])&&(a=[u[0]*y+l[0],u[1]*y+l[1],u[2]*y+l[2]],h=!0)}}if(!o[3]&&!h)return null;h||(a=[o[0]+l[0],o[1]+l[1],o[2]+l[2]]);var b=this.convert.convertCoords(a,"physical","navigation");if(this.renderer.useSuperElevation&&(b[2]=this.renderer.getUnsuperElevatedHeight(b[2])),"float"==r){i=null!=i?i:this.measure.getOptimalHeightLod(b,100,this.config.mapNavSamplesPerViewExtent);var x=this.measure.getSurfaceHeight(b,i);b[2]-=x[0]}return b},ui.prototype.hitTestGeoLayers=function(e,t,r){if(this.geoHitMapDirty&&this.freeLayersHaveGeodata&&this.draw.drawGeodataHitmap(),!this.freeLayersHaveGeodata)return this.lastHoverFeature=null,this.lastHoverFeatureId=null,this.hoverFeature=null,this.hoverFeatureId=null,[null,!1,[]];var i,a,s=this.renderer.hitTestGeoLayers(e,t);if(!s[0])return i=[],"hover"==r&&(this.lastHoverFeature=this.hoverFeature,this.lastHoverFeatureId=this.hoverFeatureId,this.hoverFeature=null,this.hoverFeatureId=null,null!=this.lastHoverFeatureId&&(null!=this.lastHoverFeatureId&&i.push(["leave",this.lastHoverFeature,this.lastHoverFeatureId]),this.dirty=!0)),[null,!1,i,a];var n=s[1]+(s[2]<<8),o=this.hoverFeatureList[n];return o?(o[6]&&(s=this.renderer.hitTestGeoLayers(e,t,!0))[0]&&(a=s[1]+(s[2]<<8)),"hover"==r?(this.lastHoverFeature=this.hoverFeature,this.lastHoverFeatureId=this.hoverFeatureId,o&&o[3]?(this.hoverFeature=o,this.hoverFeatureId=null!=o?o[0]["#id"]:null):(this.hoverFeature=null,this.hoverFeatureId=null),i=[],this.hoverFeatureId!=this.lastHoverFeatureId&&(null!=this.lastHoverFeatureId&&i.push(["leave",this.lastHoverFeature,this.lastHoverFeatureId]),null!=this.hoverFeatureId&&i.push(["enter",this.hoverFeature,this.hoverFeatureId]),this.dirty=!0),null!=this.hoverFeature&&this.hoverFeature[3]?[this.hoverFeature,!0,i,a]:[null,!1,i,a]):"click"==r?null!=o&&o[2]?[o,!0,[],a]:[null,!1,[],a]:void 0):[null,!1,[],a]},ui.prototype.getCurrentGeometry=function(){if(this.draw.tree.surfaceSequence.length>0){this.draw.tree.draw(!0);var e=this.storedTilesRes;return this.storedTilesRes=[],e}return e},ui.prototype.applyCredits=function(e){var t,r;for(var i in e.imageryCredits)t=e.imageryCredits[i],r=this.visibleCredits.imagery[i],this.visibleCredits.imagery[i]=r?t>r?t:r:t;for(i in e.glueImageryCredits)t=e.glueImageryCredits[i],r=this.visibleCredits.imagery[i],this.visibleCredits.glueImagery[i]=r?t>r?t:r:t;for(i in e.mapdataCredits)t=e.mapdataCredits[i],r=this.visibleCredits.mapdata[i],this.visibleCredits.mapdata[i]=r?t>r?t:r:t},ui.prototype.drawMap=function(){this.draw.drawMap(null)},ui.prototype.processProcessingTasks=function(){for(;this.processingTasks.length>0;){if(this.stats.renderBuild>this.config.mapMaxProcessingTime)return void this.markDirty();this.processingTasks[0](),this.processingTasks.shift()}for(;this.processingTasks2.length>0&&-123!=this.processingTasks2[0]();)this.processingTasks2.shift()},ui.prototype.addProcessingTask=function(e){this.processingTasks.push(e)},ui.prototype.addProcessingTask2=function(e){this.processingTasks2.push(e)},ui.prototype.update=function(){if(!this.killed)if(this.core.tokenExpiration&&Date.now()>this.core.tokenExpiration-6e4&&this.core.tokenExpirationCallback(),this.srsReady){if(!this.div||"hidden"!=this.div.style.visibility){this.position.isSame(this.lastPosition)||this.core.callListener("map-position-changed",{position:this.position.toArray(),"last-position":this.lastPosition.toArray()}),this.camera.lastTerrainHeight!=this.camera.terrainHeight&&this.core.callListener("map-position-fixed-height-changed",{height:this.camera.terrainHeight,"last-height":this.camera.lastTerrainHeight}),this.lastPosition=this.position.clone(),this.camera.lastTerrainHeight=this.camera.terrainHeight,this.drawFog=this.config.mapFog;var e,t=this.renderer.div.getBoundingClientRect(),r=this.renderer,i=r.cameraPosition;r.curSize[0]==t.width&&r.curSize[1]==t.height||(r.onResize(),this.dirty=!0);var a,s=this.dirty||this.dirtyCountdown>0;if(this.stats.begin(s),this.loader.update(),this.processProcessingTasks(),s&&(this.dirty?this.dirtyCountdown=this.config.mapRefreshCycles:this.dirtyCountdown--,this.dirty=!1,this.bestMeshTexelSize=0,this.bestGeodataTexelSize=0,this.renderSlots.processRenderSlots(),this.loader.update(),this.core.callListener("map-update",{})),null!=this.clickEvent||null!=this.hoverEvent){if(null!=this.hoverEvent){var n=(a=this.hitTestGeoLayers(this.hoverEvent[0],this.hoverEvent[1],"hover"))[2];if(null!=n)for(var o=0,h=n.length;o<h;o++){var l=n[o];switch(l[0]){case"enter":e=l[1][1],this.core.callListener("geo-feature-enter",{feature:l[1][0],"canvas-coords":r.project2(l[1][1],r.camera.mvp,i),"physical-coords":[e[0]+i[0],e[1]+i[1],e[2]+i[2]],state:this.hoverEvent[3],element:a[3]});break;case"leave":e=l[1][1],this.core.callListener("geo-feature-leave",{feature:l[1][0],"canvas-coords":r.project2(l[1][1],r.camera.mvp,i),"physical-coords":[e[0]+i[0],e[1]+i[1],e[2]+i[2]],state:this.hoverEvent[3],element:a[3]})}}a[1]&&null!=a[0]&&(e=a[0][1],this.core.callListener("geo-feature-hover",{feature:a[0][0],"canvas-coords":r.project2(a[0][1],r.camera.mvp,i),"physical-coords":[e[0]+i[0],e[1]+i[1],e[2]+i[2]],state:this.hoverEvent[3],element:a[3]})),!0!==this.hoverEvent[2]&&(this.hoverEvent=null)}null!=this.clickEvent&&((a=this.hitTestGeoLayers(this.clickEvent[0],this.clickEvent[1],"click"))[1]&&null!=a[0]&&(e=a[0][1],this.core.callListener("geo-feature-click",{feature:a[0][0],"canvas-coords":r.project2(a[0][1],r.camera.mvp,i),"physical-coords":[e[0]+i[0],e[1]+i[1],e[2]+i[2]],state:this.clickEvent[2],element:a[3]})),this.clickEvent=null)}this.stats.end(s)}}else this.loader.update()};var di=ui,ci=function(e){this.inspector=e,this.core=e.core};ci.prototype.init=function(){document.addEventListener("keyup",this.onKeyUp.bind(this),!1),document.addEventListener("keypress",this.onKeyPress.bind(this),!1),document.addEventListener("keydown",this.onKeyDown.bind(this),!1)},ci.prototype.onKeyDown=function(e){void 0===e&&(e=window.event),this.altDown=e.altKey,this.ctrlDown=e.ctrlKey,this.shiftDown=e.shiftKey,this.onKeyUp(e,!0)},ci.prototype.onKeyPress=function(e){this.onKeyUp(e,!0)},ci.prototype.onKeyUp=function(e,t){void 0===e&&(e=window.event);var r=this.core.getMap(),i=this.inspector;if(r){var a=r.draw.debug;this.altDown=e.altKey,this.ctrlDown=e.ctrlKey,this.shiftDown=e.shiftKey;var s=!1,n=!0;if(e){var o;if(o=window.event?window.event.keyCode:e.which?e.which:e.charCode,this.shiftDown&&this.ctrlDown)switch(o){case 68:case 100:i.preventDefault(e)}if(this.shiftDown&&!0!==t){if(this.ctrlDown)switch(o){case 68:case 100:i.enableInspector(),this.diagnosticMode=!0,s=!0}if(this.diagnosticMode){switch(n=!0,o){case 67:case 99:i.shakeCamera=!i.shakeCamera;break;case 49:case 50:case 51:case 48:break;case 72:case 104:a.heightmapOnly=!a.heightmapOnly;break;case 81:case 113:var h=r.getPosition();console.log("pos-before: "+JSON.stringify(h.pos)),r.convert.convertPositionViewMode(h,"obj"==h.getViewMode()?"subj":"obj"),console.log("new mode: "+h.getViewMode()),console.log("pos-after: "+JSON.stringify(h.pos)),r.setPosition(h),this.altDown&&"obj"!=h.getViewMode()?r.camera.near=.1:r.camera.near=2,i.preventDefault(e);break;case 80:case 112:r.renderer.saveScreenshot("file","vts-screenshot.png","png");break;case 83:case 115:i.stats.switchPanel();break;case 86:case 118:i.layers.switchPanel();break;case 69:case 101:i.stylesheets.switchPanel();break;case 84:case 116:i.replay.switchPanel();break;case 66:case 98:a.drawBBoxes=!a.drawBBoxes;break;case 65:case 97:a.drawLabelBoxes=!a.drawLabelBoxes;break;case 75:case 107:a.drawAllLabels=!a.drawAllLabels;break;case 73:case 105:a.drawHiddenLabels=!a.drawHiddenLabels;break;case 87:case 119:if(3==a.drawWireframe)a.drawWireframe=1;else{var l=a.drawWireframe+1;a.drawWireframe=l>2?0:l}break;case 70:case 102:a.drawWireframe=3!=a.drawWireframe?3:0;break;case 85:case 117:r.renderer.setSuperElevationState(!r.renderer.useSuperElevation);break;case 71:case 103:a.meshStats=!a.meshStats,s=!0;break;case 77:case 109:r.loaderSuspended=!r.loaderSuspended,console.log("loader state "+r.loaderSuspended);break;case 74:case 106:a.drawEarth=!a.drawEarth,s=!0;break;case 88:case 120:a.drawFog=!a.drawFog,s=!0;break;case 89:case 120:r.config.mapSplitLods=!r.config.mapSplitLods,s=!0;break;case 82:case 114:i.graphs.switchPanel();break;case 79:case 111:r.camera.camera.setOrtho(!r.camera.camera.getOrtho());break;case 76:case 108:i.drawRadar=!i.drawRadar;break;case 90:case 122:a.maxZoom=!a.maxZoom;break;case 78:case 110:a.drawNBBoxes=!a.drawNBBoxes;break;default:n=!1}n&&(s=!0)}}if(this.diagnosticMode&&a.drawWireframe&&!t&&o>=96&&o<=105&&(this.altDown?(a.drawTestData=o-96,this.ctrlDown&&(a.drawTestData+=10)):a.drawTestMode=o-96,s=!0),this.diagnosticMode&&i.drawRadar&&!this.shiftDown&&!t){switch(n=!0,o){case 43:case 107:null==i.radarLod&&(i.radarLod=8),i.radarLod++;break;case 45:case 109:null==i.radarLod&&(i.radarLod=8),i.radarLod=Math.max(0,i.radarLod-1);break;case 42:case 106:i.radarLod=null;break;default:n=!1}n&&(s=!0)}if(this.diagnosticMode&&(a.drawBBoxes||a.drawNBBoxes)&&!this.shiftDown&&!t){switch(n=!0,o){case 76:case 108:a.drawLods=!a.drawLods;break;case 80:case 112:a.drawPositions=!a.drawPositions;break;case 85:case 117:a.drawOctants=!a.drawOctants;break;case 84:case 116:a.drawTextureSize=!a.drawTextureSize;break;case 70:case 102:a.drawFaceCount=!a.drawFaceCount;break;case 71:case 103:a.drawGeodataOnly=!a.drawGeodataOnly;break;case 68:case 100:a.drawDistance=!a.drawDistance;break;case 86:case 118:a.drawSpaceBBox=!a.drawSpaceBBox;break;case 78:case 110:a.drawNodeInfo=!a.drawNodeInfo;break;case 77:case 109:a.drawMeshBBox=!a.drawMeshBBox;break;case 73:case 105:a.drawIndices=!a.drawIndices;break;case 66:case 98:a.drawBoundLayers=!a.drawBoundLayers;break;case 82:case 114:a.drawResources=!a.drawResources;break;case 83:case 115:a.drawSurfaces=!a.drawSurfaces;break;case 90:case 122:a.drawSurfaces2=!a.drawSurfaces2;break;case 67:case 99:a.drawCredits=!a.drawCredits;break;case 79:case 111:a.drawOrder=!a.drawOrder;break;case 69:case 101:a.debugTextSize=2==a.debugTextSize?3:2;break;case 88:case 120:r.config.mapPreciseBBoxTest=!r.config.mapPreciseBBoxTest;break;case 87:case 119:a.drawPolyWires=!a.drawPolyWires;break;case 90:case 122:r.config.mapPreciseDistanceTest=!r.config.mapPreciseDistanceTest;break;case 75:case 107:a.drawGPixelSize=!a.drawGPixelSize;break;default:n=!1}n&&(s=!0)}}s&&(r.markDirty(),i.preventDefault(e))}},ci.prototype.setParameter=function(e,t){var r=this.core.getMap(),i=this.inspector;if(r){var a=r.draw.debug,s=function(e){return!0===t||"true"==t||"1"==t};switch(e){case"debugMode":this.diagnosticMode=!0;break;case"debugBBox":a.drawBBoxes=!0;case"debugNBBox":"debugNBBox"==e&&(a.drawNBBoxes=!0);var n=function(e){return-1!=t.indexOf(e)};n("L")&&(a.drawLods=!0),n("P")&&(a.drawPositions=!0),n("T")&&(a.drawTextureSize=!0),n("F")&&(a.drawFaceCount=!0),n("G")&&(a.drawGeodataOnly=!0),n("D")&&(a.drawDistance=!0),n("N")&&(a.drawNodeInfo=!0),n("V")&&(a.drawSpaceBBox=!0),n("M")&&(a.drawMeshBBox=!0),n("I")&&(a.drawIndices=!0),n("U")&&(a.drawOctants=!0),n("B")&&(a.drawBoundLayers=!0),n("S")&&(a.drawSurfaces=!0),n("Z")&&(a.drawSurfaces2=!0),n("C")&&(a.drawCredits=!0),n("O")&&(a.drawOrder=!0),n("E")&&(a.debugTextSize=3),n("K")&&(a.drawGPixelSize=!0);break;case"debugLBox":a.drawLabelBoxes=s();break;case"debugNoEarth":a.drawEarth=!s();break;case"debugShader":a.drawWireframe=parseInt(t);break;case"debugHeightmap":a.heightmapOnly=s();break;case"debugGridCells":a.drawGridCells=s();break;case"debugRadar":i.enableInspector(),i.drawRadar=!0,i.radarLod=parseInt(t),isNaN(i.radarLod)&&(i.radarLod=null)}r.markDirty()}};var pi=ci,fi=function(e){this.inspector=e,this.core=e.core};fi.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-stats-panel {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;display: none;padding:15px;width: 305px;font-size: 14px;position: absolute;right: 10px;top: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-stats-panel-info {margin-top: 5px;margin-bottom: 3px;overflow: hidden;}#vts-stats-panel-info table {color:#000000;text-align: left;font-size: 12px;}#vts-stats-panel-info table td {vertical-align: top;}#vts-stats-panel-pos {width: 100%;}'),this.element=document.createElement("div"),this.element.id="vts-stats-panel",this.element.innerHTML='<span id="vts-stats-panel-title">Render statistics &nbsp;&nbsp;&nbsp;v'+ys()+'</h3><p id="vts-stats-panel-info"></p><input id="vts-stats-panel-pos" type="text">',this.core.element.appendChild(this.element),this.infoElement=document.getElementById("vts-stats-panel-info"),this.posElement=document.getElementById("vts-stats-panel-pos"),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.panelVisible=!1},fi.prototype.showPanel=function(){this.element.style.display="block",this.panelVisible=!0},fi.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},fi.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},fi.prototype.updateStatsPanel=function(e){if(this.infoElement&&this.panelVisible){var t=this.inspector,r="FPS: "+Math.round(e.fps)+"<br/>Render time: "+Math.round(1e3*e.renderTime)+"<br/> - resources: "+Math.round(e.gpuRenderUsed/1048576)+"MB<br/> - topdown: "+Math.round(e.gpuNeeded/1048576)+"MB<br/>GPU Cache: "+Math.round(e.gpuUsed/1048576)+"MB<br/> - textures: "+Math.round(e.gpuTextures/1048576)+"MB<br/> - meshes: "+Math.round(e.gpuMeshes/1048576)+"MB<br/> - geodata: "+Math.round(e.gpuGeodata/1048576)+"MB<br/>CPU Cache: "+Math.round(e.resourcesUsed/1048576)+"MB<br/>Metatile Cache: "+Math.round(e.metaUsed/1048576)+"MB<br/>Draw calls: "+e.drawCalls+"<br/>Polygons: "+e.drawnFaces+"<br/><br/>Terrain Height: "+e.heightTerrain.toFixed(2)+"<br/>- float: "+e.heightDelta.toFixed(2)+"<br/>- desired lod: "+e.heightLod.toFixed(2)+"<br/>- used lod: "+e.heightNode.toFixed(2)+"<br/>- used source: "+(2==e.heightClass?"navtile":1==e.heightClass?"node":"---")+"<br/>Terrain Radar Lod: "+t.radarLod+"<br/><br/>Loaded/Errors: "+e.loadedCount+" / "+e.loadErrorCount+"<br/>Load time: "+(.001*(e.loadLast-e.loadFirst)).toFixed(2)+"s <br/>",i=this.core.renderer;i&&(r+="<br/>Render jobs: "+i.totalJobs+"<br/>Drawn jobs: "+i.drawnJobs+"<br/>Jobs total time: "+Math.round(1e3*(i.jobsTimer2-i.jobsTimer1))+"<br/>Jobs reduce time: "+Math.round(1e3*i.jobsTimer4)+"<br/>"),e.debugStr&&(r+=e.debugStr+"<br/>");var a="PixelRatio: "+(window.devicePixelRatio||1).toFixed(3)+"<br/>BFRate: "+Math.round(1e3/(e.frameTime+1e-5))+"<br/><br/>",s=this.core.getMap();s&&(a+="ReduceMode: <br/>"+s.config.mapFeaturesReduceMode+"<br/>ReduceParams: <br/>"+JSON.stringify(s.config.mapFeaturesReduceParams)+"<br/><br/>",s.draw.debug.meshStats&&(a+="TexelsPerPoly: "+(e.meshesUVArea/Math.max(1,e.meshesFaces)).toFixed(2)+"<br/><br/>")),a+="Metatiles: "+e.processedMetatiles+"<br/>Metanodes: "+e.processedNodes+" / "+e.usedNodes+"<br/>GeodataTiles: "+e.drawnGeodataTiles+"<br/>",e.octoNodes&&(a+="OctoNodes: "+e.octoNodes+"<br/>OctoNodesMem: "+Math.round(e.octoNodesMemSize/1048576)+"MB<br/>"),a+="<br/>",i&&(a+="Nodes: "+i.drawnNodes+"<br/><br/>"),a+="Tiles: "+e.drawnTiles+"<br/>";for(var n=0,o=e.renderedLods.length;n<o;n++)e.renderedLods[n]&&(a+="LOD "+n+": "+e.renderedLods[n]+"<br/>");var h='<table style="width:305px"><tr><td>'+r+"</td><td>"+a+"</td></tr></table>";if(this.infoElement.innerHTML=h,s){var l=s.getPosition(),u="";u+=l.getViewMode()+",";var d=l.getCoords();u+=d[0]+","+d[1]+","+l.getHeightMode()+","+d[2].toFixed(2)+",";var c=l.getOrientation();u+=c[0].toFixed(2)+","+c[1].toFixed(2)+","+c[2].toFixed(2)+",",u+=l.getViewExtent().toFixed(2)+","+l.getFov().toFixed(2),this.posElement.value!=u&&(this.posElement.value=u)}}};var mi=fi,gi=function(e){this.inspector=e,this.core=e.core};gi.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-graphs-panel {position:absolute;left:10px;top:10px;z-index: 7;background-color: #FFFFFF;padding: 5px;border-radius: 4px;font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;color:#000000;text-align: left;font-size: 12px;display:none;}.vts-graphs-canvas {border: solid 1px #bbb;image-rendering : pixelated;}.vts-graphs-info {padding: 5px 2px;font-size: 10px;}.vts-graphs-button {padding: 2px 5px;display:inline-block;margin-right: 4px;border-radius: 4px;cursor:pointer;}.vts-graphs-button:hover {box-shadow: 0 0 1px #0066ff;}'),this.element=document.createElement("div"),this.element.id="vts-graphs-panel",this.element.innerHTML='<canvas id="vts-graphs-render" class="vts-graphs-canvas" width="900" height="100" ></canvas><div id="vts-graphs-info" class="vts-graphs-info" >&FilledSmallSquare; Frame: 1234 &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Render: 1234 &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: 1234 &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Mesh: 1234 &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> GpuMesh: 1234</div><canvas id="vts-graphs-cache" class="vts-graphs-canvas" width="900" height="100" ></canvas><div id="vts-graphs-info2" class="vts-graphs-info" >&FilledSmallSquare; Cache: 1234 &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Used: 123 &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: 1234 &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> Mesh: &nbsp 1234</div><div id="vts-graphs-rec" class="vts-graphs-button" >Recording On</div><div id="vts-graphs-ref" class="vts-graphs-button" >Refresh On</div><div id="vts-graphs-res" class="vts-graphs-button" >Reset</div><div id="vts-graphs-zoom" class="vts-graphs-button" >Scale: Max value</div><div id="vts-graphs-magnify" class="vts-graphs-button" >Magnify Off</div><div id="vts-graphs-graph" class="vts-graphs-button" >Graph: Cache</div>',this.core.element.appendChild(this.element),this.canvasRender=document.getElementById("vts-graphs-render"),this.canvasCache=document.getElementById("vts-graphs-cache"),this.canvasRenderCtx=this.canvasRender.getContext("2d"),this.canvasCacheCtx=this.canvasCache.getContext("2d"),document.getElementById("vts-graphs-rec").onclick=this.recordingPressed.bind(this),document.getElementById("vts-graphs-rec").onclick=this.recordingPressed.bind(this),document.getElementById("vts-graphs-ref").onclick=this.refreshPressed.bind(this),document.getElementById("vts-graphs-res").onclick=this.resetPressed.bind(this),document.getElementById("vts-graphs-zoom").onclick=this.zoomPressed.bind(this),document.getElementById("vts-graphs-magnify").onclick=this.magnifyPressed.bind(this),document.getElementById("vts-graphs-graph").onclick=this.graphPressed.bind(this),document.getElementById("vts-graphs-render").onmousemove=this.onMouseMove.bind(this),document.getElementById("vts-graphs-render").onmouseout=this.onMouseOut.bind(this),document.getElementById("vts-graphs-cache").onmousemove=this.onMouseMove.bind(this),document.getElementById("vts-graphs-cache").onmouseout=this.onMouseOut.bind(this),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.zoom="max",this.graph="Cache",this.refresh=!0,this.panelVisible=!1},gi.prototype.showPanel=function(){this.element.style.display="block",this.panelVisible=!0,this.recordingPressed(!0)},gi.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1,this.recordingPressed(!0)},gi.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},gi.prototype.recordingPressed=function(e){var t=this.core.getMap();t&&(t.stats.recordGraphs=null==e?e:!t.stats.recordGraphs,this.updateGraphsPanel(),this.updateGraphs(null,!0))},gi.prototype.refreshPressed=function(){this.refresh=!this.refresh,this.updateGraphsPanel(),this.updateGraphs()},gi.prototype.resetPressed=function(){var e=this.core.getMap();e&&(e.stats.resetGraphs(),this.updateGraphs(null,!0))},gi.prototype.zoomPressed=function(){switch(this.zoom){case"max":this.zoom="120avrg";break;case"120avrg":this.zoom="180avrg";break;case"180avrg":this.zoom="max"}this.updateGraphsPanel(),this.updateGraphs()},gi.prototype.graphPressed=function(){switch(this.graph){case"Cache":this.graph="Polygons";break;case"Polygons":this.graph="Processing";break;case"Processing":this.graph="LODs";break;case"LODs":this.graph="Flux";break;case"Flux":this.graph="Cache"}this.updateGraphsPanel(),this.updateGraphs()},gi.prototype.magnifyPressed=function(){this.magnify=!this.magnify,this.magnify?(this.canvasRender.style.width="1400px",this.canvasRender.style.height="200px",this.canvasCache.style.width="1400px",this.canvasCache.style.height="200px",document.getElementById("vts-graphs-magnify").innerHTML="Magnify On"):(this.canvasRender.style.width="900px",this.canvasRender.style.height="100px",this.canvasCache.style.width="900px",this.canvasCache.style.height="100px",document.getElementById("vts-graphs-magnify").innerHTML="Magnify Off"),this.updateGraphsPanel(),this.updateGraphs()},gi.prototype.updateGraphsPanel=function(){var e=this.core.getMap();if(e){switch(e.stats.recordGraphs?document.getElementById("vts-graphs-rec").innerHTML="Recording On":document.getElementById("vts-graphs-rec").innerHTML="Recording Off",this.refresh?document.getElementById("vts-graphs-ref").innerHTML="Refresh On":document.getElementById("vts-graphs-ref").innerHTML="Refresh Off",this.zoom){case"max":document.getElementById("vts-graphs-zoom").innerHTML="Scale: Max value";break;case"120avrg":document.getElementById("vts-graphs-zoom").innerHTML="Scale: 100% Avrg";break;case"180avrg":document.getElementById("vts-graphs-zoom").innerHTML="Scale: 50% Avrg"}document.getElementById("vts-graphs-graph").innerHTML="Graph: "+this.graph}},gi.prototype.onMouseMove=function(e){var t=e.clientX-this.canvasRender.getBoundingClientRect().left;this.showCursor=!0,this.magnify&&(t=Math.floor(900*t/1400)),this.cursorIndex=t;var r=this.core.getMap();r&&(r.stats.recordGraphs||this.updateGraphs(null))},gi.prototype.onMouseOut=function(){this.showCursor=!1,this.updateGraphs(null)},gi.prototype.updateGraphs=function(e,t){var r=this.core.getMap();if(r&&(this.refresh||t)&&this.panelVisible){e=e||r.stats;var i=this.canvasRender.width,a=this.canvasRender.height,s=this.canvasRenderCtx,n=e.graphsTimeSamples,o=e.graphsTimeIndex,h=i/n;s.clearRect(0,0,i,a);var l,u,d,c,p,f,m,g,v,y,b,x,S=0,M=0,w=0,T=0,A=0,C=0,F=0,P=e.graphsFrameTimes,L=e.graphsRenderTimes,E=e.graphsCreateTextureTimes,N=e.graphsCreateMeshTimes,B=e.graphsCreateGpuMeshTimes;for(l=0;l<n;l++){M+=P[l],w+=L[l],T+=E[l],A+=N[l],C+=B[l];var I=P[l];I>S&&(S=I),I>0&&F++}for("120avrg"==this.zoom&&(S=M/F*1),"180avrg"==this.zoom&&(S=M/F*.5),v=a/S,l=0;l<n;l++)c=o+l,c%=n,s.fillStyle="#000000",s.fillRect(l*h,a,1,-P[c]*v),s.fillStyle="#ff0000",s.fillRect(l*h,a,1,-L[c]*v),s.fillStyle="#0000ff",s.fillRect(l*h,a,1,-E[c]*v),g=a-E[c]*v,s.fillStyle="#007700",s.fillRect(l*h,g,1,-N[c]*v),g-=N[c]*v,s.fillStyle="#00ff00",s.fillRect(l*h,g,1,-B[c]*v);switch(this.showCursor?(s.fillStyle="#aa00aa",c=this.cursorIndex%n,s.fillRect(Math.floor(c*h)-1,0,1,a),s.fillRect(Math.floor(c*h)+1,0,1,a),m="&FilledSmallSquare; Frame: "+P[c=(this.cursorIndex+o)%n].toFixed(2)+' &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Render: '+L[c].toFixed(2)+' &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: '+E[c].toFixed(2)+' &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Meshes: '+N[c].toFixed(2)+' &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> GpuMeshes: '+B[c].toFixed(2)+"</div>"):m="&FilledSmallSquare; Frame: "+Math.round(M)+' &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Render: '+Math.round(w)+' &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: '+Math.round(T)+' &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Meshes: '+Math.round(A)+' &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> GpuMeshes: '+Math.round(C)+"</div>",document.getElementById("vts-graphs-info").innerHTML=m,i=this.canvasCache.width,a=this.canvasCache.height,h=i/n,(s=this.canvasCacheCtx).clearRect(0,0,i,a),this.graph){case"Cache":v=a/(r.gpuCache.maxCost+r.resourcesCache.maxCost+r.metatileCache.maxCost);var k=0,R=0,_=0,z=0,U=0,D=0,O=e.graphsCpuMemoryMetatiles,V=e.graphsCpuMemoryUsed,G=e.graphsGpuMemoryRender;for(x=e.graphsGpuMemoryGeodata,E=e.graphsGpuMemoryTextures,N=e.graphsGpuMemoryMeshes,l=0;l<n;l++)k=O[l]>k?O[l]:k,R=V[l]>R?V[l]:R,_=E[l]>_?E[l]:_,z=N[l]>z?N[l]:z,U=x[l]>U?x[l]:U,D=G[l]>D?G[l]:D;for(l=0;l<n;l++)c=o+l,p=O[c%=n]+N[c]+E[c]+x[c]+V[c],s.fillStyle="#000000",s.fillRect(l*h,a,1,-p*v),p-=V[c],s.fillStyle="#0000ff",s.fillRect(l*h,a,1,-p*v),p-=E[c],s.fillStyle="#009999",s.fillRect(l*h,a,1,-p*v),p-=x[c],s.fillStyle="#007700",s.fillRect(l*h,a,1,-p*v),p-=N[c],s.fillStyle="#ff0000",s.fillRect(l*h,a,1,-p*v),p=G[c],s.fillStyle="#ffff00",s.fillRect(l*h,a-p*v,1,1);this.showCursor?(c=(this.cursorIndex+o)%n,m='<span style="color:#555">&FilledSmallSquare;</span> Total: '+Math.ceil((O[c]+V[c]+E[c]+N[c])/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> CPU: '+Math.ceil(V[c]/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> GPU: '+Math.ceil((E[c]+N[c])/1048576)+'MB &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Te: '+Math.ceil(E[c]/1048576)+'MB &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Me: '+Math.ceil(N[c]/1048576)+'MB &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Ge: '+Math.ceil(x[c]/1048576)+'MB &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Met: '+Math.ceil(O[c]/1048576)+'MB &nbsp <span style="color:#ffff00">&FilledSmallSquare;</span> Render: '+Math.ceil(G[c]/1048576)+"MB</div>"):m='<span style="color:#555">&FilledSmallSquare;</span> Total: '+Math.round((k+R+_+z)/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> CPU: '+Math.ceil(R/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> GPU: '+Math.ceil((_+z)/1048576)+'MB &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Te '+Math.ceil(_/1048576)+'MB &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Me: '+Math.ceil(z/1048576)+'MB &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Ge: '+Math.ceil(U/1048576)+'MB &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Met: '+Math.ceil(k/1048576)+'MB &nbsp <span style="color:#ffff00">&FilledSmallSquare;</span> Render: '+Math.ceil(D/1048576)+"MB</div>";break;case"Polygons":case"Processing":y=0,b=99999999999,F=0,f="Polygons"==this.graph?e.graphsPolygons:e.graphsBuild;var j=0;for(l=0;l<n;l++)y=f[l]>y?f[l]:y,f[l]>0&&(b=f[l]<b?f[l]:b,j+=f[l],F++);for(v=a/y,l=0;l<n;l++)c=o+l,c%=n,s.fillStyle="#007700",s.fillRect(l*h,a,1,-f[c]*v);this.showCursor?(c=(this.cursorIndex+o)%n,m='<span style="color:#007700">&FilledSmallSquare;</span> '+this.graph+" Max: "+Math.round(f[c])+"</div>"):(m='<span style="color:#007700">&FilledSmallSquare;</span> '+this.graph+" Max: "+y+"</div>",m+=" &nbsp Min: "+b,m+=" &nbsp Avrg: "+Math.round(j/F)+"</div>");break;case"LODs":for(y=0,f=e.graphsLODs,l=0;l<n;l++)y=f[l][0]>y?f[l][0]:y;var H;for(v=a/y,s.fillStyle="#000000",s.fillRect(0,0,i,a),l=0;l<n;l++)for(c=o+l,g=a,u=0,d=(H=f[c%=n][1]).length;u<d;u++)H[u]&&(s.fillStyle="hsl("+23*u%360+",100%,50%)",p=Math.round(H[u]*v),s.fillRect(l*h,g,1,-p),g-=p);if(this.showCursor)for(m="LODs:"+f[c=(this.cursorIndex+o)%n][0],u=0,d=(H=f[c][1]).length;u<d;u++)H[u]&&(m+='<span style="color:hsl('+23*u%360+',100%,50%)">&FilledSmallSquare;</span>'+u+":"+H[u]);else m="LODs:"+f[c][0];m+="</div>";break;case"Flux":var q=0,W=0,J=0,Z=0,Y=0,K=0,X=0,Q=0,$=0,ee=0,te=0,re=0,ie=0,ae=0;for(E=e.graphsFluxTextures,N=e.graphsFluxMeshes,x=e.graphsFluxGeodatas,l=0;l<n;l++){var se=E[l][0][0]+N[l][0][0];q=se>q?se:q,q=(se=E[l][1][0]+N[l][1][0])>q?se:q,W=(se=E[l][0][1]+N[l][0][1])>W?se:W,W=(se=E[l][1][1]+N[l][1][1])>W?se:W,J=E[l][0][0]>J?E[l][0][0]:J,Z=E[l][0][1]>Z?E[l][0][1]:Z,Y=E[l][1][0]>Y?E[l][1][0]:Y,K=E[l][1][1]?E[l][1][1]:K,X=N[l][0][0]>X?N[l][0][0]:X,Q=N[l][0][1]>Q?N[l][0][1]:Q,$=N[l][1][0]>$?N[l][1][0]:$,ee=N[l][1][1]>ee?N[l][1][1]:ee,te=x[l][0][0]>te?x[l][0][0]:te,re=x[l][0][1]>re?x[l][0][1]:re,ie=x[l][1][0]>ie?x[l][1][0]:ie,ae=x[l][1][1]>ae?x[l][1][1]:ae}v=(.25*a-2)/q;var ne=(.25*a-2)/W,oe=Math.floor(.25*a),he=Math.floor(.75*a);for(l=0;l<n;l++){c=o+l,c%=n;var le=oe,ue=oe+1,de=he,ce=he+1;s.fillStyle="#0000aa",s.fillRect(l*h,le,1,-E[c][0][0]*v),s.fillRect(l*h,ue,1,E[c][1][0]*v),s.fillRect(l*h,de,1,-E[c][0][1]*ne),s.fillRect(l*h,ce,1,E[c][1][1]*ne),le-=E[c][0][0]*v,ue+=E[c][1][0]*v,de-=E[c][0][1]*ne,ce+=E[c][1][1]*ne,s.fillStyle="#007700",s.fillRect(l*h,le,1,-N[c][0][0]*v),s.fillRect(l*h,ue,1,N[c][1][0]*v),s.fillRect(l*h,de,1,-N[c][0][1]*ne),s.fillRect(l*h,ce,1,N[c][1][1]*ne),le-=N[c][0][0]*v,ue+=N[c][1][0]*v,de-=N[c][0][1]*ne,ce+=N[c][1][1]*ne,s.fillStyle="#009999",s.fillRect(l*h,le,1,-x[c][0][0]*v),s.fillRect(l*h,ue,1,x[c][1][0]*v),s.fillRect(l*h,de,1,-x[c][0][1]*ne),s.fillRect(l*h,ce,1,x[c][1][1]*ne),s.fillStyle="#aaaaaa",s.fillRect(0,Math.floor(.5*a),i,1),s.fillStyle="#dddddd",s.fillRect(0,oe,i,1),s.fillRect(0,he,i,1)}this.showCursor?(m='<span style="color:#007700">&FilledSmallSquare;</span> Textures Count +/-: '+E[c=(this.cursorIndex+o)%n][0][0]+"/"+E[c][1][0],m+=" &nbsp Size +/-: "+(E[c][0][1]/1024/1024).toFixed(2)+"/"+(E[c][1][1]/1024/1024).toFixed(2),m+=' &nbsp <span style="color:#0000aa">&FilledSmallSquare;</span> Meshes Count +/-: '+N[c][0][0]+"/"+N[c][1][0],m+=" &nbsp Size +/-: "+(N[c][0][1]/1024/1024).toFixed(2)+"/"+(N[c][1][1]/1024/1024).toFixed(2),m+=' &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Geodata Count +/-: '+x[c][0][0]+"/"+x[c][1][0],m+=" &nbsp Size +/-: "+(x[c][0][1]/1024/1024).toFixed(2)+"/"+(x[c][1][1]/1024/1024).toFixed(2),m+="</div>"):(m='<span style="color:#007700">&FilledSmallSquare;</span> Textures Count +/-: '+J+"/"+Y,m+=" &nbsp Size +/-: "+(Z/1024/1024).toFixed(2)+"/"+(K/1024/1024).toFixed(2),m+=' &nbsp <span style="color:#0000aa">&FilledSmallSquare;</span> Meshes Count +/-: '+X+"/"+$,m+=" &nbsp Size +/-: "+(Q/1024/1024).toFixed(2)+"/"+(ee/1024/1024).toFixed(2),m+=' &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Geodata Count +/-: '+te+"/"+ie,m+=" &nbsp Size +/-: "+(re/1024/1024).toFixed(2)+"/"+(ae/1024/1024).toFixed(2),m+="</div>")}this.showCursor&&(s.fillStyle="#aa00aa",c=this.cursorIndex%n,s.fillRect(Math.floor(c*h)-1,0,1,a),s.fillRect(Math.floor(c*h)+1,0,1,a)),document.getElementById("vts-graphs-info2").innerHTML=m}};var vi=gi,yi=function(e){this.inspector=e,this.core=e.core};yi.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-layers-panel {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;display: none;padding:15px;font-size: 14px;position: absolute;right: 10px;bottom: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-layers-panel button {max-width: 23px;max-height: 21px;}#vts-layers-panel-title {margin-bottom: 3px;}#vts-layers-views-panel {margin-top: 5px;float: left;}#vts-layers-views-items {width: 191px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;}#vts-layers-surfaces-panel {margin-top: 5px;float: left;}#vts-layers-surfaces-items {width: 150px;overflow-y: scroll;overflow-x: hidden;height: 200px;border-top: 1px solid #ddd;border-bottom: 1px solid #ddd;}#vts-layers-boundlayers-panel {margin-top: 5px;float: left;}#vts-layers-boundlayers-items {width: 275px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;border-right: none;}#vts-layers-freelayers-panel {margin-top: 5px;float: left;}#vts-layers-freelayers-items {width: 150px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;}#vts-layers-fl-properties-panel {margin-top: 5px;float: left;}#vts-layers-fl-properties-items {width: 250px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;border-right: none;}#vts-layers-json-panel {margin-top: 5px;float: right;}#vts-layers-json-text {width: 200px;resize: none;height: 180px;border: 1px solid #ddd;white-space: pre;padding: 0px;}#vts-layers-json-text2 {width: 200px;height: 21px;border: 1px solid #ddd;}.vts-layers-panel-title {margin: 0px;margin-bottom: 5px;}.vts-layers-item {width: 100%;}.vts-layers-item input[type=number]{width: 43px;}.vts-layers-name {width: 120px;display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}.vts-layers-name2 {width: 126px;display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}#vts-layers-fl-properties-style {width: 175px;height: 21px;}.vts-surface-item {width: 100%;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}'),this.element=document.createElement("div"),this.element.id="vts-layers-panel",this.element.innerHTML='<div id="vts-layers-views-panel"><p class="vts-layers-panel-title">Named Views:</p><div id="vts-layers-views-items"></div></div><div id="vts-layers-surfaces-panel"><p class="vts-layers-panel-title">Surfaces:</p><div id="vts-layers-surfaces-items"></div></div><div id="vts-layers-boundlayers-panel"><p class="vts-layers-panel-title">Surface Bound Layers:</p><div id="vts-layers-boundlayers-items"></div></div><div id="vts-layers-freelayers-panel"><p class="vts-layers-panel-title">Free Layers:</p><div id="vts-layers-freelayers-items"></div></div><div id="vts-layers-fl-properties-panel"><p class="vts-layers-panel-title">Free Layer Properties:</p><div id="vts-layers-fl-properties-items"></div></div><div id="vts-layers-json-panel"><p class="vts-layers-panel-title">Definition:</p><textarea id="vts-layers-json-text" cols="48"></textarea><br/><input id="vts-layers-json-text2" type="text"></div>',this.core.element.appendChild(this.element),this.viewItems=document.getElementById("vts-layers-views-items"),this.surfacesItems=document.getElementById("vts-layers-surfaces-items"),this.boundLayersItems=document.getElementById("vts-layers-boundlayers-items"),this.freeLayersItems=document.getElementById("vts-layers-freelayers-items"),this.freeLayersPropertiesItems=document.getElementById("vts-layers-fl-properties-items"),this.jsonText=document.getElementById("vts-layers-json-text"),this.jsonText2=document.getElementById("vts-layers-json-text2"),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.views=[],this.panelVisible=!1,this.panelInitialized=!1,this.currentView="",this.currentSurface="",this.currentFreeLayer=""},yi.prototype.initViews=function(){var e=this.core.getMap();if(e){var t,r,i,a,s,n,o,h,l,u,d,c=e.getNamedViews(),p="--initial--";for(this.views[p]={surfaces:{},freeLayers:{},options:{},original:JSON.parse(JSON.stringify(e.getView()))},r=0,i=c.length;r<i;r++)l=c[r],this.views[l]={surfaces:{},freeLayers:{},options:{},original:JSON.parse(JSON.stringify(e.getNamedView(l).getInfo()))};for(var f in this.currentView=p,c=this.views){for(l=c[f],r=0,i=(u=e.getSurfaces()).length;r<i;r++){for(p=u[r],y=e.getSurface(p),o=[],a=0,s=(n=e.getBoundLayers()).length;a<s;a++)o.push({id:n[a],alpha:100,options:"{}",enabled:!1});l.surfaces[p]={enabled:!1,layers:o}}var m=e.getFreeLayers();for(r=0,i=m.length;r<i;r++){for(p=m[r],o=[],a=0,s=(n=e.getBoundLayers()).length;a<s;a++)o.push({id:n[a],alpha:100,options:"{}",enabled:!1});var g=(t=e.getFreeLayer(p)).getInfo();l.freeLayers[p]={enabled:!1,style:null,originalStyle:g.style,depthShift:0,depthShift2:0,depthShift3:0,layers:o}}var v=l.original.surfaces;for(d in v)if(n=v[d],l.surfaces[d]){var y=l.surfaces[d];for(y.enabled=!0,r=0,i=n.length;r<i;r++)"string"==typeof n[r]?-1!=(h=this.findIdInArray(y.layers,n[r]))&&y.layers[h]&&(y.layers[h].enabled=!0,y.layers.splice(r,0,y.layers.splice(h,1)[0])):(p=n[r].id,-1!=(h=this.findIdInArray(y.layers,p))&&y.layers[h]&&(y.layers[h].enabled=!0,y.layers[h].alpha=n[r].alpha?100*parseFloat(n[r].alpha):100,y.layers[h].options=n[r].options?JSON.stringify(n[r].options):"{}",y.layers.splice(r,0,y.layers.splice(h,1)[0])))}var b=l.original.freeLayers;for(d in b){var x=b[d];if(l.freeLayers[d]){(t=l.freeLayers[d]).enabled=!0;var S=x.depthOffset||[0,0,0];for(t.depthShift=S[0],t.depthShift2=S[1],t.depthShift3=S[2],t.style=x.style,r=0,i=(n=x.boundLayers||[]).length;r<i;r++)"string"==typeof n[r]?-1!=(h=this.findIdInArray(t.layers,n[r]))&&t.layers[h]&&(t.layers[h].enabled=!0,t.layers.splice(r,0,t.layers.splice(h,1)[0])):(p=n[r].id,-1!=(h=this.findIdInArray(t.layers,p))&&y.layers[h]&&(t.layers[h].enabled=!0,t.layers[h].alpha=n[r].alpha?100*parseFloat(n[r].alpha):100,t.layers[h].options=n[r].options?JSON.stringify(n[r].options):"{}",t.layers.splice(r,0,y.layers.splice(h,1)[0])))}}}}},yi.prototype.findIdInArray=function(e,t){for(var r=0,i=e.length;r<i;r++)if(e[r].id==t)return r;return-1},yi.prototype.buildViews=function(){if(this.core.getMap()){var e=this.views,t="";for(var r in e)t+='<div class="vts-views-item" id="vts-views-item-'+r+'"><div class="vts-layers-name2">'+r+'</div><button id="vts-views-cbutton-'+r+'" type="button" title="Clone">C</button><button id="vts-views-xbutton-'+r+'" type="button" title="Remove">X</button></div>';for(r in this.viewItems.innerHTML=t,e){i="vts-views-cbutton-"+r,document.getElementById(i).onclick=this.switchView.bind(this,r,i,"clone"),i="vts-views-xbutton-"+r,document.getElementById(i).onclick=this.switchView.bind(this,r,i,"remove");var i="vts-views-item-"+r;document.getElementById(i).onclick=this.selectView.bind(this,r)}}},yi.prototype.buildSurfaces=function(){var e,t,r=this.views[this.currentView].surfaces,i="",a=null;for(t in r)i+='<div id="vts-surface-item-'+t+'" class="vts-surface-item"><input id="vts-surface-checkbox-'+t+'" type="checkbox"/><span title='+t+">"+t+"</span></div>",null===a&&(a=t);for(t in this.surfacesItems.innerHTML=i,this.currentSurface=a,r)r[t].enabled&&(e="vts-surface-checkbox-"+t,document.getElementById(e).checked=!0);for(t in r)e="vts-surface-checkbox-"+t,document.getElementById(e).onchange=this.switchSurface.bind(this,t,e),e="vts-surface-item-"+t,document.getElementById(e).onclick=this.selectSurface.bind(this,t)},yi.prototype.buildBoundLayers=function(e){var t=this.views[this.currentView],r="";if(t.surfaces[e])for(var i=t.surfaces[e].layers,a=0,s=i.length;a<s;a++){var n=i[a];r+='<div class="vts-layers-item"><input id="vts-boundlayer-checkbox-'+n.id+'" type="checkbox" '+(n.enabled?"checked":"")+'/><div class="vts-layers-name">'+n.id+'</div><input id="vts-boundlayer-spinner-'+n.id+'" type="number" title="Alpha" min="0" max="100" step="10" value="'+n.alpha+'"><button id="vts-boundlayer-obutton-'+n.id+'" type="button" title="Options">O</button><button id="vts-boundlayer-ubutton-'+n.id+'" type="button" title="Move Above">&uarr;</button><button id="vts-boundlayer-dbutton-'+n.id+'" type="button" title="Move Bellow">&darr;</button></div>'}if(this.boundLayersItems.innerHTML=r,t.surfaces[e])for(a=0,s=i.length;a<s;a++){var o="vts-boundlayer-checkbox-"+i[a].id;document.getElementById(o).onchange=this.switchBoundLayer.bind(this,i[a].id,o,"enable"),o="vts-boundlayer-spinner-"+i[a].id,document.getElementById(o).onchange=this.switchBoundLayer.bind(this,i[a].id,o,"alpha"),o="vts-boundlayer-obutton-"+i[a].id,document.getElementById(o).onclick=this.switchBoundLayer.bind(this,i[a].id,o,"options"),o="vts-boundlayer-ubutton-"+i[a].id,document.getElementById(o).onclick=this.switchBoundLayer.bind(this,i[a].id,o,"up"),o="vts-boundlayer-dbutton-"+i[a].id,document.getElementById(o).onclick=this.switchBoundLayer.bind(this,i[a].id,o,"down")}},yi.prototype.buildFreeLayers=function(){var e=this.views[this.currentView].freeLayers,t="";for(var r in e)t+='<div class="vts-surface-item" id="vts-freelayer-item-'+r+'"><input id="vts-freelayer-checkbox-'+r+'" type="checkbox" '+(e[r].enabled?"checked":"")+"/><span title="+r+">"+r+"</span></div>";for(r in this.freeLayersItems.innerHTML=t,e){var i="vts-freelayer-checkbox-"+r;document.getElementById(i).onchange=this.switchFreeLayer.bind(this,r,i),i="vts-freelayer-item-"+r,document.getElementById(i).onclick=this.selectFreeLayer.bind(this,r)}},yi.prototype.buildFreeLayerProperties=function(e){var t,r,i,a=this.core.getMap(),s=this.views[this.currentView],n=s.freeLayers[e].layers,o="";if(a&&a.getFreeLayer(e))switch(a.getFreeLayer(e).getInfo().type){case"mesh":case"mesh-tiles":for(o+='<div class="vts-layers-item"><div class="vts-layers-name" style="width:90px">DepthOffset:</div><input id="vts-fl-properties-depth-shift" type="number" min="-100" max="100" step="1" value="'+s.freeLayers[e].depthShift+'"><input id="vts-fl-properties-depth-shift2" type="number" min="-100" max="100" step="1" value="'+s.freeLayers[e].depthShift2+'"><input id="vts-fl-properties-depth-shift3" type="number" min="-100" max="100" step="1" value="'+s.freeLayers[e].depthShift3+'"></div>',o+='<div class="vts-layers-item"><div class="vts-layers-name">BoundLayers:</div></div>',t=0,r=n.length;t<r;t++){var h=n[t];o+='<div class="vts-layers-item"><input id="vts-fl-properties-checkbox-'+h.id+'" type="checkbox" '+(h.enabled?"checked":"")+'/><div class="vts-layers-name">'+h.id+'</div><input id="vts-fl-properties-spinner-'+h.id+'" type="number" title="Alpha" min="0" max="100" step="10" value="'+h.alpha+'"><button id="vts-fl-properties-ubutton-'+h.id+'" type="button" title="Move Above">&uarr;</button><button id="vts-fl-properties-dbutton-'+h.id+'" type="button" title="Move Bellow">&darr;</button></div>'}for(this.freeLayersPropertiesItems.innerHTML=o,i="vts-fl-properties-depth-shift",document.getElementById(i).onchange=this.switchFreeLayerProperty.bind(this,i,"depthShift"),i="vts-fl-properties-depth-shift2",document.getElementById(i).onchange=this.switchFreeLayerProperty.bind(this,i,"depthShift2"),i="vts-fl-properties-depth-shift3",document.getElementById(i).onchange=this.switchFreeLayerProperty.bind(this,i,"depthShift3"),t=0,r=n.length;t<r;t++)i="vts-fl-properties-checkbox-"+n[t].id,document.getElementById(i).onchange=this.switchFreeLayerBoundLayer.bind(this,n[t].id,i,"enable"),i="vts-fl-properties-spinner-"+n[t].id,document.getElementById(i).onchange=this.switchFreeLayerBoundLayer.bind(this,n[t].id,i,"alpha"),i="vts-fl-properties-ubutton-"+n[t].id,document.getElementById(i).onclick=this.switchFreeLayerBoundLayer.bind(this,n[t].id,i,"up"),i="vts-fl-properties-dbutton-"+n[t].id,document.getElementById(i).onclick=this.switchFreeLayerBoundLayer.bind(this,n[t].id,i,"down");break;case"geodata":case"geodata-tiles":o+='<div class="vts-layers-item"><div class="vts-layers-name" style="width:50px">Style:</div><select id="vts-layers-fl-properties-style">';var l=a.getStylesheets(),u=l.indexOf(s.freeLayers[e].style||s.freeLayers[e].originalStyle);for(t=0,r=l.length;t<r;t++)o+='<option value="'+l[t]+'" '+(t==u?"selected":"")+">"+l[t]+"</option>";o+="</select></div>",this.freeLayersPropertiesItems.innerHTML=o,i="vts-layers-fl-properties-style",document.getElementById(i).onchange=this.switchFreeLayerProperty.bind(this,i,"style")}},yi.prototype.selectView=function(e){var t;this.views[e]&&(this.currentView&&(t=document.getElementById("vts-views-item-"+this.currentView))&&(t.style.backgroundColor="initial"),(t=document.getElementById("vts-views-item-"+e)).style.backgroundColor="#ddd",this.currentView=e,this.buildSurfaces(),this.selectSurface(this.currentSurface),this.buildFreeLayers(),this.applyMapView())},yi.prototype.switchView=function(e,t,r){var i=this.views;for(var a in this.views)if(a==e){switch(r){case"clone":for(var s=2;;){if(!i[e+" #"+s]){i[e+" #"+s]=JSON.parse(JSON.stringify(i[e]));break}s++}this.buildViews();break;case"remove":var n=0;for(a in i)n++;if(n>1)if(delete i[e],this.buildViews(),this.currentView==e)for(a in i){this.selectView(a);break}else this.selectView(this.currentView)}break}},yi.prototype.switchSurface=function(e,t){var r=document.getElementById(t);this.views[this.currentView].surfaces[e].enabled=r.checked,this.applyMapView()},yi.prototype.selectSurface=function(e){var t;this.currentSurface&&((t=document.getElementById("vts-surface-item-"+this.currentSurface)).style.backgroundColor="initial"),(t=document.getElementById("vts-surface-item-"+e))&&(t.style.backgroundColor="#ddd"),this.currentSurface=e,this.buildBoundLayers(this.currentSurface)},yi.prototype.switchBoundLayer=function(e,t,r){for(var i=document.getElementById(t),a=this.views[this.currentView].surfaces[this.currentSurface].layers,s=0,n=a.length;s<n;s++)if(a[s].id==e){switch(r){case"enable":a[s].enabled=i.checked;break;case"alpha":a[s].alpha=parseInt(i.value,10);break;case"options":break;case"up":a.splice(Math.max(0,s-1),0,a.splice(s,1)[0]),this.selectSurface(this.currentSurface);break;case"down":a.splice(Math.max(0,s+1),0,a.splice(s,1)[0]),this.selectSurface(this.currentSurface)}break}this.applyMapView()},yi.prototype.switchFreeLayer=function(e,t){var r=document.getElementById(t);this.views[this.currentView].freeLayers[e].enabled=r.checked,this.applyMapView()},yi.prototype.selectFreeLayer=function(e){this.currentFreeLayer&&(document.getElementById("vts-freelayer-item-"+this.currentFreeLayer).style.backgroundColor="initial"),document.getElementById("vts-freelayer-item-"+e).style.backgroundColor="#ddd",this.currentFreeLayer=e,this.buildFreeLayerProperties(this.currentFreeLayer)},yi.prototype.switchFreeLayerBoundLayer=function(e,t,r){for(var i=document.getElementById(t),a=this.views[this.currentView].freeLayers[this.currentFreeLayer].layers,s=0,n=a.length;s<n;s++)if(a[s].id==e){switch(r){case"enable":a[s].enabled=i.checked;break;case"alpha":a[s].alpha=parseInt(i.value,10);break;case"up":a.splice(Math.max(0,s-1),0,a.splice(s,1)[0]),this.selectFreeLayer(this.currentFreeLayer);break;case"down":a.splice(Math.max(0,s+1),0,a.splice(s,1)[0]),this.selectFreeLayer(this.currentFreeLayer)}break}this.applyMapView()},yi.prototype.switchFreeLayerProperty=function(e,t){var r=document.getElementById(e),i=this.views[this.currentView].freeLayers[this.currentFreeLayer];switch(t){case"depthShift":i.depthShift=parseInt(r.value,10);break;case"depthShift2":i.depthShift2=parseInt(r.value,10);break;case"depthShift3":i.depthShift3=parseInt(r.value,10);break;case"style":i.style=r.value}this.applyMapView()},yi.prototype.applyMapView=function(e){var t,r,i,a={surfaces:{},freeLayers:{},options:{}},s=this.views[this.currentView],n=s.surfaces;for(var o in a.options=JSON.parse(JSON.stringify(s.options)),n)if(n[o].enabled){var h=[];for(t=0,r=(i=n[o].layers).length;t<r;t++)if(i[t].enabled){var l=JSON.parse(JSON.stringify(i[t].options)),u=JSON.stringify(l);if(i[t].alpha<100){var d={id:i[t].id,alpha:(.01*i[t].alpha).toFixed(2)};"{}"!=u&&(d.options=l),h.push(d)}else h.push(i[t].id)}a.surfaces[o]=h}var c=s.freeLayers;for(o in c)if(c[o].enabled){var p=[];for(t=0,r=(i=c[o].layers).length;t<r;t++)if(i[t].enabled)if(i[t].alpha<100){d={id:i[t].id,alpha:(.01*i[t].alpha).toFixed(2)};"{}"!=u&&(d.options=l),p.push(d)}else p.push(i[t].id);a.freeLayers[o]={},p.length>0&&(a.freeLayers[o].boundLayers=p),c[o].style&&c[o].style!=c[o].originalStyle&&(a.freeLayers[o].style=c[o].style),0==c[o].depthShift&&0==c[o].depthShift2&&0==c[o].depthShift3||(a.freeLayers[o].depthOffset=[parseFloat(c[o].depthShift.toFixed(2)),parseFloat(c[o].depthShift2.toFixed(2)),parseFloat(c[o].depthShift3.toFixed(2))])}if(this.jsonText.value=JSON.stringify(a,null,"  "),this.jsonText2.value=encodeURIComponent(JSON.stringify(a)),!e){var f=this.core.getMap();if(!f)return;f.setView(a,null,!0)}},yi.prototype.showPanel=function(){this.element.style.display="block",this.panelVisible=!0,this.updatePanel()},yi.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},yi.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},yi.prototype.updatePanel=function(){this.panelInitialized||(this.panelInitialized=!1,this.initViews(),this.buildViews(),this.selectView(this.currentView))};var bi=yi,xi=p.a,Si=c,Mi=a.d,wi=a.b,Ti=function(e){this.inspector=e,this.core=e.core};Ti.prototype.init=function(){var e=this.inspector;e.addStyle("#vts-replay-panel {font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;display: none;padding:15px;width: 618px;font-size: 14px;position: absolute;right: 10px;top: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-replay-panel-left {width: 253px;height: 100%;float: left;}#vts-replay-panel-right {width: 340px;height: 100%;float: right;}#vts-replay-items {width: 240px;overflow-x: hidden;border: 1px solid #ddd;padding-right: 5px;}.vts-replay-item {width: 100%;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}#vts-replay-lod-slider {width: 240px;}#vts-replay-lod-text {width: 60px;margin-left: 10px;margin-right: 10px;}#vts-replay-lod-single {margin-left: 10px;}#vts-replay-time-slider {width: 330px;}#vts-replay-time-text {width: 60px;margin-left: 10px;margin-right: 10px;}#vts-replay-time-single {margin-left: 10px;}#vts-replay-panel-gtime canvas{border: 1px solid #555;}#vts-replay-panel-gtime span{font-size: 10px;}#vts-replay-info {width: 240px;height: 140px;overflow-x: hidden;border: 1px solid #ddd;padding-right: 5px;margin-top: 10px;font-size: 12px;word-wrap: break-word;}"),this.element=document.createElement("div"),this.element.id="vts-replay-panel",this.element.innerHTML='<div id="vts-replay-panel-left"><div id="vts-replay-items"></div><div id="vts-replay-panel-lod"><input id="vts-replay-lod-slider" type="range" min="0" max="30" step="1" value="30" /><br/><span>LOD:</span><input id="vts-replay-lod-text" type="text" value="30"/><input id="vts-replay-lod-up" type="button" value="<"/><input id="vts-replay-lod-down" type="button" value=">"/><input id="vts-replay-lod-single" type="checkbox"/><span>Single</span></div><div id="vts-replay-info"></div></div><div id="vts-replay-panel-right"><div id="vts-replay-panel-gtime"><span id="vts-replay-info-meshes">Meshes Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-meshes" width=340 height=30></canvas><br/><span id="vts-replay-info-textures">Internal Textures Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-textures" width=340 height=30></canvas><br/><span id="vts-replay-info-textures2">External Textures Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-textures2" width=340 height=30></canvas><br/><span id="vts-replay-info-geodata">Geodata Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-geodata" width=340 height=30></canvas><br/><span id="vts-replay-info-metatiles">Metatiles Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-metatiles" width=340 height=30></canvas><br/><span id="vts-replay-info-intervals">Interval Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-intervals" width=340 height=30></canvas><br/><span id="vts-replay-info-threads">Threads Min/Max: 0/0 Avg. 0 </span><br/><canvas id="vts-replay-canvas-threads" width=340 height=30></canvas><br/></div><div id="vts-replay-panel-time"><input id="vts-replay-time-slider" type="range" min="0" max="2000" value="0" /><br/><span>File:</span><input id="vts-replay-time-text" type="text" value="0"/><input id="vts-replay-time-up" type="button" value="<"/><input id="vts-replay-time-down" type="button" value=">"/><input id="vts-replay-time-single" type="checkbox"/><span>Single</span></div></div>',this.core.element.appendChild(this.element),this.items=document.getElementById("vts-replay-items"),this.lodSlider=document.getElementById("vts-replay-lod-slider"),this.lodSlider.onchange=this.onSliderChange.bind(this,"lod"),this.lodSlider.oninput=this.onSliderChange.bind(this,"lod"),this.lodText=document.getElementById("vts-replay-lod-text"),this.lodText.onchange=this.onTextChange.bind(this,"lod"),document.getElementById("vts-replay-lod-up").onclick=this.onSliderChange.bind(this,"lod","down"),document.getElementById("vts-replay-lod-down").onclick=this.onSliderChange.bind(this,"lod","up"),document.getElementById("vts-replay-lod-single").onclick=this.onSliderChange.bind(this,"lod","single"),this.timeSlider=document.getElementById("vts-replay-time-slider"),this.timeSlider.onchange=this.onSliderChange.bind(this,"time"),this.timeSlider.oninput=this.onSliderChange.bind(this,"time"),this.timeText=document.getElementById("vts-replay-time-text"),this.timeText.onchange=this.onTextChange.bind(this,"time"),this.timeInfo=document.getElementById("vts-replay-info"),document.getElementById("vts-replay-time-up").onclick=this.onSliderChange.bind(this,"time","down"),document.getElementById("vts-replay-time-down").onclick=this.onSliderChange.bind(this,"time","up"),document.getElementById("vts-replay-time-single").onclick=this.onSliderChange.bind(this,"time","single"),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.infoMeshes=document.getElementById("vts-replay-info-meshes"),this.ctxMeshes=document.getElementById("vts-replay-canvas-meshes").getContext("2d"),this.infoTextures=document.getElementById("vts-replay-info-textures"),this.ctxTextures=document.getElementById("vts-replay-canvas-textures").getContext("2d"),this.infoTextures2=document.getElementById("vts-replay-info-textures2"),this.ctxTextures2=document.getElementById("vts-replay-canvas-textures2").getContext("2d"),this.infoGeodata=document.getElementById("vts-replay-info-geodata"),this.ctxGeodata=document.getElementById("vts-replay-canvas-geodata").getContext("2d"),this.infoMetatiles=document.getElementById("vts-replay-info-metatiles"),this.ctxMetatiles=document.getElementById("vts-replay-canvas-metatiles").getContext("2d"),this.infoIntervals=document.getElementById("vts-replay-info-intervals"),this.ctxIntervals=document.getElementById("vts-replay-canvas-intervals").getContext("2d"),this.infoThreads=document.getElementById("vts-replay-info-threads"),this.ctxThreads=document.getElementById("vts-replay-canvas-threads").getContext("2d"),this.cameraLines=[],this.cameraLines2=[],this.cameraLines3=[],this.cameraGenarated=!1,this.panelVisible=!1},Ti.prototype.showPanel=function(){this.buildReplayCombo(),this.element.style.display="block",this.panelVisible=!0;var e=this.core.getMap();if(e){var t=e.draw.replay;this.updateFileInfo(t.loadedIndex),this.updateLoadGraphs()}},Ti.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},Ti.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},Ti.prototype.onSliderChange=function(e,t){if("lod"==e)switch(t){case"up":this.lodSlider.stepUp(),this.lodText.value=this.lodSlider.value;break;case"down":this.lodSlider.stepDown(),this.lodText.value=this.lodSlider.value;break;default:this.lodText.value=this.lodSlider.value}else switch(t){case"up":this.timeSlider.stepUp(),this.timeText.value=this.timeSlider.value;break;case"down":this.timeSlider.stepDown(),this.timeText.value=this.timeSlider.value;break;default:this.timeText.value=this.timeSlider.value}var r=this.core.getMap();if(r){var i=r.draw.replay;"lod"==e?(i.lod=parseFloat(this.lodText.value),i.singleLod=document.getElementById("vts-replay-lod-single").checked):(i.loadedIndex=parseFloat(this.timeText.value),i.singleLodedIndex=document.getElementById("vts-replay-time-single").checked,this.updateFileInfo(i.loadedIndex),this.updateLoadGraphs()),r.markDirty()}},Ti.prototype.onTextChange=function(e){"lod"==e?this.lodSlider.value=this.lodText.value:this.timeSlider.value=this.timeText.value;var t=this.core.getMap();if(t){var r=t.draw.replay;"lod"==e?r.lod=parseFloat(this.lodText.value):(r.loadedIndex=parseFloat(this.timeText.value),this.updateFileInfo(r.loadedIndex),this.updateLoadGraphs()),t.markDirty()}},Ti.prototype.generateCameraLines=function(e){var t=this.core.getRendererInterface(),r=e.position,i=e.center;this.cameraLines=[r,i],this.cameraLines2=[[r],[r],[r],[r]];var a=16,s=this.core.getMap(),n=s.camera.getRotationviewMatrix(),o=wi.create();wi.inverse(n,o),this.cameraMatrix=o;for(var h,l,u,d,c=Math.tan(xi.radians(s.camera.getFov())),p=c*s.camera.getAspect(),f=Math.sqrt(c*c+p*p),m=Math.atan(f/1),g=e.cameraDistance/a,v=.5*g*Math.tan(m),y=v*s.camera.getAspect(),b=0;b<a;b++)h=[-y,-v,-g],l=[y,-v,-g],u=[y,v,-g],d=[-y,v,-g],Mi.scale(h,b+1),Mi.scale(l,b+1),Mi.scale(u,b+1),Mi.scale(d,b+1),wi.multiplyVec3(o,h),wi.multiplyVec3(o,l),wi.multiplyVec3(o,u),wi.multiplyVec3(o,d),Mi.add(h,r),Mi.add(l,r),Mi.add(u,r),Mi.add(d,r),this.cameraLines2[0].push(h),this.cameraLines2[1].push(l),this.cameraLines2[2].push(u),this.cameraLines2[3].push(d);for(this.cameraLines3=[[r],[r],[r],[r]],a=256,y=(v=.5*(g=(e.distance+12742e3*1.1)/a)*Math.tan(m))*s.camera.getAspect(),b=0;b<a;b++)h=[-y,-v,-g],l=[y,-v,-g],u=[y,v,-g],d=[-y,v,-g],Mi.scale(h,b+1),Mi.scale(l,b+1),Mi.scale(u,b+1),Mi.scale(d,b+1),wi.multiplyVec3(o,h),wi.multiplyVec3(o,l),wi.multiplyVec3(o,u),wi.multiplyVec3(o,d),Mi.add(h,r),Mi.add(l,r),Mi.add(u,r),Mi.add(d,r),this.cameraLines3[0].push(h),this.cameraLines3[1].push(l),this.cameraLines3[2].push(u),this.cameraLines3[3].push(d);h=[-y,-v,-g],l=[y,-v,-g],u=[y,v,-g],d=[-y,v,-g],Mi.scale(h,a),Mi.scale(l,a),Mi.scale(u,a),Mi.scale(d,a);var x=[(r=[0,0,0])[0],r[1],r[2],h[0],h[1],h[2],l[0],l[1],l[2],r[0],r[1],r[2],l[0],l[1],l[2],u[0],u[1],u[2],r[0],r[1],r[2],u[0],u[1],u[2],d[0],d[1],d[2],r[0],r[1],r[2],d[0],d[1],d[2],h[0],h[1],h[2]];this.frustumState=t.createState({blend:!0,zwrite:!1,ztest:!0,culling:!1}),this.frustumMesh=t.createMesh({vertices:x,uvs:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1]}),this.cameraGenarated=!0},Ti.prototype.itemButton=function(e,t){var r=this.core.getMap();if(r){var i=r.draw.replay;switch(e){case"DrawnTiles":i.storeTiles=!0;break;case"DrawnTilesFreeLayers":i.storeFreeTiles=!0;break;case"TracedNodes":i.storeNodes=!0;break;case"TracedNodesFreeLayers":i.storeFreeNodes=!0;break;case"LoadSequence":i.storeLoaded="S"==t,"S"==t?(i.loadedIndex=0,i.loaded=[]):(this.updateFileInfo(i.loadedIndex),this.updateLoadGraphs());break;case"Camera":if("S"==t){var a=i.camera={distance:r.camera.distance,position:r.camera.position.slice(),vector:r.camera.vector.slice(),center:r.camera.center.slice(),height:r.camera.height};i.cameraPos=r.getPosition(),this.generateCameraLines(a)}else i.cameraPos&&r.setPosition(i.cameraPos)}r.markDirty()}},Ti.prototype.switchItem=function(e,t){var r=document.getElementById(t),i=this.core.getMap();if(i){var a=i.draw.replay;switch(e){case"DrawnTiles":a.drawTiles=r.checked;break;case"DrawnTilesFreeLayers":a.drawFreeTiles=r.checked;break;case"TracedNodes":a.drawNodes=r.checked;break;case"TracedNodesFreeLayers":a.drawFreeNodes=r.checked;break;case"LoadSequence":a.drawLoaded=r.checked;break;case"Camera":this.cameraGenarated||this.itemButton("Camera"),this.drawCamera=r.checked;break;case"Globe":var s=this.core.getRenderer();if(!this.globeTexture){this.globeTexture=new Si(s.gpu,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAEACAMAAADyTj5VAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0Mzk4RkVFMzlGNjUxMUU2OTBDM0I0OEM1NjU0RURBMyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo0Mzk4RkVFNDlGNjUxMUU2OTBDM0I0OEM1NjU0RURBMyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQzOThGRUUxOUY2NTExRTY5MEMzQjQ4QzU2NTRFREEzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjQzOThGRUUyOUY2NTExRTY5MEMzQjQ4QzU2NTRFREEzIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+5rvbhAAAAAZQTFRFwcHBLS0tMDfv/wAAAiZJREFUeNrs2LENAEEIA0HTf9ME5DTgIZn8ta+TnLjymzuW6kMIwIcQgA8hAAqAAmBdAM4O4E/wBPgQAqAAKAAKgAKgHcDZAegJoAAoAAqAAqAAaAdwdgB6AigACoACoAAoANoBnB2AngAKgAKgACgACoB2AGcHoCeAAqAAKAAKgAKgHcDZAegJoAAoAAqAAqAAaAdwdgB6AigACoACoAAoANoBnB2AngAKgAKgACgACoB2AGcHoCeAAqAAKAAKgAKgHcDZAegJoAAoAAqAAqAAaAdwdgB6AigACoACEIAPIQAfwg7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABSAAH0IAPoQAfAgB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQAPxcAQYAZt2IEFFJhxsAAAAASUVORK5CYII=",this.core,null,!0)}this.drawGlobe=r.checked,this.drawGlobe=this.drawGlobe}i.markDirty()}},Ti.prototype.updateLoadGraphs=function(){var e=this.core.getMap();if(e){var t,r=e.draw.replay,i=r.loaded,a=r.loadedIndex;this.timeSlider.max=i.length;var s=340;this.ctxMeshes.fillStyle="#000000",this.ctxMeshes.fillRect(0,0,s,30),this.ctxTextures.fillStyle="#000000",this.ctxTextures.fillRect(0,0,s,30),this.ctxTextures2.fillStyle="#000000",this.ctxTextures2.fillRect(0,0,s,30),this.ctxGeodata.fillStyle="#000000",this.ctxGeodata.fillRect(0,0,s,30),this.ctxMetatiles.fillStyle="#000000",this.ctxMetatiles.fillRect(0,0,s,30),this.ctxIntervals.fillStyle="#000000",this.ctxIntervals.fillRect(0,0,s,30),this.ctxThreads.fillStyle="#000000",this.ctxThreads.fillRect(0,0,s,30);var n,o=Math.floor(r.loadedIndex/s)*s,h=339,l=o;for(o=0;o<h;o++)if(n=i[o+l]){switch(n.kind){case"mesh":t=this.ctxMeshes;break;case"texture-in":t=this.ctxTextures;break;case"texture-ex":t=this.ctxTextures2;break;case"geodata":t=this.ctxGeodata;break;case"metatile":t=this.ctxMetatiles;break;default:continue}var u=Math.round(Math.min(255,60+20*Math.max(1,n.duration/300)));t.fillStyle="rgb("+u+","+u+","+u+")";var d=n.duration/300*30;t.fillRect(o,30,1,-d),u=Math.round(Math.min(255,60+20*Math.max(1,n.interval/300))),this.ctxIntervals.fillStyle="rgb("+u+","+u+","+u+")",d=n.interval/300*30,this.ctxIntervals.fillRect(o,30,1,-d),this.ctxThreads.fillStyle="rgb(80,80,80)",d=n.threads/e.config.mapDownloadThreads*30,this.ctxThreads.fillRect(o,30,1,-d)}var c=Number.MAX_VALUE,p=0,f=0,m=0,g=Number.MAX_VALUE,v=0,y=0,b=0,x=Number.MAX_VALUE,S=0,M=0,w=0,T=Number.MAX_VALUE,A=0,C=0,F=0,P=Number.MAX_VALUE,L=0,E=0,N=0,B=Number.MAX_VALUE,I=0,k=0,R=0,_=Number.MAX_VALUE,z=0,U=0,D=0;for(h=i.length,o=0;o<h;o++)if(n=i[o]){switch(n.kind){case"mesh":n.duration<c&&(c=n.duration),n.duration>p&&(p=n.duration),f+=n.duration,m++;break;case"texture-in":n.duration<g&&(g=n.duration),n.duration>v&&(v=n.duration),y+=n.duration,b++;break;case"texture-ex":n.duration<x&&(x=n.duration),n.duration>S&&(S=n.duration),M+=n.duration,w++;break;case"geodata":n.duration<T&&(T=n.duration),n.duration>A&&(A=n.duration),C+=n.duration,F++;break;case"metatile":n.duration<P&&(P=n.duration),n.duration>L&&(L=n.duration),E+=n.duration,N++;break;default:continue}n.threads<B&&(B=n.threads),n.threads>I&&(I=n.threads),k+=n.threads,R++,n.threads<_&&(_=n.threads),n.threads>z&&(z=n.threads),U+=n.threads,D++}a-=l,this.ctxMeshes.fillStyle="#ff0000",this.ctxMeshes.fillRect(a-1,0,1,30),this.ctxMeshes.fillRect(a+1,0,1,30),this.ctxTextures.fillStyle="#ff0000",this.ctxTextures.fillRect(a-1,0,1,30),this.ctxTextures.fillRect(a+1,0,1,30),this.ctxTextures2.fillStyle="#ff0000",this.ctxTextures2.fillRect(a-1,0,1,30),this.ctxTextures2.fillRect(a+1,0,1,30),this.ctxGeodata.fillStyle="#ff0000",this.ctxGeodata.fillRect(a-1,0,1,30),this.ctxGeodata.fillRect(a+1,0,1,30),this.ctxMetatiles.fillStyle="#ff0000",this.ctxMetatiles.fillRect(a-1,0,1,30),this.ctxMetatiles.fillRect(a+1,0,1,30),this.ctxIntervals.fillStyle="#ff0000",this.ctxIntervals.fillRect(a-1,0,1,30),this.ctxIntervals.fillRect(a+1,0,1,30),this.ctxThreads.fillStyle="#ff0000",this.ctxThreads.fillRect(a-1,0,1,30),this.ctxThreads.fillRect(a+1,0,1,30),m||(c=0,p=0),b||(g=0,v=0),w||(x=0,S=0),F||(T=0,A=0),N||(P=0,L=0),R||(B=0,I=0),D||(_=0,z=0),f=m?f/m:0,y=b?y/b:0,M=w?M/w:0,C=F?C/F:0,E=N?E/N:0,U=D?U/D:0,k=R?k/R:0,this.infoMeshes.innerHTML="Meshes Min/Max/Avg/Count: "+c.toFixed(0)+"/"+p.toFixed(0)+"/"+f.toFixed(1)+"/"+m,this.infoTextures.innerHTML="Internal Textures Min/Max/Avg/Count: "+g.toFixed(0)+"/"+v.toFixed(0)+"/"+y.toFixed(1)+"/"+b,this.infoTextures2.innerHTML="External Textures Min/Max/Avg/Count: "+x.toFixed(0)+"/"+S.toFixed(0)+"/"+M.toFixed(1)+"/"+w,this.infoGeodata.innerHTML="Geodata Min/Max/Avg/Count: "+T.toFixed(0)+"/"+A.toFixed(0)+"/"+C.toFixed(1)+"/"+F,this.infoMetatiles.innerHTML="Metatiles Min/Max/Avg/Count: "+P.toFixed(0)+"/"+L.toFixed(0)+"/"+E.toFixed(1)+"/"+N,this.infoIntervals.innerHTML="Intervals Min/Max/Avg: "+_.toFixed(0)+"/"+z.toFixed(0)+"/"+U.toFixed(1),this.infoThreads.innerHTML="Threads Min/Max/Avg: "+B+"/"+I+"/"+k.toFixed(1)}},Ti.prototype.updateFileInfo=function(e){var t=this.core.getMap();if(t){var r=t.draw.replay.loaded[e];this.timeInfo.innerHTML=r?"Resource Kind: "+r.kind+"<br/>Time: "+r.time.toFixed(2)+"<br/>Duration: "+r.duration.toFixed(2)+"<br/>Interval: "+r.interval.toFixed(2)+"<br/>Priority: "+r.priority.toFixed(2)+"<br/>Threads: "+r.threads+"<br/>"+r.url:""}},Ti.prototype.buildReplayCombo=function(){if(this.core.getMap()){var e,t,r,i=[["Drawn Tiles",1],["Drawn Tiles - Free Layers",1],["Traced Nodes",1],["Traced Nodes - Free Layers",1],["Load Sequence",2],["Camera",2],["Globe",0]],a=["DrawnTiles","DrawnTilesFreeLayers","TracedNodes","TracedNodesFreeLayers","LoadSequence","Camera","Globe"],s="";for(e=0,t=i.length;e<t;e++)s+='<div id="vts-replay-item-'+a[e]+'" class="vts-replay-item"><input id="vts-replay-checkbox-'+a[e]+'" type="checkbox"/><span title='+i[e][0]+">"+i[e][0]+"&nbsp;&nbsp;</span>",i[e][1]>0&&(s+='<input id="vts-replay-sbutton-'+a[e]+'" type="button" value="S"/>'),i[e][1]>1&&(s+='<input id="vts-replay-fbutton-'+a[e]+'" type="button" value="'+("Camera"==a[e]?"R":"F")+'"/>'),s+="</div>";for(this.items.innerHTML=s,e=0,t=i.length;e<t;e++)r="vts-replay-checkbox-"+a[e],document.getElementById(r).onchange=this.switchItem.bind(this,a[e],r),i[e][1]>0&&(r="vts-replay-sbutton-"+a[e],document.getElementById(r).onclick=this.itemButton.bind(this,a[e],"S")),i[e][1]>1&&(r="vts-replay-fbutton-"+a[e],document.getElementById(r).onclick=this.itemButton.bind(this,a[e],"Camera"==a[e]?"R":"F"))}};var Ai=Ti,Ci=function(e){this.inspector=e,this.core=e.core};Ci.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-stylesheets-panel * {all: initial;}#vts-stylesheets-panel {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;display: none;padding:15px;width: 1200px;height: 350px;font-size: 14px;position: absolute;right: 10px;bottom: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-stylesheets-panel-header {width: 100%;height: 28px;}#vts-stylesheets-panel-combo {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 13px;border: 1px solid #a9a9a9;width: 1070px;height: 17px;padding: 2px;margin-bottom: 5px;-webkit-appearance: menulist;-moz-appearance: menulist;}#vts-stylesheets-panel-combo option {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 13px;}#vts-stylesheets-panel-update-button {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 14px;float: right;background-color: #dedede;padding: 3px 2px 2px 2px;border: 1px solid #a0a0a0;border-radius: 2px;margin-right: 5px;}#vts-stylesheets-panel-hide-button {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 14px;float: right;background-color: #dedede;padding: 3px 2px 2px 2px;border: 1px solid #a0a0a0;border-radius: 2px;}#vts-stylesheets-panel-text {font-family: monospace;border: 1px solid #a9a9a9;padding: 2px 0px 0px 2px;width: 100%;height: 300px;resize: none;white-space: pre;}'),this.element=document.createElement("div"),this.element.id="vts-stylesheets-panel",this.element.innerHTML='<div id="vts-stylesheets-panel-header"><select id="vts-stylesheets-panel-combo"></select><button id="vts-stylesheets-panel-hide-button" type="button" title="Hide">Hide</button><button id="vts-stylesheets-panel-update-button" type="button" title="Update">Update</button></div><textarea id="vts-stylesheets-panel-text" rows="4" cols="50">aa\naa\n</textarea>',this.core.element.appendChild(this.element),this.optionsElement=document.getElementById("vts-stylesheets-panel-combo"),this.optionsElement.onchange=this.onComboSwitched.bind(this),this.textElement=document.getElementById("vts-stylesheets-panel-text"),document.getElementById("vts-stylesheets-panel-update-button").onclick=this.onUpdate.bind(this),document.getElementById("vts-stylesheets-panel-hide-button").onclick=this.hidePanel.bind(this),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.textElement.addEventListener("keyup",e.doNothing.bind(this),!1),this.textElement.addEventListener("keydown",e.doNothing.bind(this),!1),this.panelVisible=!1},Ci.prototype.showPanel=function(){this.buildStylesheetsCombo(),this.element.style.display="block",this.panelVisible=!0},Ci.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},Ci.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},Ci.prototype.onComboSwitched=function(){var e=this.core.getMap();if(e){var t=e.getStylesheet(this.optionsElement.value);this.textElement.value=this.niceStyleFormat(t)}},Ci.prototype.onUpdate=function(){var e=this.core.getMap();e&&e.setStylesheetData(this.optionsElement.value,JSON.parse(this.textElement.value))},Ci.prototype.niceStyleFormat=function(e){if(!e||!e.data)return"";var t="";t+="{\n";var r=[];(e=e.data).constants&&r.push("constants"),e.bitmaps&&r.push("bitmaps"),e.fonts&&r.push("fonts"),e.layers&&r.push("layers");for(var i=0,a=r.length;i<a;i++){var s=r[i];t+='  "'+s+'": {\n';var n=e[s],o=[];for(var h in n)o.push(h);for(var l=0,u=o.length;l<u;l++)if("layers"==s){var d=n[o[l]],c=[];for(var p in d)c.push(p);t+='    "'+o[l]+'": {\n';for(var f=0,m=c.length;f<m;f++)t+='      "'+c[f]+'": '+JSON.stringify(d[c[f]])+(f==m-1?"":",")+"\n";t+="    }"+(l==u-1?"":",\n")}else t+='    "'+o[l]+'": '+JSON.stringify(n[o[l]])+(l==u-1?"":",")+"\n";t+="\n  }"+(i==a-1?"":",\n")}return t+="\n}"},Ci.prototype.buildStylesheetsCombo=function(){var e=this.core.getMap();if(e){for(var t="",r=e.getStylesheets(),i=0,a=r.length;i<a;i++)t+='<option value="'+r[i]+'">'+r[i]+"</option>";this.optionsElement.innerHTML=t;var s=e.getStylesheet(r[0]);this.textElement.value=this.niceStyleFormat(s)}};var Fi=Ci,Pi=a.b,Li=p.a,Ei=s.a,Ni=pi,Bi=mi,Ii=vi,ki=bi,Ri=Ai,_i=Fi,zi=function(e){this.core=e,this.enabled=!1,this.input=new Ni(this),this.stats=new Bi(this),this.graphs=new Ii(this),this.layers=new ki(this),this.replay=new Ri(this),this.stylesheets=new _i(this),this.core.config.inspector&&this.input.init(),this.shakeCamera=!1,this.drawReplayCamera=!1,this.drawRadar=!1,this.radarLod=null,this.debugValue=0,this.measureMode=!1,this.measurePoints=[]};zi.prototype.enableInspector=function(){this.enabled||(this.stats.init(),this.graphs.init(),this.layers.init(),this.replay.init(),this.stylesheets.init(),this.circleImage||(this.circleImage=Ei.loadImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAAAAAAAD5Q7t/AAAACW9GRnMAAAAgAAAA4ACD+EAUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVRYw+2VPwqDMBTG3dz1Am56EnH2XLroETxGuwc3Z7cOdhY8QJpfSUBspUvStJAPPggvD973/uQligICAgL+DKViqygUV02hbaXLwJlio7gpyhNu2idzEXwwgfI8H+u6vnZdN/V9P3EuimLcCRlsiyArGcfxjWDLsmzyAGzc4aNFNDZ7/iw7AeQH4LNrh5WZYLgkJTaZCyHuVVVdkiSZ0zSdOWMzlaBFWkRrQ4A4Zk/A4wBie1MFYUMAz0wybCYAmR8FUAlzj6+2r18TgM2VAO8tOB1Cyk7mrofQ+zP0voheVjHtIBjDxjrmvCu7k1Xs/TP6ie84ICDAGR5uCYdPo0MWiAAAAABJRU5ErkJggg==",function(){this.circleTexture=this.core.getRendererInterface().createTexture({source:this.circleImage})}.bind(this))),this.core.on("map-update",this.onMapUpdate.bind(this)),this.enabled=!0)},zi.prototype.setParameter=function(e,t){this.input.setParameter(e,t)},zi.prototype.addStyle=function(e){var t=document.createElement("style");t.type="text/css",t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)},zi.prototype.doNothing=function(e){return e.stopPropagation(),!1},zi.prototype.preventDefault=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},zi.prototype.onMapUpdate=function(){var e=this.core.getMapInterface();if(e){this.shakeCamera&&e.redraw();var t,r,i,a,s,n,o,h=this.core.getRendererInterface();if(this.replay.drawGlobe){o=e.convertCoordsFromPhysToCameraSpace([0,0,0]);var l=this.core.getRenderer();l.draw.drawTBall(o,6371e3,l.progStardome,this.replay.globeTexture,6371e3,!0)}if(this.replay.drawCamera){for(s=this.replay.cameraLines,n=[],h.drawLineString({points:s,size:2,color:[0,128,255,255],depthTest:!1,screenSpace:!1,blend:!1}),t=0,r=(s=this.replay.cameraLines3).length;t<r;t++){for(n=[],i=0,a=s[t].length;i<a;i++)n.push(s[t][i]);h.drawLineString({points:n,size:2,color:[0,255,128,255],depthTest:!1,screenSpace:!1,blend:!1})}for(t=0,r=(s=this.replay.cameraLines2).length;t<r;t++){for(n=[],i=0,a=s[t].length;i<a;i++)n.push(s[t][i]);h.drawLineString({points:n,size:2,color:[0,255,255,255],depthTest:!1,screenSpace:!1,blend:!1})}var u=e.getCameraInfo(),d=e.convertCoordsFromPhysToCameraSpace(this.replay.cameraLines[0]),c=Pi.create(this.replay.cameraMatrix);c[12]=d[0],c[13]=d[1],c[14]=d[2];Pi.multiply(u.viewMatrix,c,c);var p=[0,0,0,0,0,0,0,0,0];Pi.toInverseMat3(c,p),h.setState(this.replay.frustumState),h.drawMesh({mesh:this.replay.frustumMesh,texture:null,shader:"shaded",shaderVariables:{uMV:["mat4",c],uNorm:["mat3",p],uMaterial:["mat4",[255,128,128,0,0,0,0,0,0,0,0,0,0,.5,0,0]]}})}if(this.drawRadar&&this.circleTexture){var f=e.getPosition(),m=f.getViewExtent()/64,g=new Array(256);for(i=0;i<16;i++)for(t=0;t<16;t++){var v=t*m-8*m,y=i*m-8*m,b=Math.atan2(y,v),x=Math.sqrt(v*v+y*y),S=e.movePositionCoordsTo(f,Li.degrees(b),x).getCoords(),M=e.convertCoordsFromNavToCanvas([S[0],S[1],0],"float",this.radarLod);g[16*i+t]=M}var w=new Array(16);for(i=0;i<16;i++){for(t=0;t<16;t++)w[t]=g[16*i+t];h.drawLineString({points:w,size:2,screenSpace:!0,color:[0,255,255,255],depthTest:!1,blend:!1})}for(t=0;t<16;t++){for(i=0;i<16;i++)w[i]=g[16*i+t];h.drawLineString({points:w,size:2,screenSpace:!0,color:[0,255,255,255],depthTest:!1,blend:!1})}for(t=0,r=g.length;t<r;t++)o=g[t],h.drawImage({rect:[o[0]-10,o[1]-10,20,20],texture:this.circleTexture,color:[255,0,255,255],depth:o[2],depthTest:!1,blend:!0})}}};var Ui=zi,Di=function(e,t,r,i,a,s){this.renderer=e,this.div=t,this.canvas=null,this.curSize=r,this.currentProgram=null,this.maxAttributesCount=8,this.newAttributes=new Uint8Array(this.maxAttributesCount),this.enabledAttributes=new Uint8Array(this.maxAttributesCount),this.noTextures=!1,this.barycentricBuffer=null,this.defaultState=this.createState({blend:!1,stencil:!1,zequal:!1,ztest:!1,zwrite:!1,culling:!1}),this.currentState=this.defaultState,this.currentOffset=0,this.keepFrameBuffer=null!=i&&i,this.antialias=!!a,this.anisoLevel=s};Di.prototype.init=function(){var e=document.createElement("canvas");if(null!=e&&(this.canvas=e,e.width=this.curSize[0],e.height=this.curSize[1],e.style.display="block",null!=e.getContext)){var t;e.addEventListener("webglcontextlost",this.contextLost.bind(this),!1),e.addEventListener("webglcontextrestored",this.contextRestored.bind(this),!1);try{t=e.getContext("webgl",{preserveDrawingBuffer:this.keepFrameBuffer,antialias:this.antialias,stencil:!0})||e.getContext("experimental-webgl",{preserveDrawingBuffer:this.keepFrameBuffer})}catch(e){}t&&(this.gl=t,t.getExtension("OES_standard_derivatives"),this.anisoExt=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.anisoExt?(this.maxAniso=t.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT),this.anisoLevel&&(-1==this.anisoLevel?this.anisoLevel=this.maxAniso:this.anisoLevel=Math.min(this.anisoLevel,this.maxAniso))):(this.maxAniso=0,this.anisoLevel=0),this.div.appendChild(e),t.viewportWidth=e.width,t.viewportHeight=e.height,t.clearColor(0,0,0,1),t.disable(t.BLEND),t.disable(t.STENCIL_TEST),t.depthMask(!1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.disable(t.CULL_FACE),t.viewport(0,0,t.viewportWidth,t.viewportHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))}},Di.prototype.kill=function(){this.div.removeChild(this.canvas),delete this.canvas,this.canvas=null},Di.prototype.contextLost=function(e){e.preventDefault(),this.renderer.core.contextLost=!0,this.renderer.core.callListener("gpu-context-lost",{})},Di.prototype.contextRestored=function(){this.renderer.core.callListener("gpu-context-restored",{})},Di.prototype.resize=function(e,t){this.curSize=e;var r=this.canvas,i=this.gl;null!=r&&!0!==t&&(r.width=this.curSize[0],r.height=this.curSize[1]),null!=i&&(i.viewportWidth=r.width,i.viewportHeight=r.height)},Di.prototype.setAniso=function(e){this.anisoExt&&this.anisoLevel&&(this.anisoLevel=-1==e?this.maxAniso:Math.min(e,this.maxAniso))},Di.prototype.getCanvas=function(){return this.canvas},Di.prototype.setViewport=function(){this.gl.viewport(0,0,this.gl.viewportWidth,this.gl.viewportHeight)},Di.prototype.clear=function(e,t,r){null!=r&&this.gl.clearColor(r[0]/255,r[1]/255,r[2]/255,r[3]/255),this.gl.clear((t?this.gl.COLOR_BUFFER_BIT:0)|(e?this.gl.DEPTH_BUFFER_BIT:0))},Di.prototype.useProgram=function(e,t,r){if(this.currentProgram!=e){this.gl.useProgram(e.program),this.currentProgram=e,e.setSampler("uSampler",0),r&&e.setSampler("uSampler2",1);for(var i=this.newAttributes,a=this.enabledAttributes,s=0,n=i.length;s<n;s++)i[s]=0;for(s=0,n=t.length;s<n;s++){var o=e.getAttribute(t[s]);-1!=o&&(i[o]=1)}for(s=0,n=i.length;s<n;s++)a[s]!=i[s]&&(i[s]?(this.gl.enableVertexAttribArray(s),a[s]=1):(this.gl.disableVertexAttribArray(s),a[s]=0))}},Di.prototype.bindTexture=function(e,t){e.loaded&&(this.gl.activeTexture(t?this.gl.TEXTURE1:this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e.texture))},Di.prototype.setFramebuffer=function(e){null!=e?this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e.framebuffer):(this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null))},Di.prototype.createState=function(e){return null==e.blend&&(e.blend=!1),null==e.stencil&&(e.stencil=!1),null==e.zwrite&&(e.zwrite=!0),null==e.ztest&&(e.ztest=!0),null==e.zequal&&(e.zequal=!1),null==e.culling&&(e.culling=!0),e},Di.prototype.setState=function(e){if(e){var t=this.gl,r=this.currentState;r.blend!=e.blend&&(e.blend?(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.BLEND)):t.disable(t.BLEND)),r.stencil!=e.stencil&&(e.stencil?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST)),r.zwrite!=e.zwrite&&(e.zwrite?t.depthMask(!0):t.depthMask(!1)),r.ztest!=e.ztest&&(0!=e.ztest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST)),r.zequal!=e.zequal&&(0!=e.zequal?t.depthFunc(t.LEQUAL):t.depthFunc(t.LESS)),r.culling!=e.culling&&(e.culling?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE)),this.currentState=e}};var Oi=Di,Vi=c,Gi=s.a,ji=function(e,t,r,i,a){this.bbox=null,this.gpu=e,this.gl=e.gl,this.core=t,this.data=null,this.path=a,this.texture={width:256,height:256},this.textures=[],this.images=[],this.ready=!1,this.version=1,this.load(a)};ji.prototype.kill=function(){},ji.prototype.getSize=function(){return this.size},ji.prototype.load=function(e){Gi.loadBinary(e,this.onLoaded.bind(this),this.onError.bind(this))},ji.prototype.onLoaded=function(e){this.data=e,this.ready=!0,this.core.markDirty()},ji.prototype.isReady=function(){return this.ready},ji.prototype.onError=function(){},ji.prototype.onFileLoaded=function(e,t){this.core.markDirty(),this.textures[e].createFromData(256,256,new Uint8Array(t),"linear")},ji.prototype.onFileLoadError=function(){},ji.prototype.areTexturesReady=function(e){for(var t=!0,r=0,i=e.length;r<i;r++){var a=e[r];this.textures[a]?t=t&&this.textures[a].loaded:(Gi.loadBinary(this.path+(a+2),this.onFileLoaded.bind(this,a),this.onFileLoadError.bind(this)),this.textures[a]=new Vi(this.gpu,null,this.core),t=!1)}return t},ji.prototype.getTexture=function(e){return this.textures[e]};var Hi=ji,qi=a.d,Wi=a.e,Ji=a.b,Zi=p.a,Yi=function(e,t,r,i){this.parent=e,this.position=[0,0,0],this.orientation=[0,0,0],this.aspect=1,this.fov=t,this.fovTan=Math.tan(t*Math.PI/180),this.fovDist=1,this.near=r,this.far=i,this.rotationByMatrix=!1,this.modelview=Ji.create(),this.rotationview=Ji.create(),this.projection=Ji.create(),this.mvp=Ji.create(),this.mvp32=new Float32Array(16),this.modelview32=new Float32Array(16),this.rotationview32=new Float32Array(16),this.projection32=new Float32Array(16),this.frustumPlanes=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.bboxPoints=[[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1]],this.scaleFactorVec=[0,0,0,0],this.dirty=!0};Yi.prototype.setPosition=function(e){this.position=e,this.dirty=!0},Yi.prototype.setOrientation=function(e){this.rotationByMatrix=!1,this.orientation=e,this.dirty=!0},Yi.prototype.setRotationMatrix=function(e){this.rotationByMatrix=!0,this.rotationview=e.slice(),this.dirty=!0},Yi.prototype.setAspect=function(e){this.aspect=e,this.dirty=!0},Yi.prototype.setViewHeight=function(e){this.viewHeight=e,this.dirty=!0},Yi.prototype.setOrtho=function(e){this.ortho=e,this.dirty=!0},Yi.prototype.setParams=function(e,t,r){this.fov=e,this.near=t,this.far=r,this.dirty=!0},Yi.prototype.clone=function(e){var t=new Yi(this.parent,null!=e?e:this.getFov(),this.getNear(),this.getFar());return t.setPosition(this.getPosition()),t.setOrientation(this.getOrientation()),t.setAspect(this.getAspect()),t.update(),t},Yi.prototype.getPosition=function(){return[this.position[0],this.position[1],this.position[2]]},Yi.prototype.getOrientation=function(){return[this.orientation[0],this.orientation[1],this.orientation[2]]},Yi.prototype.getAspect=function(){return this.aspect},Yi.prototype.getFov=function(){return this.fov},Yi.prototype.getNear=function(){return this.near},Yi.prototype.getFar=function(){return this.far},Yi.prototype.getViewHeight=function(){return this.viewHeight},Yi.prototype.getOrtho=function(){return this.ortho},Yi.prototype.getRotationviewMatrix=function(){return this.dirty&&this.update(),this.rotationview},Yi.prototype.getRotationviewFMatrix=function(){return this.dirty&&this.update(),this.rotationview32},Yi.prototype.getModelviewMatrix=function(){return this.dirty&&this.update(),this.modelview},Yi.prototype.getModelviewFMatrix=function(){return this.dirty&&this.update(),this.modelview32},Yi.prototype.getProjectionMatrix=function(){return this.dirty&&this.update(),this.projection},Yi.prototype.getProjectionFMatrix=function(){return this.dirty&&this.update(),this.projection32},Yi.prototype.getMvpMatrix=function(){return this.dirty&&this.update(),this.mvp},Yi.prototype.getMvpFMatrix=function(){return this.dirty&&this.update(),this.mvp32},Yi.prototype.scaleFactor=function(e,t){this.dirty&&this.update(),Ji.multiplyVec3(this.modelview,e,this.scaleFactorVec);var r=qi.length(this.scaleFactorVec);return t?r<this.near?[Number.POSITIVE_INFINITY,r]:[this.projection[0]/r,r]:r<this.near?Number.POSITIVE_INFINITY:this.projection[0]/r},Yi.prototype.scaleFactor2=function(e){return this.dirty&&this.update(),e<this.near?Number.POSITIVE_INFINITY:this.projection[0]/e},Yi.prototype.distance=function(e){var t=qi.create();return qi.subtract(this.position,e,t),qi.length(t)},Yi.prototype.pointVisible=function(e,t){var r;this.dirty&&this.update(),r=t?[e[0]-t[0],e[1]-t[1],e[2]-t[2],1]:[e[0],e[1],e[2],1];for(var i=0;i<6;i++)if(Wi.dot(this.frustumPlanes[i],r)<0)return!1;return!0},Yi.prototype.pointsVisible=function(e,t){this.dirty&&this.update();var r,i,a,s=this.frustumPlanes,n=e.length;t?(r=t[0],i=t[1],a=t[2]):(r=0,i=0,a=0);for(var o=Wi.dot3,h=0;h<6;h++){for(var l=!0,u=s[h],d=0;d<n;d+=3)if(o(u,e,d,r,i,a)>=0){l=!1;break}if(l)return!1}return!0},Yi.prototype.pointsVisible2=function(e,t){this.dirty&&this.update();var r,i,a,s=this.frustumPlanes,n=e.length;t?(r=t[0],i=t[1],a=t[2]):(r=0,i=0,a=0);for(var o=Wi.dot3,h=0;h<6;h++){for(var l=!0,u=s[h],d=0;d<n;d++)if(o(u,e[d],0,r,i,a)>=0){l=!1;break}if(l)return!1}return!0},Yi.prototype.bboxVisible=function(e,t){this.dirty&&this.update();var r,i,a,s,n,o,h,l=e.min,u=e.max,d=this.bboxPoints;t?(i=l[0]-t[0],a=l[1]-t[1],s=l[2]-t[2],n=u[0]-t[0],o=u[1]-t[1],h=u[2]-t[2]):(i=l[0],a=l[1],s=l[2],n=u[0],o=u[1],h=u[2]),(r=d[0])[0]=i,r[1]=a,r[2]=s,(r=d[1])[0]=i,r[1]=a,r[2]=h,(r=d[2])[0]=i,r[1]=o,r[2]=s,(r=d[3])[0]=i,r[1]=o,r[2]=h,(r=d[4])[0]=n,r[1]=a,r[2]=s,(r=d[5])[0]=n,r[1]=a,r[2]=h,(r=d[6])[0]=n,r[1]=o,r[2]=s,(r=d[7])[0]=n,r[1]=o,r[2]=h;for(var c=Wi.dot2,p=this.frustumPlanes,f=0;f<6;f++){for(var m=!0,g=p[f],v=0;v<8;v++)if(c(g,d[v])>=0){m=!1;break}if(m)return!1}return!0},Yi.prototype.update=function(e){this.rotationByMatrix||(Ji.multiply(Zi.rotationMatrix(2,Zi.radians(-this.orientation[2])),Zi.rotationMatrix(0,Zi.radians(-this.orientation[1]-90)),this.rotationview),Ji.multiply(this.rotationview,Zi.rotationMatrix(2,Zi.radians(-this.orientation[0])),this.rotationview)),Ji.multiply(this.rotationview,Zi.translationMatrix(-this.position[0],-this.position[1],-this.position[2]),this.modelview),this.ortho?this.projection=Zi.orthographicMatrix(this.viewHeight,this.aspect,this.near,this.far):this.projection=Zi.perspectiveMatrix(this.fov,this.aspect,this.near,this.far),Ji.multiply(this.projection,this.modelview,this.mvp),this.frustumPlanes[0]=[0,0,1,1],this.frustumPlanes[1]=[0,0,-1,1],this.frustumPlanes[2]=[1,0,0,1],this.frustumPlanes[3]=[-1,0,0,1],this.frustumPlanes[4]=[0,1,0,1],this.frustumPlanes[5]=[0,-1,0,1];var t=Ji.create();Ji.transpose(this.mvp,t);for(var r=0;r<6;r++)this.frustumPlanes[r]=Ji.multiplyVec4(t,this.frustumPlanes[r]);this.mvp32.set(this.mvp),this.projection32.set(this.projection),this.modelview32.set(this.modelview),this.rotationview32.set(this.rotationview),this.fovDist=.5*this.parent.curSize[1]/this.fovTan,this.dirty=!1};var Ki=Yi,Xi=I,Qi={setFaceVertices:function(e,t,r,i,a){e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=r[0],e[a+4]=r[1],e[a+5]=r[2],e[a+6]=i[0],e[a+7]=i[1],e[a+8]=i[2]},setFaceUVs:function(e,t,r,i,a){e[a]=t[0],e[a+1]=t[1],e[a+2]=r[0],e[a+3]=r[1],e[a+4]=i[0],e[a+5]=i[1]},buildHeightmap:function(e,t){e--;for(var r=Qi,i=e*e*2,a=new Float32Array(3*i*3),s=new Float32Array(3*i*2),n=1*e,o=0,h=0,l=0;l<e;l++)for(var u=0;u<e;u++){var d=u*n,c=(u+1)*n,p=l*n,f=(l+1)*n;r.setFaceVertices(a,[d,p,0],[c,p,0],[c,f,0],o),r.setFaceUVs(s,[d,p],[c,p],[c,f],h),o+=9,h+=6,r.setFaceVertices(a,[c,f,0],[d,f,0],[d,p,0],o),r.setFaceUVs(s,[c,f],[d,f],[d,p],h),o+=9,h+=6}var m=new Xi(0,0,0,1,1,1);return t?{bbox:m,vertices:this.covnetTo16Bit(a),uvs:this.covnetTo16Bit(s)}:{bbox:m,vertices:a,uvs:s}},buildPlane:function(e,t){e--;for(var r,i,a,s,n,o,h,l,u=Qi,d=e*e*2,c=t?new Uint16Array(3*d*3):new Float32Array(3*d*3),p=new Float32Array(3*d*2),f=1/e,m=0,g=0,v=0;v<e;v++)for(var y=0;y<e;y++)r=y,a=y+1,i=v,s=v+1,n=y*f,o=(y+1)*f,h=v*f,l=(v+1)*f,u.setFaceVertices(c,[r,i,0],[r,s,0],[a,s,0],m),u.setFaceUVs(p,[n,h],[n,l],[o,l],g),m+=9,g+=6,u.setFaceVertices(c,[a,s,0],[a,i,0],[r,i,0],m),u.setFaceUVs(p,[o,l],[o,h],[n,h],g),m+=9,g+=6;var b=new Xi(0,0,0,1,1,1);return t?{bbox:b,vertices:c,uvs:this.covnetTo16Bit(p)}:{bbox:b,vertices:c,uvs:p}},spherePos:function(e,t){return t*=Math.PI,e*=2*Math.PI,[Math.cos(e)*Math.sin(t)*.5+.5,Math.sin(e)*Math.sin(t)*.5+.5,.5*Math.cos(t)+.5]},buildSkydome:function(e,t,r,i){var a,s,n,o=Qi,h=e*t*2,l=e*t*(i?1:3),u=new Float32Array(3*l),d=new Float32Array(2*l),c=i?new Uint16Array(3*h):null,p=0,f=0;o=Qi;if(i){for(m=0;m<e;m++)for(g=0;g<t;g++)s=g/t,n=m/e,a=o.spherePos(s,n),u[p]=a[0],u[p+1]=a[1],u[p+2]=a[2],d[f]=s,d[f+1]=n,p+=3,f+=2;for(p=0,m=0;m<e-1;m++)for(g=0;g<t;g++)x=m+1,(y=g+1)>=t&&(y=0),c[p]=x*t+g,c[p+1]=m*t+g,c[p+2]=m*t+y,c[p+3]=m*t+y,c[p+4]=x*t+y,c[p+5]=x*t+g,p+=6}else for(var m=0;m<e;m++)for(var g=0;g<t;g++){var v=g/t,y=(g+1)/t,b=m/e,x=(m+1)/e;o.makeQuad(v,b,y,x,u,p,d,f),p+=18,f+=12}var S=new Xi(0,0,0,1,1,1);return r?{bbox:S,vertices:this.covnetTo16Bit(u),uvs:this.covnetTo16Bit(d),indices:c}:{bbox:S,vertices:u,uvs:d,indices:c}},covnetTo16Bit:function(e){for(var t,r=new Uint16Array(e.length),i=0,a=e.length;i<a;i++)(t=65535*e[i])<0&&(t=0),t>65535&&(t=65535),r[i]=t;return r},makeQuad:function(e,t,r,i,a,s,n,o){var h=Qi,l=h.spherePos(e,t),u=[e,t],d=h.spherePos(e,i),c=[e,i],p=h.spherePos(r,t),f=[r,t],m=h.spherePos(r,i),g=[r,i];h.setFaceVertices(a,d,l,p,s),h.setFaceUVs(n,c,u,f,o),h.setFaceVertices(a,p,m,d,s+9),h.setFaceUVs(n,f,g,c,o+6)}},$i=Qi,ea=function(e,t){this.gl=e.gl;var r,i=this.gl;null!=i&&(this.free=t,this.vertexPositionBuffer=null,this.vertexPositionBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.vertexPositionBuffer),r=t?[0,0,0,0,0,1,0,0,1,0,0,2,0,0,2,0,0,3,0,0,3,0,0,0,0,0,4,0,0,5,0,0,5,0,0,6,0,0,6,0,0,7,0,0,7,0,0,4,0,0,0,0,0,4,0,0,1,0,0,5,0,0,2,0,0,6,0,0,3,0,0,7]:[0,0,0,1,0,0,1,0,0,1,1,0,1,1,0,0,1,0,0,1,0,0,0,0,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,0,1,0,0,0,0,0,1,1,0,0,1,0,1,1,1,0,1,1,1,0,1,0,0,1,1],i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW),this.vertexPositionBuffer.itemSize=3,this.vertexPositionBuffer.numItems=r.length/3,this.size=36,this.lines=this.vertexPositionBuffer.numItems/3)};ea.prototype.kill=function(){this.gl.deleteBuffer(this.vertexPositionBuffer)},ea.prototype.draw=function(e,t){var r=this.gl;if(null!=r){var i=e.getAttribute(t);r.bindBuffer(r.ARRAY_BUFFER,this.vertexPositionBuffer),r.vertexAttribPointer(i,this.vertexPositionBuffer.itemSize,r.FLOAT,!1,0,0),r.drawArrays(r.LINES,0,this.vertexPositionBuffer.numItems)}};var ta=ea,ra=function(e,t,r,i,a,s){this.bbox=null,this.gpu=e,this.gl=e.gl,this.core=t,null!=this.gl&&(this.vertices=[],this.normals=[],this.vertexBuffer=null,this.lines=r,this.joins=a,this.joinSides=s,this.maxLines=i,this.init())};ra.prototype.kill=function(){this.gl.deleteBuffer(this.vertexBuffer)},ra.prototype.init=function(){var e;if(this.lines)for(this.joins&&this.addCircle(0,this.joinSides),e=0;e<this.maxLines;e++)this.addLine(e,e+1),this.joins&&this.addCircle(e+1,this.joinSides);else if(this.joins)for(e=0;e<=this.maxLines;e++)this.addCircle(e,this.joinSides);this.compile()},ra.prototype.addLine=function(e,t){var r=this.vertices.length;this.vertices[r]=e,this.vertices[r+1]=t,this.vertices[r+2]=1,this.vertices[r+3]=e,this.vertices[r+4]=t,this.vertices[r+5]=-1,this.vertices[r+6]=t,this.vertices[r+7]=e,this.vertices[r+8]=1,this.vertices[r+9]=e,this.vertices[r+10]=t,this.vertices[r+11]=1,this.vertices[r+12]=t,this.vertices[r+13]=e,this.vertices[r+14]=1,this.vertices[r+15]=t,this.vertices[r+16]=e,this.vertices[r+17]=-1,this.polygons+=2},ra.prototype.addCircle=function(e,t){for(var r=this.vertices.length,i=2*Math.PI/t,a=0;a<t;a++)this.vertices[r]=e,this.vertices[r+1]=-1,this.vertices[r+2]=0,this.vertices[r+3]=e,this.vertices[r+4]=-2,this.vertices[r+5]=i*a,this.vertices[r+6]=e,this.vertices[r+7]=-2,this.vertices[r+8]=i*(a+1),r+=9;this.polygons+=t},ra.prototype.compile=function(){var e=this.gl;this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),this.vertexBuffer.itemSize=3,this.vertexBuffer.numItems=this.vertices.length/3,this.size=3*this.vertexBuffer.numItems*4*2,this.polygons=this.vertexBuffer.numItems/3},ra.prototype.draw=function(e,t,r){var i=this.gl;if(!(null==i||null==this.vertexBuffer||r>this.maxLines)){var a=e.getAttribute(t);i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),i.vertexAttribPointer(a,this.vertexBuffer.itemSize,i.FLOAT,!1,0,0);var s=0;this.lines&&(s+=3*(r-1)*2),this.joins&&(s+=r*(3*this.joinSides)),i.drawArrays(i.TRIANGLES,0,s)}},ra.prototype.getSize=function(){return this.size},ra.prototype.getBbox=function(){return this.bbox},ra.prototype.getPolygons=function(){return this.polygons};var ia=$i,aa=ta,sa=q,na=ra,oa=$,ha=te,la=c,ua=function(e){this.renderer=e,this.core=e.core,this.gpu=e.gpu,this.initShaders(),this.initHeightmap(),this.initSkydome(),this.initHitmap(),this.initTextMap(),this.initImage(),this.initTestMap(),this.initBBox(),this.initLines(),this.initBaricentricBuffer()};ua.prototype.initShaders=function(){var e=ha,t=this.renderer,r=this.gpu;t.progTile=[new oa(r,"#define variants\n"+e.tileVertexShader,"#define variants\n"+e.tileFragmentShader)],t.progTile2=[new oa(r,"#define variants\n#define externalTex\n"+e.tileVertexShader,"#define variants\n#define externalTex\n"+e.tileFragmentShader.replace("__FILTER__",""))],t.progTile3=[new oa(r,"#define variants\n#define externalTex\n"+e.tileVertexShader,"#define variants\n#define externalTex\n#define mask\n"+e.tileFragmentShader.replace("__FILTER__",""))],t.progFogTile=[new oa(r,"#define variants\n#define onlyFog\n"+e.tileVertexShader,"#define variants\n#define onlyFog\n"+e.tileFragmentShader)];var i="#extension GL_OES_standard_derivatives : enable\n";t.progFlatShadeTile=[new oa(r,"#define variants\n#define flatShadeVar\n"+e.tileVertexShader,i+"#define variants\n#define flatShadeVar\n#define flatShade\n"+e.tileFragmentShader)],t.progFlatShadeTileSE=[new oa(r,"#define variants\n#define applySE\n#define flatShadeVar\n"+e.tileVertexShader,i+"#define variants\n#define flatShadeVar\n#define flatShade\n"+e.tileFragmentShader)],t.progCFlatShadeTile=new oa(r,"#define flatShadeVar\n"+e.tileVertexShader,(i+"#define flatShadeVar\n#define flatShade\n#define fogAndColor\n"+e.tileFragmentShader).replace("mediump","highp")),t.progCFlatShadeTileSE=new oa(r,"#define applySE\n#define flatShadeVar\n"+e.tileVertexShader,(i+"#define flatShadeVar\n#define flatShade\n#define fogAndColor\n"+e.tileFragmentShader).replace("mediump","highp")),t.progDepthTile=[new oa(r,"#define variants\n#define depth\n"+e.tileVertexShader,("#define variants\n#define depth\n"+e.tileFragmentShader).replace("mediump","highp"))],t.progDepthHeightmap=new oa(r,e.heightmapDepthVertexShader,e.heightmapDepthFragmentShader.replace("mediump","highp")),t.progWireFrameBasic=[new oa(r,"#define variants\n"+e.tileVertexShader,"#define variants\n"+e.tileWireFrameBasicShader)],t.progShadedTile=new oa(r,e.shadedMeshVertexShader,e.shadedMeshFragmentShader),t.progTShadedTile=new oa(r,e.shadedMeshVertexShader,"#define textured\n"+e.shadedMeshFragmentShader),t.progHeightmap=new oa(r,e.heightmapVertexShader,e.heightmapFragmentShader),t.progPlane=new oa(r,"#define flat\n"+e.planeVertexShader,e.planeFragmentShader),t.progPlane2=new oa(r,"#define poles\n"+e.planeVertexShader,"#define poles\n"+e.planeFragmentShader),t.progPlane3=new oa(r,e.planeVertexShader,e.planeFragmentShader),t.progPlaneD=new oa(r,"#define depth\n#define flat\n"+e.planeVertexShader,"#define depth\n"+e.planeFragmentShader),t.progPlane2D=new oa(r,"#define depth\n#define poles\n"+e.planeVertexShader,"#define depth\n#define poles\n"+e.planeFragmentShader),t.progPlane3D=new oa(r,"#define depth\n"+e.planeVertexShader,"#define depth\n"+e.planeFragmentShader),t.progSkydome=new oa(r,e.skydomeVertexShader,e.skydomeFragmentShader),t.progStardome=new oa(r,e.skydomeVertexShader,e.stardomeFragmentShader),t.progAtmo2=new oa(r,e.atmoVertexShader,e.atmoFragmentShader),t.progAtmo=new oa(r,e.atmoVertexShader3,e.atmoFragmentShader3),t.progBBox=new oa(r,e.bboxVertexShader,e.bboxFragmentShader),t.progBBox2=new oa(r,e.bbox2VertexShader,e.bboxFragmentShader),t.progLine=new oa(r,e.lineVertexShader,e.lineFragmentShader),t.progLineSE=new oa(r,"#define applySE\n"+e.lineVertexShader,e.lineFragmentShader),t.progELine=new oa(r,"#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progELineSE=new oa(r,"#define applySE\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progLine3=new oa(r,"#define pixelLine\n"+e.lineVertexShader,e.lineFragmentShader),t.progELine3=new oa(r,"#define pixelLine\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progLine3SE=new oa(r,"#define applySE\n#define pixelLine\n"+e.lineVertexShader,e.lineFragmentShader),t.progELine3SE=new oa(r,"#define applySE\n#define pixelLine\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progLine4=new oa(r,"#define pixelLine\n#define dataPoints\n"+e.lineVertexShader,e.lineFragmentShader),t.progLine5=new oa(r,"#define pixelLine\n#define dataPoints\n#define dataPoints2\n"+e.lineVertexShader,e.lineFragmentShader),t.progRLine=new oa(r,"#define dynamicWidth\n"+e.lineVertexShader,e.lineFragmentShader),t.progRLineSE=new oa(r,"#define applySE\n#define dynamicWidth\n"+e.lineVertexShader,e.lineFragmentShader),t.progERLine=new oa(r,"#define dynamicWidth\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progERLineSE=new oa(r,"#define applySE\n#define dynamicWidth\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progTLine=new oa(r,e.tlineVertexShader,e.tlineFragmentShader),t.progTPLine=new oa(r,e.tplineVertexShader,e.tlineFragmentShader),t.progTBLine=new oa(r,e.tlineVertexShader,e.tblineFragmentShader),t.progTPBLine=new oa(r,e.tplineVertexShader,e.tblineFragmentShader),t.progETLine=new oa(r,e.etlineVertexShader,e.elineFragmentShader),t.progETPLine=new oa(r,e.etplineVertexShader,e.elineFragmentShader),t.progText2=new oa(r,"#define lineLabel\n"+e.lineVertexShader,e.text2FragmentShader),t.progText2SE=new oa(r,"#define applySE\n#define lineLabel\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel16=new oa(r,"#define DSIZE 16\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel32=new oa(r,"#define DSIZE 32\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel48=new oa(r,"#define DSIZE 48\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel64=new oa(r,"#define DSIZE 64\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel96=new oa(r,"#define DSIZE 96\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel128=new oa(r,"#define DSIZE 128\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progPolygon=new oa(r,e.polygonVertexShader,e.polygonFragmentShader),t.progImage=new oa(r,e.imageVertexShader,e.imageFragmentShader),t.progIcon=new oa(r,e.iconVertexShader,e.textFragmentShader),t.progIcon2=new oa(r,e.icon2VertexShader,e.text2FragmentShader),t.progLabel16=new oa(r,"#define DSIZE 16\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel32=new oa(r,"#define DSIZE 32\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel48=new oa(r,"#define DSIZE 48\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel64=new oa(r,"#define DSIZE 64\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel96=new oa(r,"#define DSIZE 96\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel128=new oa(r,"#define DSIZE 128\n"+e.icon3VertexShader,e.text2FragmentShader)},ua.prototype.initProceduralShaders=function(){var e=ha,t=this.renderer,r=this.gpu;t.progHmapPlane=new oa(r,e.planeVertex4Shader,e.planeFragmentShader2),t.progHmapPlane2=new oa(r,e.planeVertex4Shader,"#define grid\n"+e.planeFragmentShader2),t.progHmapPlane3=new oa(r,e.planeVertex4Shader,"#define exmap\n"+e.planeFragmentShader2),t.progHmapPlane4=new oa(r,e.planeVertex4Shader,"#define flat\n"+e.planeFragmentShader2),t.progHmapPlane5=new oa(r,e.planeVertex4Shader,"#define normals\n"+e.planeFragmentShader2),t.progHmapPlane6=new oa(r,e.planeVertex4Shader,"#define nmix\n#define normals\n"+e.planeFragmentShader2),t.progHmapPlane7=new oa(r,e.planeVertex4Shader,"#define nmix\n"+e.planeFragmentShader2),t.progHmapPlane8=new oa(r,e.planeVertex4Shader,"#define exmap\n#define classmap\n"+e.planeFragmentShader2)},ua.prototype.initHeightmap=function(){var e=this.renderer,t=e.core.config.map16bitMeshes,r=this.gpu,i=ia.buildHeightmap(5,!0);i=ia.buildPlane(16,!0),e.planeMesh=new sa(r,i,null,this.core,!0,t,!0),i=ia.buildPlane(128,!0),e.planeMesh2=new sa(r,i,null,this.core,!0,t,!0);for(var a=new Uint8Array(16384),s=0;s<64;s++)for(var n=0;n<64;n++){var o=4*(64*s+n);s<1||s>=63||n<1||n>=63?(a[o]=255,a[o+1]=255,a[o+2]=255):(a[o]=32,a[o+1]=32,a[o+2]=32),a[o+3]=255}e.heightmapTexture=new la(r),e.heightmapTexture.createFromData(64,64,a,"trilinear",!0)},ua.prototype.initHitmap=function(){var e=this.renderer,t=e.hitmapSize,r=new Uint8Array(t*t*4);e.hitmapMode>2&&(e.hitmapData=r),e.hitmapTexture=new la(this.gpu),e.hitmapTexture.createFromData(t,t,r),e.hitmapTexture.createFramebuffer(t,t),e.geoHitmapTexture=new la(this.gpu),e.geoHitmapTexture.createFromData(t,t,r),e.geoHitmapTexture.createFramebuffer(t,t),e.geoHitmapTexture2=new la(this.gpu),e.geoHitmapTexture2.createFromData(t,t,r),e.geoHitmapTexture2.createFramebuffer(t,t)},ua.prototype.initTestMap=function(){var e,t,r,i=this.renderer,a=this.gpu,s=new Uint8Array(1024);for(e=0;e<16;e++)for(t=0;t<16;t++)s[r=4*(16*e+t)]=255,s[r+1]=0,s[r+2]=0,s[r+3]=255;for(i.redTexture=new la(a),i.redTexture.createFromData(16,16,s),s=new Uint8Array(1024),e=0;e<16;e++)for(t=0;t<16;t++)s[r=4*(16*e+t)]=255,s[r+1]=255,s[r+2]=255,s[r+3]=255;for(i.whiteTexture=new la(a),i.whiteTexture.createFromData(16,16,s),s=new Uint8Array(1024),e=0;e<16;e++)for(t=0;t<16;t++)s[r=4*(16*e+t)]=0,s[r+1]=0,s[r+2]=0,s[r+3]=255;i.blackTexture=new la(a),i.blackTexture.createFromData(16,16,s)},ua.prototype.initTextMap=function(){this.renderer.textTexture2=new la(this.gpu,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAACACAMAAADTa0c4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAAAA////pdmf3QAABIFJREFUeNrsnNuyqzAIhsP7v/Se6Yxra0L4OUVNCzetVqP5DAQItrVOiLg95739NnfOaR99RDj6esBw+CKZXiMK4PiuBkAcANoHAP3J5fzzAV2jePQIt6f4Ndb/MIChlVcCEFpAACZPfN4KUAF0/ufboDW3AuBMFgBwHTCfg2ftYgDUKBuA1ABuHKvA2P+5XdONIEt7BO2o2MdlAJoTQOsV6GEAswt0Zq/bsBhdeQQkqEDMwmIAnJHzA8i3ASkWRFKBbADyLGB3mlYD6DyhA4DfBlgsBDtirUPcBgC5woStYMgVtgKATWcB6DskKUEkGFLYrGw3+l3ydR16wKbbPDlWp4Xfo9vZwR1jtOMA6GkABrdvNmt1Vluy6pyvxu4Xt62fquyTggCTsIkCoIuv8gAA08w+ATBXAdSRY56xPDFPx/VPWFZp5v65kFMPgFjP70YASMfRsDn01xLPcwkRq1HLMoK647hR8v+nId74MQBjvIbUQePra42ZVXVcBCR3mIY89mYAlNGLflqA0V1seosCQNMg80B0bsLGAIDNwvFyiqu66ngVGGMGVBwyWwIwpty2DqEr/qf0Bq+DbjYkkcr4VUoOxiRjrYn3YY5SC4BQB/cF0Lq4kD1RCJ+tN4g6Jps5zfWu+QmSz9sUABkA0BIAXocmBwCJ99MDIASATkmtLQAIft4IgE/ZDStZ59yQbOQQAGZWYMbZ3FFCAGRHnwHQznegGAE+zwxNi8kALCOgS9tzAC4jYG1Qo0myRm0Ae/z8eleqewBoZLwfUswCsbT1KgBZD6QAzAEoXUe3K+xxVf2uLf5U3nBeMPRyACW/LtrwVX989id3PRQOG5Io6vh9XwC6stHIdGdJozun03lxNlwvH4u6UgDM8/LmJyx7ak12feEebaXmUwCOYJWk1JcYKsl74HL74wAaH93NqkE1FSKXc4cv0AjaPEEPgE4ru/ieWdvzVq/4psG3AYDFHlEAioQCuEgMgPjK1VDrqlkbTABAiQBGK38B0BlBSf9xtiAJQDM4NtDqMlaeyduTtkDjHgAtEQBj5ZGK2QE0aCcMAIxLSw0WVYlGDgOQXWE+afouAM0S398O4Nej3wIQf4cIHSfz9pbWugyep4MFIAFARvspbm8BcE2DOdvWnCJQAWFhJ/hKzh4AaB2A7NxedKmLPc+6PN4cL2S8GYC1QMIEQJvmFsJfxdvkEQAoLV4AogBS8/kNvdXlWe5GKhABvQUAZASDALJffY1XfsrToFXFbvYD1gBo6wC8LR7/uvj9CwHcfWuoUJItsVl5nwWAnhxxqsXatUq0OYCcaS/fkbK61u5H8jwAuUIEZXHNL1Jmub5oSKZWiDR9FttM4HEAigqRpn8TeB2AuWNiByAXSHCGbB7/3qYCfgCgPgADEEskbjCCaJDB/+kR6wP4P1Obl8jsBwDUB4yAxqKkthaATjX0KmCtDyCxm+yIMLjCbwBgrg94FYC3h8vLPPmfAVBSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlLy9fJPgAEAvWMULbGsSjwAAAAASUVORK5CYII=",this.core,null,!0)},ua.prototype.initImage=function(){var e=this.renderer,t=this.gpu.gl;e.rectVerticesBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.rectVerticesBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,0,1,2,0,0,1,3,0,0,1]),t.STATIC_DRAW),e.rectVerticesBuffer.itemSize=4,e.rectVerticesBuffer.numItems=4,e.rectIndicesBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.rectIndicesBuffer);t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,2,1,0,3,2]),t.STATIC_DRAW),e.rectIndicesBuffer.itemSize=1,e.rectIndicesBuffer.numItems=6,e.textBuff16=new Float32Array(64),e.textBuff32=new Float32Array(128),e.textBuff48=new Float32Array(192),e.textBuff64=new Float32Array(256),e.textQuads16=this.generateTextQuads(16),e.textQuads32=this.generateTextQuads(32),e.textQuads48=this.generateTextQuads(48),e.textQuads64=this.generateTextQuads(64),e.textQuads96=this.generateTextQuads(96),e.textQuads128=this.generateTextQuads(128)},ua.prototype.generateTextQuads=function(e){this.renderer;for(var t,r,i=this.gpu.gl,a=new Float32Array(2*e*6),s=0;s<e;s++)r=0,a[t=6*s*2]=s,a[t+1]=r,r=1,a[t+2]=s,a[t+3]=r,r=2,a[t+4]=s,a[t+5]=r,r=2,a[t+6]=s,a[t+7]=r,r=3,a[t+8]=s,a[t+9]=r,r=0,a[t+10]=s,a[t+11]=r;var n=i.createBuffer();return i.bindBuffer(i.ARRAY_BUFFER,n),i.bufferData(i.ARRAY_BUFFER,a,i.STATIC_DRAW),n.itemSize=2,n.numItems=6*e,n},ua.prototype.initSkydome=function(){var e=this.renderer,t=e.core.config.map16bitMeshes,r=ia.buildSkydome(32,64,t);e.skydomeMesh=new sa(this.gpu,r,null,this.core,!0,t),r=ia.buildSkydome(128,256,t,!0),e.atmoMesh=new sa(this.gpu,r,null,this.core,!0,t)},ua.prototype.initBBox=function(){var e=this.renderer,t=this.gpu;e.bboxMesh=new aa(t),e.bboxMesh2=new aa(t,!0)},ua.prototype.initLines=function(){var e=this.gpu,t=this.renderer;t.plineBuffer=new Float32Array(96),t.plines=new na(e,this.core,!0,64,!0,8),t.plineJoints=new na(e,this.core,!1,64,!0,8),t.stencilLineState=e.createState({blend:!0,stencil:!0,culling:!1}),t.lineLabelState=e.createState({blend:!0,culling:!1,zequal:!0,zwrite:!1}),t.labelState=e.createState({blend:!0,culling:!1,zequal:!0}),t.stencilLineHitState=e.createState({blend:!1,stencil:!0,culling:!1}),t.lineLabelHitState=e.createState({blend:!1,culling:!1}),t.polygonB1S1C1tate=e.createState({blend:!0,stencil:!0,culling:!0,zequal:!0}),t.polygonB1S0C1tate=e.createState({blend:!0,stencil:!1,culling:!0,zequal:!0}),t.polygonB1S1C0tate=e.createState({blend:!0,stencil:!0,culling:!1,zequal:!0}),t.polygonB1S0C0tate=e.createState({blend:!0,stencil:!1,culling:!1,zequal:!0}),t.polygonB0S1C1tate=e.createState({blend:!1,stencil:!0,culling:!0,zequal:!0}),t.polygonB0S0C1tate=e.createState({blend:!1,stencil:!1,culling:!0,zequal:!0}),t.polygonB0S1C0tate=e.createState({blend:!1,stencil:!0,culling:!1,zequal:!0}),t.polygonB0S0C0tate=e.createState({blend:!1,stencil:!1,culling:!1,zequal:!0})},ua.prototype.initBaricentricBuffer=function(){for(var e=this.gpu,t=new Array(196605),r=0;r<196605;r+=9)t[r]=1,t[r+1]=0,t[r+2]=0,t[r+3]=0,t[r+4]=1,t[r+5]=0,t[r+6]=0,t[r+7]=0,t[r+8]=1;var i=e.gl;e.barycentricBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,e.barycentricBuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),e.barycentricBuffer.itemSize=3,e.barycentricBuffer.numItems=t.length/3};var da=ua;function ca(e,t,r,i){var a,s,n=0,o=t?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY,h=i.gmapTop,l=0,u=0,d=i.gmap;do{var c=t?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;u=l;for(var p=0,f=e.length;p<f;p++)a=d[s=e[p]][0].reduce[1],(t&&a>=c&&a<o||a<=c&&a>o)&&(c!=a&&(l=u),h[l]=s,l++,c=a);o=c,n++}while(n<r)}function pa(e,t,r,i,a,s,n,o,h){var l,u,d=r-1,c=i-1,p=r+1,f=i+1;for(d<0&&(d=0),c<0&&(c=0),p>a&&(p=a),f>s&&(f=s);c<=f;c++)for(l=d;l<=p;l++)n[u=2*(c*a+l)],n[u]?(o[n[u+1]]=h,n[u+1]=h+1,o[h]=t,o[h+1]=0,h+=2):(n[u]=h,n[u+1]=h+1,o[h]=t,o[h+1]=0,h+=2);return h}function fa(e,t,r,i,a){var s,n,o,h,l=r<65536?e.radixCountBuffer16:e.radixCountBuffer32,u=e.buffUint32,d=e.buffFloat32,c=e.config.mapFeaturesReduceFactor;e.curSize[0],e.curSize[1];if(l.fill)l.fill(0);else for(o=0;o<1024;o++)l[o]=0;for(o=0;o<r;o++)n=(h=(s=t[o])[0].reduce)[3]-c*Math.log(h[4]),h[6]=n,(n+=1e4)<0&&(n=0),d[0]=n,n=u[0],h[5]=n,l[255&n]++,l[256+(n>>8&255)]++,l[512+(n>>16&255)]++,l[768+(n>>24&255)]++;for(var p=0;p<4;p++){var f=0,m=0,g=256*p;for(o=0;o<256;o++)f=l[o+g],l[o+g]=m,m+=f}for(o=0;o<r;o++)i[l[255&(n=(s=t[o])[0].reduce[5])]++]=s;for(o=0;o<r;o++)t[l[256+((n=(s=i[o])[0].reduce[5])>>8&255)]++]=s;for(o=0;o<r;o++)i[l[512+((n=(s=t[o])[0].reduce[5])>>16&255)]++]=s;for(o=0;o<r;o++)t[l[768+((n=(s=i[o])[0].reduce[5])>>24&255)]++]=s;if(-123==o)for(o=0;o<r;o++)n=t[o][0].reduce[5],console.log(n+" "+t[o][0].id);return t}function ma(e,t,r,i,a){var s=i-1,n=a-1;(t-=.5)<0&&(t=0),(r-=.5)<0&&(r=0),t>s&&(t=s),r>n&&(r=n);var o=Math.floor(t),h=Math.floor(r),l=t-o,u=r-h,d=h*i,c=h==n?d:d+i,p=o==s?o:o+1,f=e[d+o],m=e[d+p],g=e[c+o],v=f+(m-f)*l;return v+(g+(e[c+p]-g)*l-v)*u}var ga=a.d,va=a.a,ya=a.b,ba=p.a,xa=function(e,t,r,i,a){if(r.config.mapFeaturesReduceParams){var s,n,o=r.config.mapFeaturesReduceParams[1],h=r.config.mapFeaturesReduceParams[0],l=96*(window.devicePixelRatio||1),u=r.curSize[0],d=r.curSize[1],c=Math.ceil(u/l*(d/l)*h),p=r.config.mapFeaturesSortByTop;o=o<=0?2*c:o;var f=r.gmap,m=r.gmapIndex,g=r.gmapTop,v=c;c>m&&(v=m);var y,b,x,S,M=Math.floor(Math.sqrt(u*d/o)),w=r.gmapHit,T=0,A=r.drawAllLabels,C=[[0,0,255,255],[128,0,255,255],[255,0,0,255],[255,128,0,255],[0,255,0,255],[0,255,128,255],[128,255,128,255]],F=0;do{var P,L,E,N,B,I,k,R,_,z,U,D,O,V,G;P=1/(k=(B=u/M)*(I=d/M)),L=(B-=U=Math.floor(B))/k,E=(I-=D=Math.floor(I))/k,N=B*I/k,P=Math.floor(P*c),L=Math.floor(L*c),E=Math.floor(E*c),N=Math.floor(N*c);w=r.gmapStore;var j=r.gmapHit;if(r.drawGridCells){e.setState(r.lineLabelState);var H,q,W=0,J=0;for(H=0,q=D+1;H<q;H++)for(s=0,n=U+1;s<n;s++)W=M*s,J=M*H,O=P,s>=U?O=H>=D?N:L:H>=D&&(O=L),a.drawLineString([[W,J,.5],[W+M,J,.5],[W+M,J+M,.5],[W,J+M,.5]],!0,1,C[F],null,!0,null,null,null),a.drawText(Math.round(W+5),Math.round(J+5+15*F),10,""+O,C[F],.5)}for(s=0,n=(U+1)*(D+1);s<n;s++)w[s]=null;for(s=0,n=m;s<n;s++)(x=f[s])&&((R=x[5])[0]<30||R[0]>=u-30||R[1]<30||R[1]>=d-30?f[s]=null:(_=R[0]/M,z=R[1]/M,(O=_>U?z>D?N:L:z>D?E:P)>0&&((y=w[V=Math.floor(_)+Math.floor(z)*(U+1)])?w[V].push(s):(w[V]=[s],j[V]=O))));for(s=0,n=(U+1)*(D+1);s<n;s++)if((y=w[s])&&y.length)for((b=j[s])>y.length&&(b=y.length),ca(y,p,b,r),H=0;H<b;H++)x=f[V=g[H]],g[H]=null,f[V]=null,S=x[0],!A&&x[6]?(R=x[5],G=x[8],r.rmap.addRectangle(R[0]+G[0],R[1]+G[1],R[0]+G[2],R[1]+G[3],x[7],x[0].lastSubJob),6==S.type?r.rmap.addLineLabel(S.lastSubJob,depthParams):r.rmap.addRectangle(R[0]+G[0],R[1]+G[1],R[0]+G[2],R[1]+G[3],x[7],S.lastSubJob,!0,depthParams)&&r.rmap.storeRemovedRectangle(R[0]+G[0],R[1]+G[1],R[0]+G[2],R[1]+G[3],x[7],x[0].lastSubJob)):S.hysteresis?r.jobHBuffer[S.id]=S:(r.drawnJobs++,6==S.type?a.drawGpuSubJobLineLabel(e,t,r,i,S.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,S.lastSubJob,null));T+=(P*=U*D)+(L*=U)+(E*=D)+N,c-=P+L+E+N,M*=2,F++}while(T<v)}},Sa=function(e,t,r,i,a){if(r.config.mapFeaturesReduceParams){var s,n,o,h,l,u,d,c,p,f=96*(window.devicePixelRatio||1),m=r.config.mapFeaturesReduceParams[0]*f,g=r.config.mapFeaturesReduceParams[1],v=r.curSize[0],y=r.curSize[1],b=(r.config.mapFeaturesSortByTop,r.drawAllLabels),x=r.gmap,S=r.gmapIndex,M=r.gmap2,w=1,T=r.gmap3,A=r.gmap3Size,C=(T=r.gmap3,1e4),F=0,P=r.config.mapFeaturesReduceFactor>=1;if(P){if(r.fmaxDist==Number.NEGATIVE_INFINITY||r.fminDist==Number.POSITIVE_INFINITY)return;var L=1-Math.log(r.fminDist)/Math.log(101),E=-Math.log(r.fmaxDist)/Math.log(101)}for(s=0,n=S;s<n;s++)(o=x[s])&&(h=o[5],P?(p=o[0].reduce,c=Math.round(((Math.log(p[1]+1)-Math.log(p[4]))/Math.log(101)-E)/(L-E)*1e4-5e3)+5e3,p[5]=c):c=Math.round(o[0].reduce[1]),c<0&&(c=0),c>=1e4&&(c=9999),c<C&&(C=c),c>F&&(F=c),T[c][A[c]++]=o);var N,B,I,k=1/m,R=Math.floor(v*k),_=Math.floor(y*k),z=r.gmapStore;r.gmapHit;for(s=0,n=(R+1)*(_+1)*2;s<n;s+=2)z[s]=0;var U,D,O,V,G,j=0;for(m*=m,s=F,n=C;s>=0;s--)if(A[s]>0){var H=T[s];for(U=0,D=A[s];U<D;U++){if(d=(o=H[U])[0],O=0,h=o[5],B=Math.floor(h[0]*k),z[N=2*((I=Math.floor(h[1]*k))*R+B)]){N=z[N];do{if(l=M[N][5],(V=h[0]-l[0])*V+(G=h[1]-l[1])*G<m&&++O>g)break;N=M[N+1]}while(N)}O<=g&&(N=j,!b&&o[6]?(h=o[5],u=o[8],6==d.type?r.rmap.addLineLabel(d.lastSubJob,null)&&j++:r.rmap.addRectangle(h[0]+u[0],h[1]+u[1],h[0]+u[2],h[1]+u[3],o[7],d.lastSubJob,!0,null)&&j++):(d.hysteresis?r.jobHBuffer[d.id]=d:(r.drawnJobs++,6==d.type?a.drawGpuSubJobLineLabel(e,t,r,i,d.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,d.lastSubJob,null)),j++),N!=j&&(w=pa(0,o,B,I,R,_,z,M,w)))}A[s]=0}}},Ma=function(e,t,r,i,a){if(r.config.mapFeaturesReduceParams){window.devicePixelRatio,r.curSize[0],r.curSize[1],r.config.mapFeaturesSortByTop;var s,n,o,h,l,u,d,c,p,f,m=r.drawAllLabels,g=r.gmap,v=r.gmapIndex,y=(r.gmap2,r.gmap3),b=r.gmap3Size,x=(y=r.gmap3,1e4),S=0,M=r.config.mapFeaturesReduceFactor>=1;if(M){if(r.fmaxDist==Number.NEGATIVE_INFINITY||r.fminDist==Number.POSITIVE_INFINITY)return;var w=1-Math.log(r.fminDist)/Math.log(101),T=-Math.log(r.fmaxDist)/Math.log(101)}for(s=0,n=v;s<n;s++)(o=g[s])&&(h=o[5],M?(c=o[0].reduce,d=Math.round(((Math.log(c[1]+1)-Math.log(c[4]))/Math.log(101)-T)/(w-T)*1e4-5e3)+5e3,c[5]=d):d=Math.round(o[0].reduce[1]),d<0&&(d=0),d>=1e4&&(d=9999),d<x&&(x=d),d>S&&(S=d),y[d][b[d]++]=o);for(s=S,n=x;s>=0;s--)if(b[s]>0){var A=y[s];for(p=0,f=b[s];p<f;p++)u=(o=A[p])[0],h=o[5],!m&&o[6]?(h=o[5],l=o[8],6==u.type?r.rmap.addLineLabel(u.lastSubJob,null):r.rmap.addRectangle(h[0]+l[0],h[1]+l[1],h[0]+l[2],h[1]+l[3],o[7],u.lastSubJob,!0,null)):u.hysteresis?r.jobHBuffer[u.id]=u:(r.drawnJobs++,6==u.type?a.drawGpuSubJobLineLabel(e,t,r,i,u.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,u.lastSubJob,null));b[s]=0}}},wa=function(e,t,r,i,a){if(r.config.mapFeaturesReduceParams){var s,n,o,h,l,u=r.config.mapFeaturesReduceParams[1],d=96*(window.devicePixelRatio||1),c=r.curSize[0],p=r.curSize[1],f=Math.ceil(c/d*(p/d)*u),m=(r.config.mapFeaturesSortByTop,0),g=r.drawAllLabels,v=0!=r.config.mapFeaturesReduceFactor2,y=-r.config.mapFeaturesReduceFactor3,b=null;r.debugStr="<br>featuresPerScr: "+f;var x=r.gmap,S=r.gmapIndex;for(g&&(f=S),fa(r,x,S,r.gmap2),s=S-1;s>=0;s--)if(n=(o=x[s])[0],!g&&o[6]){if(h=o[5],l=o[8],b=v?[h[0],h[1]+o[1],n.reduce,y]:null,6==n.type?r.rmap.addLineLabel(n.lastSubJob,b)&&m++:r.rmap.addRectangle(h[0]+l[0],h[1]+l[1],h[0]+l[2],h[1]+l[3],o[7],n.lastSubJob,!0,b)&&m++,m>=f)return}else n.hysteresis?r.jobHBuffer[n.id]=n:(r.drawnJobs++,6==n.type?a.drawGpuSubJobLineLabel(e,t,r,i,n.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,n.lastSubJob,null))}},Ta=function(e,t,r,i,a){if(r.config.mapFeaturesReduceParams){var s=r.config.mapFeaturesReduceParams[5],n=r.config.mapFeaturesReduceParams[1],o=96*(window.devicePixelRatio||1),h=r.curSize[0],l=r.curSize[1],u=Math.ceil(h/o*(l/o)*n),d=u/(s*s),c=Math.floor(d),p=d-c,f=h/s,m=l/s;r.debugStr="<br>featuresPerScr: "+u+"<br>featuresPerTile: "+d.toFixed(2);r.config.mapFeaturesSortByTop;var g,v,y,b=0,x=0!=r.config.mapFeaturesReduceFactor2,S=-r.config.mapFeaturesReduceFactor3,M=null,w=r.gmap,T=r.gmapIndex,A=r.gmap2,C=0,F=r.gmap4,P=r.drawAllLabels;if(P&&(u=T),T>0)if(fa(r,w,T,A),P)for(g=T-1;g>=0;g--)y=(N=w[g])[0],N[0].hysteresis?r.jobHBuffer[N[0].id]=y:(r.drawnJobs++,6==(y=N[0]).type?a.drawGpuSubJobLineLabel(e,t,r,i,y.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,y.lastSubJob,null));else{var L,E,N,B,I,k,R,_,z,U,D,O,V=r.gmapHit;B=h/f,I=l/m,z=Math.round(B),U=Math.round(I);V=r.gmapStore,r.gmapHit;for(g=0,v=z*U;g<v;g++)V[g]=null,F[g]=null;for(g=T-1;g>=0;g--)(N=w[g])&&((k=N[5])[0]<30||k[0]>=h-30||k[1]<30||k[1]>=l-30?w[g]=null:(R=k[0]/f,_=k[1]/m,(L=V[D=Math.floor(R)+Math.floor(_)*z])?V[D].push(g):V[D]=[g]));for(g=0,v=z*U;g<v;g++)(L=V[g])&&L.length&&(0==(E=L.length)?F[g]=null:(E>c?(J=(N=w[D=L[E=c]])[0].reduce[6],L.length>E+1&&(J+=((N=w[D=L[E+1]])[0].reduce[6]-J)*p)):J=(N=w[D=L[E-1]])[0].reduce[6],F[g]=J));for(function e(t,r,i){for(var a,s,n,o,h,l,u=0,d=r-1,c=i-1,p=0,f=i;p<f;p++)for(var m=0,g=r;m<g;m++)if(null===t[p*r+m]){n=m,o=p,(a=m-1)<0&&(a=0),(s=p-1)<0&&(s=0),(h=m+1)>d&&(h=d),(l=p+1)>c&&(l=c);for(var v=[t[s*r+a],t[s*r+n],t[s*r+h],t[o*r+a],t[o*r+h],t[l*r+a],t[l*r+n],t[l*r+h]],y=0,b=0,x=0;x<8;x++)null!==v[x]&&(y++,b+=v[x]);0!=y?t[p*r+m]=b/y:u++}0!=u&&u!=r*i&&e(t,r,i)}(F,z,U),g=T-1;g>=0;g--)if(N=w[g]){J=(y=N[0]).reduce[6];var G=ma(F,(k=N[5])[0]/f,k[1]/m,z,U);J>=G?/*!drawAllLabels &&*/N[6]?(k=N[5],O=N[8],M=x?[k[0],k[1]+N[1],y.reduce,S]:null,6==y.type?r.rmap.addLineLabel(y.lastSubJob,M)&&b++:r.rmap.addRectangle(k[0]+O[0],k[1]+O[1],k[0]+O[2],k[1]+O[3],N[7],y.lastSubJob,!0,M)&&b++):y.hysteresis?r.jobHBuffer[y.id]=y:(r.drawnJobs++,6==y.type?a.drawGpuSubJobLineLabel(e,t,r,i,y.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,y.lastSubJob,null)):(N[0].delta=Math.abs(G-J),A[C]=N,C++)}if(b<u&&C>0)for(function(e,t,r,i){var a,s,n,o=r<65536?e.radixCountBuffer16:e.radixCountBuffer32,h=e.buffUint32,l=e.buffFloat32;if(o.fill)o.fill(0);else for(n=0;n<1024;n++)o[n]=0;for(n=0;n<r;n++)a=t[n],l[0]=a[0].delta,s=h[0],a[0].delta=s,o[255&s]++,o[256+(s>>8&255)]++,o[512+(s>>16&255)]++,o[768+(s>>24&255)]++;for(var u=0;u<4;u++){var d=0,c=0,p=256*u;for(n=0;n<256;n++)d=o[n+p],o[n+p]=c,c+=d}for(n=0;n<r;n++)i[o[255&(s=(a=t[n])[0].delta)]++]=a;for(n=0;n<r;n++)t[o[256+((s=(a=i[n])[0].delta)>>8&255)]++]=a;for(n=0;n<r;n++)i[o[512+((s=(a=t[n])[0].delta)>>16&255)]++]=a;for(n=0;n<r;n++)t[o[768+((s=(a=i[n])[0].delta)>>24&255)]++]=a}(r,A,C,w),g=C-1;g>=0&&(y=(N=A[g])[0],/*!drawAllLabels &&*/N[6]?(k=N[5],O=N[8],M=x?[k[0],k[1]+N[1],y.reduce,S]:null,6==y.type?r.rmap.addLineLabel(y.lastSubJob,M)&&b++:r.rmap.addRectangle(k[0]+O[0],k[1]+O[1],k[0]+O[2],k[1]+O[3],N[7],y.lastSubJob,!0,M)&&b++):y.hysteresis?r.jobHBuffer[y.id]=y:(r.drawnJobs++,6==y.type?a.drawGpuSubJobLineLabel(e,t,r,i,y.lastSubJob,null):a.drawGpuSubJob(e,t,r,i,y.lastSubJob,null)),!(b>=u));g--);}if(r.drawGridCells){e.setState(r.lineLabelState);var j,H,q=0,W=0;for(j=0,H=U;j<H;j++)for(g=0,v=z;g<v;g++){q=f*g,W=m*j;var J=F[j*z+g];a.drawLineString([[q,W,.5],[q+f,W,.5],[q+f,W+m,.5],[q,W+m,.5]],!0,1,[0,0,255,255],null,!0,null,null,null),J&&a.drawText(Math.round(q+5),Math.round(W+5),11,""+J.toFixed(2),[255,255,255,255],.5)}}}},Aa=function(e,t,r,i){var a,s,n,o=r<65536?e.radixCountBuffer16:e.radixCountBuffer32,h=e.buffUint32,l=e.buffFloat32;if(e.config.mapFeaturesReduceFactor,o.fill)o.fill(0);else for(n=0;n<1024;n++)o[n]=0;for(n=0;n<r;n++)s=1-(a=t[n]).lastSubJob[5][2],l[0]=s,s=h[0],a.depth=s,o[255&s]++,o[256+(s>>8&255)]++,o[512+(s>>16&255)]++,o[768+(s>>24&255)]++;for(var u=0;u<4;u++){var d=0,c=0,p=256*u;for(n=0;n<256;n++)d=o[n+p],o[n+p]=c,c+=d}for(n=0;n<r;n++)i[o[255&(s=(a=t[n]).depth)]++]=a;for(n=0;n<r;n++)t[o[256+((s=(a=i[n]).depth)>>8&255)]++]=a;for(n=0;n<r;n++)i[o[512+((s=(a=t[n]).depth)>>16&255)]++]=a;for(n=0;n<r;n++)t[o[768+((s=(a=i[n]).depth)>>24&255)]++]=a;return t},Ca=function(e){this.renderer=e,this.core=e.core,this.gpu=e.gpu,this.gl=e.gpu.gl,this.rmap=e.rmap,this.mBuffer=new Float32Array(16),this.mBuffer2=new Float32Array(16),this.vBuffer=new Float32Array(4)};function Fa(e,t,r,i){var a,s,n,o,h,l=e[0],u=e[1],d=e[2],c=e[3],p=t[0],f=t[1],m=t[2],g=t[3];return(s=l*p+u*f+d*m+c*g)<0&&(s=-s,p=-p,f=-f,m=-m,g=-g),1-s>1e-6?(a=Math.acos(s),n=Math.sin(a),o=Math.sin((1-r)*a)/n,h=Math.sin(r*a)/n):(o=1-r,h=r),i[0]=o*l+h*p,i[1]=o*u+h*f,i[2]=o*d+h*m,i[3]=o*c+h*g,i}Ca.prototype.drawSkydome=function(e,t){if(e){var r=this.gpu,i=this.gl,a=this.renderer,s=ya.create();ya.multiply(ba.scaleMatrix(2,2,2),ba.translationMatrix(-.5,-.5,-.5),s);var n=ya.create(),o=a.camera.getPosition();ya.multiply(ba.translationMatrix(o[0],o[1],o[2]-400),ba.scaleMatrixf(Math.min(.9*a.camera.getFar(),6e5)),n);var h=ya.create();ya.multiply(a.camera.getMvpMatrix(),n,h),ya.multiply(h,s,h),r.useProgram(t,["aPosition","aTexCoord"]),r.bindTexture(e),t.setSampler("uSampler",0),t.setMat4("uMVP",h),i.depthMask(!1),a.skydomeMesh.draw(t,"aPosition","aTexCoord"),i.depthMask(!0),i.enable(i.CULL_FACE),a.renderedPolygons+=a.skydomeMesh.getPolygons()}},Ca.prototype.drawTBall=function(e,t,r,i,a,s){var n=this.gpu,o=(this.gl,this.renderer),h=ya.create();ya.multiply(ba.scaleMatrix(2,2,2),ba.translationMatrix(-.5,-.5,-.5),h);var l=[e[0],e[1],e[2]];t=null!=t?t:1.5;var u=ya.create();ya.multiply(ba.translationMatrix(l[0],l[1],l[2]),ba.scaleMatrix(t,t,a||t),u);var d=ya.create();ya.multiply(o.camera.getMvpMatrix(),u,d),ya.multiply(d,h,d),n.useProgram(r,["aPosition","aTexCoord"]),n.bindTexture(i||o.redTexture),r.setSampler("uSampler",0),r.setMat4("uMVP",d),o.skydomeMesh.draw(r,"aPosition","aTexCoord"),o.renderedPolygons+=o.skydomeMesh.getPolygons()},Ca.prototype.drawBall=function(e,t,r,i,a,s,n,o,h,l){var u=this.gpu,d=this.gl,c=this.renderer,p=ya.create();ya.multiply(ba.scaleMatrix(2,2,2),ba.translationMatrix(-.5,-.5,-.5),p);var f=[e[0],e[1],e[2]],m=ya.create();t=t||1.5,r=r||1.5,ya.multiply(ba.translationMatrix(f[0],f[1],f[2]),ba.scaleMatrix(t,t,r),m);var g=ya.create();ya.multiply(c.camera.getModelviewMatrix(),m,g),ya.multiply(g,p,g);var v=c.camera.getProjectionMatrix(),y=[0,0,0,0,0,0,0,0,0];ya.toInverseMat3(g,y),va.transpose(y),u.useProgram(i,["aPosition"]),i.setMat4("uProj",v),i.setMat4("uMV",g),l&&(i.setMat3("uNorm",y),d.cullFace(d.FRONT)),a&&i.setVec4("uParams",a),s&&i.setVec4("uParams2",s),s&&i.setVec4("uParams3",n),o&&i.setVec4("uFogColor",o),h&&i.setVec4("uFogColor2",h),c.atmoMesh.draw(i,"aPosition",null),c.renderedPolygons+=c.skydomeMesh.getPolygons(),l&&d.cullFace(d.BACK)},Ca.prototype.drawBall2=function(e,t,r,i,a,s){var n=this.gpu,o=this.renderer,h=ya.create();ya.multiply(ba.scaleMatrix(2,2,2),ba.translationMatrix(-.5,-.5,-.5),h);var l=[e[0],e[1],e[2]],u=ya.create();ya.multiply(ba.translationMatrix(l[0],l[1],l[2]),ba.scaleMatrixf(null!=t?t:1.5),u);var d=ya.create();ya.multiply(o.camera.getModelviewMatrix(),u,d),ya.multiply(d,h,d);var c=o.camera.getProjectionMatrix(),p=[0,0,0,0,0,0,0,0,0];ya.toInverseMat3(d,p),va.transpose(p),n.useProgram(r,["aPosition"]),n.bindTexture(o.redTexture),r.setSampler("uSampler",0),r.setMat4("uProj",c),r.setMat4("uMV",d),r.setMat3("uNorm",p),r.setFloat("uNFactor",i),r.setVec3("uCenter",e),r.setVec2("uRadius",[t,s]),o.atmoMesh.draw(r,"aPosition",null),o.renderedPolygons+=o.skydomeMesh.getPolygons()},Ca.prototype.drawLineString=function(e,t,r,i,a,s,n,o,h){var l,u,d=this.gpu,c=(this.gl,this.renderer),p=0,f=e.length;if(f>32)for(u=0;u<f;u+=31)l=e.slice(u,u+32),this.drawLineString(l,t,r,i,a,s,n,o,h);else{var m=c.plineBuffer;if(t)for(u=0;u<f;u++)l=e[u],m[p]=l[0],m[p+1]=l[1],m[p+2]=l[2]||0,p+=3;else{c.camera.getMvpMatrix(),c.curSize;var g=c.cameraPosition;for(u=0;u<f;u++)l=e[u],m[p]=l[0]-g[0],m[p+1]=l[1]-g[1],m[p+2]=l[2]-g[2],p+=3}if(!0!==h){var v=d.currentState;d.setState({ztest:!(!0!==s),blend:!0===n,zwrite:!(!1===o),stencil:!1,culling:!1,zequal:!1})}var y=t?c.progLine4:c.progLine5;d.useProgram(y,["aPosition"]),t?y.setMat4("uMVP",c.imageProjectionMatrix,a?c.getZoffsetFactor(a):null):(y.setMat4("uMV",c.camera.getModelviewFMatrix(),null),y.setMat4("uProj",c.camera.getProjectionFMatrix(),null)),y.setVec3("uScale",[2/c.curSize[0],2/c.curSize[1],.5*r]),y.setVec4("uColor",null!=i?i:[1,1,1,1]),y.setVec3("uPoints",m),c.plines.draw(y,"aPosition",f),!0!==h&&d.setState(v)}},Ca.prototype.drawCircle=function(e,t,r,i,a,s,n,o,h){for(var l=[],u=0,d=2*Math.PI/16,c=0;c<16;c++)l[c]=[-Math.sin(u)*t+e[0],Math.cos(u)*t+e[1],e[2]],u+=d;l[16]=[e[0],t+e[1],e[2]],this.drawLineString(l,!0,r,i,a,s,n,o,h)},Ca.prototype.drawImage=function(e,t,r,i,a,s,n,o,h,l,u,d){var c=this.gpu,p=this.gl,f=this.renderer;if(null!=a&&null!=f.imageProjectionMatrix){if(!0!==d){var m=c.currentState;c.setState({ztest:!(!0!==h),blend:!0===l,zwrite:!(!1===u),stencil:!1,culling:!1,zequal:!1})}var g=f.progImage;c.useProgram(g,["aPosition"]),c.bindTexture(a);var v=f.rectVerticesBuffer;p.bindBuffer(p.ARRAY_BUFFER,v),p.vertexAttribPointer(g.getAttribute("aPosition"),v.itemSize,p.FLOAT,!1,0,0);var y=f.rectIndicesBuffer;p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,y),g.setMat4("uProjectionMatrix",f.imageProjectionMatrix),g.setMat4("uData",[e,t,0,0,e+r,t,1,0,e+r,t+i,1,1,e,t+i,0,1]),o&&(n*=1+2*f.getZoffsetFactor(o)),g.setVec4("uColor",null!=s?s:[1,1,1,1]),g.setFloat("uDepth",n),p.drawElements(p.TRIANGLES,y.numItems,p.UNSIGNED_SHORT,0),!0!==d&&c.setState(m)}},Ca.prototype.drawBillboard=function(e,t,r,i,a,s,n,o){var h=this.gpu,l=this.gl,u=this.renderer;if(!0!==o){var d=h.currentState;h.setState({ztest:!(!0!==a),blend:!0===s,zwrite:!(!1===n),stencil:!1,culling:!1,zequal:!1})}var c=u.progImage;h.useProgram(c,["aPosition","aTexCoord"]),h.bindTexture(t),c.setSampler("uSampler",0);var p=u.rectVerticesBuffer;l.bindBuffer(l.ARRAY_BUFFER,p),l.vertexAttribPointer(c.getAttribute("aPosition"),p.itemSize,l.FLOAT,!1,0,0);var f=u.rectIndicesBuffer;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,f),c.setMat4("uProjectionMatrix",e,i?u.getZoffsetFactor(i):null);c.setMat4("uData",[0,0,0,0,1,0,1,0,1,1,1,1,0,1,0,1]),c.setVec4("uColor",null!=r?r:[1,1,1,1]),c.setFloat("uDepth",0),l.drawElements(l.TRIANGLES,f.numItems,l.UNSIGNED_SHORT,0),!0!==o&&h.setState(d)},Ca.prototype.drawFlatImage=function(e,t,r,i,a,s,n,o){var h=this.gpu,l=this.gl,u=this.renderer;if(null!=a&&null!=u.imageProjectionMatrix){var d=u.progImage;h.useProgram(d,["aPosition"]),h.bindTexture(a);var c=u.rectVerticesBuffer;l.bindBuffer(l.ARRAY_BUFFER,c),l.vertexAttribPointer(d.getAttribute("aPosition"),c.itemSize,l.FLOAT,!1,0,0);var p=u.rectIndicesBuffer;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,p),d.setMat4("uProjectionMatrix",u.imageProjectionMatrix),d.setMat4("uData",[e,t,0,0,e+r,t,1,0,e+r,t+i,1,1,e,t+i,0,1]),d.setVec4("uColor",null!=s?s:[1,1,1,1]),d.setFloat("uDepth",null!=n?n:0),l.drawElements(l.TRIANGLES,p.numItems,l.UNSIGNED_SHORT,0)}},Ca.prototype.drawText=function(e,t,r,i,a,s,n){var o=this.gpu,h=this.gl,l=this.renderer;if(null!=l.imageProjectionMatrix){if(!0!==n){var u=o.currentState;o.setState({ztest:!(null==s),blend:!1,zwrite:!(null==s),stencil:!1,culling:!1,zequal:!(null==s)})}var d=l.progImage;o.useProgram(d,["aPosition"]),o.bindTexture(l.textTexture2);var c=l.rectVerticesBuffer;h.bindBuffer(h.ARRAY_BUFFER,c),h.vertexAttribPointer(d.getAttribute("aPosition"),c.itemSize,h.FLOAT,!1,0,0);var p=l.rectIndicesBuffer;h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,p),d.setMat4("uProjectionMatrix",l.imageProjectionMatrix),d.setVec4("uColor",a),d.setFloat("uDepth",null!=s?s:0);var f=r-1,m=r,g=Math.round(.5*r),v=this.getTextSize(r,i)+2,y=0,b=(15&y)<<4,x=y>>4<<4;d.setMat4("uData",[e-2,t-2,b*(1/256),x*(1/128),e-2+v,t-2,(b+15)*(1/256),x*(1/128),e-2+v,t+m+1,(b+15)*(1/256),(x+15)*(1/128),e-2,t+m+1,b*(1/256),(x+15)*(1/128)]),h.drawElements(h.TRIANGLES,p.numItems,h.UNSIGNED_SHORT,0);for(var S=0,M=i.length;S<M;S++){switch(b=(15&(y=i.charCodeAt(S)-32))<<4,x=y>>4<<4,y){case 12:case 14:case 27:case 28:case 64:case 73:case 76:case 84:d.setMat4("uData",[e,t,b*(1/256),x*(1/128),e+g,t,(b+8)*(1/256),x*(1/128),e+g,t+m,(b+8)*(1/256),(x+16)*(1/128),e,t+m,b*(1/256),(x+16)*(1/128)]),e+=g;break;default:d.setMat4("uData",[e,t,b*(1/256),x*(1/128),e+f,t,(b+15)*(1/256),x*(1/128),e+f,t+m,(b+15)*(1/256),(x+16)*(1/128),e,t+m,b*(1/256),(x+16)*(1/128)]),e+=f}h.drawElements(h.TRIANGLES,p.numItems,h.UNSIGNED_SHORT,0)}!0!==n&&o.setState(u)}},Ca.prototype.getTextSize=function(e,t){for(var r=e-1,i=Math.round(.5*e),a=0,s=0,n=t.length;s<n;s++){switch(t.charCodeAt(s)-32){case 12:case 14:case 27:case 28:case 64:case 73:case 76:case 84:a+=i;break;default:a+=r}}return a},Ca.prototype.drawGpuJobs=function(){var e=this.gpu,t=this.gl,r=this.renderer,i=r.config.mapSortHysteresis,a=r.config.mapHysteresisWait;r.geoRenderCounter++,r.totalJobs=0,r.drawnJobs=0,r.jobsTimer4=0,r.jobsTimer3=0,r.jobsTimer2=0,r.jobsTimer1=performance.now(),t.stencilMask(255),t.clear(t.STENCIL_BUFFER_BIT),t.stencilFunc(t.EQUAL,0,255),t.stencilOp(t.KEEP,t.KEEP,t.INCR);var s,n=[1/r.curSize[0],1/r.curSize[1]],o=this.rmap,h=513,l=0,u=r.clearStencilPasses,d=r.jobZBuffer,c=r.jobZBufferSize,p=r.jobZBuffer2,f=r.jobZBuffer2Size,m=r.onlyHitLayers,g=r.onlyAdvancedHitLayers,v=r.geoRenderCounter,y=r.onlyHitLayers,b=r.jobHSortBuffer,x=0;u.length>0&&(h=u[0],l++),this.rmap.counter!=this.renderer.geoRenderCounter&&this.rmap.clear(),r.gmapIndex=0,r.gmapUseVersion=1;for(var S=!1,M=r.frameTime,w=0,T=d.length;w<T;w++){var A,C=c[w],F=f[w],P=d[w],L=p[w];if(r.jobHBuffer={},r.totalJobs+=C,C>0&&w>=h&&(t.clear(t.STENCIL_BUFFER_BIT),u.length>l?(h=u[l],l++):h=513),m)if(g)for(A=0;A<C;A++)P[A].advancedHit&&this.drawGpuJob(e,t,r,P[A],n,!0);else for(A=0;A<C;A++){var E;(E=P[A]).hitable&&(this.drawGpuJob(e,t,r,E,n),E.advancedHit&&(r.advancedPassNeeded=!0))}else for(A=0;A<C;A++)E=P[A],this.drawGpuJob(e,t,r,E,n);if(r.jobsTimer3=performance.now(),r.gmapIndex>0){switch(r.gmapUseVersion){case 1:xa(e,t,r,n,this);break;case 2:Sa(e,t,r,n,this);break;case 3:Ma(e,t,r,n,this);break;case 4:wa(e,t,r,n,this);break;case 5:Ta(e,t,r,n,this)}r.gmapIndex=0}(o.rectanglesCount>0||o.rectangles2Count>0)&&o.processRectangles(e,t,r,n),r.jobsTimer4+=performance.now()-r.jobsTimer3,F=!1;var N=r.jobHBuffer;for(s in N){F=!0;break}for(s in L){F=!0;break}if(F){if(!y)for(s in N)if((E=N[s]).hysteresis&&E.id){var B=L[E.id];B?E==B?B.hysteresisCounter=r.geoRenderCounter:B.hysteresisBackup=E:(E.timerShow=0,E.timerHide=0,E.draw=!1,E.hysteresisCounter=r.geoRenderCounter,L[E.id]=E,f[w]++,S=!0),!0}for(s in L){E=L[s],B=N[s],r.drawnJobs++,y||(B?(isNaN(E.timerShow)&&(E.timerShow=0,E.timerHide=0,E.draw=!1),E.draw?E.timerHide&&(E.draw=!1,E.timerShow=a+E.hysteresis[0]*(1-E.timerHide/E.hysteresis[1])):(E.timerShow+=M,E.timerShow-a>E.hysteresis[0]?(E.draw=!0,E.timerShow=0):S=!0),E.timerHide=0):(E.draw?(E.timerHide+=M,E.timerHide>E.hysteresis[1]?(delete L[s],f[w]--,E.draw=!1,E.timerHide=0):S=!0):E.timerShow&&(E.draw=!0,E.timerHide=E.hysteresis[1]*(1-(E.timerShow-a)/E.hysteresis[0])),E.timerShow=0));var I=E.draw,k=null;if(y||!0!==E.hysteresis[3]||(I?0!=E.timerHide&&(k=E.timerHide/(E.hysteresis[1]+1),k=1-Math.min(1,k)):0!=E.timerShow&&E.timerShow-a>0&&(k=(E.timerShow-a)/(E.hysteresis[0]+1),k=Math.min(1,k),I=!0)),I){if(E.hysteresisCounter!=r.geoRenderCounter&&E.hysteresisBackup){var R=E.hysteresisBackup;L[s]=R,R.timerShow=E.timerShow,R.timerHide=E.timerHide,R.draw=E.draw,E=R}if(E.renderCounter[0][0]!==v&&null!==E.renderCounter[0][0]){E.updatePos=!0;var _=E.renderCounter[0],z=ya.create(),U=ya.create(),D=_[3].bbox,O=r.cameraPosition,V=ba.translationMatrix(D.min[0]-O[0],D.min[1]-O[1],D.min[2]-O[2]);ya.multiply(r.camera.getModelviewMatrix(),V,U);var G=r.camera.getProjectionMatrix();ya.multiply(G,U,z),E.mv=U,E.mvp=z}if(i)E.fade=k,b[x]=E,x++;else{switch(E.type){case 10:r.viewExtent;if(q=E.vswitch[E.vswitchIndex])for(var j=0,H=(q=q[1]).length;j<H;j++){(W=q[j]).updatePos=E.updatePos,W.mvp=E.mvp,W.mv=E.mv,this.drawGpuSubJob(e,t,r,n,W.lastSubJob,k)}break;case 6:this.drawGpuSubJobLineLabel(e,t,r,n,E.lastSubJob,k);break;default:this.drawGpuSubJob(e,t,r,n,E.lastSubJob,k)}E.updatePos=!1}}E.hysteresisBackup=null}}}if(i&&x)for(Aa(r,b,x,r.gmap2),w=0;w<x;w++){switch((E=b[w]).type){case 10:var q;r.viewExtent;if(q=E.vswitch[E.vswitchIndex])for(j=0,H=(q=q[1]).length;j<H;j++){var W;(W=q[j]).updatePos=E.updatePos,W.mvp=E.mvp,W.mv=E.mv,this.drawGpuSubJob(e,t,r,n,W.lastSubJob,E.fade)}break;case 6:this.drawGpuSubJobLineLabel(e,t,r,n,E.lastSubJob,E.fade);break;default:this.drawGpuSubJob(e,t,r,n,E.lastSubJob,E.fade)}E.updatePos=!1}S&&this.core.markDirty(),r.jobsTimer2=performance.now()},Ca.prototype.clearJobBuffer=function(){for(var e=this.renderer,t=e.jobZBuffer,r=e.jobZBufferSize,i=0,a=t.length;i<a;i++){for(var s=r[i],n=t[i],o=0;o<s;o++)n[o]=null;r[i]=0}},Ca.prototype.clearJobHBuffer=function(){for(var e=this.renderer,t=e.jobZBuffer2,r=e.jobZBuffer2Size,i=0,a=t.length;i<a;i++)t[i]={},r[i]=0},Ca.prototype.paintGL=function(){var e=this.renderer;this.gpu.clear(!0,!1),e.onlyLayers||e.onlyDepth||e.onlyHitLayers||this.drawSkydome()},Ca.prototype.processNoOverlap=function(e,t,r,i,a,s,n,o,h,l,u){var d={exit:!0},c=t.reduce&&t.reduce[0]>=7&&t.reduce[0]<=11;if(!e.drawAllLabels&&t.noOverlap){r||(r=e.project2(t.center2,e.camera.mvp,e.cameraPosition,!0)),d.pp=r;var p=t.noOverlap,f=r[2];if(f<0||f>1)return d;if(6==t.type){if(e.benevolentMargins){if(!e.rmap.checkRectangle(r[0]-200,r[1]-200,r[0]+200,r[1]+200,0))return d}else if(!e.rmap.checkRectangle(r[0],r[1],r[0],r[1],0))return d}else if(!e.rmap.checkRectangle(r[0]+p[0],r[1]+p[1],r[0]+p[2],r[1]+p[3],o))return d;if(null!==p[4]&&(0===p[4]?f=p[5]:(null===n&&(a=t.center2,i=e.cameraPosition,s=[a[0]-i[0],a[1]-i[1],a[2]-i[2]],n=ga.length(s)+1e-4),t.reduce&&(!t.reduce||t.reduce[0]>=8&&t.reduce[0]<=11)||(f=p[5]/n))),t.lastSubJob=[t,o,h,l,u,r,!0,f,p],c)return e.gmapUseVersion=t.reduce[0]>=8&&t.reduce[0]<=11?t.reduce[0]-6:1,e.gmap[e.gmapIndex]=t.lastSubJob,e.gmapIndex++,e.config.mapFeaturesReduceFactor>=1&&(null===n&&(a=t.center2,i=e.cameraPosition,s=[a[0]-i[0],a[1]-i[1],a[2]-i[2]],n=ga.length(s)+1e-4),n>e.fmaxDist&&(e.fmaxDist=n),n<e.fminDist&&(e.fminDist=n),t.reduce[1]=t.reduce[2],t.reduce[4]=n),d;if(6==t.type){if(!e.rmap.addLineLabel(t.lastSubJob))return d}else if(!e.rmap.addRectangle(r[0]+p[0],r[1]+p[1],r[0]+p[2],r[1]+p[3],f,t.lastSubJob))return e.rmap.storeRemovedRectangle(r[0]+p[0],r[1]+p[1],r[0]+p[2],r[1]+p[3],f,t.lastSubJob),d;return d}return c?(r||(r=e.project2(t.center2,e.camera.mvp,e.cameraPosition,!0)),t.lastSubJob=[t,o,h,l,u,r,!1],e.gmapUseVersion=t.reduce[0]>=8&&t.reduce[0]<=11?t.reduce[0]-6:1,e.gmap[e.gmapIndex]=t.lastSubJob,e.gmapIndex++,e.config.mapFeaturesReduceFactor>=1&&(null===n&&(a=t.center2,i=e.cameraPosition,s=[a[0]-i[0],a[1]-i[1],a[2]-i[2]],n=ga.length(s)+1e-4),n>e.fmaxDist&&(e.fmaxDist=n),n<e.fminDist&&(e.fminDist=n),t.reduce[1]=t.reduce[2],t.reduce[4]=n),d.pp=r,d):t.hysteresis&&t.id?(r||(r=e.project2(t.center2,e.camera.mvp,e.cameraPosition,!0)),t.lastSubJob=[t,o,h,l,u,r],e.jobHBuffer[t.id]=t,d.pp=r,d):(d.pp=r,d.exit=!1,d)},Ca.prototype.drawGpuJob=function(e,t,r,i,a,s,n){if(i.ready&&i.eventInfo){var o=255&i.state,h=i.eventInfo["#id"];if(null!=h){if(512&i.state){if(-1!=r.geodataSelection.indexOf(h)){if(768&i.state)if(r.hoverFeature&&r.hoverFeature[0]["#id"]==h){if(3!=o)return}else if(2!=o)return}else if(256&i.state){if(r.hoverFeature&&r.hoverFeature[0]["#id"]==h){if(1!=o)return}else if(0!=o)return}else if(0!=o)return}else if(256&i.state){if(r.hoverFeature&&r.hoverFeature[0]["#id"]==h){if(1!=o)return}else if(0!=o)return}else if(0!=o)return}else if(0!=o)return;var l,u,d,c,p,f,m,g,v=i.mvp,y=i.hitable&&r.onlyHitLayers,b=i.color,x=r.useSuperElevation;if(y){var S=r.hoverFeatureCounter;b=[(255&S)/255,(S>>8&255)/255,0,0],r.hoverFeatureList[S]=[i.eventInfo,i.center,i.clickEvent,i.hoverEvent,i.enterEvent,i.leaveEvent,s],r.hoverFeatureCounter++}switch(i.type){case 1:case 11:11==i.type?y?i.stencil?e.setState(i.culling?r.polygonB0S1C1tate:r.polygonB0S1C0tate):e.setState(i.culling?r.polygonB0S0C1tate:r.polygonB0S0C0tate):i.stencil?e.setState(i.culling?r.polygonB1S1C1tate:r.polygonB1S1C0tate):e.setState(i.culling?r.polygonB1S0C1tate:r.polygonB1S0C0tate):e.setState(y?r.stencilLineHitState:r.stencilLineState);var M=0===e;l=x?s?i.program2:r.progLineSE:s?i.program2:M?r.progLineWireframe:i.program;var w=!s&&11==i.type&&1==i.style;if(w&&(l=x?r.progCFlatShadeTileSE:r.progCFlatShadeTile),e.useProgram(l,s?["aPosition","aElement"]:M?["aPosition","aBarycentric"]:["aPosition"]),x){var T=this.mBuffer,A=r.superElevation;T[0]=i.bbox.min[0],T[1]=i.bbox.min[1],T[2]=i.bbox.min[2],T[3]=1,T[4]=1,T[5]=1,T[9]=A[0],T[10]=A[1],T[11]=A[2],T[12]=A[6],T[13]=A[5],T[14]=r.earthRadius,T[15]=r.earthERatio,l.setMat4("uParamsSE",T)}if(w?(l.setMat4("uMV",i.mv),l.setMat4("uProj",r.camera.getProjectionFMatrix(),r.getZoffsetFactor(i.zbufferOffset)),l.setVec4("uColor",b)):(l.setMat4("uMVP",v,r.getZoffsetFactor(i.zbufferOffset)),l.setVec4("uColor",b)),xe=l.getAttribute("aPosition"),t.bindBuffer(t.ARRAY_BUFFER,i.vertexPositionBuffer),t.vertexAttribPointer(xe,i.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),s&&(m=l.getAttribute("aElement"),t.bindBuffer(t.ARRAY_BUFFER,i.vertexElementBuffer),t.vertexAttribPointer(m,i.vertexElementBuffer.itemSize,t.FLOAT,!1,0,0)),M){var C=l.getAttribute("aBarycentric");t.bindBuffer(t.ARRAY_BUFFER,e.barycentricBuffer),t.vertexAttribPointer(C,e.barycentricBuffer.itemSize,t.FLOAT,!1,0,0)}if(t.drawArrays(t.TRIANGLES,0,i.vertexPositionBuffer.numItems),r.debug.drawPolyWires){var F=x?r.progWireFrameBasicSE:r.progWireFrameBasic;r.gpu.useProgram(F,["aPosition"]),x&&F.setMat4("uParamsSE",T),F.setMat4("uMV",i.mv),F.setVec4("uColor",[0,0,0,1]),F.setMat4("uProj",r.camera.getProjectionFMatrix(),r.getZoffsetFactor(i.zbufferOffset));for(var P=0,L=2*i.vertexPositionBuffer.numItems;P<L;P+=3)t.drawArrays(t.LINE_LOOP,P,3)}break;case 2:case 3:case 4:case 5:e.setState(y?r.stencilLineHitState:r.stencilLineState),l=s?i.program2:i.program,u=null;var E=[0,0,0,0];if(g=a,y&&5==i.type&&(i.widthByRatio&&(g=[a[0]*r.curSize[1],a[1]*r.curSize[1]]),!(l=s?this.renderer.progELine3:this.renderer.progLine3).isReady()))return;if(4!=i.type)if(2==i.type)E=[0,0,0,i.widthByRatio?r.cameraViewExtent:1];else{if(y)u=r.whiteTexture,3!=i.type&&2!=i.type||(E=[0,0,0,i.widthByRatio?r.cameraViewExtent:1]);else{var N=i.texture;if(null==N||null==N[0])return;u=N[0],E=[0,N[1]/N[0].height,(N[1]+N[2])/N[0].height,i.widthByRatio?r.cameraViewExtent:1],3==i.type||2==i.type?i.widthByRatio?E[0]=1/(r.cameraViewExtent2*i.lineWidth)/(u.width/N[2]):E[0]=1/i.lineWidth/(u.width/N[2]):i.widthByRatio?(E[0]=1/(r.cameraViewExtent2/r.curSize[1])/(u.width/N[2]),E[0]/=r.curSize[1]*i.lineWidth*.5,E[3]=r.curSize[1]):(E[0]=1/(r.cameraViewExtent2/r.curSize[1])/(u.width/N[2]),E[0]/=.5*i.lineWidth,E[3]=1)}if(!u.loaded)return;e.bindTexture(u)}else i.widthByRatio&&(g=[a[0]*r.curSize[1],a[1]*r.curSize[1]]);if(x){l=s?i.program2:r.progLine3SE;T=this.mBuffer,A=r.superElevation;T[0]=i.bbox.min[0],T[1]=i.bbox.min[1],T[2]=i.bbox.min[2],T[3]=1,T[4]=1,T[5]=1,T[9]=A[0],T[10]=A[1],T[11]=A[2],T[12]=A[6],T[13]=A[5],T[14]=r.earthRadius,T[15]=r.earthERatio,e.useProgram(l,s?["aPosition","aNormal","aElement"]:["aPosition","aNormal"]),l.setMat4("uParamsSE",T)}else e.useProgram(l,s?["aPosition","aNormal","aElement"]:["aPosition","aNormal"]);l.setVec4("uColor",b),l.setVec2("uScale",g),l.setMat4("uMVP",v,r.getZoffsetFactor(i.zbufferOffset)),4!=i.type&&(null!=i.background&&l.setVec4("uColor2",y?[0,0,0,0]:i.background),l.setVec4("uParams",E),l.setSampler("uSampler",0)),xe=l.getAttribute("aPosition"),p=l.getAttribute("aNormal"),t.bindBuffer(t.ARRAY_BUFFER,i.vertexPositionBuffer),t.vertexAttribPointer(xe,i.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,i.vertexNormalBuffer),t.vertexAttribPointer(p,i.vertexNormalBuffer.itemSize,t.FLOAT,!1,0,0),s&&(m=l.getAttribute("aElement"),t.bindBuffer(t.ARRAY_BUFFER,i.vertexElementBuffer),t.vertexAttribPointer(m,i.vertexElementBuffer.itemSize,t.FLOAT,!1,0,0)),t.drawArrays(t.TRIANGLES,0,i.vertexPositionBuffer.numItems);break;case 6:if((G=i.files).length>0)for(P=0,L=G.length;P<L;P++){if(G[P].length>0)if((W=i.fonts[P])&&!W.areTexturesReady(G[P]))return}else{if(!y)return;u=r.whiteTexture}r.useSuperElevation?i.seCounter!=r.seCounter&&(i.seCounter=r.seCounter,i.labelPointsBuffer.id=-1,i.center2=r.transformPointBySE(i.center)):i.center2=i.center;var B=1.4142*i.outline[2]/20,I=1.4142*i.outline[3]/20;if(i.singleBuffer){var k=null;if(180!=i.culling){if(Z=i.center2,J=r.cameraPosition,Y=[Z[0]-J[0],Z[1]-J[1],Z[2]-J[2]],i.visibility){switch(k=ga.length(Y),i.visibility.length){case 1:if(k>i.visibility[0])return;break;case 2:if((K=k*r.localViewExtentFactor)<i.visibility[0]||K>i.visibility[1])return;break;case 4:if(K=k*r.localViewExtentFactor,(Q=i.visibility[0]*i.visibility[1])<i.visibility[2]*K||Q>i.visibility[3]*K)return}k=1/k,Y[0]*=k,Y[1]*=k,Y[2]*=k}else ga.normalize(Y);if(i.normal=[0,0,0],ga.normalize(i.center2,i.normal),(X=-ga.dot(Y,i.normal))<Math.cos(ba.radians(i.culling)))return}else if(i.visibility)switch(Z=i.center2,J=r.cameraPosition,Y=[Z[0]-J[0],Z[1]-J[1],Z[2]-J[2]],k=ga.length(Y),i.visibility.length){case 1:if(k>i.visibility[0])return;break;case 2:if((k*=r.localViewExtentFactor)<i.visibility[0]||k>i.visibility[1])return;break;case 4:if(k*=r.localViewExtentFactor,(Q=i.visibility[0]*i.visibility[1])<i.visibility[2]*k||Q>i.visibility[3]*k)return}if((d=this.processNoOverlap(r,i,ie,J,Z,Y,k,he,u,G,b)).exit)return;return void this.drawGpuSubJobLineLabel(e,t,r,a,[i,0,u,G,b,ie])}if(e.setState(y?r.lineLabelHitState:r.lineLabelState),l=r.useSuperElevation?r.progText2SE:i.program,e.useProgram(l,["aPosition","aTexCoord"]),x){T=this.mBuffer,A=r.superElevation;T[0]=i.bbox.min[0],T[1]=i.bbox.min[1],T[2]=i.bbox.min[2],T[3]=1,T[4]=1,T[5]=1,T[9]=A[0],T[10]=A[1],T[11]=A[2],T[12]=A[6],T[13]=A[5],T[14]=r.earthRadius,T[15]=r.earthERatio,l.setMat4("uParamsSE",T)}l.setSampler("uSampler",0),l.setMat4("uMVP",v,r.getZoffsetFactor(i.zbufferOffset)),l.setVec4("uVec",r.labelVector),l.setVec4("uColor",y?b:i.color2),l.setVec2("uParams",[i.outline[0],I]),xe=l.getAttribute("aPosition"),c=l.getAttribute("aTexCoord"),t.bindBuffer(t.ARRAY_BUFFER,i.vertexPositionBuffer),t.vertexAttribPointer(xe,i.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,i.vertexTexcoordBuffer),t.vertexAttribPointer(c,i.vertexTexcoordBuffer.itemSize,t.FLOAT,!1,0,0);for(var R=0;R<(y?1:2);R++)if(1==R&&(l.setVec4("uColor",b),l.setVec2("uParams",[i.outline[1],B])),G.length>0)for(P=0,L=G.length;P<L;P++)for(var _=0,z=(Se=G[P]).length;_<z;_++){var U=Se[_];l.setFloat("uFile",Math.round(U+1e3*P)),e.bindTexture(i.fonts[P].getTexture(U)),t.drawArrays(t.TRIANGLES,0,i.vertexPositionBuffer.numItems)}else e.bindTexture(u),t.drawArrays(t.TRIANGLES,0,i.vertexPositionBuffer.numItems);break;case 7:case 8:case 9:case 10:if(i.reduce&&!(i.reduce[0]>=7&&i.reduce[0]<=11)){var D,O=i.reduce;if(O[0]>4)if(4==O[0]){if(D=Math.max(O[1],Math.floor(O[2]/Math.max(1,r.drawnGeodataTiles))),i.index>=D)return;O[5]=D}else{if(D=Math.pow(i.texelSize*i.tiltAngle,.5),D=Math.max(O[1],Math.round(O[2]*(D/Math.max(1e-5,this.renderer.drawnGeodataTilesFactor)))),i.index>=D)return;O[5]=D}else{D=i.tiltAngle,1==O[0]?D=1-Math.acos(D)*(1/(.5*Math.PI)):3==O[0]&&(D=.5*(Math.cos(2*Math.acos(D))+1));var V=Math.round(O[1]+D*O[2])-1;if(i.index>V)return;O[5]=V}}var G=i.files;if(10!=i.type)if(9==i.type){for(var j=!1,H=(R=0,i.subjobs.length);R<H;R++){var q=i.subjobs[R];if((G=q.files).length>0)for(P=0,L=G.length;P<L;P++){if(G[P].length>0)(W=q.fonts[P])&&!W.areTexturesReady(G[P])&&(j=!0)}else(u=y?r.whiteTexture:q.texture).loaded||(j=!0)}if(j)return}else if((G=i.files).length>0)for(P=0,L=G.length;P<L;P++){var W;if(G[P].length>0)if((W=i.fonts[P])&&!W.areTexturesReady(G[P]))return}else if(!(u=y?r.whiteTexture:i.texture).loaded)return;var J,Z,Y,K,X;k=null;if(r.useSuperElevation?i.seCounter!=r.seCounter&&(i.seCounter=r.seCounter,i.center2=r.transformPointBySE(i.center)):i.center2=i.center,180!=i.culling){if(Z=i.center2,J=r.cameraPosition,Y=[Z[0]-J[0],Z[1]-J[1],Z[2]-J[2]],i.visibility){switch(k=ga.length(Y),i.visibility.length){case 1:if(k>i.visibility[0])return;break;case 2:if((K=k*r.localViewExtentFactor)<i.visibility[0]||K>i.visibility[1])return;break;case 4:if(K=k*r.localViewExtentFactor,(Q=i.visibility[0]*i.visibility[1])<i.visibility[2]*K||Q>i.visibility[3]*K)return}k=1/k,Y[0]*=k,Y[1]*=k,Y[2]*=k}else ga.normalize(Y);if(i.normal=[0,0,0],ga.normalize(i.center2,i.normal),(X=-ga.dot(Y,i.normal))<Math.cos(ba.radians(i.culling)))return}else if(i.visibility)switch(Z=i.center2,J=r.cameraPosition,Y=[Z[0]-J[0],Z[1]-J[1],Z[2]-J[2]],k=ga.length(Y),i.visibility.length){case 1:if(k>i.visibility[0])return;break;case 2:if((k*=r.localViewExtentFactor)<i.visibility[0]||k>i.visibility[1])return;break;case 4:var Q;if(k*=r.localViewExtentFactor,(Q=i.visibility[0]*i.visibility[1])<i.visibility[2]*k||Q>i.visibility[3]*k)return}if(10==i.type){var $=r.viewExtent,ee=i.vswitch;for(i.vswitchIndex=0,P=0,L=ee.length;P<L;P++)if($<=ee[P][0]||P==L-1){i.vswitchIndex=P;var te=i.vswitch[P];if(te)for(R=0,H=(te=te[1]).length;R<H;R++){var re=te[R];re.mv=i.mv,re.mvp=i.mvp,re.updatePos=i.updatePos,re.hysteresis=i.hysteresis,re.vswitchIndex=P,re.renderCounter=i.renderCounter,re.localTilt=X,re.id=i.id,this.drawGpuJob(e,t,r,re,a,s,n)}return}return}var ie,ae,se,ne,oe=i.stick,he=0;if(0!=oe[0]){if(se=r.config.mapFeatureStickMode,ne=oe[0],se[0]){if(X||(X=i.localTilt)||(Z=i.center2,J=r.cameraPosition,Y=[Z[0]-J[0],Z[1]-J[1],Z[2]-J[2]],ga.normalize(Y),i.normal=[0,0,0],ga.normalize(i.center2,i.normal),X=-ga.dot(Y,i.normal)),2==se[0]){var le=r.gridHmax-r.gridHmin;le<0&&(le=0),le<ne&&(ne=le)}X<0&&(X=0),he=Math.pow(1-X,se[1])*ne*r.cameraTiltFator}else he=r.cameraTiltFator*oe[0];he<oe[1]&&(he=0),0!=oe[0]&&0!=oe[2]&&he>=4&&(he+=oe[7]),(ie=r.project2(i.center2,r.camera.mvp,r.cameraPosition))[0]=Math.round(ie[0]),ie[1]-=he}if((d=this.processNoOverlap(r,i,ie,J,Z,Y,k,he,u,G,b)).exit)return;if(ie=d.pp,J=d.p1,Z=d.p2,Y=d.camVec,k=d.l,9==i.type)return;if(r.drawLabelBoxes&&(ae=i.noOverlap)&&(ie||(ie=r.project2(i.center2,r.camera.mvp,r.cameraPosition)),e.setState(y?r.lineLabelHitState:r.lineLabelState),this.drawLineString([[ie[0]+ae[0],ie[1]+ae[1],.5],[ie[0]+ae[2],ie[1]+ae[1],.5],[ie[0]+ae[2],ie[1]+ae[3],.5],[ie[0]+ae[0],ie[1]+ae[3],.5],[ie[0]+ae[0],ie[1]+ae[1],.5]],!0,1,[255,0,0,255],null,!0,null,null,null),i.reduce&&(i.reduce[0]>=10?this.drawText(ie[0]+ae[0],ie[1]+ae[3]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,i.reduce[6].toFixed(3)+" "+i.reduce[1].toFixed(2)+" "+i.reduce[3].toFixed(2)+" "+i.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(ie[0]+ae[0],ie[1]+ae[3]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,i.reduce[1].toFixed(0)+" "+i.reduce[5].toFixed(0),[1,0,0,1],.5))),e.setState(y?r.lineLabelHitState:r.labelState),0!=oe[0]&&0!=oe[2]&&(ie||(ie=r.project2(i.center2,r.camera.mvp,r.cameraPosition)),this.drawLineString([[ie[0],ie[1]+he+oe[7],ie[2]],[ie[0],ie[1]+oe[7],ie[2]]],!0,oe[2],[oe[3],oe[4],oe[5],oe[6]],null,null,null,null,!0)),l=i.program,i.singleBuffer){if(ie||(ie=r.project2(i.center2,r.camera.mvp,r.cameraPosition)),l==r.progIcon){var ue=i.singleBuffer;if(l=r.progImage,!i.singleBuffer2){i.singleBuffer2=new Float32Array(ue);var de=1/u.width,ce=1/u.height;ue[2]*=de,ue[3]*=ce,ue[6]*=de,ue[7]*=ce,ue[10]*=de,ue[11]*=ce,ue[14]*=de,ue[15]*=ce}i.updatePos&&((ie=r.project2(i.center2,r.camera.mvp,r.cameraPosition))[1]-=he);var pe=i.singleBuffer2;ue[0]=ie[0]+pe[0],ue[1]=ie[1]+pe[1],ue[4]=ie[0]+pe[4],ue[5]=ie[1]+pe[5],ue[8]=ie[0]+pe[8],ue[9]=ie[1]+pe[9],ue[12]=ie[0]+pe[12],ue[13]=ie[1]+pe[13],e.useProgram(l,["aPosition"]),e.bindTexture(u);var fe=r.rectVerticesBuffer;t.bindBuffer(t.ARRAY_BUFFER,fe),t.vertexAttribPointer(l.getAttribute("aPosition"),fe.itemSize,t.FLOAT,!1,0,0);var me=r.rectIndicesBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,me),l.setMat4("uProjectionMatrix",r.imageProjectionMatrix),l.setMat4("uData",i.singleBuffer),l.setVec4("uColor",b),l.setFloat("uDepth",ie[2]*(1+2*r.getZoffsetFactor(i.zbufferOffset))),t.drawElements(t.TRIANGLES,me.numItems,t.UNSIGNED_SHORT,0)}else{var ge,ve=(ue=i.singleBuffer).length,ye=ue.length/4*6,be=i.color2;R=0;ve>384?(ge=r.textQuads128,l=r.progLabel128):ve>256?(ge=r.textQuads96,l=r.progLabel96):ve>192?(ge=r.textQuads64,l=r.progLabel64):ve>128?(ge=r.textQuads48,l=r.progLabel48):ve>64?(ge=r.textQuads32,l=r.progLabel32):(ge=r.textQuads16,l=r.progLabel16),i.updatePos&&((ie=r.project2(i.center2,r.camera.mvp,r.cameraPosition))[1]-=he),e.useProgram(l,["aPosition"]),l.setSampler("uSampler",0),l.setMat4("uProjectionMatrix",r.imageProjectionMatrix),l.setVec4("uScale",[a[0],a[1],1,2*he]),l.setVec3("uOrigin",[ie[0],ie[1],ie[2]*(1+2*r.getZoffsetFactor(i.zbufferOffset))]),l.setVec4("uColor",y?b:be),l.setVec2("uParams",[i.outline[0],i.gamma[1]]),H=y?1:2;var xe=l.getAttribute("aPosition");for(l.setVec4("uData",ue),t.bindBuffer(t.ARRAY_BUFFER,ge),t.vertexAttribPointer(xe,ge.itemSize,t.FLOAT,!1,0,0);R<H;R++){1==R&&(l.setVec4("uColor",b),l.setVec2("uParams",[i.outline[1],i.gamma[0]]));for(P=0,L=G.length;P<L;P++)for(_=0,z=(Se=G[P]).length;_<z;_++){U=Se[_];l.setFloat("uFile",Math.round(U+1e3*P)),e.bindTexture(i.fonts[P].getTexture(U)),t.drawArrays(t.TRIANGLES,0,ye)}}}return}e.useProgram(l,["aPosition","aTexCoord","aOrigin"]),l.setSampler("uSampler",0),l.setMat4("uMVP",v,r.getZoffsetFactor(i.zbufferOffset)),l.setVec4("uScale",[a[0],a[1],8==i.type?1:1/u.width,2*he]);R=0,H=1;for(l!=r.progIcon?(l.setVec4("uColor",y?b:i.color2),l.setVec2("uParams",[i.outline[0],i.gamma[1]]),H=y?1:2):l.setVec4("uColor",b),xe=l.getAttribute("aPosition"),c=l.getAttribute("aTexCoord"),f=l.getAttribute("aOrigin"),t.bindBuffer(t.ARRAY_BUFFER,i.vertexPositionBuffer),t.vertexAttribPointer(xe,i.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,i.vertexTexcoordBuffer),t.vertexAttribPointer(c,i.vertexTexcoordBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,i.vertexOriginBuffer),t.vertexAttribPointer(f,i.vertexOriginBuffer.itemSize,t.FLOAT,!1,0,0);R<H;R++)if(1==R&&(l.setVec4("uColor",b),l.setVec2("uParams",[i.outline[1],i.gamma[0]])),G.length>0)for(P=0,L=G.length;P<L;P++){var Se;for(_=0,z=(Se=G[P]).length;_<z;_++){U=Se[_];l.setFloat("uFile",Math.round(U+1e3*P)),e.bindTexture(i.fonts[P].getTexture(U)),t.drawArrays(t.TRIANGLES,0,i.vertexPositionBuffer.numItems)}}else e.bindTexture(u),t.drawArrays(t.TRIANGLES,0,i.vertexPositionBuffer.numItems)}}},Ca.prototype.drawGpuSubJob=function(e,t,r,i,a,s){if(a){var n,o,h,l,u=a[0],d=a[1],c=a[2],p=a[3],f=a[4],m=a[5],g=u.stick,v=u.noOverlap;if(r.useSuperElevation?u.seCounter!=r.seCounter&&(u.seCounter=r.seCounter,u.center2=r.transformPointBySE(u.center)):u.center2=u.center,u.hysteresis&&u.id&&0!=g[0]){var y=r.config.mapFeatureStickMode,b=g[0];if(y[0]){if(n||(n=u.localTilt)||(o=u.center2,h=r.cameraPosition,l=[o[0]-h[0],o[1]-h[1],o[2]-h[2]],ga.normalize(l),u.normal=[0,0,0],ga.normalize(u.center2,u.normal),n=-ga.dot(l,u.normal)),2==y[0]){var x=r.gridHmax-r.gridHmin;x<0&&(x=0),x<b&&(b=x)}n<0&&(n=0),d=Math.pow(1-n,y[1])*b*r.cameraTiltFator}else d=r.cameraTiltFator*g[0];d<g[1]&&(d=0),0!=g[0]&&0!=g[2]&&d>=4&&(d+=g[7]),(m=r.project2(u.center2,r.camera.mvp,r.cameraPosition))[0]=Math.round(m[0]),m[1]-=d}var S=u.hitable&&r.onlyHitLayers;if(9!=u.type){r.drawLabelBoxes&&v&&(e.setState(S?r.lineLabelHitState:r.lineLabelState),this.drawLineString([[m[0]+v[0],m[1]+v[1],.5],[m[0]+v[2],m[1]+v[1],.5],[m[0]+v[2],m[1]+v[3],.5],[m[0]+v[0],m[1]+v[3],.5],[m[0]+v[0],m[1]+v[1],.5]],!0,1,[255,0,0,255],null,!0,null,null,null),u.reduce&&(u.reduce[0]>=10?this.drawText(m[0]+v[0],m[1]+v[3]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,u.reduce[6].toFixed(3)+" "+u.reduce[1].toFixed(2)+" "+u.reduce[3].toFixed(2)+" "+u.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(m[0]+v[0],m[1]+v[3]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,u.reduce[1].toFixed(0)+" "+u.reduce[5].toFixed(0),[1,0,0,1],.5))),e.setState(S?r.lineLabelHitState:r.labelState);var M=0,w=1,T=u.color2;null!==s&&(f=[f[0],f[1],f[2],f[3]*s],T&&(T=[T[0],T[1],T[2],T[3]*s])),0!=g[0]&&0!=g[2]&&d>=4&&this.drawLineString([[m[0],m[1]+d+g[7],m[2]],[m[0],m[1]+g[7],m[2]]],!0,g[2],[g[3],g[4],g[5],null!==s?g[6]*s:g[6]],null,null,null,null,!0);var A=u.program;if(u.singleBuffer)if(A==r.progIcon){var C=u.singleBuffer;if(A=r.progImage,!u.singleBuffer2){u.singleBuffer2=new Float32Array(C);var F=1/c.width,P=1/c.height;C[2]*=F,C[3]*=P,C[6]*=F,C[7]*=P,C[10]*=F,C[11]*=P,C[14]*=F,C[15]*=P}u.updatePos&&((m=r.project2(u.center2,r.camera.mvp,r.cameraPosition))[1]-=d);var L=u.singleBuffer2;C[0]=m[0]+L[0],C[1]=m[1]+L[1],C[4]=m[0]+L[4],C[5]=m[1]+L[5],C[8]=m[0]+L[8],C[9]=m[1]+L[9],C[12]=m[0]+L[12],C[13]=m[1]+L[13],e.useProgram(A,["aPosition"]),e.bindTexture(c);var E=r.rectVerticesBuffer;t.bindBuffer(t.ARRAY_BUFFER,E),t.vertexAttribPointer(A.getAttribute("aPosition"),E.itemSize,t.FLOAT,!1,0,0);var N=r.rectIndicesBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,N),A.setMat4("uProjectionMatrix",r.imageProjectionMatrix),A.setMat4("uData",u.singleBuffer),A.setVec4("uColor",f),A.setFloat("uDepth",m[2]*(1+2*r.getZoffsetFactor(u.zbufferOffset))),t.drawElements(t.TRIANGLES,N.numItems,t.UNSIGNED_SHORT,0)}else{var B,I=(C=u.singleBuffer).length,k=C.length/4*6;I>384?(B=r.textQuads128,A=r.progLabel128):I>256?(B=r.textQuads96,A=r.progLabel96):I>192?(B=r.textQuads64,A=r.progLabel64):I>128?(B=r.textQuads48,A=r.progLabel48):I>64?(B=r.textQuads32,A=r.progLabel32):(B=r.textQuads16,A=r.progLabel16),u.updatePos&&((m=r.project2(u.center2,r.camera.mvp,r.cameraPosition))[1]-=d),e.useProgram(A,["aPosition"]),A.setSampler("uSampler",0),A.setMat4("uProjectionMatrix",r.imageProjectionMatrix),A.setVec4("uScale",[i[0],i[1],1,2*d]),A.setVec3("uOrigin",[m[0],m[1],m[2]*(1+2*r.getZoffsetFactor(u.zbufferOffset))]),A.setVec4("uColor",S?f:T),A.setVec2("uParams",[u.outline[0],u.gamma[1]]),w=S?1:2;var R=A.getAttribute("aPosition");for(A.setVec4("uData",C),t.bindBuffer(t.ARRAY_BUFFER,B),t.vertexAttribPointer(R,B.itemSize,t.FLOAT,!1,0,0);M<w;M++){1==M&&(A.setVec4("uColor",f),A.setVec2("uParams",[u.outline[1],u.gamma[0]]));for(G=0,j=p.length;G<j;G++)for(var _=0,z=(V=p[G]).length;_<z;_++){var U=V[_];A.setFloat("uFile",Math.round(U+1e3*G)),e.bindTexture(u.fonts[G].getTexture(U)),t.drawArrays(t.TRIANGLES,0,k)}}}else{e.useProgram(A,["aPosition","aTexCoord","aOrigin"]),A.setSampler("uSampler",0),A.setMat4("uMVP",u.mvp,r.getZoffsetFactor(u.zbufferOffset)),A.setVec4("uScale",[i[0],i[1],8==u.type?1:1/c.width,2*d]),A!=r.progIcon?(A.setVec4("uColor",S?f:T),A.setVec2("uParams",[u.outline[0],u.gamma[1]]),w=S?1:2):A.setVec4("uColor",f);R=A.getAttribute("aPosition");var D=A.getAttribute("aTexCoord"),O=A.getAttribute("aOrigin");for(t.bindBuffer(t.ARRAY_BUFFER,u.vertexPositionBuffer),t.vertexAttribPointer(R,u.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,u.vertexTexcoordBuffer),t.vertexAttribPointer(D,u.vertexTexcoordBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,u.vertexOriginBuffer),t.vertexAttribPointer(O,u.vertexOriginBuffer.itemSize,t.FLOAT,!1,0,0);M<w;M++)if(1==M&&(A.setVec4("uColor",f),A.setVec2("uParams",[u.outline[1],u.gamma[0]])),p.length>0)for(G=0,j=p.length;G<j;G++){var V;for(_=0,z=(V=p[G]).length;_<z;_++){U=V[_];A.setFloat("uFile",Math.round(U+1e3*G)),e.bindTexture(u.fonts[G].getTexture(U)),t.drawArrays(t.TRIANGLES,0,u.vertexPositionBuffer.numItems)}}else e.bindTexture(c),t.drawArrays(t.TRIANGLES,0,u.vertexPositionBuffer.numItems)}}else{r.drawLabelBoxes&&v&&(e.setState(S?r.lineLabelHitState:r.lineLabelState),this.drawLineString([[m[0]+v[0],m[1]+v[1],.5],[m[0]+v[2],m[1]+v[1],.5],[m[0]+v[2],m[1]+v[3],.5],[m[0]+v[0],m[1]+v[3],.5],[m[0]+v[0],m[1]+v[1],.5]],!0,1,[255,0,0,255],null,!0,null,null,null),u.reduce&&(u.reduce[0]>=10?this.drawText(m[0]+v[0],m[1]+v[3]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,u.reduce[6].toFixed(3)+" "+u.reduce[1].toFixed(2)+" "+u.reduce[3].toFixed(2)+" "+u.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(m[0]+v[0],m[1]+v[3]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,u.reduce[1].toFixed(0)+" "+u.reduce[5].toFixed(0),[1,0,0,1],.5))),e.setState(S?r.lineLabelHitState:r.labelState),0!=g[0]&&0!=g[2]&&d>=4&&this.drawLineString([[m[0],m[1]+d+g[7],m[2]],[m[0],m[1]+g[7],m[2]]],!0,g[2],[g[3],g[4],g[5],null!==s?g[6]*s:g[6]],null,null,null,null,!0);for(var G=0,j=u.subjobs.length;G<j;G++){var H=u.subjobs[G];H.mvp=u.mvp,H.updatePos=u.updatePos;var q=a[7];v=null,p=H.files,S?(f=a[4],c=r.whiteTexture):(f=H.color,c=H.texture),this.drawGpuSubJob(e,t,r,i,[H,d,c,p,f,m,!0,q,v],s)}}}},Ca.prototype.drawGpuSubJobLineLabel=function(e,t,r,i,a,s){if(a){var n,o=a[0],h=(a[2],a[3]),l=a[4],u=a[5],d=o.noOverlap,c=r.useSuperElevation;c?o.seCounter!=r.seCounter&&(o.seCounter=r.seCounter,o.labelPointsBuffer.id=-1,o.center2=r.transformPointBySE(o.center)):o.center2=o.center;var p,f,m,g=o.hitable&&r.onlyHitLayers,v=1.4142*o.outline[2]/20,y=1.4142*o.outline[3]/20;if(o.singleBuffer){e.setState(g?r.lineLabelHitState:r.lineLabelState),(u=a[5])&&!o.updatePos||(u=r.project2(o.center2,r.camera.mvp,r.cameraPosition,!0));var b=.5*o.labelSize,x=.5*r.camera.scaleFactor2(u[3])*r.curSize[1]*(r.curSize[0]/r.curSize[1]),S=o.labelPoints,M=o.labelIndex,w=0;if((D=S.length)<=1||S[D-1][0]*x<b)return;for(D--,p=0;p<D;p++){var T=S[p+1][0]*x;if(T>b){var A=S[p][0]*x;M=p,w=(b-A)/(T-A);break}}var C,F,P=ga.dot(S[M][1],r.labelVector)>=0?3:2,L=3==P?o.singleBuffer2:o.singleBuffer,E=L.length,N=L.length/4*6,B=S[M][P],I=0,k=S[M+1]?S[M+1][P]:B,R=[0,0,0,0];if(c)if((F=o.labelPointsBuffer).id!=1024*M+P){F.id=1024*M+P,F.points.length!=B.length&&(F.points=new Array(B.length),F.points2=new Array(B.length));var _=F.points,z=F.points2;for(p=0,D=B.length;p<D;p++)_[p]=r.transformPointBySE2(B[p]),z[p]=r.transformPointBySE2(k[p]);B=_,k=z}else B=F.points,k=F.points2;if(!B.length||!k.length)return;for(p=0,D=B.length;p<D;p++)f=B[p],m=k[p],c?(L[I]=f[4]+f[13]+(m[4]+m[13]-(f[4]+f[13]))*w,L[I+1]=f[5]+f[14]+(m[5]+m[14]-(f[5]+f[14]))*w,L[I+2]=f[6]+f[15]+(m[6]+m[15]-(f[6]+f[15]))*w):(L[I]=f[4]+(m[4]-f[4])*w,L[I+1]=f[5]+(m[5]-f[5])*w,L[I+2]=f[6]+(m[6]-f[6])*w),Fa([f[7],f[8],f[9],f[10]],[m[7],m[8],m[9],m[10]],w,R),L[I+3]=R[0],L[I+4]=R[1],L[I+5]=R[2],L[I+6]=R[3],L[I+7]=f[11]+(m[11]-f[11])*w,L[I+8]=f[12]+(m[12]-f[12])*w,I+=12;E>384?(C=r.textQuads128,n=r.progLineLabel128):E>256?(C=r.textQuads96,n=r.progLineLabel96):E>192?(C=r.textQuads64,n=r.progLineLabel64):E>128?(C=r.textQuads48,n=r.progLineLabel48):E>64?(C=r.textQuads32,n=r.progLineLabel32):(C=r.textQuads16,n=r.progLineLabel16);var U=o.color2;null!==s&&(l=[l[0],l[1],l[2],l[3]*s],U&&(U=[U[0],U[1],U[2],U[3]*s])),e.useProgram(n,["aPosition"]),n.setSampler("uSampler",0),n.setMat4("uMVP",o.mvp,r.getZoffsetFactor(o.zbufferOffset)),n.setVec4("uColor",g?l:U),n.setVec2("uParams",[o.outline[0],y]);var D=g?1:2,O=n.getAttribute("aPosition");for(n.setVec4("uData",L),t.bindBuffer(t.ARRAY_BUFFER,C),t.vertexAttribPointer(O,C.itemSize,t.FLOAT,!1,0,0),p=0,D=g?1:2;p<D;p++){1==p&&(n.setVec4("uColor",l),n.setVec2("uParams",[o.outline[1],v]));for(var V=0,G=h.length;V<G;V++)for(var j=h[V],H=0,q=j.length;H<q;H++){var W=j[H];n.setFloat("uFile",Math.round(W+1e3*V)),e.bindTexture(o.fonts[V].getTexture(W)),t.drawArrays(t.TRIANGLES,0,N/3)}}if(r.drawLabelBoxes){var J,Z=d?d[0]:1;u=[0,0,0];for(p=0,D=B.length;p<D;p++)f=B[p],m=k[p],u[0]=f[0]+(m[0]-f[0])*w,u[1]=f[1]+(m[1]-f[1])*w,u[2]=f[2]+(m[2]-f[2])*w,J=f[3]+(m[3]-f[3])*w,u=r.project2(u,r.camera.mvp,r.cameraPosition,!0),this.drawCircle(u,J*x*Z,1,[255,0,255,255],null,null,null,null,null);(u=a[5])||(u=r.project2(o.center2,r.camera.mvp,r.cameraPosition,!0)),this.drawCircle(u,8,1,[255,255,0,255],null,null,null,null,null),o.reduce&&(o.reduce[0]>=10?this.drawText(u[0],u[1]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,o.reduce[6].toFixed(3)+" "+o.reduce[1].toFixed(2)+" "+o.reduce[3].toFixed(2)+" "+o.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(u[0],u[1]-4*r.debug.debugTextSize,4*r.debug.debugTextSize,o.reduce[1].toFixed(0)+" "+o.reduce[5].toFixed(0),[1,0,0,1],.5))}}else;}};var Pa=Ca,La=a.d,Ea=function(e,t,r){this.renderer=e,this.drawAllLabels=!1,this.maxBlockRectangles=r||500,this.blockSize=t,this.blockSizeFactor=1/t,this.blocks=[],this.blocks2=[],this.blocksRCount=[],this.blocks2RCount=[],this.allocatedBlocks=0,this.lx=1,this.ly=1,this.counter=0,this.rectangles=null,this.rectanglesCount=0,this.rectangles2=null,this.rectangles2Count=0,this.rectanglesR=null,this.rectanglesRCount=0,this.benevolentMargins=!1,this.positionsBuffer=new Float64Array(1024)};Ea.prototype.clear=function(){var e=this.renderer;this.sx2=e.curSize[0],this.sy2=e.curSize[1],this.sy2=Math.max(1,this.sy2-55),this.sy1=1,this.sx1=1,this.cx2=135,this.cy1=e.curSize[1]-145,this.bx2=245,this.by2=45,this.lx=Math.floor(e.curSize[0]*this.blockSizeFactor)+1,this.ly=Math.floor(e.curSize[1]*this.blockSizeFactor)+1,4096&e.marginFlags&&(this.sx1=Math.min(34,this.sx2),this.sx2=Math.max(1,e.curSize[0]-34),this.sy1=Math.min(50,this.sy2),this.sy2=Math.max(1,e.curSize[1]-68));var t=this.ly*this.lx;if(this.rectangles||(this.rectangles=new Array(t*this.maxBlockRectangles*6)),this.rectangles2||(this.rectangles2=new Array(t*this.maxBlockRectangles*6)),this.rectanglesR||(this.rectanglesR=new Array(t*this.maxBlockRectangles*6)),this.rectanglesCount>0||this.allocatedBlocks!=t)for(var r=0;r<t;r++)this.blocks[r]||(this.blocks[r]=[]),this.blocksRCount[r]=0;if(this.rectangles2Count>0||this.allocatedBlocks!=t)for(r=0;r<t;r++)this.blocks2[r]||(this.blocks2[r]=[]),this.blocks2RCount[r]=0;this.allocatedBlocks=t,this.drawAllLabels=e.debug.drawAllLabels,this.benevolentMargins=e.benevolentMargins,this.rectanglesCount=0,this.rectangles2Count=0,this.rectanglesRCount=0,this.counter=e.geoRenderCounter},Ea.prototype.storeRemovedRectangle=function(e,t,r,i,a,s){var n=this.rectanglesR,o=this.rectanglesRCount;n[o]=e,n[o+1]=t,n[o+2]=r,n[o+3]=i,n[o+4]=a,n[o+5]=s,this.rectanglesRCount+=6},Ea.prototype.circleAABBoxCollide=function(e,t,r,i,a,s,n){var o=.5*(r-e),h=.5*(i-t),l=Math.abs(a-e-o),u=Math.abs(s-i-h);if(l>o+n||u>h+n)return!1;if(l<=o||u<=h)return!0;var d=l-o,c=u-h;return d*d+c*c<=n*n},Ea.prototype.lineAABBoxCollide=function(e,t,r,i,a,s,n,o){var h=1/(n!=a?n-a:1e-5),l=(e-a)*h,u=(r-a)*h,d=Math.min(l,u),c=Math.max(l,u),p=1/(o!=s?o-s:1e-5),f=(t-s)*p,m=(i-s)*p;return d=Math.max(d,Math.min(f,m)),(c=Math.min(c,Math.max(f,m)))>=d},Ea.prototype.checkRectangle=function(e,t,r,i,a){var s;return e>r&&(s=e,e=r,r=s),t>i&&(s=t,t=i,i=s),a+=i,this.benevolentMargins?!(r<this.sx1||e>this.sx2||a<this.sy1||t>this.sy2):!(e<this.sx1||r>this.sx2||t<this.sy1||a>this.sy2)&&(!(1&this.renderer.marginFlags&&e<this.cx2&&r>0&&t<=this.sx2&&a>this.cy1)&&!(2&this.renderer.marginFlags&&e<this.bx2&&r>0&&t<=this.by2&&a>0))},Ea.prototype.addRectangle=function(e,t,r,i,a,s,n,o){var h,l,u,d,c,p,f,m,g=this.renderer;if(this.drawAllLabels)return!0;e>r&&(m=e,e=r,r=m),t>i&&(m=t,t=i,i=m);var v=i+s[1];if(this.benevolentMargins){if(r<this.sx1||e>this.sx2||v<this.sy1||t>this.sy2)return!1}else{if(e<this.sx1||r>this.sx2||t<this.sy1||v>this.sy2)return!1;if(1&g.marginFlags&&e<this.cx2&&r>0&&t<=this.sx2&&v>this.cy1)return!1;if(2&g.marginFlags&&e<this.bx2&&r>0&&t<=this.by2&&v>0)return!1}var y=Math.floor(e*this.blockSizeFactor),b=Math.floor(t*this.blockSizeFactor),x=Math.floor(r*this.blockSizeFactor),S=Math.floor(i*this.blockSizeFactor);if(x<0||S<0||y>=this.lx||b>=this.ly)return!1;y<0&&(y=0),x>=this.lx&&(x=this.lx-1),b<0&&(b=0),S>=this.ly&&(S=this.ly-1);var M=x-y+1,w=S-b+1,T={},A=g.config.mapFeaturesSortByTop,C=this.rectangles,F=this.rectangles2;for(l=0;l<w;l++)for(h=0;h<M;h++){for(d=(b+l)*this.lx+(y+h),c=this.blocks[d],p=this.blocksRCount[d],u=0;u<p;u++)if(e<C[(f=c[u])+2]&&r>C[f+0]&&t<C[f+3]&&i>C[f+1]){if(n)return!1;if(A){if(a<C[f+4])return!1}else if(a>C[f+4])return!1;T[f]=!0}if(p+1>=this.maxBlockRectangles)return!1;for(c=this.blocks2[d],p=this.blocks2RCount[d],u=0;u<p;u++)if(f=c[u],this.circleAABBoxCollide(e,t,r,i,F[f+0],F[f+1],C[f+3]))return!1}for(var P in T)this.removeRectangle(parseInt(P));if(o){var L=o[2],E=g.mapHack.getScreenDepth(o[0],o[1],L[4]>1e7);if(E[0]){var N=E[1]-L[4];if(L[7]=N,!g.drawHiddenLabels&&N<o[3])return!1}}for(C[f=this.rectanglesCount]=e,C[f+1]=t,C[f+2]=r,C[f+3]=i,C[f+4]=a,C[f+5]=s,this.rectanglesCount+=6,l=0;l<w;l++)for(h=0;h<M;h++)d=(b+l)*this.lx+(y+h),this.blocks[d][this.blocksRCount[d]]=f,this.blocksRCount[d]++;return!0},Ea.prototype.addLineLabel=function(e,t){var r,i,a,s,n,o,h,l,u,d,c=e[0],p=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,m=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,v=0,y=this.renderer,b=[0,0,0,0],x=this.positionsBuffer,S=0,M=0,w=c.noOverlap?c.noOverlap[0]:1,T=.5*c.labelSize,A=.5*y.camera.scaleFactor2(e[5][3])*y.curSize[1]*(y.curSize[0]/y.curSize[1]),C=e[9],F=c.labelPoints,P=c.labelIndex,L=0;if(!((d=F.length)<=1||F[d-1][0]*A<T)){for(d--,u=0;u<d;u++){var E=F[u+1][0]*A;if(E>T){var N=F[u][0]*A;P=u,L=(T-N)/(E-N);break}}C=La.dot(F[P][1],y.labelVector)>=0?3:2;var B,I,k,R=F[P][C],_=F[P+1]?F[P+1][C]:R,z=this.benevolentMargins;if(y.useSuperElevation)if((k=c.labelPointsBuffer).id!=1024*P+C){k.id=1024*P+C,k.points.length!=R.length&&(k.points=new Array(R.length),k.points2=new Array(R.length));var U=k.points,D=k.points2;for(u=0,d=R.length;u<d;u++)U[u]=y.transformPointBySE2(R[u]),D[u]=y.transformPointBySE2(_[u]);R=U,_=D}else R=k.points,_=k.points2;if(!R.length||!_.length)return!1;for(u=0,d=R.length;u<d;u++)B=R[u],I=_[u],b[0]=B[0]+(I[0]-B[0])*L,b[1]=B[1]+(I[1]-B[1])*L,b[2]=B[2]+(I[2]-B[2])*L,o=(B[3]+(I[3]-B[3])*L)*A*w,(b=y.project2(b,y.camera.mvp,y.cameraPosition,!0))[0]>f&&(f=b[0]),b[1]>g&&(g=b[1]),b[0]<p&&(p=b[0]),b[1]<m&&(m=b[1]),x[M]=b[0],x[M+1]=b[1],x[M+2]=b[2],x[M+3]=o,o>v&&(v=o),M+=4;if(p-=v,f+=v,m-=v,g+=v,z){if(f<this.sx1||p>this.sx2||g<this.sy1||m>this.sy2)return!1}else{if(p<this.sx1||f>this.sx2||m<this.sy1||g>this.sy2)return!1;if(1&y.marginFlags&&p<this.cx2&&f>0&&m<=this.sx2&&g>this.cy1)return!1;if(2&y.marginFlags&&p<this.bx2&&f>0&&m<=this.by2&&g>0)return!1}var O,V,G,j,H,q,W,J=this.blockSizeFactor,Z=this.lx,Y=this.ly,K=(y.config.mapFeaturesSortByTop,this.rectangles),X=this.rectangles2;for(M=0,u=0,d=R.length;u<d;u++){if(h=x[M],l=x[M+1],o=x[M+3],O=Math.floor((h-o)*J),V=Math.floor((l-o)*J),G=Math.floor((h+o)*J),j=Math.floor((l+o)*J),z){if(G<0||O>=Z||j<0||V>=Y){M+=4;continue}O<0&&(O=0),V<0&&(V=0),G>=Z&&(G=Z-1),j>=Y&&(j=Y-1)}var Q=G-O+1,$=j-V+1;for(n=0;n<$;n++)for(s=0;s<Q;s++){for(S=(V+n)*Z+(O+s),r=this.blocks[S],i=this.blocksRCount[S],W=0;W<i;W++)if(a=r[W],this.circleAABBoxCollide(p,m,f,g,K[a+0],K[a+1],K[a+2]))return!1;for(r=this.blocks2[S],i=this.blocks2RCount[S],W=0;W<i;W++)if((H=h-X[(a=r[W])+0])*H+(q=l-X[a+1])*q<(v=X[a+2]+o)*v)return!1}M+=4}for(M=0,u=0,d=R.length;u<d;u++){if(h=x[M],l=x[M+1],o=x[M+3],O=Math.floor((h-o)*J),V=Math.floor((l-o)*J),G=Math.floor((h+o)*J),j=Math.floor((l+o)*J),z){if(G<0||O>=Z||j<0||V>=Y){M+=4;continue}O<0&&(O=0),V<0&&(V=0),G>=Z&&(G=Z-1),j>=Y&&(j=Y-1)}Q=G-O+1,$=j-V+1;for(X[a=this.rectangles2Count]=h,X[a+1]=l,X[a+2]=o,X[a+3]=e,this.rectangles2Count+=4,n=0;n<$;n++)for(s=0;s<Q;s++)S=(V+n)*this.lx+(O+s),this.blocks2[S][this.blocks2RCount[S]]=a,this.blocks2RCount[S]++;M+=4}return!0}},Ea.prototype.removeRectangle=function(e){var t,r,i,a,s,n,o,h,l,u,d=this.rectangles;t=d[e],r=d[e+1],i=d[e+2],a=d[e+3];var c=this.rectanglesR,p=this.rectanglesRCount;c[p]=t,c[p+1]=r,c[p+2]=i,c[p+3]=a,c[p+4]=d[e+4],c[p+5]=d[e+5],this.rectanglesRCount+=6,d[e+5]=null;var f=Math.floor(t*this.blockSizeFactor),m=Math.floor(r*this.blockSizeFactor),g=Math.floor(i*this.blockSizeFactor),v=Math.floor(a*this.blockSizeFactor);f<0&&(f=0),g>=this.lx&&(g=this.lx-1),m<0&&(m=0),v>=this.ly&&(v=this.ly-1);var y=g-f+1,b=v-m+1;for(n=0;n<b;n++)for(s=0;s<y;s++)for(h=(m+n)*this.lx+(f+s),l=this.blocks[h],u=this.blocksRCount[h],o=0;o<u;o++)if(l[o]==e){l[o]=l[u-1],this.blocksRCount[h]--;break}},Ea.prototype.processRectangles=function(e,t,r,i){for(var a=this.rectangles,s=this.rectangles2,n=this.rectanglesR,o=r.draw,h=0,l=this.rectanglesRCount;h<l;h+=6){var u=n[h],d=n[h+1],c=n[h+2],p=n[h+3],f=n[h+4],m=n[h+5];this.addRectangle(u,d,c,p,f,m)}for(this.rectanglesRCount=0,h=0,l=this.rectanglesCount;h<l;h+=6){(m=a[h+5])&&(m[0].hysteresis?r.jobHBuffer[m[0].id]=m[0]:(r.drawnJobs++,o.drawGpuSubJob(e,t,r,i,m,null)))}for(h=0,l=this.rectangles2Count;h<l;h+=4){if(m=s[h+3]){var g=m[0];g.hysteresis?r.jobHBuffer[g.id]=g:(r.drawnJobs++,o.drawGpuSubJobLineLabel(e,t,r,i,m,null));var v=g.labelPoints[0][2].length;v>0&&(h+=4*(v-1))}}this.clear()};var Na=Ea,Ba=a.d,Ia=a.b,ka=Oi,Ra=c,_a=Hi,za=Ki,Ua=da,Da=Pa,Oa=Na,Va=function(e,t,r,i,a){this.config=a||{},this.core=e,this.marginFlags=0,this.progTile=null,this.progHeightmap=null,this.progSkydome=null,this.progWireframeTile=null,this.progWireframeTile2=null,this.progText=null,this.div=t,this.onUpdate=r,this.killed=!1,this.onlyDepth=!1,this.onlyLayers=!1,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1,this.hitmapCounter=0,this.geoRenderCounter=0,this.geoHitmapCounter=0,this.frameTime=0,this.geometries={},this.clearStencilPasses=[],this.onResizeCall=i,this.stencilLineState=null,this.drawLabelBoxes=!1,this.drawGridCells=!1,this.drawAllLabels=!1,this.debug={},this.mapHack=null,this.geodataSelection=[],this.hoverFeatureCounter=0,this.hoverFeatureList=[],this.touchSurfaceEvent=[];var s=this.div.getBoundingClientRect();this.winSize=[s.width,s.height],this.curSize=[s.width,s.height],this.oldSize=[s.width,s.height],this.dirty=!0,this.cameraVector=[0,1,0],this.viewExtent=1,this.gpu=new ka(this,t,this.curSize,this.config.rendererAllowScreenshots,this.config.rendererAntialiasing,this.config.rendererAnisotropic),this.camera=new za(this,45,2,12e5),this.drawTileMatrix=Ia.create(),this.drawTileMatrix2=Ia.create(),this.drawTileVec=[0,0,0],this.drawTileWorldMatrix=Ia.create(),this.pixelTileSizeMatrix=Ia.create(),this.heightmapMesh=null,this.heightmapTexture=null,this.skydomeMesh=null,this.skydomeTexture=null,this.hitmapTexture=null,this.geoHitmapTexture=null,this.hitmapSize=this.config.mapDMapSize,this.hitmapMode=this.config.mapDMapMode,this.updateHitmap=!0,this.updateGeoHitmap=!0,this.redTexture=null,this.rectVerticesBuffer=null,this.rectIndicesBuffer=null,this.imageProjectionMatrix=null,this.font=null,this.fonts={},this.fogDensity=0,this.gmap=new Array(2048),this.gmap2=new Array(2048),this.gmap3=new Array(1e4),this.gmap3Size=new Array(1e4),this.gmap4=new Array(1e4),this.gmapIndex=0,this.gmapTop=new Array(512),this.gmapHit=new Array(512),this.gmapStore=new Array(512),this.fmaxDist=0,this.fminDist=0,this.jobZBuffer=new Array(512),this.jobZBufferSize=new Array(512),this.jobZBuffer2=new Array(512),this.jobZBuffer2Size=new Array(512),this.jobHBuffer={},this.jobHBufferSize=0,this.jobHSortBuffer=new Array(2048);for(var n=0,o=this.jobZBuffer.length;n<o;n++)this.jobZBuffer[n]=[],this.jobZBufferSize[n]=0,this.jobZBuffer2[n]={},this.jobZBuffer2Size[n]=0;for(n=0,o=this.gmap3.length;n<o;n++)this.gmap3[n]=[],this.gmap3Size[n]=0;this.radixCountBuffer16=new Uint16Array(1024),this.radixCountBuffer32=new Uint32Array(1024),this.buffFloat32=new Float32Array(1),this.buffUint32=new Uint32Array(this.buffFloat32.buffer),this.layerGroupVisible=[],this.bitmaps={},this.cameraPosition=[0,0,0],this.cameraOrientation=[0,0,0],this.cameraTiltFator=1,this.cameraViewExtent=1,this.distanceFactor=1,this.tiltFactor=1,this.localViewExtentFactor=1,this.cameraVector=[0,0,0],this.labelVector=[0,0,0],this.drawnGeodataTiles=0,this.drawnGeodataTilesFactor=0,this.drawnGeodataTilesUsed=!1,this.progMap={},this.gridHmax=0,this.gridHmin=0,this.seCounter=0,this.updateCameraMatrix=Ia.create(),this.seTmpVec=[0,0,0],this.seTmpVec2=[0,0,0],this.seTmpVec3=[0,0,0],this.lastHitPosition=[0,0,100],this.logTilePos=null,this.setSuperElevation(0,2,4e3,1.5),window.addEventListener("resize",this.onResize.bind(this),!1),this.gpu.init(),this.init=new Ua(this),this.rmap=new Oa(this,50),this.draw=new Da(this);this.resizeGL(Math.floor(1*this.curSize[0]),Math.floor(1*this.curSize[1]))};Va.prototype.initProceduralShaders=function(){this.init.initProceduralShaders()},Va.prototype.onResize=function(){if(!this.killed){var e=this.div.getBoundingClientRect();this.resizeGL(Math.floor(e.width),Math.floor(e.height)),this.onResizeCall&&this.onResizeCall()}},Va.prototype.kill=function(){this.killed||(this.killed=!0,this.heightmapMesh&&this.heightmapMesh.kill(),this.heightmapTexture&&this.heightmapTexture.kill(),this.skydomeMesh&&this.skydomeMesh.kill(),this.skydomeTexture&&this.skydomeTexture.kill(),this.hitmapTexture&&this.hitmapTexture.kill(),this.geoHitmapTexture&&this.geoHitmapTexture.kill(),this.redTexture&&this.redTexture.kill(),this.whiteTexture&&this.whiteTexture.kill(),this.blackTexture&&this.blackTexture.kill(),this.lineTexture&&this.lineTexture.kill(),this.textTexture2&&this.textTexture2.kill(),this.atmoMesh&&this.atmoMesh.kill(),this.bboxMesh&&this.bboxMesh.kill(),this.font&&this.font.kill(),this.plines&&this.plines.kill(),this.plineJoints&&this.plineJoints.kill(),this.gpu.kill())},Va.prototype.resizeGL=function(e,t,r,i){this.camera.setAspect(e/t),this.curSize=[e,t],this.oldSize=[e,t],this.gpu.resize(this.curSize,r);var a=new Float32Array(16);a[0]=2/e,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2/t,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=.5*-e*a[0],a[13]=.5*-t*a[5],a[14]=0,a[15]=1,this.imageProjectionMatrix=a},Va.prototype.project2=function(e,t,r,i){var a=[0,0,0,1];if(0!=(a=r?Ia.multiplyVec4(t,[e[0]-r[0],e[1]-r[1],e[2]-r[2],1]):Ia.multiplyVec4(t,[e[0],e[1],e[2],1]))[3]){var s=[0,0,0];return s[0]=.5*(a[0]/a[3]+1)*this.curSize[0],s[1]=.5*(-a[1]/a[3]+1)*this.curSize[1],s[2]=a[2]/a[3],i&&(s[3]=a[2]),s}return[0,0,0]},Va.prototype.setSuperElevationState=function(e){this.useSuperElevation!=e&&(this.useSuperElevation=e,this.seCounter++)},Va.prototype.getSuperElevationState=function(){return this.useSuperElevation},Va.prototype.setSuperElevation=function(e,t,r,i){if(1==t&&1==i)return 0!=this.useSuperElevation&&(this.useSuperElevation=!1,this.seCounter++),e==r&&(r=e+1),void(this.superElevation=[e,t,r,i,r-e,i-t,1/(r-e)]);e==r&&(r=e+1),this.superElevation=[e,t,r,i,r-e,i-t,1/(r-e)],this.seCounter++},Va.prototype.getSuperElevation=function(){return this.superElevation.slice()},Va.prototype.getSuperElevatedHeight=function(e){var t=this.superElevation,r=e;return r<t[0]&&(r=t[0]),r>t[2]&&(r=t[2]),e*(t[1]+(r-t[0])*t[6]*t[5])},Va.prototype.getUnsuperElevatedHeight=function(e){var t=this.superElevation,r=e;if(t[1]==t[3])return r/t[1];if(r<=t[0]*t[1])return r/t[1];if(r>=t[2]*t[3])return r/t[3];var i=t[0],a=t[1],s=t[2],n=t[3];return-(Math.sqrt(-2*n*(a*i*s+2*i*r-2*s*r)+a*(a*s*s+4*i*r-4*s*r)+n*n*i*i)-a*s+n*i)/(2*(a-n))},Va.prototype.getEllipsoidHeight=function(e,t){var r,i;return this.seTmpVec3=[0,0,0],t?(r=this.seTmpVec,i=[e[0]+t[0],e[1]+t[1],(e[2]+t[2])*this.earthERatio]):i=[(r=e)[0],r[1],r[2]*this.earthERatio],Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2])-this.earthRadius},Va.prototype.transformPointBySE=function(e,t){var r,i=e;this.seTmpVec3=[0,0,0],r=t?[e[0]+t[0],e[1]+t[1],(e[2]+t[2])*this.earthERatio]:[i[0],i[1],i[2]*this.earthERatio];var a=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),s=this.seTmpVec2,n=1/(a+1e-4);s[0]=r[0]*n,s[1]=r[1]*n,s[2]=r[2]*n;var o=a-this.earthRadius;return n=this.getSuperElevatedHeight(o)-o,r[0]=i[0]+s[0]*n,r[1]=i[1]+s[1]*n,r[2]=i[2]+s[2]*n,r},Va.prototype.transformPointBySE2=function(e,t){var r,i=e;this.seTmpVec3=[0,0,0],r=t?[e[0]+t[0],e[1]+t[1],(e[2]+t[2])*this.earthERatio]:[i[0],i[1],i[2]*this.earthERatio];var a=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),s=this.seTmpVec2,n=1/(a+1e-4);s[0]=r[0]*n,s[1]=r[1]*n,s[2]=r[2]*n;var o=a-this.earthRadius;return n=this.getSuperElevatedHeight(o)-o,(e=e.slice())[0]=i[0]+s[0]*n,e[1]=i[1]+s[1]*n,e[2]=i[2]+s[2]*n,e[13]=s[0]*n,e[14]=s[1]*n,e[15]=s[2]*n,e},Va.prototype.project=function(e){var t,r=this.camera.getMvpMatrix(),i=this.camera.getPosition(),a=this.cameraPosition(),s=[e[0]-a[0]+i[0],e[1]-a[1]+i[1],e[2]-a[2]+i[2],1];if(0!=(t=Ia.multiplyVec4(r,s))[3]){var n=[0,0,0];return n[0]=.5*(t[0]/t[3]+1)*this.curSize[0],n[1]=.5*(-t[1]/t[3]+1)*this.curSize[1],n[2]=t[2]/t[3],n}return[0,0,0]},Va.prototype.getScreenRay=function(e,t){if(null==this.camera)return[0,0,1];this.camera.dirty=!0;var r=[2*e/this.curSize[0]-1,1-2*t/this.curSize[1],1],i=[r[0],r[1],-1,1],a=Ia.create();a=Ia.inverse(this.camera.getProjectionMatrix());var s=[0,0,0,0];Ia.multiplyVec4(a,i,s),s[2]=-1,s[3]=0;var n=Ia.create();n=Ia.inverse(this.camera.getModelviewMatrix());var o=[0,0,0,0];return Ia.multiplyVec4(n,s,o),o=Ba.normalize([o[0],o[1],o[2]])},Va.prototype.hitTestGeoLayers=function(e,t,r){this.gpu.gl;var i,a=!1;if(e>=0&&e<this.curSize[0]&&t>=0&&t<this.curSize[1]){var s,n;s=Math.floor(e*(this.hitmapSize/this.curSize[0])),n=Math.floor(t*(this.hitmapSize/this.curSize[1])),a=!(255==(i=r?this.geoHitmapTexture2.readFramebufferPixels(s,this.hitmapSize-n-1,1,1):this.geoHitmapTexture.readFramebufferPixels(s,this.hitmapSize-n-1,1,1))[0]&&255==i[1]&&255==i[2]&&255==i[3])}return a?[!0,i[0],i[1],i[2],i[3]]:[!1,0,0,0,0]},Va.prototype.switchToFramebuffer=function(e,t){var r,i,a,s=this.gpu.gl;switch(e){case"base":i=this.oldSize[0],a=this.oldSize[1],s.clearColor(0,0,0,1),s.viewport(0,0,i,a),this.gpu.setFramebuffer(null),this.camera.setAspect(i/a),this.curSize=[i,a],this.gpu.resize(this.curSize,!0),this.camera.update(),this.onlyDepth=!1,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1;break;case"depth":this.gpu.setFramebuffer(this.hitmapTexture),this.oldSize=[this.curSize[0],this.curSize[1]],s.clearColor(1,1,1,1),s.enable(s.DEPTH_TEST),r=this.hitmapSize,s.viewport(0,0,r,r),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),this.curSize=[r,r],this.camera.update(),this.onlyDepth=!0,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1;break;case"geo":case"geo2":this.hoverFeatureCounter=0,r=this.hitmapSize,this.gpu.setFramebuffer("geo"==e?this.geoHitmapTexture:this.geoHitmapTexture2),i=r,a=r,s.clearColor(1,1,1,1),s.enable(s.DEPTH_TEST),s.viewport(0,0,r,r),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),this.curSize=[i,a],this.onlyHitLayers=!0,this.advancedPassNeeded=!1,this.onlyAdvancedHitLayers="geo2"==e,this.camera.update();break;case"texture":this.gpu.setFramebuffer(t),this.oldSize=[this.curSize[0],this.curSize[1]],s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.viewport(0,0,this.gpu.canvas.width,this.gpu.canvas.height),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),this.curSize=[this.gpu.canvas.width,this.gpu.canvas.height],this.camera.update(),this.onlyDepth=!1,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1}},Va.prototype.hitTest=function(e,t){this.gpu.gl;var r,i,a=this.getScreenRay(e,t),s=this.camera.getPosition();r=Math.floor(e*(this.hitmapSize/this.curSize[0])),i=Math.floor(t*(this.hitmapSize/this.curSize[1]));var n=this.hitmapTexture.readFramebufferPixels(r,this.hitmapSize-i-1,1,1),o=n[0]*(1/255)+n[1]+255*n[2]+65025*n[3],h=!(255==n[0]&&255==n[1]&&255==n[2]&&255==n[3]);return this.lastHitPosition=[s[0]+a[0]*o,s[1]+a[1]*o,s[2]+a[2]*o],[this.lastHitPosition[0],this.lastHitPosition[1],this.lastHitPosition[2],h,a,o,s]},Va.prototype.copyHitmap=function(){this.hitmapTexture.readFramebufferPixels(0,0,this.hitmapSize,this.hitmapSize,!1,this.hitmapData)},Va.prototype.getDepth=function(e,t){var r=Math.floor(e*(this.hitmapSize/this.curSize[0])),i=Math.floor(t*(this.hitmapSize/this.curSize[1]));if(this.hitmapMode<=2)var a=this.hitmapTexture.readFramebufferPixels(r,this.hitmapSize-i-1,1,1,2==this.hitmapMode),s=a[0]*(1/255)+a[1]+255*a[2]+65025*a[3],n=!(255==a[0]&&255==a[1]&&255==a[2]&&255==a[3]);else{var o=this.hitmapData,h=4*(r+(this.hitmapSize-i-1)*this.hitmapSize),l=o[h],u=o[h+1],d=o[h+2],c=o[h+3];s=l*(1/255)+u+255*d+65025*c,n=!(255==l&&255==u&&255==d&&255==c)}return[n,s]},Va.prototype.getZoffsetFactor=function(e){return 1e-4*(e[0]+e[1]*this.distanceFactor+e[2]*this.tiltFactor)},Va.prototype.saveScreenshot=function(e,t,r){var i=this.gpu.gl,a=this.curSize[0],s=this.curSize[1],n=new Uint8Array(a*s*4);i.readPixels(0,0,a,s,i.RGBA,i.UNSIGNED_BYTE,n);for(var o=new Uint8Array(a*s*4),h=0,l=0;l<s;l++)for(var u=(s-1-l)*a*4,d=0;d<a;d++)o[h]=n[u],o[h+1]=n[u+1],o[h+2]=n[u+2],o[h+3]=n[u+3],h+=4,u+=4;var c=document.createElement("canvas");c.width=a,c.height=s;var p=c.getContext("2d"),f=p.createImageData(a,s);if(f.data.set(o),p.putImageData(f,0,0),r=r||"jpg","file"==e){for(var m=document.createElement("a"),g=c.toDataURL("image/"+r),v=atob(g.split(",")[1]),y=new ArrayBuffer(v.length),b=new Uint8Array(y),x=0;x<v.length;x++)b[x]=v.charCodeAt(x);var S=new Blob([y],{type:r}),M=URL.createObjectURL(S);m.href=M,m.download=t,document.body.appendChild(m),m.click(),setTimeout((function(){document.body.removeChild(m),window.URL.revokeObjectURL(M)}),0)}return"tab"==e&&window.open(c.toDataURL("image/"+r)),f},Va.prototype.getBitmap=function(e,t,r,i,a){var s=(a?i:e)+"*"+t+"*"+r,n=this.bitmaps[s];return!n&&e&&(n=new Ra(this.gpu,e,this.core,null,null,r,t),this.bitmaps[s]=n),n},Va.prototype.getFont=function(e){var t=this.fonts[e];return t||(t=new _a(this.gpu,this.core,null,null,e),this.fonts[e]=t),t};var Ga=Va,ja=a.d,Ha=function(){this.root=null,this.maxItemsPerNode=20,this.maxDepth=20,this.depthCount=[];for(var e=0;e<1e3;e++)this.depthCount[e]=0;this.pattern=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])]};Ha.prototype.clear=function(){},Ha.prototype.buildFromGeometry=function(e){if(e){var t,r,i,a,s,n,o,h,l,u,d,c,p,f,m,g,v,y;for(d=c=p=Number.POSITIVE_INFINITY,f=m=g=Number.NEGATIVE_INFINITY,t=0,r=e.length;t<r;t++)if("mesh"==(v=e[t]).type)for(i=0,a=(h=v.submeshes).length;i<a;i++)(l=h[i].bbox)[0][0]<d&&(d=l[0][0]),l[0][1]<c&&(c=l[0][1]),l[0][2]<p&&(p=l[0][2]),l[1][0]>f&&(f=l[1][0]),l[1][1]>m&&(m=l[1][1]),l[1][2]>g&&(g=l[1][2]);for(this.root=new qa([d,c,p],[f,m,g]),t=0,r=e.length;t<r;t++)if("mesh"==(v=e[t]).type)for(i=0,a=(h=v.submeshes).length;i<a;i++)for(s=0,n=(y=h[i].vertices).length;s<n;s+=9){for(d=c=p=Number.POSITIVE_INFINITY,f=m=g=Number.NEGATIVE_INFINITY,o=0;o<3;o++)y[u=s+3*o]<d&&(d=y[u]),y[u+1]<c&&(c=y[u+1]),y[u+2]<p&&(p=y[u+2]),y[u]>f&&(f=y[u]),y[u+1]>m&&(m=y[u+1]),y[u+2]>g&&(g=y[u+2]);this.root.add([d,c,p,f,m,g,y,s],this)}}};var qa=function(e,t){this.min=e,this.max=t,this.children=null,this.items=null};qa.prototype.add=function(e,t,r){if(this.children){r||(r=0);for(var i=0;i<8;i++){var a=this.children[i],s=a.min,n=a.max;e[0]<n[0]&&e[3]>s[0]&&e[1]<n[1]&&e[4]>s[1]&&e[2]<n[2]&&e[5]>s[2]&&a.add(e,t,r+1)}}else this.items||(this.items=[]),this.items.push(e),r<t.maxDepth&&this.items.length>=t.maxItemsPerNode&&this.split(t,r+1)},qa.prototype.split=function(e,t){var r,i,a,s=this.min,n=this.max,o=[.5*(n[0]+s[0]),.5*(n[1]+s[1]),.5*(n[2]+s[2])];for(this.children=[null,null,null,null,null,null,null,null],this.depthCount[t]++,r=0;r<8;r++){var h=e.pattern[r];this.children[r]=new qa([0===h[0]?s[0]:o[0],0===h[1]?s[1]:o[1],0===h[2]?s[2]:o[2]],[0===h[0]?o[0]:n[0],0===h[1]?o[1]:n[1],0===h[2]?o[2]:n[2]])}var l=this.items;if(l)for(r=0,i=l.length;r<i;r++){var u=l[r];for(a=0;a<8;a++){var d=this.children[a];s=d.min,n=d.max,u[0]<n[0]&&u[3]>s[0]&&u[1]<n[1]&&u[4]>s[1]&&u[2]<n[2]&&u[5]>s[2]&&d.add(u,e)}}this.items=null};var Wa=function(){this.octantTable=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],this.flags=0};Wa.prototype.findEntryOctant=function(e,t,r,i,a,s){var n=0;return e>t&&e>r?(a<e&&(n|=2),s<e&&(n|=1)):t>r?(i<t&&(n|=4),s<t&&(n|=1)):(i<r&&(n|=4),a<r&&(n|=2)),n},Wa.prototype.findNextOctant=function(e,t,r,i){var a,s=0;return t<r?(a=t,s=0):(a=r,s=1),i<a&&(s=2),this.octantTable[e][s]},Wa.prototype.raycastOctant=function(e,t,r,i,a,s,n,o){var h,l,u,d,c=e.children;if(a>=0&&s>=0&&n>=0)if(c){l=.5*(t+a),u=.5*(r+s),d=.5*(i+n),h=this.findEntryOctant(t,r,i,l,u,d);do{switch(h){case 0:this.raycastOctant(c[this.flags],t,r,i,l,u,d,o),h=this.findNextOctant(h,l,u,d);break;case 1:this.raycastOctant(c[1^this.flags],t,r,d,l,u,n,o),h=this.findNextOctant(h,l,u,n);break;case 2:this.raycastOctant(c[2^this.flags],t,u,i,l,s,d,o),h=this.findNextOctant(h,l,s,d);break;case 3:this.raycastOctant(c[3^this.flags],t,u,d,l,s,n,o),h=this.findNextOctant(h,l,s,n);break;case 4:this.raycastOctant(c[4^this.flags],l,r,i,a,u,d,o),h=this.findNextOctant(h,a,u,d);break;case 5:this.raycastOctant(c[5^this.flags],l,r,d,a,u,n,o),h=this.findNextOctant(h,a,u,n);break;case 6:this.raycastOctant(c[6^this.flags],l,u,i,a,s,d,o),h=this.findNextOctant(h,a,s,d);break;case 7:this.raycastOctant(c[7^this.flags],l,u,d,a,s,n,o),h=8}}while(h<8)}else e.items&&o.push(e)},Wa.prototype.hitFace=function(e,t,r,i){var a,s,n,o,h,l,u=[i[r],i[r+1],i[r+2]],d=[i[r+3],i[r+4],i[r+5]],c=[i[r+6],i[r+7],i[r+8]],p=[0,0,0],f=[d[0]-u[0],d[1]-u[1],d[2]-u[2]],m=[c[0]-u[0],c[1]-u[1],c[2]-u[2]];return ja.cross(t,m,p),(n=ja.dot(f,p))>-1e-7&&n<1e-7?[!1]:(o=1/n,s=[e[0]-u[0],e[1]-u[1],e[2]-u[2]],(h=o*ja.dot(s,p))<0||h>1?[!1]:(a=ja.cross(s,f),(l=o*ja.dot(t,a))<0||h+l>1?[!1]:[!0,o*ja.dot(m,a)]))},Wa.prototype.intersectOctree=function(e,t,r,i){var a,s,n,o,h,l,u,d,c,p=[0,0,0],f=[r.root.max[0]-r.root.min[0],r.root.max[1]-r.root.min[1],r.root.max[2]-r.root.min[2]],m=[f[0],f[1],f[2]],g=[.5*m[0],.5*m[1],.5*m[2]],v=[e[0],e[1],e[2]],y=[t[0],t[1],t[2]],b=[.5*(r.root.max[0]+r.root.min[0]),.5*(r.root.max[1]+r.root.min[1]),.5*(r.root.max[2]+r.root.min[2])];v[0]=v[0]-b[0]+g[0],v[1]=v[1]-b[1]+g[1],v[2]=v[2]-b[2]+g[2],this.flags=0,y[0]<0&&(v[0]=m[0]-v[0],y[0]=-y[0],this.flags|=4),y[1]<0&&(v[1]=m[1]-v[1],y[1]=-y[1],this.flags|=2),y[2]<0&&(v[2]=m[2]-v[2],y[2]=-y[2],this.flags|=1),a=1/y[0],s=1/y[1],n=1/y[2],o=(p[0]-v[0])*a,h=(f[0]-v[0])*a,l=(p[1]-v[1])*s,u=(f[1]-v[1])*s,d=(p[2]-v[2])*n,c=(f[2]-v[2])*n,Math.max(Math.max(o,l),d)<Math.min(Math.min(h,u),c)&&this.raycastOctant(r.root,o,l,d,h,u,c,i)},Wa.prototype.intersectOctants=function(e,t,r){for(var i=[],a=Number.POSITIVE_INFINITY,s=0,n=r.length;s<n;s++)for(var o=r[s].items,h=0,l=o.length;h<l;h++){var u=o[h],d=this.hitFace(e,t,u[7],u[6]);d[0]&&d[1]<a&&(a=d[1])}return a!==Number.POSITIVE_INFINITY&&(i=[a]),i};var Ja=c,Za=q,Ya=$,Ka=Ha,Xa=Wa,Qa=function(e){this.renderer=e,this.gpu=e.gpu};Qa.prototype.clear=function(e){return null!=e&&this.gpu.clear(e.clearDepth||!0,e.clearColor||!1,e.color||[255,255,255,255],null!=e.depth?e.depth:1),this},Qa.prototype.createState=function(e){if(null==e||"object"!=typeof e)return this;var t={blend:null!=e.blend&&e.blend,stencil:null!=e.stencil&&e.stencil,zoffset:null!=e.zoffset?e.zoffset:0,zwrite:null==e.zwrite||e.zwrite,ztest:null==e.ztest||e.ztest,zequal:null==e.zequal||e.zequal,culling:null==e.culling||e.culling};return this.gpu.createState(t)},Qa.prototype.setState=function(e){return null!=e&&this.gpu.setState(e),this},Qa.prototype.createTexture=function(e){if(null==e||"object"!=typeof e)return null;var t=e.source;if(null==t)return null;var r,i=e.filter||"linear",a=e.repeat||!1;if(t instanceof Uint8Array){var s=e.width,n=e.height;if(s&&n)return(r=new Ja(this.gpu)).createFromData(s,n,t,i,a),r}return t instanceof Image?((r=new Ja(this.gpu)).createFromImage(t,i,a),r):null},Qa.prototype.removeTexture=function(e){return e&&e.kill(),this},Qa.prototype.createMesh=function(e){if(null==e||"object"!=typeof e)return null;var t={vertices:e.vertices,uvs:e.uvs,uvs2:e.normals,vertexSize:e.vertexSize,uvSize:e.uvSize,uv2Size:e.normalSize||3,vertexAttr:e.vertexAttr,uvAttr:e.uvAttr,uv2Attr:e.normalAttr,bbox:e.bbox};return new Za(this.gpu,t,0,this.renderer.core)},Qa.prototype.removeMesh=function(e){return e&&e.kill(),this},Qa.prototype.createShader=function(e){if(null==e||"object"!=typeof e)return null;var t=e.vertexShader,r=e.fragmentShader;return null!=t&&r?new Ya(this.gpu,t,r):void 0},Qa.prototype.removeResource=function(e){return null!=e&&null!=e.kill&&e.kill(),this},Qa.prototype.addJob=function(){return this},Qa.prototype.clearJobs=function(){return this},Qa.prototype.drawMesh=function(e){if(null==e||"object"!=typeof e)return this;if(null==!e.mesh||!e.shaderVariables)return this;var t=e.vertex||"aPosition",r=e.uv||"aTexCoord",i=e.normal||"aNormal",a=null!=e.depthOffset?e.depthOffset:null,s=e.shaderVariables,n=e.shader||"textured",o=this.renderer,h=e.mesh,l=e.texture,u=o.camera.getModelviewMatrix(),d=o.camera.getProjectionMatrix(),c=o.fogDensity;if("string"==typeof n)switch(n){case"hit":s.uMV||(s.uMV=["mat4",u]),s.uProj||(s.uProj=["mat4",d]),r=null,i=null,l=null,n=o.progDepthTile[0];break;case"shaded":r=null;case"textured":case"textured-and-shaded":s.uMV||(s.uMV=["mat4",u]),s.uProj||(s.uProj=["mat4",d]),s.uFogDensity||(s.uFogDensity=["float",c]),i="textured"==n?null:"aNormal",n="textured"==n?o.progTile[0]:"shaded"==n?o.progShadedTile:o.progTShadedTile}if(n&&n.isReady()){var p=[t];for(var f in r&&p.push(r),i&&p.push(i),o.gpu.useProgram(n,p),s){var m=s[f];if(2==m.length)switch(m[0]){case"floatArray":n.setFloatArray(f,m[1]);break;case"float":n.setFloat(f,m[1]);break;case"mat3":n.setMat3(f,m[1]);break;case"mat4":a&&"uProj"==f?n.setMat4(f,m[1],o.getZoffsetFactor(a)):n.setMat4(f,m[1]);break;case"vec2":n.setVec2(f,m[1]);break;case"vec3":n.setVec3(f,m[1]);break;case"vec4":n.setVec4(f,m[1]);break;case"sampler":n.setSampler(f,m[1])}}return l&&o.gpu.bindTexture(l),h.draw(n,t,r,i,null),this}},Qa.prototype.drawImage=function(e){if(null==e||"object"!=typeof e)return this;if(null==e.texture||null==e.rect)return this;var t=e.rect,r=e.color||[255,255,255,255],i=null!=e.depth?e.depth:0,a=null!=e.depthOffset?e.depthOffset:null,s=null!=e.depthTest&&e.depthTest,n=null!=e.blend&&e.blend,o=null!=e.writeDepth&&e.writeDepth,h=null!=e.useState&&e.useState;return r=[r[0]*(1/255),r[1]*(1/255),r[2]*(1/255),r[3]*(1/255)],this.renderer.draw.drawImage(t[0],t[1],t[2],t[3],e.texture,r,i,a,s,n,o,h),this},Qa.prototype.drawBillboard=function(e){if(null==e||"object"!=typeof e)return this;if(null==e.texture||null==e.mvp)return this;var t=e.mvp,r=e.color||[255,255,255,255],i=null!=e.depthOffset?e.depthOffset:null,a=null!=e.depthTest&&e.depthTest,s=null!=e.blend&&e.blend,n=null!=e.writeDepth&&e.writeDepth,o=null!=e.useState&&e.useState;return r[0]*=1/255,r[1]*=1/255,r[2]*=1/255,r[3]*=1/255,this.renderer.draw.drawBillboard(t,e.texture,r,i,a,s,n,o),this},Qa.prototype.drawLineString=function(e){if(null==e||"object"!=typeof e)return this;if(null==e.points)return this;var t=e.points,r=e.color||[255,255,255,255],i=null!=e.depthOffset?e.depthOffset:null,a=e.size||2,s=null==e.screenSpace||e.screenSpace,n=null!=e.depthTest&&e.depthTest,o=null!=e.blend&&e.blend,h=null!=e.writeDepth&&e.writeDepth,l=null!=e.useState&&e.useState;return r[0]*=1/255,r[1]*=1/255,r[2]*=1/255,r[3]*=1/255,this.renderer.draw.drawLineString(t,s,a,r,i,n,o,h,l),this},Qa.prototype.drawJobs=function(){return this},Qa.prototype.drawBBox=function(){return this},Qa.prototype.drawDebugText=function(e){if(null==e||"object"!=typeof e)return this;var t=e.text,r=e.coords;if(!t||!r)return this;var i=e.color||[255,255,255,255],a=e.size||16,s=e.depth,n=e.useState||!1;i[0]*=1/255,i[1]*=1/255,i[2]*=1/255,i[3]*=1/255;var o=this.renderer.draw.getTextSize(a,t);return this.renderer.draw.drawText(r[0]-.5*o,r[1],a,t,i,s,n),this},Qa.prototype.buildOctreeFromGeometry=function(e){var t=new Ka;return t.buildFromGeometry(e),t},Qa.prototype.raycastOctreeGeometry=function(e,t,r){var i=new Xa,a=[];return i.intersectOctree(t,r,e,a),i.intersectOctants(t,r,a)},Qa.prototype.saveScreenshot=function(e,t,r){return this.renderer.saveScreenshot(e,t,r)},Qa.prototype.getCanvasCoords=function(e,t){return this.renderer.project2(e,t)},Qa.prototype.getCanvasSize=function(){return this.renderer.curSize.slice()},Qa.prototype.setConfigParams=function(e){return this.renderer.setConfigParams(e),this},Qa.prototype.setConfigParam=function(e,t){return this.renderer.setConfigParam(e,t),this},Qa.prototype.getConfigParam=function(e){return this.renderer.getConfigParam(e)},Qa.prototype.getGLInterface=function(){return{canvas:this.gpu.canvas,gl:this.gpu.gl}},Qa.prototype.setSuperElevation=function(e,t,r,i){return this.renderer.setSuperElevation(e,t,r,i)},Qa.prototype.setMarginFlags=function(e){return this.renderer.marginFlags=e},Qa.prototype.getMarginFlags=function(){return this.renderer.marginFlags};var $a=Qa,es=p.a,ts=function(e,t,r,i){this.map=e,this.p1=t.clone(),this.p2=r.clone(),this.op2=r.clone();var a=this.p1.getHeightMode(),s=this.p2.getHeightMode();"fix"==a&&"float"==s?this.p1=this.map.convert.convertPositionHeightMode(this.p1,"float",!0):"float"==a&&"fix"==s&&(this.p1=this.map.convert.convertPositionHeightMode(this.p1,"fix",!0));var n=this.p1.getViewMode(),o=this.p2.getViewMode();if("subj"==n&&"obj"==o?this.p2=this.map.convert.convertPositionViewMode(this.p2,"subj"):"obj"==n&&"subj"==o&&(this.p1=this.map.convert.convertPositionViewMode(this.p1,"subj")),this.p1.pos[5]=this.p1.pos[5]<0?360+this.p1.pos[5]%360:this.p1.pos[5]%360,this.p2.pos[5]=this.p2.pos[5]<0?360+this.p2.pos[5]%360:this.p2.pos[5]%360,this.pp1=this.p1.clone(),this.mode=i.mode||"auto",this.submode=i.submode||"none",this.submode="none",this.maxHeight=i.maxHeight||1e9,this.minDuration=i.minDuration||0,this.maxDuration=i.maxDuration||1e4,this.samplePeriod=i.samplePeriod||10,this.fade=i.fade||"none",this.fadePower=i.fadePower||1,this.yawInterpolation=i.yawInterpolation||"shortest",this.pv=i.pv||.15,this.map.getNavigationSrs().isProjected()||(this.geodesic=this.map.measure.getGeodesic()),i.distanceAzimuth)this.distanceAzimuth=!0,this.pp2=this.p1.clone(),i.destHeight&&this.pp2.setHeight(i.destHeight),i.destOrientation&&this.pp2.setHeight(i.destOrientation),i.destFov&&this.pp2.setHeight(i.destFov),this.geoAzimuth=i.azimuth||0,this.geoDistance=i.distance||100,this.distance=this.geoDistance,this.azimuth=this.geoAzimuth%360,this.azimuth=this.azimuth<0?360+this.azimuth:this.azimuth;else{this.distanceAzimuth=!1,this.pp2=this.p2.clone();var h=this.map.measure.getDistance(this.pp1.getCoords(),this.pp2.getCoords());this.distance=h[0],this.azimuth=(h[1]+90)%360,this.azimuth=this.azimuth<0?360+this.azimuth:this.azimuth,this.map.getNavigationSrs().isProjected()||(h=this.geodesic.Inverse(this.pp1.pos[2],this.pp1.pos[1],this.pp2.pos[2],this.pp2.pos[1]),this.geoAzimuth=h.azi1,this.geoDistance=h.s12,this.azimuth=this.geoAzimuth%360,this.azimuth=this.azimuth<0?360+this.azimuth:this.azimuth)}this.detectMode(),this.detectDuration(),this.detectFlightHeight(i.height)};ts.prototype.detectFlightHeight=function(e){"ballistic"==this.mode&&(this.flightHeight=Math.max(this.pp1.getHeight(),this.pp2.getHeight()),this.flightHeight+=e||.5*this.distance,this.flightHeight=Math.min(this.flightHeight,this.maxHeight),this.flightHeight-=Math.max(this.pp1.getHeight(),this.pp2.getHeight()))},ts.prototype.detectMode=function(){"auto"==this.mode&&(this.mode=this.distance>2e3?"ballistic":"direct")},ts.prototype.detectDuration=function(){if(this.duration=0,this.headingDuration=1e3,this.distance<500?this.duration=1e3:this.distance<2e3?this.duration=2e3:(this.duration=this.distance/100,this.duration<300?this.duration=3e3:this.headingDuration=1500,this.duration<6e3&&(this.duration=6e3),this.duration>1e4&&(this.duration=1e4),"direct"!=this.mode&&(this.duration*=1.8,this.headingDuration*=1.8)),"direct"!=this.mode){var e=3*this.headingDuration;this.duration=Math.max(this.duration,e),this.maxDuration<e&&(this.duration=this.maxDuration,this.headingDuration=this.maxDuration/3)}this.duration=Math.min(this.duration,this.maxDuration),this.duration=Math.max(this.duration,this.minDuration)},ts.prototype.generate=function(){for(var e=new Array(Math.ceil(this.duration/this.samplePeriod)+(this.distanceAzimuth?0:1)),t=0,r=0;r<=this.duration;r+=this.samplePeriod){var i,a,s=r/this.duration,n=this.pp1.clone();if("direct"==this.mode){switch(i=s,this.fade){case"in":switch(this.fadePower){case 1:s=i*i;break;case 2:s=i*i*i;break;case 3:s=i*i*i*i;break;case 4:s=i*i*i*i*i;break;case 5:s=i*i*i*i*i*i;break;case 6:s=i*i*i*i*i*i*i}break;case"out":switch(i=1-i,this.fadePower){case 1:s=1-i*i;break;case 2:s=1-i*i*i;break;case 3:s=1-i*i*i*i;break;case 4:s=1-i*i*i*i*i;break;case 5:s=1-i*i*i*i*i*i;break;case 6:s=1-i*i*i*i*i*i*i}break;case"inout":switch(this.fadePower){case 1:s=i*i*(3-2*i);break;case 2:s=i*i*i*(i*(6*i-15)+10);break;case 3:s=(i=s=i*i*(3-2*i))*i*(3-2*i);break;case 4:s=(i=s=i*i*i*(i*(6*i-15)+10))*i*i*(i*(6*i-15)+10);break;case 5:s=(i=s=(i=s=i*i*(3-2*i))*i*(3-2*i))*i*(3-2*i);break;case 6:s=(i=s=(i=s=i*i*i*(i*(6*i-15)+10))*i*i*(i*(6*i-15)+10))*i*i*(i*(6*i-15)+10)}}n.setCoords(this.getInterpolatedCoords(s)),n.setHeight(this.getInterpolatedHeight(s));var o=this.pp1.getOrientation(),h=this.pp2.getOrientation();n.setOrientation(this.getInterpolatedOrinetation(o,h,s)),n.setFov(this.getInterpolatedFov(s)),n.setViewExtent(this.getInterpolatedViewExtent(s)),e[t]=n.pos,t++}else{s=(i=s=(i=s)*i*(3-2*i))*i*(3-2*i);var l=this.getSmoothFactor(r);if("piha"==this.submode){var u=this.distance/this.duration*(r-this.duration/(2*Math.PI)*Math.sin(2*Math.PI/this.duration*r))/this.distance,d=this.pv,c=this.pp1.getCoords()[2],p=this.pp2.getCoords()[2],f=this.distance/(.001*this.duration*d*Math.tan(.5*es.radians(this.pp1.getFov())))*(1-Math.cos(2*Math.PI*r/this.duration))+c+(p-c)*r/this.duration;a=this.getInterpolatedCoords(u),n.setCoords(a),n.setHeight(f)}else a=this.getInterpolatedCoords(l),n.setCoords(a),n.setHeight(this.getSineHeight(s));null!=a[3]&&(this.azimuth=-a[3]),n.setOrientation(this.getFlightOrienation(r)),n.setFov(this.getInterpolatedFov(s)),n.setViewExtent(this.getInterpolatedViewExtent(s)),e[t]=n.pos,e[t]=n.pos,t++}}return this.distanceAzimuth||(e[t]=this.op2.clone().pos),e},ts.prototype.getInterpolatedCoords=function(e){var t=this.pp1.getCoords(),r=this.pp2.getCoords();if(this.map.getNavigationSrs().isProjected())return[t[0]+(r[0]-t[0])*e,t[1]+(r[1]-t[1])*e,t[2]+(r[2]-t[2])*e];var i=this.geodesic.Direct(t[1],t[0],this.geoAzimuth,this.geoDistance*e),a=i.azi1-i.azi2;return a=this.azimuth<0?360+a:a,[i.lon2,i.lat2,t[2]+(r[2]-t[2])*e,a]},ts.prototype.getInterpolatedOrinetation=function(e,t,r){var i=t[0]-e[0],a=t[1]-e[1],s=t[2]-e[2];return"shortest"!=this.yawInterpolation&&"longest"!=this.yawInterpolation||Math.abs(i)>180&&(i=i>0?-(360-i):360-Math.abs(i)),"longest"==this.yawInterpolation&&(i=i<0?360+i:-360+i),[e[0]+i*r,e[1]+a*r,e[2]+s*r]},ts.prototype.getInterpolatedFov=function(e){var t=this.pp1.getFov();return t+(this.pp2.getFov()-t)*e},ts.prototype.getInterpolatedViewExtent=function(e){var t=this.pp1.getViewExtent();return t+(this.pp2.getViewExtent()-t)*e},ts.prototype.getInterpolatedHeight=function(e){var t=this.pp1.getHeight();return t+(this.pp2.getHeight()-t)*e},ts.prototype.getSineHeight=function(e){var t=this.pp1.getCoords(),r=this.pp2.getCoords();return t[2]+(r[2]-t[2])*e+Math.sin(Math.PI*e)*this.flightHeight},ts.prototype.getSmoothFactor=function(e){var t=0;return(t=(t=e<this.headingDuration?0:e>this.duration-this.headingDuration?1:Math.min(1,(e-this.headingDuration)/(this.duration-2*this.headingDuration)))*t*(3-2*t))*t*(3-2*t)},ts.prototype.getFlightOrienation=function(e){var t=null,r=null,i=[0,-90,0],a=0;return i[0]=this.azimuth%360,i[0]<0&&(i[0]=360-Math.abs(i[0])),e<=this.headingDuration?(a=e/this.headingDuration,t=this.pp1.getOrientation(),r=i):e>=this.duration-this.headingDuration?(a=(e-(this.duration-this.headingDuration))/this.headingDuration,t=i,r=this.pp2.getOrientation()):(a=0,t=i,r=i),this.getInterpolatedOrinetation(t,r,a)};var rs=ts,is=ut,as=Ft,ss=_r,ns=Le,os=function(e){this.map=e,this.config=e.config};os.prototype.setPosition=function(e){return this.map.setPosition(e),this},os.prototype.getPosition=function(){return this.map.getPosition()},os.prototype.setView=function(e,t,r){return this.map.setView(e,t,r),this},os.prototype.getView=function(){return this.map.getView()},os.prototype.getCredits=function(){return this.map.getCredits()},os.prototype.getCurrentCredits=function(){return this.map.getVisibleCredits()},os.prototype.getCreditInfo=function(e){var t=this.map.getCreditById(e);return t?t.getInfo():{}},os.prototype.getViews=function(){return this.map.getNamedViews()},os.prototype.getViewInfo=function(e){var t=this.map.getNamedView(e);return t?t.getInfo():{}},os.prototype.getBoundLayers=function(){return this.map.getBoundLayers()},os.prototype.getBoundLayerInfo=function(e){return this.map.getBoundLayerInfo(e)},os.prototype.getFreeLayers=function(){return this.map.getFreeLayers()},os.prototype.getFreeLayerInfo=function(e){var t=this.map.getFreeLayer(e);return t?t.getInfo():{}},os.prototype.getSurfaces=function(){return this.map.getSurfaces()},os.prototype.getSurfaceInfo=function(e){var t=this.map.getFreeLayer(e);return t?t.getInfo():{}},os.prototype.getSrses=function(){return this.map.getSrses()},os.prototype.getSrsInfo=function(e){var t=this.map.getSrs(e);return t?t.getInfo():{}},os.prototype.getReferenceFrame=function(){return this.map.referenceFrame.getInfo()},os.prototype.addFreeLayer=function(e,t){var r=new as(this.map,t,"free");this.map.addFreeLayer(e,r)},os.prototype.removeFreeLayer=function(e){this.map.removeFreeLayer(e)},os.prototype.addBoundLayer=function(e,t){var r=new is(this.map,t,e);this.map.addBoundLayer(e,r)},os.prototype.removeBoundLayer=function(e){this.map.removeBoundLayer(e)},os.prototype.convertPositionViewMode=function(e,t){return this.map.convert.convertPositionViewMode(new ss(e),t)},os.prototype.convertPositionHeightMode=function(e,t,r){return this.map.convert.convertPositionHeightMode(new ss(e),t,r)},os.prototype.convertCoords=function(e,t,r){var i=this.map.getSrs(e),a=this.map.getSrs(t);return i&&a?a.convertCoordsFrom(r,i):null},os.prototype.convertCoordsFromNavToPublic=function(e,t,r){var i=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionPublicCoords(new ss(i),r)},os.prototype.convertCoordsFromPublicToNav=function(e,t,r){var i=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionNavCoordsFromPublic(new ss(i),r)},os.prototype.convertCoordsFromPhysToPublic=function(e,t){if(t&&this.map.renderer.useSuperElevation){var r=this.map.renderer.transformPointBySE(e);return this.map.convert.convertCoords(r,"physical","public")}return this.map.convert.convertCoords(e,"physical","public")},os.prototype.convertCoordsFromNavToPhys=function(e,t,r,i){var a=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionPhysCoords(new ss(a),r,i)},os.prototype.convertCoordsFromPhysToNav=function(e,t,r,i){return this.map.convert.convertCoordsFromPhysToNav(e,t,r,i)},os.prototype.convertCoordsFromNavToCanvas=function(e,t,r){var i=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionCanvasCoords(new ss(i),r)},os.prototype.convertCoordsFromPhysToCanvas=function(e,t){var r=["obj",e[0],e[1],"fix",e[2],0,0,0,10,45];return this.map.convert.getPositionCanvasCoords(new ss(r),null,!0,t)},os.prototype.convertCoordsFromNavToCameraSpace=function(e,t,r){var i=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionCameraSpaceCoords(new ss(i),r)},os.prototype.convertCoordsFromPhysToCameraSpace=function(e){var t=this.map.camera.position;return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},os.prototype.transformPhysCoordsBySE=function(e){return this.map.convert.transformPhysCoordsBySE(e)},os.prototype.getPositionCanvasCoords=function(e,t){return this.map.convert.getPositionCanvasCoords(new ss(e),t)},os.prototype.getPositionCameraCoords=function(e,t){return this.map.convert.getPositionCameraCoords(new ss(e),t)},os.prototype.movePositionCoordsTo=function(e,t,r,i){return this.map.convert.movePositionCoordsTo(new ss(e),t,r,i)},os.prototype.getGeodesicLinePoints=function(e,t,r,i){return this.map.convert.getGeodesicLinePoints(e,t,r,i)},os.prototype.getSurfaceHeight=function(e,t){return this.map.measure.getSurfaceHeight(e,this.map.measure.getOptimalHeightLodBySampleSize(e,t))},os.prototype.getSurfaceAreaGeometry=function(e,t,r,i,a,s){var n=this.map.measure.getSurfaceAreaGeometry(e,t,r,i,!0,s);if(n[0]){var o=n[1],h=[],l=this.map;return l.tree&&(l.storedTilesRes=[],l.tree.storeGeometry(o,o.length),h=l.storedTilesRes,l.storedTilesRes=[]),a(h),function(){}}return this.map.core.once("map-update",this.getSurfaceAreaGeometry.bind(this,e,t,r,i,a,s),1)},os.prototype.getDistance=function(e,t,r,i){return this.map.measure.getDistance(e,t,r,i)},os.prototype.getAzimuthCorrection=function(e,t){return this.map.measure.getAzimuthCorrection(e,t)},os.prototype.getNED=function(e,t){return this.map.measure.getNewNED(e,!1!==t)},os.prototype.getCameraInfo=function(){var e=this.map.camera;return{projectionMatrix:e.camera.projection.slice(),viewMatrix:e.camera.modelview.slice(),viewProjectionMatrix:e.camera.mvp.slice(),rotationMatrix:e.camera.rotationview.slice(),position:this.map.camera.position.slice(),vector:this.map.camera.vector.slice(),distance:this.map.camera.distance,height:this.map.camera.height}},os.prototype.isPointInsideCameraFrustum=function(e){return this.map.camera.camera.pointVisible(e,this.map.camera.position)},os.prototype.isBBoxInsideCameraFrustum=function(e){return this.map.camera.camera.bboxVisible({min:e[0],max:e[1]},this.map.camera.position)},os.prototype.generateTrajectory=function(e,t,r){return e=new ss(e),t=new ss(t),new rs(this.map,e,t,r).generate()},os.prototype.generatePIHTrajectory=function(e,t,r,i){var a=new ss(e);return i.distance=r,i.azimuth=t,i.distanceAzimuth=!0,new rs(this.map,a,a,i).generate()},os.prototype.setConfigParams=function(e){return this.map.setConfigParams(e),this},os.prototype.setConfigParam=function(e,t){return this.map.setConfigParam(e,t),this},os.prototype.getConfigParam=function(e){return this.map.getConfigParam(e)},os.prototype.redraw=function(){return this.map.markDirty(),this},os.prototype.addRenderSlot=function(e,t,r){return this.map.renderSlots.addRenderSlot(e,t,r),this},os.prototype.moveRenderSlotBefore=function(e,t){return this.map.renderSlots.moveRenderSlotBefore(e,t),this},os.prototype.moveRenderSlotAfter=function(e,t){return this.map.renderSlots.moveRenderSlotAfter(e,t),this},os.prototype.removeRenderSlot=function(e){return this.map.renderSlots.removeRenderSlot(e),this},os.prototype.setRenderSlotEnabled=function(e,t){return this.map.renderSlots.setRenderSlotEnabled(e,t),this},os.prototype.getRenderSlotEnabled=function(e){return this.map.renderSlots.getRenderSlotEnabled(e)},os.prototype.setLoaderSuspended=function(e){return this.map.loaderSuspended=e,this},os.prototype.getLoaderSuspended=function(){return this.map.loaderSuspended},os.prototype.getGpuCache=function(){return this.map.gpuCache},os.prototype.getHitCoords=function(e,t,r,i){return this.map.getHitCoords(e,t,r,i)},os.prototype.getScreenRay=function(e,t){return this.map.getScreenRay(e,t)},os.prototype.renderToImage=function(){return this.map.renderToImage()},os.prototype.getCurrentGeometry=function(){return this.map.getCurrentGeometry()},os.prototype.getStats=function(e){if(e)return{maxZoom:this.map.draw.debug.maxZoom};for(var t=0,r=0,i=this.map.geodataProcessors;r<i;r++)this.map.geodataProcessors[r].busy&&t++;return{bestMeshTexelSize:this.map.bestMeshTexelSize,bestGeodataTexelSize:this.map.bestGeodataTexelSize,downloading:this.map.loader.downloading.length,lastDownload:this.map.loader.lastDownloadTime,surfaces:this.map.tree.surfaceSequence.length,freeLayers:this.map.freeLayerSequence.length,texelSizeFit:this.map.texelSizeFit,loadMode:this.map.config.mapLoadMode,processingTasks:this.map.processingTasks.length,busyWorkers:t,dirty:this.map.dirty,drawnTiles:this.map.stats.drawnTiles,drawnGeodataTiles:this.map.stats.drawnGeodataTiles,renderTime:this.map.stats.rendererTime,frameTime:this.map.stats.frameTime}},os.prototype.click=function(e,t,r){this.map.click(e,t,r)},os.prototype.hover=function(e,t,r,i){this.map.hover(e,t,r,i)},os.prototype.createGeodata=function(){return new ns(this.map)},os.prototype.getGeodataGeometry=function(e){return this.map.renderer.geometries[e]},os.prototype.setGeodataSelection=function(e){return this.map.renderer.geodataSelection=e,this.map.markDirty(),this},os.prototype.getGeodataSelection=function(){return this.map.renderer.geodataSelection};var hs=di,ls=Ui,us=Ga,ds=$a,cs=_r,ps=os,fs=s.a,ms=ge.a,gs=n.a,vs=function(e,t,r){var a=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;this.killed=!1,this.config={map:null,mapCache:1100,mapGPUCache:600,mapMetatileCache:60,mapTexelSizeFit:1.1,mapMaxHiresLodLevels:2,mapDownloadThreads:20,mapMaxProcessingTime:10,mapMaxGeodataProcessingTime:10,mapMobileMode:!1,mapMobileModeAutodect:!0,mapMobileDetailDegradation:1,mapNavSamplesPerViewExtent:4,mapIgnoreNavtiles:!1,mapVirtualSurfaces:!0,mapAllowHires:!0,mapAllowLowres:!0,mapAllowSmartSwitching:!0,mapDisableCulling:!1,mapPreciseCulling:!0,mapHeightLodBlend:!0,mapHeightNodeBlend:!0,mapBasicTileSequence:!1,mapPreciseBBoxTest:!1,mapPreciseDistanceTest:!1,mapHeightfiledWhenUnloaded:!0,mapForceMetatileV3:!1,mapSmartNodeParsing:!0,mapLoadErrorRetryTime:3e3,mapLoadErrorMaxRetryCount:3,mapLoadMode:"topdown",mapGeodataLoadMode:"fit",mapSplitMeshes:!0,mapSplitMargin:.0025,mapSplitSpace:null,mapSplitLods:!1,mapGridMode:"linear",mapGridSurrogatez:!1,mapGridUnderSurface:0,mapGridTextureLevel:-1,mapGridTextureLayer:null,mapXhrImageLoad:!0,mapStoreLoadStats:!1,mapRefreshCycles:3,mapSoftViewSwitch:!0,mapSortHysteresis:!0,mapHysteresisWait:0,mapSeparateLoader:!0,mapGeodataBinaryLoad:!0,mapPackLoaderEvents:!0,mapParseMeshInWorker:!0,mapPackGeodataEvents:!0,mapCheckTextureSize:!1,mapTraverseToMeshNode:!0,mapNormalizeOctantTexelSize:!0,mapFeatureStickMode:[1,1],map16bitMeshes:!0,mapOnlyOneUVs:!1,mapIndexBuffers:!0,mapAsyncImageDecode:!0,mapFeatureGridCells:31,mapFeaturesPerSquareInch:.25,mapFeaturesSortByTop:!1,mapFeaturesReduceMode:"scr-count1",mapFeaturesReduceParams:null,mapFeaturesReduceFactor:1,mapFeaturesReduceFactor2:1,mapDMapSize:1024,mapDMapMode:1,mapDegradeHorizon:!1,mapDegradeHorizonParams:[1,1500,97500,3500],mapDefaultFont:"//cdn.melown.com/libs/vtsjs/fonts/noto-basic/1.0.0/noto.fnt",mapFog:!0,mapNoTextures:!1,mapMetricUnits:!("en"==a||0==a.indexOf("en-")),mapLanguage:a,mapForceFrameTime:0,mapForcePipeline:0,mapLogGeodataStyles:!0,mapBenevolentMargins:!1,rendererAnisotropic:0,rendererAntialiasing:!0,rendererAllowScreenshots:!1,inspector:!0,authorization:null,mario:!1},this.configStorage={},this.element=e,this.coreInterface=r,this.ready=!1,this.listeners=[],this.listenerCounter=0,this.tokenCookieHost=null,this.tokenIFrame=null,this.xhrParams={},this.inspector=null!=ls?new ls(this):null,this.setConfigParams(t),this.map=null,this.mapInterface=null,this.renderer=new us(this,this.element,null,this.onResize.bind(this),this.config),this.rendererInterface=new ds(this.renderer),this.proj4=i.a,this.contextLost=!1,gs.init(),this.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},window.performance=window.performance||{},performance.now=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()},this.loadMap(this.config.map),this.requestAnimFrame.call(window,this.onUpdate.bind(this))};function ys(e){return(e?"Core: ":"")+"2.23.9"}function bs(){gs.init();var e=document.createElement("canvas");if(null==e)return!1;if(e.width=1024,e.height=768,null==e.getContext)return!1;var t=null;try{t=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(e){return!1}return!!t}vs.prototype.onResize=function(){null!=this.map&&this.map.markDirty()},vs.prototype.loadMap=function(e){if(null!=this.map&&this.destroyMap(),null!=e){e=ms.getProcessUrl(e,window.location.href),this.tokenCookieLoaded=!0,this.mapConfigData=null,this.tokenExpiration=null,this.tokenExpirationCallback=null,this.tokenExpirationLoop=!1,this.tokenCanBeSkiped=!0,this.mapRunnig=!1;var t=function(){if((this.tokenCookieLoaded||this.tokenCanBeSkiped)&&this.mapConfigData&&!this.mapRunnig){this.mapRunnig=!0;var t=this.mapConfigData;this.callListener("map-mapconfig-loaded",t),this.map=new hs(this,t,e,this.config,this.configStorage),this.mapInterface=new ps(this.map),this.setConfigParams(this.map.browserOptions,!0),this.setConfigParams(this.configStorage),this.config.position&&(this.map.setPosition(this.config.position),this.config.position=null),this.config.view&&(this.map.setView(this.config.view),this.config.view=null)}}.bind(this),r=function(e){this.mapConfigData=e,t()}.bind(this),i=function(){}.bind(this),a=function(t){!t||t&&t.status?this.tokenCanBeSkiped&&o(e):(this.tokenLoaded=!0,this.xhrParams.token=t.token,this.xhrParams.tokenHeader=t.header,this.tokenExpiration=1e3*t.expires,this.tokenExpirationCallback=function(){this.tokenExpiration=null,this.tokenExpirationLoop=!0,"string"==typeof this.config.authorization?fs.loadJSON(this.config.authorization,a,s,null,fs.useCredentials,this.xhrParams):this.config.authorization(a)}.bind(this),this.tokenExpirationLoop||o(e),"string"==typeof this.config.authorization?h(t.cookieInjector,this.config.authorization):h(t.cookieInjector,e))}.bind(this),s=function(){console.log("auth token not loaded"),this.tokenCanBeSkiped&&o(e)}.bind(this),n=function(){document.body.removeChild(this.tokenIFrame),this.tokenIFrame=null,this.tokenCookieLoaded=!0,t()}.bind(this),o=function(e){fs.loadJSON(e,r,i,null,fs.useCredentials,this.xhrParams)}.bind(this),h=function(e,t){e=ms.getProcessUrl(e,t),this.tokenCookieHost=ms.getHost(e);var r=document.createElement("iframe");this.tokenIFrame=r,r.onload=n,r.src=e,r.style.display="none",document.body.appendChild(r)}.bind(this);this.config.authorization?(this.tokenCookieLoaded=!1,"string"==typeof this.config.authorization?fs.loadJSON(this.config.authorization,a,s,null,fs.useCredentials,this.xhrParams):this.config.authorization(a)):o(e)}},vs.prototype.destroy=function(){this.killed||(this.destroyMap(),this.renderer&&this.renderer.kill(),this.element=null,this.killed=!0)},vs.prototype.destroyMap=function(){this.map&&(this.map.kill(),this.map=null,this.mapInterface=null,this.callListener("map-unloaded",{}))},vs.prototype.getMap=function(){return this.map},vs.prototype.getMapInterface=function(){return this.mapInterface},vs.prototype.getRenderer=function(){return this.renderer},vs.prototype.getRendererInterface=function(){return this.rendererInterface},vs.prototype.getProj4=function(){return this.proj4},vs.prototype.getOption=function(){},vs.prototype.setOption=function(){},vs.prototype.on=function(e,t,r,i){if(!this.killed&&null!=t)return this.listenerCounter++,this.listeners.push({name:e,listener:t,id:this.listenerCounter,once:i,wait:r||0}),function(e){this.removeListener(e)}.bind(this,this.listenerCounter)},vs.prototype.once=function(e,t,r){this.on(e,t,r,!0)},vs.prototype.callListener=function(e,t,r){for(var i=0;i<this.listeners.length;i++)if(this.listeners[i].name==e){var a=this.listeners[i];a.wait>0?a.wait--:(a.listener(t),a.once&&(this.listeners.splice(i,1),i--))}r&&console.log("event "+e+": "+JSON.stringify(t))},vs.prototype.removeListener=function(e){for(var t=0;t<this.listeners.length;t++)if(this.listeners[t].id==e)return void this.listeners.splice(t,1)},vs.prototype.markDirty=function(){null!=this.map&&this.map.markDirty()},vs.prototype.onUpdate=function(){this.killed||this.contextLost||(null!=this.map&&(!this.map.srsReady&&this.map.isReferenceFrameReady()&&(this.map.srsReady=!0,this.callListener("map-loaded",{browserOptions:this.map.browserOptions})),this.map.update()),this.callListener("tick",{}),this.requestAnimFrame.call(window,this.onUpdate.bind(this)))},vs.prototype.setConfigParams=function(e,t){if("object"==typeof e&&null!==e)for(var r in e)this.setConfigParam(r,e[r],t)},vs.prototype.setConfigParam=function(e,t,r){switch(e){case"pos":case"position":case"view":this.getMap()?("view"==e?this.getMap().setView(t):this.getMap().setPosition(new cs(t)),this.configStorage[e]&&delete this.configStorage[e]):this.configStorage[e]=t;break;case"map":this.config.map=fs.validateString(t,null);break;case"mapVirtualSurfaces":this.config.mapVirtualSurfaces=fs.validateBool(t,!0);break;case"mapForcePipeline":this.config.mapForcePipeline=fs.validateNumber(t,-1,Number.MAXINTEGER,0);break;case"mapDMapSize":this.config.mapDMapSize=fs.validateNumber(t,16,Number.MAXINTEGER,512);break;case"mapDMapMode":this.config.mapDMapMode=fs.validateNumber(t,1,Number.MAXINTEGER,1);break;case"map16bitMeshes":this.config.map16bitMeshes=fs.validateBool(t,!1);break;case"inspector":this.config.inspector=fs.validateBool(t,!0);break;case"authorization":this.config.authorization="string"==typeof t||"function"==typeof t?t:null;break;default:0!=e.indexOf("map")&&"mario"!=e||(r&&void 0!==this.configStorage[e]||(this.configStorage[e]=t),null!=this.getMap()&&this.getMap().setConfigParam(e,t)),0==e.indexOf("renderer")&&(r&&void 0!==this.configStorage[e]||(this.configStorage[e]=t),this.setRendererConfigParam(e,t)),0==e.indexOf("debug")&&(this.configStorage[e]=t,null!=this.getMap()&&this.inspector.setParameter(e,t))}},vs.prototype.getConfigParam=function(e){return"map"==e?this.config.map:"inspector"==e?this.config.inspector:0==e.indexOf("map")&&null!=this.getMap()?this.getMap().getConfigParam(e):0==e.indexOf("renderer")?this.getRendererConfigParam(e):void 0},vs.prototype.setRendererConfigParam=function(e,t){switch(e){case"rendererAnisotropic":this.config.rendererAnisotropic=fs.validateNumber(t,-1,2048,0),this.rederer&&this.rederer.gpu.setAniso(this.config.rendererAnisotropic);break;case"rendererAntialiasing":this.config.rendererAntialiasing=fs.validateBool(t,!0);break;case"rendererAllowScreenshots":this.config.rendererAllowScreenshots=fs.validateBool(t,!1)}},vs.prototype.getRendererConfigParam=function(e){switch(e){case"rendererAnisotropic":return this.config.rendererAnisotropic;case"rendererAntialiasing":return this.config.rendererAntialiasing;case"rendererAllowScreenshots":return this.config.rendererAllowScreenshots}}},function(e,t,r){"use strict";function i(e,t,r){r=r||2;var i,o,h,l,u,p,f,g=t&&t.length,v=g?t[0]*r:e.length,y=a(e,0,v,r,!0),b=[];if(!y||y.next===y.prev)return b;if(g&&(y=function(e,t,r,i){var n,o,h,l,u,p=[];for(n=0,o=t.length;n<o;n++)h=t[n]*i,l=n<o-1?t[n+1]*i:e.length,(u=a(e,h,l,i,!1))===u.next&&(u.steiner=!0),p.push(m(u));for(p.sort(d),n=0;n<p.length;n++)c(p[n],r),r=s(r,r.next);return r}(e,t,y,r)),e.length>80*r){i=h=e[0],o=l=e[1];for(var x=r;x<v;x+=r)(u=e[x])<i&&(i=u),(p=e[x+1])<o&&(o=p),u>h&&(h=u),p>l&&(l=p);f=0!==(f=Math.max(h-i,l-o))?1/f:0}return n(y,b,r,i,o,f),b}function a(e,t,r,i,a){var s,n;if(a===P(e,t,r,i)>0)for(s=t;s<r;s+=i)n=A(s,e[s],e[s+1],n);else for(s=r-i;s>=t;s-=i)n=A(s,e[s],e[s+1],n);return n&&b(n,n.next)&&(C(n),n=n.next),n}function s(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!b(i,i.next)&&0!==y(i.prev,i,i.next))i=i.next;else{if(C(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}function n(e,t,r,i,a,d,c){if(e){!c&&d&&function(e,t,r,i){var a=e;do{null===a.z&&(a.z=f(a.x,a.y,t,r,i)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,function(e){var t,r,i,a,s,n,o,h,l=1;do{for(r=e,e=null,s=null,n=0;r;){for(n++,i=r,o=0,t=0;t<l&&(o++,i=i.nextZ);t++);for(h=l;o>0||h>0&&i;)0!==o&&(0===h||!i||r.z<=i.z)?(a=r,r=r.nextZ,o--):(a=i,i=i.nextZ,h--),s?s.nextZ=a:e=a,a.prevZ=s,s=a;r=i}s.nextZ=null,l*=2}while(n>1)}(a)}(e,i,a,d);for(var p,m,g=e;e.prev!==e.next;)if(p=e.prev,m=e.next,d?h(e,i,a,d):o(e))t.push(p.i/r),t.push(e.i/r),t.push(m.i/r),C(e),e=m.next,g=m.next;else if((e=m)===g){c?1===c?n(e=l(s(e),t,r),t,r,i,a,d,2):2===c&&u(e,t,r,i,a,d):n(s(e),t,r,i,a,d,1);break}}}function o(e){var t=e.prev,r=e,i=e.next;if(y(t,r,i)>=0)return!1;for(var a=e.next.next;a!==e.prev;){if(g(t.x,t.y,r.x,r.y,i.x,i.y,a.x,a.y)&&y(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function h(e,t,r,i){var a=e.prev,s=e,n=e.next;if(y(a,s,n)>=0)return!1;for(var o=a.x<s.x?a.x<n.x?a.x:n.x:s.x<n.x?s.x:n.x,h=a.y<s.y?a.y<n.y?a.y:n.y:s.y<n.y?s.y:n.y,l=a.x>s.x?a.x>n.x?a.x:n.x:s.x>n.x?s.x:n.x,u=a.y>s.y?a.y>n.y?a.y:n.y:s.y>n.y?s.y:n.y,d=f(o,h,t,r,i),c=f(l,u,t,r,i),p=e.prevZ,m=e.nextZ;p&&p.z>=d&&m&&m.z<=c;){if(p!==e.prev&&p!==e.next&&g(a.x,a.y,s.x,s.y,n.x,n.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,m!==e.prev&&m!==e.next&&g(a.x,a.y,s.x,s.y,n.x,n.y,m.x,m.y)&&y(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;p&&p.z>=d;){if(p!==e.prev&&p!==e.next&&g(a.x,a.y,s.x,s.y,n.x,n.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;m&&m.z<=c;){if(m!==e.prev&&m!==e.next&&g(a.x,a.y,s.x,s.y,n.x,n.y,m.x,m.y)&&y(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function l(e,t,r){var i=e;do{var a=i.prev,n=i.next.next;!b(a,n)&&x(a,i,i.next,n)&&w(a,n)&&w(n,a)&&(t.push(a.i/r),t.push(i.i/r),t.push(n.i/r),C(i),C(i.next),i=e=n),i=i.next}while(i!==e);return s(i)}function u(e,t,r,i,a,o){var h=e;do{for(var l=h.next.next;l!==h.prev;){if(h.i!==l.i&&v(h,l)){var u=T(h,l);return h=s(h,h.next),u=s(u,u.next),n(h,t,r,i,a,o),void n(u,t,r,i,a,o)}l=l.next}h=h.next}while(h!==e)}function d(e,t){return e.x-t.x}function c(e,t){if(t=function(e,t){var r,i=t,a=e.x,s=e.y,n=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var o=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=a&&o>n){if(n=o,o===a){if(s===i.y)return i;if(s===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(a===n)return r;var h,l=r,u=r.x,d=r.y,c=1/0;i=r;do{a>=i.x&&i.x>=u&&a!==i.x&&g(s<d?a:n,s,u,d,s<d?n:a,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(a-i.x),w(i,e)&&(h<c||h===c&&(i.x>r.x||i.x===r.x&&p(r,i)))&&(r=i,c=h)),i=i.next}while(i!==l);return r}(e,t)){var r=T(t,e);s(t,t.next),s(r,r.next)}}function p(e,t){return y(e.prev,e,t.prev)<0&&y(t.next,e,e.next)<0}function f(e,t,r,i,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function m(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function g(e,t,r,i,a,s,n,o){return(a-n)*(t-o)-(e-n)*(s-o)>=0&&(e-n)*(i-o)-(r-n)*(t-o)>=0&&(r-n)*(s-o)-(a-n)*(i-o)>=0}function v(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&x(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(w(e,t)&&w(t,e)&&function(e,t){var r=e,i=!1,a=(e.x+t.x)/2,s=(e.y+t.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&a<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)&&(y(e.prev,e,t.prev)||y(e,t.prev,t))||b(e,t)&&y(e.prev,e,e.next)>0&&y(t.prev,t,t.next)>0)}function y(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function b(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,r,i){var a=M(y(e,t,r)),s=M(y(e,t,i)),n=M(y(r,i,e)),o=M(y(r,i,t));return a!==s&&n!==o||(!(0!==a||!S(e,r,t))||(!(0!==s||!S(e,i,t))||(!(0!==n||!S(r,e,i))||!(0!==o||!S(r,t,i)))))}function S(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function M(e){return e>0?1:e<0?-1:0}function w(e,t){return y(e.prev,e,e.next)<0?y(e,t,e.next)>=0&&y(e,e.prev,t)>=0:y(e,t,e.prev)<0||y(e,e.next,t)<0}function T(e,t){var r=new F(e.i,e.x,e.y),i=new F(t.i,t.x,t.y),a=e.next,s=t.prev;return e.next=t,t.prev=e,r.next=a,a.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}function A(e,t,r,i){var a=new F(e,t,r);return i?(a.next=i.next,a.prev=i,i.next.prev=a,i.next=a):(a.prev=a,a.next=a),a}function C(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function F(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function P(e,t,r,i){for(var a=0,s=t,n=r-i;s<r;s+=i)a+=(e[n]-e[s])*(e[s+1]+e[n+1]),n=s;return a}e.exports=i,e.exports.default=i,i.deviation=function(e,t,r,i){var a=t&&t.length,s=a?t[0]*r:e.length,n=Math.abs(P(e,0,s,r));if(a)for(var o=0,h=t.length;o<h;o++){var l=t[o]*r,u=o<h-1?t[o+1]*r:e.length;n-=Math.abs(P(e,l,u,r))}var d=0;for(o=0;o<i.length;o+=3){var c=i[o]*r,p=i[o+1]*r,f=i[o+2]*r;d+=Math.abs((e[c]-e[f])*(e[p+1]-e[c+1])-(e[c]-e[p])*(e[f+1]-e[c+1]))}return 0===n&&0===d?0:Math.abs((d-n)/n)},i.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},i=0,a=0;a<e.length;a++){for(var s=0;s<e[a].length;s++)for(var n=0;n<t;n++)r.vertices.push(e[a][s][n]);a>0&&(i+=e[a-1].length,r.holes.push(i))}return r}},function(e){e.exports=JSON.parse('{"a":"2.4.5"}')},function(e,t,r){"use strict";var i=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var r;try{(r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),r=r.getBlob()}catch(t){r=new Blob([e])}return new Worker(i.createObjectURL(r))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";var _utils_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_utils_url__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(3),utilsUrl=_utils_url__WEBPACK_IMPORTED_MODULE_1__.a,utils=_utils_utils__WEBPACK_IMPORTED_MODULE_0__.a,MapUrl=function(e,t){this.map=e,t=t.trim(),this.baseUrl=utilsUrl.getBase(t),this.baseUrlSchema=utilsUrl.getSchema(t),this.baseUrlOrigin=utilsUrl.getOrigin(t),this.urlCounter=0};MapUrl.prototype.quad=function(e,t,r){for(var i="",a=e;a>0;a--){var s=0,n=1<<a-1;0!=(t&n)&&(s+=1),0!=(r&n)&&(s+=2),i+=s}return i},MapUrl.prototype.msDigit=function(e,t){return((3&e)<<1)+(1&t)},MapUrl.prototype.hex=function(e){for(var t=e.toString(16);t.length<8;)t="0"+t;return t},MapUrl.prototype.ppx=function(e,t){return this.hex(t<<28-e,7)},MapUrl.prototype.ppy=function(e,t){return this.hex((1<<28)-(t+1<<28-e),7)},MapUrl.prototype.processUrlFunction=function(id,counter,string){var string2,fc;if("string"!=typeof string)return string;if(-1!=string.indexOf("quad")){string2="(function(lod,x,y,loclod,locx,locy){"+string.replace("quad","return this.quad")+"})";try{return fc=eval(string2).bind(this),fc(id.lod,id.ix,id.iy,id.loclod,id.locx,id.locy)}catch(e){return string}}else if(-1!=string.indexOf("msdigit")){string2="(function(x,y,loclod,locx,locy){"+string.replace("msdigit","return this.msDigit")+"})";try{return fc=eval(string2).bind(this),fc(id.ix,id.iy,id.loclod,id.locx,id.locy)}catch(e){return string}}else{if(-1!=string.indexOf("alt")){var result=/\(([^)]*)\)/.exec(string);if(result&&result[1]){var strings=result[1].match(/([^,]+)/g);if(strings.length>0)return strings[counter%strings.length]}return string}if(-1!=string.indexOf("ppx")){string2="(function(lod,x,loclod,locx){"+string.replace("ppx","return this.ppx")+"})";try{return fc=eval(string2).bind(this),fc(id.lod,id.ix,id.loclod,id.locx)}catch(e){return string}}else{if(-1==string.indexOf("ppy"))return string;string2="(function(lod,y,loclod,locy){"+string.replace("ppy","return this.ppy")+"})";try{return fc=eval(string2).bind(this),fc(id.lod,id.iy,id.loclod,id.locy)}catch(e){return string}}}},MapUrl.prototype.findLocalRoot=function(e){for(var t=this.map.referenceFrame.getSpatialDivisionNodes(),r=[],i=0,a=t.length;i<a;i++){var s=t[i],n=e[0]-s.id[0],o=e[1]>>n,h=e[2]>>n;o==s.id[1]&&h==s.id[2]&&r.push(s)}var l=null;for(i=0,a=r.length;i<a;i++)r[i].id[0]>-1&&(l=r[i]);return l?l.id.slice():[0,0,0]},MapUrl.prototype.makeUrl=function(e,t,r,i){var a=0,s=0,n=0;if(t.lod){var o=this.findLocalRoot([t.lod,t.ix,t.iy]),h=(1<<(n=t.lod-o[0]))-1;a=t.ix&h,s=t.iy&h}var l={lod:t.lod,ix:t.ix,iy:t.iy,loclod:n,locx:a,locy:s};e=e.replace(/ /g,"");var u=utils.simpleFmtObjOrCall(e,{lod:t.lod,x:t.ix,y:t.iy,sub:r,locx:a,locy:s,loclod:n,geonavtile:r,hereappid:"abcde",hereappcode:"12345"},this.processUrlFunction.bind(this,l,this.urlCounter));return this.urlCounter++,-1!=u.indexOf("//")?0==u.indexOf("//")?this.baseUrlSchema+u:u:this.baseUrl+u},MapUrl.prototype.processUrl=function(e,t){return e?-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},__webpack_exports__.a=MapUrl},function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));var i=r(6),a=r(8),s=r.n(a),n=r(7).a,o=i.a,h=function(e,t){this.core=new n(e,t,this),Object.defineProperty(this,"map",{get:function(){return this.core?this.core.getMapInterface():null}}),Object.defineProperty(this,"renderer",{get:function(){return this.core?this.core.getRendererInterface():null}}),Object.defineProperty(this,"proj4",{get:function(){return this.core?o:null}}),Object.defineProperty(this,"earcut",{get:function(){return this.core?s.a:null}})};h.prototype.destroy=function(){this.core.destroy(),this.core=null},h.prototype.loadMap=function(e){return this.core?this.core.loadMap(e):null},h.prototype.destroyMap=function(){return this.core?this.core.destroyMap():null},h.prototype.on=function(e,t){return this.core?this.core.on(e,t):null},h.prototype.once=function(e,t,r){return this.core?this.core.once(e,t,r):null},h.prototype.callListener=function(e,t){if(!this.core)return null;this.core.callListener(e,t)}},function(e,t,r){e.exports=function(){return r(10)('/*!\n * Copyright (c) 2020 Melown Technologies SE\n *  *  For terms of use, see accompanying main file.\n *  *  For 3rd party libraries licenses, see 3rdpartylicenses.txt.\n * \n */!function(e){var r={};function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)t.d(n,a,function(r){return e[r]}.bind(null,a));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=0)}([function(e,r,t){"use strict";t.r(r);var n={stylesheetData:{},stylesheetLayers:{},stylesheetBitmaps:{},stylesheetFonts:{},stylesheetConstants:{},stylesheetVariables:{},insidePack:!1,directPoints:[],directPoint:null,fonts:{},fontsMap:{},fontsStorage:{},forceOrigin:!1,forceScale:[1,1,1],bboxMin:[0,0,0],bboxMax:[1,1,1],geocent:!1,tileX:0,tileY:0,tileLod:0,tileIX:0,tileIY:0,tileSize:1,hitState:0,pixelFactor:1,alwaysEventInfo:!0,metricUnits:!0,language:"en",groupOptimize:!0,groupOrigin:[0,0,0],messageBuffer:new Array(65536),messageBufferIndex:0,messageBufferSize:65536,messagePackSize:0,signatureCounter:0,autoLod:!1,featureType:null,groupId:null,disableLog:!1,reduceMode:"scr-count4",reduceParams:null,processLineLabel:!1,useLineLabel2:!0,lineLabelPass:0};function a(e,r,t){return e<r&&(e=r),e>t&&(e=t),e}function s(e,r){r||(r=e);var t=e[0],n=e[1],a=e[2],s=Math.sqrt(t*t+n*n+a*a);return s?1==s?(r[0]=t,r[1]=n,r[2]=a,r):(s=1/s,r[0]=t*s,r[1]=n*s,r[2]=a*s,r):(r[0]=0,r[1]=0,r[2]=0,r)}function i(e,r,t){t||(t=e);var n=e[0],a=e[1];e=e[2];var s=r[0],i=r[1];return r=r[2],t[0]=a*r-e*i,t[1]=e*s-n*r,t[2]=n*i-a*s,t}var o="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):null;var l="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;var u=["BN","BN","BN","BN","BN","BN","BN","BN","BN","S","B","S","WS","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","B","B","B","S","WS","ON","ON","ET","ET","ET","ON","ON","ON","ON","ON","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","ON","ON","ON","ON","ON","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","ON","ON","ON","ON","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","ON","ON","ON","BN","BN","BN","BN","BN","BN","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","CS","ON","ET","ET","ET","ET","ON","ON","ON","ON","L","ON","ON","BN","ON","ON","ET","ET","EN","EN","ON","L","ON","ON","ON","EN","L","ON","ON","ON","ON","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","L","L","L","L","L","L","L","L"],c=["AN","AN","AN","AN","AN","AN","ON","ON","AL","ET","ET","AL","CS","AL","ON","ON","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","AN","AN","AN","AN","AN","AN","AN","AN","AN","ET","AN","AN","AL","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","ON","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","NSM","NSM","ON","NSM","NSM","NSM","NSM","AL","AL","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","AL","AL","AL","AL","AL","AL"];function f(e){return 0!=(1&e)}function h(e){return 0==(1&e)}function v(e,r,t){for(var n=r,a=e.length;n<a;++n)if(e[n]!==t)return n;return n}function d(e,r,t,n){for(var a=r;a<t;++a)e[a]=n}function b(e,r,t,n){for(var a=t,s=n-1;a<s;++a,--s){var i=e[a];e[a]=e[s],e[s]=i,i=r[a],r[a]=r[s],r[s]=i}}function g(e,r,t){return{str:e,indices:L,types:y,dir:t?"ttb":r?"ltr":"rtl"}}var p=[],y=[],L=[];var A=function(e,r,t){var n=!0,a=e.length;if(0===a||t)return g(e,n,t);p.length=a,y.length=a;var s,i,o=0;for(s=0;s<a;++s){p[s]=e.charAt(s),L[s]=s;var l=e.charCodeAt(s),A="L";l<=255?A=u[l]:1424<=l&&l<=1524?A="R":1536<=l&&l<=1791?A=c[255&l]:1792<=l&&l<=2220&&(A="AL"),"R"!==A&&"AL"!==A&&"AN"!==A||o++,y[s]=A}if(0===o)return g(e,n=!0);-1===r&&(o/a<.3?(n=!0,r=0):(n=!1,r=1));var m=[];for(s=0;s<a;++s)m[s]=r;var N,U=f(r)?"R":"L",w=U,x=w,S=w;for(s=0;s<a;++s)"NSM"===y[s]?y[s]=S:S=y[s];for(S=w,s=0;s<a;++s)"EN"===(N=y[s])?y[s]="AL"===S?"AN":"EN":"R"!==N&&"L"!==N&&"AL"!==N||(S=N);for(s=0;s<a;++s)"AL"===(N=y[s])&&(y[s]="R");for(s=1;s<a-1;++s)"ES"===y[s]&&"EN"===y[s-1]&&"EN"===y[s+1]&&(y[s]="EN"),"CS"!==y[s]||"EN"!==y[s-1]&&"AN"!==y[s-1]||y[s+1]!==y[s-1]||(y[s]=y[s-1]);for(s=0;s<a;++s)if("EN"===y[s]){var M;for(M=s-1;M>=0&&"ET"===y[M];--M)y[M]="EN";for(M=s+1;M<a&&"ET"===y[M];++M)y[M]="EN"}for(s=0;s<a;++s)"WS"!==(N=y[s])&&"ES"!==N&&"ET"!==N&&"CS"!==N||(y[s]="ON");for(S=w,s=0;s<a;++s)"EN"===(N=y[s])?y[s]="L"===S?"L":"EN":"R"!==N&&"L"!==N||(S=N);for(s=0;s<a;++s)if("ON"===y[s]){var B=v(y,s+1,"ON"),O=w;s>0&&(O=y[s-1]);var _=x;B+1<a&&(_=y[B+1]),"L"!==O&&(O="R"),"L"!==_&&(_="R"),O===_&&d(y,s,B,O),s=B-1}for(s=0;s<a;++s)"ON"===y[s]&&(y[s]=U);for(s=0;s<a;++s)N=y[s],h(m[s])?"R"===N?m[s]+=1:"AN"!==N&&"EN"!==N||(m[s]+=2):"L"!==N&&"AN"!==N&&"EN"!==N||(m[s]+=1);var k,I=-1,E=99;for(s=0,i=m.length;s<i;++s)I<(k=m[s])&&(I=k),E>k&&f(k)&&(E=k);for(k=I;k>=E;--k){var C=-1;for(s=0,i=m.length;s<i;++s)m[s]<k?C>=0&&(b(p,L,C,s),C=-1):C<0&&(C=s);C>=0&&b(p,L,C,m.length)}for(s=0,i=p.length;s<i;++s){var F=p[s];"<"!==F&&">"!==F||(p[s]="")}return g(p.join(""),n)},m={parse:function(e){var r=m._bin,t=new Uint8Array(e),n=0;r.readFixed(t,n);n+=4;var a=r.readUshort(t,n);n+=2;r.readUshort(t,n);n+=2;r.readUshort(t,n);n+=2;r.readUshort(t,n);n+=2;for(var s=["cmap","head","hhea","maxp","hmtx","kern","GPOS","GSUB"],i={_data:t},o={},l=0,u=0;u<a;u++){var c=r.readASCII(t,n,4);n+=4;r.readUint(t,n);n+=4;var f=r.readUint(t,n);n+=4;var h=r.readUint(t,n);n+=4,o[c]={offset:f,length:h},l=f+h}for(u=0;u<s.length;u++){var v=s[u];o[v]&&(i[v.trim()]=m[v.trim()].parse(t,o[v].offset,o[v].length,i))}i._tabs=o,m._processGlyphs(t,l,o,i);var d=i.GSUB;if(d){var b=d.lookupList,g=d.featureList;i.gsubIsolTable=[],i.gsubInitTable=[],i.gsubFinaTable=[],i.gsubMediTable=[],i.gsubRligLigaTable=[];for(var p=0;p<g.length;p++){switch(c=g[p].tag){case"isol":case"init":case"fina":case"medi":for(var y=0;y<g[p].tab.length;y++){if(1==(L=b[g[p].tab[y]]).ltype)switch(c){case"isol":i.gsubIsolTable.push(L.tabs);break;case"init":i.gsubInitTable.push(L.tabs);break;case"fina":i.gsubFinaTable.push(L.tabs);break;case"medi":i.gsubMediTable.push(L.tabs)}}break;case"rlig":case"liga":for(y=0;y<g[p].tab.length;y++){var L;4==(L=b[g[p].tab[y]]).ltype&&i.gsubRligLigaTable.push(L.tabs)}}}}return i},_processGlyphs:function(e,r,t,n){var a=e[r],s=e[r+=1]<<8|e[r+1],i=e[r+=2]<<8|e[r+1],o=e[r+=2],l=e[r+=1];r+=1,n.version=a,n.textureLX=s,n.textureLY=i,n.size=o,n.cly=1.5*o,n.flags=l;var u=new Array(n.maxp.numGlyphs),c=1/s,f=1/i,h=s>256?7:6,v=r+n.maxp.numGlyphs*h,d=e[v]<<8|e[v+1],b=new Array(d);v+=2;for(var g=0,p=d;g<p;g++)b[g]=e[v+2*g]<<8|e[v+2*g+1];var y=0;for(g=0,p=n.maxp.numGlyphs;g<p;g++)g==b[y]&&y++,u[g]=m._processGlyph(e,r,c,f,s,n,g,y),r+=h;n.glyphs=u},_processGlyph:function(e,r,t,n,a,s,i,o){var l=e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3],u=l>>22&63,c=l>>16&63,f=(l>>9&63)*(l>>15&1?-1:1),h=-(l>>2&63)*(l>>8&1?-1:1),v=(3&l)+4*o;l=a>256?e[r+4]<<16|e[r+5]<<8|e[r+6]:e[r+4]<<8|e[r+5];var d,b,g=s.size/.75/s.head.unitsPerEm*.75,p=s.hmtx.aWidth[i]*g;switch(a){case 2048:d=l>>11&2047,b=2047&l;break;case 1024:d=l>>10&1023,b=1023&l;break;case 512:d=l>>9&511,b=511&l;break;default:d=l>>8&255,b=255&l}return{u1:d*t,v1:b*n+v,u2:(d+u)*t,v2:(b+c)*n+v,lx:u,ly:c,sx:f,sy:h,step:p,plane:v}},_tabOffset:function(e,r){for(var t=m._bin,n=t.readUshort(e,4),a=12,s=0;s<n;s++){var i=t.readASCII(e,a,4);a+=4;t.readUint(e,a);a+=4;var o=t.readUint(e,a);a+=4;t.readUint(e,a);if(a+=4,i==r)return o}return 0}};m._bin={readFixed:function(e,r){return(e[r]<<8|e[r+1])+(e[r+2]<<8|e[r+3])/65540},readF2dot14:function(e,r){var t=m._bin.readShort(e,r);return t/16384},readInt:function(e,r){var t=m._bin.t.uint8;return t[0]=e[r+3],t[1]=e[r+2],t[2]=e[r+1],t[3]=e[r],m._bin.t.int32[0]},readInt8:function(e,r){return m._bin.t.uint8[0]=e[r],m._bin.t.int8[0]},readShort:function(e,r){var t=m._bin.t.uint8;return t[1]=e[r],t[0]=e[r+1],m._bin.t.int16[0]},readUshort:function(e,r){return e[r]<<8|e[r+1]},readUshorts:function(e,r,t){for(var n=[],a=0;a<t;a++)n.push(m._bin.readUshort(e,r+2*a));return n},readUint:function(e,r){var t=m._bin.t.uint8;return t[3]=e[r],t[2]=e[r+1],t[1]=e[r+2],t[0]=e[r+3],m._bin.t.uint32[0]},readUint64:function(e,r){return 4294967296*m._bin.readUint(e,r)+m._bin.readUint(e,r+4)},readASCII:function(e,r,t){for(var n="",a=0;a<t;a++)n+=String.fromCharCode(e[r+a]);return n},readUnicode:function(e,r,t){for(var n="",a=0;a<t;a++){var s=e[r++]<<8|e[r++];n+=String.fromCharCode(s)}return n},readBytes:function(e,r,t){for(var n=[],a=0;a<t;a++)n.push(e[r+a]);return n},readASCIIArray:function(e,r,t){for(var n=[],a=0;a<t;a++)n.push(String.fromCharCode(e[r+a]));return n}},m._bin.t={buff:new ArrayBuffer(8)},m._bin.t.int8=new Int8Array(m._bin.t.buff),m._bin.t.uint8=new Uint8Array(m._bin.t.buff),m._bin.t.int16=new Int16Array(m._bin.t.buff),m._bin.t.uint16=new Uint16Array(m._bin.t.buff),m._bin.t.int32=new Int32Array(m._bin.t.buff),m._bin.t.uint32=new Uint32Array(m._bin.t.buff),m._lctf={},m._lctf.parse=function(e,r,t,n,a){var s=m._bin,i={},o=r;s.readFixed(e,r);r+=4;var l=s.readUshort(e,r);r+=2;var u=s.readUshort(e,r);r+=2;var c=s.readUshort(e,r);return r+=2,i.scriptList=m._lctf.readScriptList(e,o+l),i.featureList=m._lctf.readFeatureList(e,o+u),i.lookupList=m._lctf.readLookupList(e,o+c,a),i},m._lctf.readLookupList=function(e,r,t){var n=m._bin,a=r,s=[],i=n.readUshort(e,r);r+=2;for(var o=0;o<i;o++){var l=n.readUshort(e,r);r+=2;var u=m._lctf.readLookupTable(e,a+l,t);s.push(u)}return s},m._lctf.readLookupTable=function(e,r,t){var n=m._bin,a=r,s={tabs:[]};s.ltype=n.readUshort(e,r),r+=2,s.flag=n.readUshort(e,r),r+=2;var i=n.readUshort(e,r);r+=2;for(var o=0;o<i;o++){var l=n.readUshort(e,r);r+=2;var u=t(e,s.ltype,a+l);s.tabs.push(u)}return s},m._lctf.numOfOnes=function(e){for(var r=0,t=0;t<32;t++)0!=(e>>>t&1)&&r++;return r},m._lctf.readClassDef=function(e,r){var t=m._bin,n={start:[],end:[],class:[]},a=t.readUshort(e,r);if(r+=2,1==a){var s=t.readUshort(e,r);r+=2;var i=t.readUshort(e,r);r+=2;for(var o=0;o<i;o++)n.start.push(s+o),n.end.push(s+o),n.class.push(t.readUshort(e,r)),r+=2}if(2==a){var l=t.readUshort(e,r);r+=2;for(o=0;o<l;o++)n.start.push(t.readUshort(e,r)),r+=2,n.end.push(t.readUshort(e,r)),r+=2,n.class.push(t.readUshort(e,r)),r+=2}return n},m._lctf.readValueRecord=function(e,r,t){var n=m._bin,a=[];return a.push(1&t?n.readShort(e,r):0),r+=1&t?2:0,a.push(2&t?n.readShort(e,r):0),r+=2&t?2:0,a.push(4&t?n.readShort(e,r):0),r+=4&t?2:0,a.push(8&t?n.readShort(e,r):0),r+=8&t?2:0,a},m._lctf.readCoverage=function(e,r){var t=m._bin,n={};n.fmt=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2,1==n.fmt&&(n.tab=t.readUshorts(e,r,a)),2==n.fmt&&(n.tab=t.readUshorts(e,r,3*a));var s=Number.POSITIVE_INFINITY,i=0,o=n.tab;if(1==n.fmt)for(var l=0;l<o.length;l++){var u=o[l];u>i&&(i=u),u<s&&(s=u)}if(2==n.fmt)for(l=0;l<o.length;l+=3){var c=o[l],f=o[l+1];c>i&&(i=c),c<s&&(s=c),f>i&&(i=f),f<s&&(s=f)}return n.min=s,n.max=i,n},m._lctf.coverageIndex=function(e,r){if(r<e.min||r>e.max)return-1;var t=e.tab;if(1==e.fmt)return t.indexOf(r);for(var n=0;n<t.length;n+=3){var a=t[n],s=t[n+1],i=t[n+2];if(a<=r&&r<=s)return i+(r-a)}return-1},m._lctf.readFeatureList=function(e,r){var t=m._bin,n=r,a=[],s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readASCII(e,r,4);r+=4;var l=t.readUshort(e,r);r+=2,a.push({tag:o.trim(),tab:m._lctf.readFeatureTable(e,n+l)})}return a},m._lctf.readFeatureTable=function(e,r){var t=m._bin;t.readUshort(e,r);r+=2;var n=t.readUshort(e,r);r+=2;for(var a=[],s=0;s<n;s++)a.push(t.readUshort(e,r+2*s));return a},m._lctf.readScriptList=function(e,r){var t=m._bin,n=r,a={},s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readASCII(e,r,4);r+=4;var l=t.readUshort(e,r);r+=2,a[o.trim()]=m._lctf.readScriptTable(e,n+l)}return a},m._lctf.readScriptTable=function(e,r){var t=m._bin,n=r,a={},s=t.readUshort(e,r);r+=2,a.default=m._lctf.readLangSysTable(e,n+s);var i=t.readUshort(e,r);r+=2;for(var o=0;o<i;o++){var l=t.readASCII(e,r,4);r+=4;var u=t.readUshort(e,r);r+=2,a[l.trim()]=m._lctf.readLangSysTable(e,n+u)}return a},m._lctf.readLangSysTable=function(e,r){var t=m._bin,n={};t.readUshort(e,r);r+=2,n.reqFeature=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);return r+=2,n.features=t.readUshorts(e,r,a),n},m.cmap={},m.cmap.parse=function(e,r,t){e=new Uint8Array(e.buffer,r,t);r=0;var n=m._bin,a={};n.readUshort(e,r);r+=2;var s=n.readUshort(e,r);r+=2;var i=[];a.tables=[];for(var o=0;o<s;o++){var l=n.readUshort(e,r);r+=2;var u=n.readUshort(e,r);r+=2;var c=n.readUint(e,r);r+=4;var f="p"+l+"e"+u,h=i.indexOf(c);if(-1==h){var v;h=a.tables.length,i.push(c);var d=n.readUshort(e,c);0==d?v=m.cmap.parse0(e,c):4==d?v=m.cmap.parse4(e,c):6==d?v=m.cmap.parse6(e,c):12==d?v=m.cmap.parse12(e,c):console.log("unknown format: "+d,l,u,c),a.tables.push(v)}if(null!=a[f])throw"multiple tables for one platform+encoding";a[f]=h}return a},m.cmap.parse0=function(e,r){var t=m._bin,n={};n.format=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2;t.readUshort(e,r);r+=2,n.map=[];for(var s=0;s<a-6;s++)n.map.push(e[r+s]);return n},m.cmap.parse4=function(e,r){var t=m._bin,n=r,a={};a.format=t.readUshort(e,r),r+=2;var s=t.readUshort(e,r);r+=2;t.readUshort(e,r);r+=2;var i=t.readUshort(e,r);r+=2;var o=i/2;a.searchRange=t.readUshort(e,r),r+=2,a.entrySelector=t.readUshort(e,r),r+=2,a.rangeShift=t.readUshort(e,r),r+=2,a.endCount=t.readUshorts(e,r,o),r+=2*o,r+=2,a.startCount=t.readUshorts(e,r,o),r+=2*o,a.idDelta=[];for(var l=0;l<o;l++)a.idDelta.push(t.readShort(e,r)),r+=2;for(a.idRangeOffset=t.readUshorts(e,r,o),r+=2*o,a.glyphIdArray=[];r<n+s;)a.glyphIdArray.push(t.readUshort(e,r)),r+=2;return a},m.cmap.parse6=function(e,r){var t=m._bin,n={};n.format=t.readUshort(e,r),r+=2;t.readUshort(e,r);r+=2;t.readUshort(e,r);r+=2,n.firstCode=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2,n.glyphIdArray=[];for(var s=0;s<a;s++)n.glyphIdArray.push(t.readUshort(e,r)),r+=2;return n},m.cmap.parse12=function(e,r){var t=m._bin,n={};n.format=t.readUshort(e,r),r+=2,r+=2;t.readUint(e,r);r+=4;t.readUint(e,r);r+=4;var a=t.readUint(e,r);r+=4,n.groups=[];for(var s=0;s<a;s++){var i=r+12*s,o=t.readUint(e,i+0),l=t.readUint(e,i+4),u=t.readUint(e,i+8);n.groups.push([o,l,u])}return n},m.GPOS={},m.GPOS.parse=function(e,r,t,n){return m._lctf.parse(e,r,t,n,m.GPOS.subt)},m.GPOS.subt=function(e,r,t){if(2!=r)return null;var n=m._bin,a=t,s={};s.format=n.readUshort(e,t),t+=2;var i=n.readUshort(e,t);t+=2,s.coverage=m._lctf.readCoverage(e,i+a),s.valFmt1=n.readUshort(e,t),t+=2,s.valFmt2=n.readUshort(e,t),t+=2;var o=m._lctf.numOfOnes(s.valFmt1),l=m._lctf.numOfOnes(s.valFmt2);if(1==s.format){s.pairsets=[];var u=n.readUshort(e,t);t+=2;for(var c=0;c<u;c++){var f=n.readUshort(e,t);t+=2,f+=a;var h=n.readUshort(e,f);f+=2;for(var v=[],d=0;d<h;d++){var b=n.readUshort(e,f);f+=2,0!=s.valFmt1&&(N=m._lctf.readValueRecord(e,f,s.valFmt1),f+=2*o),0!=s.valFmt2&&(U=m._lctf.readValueRecord(e,f,s.valFmt2),f+=2*l),v.push({gid2:b,val1:N,val2:U})}s.pairsets.push(v)}}if(2==s.format){var g=n.readUshort(e,t);t+=2;var p=n.readUshort(e,t);t+=2;var y=n.readUshort(e,t);t+=2;var L=n.readUshort(e,t);t+=2,s.classDef1=m._lctf.readClassDef(e,a+g),s.classDef2=m._lctf.readClassDef(e,a+p),s.matrix=[];for(c=0;c<y;c++){var A=[];for(d=0;d<L;d++){var N=null,U=null;0!=s.valFmt1&&(N=m._lctf.readValueRecord(e,t,s.valFmt1),t+=2*o),0!=s.valFmt2&&(U=m._lctf.readValueRecord(e,t,s.valFmt2),t+=2*l),A.push({val1:N,val2:U})}s.matrix.push(A)}}return s},m.GSUB={},m.GSUB.parse=function(e,r,t,n){return m._lctf.parse(e,r,t,n,m.GSUB.subt)},m.GSUB.subt=function(e,r,t){var n=m._bin,a=t,s={};if(1!=r&&4!=r)return null;s.fmt=n.readUshort(e,t),t+=2;var i=n.readUshort(e,t);if(t+=2,s.coverage=m._lctf.readCoverage(e,i+a),1==r){if(1==s.fmt)s.delta=n.readShort(e,t),t+=2;else if(2==s.fmt){var o=n.readUshort(e,t);t+=2,s.newg=n.readUshorts(e,t,o),t+=2*s.newg.length}}else if(4==r){s.vals=[];o=n.readUshort(e,t);t+=2;for(var l=0;l<o;l++){var u=n.readUshort(e,t);t+=2,s.vals.push(m.GSUB.readLigatureSet(e,a+u))}}return s},m.GSUB.readChainSubClassSet=function(e,r){var t=m._bin,n=r,a=[],s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readUshort(e,r);r+=2,a.push(m.GSUB.readChainSubClassRule(e,n+o))}return a},m.GSUB.readChainSubClassRule=function(e,r){for(var t=m._bin,n={},a=["backtrack","input","lookahead"],s=0;s<a.length;s++){var i=t.readUshort(e,r);r+=2,1==s&&i--,n[a[s]]=t.readUshorts(e,r,i),r+=2*n[a[s]].length}i=t.readUshort(e,r);return r+=2,n.subst=t.readUshorts(e,r,2*i),r+=2*n.subst.length,n},m.GSUB.readLigatureSet=function(e,r){var t=m._bin,n=r,a=[],s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readUshort(e,r);r+=2,a.push(m.GSUB.readLigature(e,n+o))}return a},m.GSUB.readLigature=function(e,r){var t=m._bin,n={chain:[]};n.nglyph=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2;for(var s=0;s<a-1;s++)n.chain.push(t.readUshort(e,r)),r+=2;return n},m.head={},m.head.parse=function(e,r,t){var n=m._bin,a={};n.readFixed(e,r);r+=4,a.fontRevision=n.readFixed(e,r),r+=4;n.readUint(e,r);r+=4;n.readUint(e,r);return r+=4,a.flags=n.readUshort(e,r),r+=2,a.unitsPerEm=n.readUshort(e,r),r+=2,a.created=n.readUint64(e,r),r+=8,a.modified=n.readUint64(e,r),r+=8,a.xMin=n.readShort(e,r),r+=2,a.yMin=n.readShort(e,r),r+=2,a.xMax=n.readShort(e,r),r+=2,a.yMax=n.readShort(e,r),r+=2,a.macStyle=n.readUshort(e,r),r+=2,a.lowestRecPPEM=n.readUshort(e,r),r+=2,a.fontDirectionHint=n.readShort(e,r),r+=2,a.indexToLocFormat=n.readShort(e,r),r+=2,a.glyphDataFormat=n.readShort(e,r),r+=2,a},m.hhea={},m.hhea.parse=function(e,r,t){var n=m._bin,a={};n.readFixed(e,r);return r+=4,a.ascender=n.readShort(e,r),r+=2,a.descender=n.readShort(e,r),r+=2,a.lineGap=n.readShort(e,r),r+=2,a.advanceWidthMax=n.readUshort(e,r),r+=2,a.minLeftSideBearing=n.readShort(e,r),r+=2,a.minRightSideBearing=n.readShort(e,r),r+=2,a.xMaxExtent=n.readShort(e,r),r+=2,a.caretSlopeRise=n.readShort(e,r),r+=2,a.caretSlopeRun=n.readShort(e,r),r+=2,a.caretOffset=n.readShort(e,r),r+=2,r+=8,a.metricDataFormat=n.readShort(e,r),r+=2,a.numberOfHMetrics=n.readUshort(e,r),r+=2,a},m.hmtx={},m.hmtx.parse=function(e,r,t,n){for(var a=m._bin,s={aWidth:[],lsBearing:[]},i=0,o=0,l=0;l<n.maxp.numGlyphs;l++)l<n.hhea.numberOfHMetrics&&(i=a.readUshort(e,r),r+=2,o=a.readShort(e,r),r+=2),s.aWidth.push(i),s.lsBearing.push(o);return s},m.kern={},m.kern.parse=function(e,r,t,n){var a=m._bin,s=a.readUshort(e,r);if(r+=2,1==s)return m.kern.parseV1(e,r-2,t,n);var i=a.readUshort(e,r);r+=2;for(var o={glyph1:[],rval:[]},l=0;l<i;l++){r+=2;t=a.readUshort(e,r);r+=2;var u=a.readUshort(e,r);r+=2;var c=u>>>8;if(0!=(c&=15))throw"unknown kern table format: "+c;r=m.kern.readFormat0(e,r,o)}return o},m.kern.parseV1=function(e,r,t,n){var a=m._bin;a.readFixed(e,r);r+=4;var s=a.readUint(e,r);r+=4;for(var i={glyph1:[],rval:[]},o=0;o<s;o++){a.readUint(e,r);r+=4;var l=a.readUshort(e,r);r+=2;a.readUshort(e,r);r+=2;var u=l>>>8;if(0!=(u&=15))throw"unknown kern table format: "+u;r=m.kern.readFormat0(e,r,i)}return i},m.kern.readFormat0=function(e,r,t){var n=m._bin,a=-1,s=n.readUshort(e,r);r+=2;n.readUshort(e,r);r+=2;n.readUshort(e,r);r+=2;n.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=n.readUshort(e,r);r+=2;var l=n.readUshort(e,r);r+=2;var u=n.readShort(e,r);r+=2,o!=a&&(t.glyph1.push(o),t.rval.push({glyph2:[],vals:[]}));var c=t.rval[t.rval.length-1];c.glyph2.push(l),c.vals.push(u),a=o}return r},m.maxp={},m.maxp.parse=function(e,r,t){var n=m._bin,a={},s=n.readUint(e,r);return r+=4,a.numGlyphs=n.readUshort(e,r),r+=2,65536==s&&(a.maxPoints=n.readUshort(e,r),r+=2,a.maxContours=n.readUshort(e,r),r+=2,a.maxCompositePoints=n.readUshort(e,r),r+=2,a.maxCompositeContours=n.readUshort(e,r),r+=2,a.maxZones=n.readUshort(e,r),r+=2,a.maxTwilightPoints=n.readUshort(e,r),r+=2,a.maxStorage=n.readUshort(e,r),r+=2,a.maxFunctionDefs=n.readUshort(e,r),r+=2,a.maxInstructionDefs=n.readUshort(e,r),r+=2,a.maxStackElements=n.readUshort(e,r),r+=2,a.maxSizeOfInstructions=n.readUshort(e,r),r+=2,a.maxComponentElements=n.readUshort(e,r),r+=2,a.maxComponentDepth=n.readUshort(e,r),r+=2),a},m.U={},m.U.codeToGlyph=function(e,r){var t=e.cmap,n=-1;if(null!=t.p0e4?n=t.p0e4:null!=t.p3e1?n=t.p3e1:null!=t.p1e0&&(n=t.p1e0),-1==n)throw"no familiar platform and encoding!";var a=t.tables[n];if(0==a.format)return r>=a.map.length?0:a.map[r];if(4==a.format){for(var s=-1,i=0;i<a.endCount.length;i++)if(r<=a.endCount[i]){s=i;break}if(-1==s)return 0;if(a.startCount[s]>r)return 0;return 65535&(0!=a.idRangeOffset[s]?a.glyphIdArray[r-a.startCount[s]+(a.idRangeOffset[s]>>1)-(a.idRangeOffset.length-s)]:r+a.idDelta[s])}if(12==a.format){if(r>a.groups[a.groups.length-1][1])return 0;for(i=0;i<a.groups.length;i++){var o=a.groups[i];if(o[0]<=r&&r<=o[1])return o[2]+(r-o[0])}return 0}throw"unknown cmap table format "+a.format},m.U._getGlyphClass=function(e,r){for(var t=0;t<r.start.length;t++)if(r.start[t]<=e&&r.end[t]>=e)return r.class[t];return 0},m.U.getPairAdjustment=function(e,r,t){if(e.GPOS){for(var n=null,a=0;a<e.GPOS.featureList.length;a++){var s=e.GPOS.featureList[a];if("kern"==s.tag)for(var i=0;i<s.tab.length;i++)2==e.GPOS.lookupList[s.tab[i]].ltype&&(n=e.GPOS.lookupList[s.tab[i]])}if(n)for(a=0;a<n.tabs.length;a++){var o=n.tabs[a],l=m._lctf.coverageIndex(o.coverage,r);if(-1!=l){var u=0;if(1==o.format){var c=o.pairsets[l];for(i=0;i<c.length;i++)c[i].gid2==t&&(u=c[i]);if(null==u)continue}else if(2==o.format){var f=m.U._getGlyphClass(r,o.classDef1),h=m.U._getGlyphClass(t,o.classDef2);u=o.matrix[f][h]}return u.val1[2]}}}if(e.kern){var v=e.kern.glyph1.indexOf(r);if(-1!=v){var d=e.kern.rval[v].glyph2.indexOf(t);if(-1!=d)return e.kern.rval[v].vals[d]}}return 0},m.U.RTable=[1570,1571,1572,1573,1575,1577,1583,1584,1585,1586,1608,1649,1650,1651,1653,1654,1655,1672,1673,1674,1675,1676,1677,1678,1679,1680,1681,1682,1683,1684,1685,1686,1687,1688,1689,1728,1731,1732,1733,1734,1735,1736,1737,1738,1739,1741,1743,1746,1747,1749,1774,1775,1808,1813,1814,1815,1816,1817,1822,1832,1834,1836,1839,1869,1881,1882,1883,1899,1900,1905,1907,1908,1912,1913,2112,2118,2119,2121,2132,2151,2153,2154,2218,2219,2220,2222,2225,2226,2233,2757,2759,2761,2762,2766,2767,2768,2769,2770,2781,2785,2788,2799,2945,2947,2948,2949,2953,2956,2958,2959,2961,2985,2986,2987,2988],m.U.stringToGlyphs=function(e,r){var t,n,a,s,i,o,l,u,c,f,h,v,d,b=[],g=[],p=[],y=[],L=[],N=A(r,-1,!1),U=m.U.RTable;for(n=0,a=r.length;n<a;n++)u=r.charCodeAt(n),y.push(u),L.push(0),2765==u||2775==u||43122==u?L[n]=2:1548==u?L[n]=1:u<=63?9!=u&&10!=u&&32!=u&&33!=u&&34!=u&&40!=u&&41!=u&&44!=u&&46!=u&&58!=u&&59!=u&&63!=u||(L[n]=1):u>=1570&&u<=2988&&-1!=U.indexOf(u)&&(L[n]=3);for(n=0,a=r.length;n<a;n++)u=y[n],1!=L[n]&&n<a-2&&4156==(c=y[n+1])&&(y[n]=c,y[n+1]=u,n++);for(n=0,a=r.length;n<a;n++){for(u=y[n],s=0,i=e.length;s<i&&(h=e[s],!(t=m.U.codeToGlyph(h,u)));s++);b.push(t),g.push(t?s:0)}p=y,h=null;for(var w=0;w<b.length;w++)if(d=b[w],h!=g[w]&&(f=(h=e[g[w]]).GSUB),f){var x=L[w-1],S=L[w],M=L[w+1],B=0==w||1==x,O=w==b.length-1||1==M;if(B||3!=x||(B=!0),O||3!=S||(O=!0),O||2!=M||(O=!0),B||2!=S||(B=!0),v=null,v=B?O?h.gsubIsolTable:h.gsubInitTable:O?h.gsubFinaTable:h.gsubMediTable)for(l=0;l<v.length;l++){var _=v[l];for(s=0;s<_.length;s++){var k=_[s];-1!=(E=m._lctf.coverageIndex(k.coverage,d))&&(0==k.fmt?b[w]=E+k.delta:k.newg?b[w]=k.newg[E]:(b[w]=d,console.log(w,d,"subst-error"," original:",r)))}}}h=null;for(w=0;w<b.length;w++)if(d=b[w],h!=g[w]&&(f=(h=e[g[w]]).GSUB),f&&(v=h.gsubRligLigaTable)){var I=Math.min(3,b.length-w-1);for(l=0;l<v.length;l++){_=v[l];for(s=0;s<_.length;s++){var E;k=_[s];if(-1!=(E=m._lctf.coverageIndex(k.coverage,d))){var C=k.vals[E];for(o=0;o<C.length;o++){var F=C[o],z=F.chain.length;if(!(z>I)){for(var P=!0,j=0;j<z;j++)F.chain[j]!=b[w+(1+j)]&&(P=!1);if(P){b[w]=F.nglyph;for(j=0;j<z;j++)b[w+j+1]=-1}}}}}}}var T=N.indices,V=b.slice(),G=p.slice(),X=g.slice();for(n=0,a=b.length;n<a;n++)u=T[n],V[n]=b[u],G[n]=p[u],X[n]=g[u];return[V,X,G]};var N=n,U=s,w=function(e){var r=e[0],t=e[1];return e=e[2],Math.sqrt(r*r+t*t+e*e)},x=i,S=m,M=function(e,r,t,n,a,s,i,o,l,u,c,f,h,v,d,b){var g,p=u[d],y=[0,0,0];N.geocent&&!h?(g=[0,0,0],U(N.bboxMin,y),x(y,r,g)):g=[-r[1],r[0],0],x(r,g,y);var L=[e[0],e[1],e[2]],A=[L[0],L[1],L[2]],m=p.glyphs[n];if(n=0,!m)return[e,i,o,0];var w=0,S=l[0],M=l[1],B=l[2];if(9==n||32==n)(m=chars[32])&&(e[0]+=r[0]*m.step*a*s,e[1]+=r[1]*m.step*a*s,w=m.lx*a);else if(0==m.lx)e[0]=e[0]+r[0]*m.step*a*s,e[1]=e[1]+r[1]*m.step*a*s,w=m.lx*a;else{var O=4e3*d,_=m.plane+O;v&&(v[d]||(v[d]={}),v[d][_]=!0);var k=m.lx*a,I=m.ly*a;if(b)if(N.processLineLabel&&N.useLineLabel2){L[0]=L[0]+r[0]*m.sx*a,L[1]=L[1]+r[1]*m.sx*a,L[2]=L[2]+r[2]*m.sx*a,L[0]=L[0]+g[0]*(m.sy-p.size)*a,L[1]=L[1]+g[1]*(m.sy-p.size)*a,L[2]=L[2]+g[2]*(m.sy-p.size)*a;var E=[(V=[g[0]*t,g[1]*t,g[2]*t])[0]+g[0]*I,V[1]+g[1]*I,V[2]+g[2]*I];b[i]=L[0]-V[0],b[i+1]=L[1]-V[1],b[i+2]=L[2]-V[2];var C=function(e){var r,t,n,a,s,i=e[0][0]+e[1][1]+e[2][2];return i>0?(a=.25*(s=2*Math.sqrt(i+1)),r=(e[2][1]-e[1][2])/s,t=(e[0][2]-e[2][0])/s,n=(e[1][0]-e[0][1])/s):e[0][0]>e[1][1]&e[0][0]>e[2][2]?(s=2*Math.sqrt(1+e[0][0]-e[1][1]-e[2][2]),a=(e[2][1]-e[1][2])/s,r=.25*s,t=(e[0][1]+e[1][0])/s,n=(e[0][2]+e[2][0])/s):e[1][1]>e[2][2]?(s=2*Math.sqrt(1+e[1][1]-e[0][0]-e[2][2]),a=(e[0][2]-e[2][0])/s,r=(e[0][1]+e[1][0])/s,t=.25*s,n=(e[1][2]+e[2][1])/s):(s=2*Math.sqrt(1+e[2][2]-e[0][0]-e[1][1]),a=(e[1][0]-e[0][1])/s,r=(e[0][2]+e[2][0])/s,t=(e[1][2]+e[2][1])/s,n=.25*s),[r,t,n,a]}([[r[0],r[1],r[2]],[g[0],g[1],g[2]],[y[0],y[1],y[2]]]);b[i+3]=C[0],b[i+4]=C[1],b[i+5]=C[2],b[i+6]=C[3],N.lineLabelPass||(b[i+7]=k,b[i+8]=I),b[i+9]=m.u1,b[i+10]=m.v1+O;var F=1024*(m.u2-m.u1),z=m.v2-m.v1;b[i+11]=F+z;var P=.5*r[0]*k-.5*g[0]*I-V[0],j=.5*r[1]*k-.5*g[1]*I-V[1],T=.5*r[2]*k-.5*g[2]*I-V[2];N.lineLabelPoints.push([L[0]+P,L[1]+j,L[2]+T,.5*Math.sqrt(k*k+I*I),b[i],b[i+1],b[i+2],b[i+3],b[i+4],b[i+5],b[i+6],k,I]),i+=12}else b[i]=L[0]+m.sx*a,b[i+1]=L[1]+(m.sy-p.size)*a,b[i+2]=b[i]+k,b[i+3]=b[i+1]-I,b[i+4]=m.u1,b[i+5]=m.v1+O,b[i+6]=m.u2,b[i+7]=m.v2+O,i+=8;else{var V;E=[(V=[g[0]*t,g[1]*t,g[2]*t])[0]+g[0]*I,V[1]+g[1]*I,V[2]+g[2]*I];L[0]=L[0]+r[0]*m.sx*a,L[1]=L[1]+r[1]*m.sx*a,L[2]=L[2]+r[2]*m.sx*a,L[0]=L[0]+g[0]*(m.sy-p.size)*a,L[1]=L[1]+g[1]*(m.sy-p.size)*a,L[2]=L[2]+g[2]*(m.sy-p.size)*a,A[0]=L[0]+r[0]*k,A[1]=L[1]+r[1]*k,A[2]=L[2]+r[2]*k,c[i]=L[0]-V[0],c[i+1]=L[1]-V[1],c[i+2]=L[2]-V[2],c[i+3]=B,f[o]=m.u1,f[o+1]=m.v1+O,f[o+2]=S,f[o+3]=M,c[i+4]=L[0]-E[0],c[i+5]=L[1]-E[1],c[i+6]=L[2]-E[2],c[i+7]=B,f[o+4]=m.u1,f[o+5]=m.v2+O,f[o+6]=S,f[o+7]=M,c[i+8]=A[0]-V[0],c[i+9]=A[1]-V[1],c[i+10]=A[2]-V[2],c[i+11]=B,f[o+8]=m.u2,f[o+9]=m.v1+O,f[o+10]=S,f[o+11]=M,c[i+12]=L[0]-E[0],c[i+13]=L[1]-E[1],c[i+14]=L[2]-E[2],c[i+15]=B,f[o+12]=m.u1,f[o+13]=m.v2+O,f[o+14]=S,f[o+15]=M,c[i+16]=A[0]-E[0],c[i+17]=A[1]-E[1],c[i+18]=A[2]-E[2],c[i+19]=B,f[o+16]=m.u2,f[o+17]=m.v2+O,f[o+18]=S,f[o+19]=M,c[i+20]=A[0]-V[0],c[i+21]=A[1]-V[1],c[i+22]=A[2]-V[2],c[i+23]=B,f[o+20]=m.u2,f[o+21]=m.v1+O,f[o+22]=S,f[o+23]=M,i+=24,o+=24}e[0]=e[0]+r[0]*m.step*a*s,e[1]=e[1]+r[1]*m.step*a*s,w=m.lx*a}return[e,i,o,w*s]},B=function(e){return 3*(e?3:4)*2},O=function(e,r){return r?e/r.size*1.52:1},_=function(e,r,t,n,a){for(var s=0,i=a||S.U.stringToGlyphs(n,e),o=i[0],l=i[1],u=0,c=o.length;u<c;u++){var f=o[u],h=n[l[u]];if(h){var v=O(r,h)*t,d=h.glyphs[f];d&&(s+=u==c-1?d.lx*v:d.step*v)}}return s},k=function(e){for(var r=0,t=0,n=e.length-1;t<n;t++){var a=e[t],s=e[t+1],i=[s[0]-a[0],s[1]-a[1],s[2]-a[2]];r+=w(i)}return r},I=function(e,r){for(var t=0,n=[0,0,0],a=[1,0,0],s=0,i=e.length-1;s<i;s++){n=e[s];var o=e[s+1];a=[o[0]-n[0],o[1]-n[1],o[2]-n[2]];var l=w(a);if(t+l>r){var u=(r-t)/l,c=[n[0]+a[0]*u,n[1]+a[1]*u,n[2]+a[2]*u];return U(a),[c,a]}t+=l}return[n,a]},E=function(e,r,t,n,a,s,i){for(var o=0,l=[0,0,0],u=[1,0,0],c=[0,0,0],f=r,h=r+_(t,n,a,s,i),v=N.bboxMin,d=N.geocent,b=0,g=e.length-1;b<g;b++){l=e[b];var p=e[b+1];if(u=[p[0]-l[0],p[1]-l[1],p[2]-l[2]],(o+=w(u))>f&&(U(u),c[0]+=u[0],c[1]+=u[1],c[2]+=u[2]),o>h){if(U(c),d){var y=[0,0,0];return U(v,y),x(y,c,y),y}return[-c[1],c[0],0]}}return c},C=function(e,r,t){return!(!e||""==e)&&-1==(t||S.U.stringToGlyphs(r,e))[0].indexOf(0)},F=function(e){for(var r=[],t=0,n=e.length;t<n;t++)r.push(N.fonts[e[t]]);return r},z=function(e){for(var r=[],t=0,n=e.length;t<n;t++)r.push(N.fontsMap[e[t]]);return r},P=function(e,r){return S.U.stringToGlyphs(r,e)},j=n,T=a,V=function(e,r){if(!e||""==e)return"";var t,n,a=e.indexOf("{");if(-1==a)return e;n=a>0?e.substring(0,a):"";var s=0,i=-1;for(t=e.length;a<t;a++){var o=e.charAt(a);"{"==o?(0==s&&(i=a),s++):"}"==o?0==--s&&(n+=r(e.substring(i+1,a))):0==s&&(n+=o)}return n},G=function(e){if(!e||0===e.length)return 0;for(var r=0,t=0,n=e.length;t<n;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return r},X=function(e){for(var r=0,t=e.length;r<t;r++){var n=e.charCodeAt(r);if(n>=65&&n<=90||n>=97&&n<=122||n>=192&&n<=255&&215!=n&&247!=n||n>=256&&n<=383)return!0}return!1},D=function(e){for(var r=0,t=e.length;r<t;r++){var n=e.charCodeAt(r);if(!(n>=19968&&n<=25343||n>=25344&&n<=30719||n>=30720&&n<=36095||n>=36096&&n<=40959||n>=13312&&n<=19903||n>=131072&&n<=136703||n>=136704&&n<=143615||n>=143616&&n<=148991||n>=148992&&n<=155903||n>=155904&&n<=161279||n>=161280&&n<=168191||n>=168192&&n<=173791||n>=173824&&n<=177983||n>=177984&&n<=178207||n>=178208&&n<=183983||n>=183984&&n<=191471||n>=63744&&n<=64255||n>=13056&&n<=13311||n>=65072&&n<=65103||n>=63744&&n<=64255||n>=194560&&n<=195103||n>=0&&n<=64||n>=160&&n<=191))return!1}return!0},R=C,$=function(e,r,t,n,a,s){var i;if(s||(s=0),!(s>100)){switch(typeof r){case"string":if(r.length>0){switch(r.charAt(0)){case"#":case"$":case"@":case"&":case"%":return void 0===(i=Y(e,a,t,n,r,s+1))&&W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),i}return V(r,(function(o){if(o.length>0){switch(o.charAt(0)){case"#":case"$":case"@":case"&":case"%":return void 0===(i=Y(e,a,t,n,o,s+1))&&W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),i}if(-1!=o.indexOf("{")){try{o=o.replace(/\'/g,\'"\'),i=JSON.parse(o)}catch(t){return W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),""}return void 0===i?(W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),""):H(e,a,t,n,i,s+1)}return o}}))}}return r}},q=function(e,r,t,n){var a=H(e,r,t,n);return K(e["$$layer-id"],r,a)},Y=function(e,r,t,n,a,s){var i=a;switch(a.charAt(0)){case"$":i=t.properties[a.substr(1)];break;case"@":i=j.stylesheetConstants[a];break;case"%":i=j.stylesheetVariables[a.substr(1)];break;case"&":i=j.stylesheetLocals[a];break;case"#":switch(a){case"#id":return t.id;case"#type":return j.featureType;case"#group":return j.groupId;case"#lod":return j.tileLod;case"#ix":return j.tileIX;case"#iy":return j.tileIY;case"#tileSize":return j.tileSize;case"#pixelSize":return j.pixelSize;case"#metric":return j.metricUnits;case"#dpr":return j.pixelFactor;case"#language":return j.language}}return"&"==a.charAt(0)?void 0===i&&void 0!==(i=e[a])&&("string"==typeof i?i=$(e,i,t,n,r,s+1):void 0!==i&&(i=H(e,r,t,n,i,s+1)),j.stylesheetLocals[a]=i):"string"==typeof i?i=$(e,i,t,n,r,s+1):void 0!==i&&"@"==a.charAt(0)&&(i=H(e,r,t,n,i,s+1)),i},H=function(e,r,t,n,a,s){var i,o,l,u,c,f;if(void 0===a)a=e[r],i=!0,s=0;else if(s>100)return;switch(typeof a){case"string":return a.length>0?void 0!==(d=Y(e,r,t,n,a,s))?d:(W("wrong-object",e["$$layer-id"],r,a,null,"feature-property"),i?Q(r):void 0):a;case"object":if(null==a)return i?Q(r):void 0;if(Array.isArray(a)){if("icon-source"==r&&null==j.stylesheetBitmaps[a[0]])return W("wrong-object",e["$$layer-id"],r,a,null,"bitmap"),i?Q(r):void 0;if("filter"!=r){for(f=new Array(a.length),_=0,k=a.length;_<k;_++)f[_]=H(e,r,t,n,a[_],s+1);return f}return a}var h,v,d;for(h in a)break;if(!h)return i?Q(r):void 0;switch(N=a[h],h){case"if":if(Array.isArray(N)&&3==N.length){if(void 0!==(d=ee(N[0],t,j.featureType,j.groupId,e,r,n,0)?H(e,r,t,n,N[1],s+1):H(e,r,t,n,N[2],s+1)))return d;v=!0}else v=!0;break;case"add":case"sub":case"mul":case"div":case"mod":case"pow":case"tofixed":case"atan2":case"random":if(Array.isArray(N)&&2==N.length)if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),"number"!=typeof o||"number"!=typeof l)v=!0;else switch(h){case"add":return o+l;case"sub":return o-l;case"mul":return o*l;case"div":return o/l;case"mod":return o%l;case"pow":return Math.pow(o,l);case"atan2":return Math.atan2(o,l);case"tofixed":return o.tofixed(l);case"random":return o+Math.random()*(l-o)}else v=!0;break;case"clamp":if(Array.isArray(N)&&3==N.length){if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),u=H(e,r,t,n,N[2],s+1),"number"==typeof o&&"number"==typeof l&&"number"==typeof u)return T(o,l,u);v=!0}else v=!0;break;case"logScale":case"log-scale":if(!Array.isArray(N)||N.length<2)v=!0;else{if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),u=0,c=100,N.length>2&&"number"!=typeof(u=H(e,r,t,n,N[2],s+1))&&(v=!0),N.length>3&&"number"!=typeof(c=H(e,r,t,n,N[3],s+1))&&(v=!0),!v&&"number"==typeof o&&"number"==typeof l){var b=u,g=l,p=o;return p>g&&(p=g),_=(c-b)/Math.log(g+1)*Math.log(p+1)+b}v=!0}break;case"sgn":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"sqrt":case"abs":case"log":case"round":case"floor":case"ceil":case"deg2rad":case"rad2deg":if("number"!=typeof(N=H(e,r,t,n,N,s+1)))v=!0;else switch(h){case"sgn":return N<0?-1:1;case"sin":return Math.sin(N);case"cos":return Math.cos(N);case"tan":return Math.tan(N);case"asin":return Math.asin(N);case"acos":return Math.acos(N);case"atan":return Math.atan(N);case"sqrt":return Math.sqrt(N);case"abs":return Math.abs(N);case"log":return Math.log(N);case"round":return Math.round(N);case"floor":return Math.floor(N);case"ceil":return Math.ceil(N);case"deg2rad":return N/180*Math.PI;case"rad2deg":return N/Math.PI*180}break;case"strlen":case"trim":case"str2num":case"lowercase":case"uppercase":case"capitalize":case"has-fonts":case"has-latin":case"is-cjk":if("string"!=typeof(N=H(e,r,t,n,N,s+1))){if("number"==typeof N)return N;v=!0}else switch(h){case"strlen":return N.length;case"trim":return N.trim();case"str2num":return parseFloat(N);case"lowercase":return N.toLowerCase();case"uppercase":return N.toUpperCase();case"capitalize":return N.replace(/(?:^|\\s)\\S/g,(function(e){return e.toUpperCase()}));case"has-fonts":return R(N);case"has-latin":return X(N);case"is-cjk":return D(N)}break;case"find":case"replace":case"substr":if(Array.isArray(N)&&N.length>=2){if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),"find"==h&&"string"==typeof o&&"string"==typeof l)return o.indexOf(l);if("replace"==h&&3==N.length&&(u=H(e,r,t,n,N[2],s+1),"string"==typeof o&&"string"==typeof l&&"string"==typeof u))return o.replace(l,u);if("substr"==h)if(2==N.length){if("string"==typeof o&&"number"==typeof l)return o.substr(l)}else if(u=H(e,r,t,n,N[2],s+1),"string"==typeof o&&"number"==typeof l&&"number"==typeof u)return o.substr(l,u)}v=!0;break;case"min":case"max":if(Array.isArray(N)){for(d=H(e,r,t,n,N[0],s+1),_=0,k=N.length;_<k;_++){if("number"!=typeof(f=H(e,r,t,n,N[_],s+1))){v=!0;break}d="max"==h?Math.max(d,f):Math.min(d,f)}return d}v=!0;break;case"map":if(Array.isArray(N)){d=H(e,r,t,n,N[0],s+1);var y=N[1];if(Array.isArray(y))for(_=0,k=y.length;_<k;_++){var L=y[_];if(!Array.isArray(L)){v=!0;break}if(d==H(e,r,t,n,L[0],s+1))return H(e,r,t,n,L[1],s+1)}else v=!0;return H(e,r,t,n,N[2],s+1)}v=!0;break;case"linear":case"linear2":case"discrete":case"discrete2":case"lod-scaled":var A=null,m=null,N=n;if(null!=a["lod-scaled"]){var U;if("number"==typeof(U=a["lod-scaled"])[1])return U[1]*Math.pow(2*U[2],U[0]-n);A=U[1],m=U}if(null!=a.discrete2||null!=a.linear2)A=(U=a.discrete2||a.linear2)[1],N=H(e,r,t,n,U[0],s+1);else A=a.discrete||a.linear;for(var w,x,S=A[0][0],M=A[0][1],B=typeof M,O=M,_=0,k=A.length;_<=k;_++){if(_==k){O=M;break}if(A[_][0]>N){if(null!=a.discrete||null!=a.discrete2||null!=m){O=M;break}if(w=A[_][0],x=A[_][1],w==S)break;switch(B){case"boolean":O=(O=(M=M?1:0)+(N-S)/(w-S)*((x=M?1:0)-M))>.5;break;case"number":O=M+(N-S)/(w-S)*(x-M);break;case"object":O=[];for(var I=0,E=M.length;I<E;I++)O[I]=M[I]+(x[I]-M[I])*((N-S)/(w-S))}break}S=A[_][0],M=A[_][1]}return null!=m&&(O*=Math.pow(2*m[2],m[0]-N)),O;default:v=!0}if(v)return i?Q(r):void 0;case"number":case"boolean":return a}return i?Q(r):void 0},J=function(e,r,t,n,a){if(a>100)W("custom","infinite inherit loop in Layer: "+e);else if(null!=t.inherit){var s=n.layers[t.inherit];if(null==s)return W("wrong-object",e,"inherit",s,"Layer"),Q(i);for(var i in null!=s.inherit&&J(t.inherit,r,s,n,a++),s)r[i]=s[i]}},W=function(e,r,t,n,a,s){if(!j.disableLog){"object"==typeof n&&(n=JSON.stringify(n));var i=null;switch(e){case"wrong-property-value":i="Error: wrong layer property "+(s?"\'"+s+"\'":"")+": "+r+"."+t+" = "+n;break;case"wrong-property-value[]":i="Error: wrong layer property "+(s?"\'"+s+"\'":"")+"["+a+"]: "+r+"."+t+" = "+n;break;case"wrong-object":i="Error: reffered "+s+" does not exist: "+r+"."+t+" = "+n;break;case"wrong-object[]":i="Error: reffered "+s+" does not exist: "+r+"."+t+"["+a+"] = "+n;break;case"wrong-Layer":i="Error: reffered "+s+" Layer does not exist: "+s+"["+a+"].Layer = "+r;break;case"wrong-bitmap":i="Error: wrong definition of bitmap: "+r;break;case"custom":i="Error: "+r}i&&j.log&&console.log(i)}},Z=function(e,r,t,n,a,s,i,o){var l,u;if(null!=t&&"object"==typeof t&&!Array.isArray(t))return W("wrong-property-value",e,r,t),Q(r);if(typeof t!=n&&(null!==t||"icon-source"!=r&&"visibility"!=r&&"label-no-overlap-factor"!=r))return W("wrong-property-value",e,r,t),Q(r);switch(typeof t){case"object":if(null===t)return t;if("reduce"==r||"dynamic-reduce"==r||"label-no-overlap-factor"==r||"line-points"==r){if(!(Array.isArray(t)&&t.length>0&&"string"==typeof t[0]))return W("wrong-property-value",e,r,t),Q(r);if("line-points"==r){if("vertices"!=t[0]&&"by-length"!=t[0]&&"by-ratio"!=t[0]&&"endpoints"!=t[0]&&"start"!=t[0]&&"end"!=t[0]&&"middle"!=t[0]&&"midpoint"!=t[0])return W("wrong-property-value",e,r,t),Q(r)}else if("dynamic-reduce"==r){if("by-extenal-param"==t[0]&&(t[0]=j.reduceMode),"tilt"!=t[0]&&"tilt-cos"!=t[0]&&"tilt-cos2"!=t[0]&&"scr-count"!=t[0]&&"scr-count2"!=t[0]&&"scr-count3"!=t[0]&&"scr-count4"!=t[0]&&"scr-count5"!=t[0]&&"scr-count6"!=t[0]&&"scr-count7"!=t[0]&&"scr-count8"!=t[0]||"number"!=typeof t[1]||"number"!=typeof t[2]&&"scr-count4"!=t[0]&&"scr-count5"!=t[0]&&"scr-count6"!=t[0]&&"scr-count7"!=t[0]&&"scr-count8"!=t[0])return W("wrong-property-value",e,r,t),Q(r)}else if("reduce"==r){if("odd"!=t[0]&&"even"!=t&&("number"!=typeof t[1]||("top"!=t[0]||"bottom"!=t)&&"string"!=typeof t[2]))return W("wrong-property-value",e,r,t),Q(r)}else if("label-no-overlap-factor"==r&&"direct"!=t[0]&&"div-by-dist"!=t[0])return W("wrong-property-value",e,r,t),Q(r)}if("next-pass"==r||"visibility-switch"==r){var c="visibility-switch"==r;if(!(Array.isArray(t)&&t.length>0))return W("wrong-property-value",e,r,t),Q(r);for(l=0;l<u;l++){var f=t[l];if("object"!=typeof f||!Array.isArray(f)||2!=f.length||"number"!=typeof f[0]||!("string"==typeof f[1]||c&&null===f[1]))return W("wrong-property-value[]",e,r,t,l),Q(r);if("string"==typeof f[1]&&"@"==f[1].charAt(0)){if(void 0===j.stylesheetConstants[f[1]])return W("wrong-property-value[]",e,r,t,l),Q(r);f[1]=j.stylesheetConstants[f[1]]}}}if("label-font"==r||"line-label-font"==r){if(!Array.isArray(t)||t.length<1)return W("wrong-property-value[]",e,r,t,0),Q(r);for(l=0,u=t.length;l<u;l++)if("string"!=typeof t[l]||!j.fonts[t[l]])return W("wrong-property-value[]",e,r,t,0),Q(r);return t}if(null!=a){if(Array.isArray(t)&&(t.length==a||t.length>=7)){if(l=0,"icon-source"==r||"line-style-texture"==r){if("string"!=typeof t[0])return W("wrong-property-value[]",e,r,t,0),Q(r);if(null==j.stylesheetBitmaps[t[0]])return W("wrong-object",e,r,t,null,"bitmap"),Q(r);l=1}for(u=t.length;l<u;l++)if("number"!=typeof t[l])return W("wrong-property-value[]",e,r,t,l),Q(r);return 7==t.length&&(t[7]=0),t}return W("wrong-property-value",e,r,t),Q(r)}return t;case"string":if("line-type"==r||"point-type"==r)switch(t){case"screen":case"flat":case"screen-flat":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("line-label-type"==r)switch(t){case"flat":case"screen-flat":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("line-style"==r)switch(t){case"solid":case"texture":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("label-size-units"==r)switch(t){case"pixels":case"points":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("line-width-units"==r)switch(t){case"pixels":case"points":case"meters":case"ratio":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("label-origin"==r||"icon-origin"==r)switch(t){case"top-left":case"top-right":case"top-center":case"center-left":case"center-right":case"center-center":case"bottom-left":case"bottom-right":case"bottom-center":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("label-align"==r)switch(t){case"left":case"right":case"center":return t;default:return W("wrong-property-value",e,r,t),Q(r)}return t;case"number":return t>i||t<s?(W("wrong-property-value",e,r,t),Q(r)):t;case"boolean":return t}},K=function(e,r,t){switch(r){case"inherit":return Z(e,r,t,"string");case"reduce":case"dynamic-reduce":case"line-points":return Z(e,r,t,"object");case"line":return Z(e,r,t,"boolean");case"line-type":return Z(e,r,t,"string");case"line-flat":return Z(e,r,t,"boolean");case"line-width":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"line-width-units":return Z(e,r,t,"string");case"line-color":return Z(e,r,t,"object",4,0,255);case"line-style":return Z(e,r,t,"string");case"line-style-texture":return Z(e,r,t,"object",3,-Number.MAX_VALUE,Number.MAX_VALUE);case"line-style-background":return Z(e,r,t,"object",4,0,255);case"line-label":return Z(e,r,t,"boolean");case"line-label-type":case"line-label-source":return Z(e,r,t,"string");case"line-label-color":case"line-label-color2":return Z(e,r,t,"object",4,0,255);case"line-label-size":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"line-label-offset":return Z(e,r,t,"number",null,-Number.MAX_VALUE,Number.MAX_VALUE);case"line-label-spacing":case"line-label-line-height":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"line-label-no-overlap":return Z(e,r,t,"boolean");case"line-label-no-overlap-factor":return Z(e,r,t,"object");case"line-label-no-overlap-margin":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"point":return Z(e,r,t,"boolean");case"point-type":return Z(e,r,t,"string");case"point-flat":return Z(e,r,t,"boolean");case"point-radius":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"point-Layer":return Z(e,r,t,"string");case"point-color":return Z(e,r,t,"object",4,0,255);case"icon":return Z(e,r,t,"boolean");case"icon-source":return Z(e,r,t,"object",5,-Number.MAX_VALUE,Number.MAX_VALUE);case"icon-scale":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"icon-offset":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"icon-origin":return Z(e,r,t,"string");case"icon-stick":return Z(e,r,t,"object",8,-Number.MAX_VALUE,Number.MAX_VALUE);case"icon-color":return Z(e,r,t,"object",4,0,255);case"icon-no-overlap":return Z(e,r,t,"boolean");case"icon-no-overlap-factor":return Z(e,r,t,"object");case"icon-no-overlap-margin":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"label":return Z(e,r,t,"boolean");case"label-color":case"label-color2":return Z(e,r,t,"object",4,0,255);case"label-source":return Z(e,r,t,"string");case"label-size":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"label-size-units":return Z(e,r,t,"string");case"label-spacing":case"label-line-height":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"label-offset":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"label-origin":case"label-align":return Z(e,r,t,"string");case"label-stick":return Z(e,r,t,"object",8,-Number.MAX_VALUE,Number.MAX_VALUE);case"label-width":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"label-no-overlap":return Z(e,r,t,"boolean");case"label-no-overlap-factor":return Z(e,r,t,"object");case"label-no-overlap-margin":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"polygon":return Z(e,r,t,"boolean");case"polygon-style":return Z(e,r,t,"string");case"polygon-use-stencil":return Z(e,r,t,"boolean");case"polygon-culling":return Z(e,r,t,"string");case"polygon-color":return Z(e,r,t,"object",4,0,255);case"polygon-extrude":return Z(e,r,t,"number",0,-Number.MAX_VALUE,Number.MAX_VALUE);case"z-index":return Z(e,r,t,"number",null,-Number.MAX_VALUE,Number.MAX_VALUE);case"zbuffer-offset":return Z(e,r,t,"object",3,0,Number.MAX_VALUE);case"selected-hover-layer":case"selected-layer":return Z(e,r,t,"string");case"hover-event":return Z(e,r,t,"boolean");case"hover-layer":return Z(e,r,t,"string");case"enter-event":case"leave-event":case"click-event":case"draw-event":case"advanced-hit":case"export-geometry":case"pack":case"visible":return Z(e,r,t,"boolean");case"visibility":return Z(e,r,t,"number",null,1e-5,Number.MAX_VALUE);case"visibility-abs":return Z(e,r,t,"object",2,1e-5,Number.MAX_VALUE);case"visibility-rel":return Z(e,r,t,"object",4,1e-5,Number.MAX_VALUE);case"visibility-switch":case"hysteresis":return Z(e,r,t,"object");case"culling":return Z(e,r,t,"number",180,1e-4,180);case"next-pass":return Z(e,r,t,"object");case"importance-source":return Z(e,r,t,"string");case"importance-weight":return Z(e,r,t,"number",null,0,Number.MAX_VALUE)}return t},Q=function(e){switch(e){case"inherit":return"";case"filter":case"reduce":case"dynamic-reduce":return null;case"line-points":return["vertices",0,0];case"line":return!1;case"line-type":return"screen";case"line-flat":return!1;case"line-width":return 1;case"line-width-units":return"meters";case"line-color":return[255,255,255,255];case"line-style":return"solid";case"line-style-texture":return null;case"line-style-background":return[0,0,0,0];case"line-label":return!1;case"line-label-type":return"flat";case"line-label-font":return["#default"];case"line-label-color":return[255,255,255,255];case"line-label-color2":return[0,0,0,255];case"line-label-outline":return[.27,.75,2.2,2.2];case"line-label-source":return"$name";case"line-label-size":return 1;case"line-label-offset":return 0;case"line-label-spacing":case"line-label-line-height":return 1;case"line-label-no-overlap":return!0;case"line-label-no-overlap-factor":return null;case"line-label-no-overlap-margin":return 1.1;case"point":return!1;case"point-type":return"screen";case"point-flat":return!1;case"point-radius":return 1;case"point-Layer":return"solid";case"point-color":return[255,255,255,255];case"icon":return!1;case"icon-source":return null;case"icon-scale":return 1;case"icon-offset":return[0,0];case"icon-origin":return"bottom-center";case"icon-stick":return[0,0,0,255,255,255,255,0];case"icon-color":return[255,255,255,255];case"icon-no-overlap":return!1;case"icon-no-overlap-factor":return null;case"icon-no-overlap-margin":return[5,5];case"label":return!1;case"label-font":return["#default"];case"label-color":return[255,255,255,255];case"label-color2":return[0,0,0,255];case"label-outline":return[.27,.75,2.2,2.2];case"label-source":return"$name";case"label-size":return 10;case"label-size-units":return"pixels";case"label-spacing":case"label-line-height":return 1;case"label-offset":return[0,0];case"label-origin":return"bottom-center";case"label-align":return"center";case"label-stick":return[0,0,0,255,255,255,255,0];case"label-width":return 200;case"label-no-overlap":return!0;case"label-no-overlap-factor":return null;case"label-no-overlap-margin":return[5,5];case"polygon":return!1;case"polygon-style":return"solid";case"polygon-use-stencil":return!0;case"polygon-culling":return"none";case"polygon-color":return[255,255,255,255];case"polygon-extrude":case"z-index":return 0;case"zbuffer-offset":return[0,0,0];case"selected-hover-layer":case"selected-layer":return"";case"hover-event":return!1;case"hover-layer":return"";case"enter-event":case"leave-event":case"click-event":case"draw-event":case"advanced-hit":case"export-geometry":case"pack":return!1;case"visible":return!0;case"visibility":case"visibility-abs":case"visibility-rel":case"visibility-switch":case"hysteresis":return null;case"culling":return 180;case"next-pass":case"importance-source":return null;case"importance-weight":return 1}};function ee(e,r,t,n,a,s,i,o,l){var u,c,f,h;if(!e||!Array.isArray(e))return!1;if(o>100)return!1;switch(e[0]){case"all":for(u=1,c=e.length;u<c;u++)if(!ee(e[u],r,t,n,a,s,i,o+1,l))return!1;return!0;case"any":for(u=1,c=e.length;u<c;u++)if(ee(e[u],r,t,n,s,i,o+1,l))return!0;return!1;case"none":for(u=1,c=e.length;u<c;u++)if(ee(e[u],r,t,n,s,i,o+1,l))return!1;return!0;case"skip":return!1}switch(l&&e[2]?f=e[1]:(j.disableLog="has"==e[0]||"!has"==e[0],f=H(a,s,r,i,e[1],0),j.disableLog=!1),e[0]){case"==":case"!=":case">=":case"<=":case">":case"<":if(void 0===(h=e[l?3:2]))return!1;l&&e[4]||(h=H(a,s,r,i,h,0))}switch(e[0]){case"==":return f==h;case"!=":return f!=h;case">=":return f>=h;case"<=":return f<=h;case">":return f>h;case"<":return f<h;case"has":return void 0!==f;case"!has":return void 0===f;case"in":for(u=l?3:2,c=e.length;u<c;u++)if(e[u]==f)return!0;return!1;case"!in":for(u=l?3:2,c=e.length;u<c;u++)if(e[u]==f)return!1;return!0}return!1}function re(e){switch(typeof e){case"number":return!0;case"string":if(!(e.length>0))return!0;switch(e.charAt(0)){case"#":case"$":case"@":case"&":break;default:if(-1==e.indexOf("{"))return!0}}return!1}var te=function(e,r,t){var n,a,s={};for(n in function(e,r,t,n){for(var a in null!=t.inherit&&J(e,r,t,n,0),t)r[a]=t[a];r["$$layer-id"]=e}(e,s,r,t),s){if("string"==typeof(a=s[n])&&a.length>0)switch(a.charAt(0)){case"@":null!=j.stylesheetConstants[a]?s[n]=j.stylesheetConstants[a]:(W("wrong-object",e,n,a,null,"constant"),s[n]=Q(n));break;case"%":null!=j.stylesheetLocals[a]?(s["$$layer-variables"]||(s["$$layer-variables"]={}),s["$$layer-variables"][n]=a,s[n]=j.stylesheetLocals[a]):(W("wrong-object",e,n,a,null,"variable"),s[n]=Q(n))}if("visibility-switch"==n){if(!(Array.isArray(a)&&a.length>0))return W("wrong-property-value",e,n,a),Q(n);for(var i=0,o=a.length;i<o;i++){var l=a[i],u=!1;"object"==typeof l&&Array.isArray(l)&&2==l.length?("string"==typeof l[0]&&"@"==l[0].charAt(0)&&(void 0===j.stylesheetConstants[l[0]]?u=!0:l[0]=j.stylesheetConstants[l[0]]),("number"!=typeof l[0]||"string"!=typeof l[1]&&null!==l[1])&&(u=!0)):u=!0,u&&W("wrong-property-value[]",e,n,a,i)}}}return s},ne=n,ae=function(e){if(o)return o.encode(e);for(var r=String(e),t=r.length,n=0,a=[];n<t;){var s=r.charCodeAt(n);if(s<55296||s>57343)a.push(s);else if(56320<=s&&s<=57343)a.push(65533);else if(55296<=s&&s<=56319)if(n===t-1)a.push(65533);else{var i=r.charCodeAt(n+1);if(56320<=i&&i<=57343){var l=1023&s,u=1023&i;a.push(65536+(l<<10)+u),n+=1}else a.push(65533)}n+=1}return new Uint8Array(new Uint32Array(a).buffer)},se=new Uint8Array(16777216),ie=new Uint8Array(16777216),oe=[],le=[];function ue(e,r){ne.config.mapPackLoaderEvents?(oe.push(e),r&&(le=le.concat(r))):r?postMessage(e,r):postMessage(e)}function ce(e,r,t,n,a){var s,i,o=ae(JSON.stringify(t)),l=6+o.byteLength;for(s=0,i=n.length;s<i;s++)l+=4+n[s].byteLength;var u,c=new Uint8Array(l),f=new DataView(c.buffer),h=0;for(f.setUint8(h,e),h+=1,f.setUint8(h,r),h+=1,f.setUint32(h,o.byteLength),h+=4,c.set(o,h),u=h+=o.byteLength,s=0,i=n.length;s<i;s++)f.setUint32(h,n[s].length),h+=4,c.set(new Uint8Array(n[s].buffer),h),h+=n[s].byteLength;fe(e,r,c.buffer,u,a,t.hitable,t.totalPoints,11==r?t:null)}function fe(e,r,t,n,a,s,i,o){if(ne.messageBufferIndex>=ne.messageBufferSize){var l=ne.messageBuffer;ne.messageBufferSize+=65536,ne.messageBuffer=new Array(ne.messageBufferSize);for(var u=0,c=ne.messageBufferIndex;u<c;u++)ne.messageBuffer[u]=l[u]}ne.messageBuffer[ne.messageBufferIndex]={command:e,type:r,job:t,buffersIndex:n,signature:a,hitable:s,totalPoints:i,job2:o},ne.messageBufferIndex++,ne.messagePackSize+=t.byteLength}function he(e,r,t){var n=1==e?ie:se;if(n.byteLength<=r.byteLength+t){var a=new Uint8Array(2*n.byteLength);a.set(n,0),n=a,1==e?ie=n:se=n}n.set(r,t)}var ve=n,de=a,be=q,ge=$,pe=function(e,r,t,n,a,s,i,o,l,u,c,f,h){for(var v=[0,1,0],d=[e[0],e[1],e[2]],b=f||S.U.stringToGlyphs(s,t),g=b[0],p=b[1],y=0,L=g.length;y<L;y++){var A=g[y],m=s[p[y]];if(m){var N=O(n,m),U=M(d,r,0,A,N,a,u,u,v,s,i,o,l,c,p[y],h);d=U[0],u=U[1]}}return u},ye=function(e,r,t,n,a,s){for(var i=0,o=s||S.U.stringToGlyphs(a,e),l=o[0],u=o[1],c=o[2],f=0,h=l.length;f<h;f++){var v=l[f],d=c[f];if(i>r&&(10==d||9==d||32==d))return f;if(10!=d){var b=a[u[f]];if(b){var g=O(t,b)*n,p=b.glyphs[v];p&&(i+=f==h-1?p.lx*g:p.step*g)}}}return h},Le=P,Ae=_,me=F,Ne=z,Ue=C,we=B,xe=function(e,r,t){var n=O(e,t[0]);return t[0].cly*n*r},Se=ce,Me=function(e){var r,t,n,a,s,i,o,l=[];if(e["d-points"]||e["d-lines"]){if(l=e["d-points"]||e["d-lines"],Array.isArray(l)&&s.length>0)for(n=0,a=l;n<a;n++)if(s=l[n],Array.isArray(s)&&s.length>0)for((i=s[0])[0]=i[0]>>1^-(1&i[0]),i[1]=i[1]>>1^-(1&i[1]),i[2]=i[2]>>1^-(1&i[2]),r=1,t=s.length;r<t;r++)i=s[r-1],(o=s[r])[0]=(o[0]>>1^-(1&o[0]))+i[0],o[1]=(o[1]>>1^-(1&o[1]))+i[1],o[2]=(o[2]>>1^-(1&o[2]))+i[2];e["d-points"]?(e.points=e["d-points"],delete e["d-points"]):(e.lines=e["d-lines"],delete e["d-lines"])}},Be=function(e,r,t,n,a,s){var i,o,l,u,c,f=[];if(Me(e),(f=e.lines?e.lines:[e.points])&&0!=f.length){var h,v,d,b,g=be(t,"visibility-rel",e,r)||be(t,"visibility-abs",e,r)||be(t,"visibility",e,r),p=be(t,"culling",e,r),y=be(t,"hover-event",e,r),L=be(t,"click-event",e,r),A=be(t,"draw-event",e,r),m=be(t,"enter-event",e,r),N=be(t,"leave-event",e,r),U=be(t,"advanced-event",e,r),w=be(t,"line-points",e,r),x=be(t,"zbuffer-offset",e,r),S=be(t,"point",e,r),M=be(t,"point-flat",e,r),B=be(t,"point-color",e,r),O=.5*be(t,"point-radius",e,r),_=0;for(l=0,u=f.length;l<u;l++)c=f[l],Array.isArray(c)&&c.length>0&&(_+=c.length);var k=be(t,"icon",e,r);if(k)if(h=be(t,"icon-source",e,r)){v=we()*_,d=we(!0)*_;var I={color:be(t,"icon-color",e,r),scale:be(t,"icon-scale",e,r),offset:be(t,"icon-offset",e,r),stick:be(t,"icon-stick",e,r),reduce:be(t,"dynamic-reduce",e,r),origin:be(t,"icon-origin",e,r),source:be(t,"icon-source",e,r),noOverlap:be(t,"icon-no-overlap",e,r),noOverlapMargin:be(t,"icon-no-overlap-margin",e,r),noOverlapFactor:be(t,"icon-no-overlap-factor",e,r),index:0,index2:0};_>1?(I.vertexBuffer=new Float32Array(v),I.originBuffer=new Float32Array(d),I.texcoordsBuffer=new Float32Array(v)):I.singleBuffer=new Float32Array(16)}else k=!1;var E=be(t,"label",e,r);if(E){h=be(t,"label-source",e,r);var C=ge(t,h,e,r,h);C=C?C.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var F=be(t,"label-size",e,r),z=be(t,"label-font",e,r),P=me(z),j=Le(C,P);if("$name"==h&&!Ue(C,P,j)){var T=ge(t,"$name:en",e,r,h);T=T?T.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var V=Le(T,P);Ue(T,P)&&(C=T,j=V)}if(C&&""!=C&&Math.abs(F)>1e-4){b=be(t,"label-no-overlap",e,r),v=we()*C.length*(b?1:_),d=we(!0)*C.length*(b?1:_);var G=1==_,X=1;"points"==be(t,"label-size-units",e,r)&&(X=ve.pixelFactor/(1/72*96));var D={color:be(t,"label-color",e,r),color2:be(t,"label-color2",e,r),outline:be(t,"label-outline",e,r),reduce:be(t,"dynamic-reduce",e,r),size:F*X,spacing:be(t,"label-spacing",e,r),lineHeight:be(t,"label-line-height",e,r),offset:be(t,"label-offset",e,r),stick:be(t,"label-stick",e,r),origin:be(t,"label-origin",e,r),align:be(t,"label-align",e,r),fonts:P,fontsStorage:Ne(z),text:C,hysteresis:be(t,"hysteresis",e,r),width:X*be(t,"label-width",e,r),noOverlap:b,noOverlapMargin:be(t,"label-no-overlap-margin",e,r),noOverlapFactor:be(t,"label-no-overlap-factor",e,r),vertexBuffer:G?null:new Float32Array(v),originBuffer:G?null:new Float32Array(d),texcoordsBuffer:G?null:new Float32Array(v),singleBuffer:G?new Float32Array(4*C.length*2):null,index:0,index2:0,glyphsRes:j};D.stick&&(D.stick=D.stick.slice(),D.stick[2]*=X)}else E=!1}var R,$,q,Y,H,J,W,Z=0,K=0,Q=[0,0,0],ee=ve.forceOrigin,re=ve.bboxMin,te=ve.tileX,ne=ve.tileY,ae=ve.forceScale,se=function(e){if(k&&!I.noOverlap&&($=_e(J,I)),E&&!D.noOverlap&&(R=ke(J,D)),S)for(var r=0;r<Fe;r++)M?(Oe[Z]=J[0],Oe[Z+1]=J[1],Oe[Z+2]=J[2],Oe[Z+3]=J[0]+Ce[r][0]*O,Oe[Z+4]=J[1]+Ce[r][1]*O,Oe[Z+5]=J[2],Oe[Z+6]=J[0]+Ce[r+1][0]*O,Oe[Z+7]=J[1]+Ce[r+1][1]*O,Oe[Z+8]=J[2],Z+=9):(Oe[Z]=J[0],Oe[Z+1]=J[1],Oe[Z+2]=J[2],Oe[Z+3]=0,Ie[K]=0,Ie[K+1]=0,Ie[K+2]=0,Ie[K+3]=0,Oe[Z+4]=J[0],Oe[Z+5]=J[1],Oe[Z+6]=J[2],Oe[Z+7]=0,Ie[K+4]=Ce[r][0]*O,Ie[K+5]=Ce[r][1]*O,Ie[K+6]=0,Ie[K+7]=0,Oe[Z+8]=J[0],Oe[Z+9]=J[1],Oe[Z+10]=J[2],Oe[Z+11]=0,Ie[K+8]=Ce[r+1][0]*O,Ie[K+9]=Ce[r+1][1]*O,Ie[K+10]=0,Ie[K+11]=0,Z+=12,K+=12)},ie=function(e){var r=0,t=0;if(q=c[0],Y=[q[0],q[1],q[2]],ee&&(Y=[Y[0]-te,Y[1]-ne,Y[2]]),null!=ae&&(Y=[Y[0]*ae[0],Y[1]*ae[1],Y[2]*ae[2]]),0==e)return Y;for(var n=0,a=c.length-1;n<a;n++){q=c[n+1],H=[q[0],q[1],q[2]],ee&&(H=[H[0]-te,H[1]-ne,H[2]]),null!=ae&&(H=[H[0]*ae[0],H[1]*ae[1],H[2]*ae[2]]);var s=H[0]-Y[0],i=H[1]-Y[1],o=H[2]-Y[2],l=Math.sqrt(s*s+i*i+o*o);if(r=t,t+=l,e>=r&&e<=t){var u=(e-r)/l;return[Y[0]+s*u,Y[1]+i*u,Y[2]+o*u]}Y=H}},oe=new Array(2048),le=0;for(l=0,u=f.length;l<u;l++)if(c=f[l],Array.isArray(c)&&c.length>0){var ue=0,ce=null;for("vertices"!=w[0]&&((ce=new Array(c.length))[0]=0),i=0,o=c.length;i<o;i++){if(q=c[i],Y=[q[0],q[1],q[2]],ee&&(Y=[Y[0]-te,Y[1]-ne,Y[2]]),null!=ae&&(Y=[Y[0]*ae[0],Y[1]*ae[1],Y[2]*ae[2]]),i+1<o){q=c[i+1],H=[q[0],q[1],q[2]],ee&&(H=[H[0]-te,H[1]-ne,H[2]]),null!=ae&&(H=[H[0]*ae[0],H[1]*ae[1],H[2]*ae[2]]);var fe=H[0]-Y[0],he=H[1]-Y[1],pe=H[2]-Y[2],ye=Math.sqrt(fe*fe+he*he+pe*pe);ce&&(ce[i]=ye),ue+=ye}Q[0]+=Y[0],Q[1]+=Y[1],Q[2]+=Y[2],"vertices"==w[0]&&(oe[le]=Y,le++)}if("by-length"==w[0]||"by-ratio"==w[0]){var Ae=w[1],xe=w[2]||0;if("by-ratio"==w[0]&&(Ae*=ue,xe*=ue),Ae<=0)oe[le]=ie(xe),oe[le]&&le++;else for(i=xe;i<ue;i+=Ae)oe[le]=ie(i),oe[le]&&le++}"start"==w[0]&&(oe[le]=ie(0),le++),"end"==w[0]&&(oe[le]=ie(ue),le++),"endpoints"==w[0]&&(oe[le]=ie(0),oe[++le]=ie(ue),le++),"middle"!=w[0]&&"midpoint"!=w[0]||(oe[le]=ie(.5*ue),le++)}var Be,Oe,Ie,Ee=le;if(S){var Ce=[],Fe=de(8*O*.5,8,32),ze=0,Pe=2*Math.PI/Fe;for(i=0;i<Fe;i++)Ce[i]=[-Math.sin(ze),Math.cos(ze)],ze+=Pe;Ce[Fe]=[0,1],M?(Be=3*Fe*3,Oe=new Float32Array(Ee*Be)):(Be=3*Fe*4,Oe=new Float32Array(Ee*Be),Ie=new Float32Array(Ee*(3*Fe*4)))}if(le){for(ve.directPoints=oe.slice(0,le),i=0;i<le;i++)J=oe[i],se();_>0&&(Q[0]/=_,Q[1]/=_,Q[2]/=_),Q[0]+=re[0],Q[1]+=re[1],Q[2]+=re[2];var je=y||L||m||N;ve.signatureCounter++;var Te=""+ve.signatureCounter;g&&!Array.isArray(g)&&(g=[g]),S&&(M?Se(5,6,{color:B,"z-index":a,visibility:g,center:Q,"hover-event":y,"click-event":L,"draw-event":A,advancedHit:U,"enter-event":m,"leave-event":N,"zbuffer-offset":x,hitable:je,state:ve.hitState,eventInfo:ve.alwaysEventInfo||je||A?s:{},lod:ve.autoLod?null:ve.tileLod},[Oe],Te):Se(5,9,{color:B,"z-index":a,visibility:g,center:Q,"hover-event":y,"click-event":L,"draw-event":A,"enter-event":m,"leave-event":N,"zbuffer-offset":x,hitable:je,state:ve.hitState,eventInfo:ve.alwaysEventInfo||je||A?s:{},lod:ve.autoLod?null:ve.tileLod},[Oe,Ie],Te));var Ve=function(){if(k){if(ve.signatureCounter++,Te=""+ve.signatureCounter,I.noOverlap){var e=I.noOverlapMargin,r=null,t=null;if(null!==I.noOverlapFactor){switch(I.noOverlapFactor[0]){case"direct":r=0;break;case"div-by-dist":r=1}t=I.noOverlapFactor[1]}var i=[$[0]-e[0],$[1]-e[1],$[2]+e[0],$[3]+e[1],r,t]}(I.singleBuffer&&I.singleBuffer.length>0||I.vertexBuffer&&I.vertexBuffer.length>0)&&Se(5,I.singleBuffer?3:4,{icon:ve.stylesheetBitmaps[I.source[0]],color:I.color,"z-index":a,visibility:g,culling:p,center:W,stick:I.stick,"hover-event":y,"click-event":L,"draw-event":A,advancedHit:U,"enter-event":m,"leave-event":N,"zbuffer-offset":x,noOverlap:I.noOverlap?i:null,hitable:je,state:ve.hitState,eventInfo:ve.alwaysEventInfo||je||A?s:{},index:n,reduce:I.reduce,lod:ve.autoLod?null:ve.tileLod},I.singleBuffer?[I.singleBuffer]:[I.vertexBuffer,I.originBuffer,I.texcoordsBuffer],Te)}},Ge=function(){if(E){if(ve.signatureCounter++,Te=""+ve.signatureCounter,D.noOverlap){var e=D.noOverlapMargin,r=null,t=null;if(null!==D.noOverlapFactor){switch(D.noOverlapFactor[0]){case"direct":r=0;break;case"div-by-dist":r=1}t=D.noOverlapFactor[1]}var i=[R[0]-e[0],R[1]-e[1],R[2]+e[0],R[3]+e[1],r,t]}(D.singleBuffer&&D.singleBuffer.length>0||D.vertexBuffer&&D.vertexBuffer.length>0)&&Se(5,D.singleBuffer?1:2,{size:D.size,origin:D.pos,color:D.color,color2:D.color2,outline:D.outline,"z-index":a,visibility:g,culling:p,center:W,stick:D.stick,noOverlap:D.noOverlap?i:null,"hover-event":y,"click-event":L,"draw-event":A,files:D.files,index:n,"enter-event":m,"leave-event":N,"zbuffer-offset":x,fonts:D.fontsStorage,hitable:je,state:ve.hitState,advancedHit:U,reduce:D.reduce,hysteresis:D.hysteresis,eventInfo:ve.alwaysEventInfo||je||A?s:{},lod:ve.autoLod?null:ve.tileLod},D.singleBuffer?[D.singleBuffer]:[D.vertexBuffer,D.originBuffer,D.texcoordsBuffer],Te)}};for(k&&!I.noOverlap&&(W=Q,Ve()),E&&!D.noOverlap&&(W=Q,Ge()),i=0,o=ve.insidePack?1:ve.directPoints.length;i<o;i++)J=ve.directPoints[i],W=[J[0]+re[0],J[1]+re[1],J[2]+re[2]],k&&I.noOverlap&&($=_e(J,I,$),Ve()),E&&D.noOverlap&&(R=ke(J,D,R),Ge())}}},Oe=function(e,r,t){switch(e){case"top-left":return[0,0];case"top-right":return[-r,0];case"top-center":return[.5*-r,0];case"center-left":return[0,.5*-t];case"center-right":return[-r,.5*-t];case"center-center":return[.5*-r,.5*-t];case"bottom-left":return[0,-t];case"bottom-right":return[-r,-t];case"bottom-center":return[.5*-r,-t]}},_e=function(e,r,t){t&&(r.index=0,r.index2=0,r.vertexBuffer=r.vertexBuffer?new Float32Array(r.vertexBuffer.length):null,r.originBuffer=r.originBuffer?new Float32Array(r.originBuffer.length):null,r.singleBuffer=r.singleBuffer?new Float32Array(r.singleBuffer.length):null);var n=r.source,a=r.index,s=r.index2,i=a,o=Math.abs(n[3]*r.scale*.5),l=Math.abs(n[4]*r.scale*.5),u=Oe(r.origin,o,l),c=u[0]+r.offset[0],f=u[1]+r.offset[1];if(r.singleBuffer){var h=r.singleBuffer;return h[0]=c,h[1]=f,h[2]=n[1],h[3]=n[2],h[4]=o+c,h[5]=f,h[6]=n[1]+n[3],h[7]=n[2],h[8]=o+c,h[9]=l+f,h[10]=n[1]+n[3],h[11]=n[2]+n[4],h[12]=c,h[13]=l+f,h[14]=n[1],h[15]=n[2]+n[4],[.5*c,.5*f,.5*(c+o)+1,.5*(f+l)]}var v=r.vertexBuffer,d=r.texcoordsBuffer,b=r.originBuffer;v[a]=0,v[a+1]=0,v[a+2]=0,v[a+3]=0,v[a+4]=o,v[a+5]=0,v[a+6]=0,v[a+7]=0,v[a+8]=o,v[a+9]=-l,v[a+10]=0,v[a+11]=0,d[a]=n[1],d[a+1]=n[2],d[a+2]=0,d[a+3]=0,d[a+4]=n[1]+n[3],d[a+5]=n[2],d[a+6]=0,d[a+7]=0,d[a+8]=n[1]+n[3],d[a+9]=n[2]+n[4],d[a+10]=0,d[a+11]=0,v[a+=12]=0,v[a+1]=0,v[a+2]=0,v[a+3]=0,v[a+4]=0,v[a+5]=-l,v[a+6]=0,v[a+7]=0,v[a+8]=o,v[a+9]=-l,v[a+10]=0,v[a+11]=0,d[a]=n[1],d[a+1]=n[2],d[a+2]=0,d[a+3]=0,d[a+4]=n[1],d[a+5]=n[2]+n[4],d[a+6]=0,d[a+7]=0,d[a+8]=n[1]+n[3],d[a+9]=n[2]+n[4],d[a+10]=0,d[a+11]=0,a+=12;for(var g=e[0],p=e[1],y=e[2],L=i;L<a;L+=4)v[L]+=c,v[L+1]-=f,b[s]=g,b[s+1]=p,b[s+2]=y,s+=3;return r.index=a,r.index2=s,[.5*c,.5*f,.5*(c+o)+1,.5*(f+l)]},ke=function(e,r,t){t&&(r.index=0,r.index2=0,r.vertexBuffer=r.vertexBuffer?new Float32Array(r.vertexBuffer.length):null,r.originBuffer=r.originBuffer?new Float32Array(r.originBuffer.length):null,r.singleBuffer=r.singleBuffer?new Float32Array(r.singleBuffer.length):null);var n=r.vertexBuffer,a=r.texcoordsBuffer,s=r.originBuffer,i=r.singleBuffer,o=r.index,l=r.index2,u=o,c=(r.text,r.fonts),f={},h=r.glyphsRes,v=[],d=[];do{var b=h[2].indexOf(10);-1!=b?(v.push([h[0].slice(0,b),h[1].slice(0,b),h[2].slice(0,b)]),h=[h[0].slice(b+1),h[1].slice(b+1),h[2].slice(b+1)]):v.push(h)}while(-1!=b);for(var g=0,p=v.length;g<p;g++)for(h=v[g];;){var y=ye(null,r.width,r.size,r.spacing,c,h);if(h[2].length==y){d.push(h);break}d.push([h[0].slice(0,y),h[1].slice(0,y),h[2].slice(0,y)]),h=[h[0].slice(y+1),h[1].slice(y+1),h[2].slice(y+1)]}var L=0,A=0,m=xe(r.size,r.lineHeight,c),N=0,U=[];for(g=0,p=d.length;g<p;g++)U[g]=Ae(null,r.size,r.spacing,c,d[g]),N=Math.max(U[g],N);for(g=0,p=d.length;g<p;g++){var w=U[g];switch(r.align){case"left":L=0;break;case"right":L=N-w;break;case"center":L=.5*(N-w)}o=pe([L,A,0],[1,0,0],null,r.size,r.spacing,c,n,a,!0,o,f,d[g],i),A-=m}var x=Oe(r.origin,N,-A),S=x[0]+r.offset[0],M=x[1]+r.offset[1],B=e[0],O=e[1],_=e[2];if(i){for(g=u;g<o;g+=8)i[g]+=S,i[g+1]-=M,i[g+2]+=S,i[g+3]-=M;r.pos=[B,O,_],i=new Float32Array(i.buffer,0,o)}else for(g=u;g<o;g+=4)n[g]+=S,n[g+1]-=M,s[l]=B,s[l+1]=O,s[l+2]=_,l+=3;c=r.fonts;for(r.files=new Array(c.length),g=0,p=c.length;g<p;g++)r.files[g]=[];for(var k in f){var I=parseInt(k),E=f[k],C=[];for(var F in E){var z=parseInt(F)-4e3*I,P=Math.round((z-z%4)/4);-1==C.indexOf(P)&&C.push(P)}r.files[I]=C}return r.index=o,r.index2=l,[.5*S,.5*M,.5*(S+N)+1,.5*(M+Math.abs(A))]},Ie=n,Ee=s,Ce=i,Fe=q,ze=$,Pe=function(e,r){return void 0!==e[r]},je=function(e,r,t,n,a,s,i,o,l,u,c,f){var h=_(r,t,n,a,c),v=k(e),d=.5*(v-h);if(d<0&&(d=0),!(h>v)){var b=E(e,d,r,t,n,a,c);return N.textVector=b,N.textCenter=I(e,.5*v)[0],N.textLength=h,function(e,r,t,n,a,s,i,o,l,u,c,f,h,v){null==s&&(s=[0,1,0]);var d=e[0];d=[d[0],d[1],d[2]];var b=r,g=h||S.U.stringToGlyphs(i,t),p=g[0],y=g[1];N.processLineLabel=!0;for(var L=0,A=p.length;L<A;L++){var m=p[L],w=i[y[L]];if(w){var x=O(n,w),B=.01,_=w.glyphs[m];_&&(B=_.step*x*a);var k=I(e,b),E=I(e,b+B),C=[.5*(E[1][0]+k[1][0]),.5*(E[1][1]+k[1][1]),.5*(E[1][2]+k[1][2])];U(C);var F=M(k[0],C,-x*w.size*.7+o,m,x,a,c,c,s,i,l,u,null,f,y[L],v);d=F[0],c=F[1],b+=B}}return N.processLineLabel=!1,c}(e,d,r,t,n,b,a,s,i,o,l,u,c,f)}},Te=C,Ve=B,Ge=F,Xe=z,De=ce,Re=P,$e=Me,qe=function(e,r,t,n,a,s){$e(e);var i=e.lines;if(i&&0!=i.length){var o=Fe(t,"line",e,r),l=Fe(t,"line-label",e,r);if(o||l){var u=Fe(t,"hover-event",e,r),c=Fe(t,"click-event",e,r),f=Fe(t,"draw-event",e,r),h=Fe(t,"enter-event",e,r),v=Fe(t,"leave-event",e,r),d=Fe(t,"advanced-hit",e,r),b=Fe(t,"zbuffer-offset",e,r);if(Pe(t,"line-type"));else var g=Fe(t,"line-flat",e,r);var p=Fe(t,"line-color",e,r),y=.5*Fe(t,"line-width",e,r),L=Fe(t,"line-width-units",e,r),A=Fe(t,"line-style",e,r),m=Fe(t,"line-style-texture",e,r),N=Fe(t,"line-style-background",e,r),U=Fe(t,"line-label-size",e,r),w="solid"!=A,x="ratio"==L;"points"==L&&(y*=Ie.pixelFactor/(1/72*96));var S,M,B,O,_,k,I,E,C,F,z,P,j=0,T=0,V=0,G=!1,X=1;if(!(G=x?!g&&1080*y<2.1:!g&&y<2.1)){var D=[],R=[],$=8,q=0,Y=2*Math.PI/$;for(M=0;M<$;M++)D[M]=[-Math.sin(q),Math.cos(q)],R[M]=q,q+=Y;D[$]=[0,1],R[$]=0}var H=0;for(S=0;S<i.length;S++)Array.isArray(i[S])&&(H+=i[S].length);if(!(H<=1)){g&&($=2);var J=3*(w||x||!g?4:3)*2,W=new Float32Array((H-1)*J+H*(G?0:$*(w||x||!g?4:3)*3));if(d)var Z=new Float32Array(6*(H-1)+H*(G?0:$)*3);if(!g||w||x)var K=new Float32Array(24*(H-1)+H*(G?0:3*$*4));var Q=[0,0,0],ee=[],re=Ie.forceOrigin,te=Ie.bboxMin,ne=Ie.geocent,ae=Ie.tileX,se=Ie.tileY,ie=Ie.forceScale,oe=[1,0,0],le=[-1,0,0];for(S=0;S<i.length;S++)if(Array.isArray(i[S])&&i[S].length){var ue=i[S];if(l){var ce=new Array(ue.length),fe=new Array(ue.length);ee.push({points:ce,points2:fe})}F=[(z=ue[0])[0],z[1],z[2]],re&&(F=[F[0]-ae,F[1]-se,F[2]]),null!=ie&&(F=[F[0]*ie[0],F[1]*ie[1],F[2]*ie[2]]);var he=.001,ve=.001,de=j,be=T;for(M=0,B=ue.length-1;M<B;M++)F=ue[M],O=ue[M+1],re&&(F=[F[0]-ae,F[1]-se,F[2]],O=[O[0]-ae,O[1]-se,O[2]]),null!=ie&&(F=[F[0]*ie[0],F[1]*ie[1],F[2]*ie[2]],O=[O[0]*ie[0],O[1]*ie[1],O[2]*ie[2]]),d&&(P=X+M,Z[V]=P,Z[V+1]=P,Z[V+2]=P,Z[V+3]=P,Z[V+4]=P,Z[V+5]=P,V+=6),!g||w||x?g?(ne?(_=[O[0]-F[0],O[1]-F[1],O[2]-F[2]],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]+_[2]*_[2]),I=0!=I?1/I:0,k=[_[0]*I,_[1]*I,_[2]*I],E=[0,0,0],0==M&&(oe=k),M==B-1&&(le=k),Ee(te,C=[0,0,0]),Ce(C,k,E),E=[E[0],E[1],E[2]]):(_=[O[0]-F[0],O[1]-F[1],0],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]),I=0!=I?y/I:0,E=[-_[1],_[0],0],0==M&&(oe=[_[0]*I,_[1]*I,0]),M==B-1&&(le=[_[0]*I,_[1]*I,0])),W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,K[T]=E[0],K[T+1]=E[1],K[T+2]=E[2],K[T+3]=y,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=-he,K[T+4]=-E[0],K[T+5]=-E[1],K[T+6]=-E[2],K[T+7]=y,W[j+8]=O[0],W[j+9]=O[1],W[j+10]=O[2],W[j+11]=ve,K[T+8]=E[0],K[T+9]=E[1],K[T+10]=E[2],K[T+11]=y,W[j+12]=F[0],W[j+13]=F[1],W[j+14]=F[2],W[j+15]=-he,K[T+12]=-E[0],K[T+13]=-E[1],K[T+14]=-E[2],K[T+15]=y,W[j+16]=O[0],W[j+17]=O[1],W[j+18]=O[2],W[j+19]=-ve,K[T+16]=-E[0],K[T+17]=-E[1],K[T+18]=-E[2],K[T+19]=y,W[j+20]=O[0],W[j+21]=O[1],W[j+22]=O[2],W[j+23]=ve,K[T+20]=E[0],K[T+21]=E[1],K[T+22]=E[2],K[T+23]=y,j+=24,T+=24):(_=[O[0]-F[0],O[1]-F[1],0],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]),W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,K[T]=O[0],K[T+1]=O[1],K[T+2]=O[2],K[T+3]=y,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=-he,K[T+4]=O[0],K[T+5]=O[1],K[T+6]=O[2],K[T+7]=-y,W[j+8]=O[0],W[j+9]=O[1],W[j+10]=O[2],W[j+11]=-ve,K[T+8]=F[0],K[T+9]=F[1],K[T+10]=F[2],K[T+11]=y,W[j+12]=F[0],W[j+13]=F[1],W[j+14]=F[2],W[j+15]=he,K[T+12]=O[0],K[T+13]=O[1],K[T+14]=O[2],K[T+15]=y,W[j+16]=O[0],W[j+17]=O[1],W[j+18]=O[2],W[j+19]=-ve,K[T+16]=F[0],K[T+17]=F[1],K[T+18]=F[2],K[T+19]=y,W[j+20]=O[0],W[j+21]=O[1],W[j+22]=O[2],W[j+23]=ve,K[T+20]=F[0],K[T+21]=F[1],K[T+22]=F[2],K[T+23]=-y,j+=24,T+=24):(ne?(_=[O[0]-F[0],O[1]-F[1],O[2]-F[2]],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]+_[2]*_[2]),I=0!=I?1/I:0,k=[_[0]*I,_[1]*I,_[2]*I],E=[0,0,0],Ee(te,C=[0,0,0]),Ce(C,k,E),0==M&&(oe=k),M==B-1&&(le=k),E=[E[0]*y,E[1]*y,E[2]*y]):(_=[O[0]-F[0],O[1]-F[1],0],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]),I=0!=I?y/I:0,E=[-_[1]*I,_[0]*I,0],0==M&&(oe=[_[0]*I,_[1]*I,0]),M==B-1&&(le=[_[0]*I,_[1]*I,0])),W[j]=F[0]+E[0],W[j+1]=F[1]+E[1],W[j+2]=F[2]+E[2],W[j+3]=F[0]-E[0],W[j+4]=F[1]-E[1],W[j+5]=F[2]-E[2],W[j+6]=O[0]+E[0],W[j+7]=O[1]+E[1],W[j+8]=O[2]+E[2],W[j+9]=F[0]-E[0],W[j+10]=F[1]-E[1],W[j+11]=F[2]-E[2],W[j+12]=O[0]-E[0],W[j+13]=O[1]-E[1],W[j+14]=O[2]-E[2],W[j+15]=O[0]+E[0],W[j+16]=O[1]+E[1],W[j+17]=O[2]+E[2],j+=18),he=ve,F=O;for(F=[z[0],z[1],z[2]],M=0,B=ue.length;M<B;M++){if(re&&(F=[F[0]-ae,F[1]-se,F[2]]),null!=ie&&(F=[F[0]*ie[0],F[1]*ie[1],F[2]*ie[2]]),Q[0]+=F[0],Q[1]+=F[1],Q[2]+=F[2],!G){var ge,pe;if(g)d&&(P=X+(M!=B-1?M:M-1),Z[V]=P,Z[V+1]=P,Z[V+2]=P,Z[V+3]=P,Z[V+4]=P,Z[V+5]=P,V+=6),w||x?(he=M!=B-1?W[M*J+3]:W[(M-1)*J+11],ge=M!=B-1?be+M*J:be+(M-1)*J+8,pe=M>0?be+(M-1)*J+8:be+ge,W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=he,W[j+8]=F[0],W[j+9]=F[1],W[j+10]=F[2],W[j+11]=he,W[j+12]=F[0],W[j+1+12]=F[1],W[j+2+12]=F[2],W[j+3+12]=he,W[j+4+12]=F[0],W[j+5+12]=F[1],W[j+6+12]=F[2],W[j+7+12]=-he,W[j+8+12]=F[0],W[j+9+12]=F[1],W[j+10+12]=F[2],W[j+11+12]=-he,0==M?(K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=-y,K[T+4]=K[ge],K[T+5]=K[ge+1],K[T+6]=K[ge+2],K[T+7]=y,K[T+8]=-oe[0],K[T+9]=-oe[1],K[T+10]=-oe[2],K[T+11]=-y,K[T+12]=0,K[T+1+12]=0,K[T+2+12]=0,K[T+3+12]=-y,K[T+4+12]=-K[ge],K[T+5+12]=-K[ge+1],K[T+6+12]=-K[ge+2],K[T+7+12]=y,K[T+8+12]=-oe[0],K[T+9+12]=-oe[1],K[T+10+12]=-oe[2],K[T+11+12]=-y):M==B-1?(K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=-y,K[T+4]=K[pe],K[T+5]=K[pe+1],K[T+6]=K[pe+2],K[T+7]=y,K[T+8]=le[0],K[T+9]=le[1],K[T+10]=le[2],K[T+11]=-y,K[T+12]=0,K[T+1+12]=0,K[T+2+12]=0,K[T+3+12]=-y,K[T+4+12]=-K[pe],K[T+5+12]=-K[pe+1],K[T+6+12]=-K[pe+2],K[T+7+12]=y,K[T+8+12]=le[0],K[T+9+12]=le[1],K[T+10+12]=le[2],K[T+11+12]=-y):(K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=-y,K[T+4]=K[ge],K[T+5]=K[ge+1],K[T+6]=K[ge+2],K[T+7]=y,K[T+8]=K[pe],K[T+9]=K[pe+1],K[T+10]=K[pe+2],K[T+11]=y,K[T+12]=0,K[T+1+12]=0,K[T+2+12]=0,K[T+3+12]=-y,K[T+4+12]=-K[ge],K[T+5+12]=-K[ge+1],K[T+6+12]=-K[ge+2],K[T+7+12]=y,K[T+8+12]=-K[pe],K[T+9+12]=-K[pe+1],K[T+10+12]=-K[pe+2],K[T+11+12]=y),j+=24,T+=24):(ge=M!=B-1?de+M*J:de+(M-1)*J,pe=M>0?de+(M-1)*J:de+ge,0==M?(W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=W[ge],W[j+4]=W[ge+1],W[j+5]=W[ge+2],W[j+6]=F[0]-oe[0]*y,W[j+7]=F[1]-oe[1]*y,W[j+8]=F[2]-oe[2]*y,W[j+9]=F[0],W[j+9+1]=F[1],W[j+9+2]=F[2],W[j+9+3]=W[ge+3],W[j+9+4]=W[ge+4],W[j+9+5]=W[ge+5],W[j+9+6]=F[0]-oe[0]*y,W[j+9+7]=F[1]-oe[1]*y,W[j+9+8]=F[2]-oe[2]*y):M==B-1?(W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=W[ge+15],W[j+4]=W[ge+16],W[j+5]=W[ge+17],W[j+6]=F[0]+le[0]*y,W[j+7]=F[1]+le[1]*y,W[j+8]=F[2]+le[2]*y,W[j+9]=F[0],W[j+9+1]=F[1],W[j+9+2]=F[2],W[j+9+3]=W[ge+12],W[j+9+4]=W[ge+13],W[j+9+5]=W[ge+14],W[j+9+6]=F[0]+le[0]*y,W[j+9+7]=F[1]+le[1]*y,W[j+9+8]=F[2]+le[2]*y):(W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=W[ge],W[j+4]=W[ge+1],W[j+5]=W[ge+2],W[j+6]=W[pe+15],W[j+7]=W[pe+16],W[j+8]=W[pe+17],W[j+9]=F[0],W[j+9+1]=F[1],W[j+9+2]=F[2],W[j+9+3]=W[ge+3],W[j+9+4]=W[ge+4],W[j+9+5]=W[ge+5],W[j+9+6]=W[pe+12],W[j+9+7]=W[pe+13],W[j+9+8]=W[pe+14]),j+=18);else for(var ye=M!=B-1?M:M-1,Le=0;Le<$;Le++)d&&(P=X+ye,Z[V]=P,Z[V+1]=P,Z[V+2]=P,V+=3),he=W[ye*J+3],W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=0,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=he,K[T+4]=D[Le][0]*y,K[T+5]=D[Le][1]*y,K[T+6]=R[Le]+0,K[T+7]=0,W[j+8]=F[0],W[j+9]=F[1],W[j+10]=F[2],W[j+11]=he,K[T+8]=D[Le+1][0]*y,K[T+9]=D[Le+1][1]*y,K[T+10]=R[Le+1]+0,K[T+11]=0,j+=12,T+=12}l&&(z=[F[0],F[1],F[2]+.1*U],ce[M]=z,fe[B-M-1]=z),M+1<B&&(F=ue[M+1])}X+=ue.length}H>0&&(Q[0]/=H,Q[1]/=H,Q[2]/=H),Q[0]+=Ie.groupOrigin[0],Q[1]+=Ie.groupOrigin[1],Q[2]+=Ie.groupOrigin[2];var Ae,me=u||c||h||v;if(o){var Ne={color:p,"z-index":a,center:Q,advancedHit:d,totalPoints:H,"hover-event":u,"click-event":c,"draw-event":f,"width-units":L,hitable:me,state:Ie.hitState,eventInfo:Ie.alwaysEventInfo||me||f?s:{},"enter-event":h,"leave-event":v,"zbuffer-offset":b,"line-width":2*y,lod:Ie.autoLod?null:Ie.tileLod};Ae=g?w?8:x?7:6:w?10:9,w&&null!=m&&(Ne.texture=[Ie.stylesheetBitmaps[m[0]],m[1],m[2]],Ne.background=N);var Ue=JSON.stringify({type:"T"+Ae,color:p,zIndex:a,zOffset:b,state:Ie.hitState}),we=K?[W,K]:[W];d&&we.push(Z),De(5,Ae,Ne,we,Ue)}if(l)for(M=0,B=ee.length;M<B;M++)Ye(ee[M].points,ee[M].points2,e,Q,r,t,n,a,s)}}}},Ye=function(e,r,t,n,a,s,i,o,l){var u=Fe(s,"line-label-type",t,a),c=Fe(s,"line-label-color",t,a),f=Fe(s,"line-label-color2",t,a),h=Fe(s,"line-label-outline",t,a),v=Fe(s,"line-label-source",t,a),d=Fe(s,"line-label-size",t,a),b=Fe(s,"line-label-spacing",t,a),g=(Fe(s,"line-label-line-height",t,a),Fe(s,"line-label-offset",t,a)),p=Fe(s,"dynamic-reduce",t,a),y=Fe(s,"line-label-no-overlap",t,a),L=Fe(s,"line-label-no-overlap-factor",t,a),A=Fe(s,"line-label-no-overlap-margin",t,a);if(!(Math.abs(d)<1e-4)){var m=ze(s,v,t,a,v);m=m?m.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var N=Fe(s,"line-label-font",t,a),U=Ge(N),w=Xe(N),x=Re(m,U);if("$name"==v&&!Te(m,U,x)){var S=ze(s,"$name:en",t,a,v);S=S?S.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var M=Re(m,U);Te(S,U,M)&&(m=S,x=M)}if(m&&""!=m){var B,O,_,k,I,E=Fe(s,"hover-event",t,a),C=Fe(s,"click-event",t,a),F=Fe(s,"draw-event",t,a),z=Fe(s,"enter-event",t,a),P=Fe(s,"leave-event",t,a),j=Fe(s,"advanced-hit",t,a),T=Fe(s,"zbuffer-offset",t,a);Ie.useLineLabel2="flat"!=u,Ie.useLineLabel2?(B=12*m.length,k=new Float32Array(B),I=new Float32Array(B)):(B=Ve()*m.length*2,O=new Float32Array(B),_=new Float32Array(B));var V={},G=E||C||z||P,X=d;Ie.lineLabelPass=0,Ie.lineLabelPoints=[];var D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints;Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,Ie.useLineLabel2?0:D,null,x,I);var $=Ie.lineLabelPoints;if(!D){if(Ie.useLineLabel2)for(;;){d*=.5,Ie.lineLabelPass=0,Ie.lineLabelPoints=[];D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints;Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,Ie.useLineLabel2?0:D,null,x,I);$=Ie.lineLabelPoints;if(D||d<.05)break}if(!D)return}var q,Y,H,J=Fe(s,"visibility-rel",t,a)||Fe(s,"visibility-abs",t,a)||Fe(s,"visibility",t,a),W=Fe(s,"culling",t,a),Z=Fe(s,"hysteresis",t,a),K=Ie.bboxMin,Q=[],ee=0;if(Ie.useLineLabel2){for(Y=0,H=R.length;Y<H;Y++)(q=R[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2],(q=$[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2];for(Q.push([d,Ie.textVector,R,$]),Ie.lineLabelPass=1;d*=2,Ie.lineLabelPoints=[],D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints,D;){for(Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,Ie.useLineLabel2?0:D,null,x,I),$=Ie.lineLabelPoints,Y=0,H=R.length;Y<H;Y++)(q=R[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2],(q=$[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2];Q.push([d,Ie.textVector,R,$])}for(d=X;d*=.5,Ie.lineLabelPoints=[],D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints,!(Ie.textLength<2);){for(Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,0,null,x,I),$=Ie.lineLabelPoints,Y=0,H=R.length;Y<H;Y++)(q=R[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2],(q=$[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2];Q.unshift([d,Ie.textVector,R,$]),ee++}(n=Ie.textCenter)[0]+=K[0],n[1]+=K[1],n[2]+=K[2]}var re=new Array(U.length);for(Y=0,H=U.length;Y<H;Y++)re[Y]=[];for(var te in V){var ne=parseInt(te),ae=V[te],se=[];for(var ie in ae){var oe=parseInt(ie)-4e3*ne,le=Math.round((oe-oe%4)/4);-1==se.indexOf(le)&&se.push(le)}re[ne]=se}var ue=JSON.stringify({type:"line-label",color:c,color2:f,outline:h,fonts:N,zIndex:o,zOffset:T});if(y){var ce=null,fe=null;if(null!==L){switch(L[0]){case"direct":ce=0;break;case"div-by-dist":ce=1}fe=L[1]}var he=[A,ce,fe]}De(5,Ie.useLineLabel2?12:11,{color:c,color2:f,outline:h,textVector:Ie.textVector,labelPoints:Ie.useLineLabel2?Q:[],visibility:J,culling:W,hysteresis:Z,"z-index":o,center:n,"hover-event":E,"click-event":C,"draw-event":F,reduce:p,noOverlap:y?he:null,files:re,"enter-event":z,"leave-event":P,"zbuffer-offset":T,advancedHit:j,labelIndex:ee,labelSize:X,fonts:w,hitable:G,state:Ie.hitState,eventInfo:Ie.alwaysEventInfo||G||F?l:{},lod:Ie.autoLod?null:Ie.tileLod},Ie.useLineLabel2?[k,I]:[O,_],ue)}}},He=n,Je=s,We=q,Ze=ce,Ke=qe,Qe=Be,er=function(e,r,t,n,a,s,i,o){var l=e.borders||[];if(0!=l.length){for(var u,c,f=We(n,"polygon-extrude",e,t),h=function(e){var r={};for(var t in e)"surface"!=t&&"vertices"!=t&&"borders"!=t&&(r[t]=e[t]);return r}(e),v=l.length,d=[],b=[],g=[0,0,0],p=He.tileX,y=He.tileY,L=He.forceOrigin,A=He.forceScale,m=[1/A[0],1/A[1],1/A[2]],N=He.geocent,U=He.bboxMin,w=0;w<v;w++){var x,S=l[w],M=S.length,B=0;if(M>0){var O,_,k;for(o?(O=new Array(M+1),_=new Array(M+1)):(O=new Array(M),_=new Array(M)),k=0;k<M;k++)S[k]>=0?(x=3*S[k],B++):x=3*-S[k],f?(c=(u=[r[x],r[x+1],r[x+2]]).slice(),L&&(c=[c[0]-p,c[1]-y,c[2]]),null!=A&&(c=[c[0]*A[0],c[1]*A[1],c[2]*A[2]]),N?(Je([c[0]+U[0],c[1]+U[1],c[2]+U[2]],g),c=[u[0]+g[0]*f*m[0],u[1]+g[1]*f*m[1],u[2]+g[2]*f*m[2]]):c[2]+=f,O[k]=u,_[k]=c,S[k]>=0&&d.push([u,c])):O[k]=[r[x],r[x+1],r[x+2]],o&&0==k&&(O[M]=O[0],_[M]=_[0]);var I=new Array(B),E=new Array(B),C=0;for(k=0;k<M;k++)S[k]>=0&&(I[C]=O[k].slice(),f&&(E[C]=_[k].slice()),C++);d.push(O),b=b.concat(I),f&&(d.push(_),b=b.concat(E))}}o&&d.length>0?(h.lines=d,Ke(h,t,n,a,s,i)):b.length>0&&(h.points=b,Qe(h,t,n,a,s,i))}},rr=n,tr=function(e){var r=S.parse(e.data);N.fontsStorage[e.url]=r},nr=function(e,r){if(l&&!r)return l.decode(e);var t,n,a,s,i,o;for(t="",a=(e=new Uint8Array(e)).length,n=0;n<a;)switch((s=e[n++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(s);break;case 12:case 13:i=e[n++],t+=String.fromCharCode((31&s)<<6|63&i);break;case 14:i=e[n++],o=e[n++],t+=String.fromCharCode((15&s)<<12|(63&i)<<6|(63&o)<<0)}return t},ar=function(e){var r=e.map;for(var t in r)N.fonts[t]=N.fontsStorage[r[t]];N.fontsMap=r},sr=function e(r){if(!r||!Array.isArray(r))return r;var t,n,a=[r[0]];switch(r[0]){case"all":case"any":case"none":case"skip":for(t=1,n=r.length;t<n;t++)a[t]=e(r[t]);return a}switch(a[1]=r[1],a[2]=re(r[1]),r[0]){case"==":case"!=":case">=":case"<=":case">":case"<":a[3]=r[2],a[4]=re(r[2]);break;case"in":case"!in":for(t=2,n=r.length;t<n;t++)a[t+1]=r[t]}return a},ir=function(e,r,t){var n=j.stylesheetData.layers[e];return null==n?(W("wrong-Layer",e,null,null,t,r),{}):n},or=q,lr=function(e){var r;j.stylesheetBitmaps={},j.stylesheetFonts={},j.stylesheetConstants=e.constants||{},j.stylesheetVariables=e.variables||{},j.stylesheetLocals={};var t=e.bitmaps||{};for(r in t){var n=t[r];"string"==typeof n?n={url:n,hash:G(n)}:"object"==typeof n?null==n.url?(n.hash="null",W("wrong-bitmap",r)):n.hash=G(n.url):W("wrong-bitmap",r),j.stylesheetBitmaps[r]=n}for(r in postMessage({command:"loadBitmaps",bitmaps:j.stylesheetBitmaps}),t=j.stylesheetBitmaps)(n=t[r]).url=null;var a=e.fonts||{};for(r in a){var s=a[r];"string"==typeof s?s={url:s}:"object"==typeof s?null==s.url&&W("wrong-font",r):W("wrong-font",r),j.stylesheetFonts[r]=s}postMessage({command:"loadFonts",fonts:j.stylesheetFonts}),j.stylesheetData={layers:{}};var i=e.layers||{};for(r in j.stylesheetLayers=j.stylesheetData.layers,i)j.stylesheetData.layers[r]=te(r,i[r],e)},ur=ee,cr=qe,fr=Be,hr=function(e,r,t,n,a,s){var i,o,l=[];if(Me(e),(l=e.lines?e.lines:[e.points])&&0!=l.length){var u,c,f,h=be(t,"visibility-rel",e,r)||be(t,"visibility-abs",e,r)||be(t,"visibility",e,r),v=be(t,"culling",e,r),d=be(t,"hysteresis",e,r),b=0;for(c=0,f=l.length;c<f;c++)u=l[c],Array.isArray(u)&&u.length>0&&(b+=u.length);var g,p,y=[0,0,0],L=ve.forceOrigin,A=ve.bboxMin,m=ve.tileX,N=ve.tileY,U=ve.forceScale;for(c=0,f=l.length;c<f;c++)if(u=l[c],Array.isArray(u)&&u.length>0)for(i=0,o=u.length;i<o;i++)p=[(g=u[i])[0],g[1],g[2]],L&&(p=[p[0]-m,p[1]-N,p[2]]),null!=U&&(p=[p[0]*U[0],p[1]*U[1],p[2]*U[2]]),y[0]+=p[0],y[1]+=p[1],y[2]+=p[2];b>0&&(y[0]/=b,y[1]/=b,y[2]/=b),y[0]+=A[0],y[1]+=A[1],y[2]+=A[2],ve.signatureCounter++;var w=""+ve.signatureCounter;Se(5,20,{"z-index":a,hysteresis:d,visibility:h,culling:v,center:y,eventInfo:{},index:n,lod:ve.autoLod?null:ve.tileLod},[],w)}},vr=function(e,r,t,n,a,s){var i=e.vertices||[];if(0!=i.length&&((We(t,"point",e,r)||We(t,"label",e,r))&&er(e,i,r,t,n,a,s,!1),(We(t,"line",e,r)||We(t,"line-label",e,r))&&er(e,i,r,t,n,a,s,!0),We(t,"polygon",e,r))){var o=e.surface||[];if(0!=o.length){var l=We(t,"hover-event",e,r),u=We(t,"click-event",e,r),c=We(t,"draw-event",e,r),f=We(t,"enter-event",e,r),h=We(t,"leave-event",e,r),v=We(t,"advanced-hit",e,r),d=We(t,"zbuffer-offset",e,r),b=We(t,"polygon-color",e,r),g=We(t,"polygon-style",e,r),p=We(t,"polygon-use-stencil",e,r),y=We(t,"polygon-culling",e,r),L=We(t,"polygon-extrude",e,r);g="flatshade"==g?1:0,y="back"==y?1:0;for(var A,m,N,U,w=He.geocent,x=[0,0,0],S=[0,0,0],M=He.bboxMin,B=3*(o.length/3),O=new Float32Array(3*B),_=0,k=0,I=[0,0,0],E=[0,0,0],C=[0,0,0],F=[0,0,0],z=He.tileX,P=He.tileY,j=He.forceOrigin,T=He.forceScale,V=0;V<B;V++)I=[i[A=3*o[_++]],i[A+1],i[A+2]],j&&(I=[I[0]-z,I[1]-P,I[2]]),null!=T&&(I=[I[0]*T[0],I[1]*T[1],I[2]*T[2]]),L&&(w?(Je([I[0]+M[0],I[1]+M[1],I[2]+M[2]],S),I[0]+=S[0]*L,I[1]+=S[1]*L,I[2]+=S[2]*L):I[2]+=L),x[0]+=I[0],x[1]+=I[1],x[2]+=I[2],O[k++]=I[0],O[k++]=I[1],O[k++]=I[2];if(B>0){var G=1/B;x[0]*=G,x[1]*=G,x[2]*=G}x[0]+=He.groupOrigin[0],x[1]+=He.groupOrigin[1],x[2]+=He.groupOrigin[2];var X=e.borders||[];if(X.length>0){var D=0;for(V=0,m=X.length;V<m;V++){D+=2*(($=X[V]).length+1)}var R=O;for((O=new Float32Array(O.length+3*D*3)).set(R),V=0,m=X.length;V<m;V++){var $,q;for(N=0,U=($=X[V]).length;N<U;N++)q=$[N]>=0?3*$[N]:3*-$[N],I[0]=i[q],I[1]=i[q+1],I[2]=i[q+2],C[0]=i[q],C[1]=i[q+1],C[2]=i[q+2],q=N<U-1?$[N+1]>=0?3*$[N+1]:3*-$[N+1]:$[0]>=0?3*$[0]:3*-$[0],E[0]=i[q],E[1]=i[q+1],E[2]=i[q+2],F[0]=i[q],F[1]=i[q+1],F[2]=i[q+2],j&&(I=[I[0]-z,I[1]-P,I[2]],E=[E[0]-z,E[1]-P,E[2]],C=[C[0]-z,C[1]-P,C[2]],F=[F[0]-z,F[1]-P,F[2]]),null!=T&&(I=[I[0]*T[0],I[1]*T[1],I[2]*T[2]],E=[E[0]*T[0],E[1]*T[1],E[2]*T[2]],C=[C[0]*T[0],C[1]*T[1],C[2]*T[2]],F=[F[0]*T[0],F[1]*T[1],F[2]*T[2]]),L&&(w?(Je([I[0]+M[0],I[1]+M[1],I[2]+M[2]],S),I=[I[0]+S[0]*L,I[1]+S[1]*L,I[2]+S[2]*L],Je([E[0]+M[0],E[1]+M[1],E[2]+M[2]],S),E=[E[0]+S[0]*L,E[1]+S[1]*L,E[2]+S[2]*L]):(I[2]+=L,E[2]+=L)),O[k]=F[0],O[k+1]=F[1],O[k+2]=F[2],O[k+3]=E[0],O[k+4]=E[1],O[k+5]=E[2],O[k+6]=I[0],O[k+7]=I[1],O[k+8]=I[2],O[k+9]=I[0],O[k+10]=I[1],O[k+11]=I[2],O[k+12]=C[0],O[k+13]=C[1],O[k+14]=C[2],O[k+15]=F[0],O[k+16]=F[1],O[k+17]=F[2],k+=18}}var Y=l||u||f||h,H=JSON.stringify({style:g,culling:y,stencil:p,color:b,zIndex:a,zOffset:d,state:He.hitState});Ze(5,13,{color:b,"z-index":a,center:x,advancedHit:v,culling:y,"hover-event":l,"click-event":u,"draw-event":c,style:g,stencil:p,hitable:Y,state:He.hitState,eventInfo:He.alwaysEventInfo||Y||c?s:{},"enter-event":f,"leave-event":h,"zbuffer-offset":d,lod:He.autoLod?null:He.tileLod},[O],H)}}},dr=function(e){$e(e);var r=e.lines;if(!r&&0!=r.length){var t=0,n=new Uint32Array(r.length);for(c=0;c<r.length;c++)n[c]=t,Array.isArray(r[c])&&(t+=r[c].length);for(var a,s,i,o=new Float64Array(3*t),l=Ie.forceScale,u=0,c=0;c<r.length;c++)if(Array.isArray(r[c])&&r[c].length){var f=r[c];a=[(i=f[0])[0],i[1],i[2]];for(var h=0,v=f.length;h<v&&(null!=l&&(s=[a[0]*l[0],a[1]*l[1],a[2]*l[2]]),o[u]=s[0],o[u+1]=s[1],o[u+2]=s[2],u+=3,h!=v-1);h++)a=f[h+1]}Ie.signatureCounter++,De(5,14,{id:e.id},[o,n],""+Ie.signatureCounter)}},br=function(e){if(Me(e),e.lines?pointsGroups=e.lines:pointsGroups=[e.points],pointsGroups&&0!=pointsGroups.length){var r=0,t=new Uint32Array(pointsGroups.length);for(u=0;u<pointsGroups.length;u++)t[u]=r,Array.isArray(pointsGroups[u])&&(r+=pointsGroups[u].length);for(var n,a,s,i=new Float64Array(3*r),o=ve.forceScale,l=0,u=0;u<pointsGroups.length;u++)if(Array.isArray(pointsGroups[u])&&pointsGroups[u].length){var c=pointsGroups[u];n=[(s=c[0])[0],s[1],s[2]];for(var f=0,h=c.length;f<h&&(null!=o&&(a=[n[0]*o[0],n[1]*o[1],n[2]*o[2]]),i[l]=a[0],i[l+1]=a[1],i[l+2]=a[2],l+=3,f!=h-1);f++)n=c[f+1]}ve.signatureCounter++,Se(5,5,{id:e.id},[i,t],""+ve.signatureCounter)}},gr=function(e,r,t){var n=0,a=new ArrayBuffer(6),s=new DataView(a);n=0,s.setUint8(n,e),n+=1,s.setUint8(n,r),n+=1,s.setUint32(n,t||0),fe(e,r,a,n+=4,"")},pr=function(){for(var e,r,t,n,a,s,i,o,l=ne.messageBuffer,u=0,c=ne.messageBufferIndex;u<c;u++){(A=l[u]).job;var f=A.type,h=A.signature;if(!A.hitable&&!A.reduced&&f>=6&&f<=13)switch(f){case 13:case 6:for(o=0,i=4*new DataView(A.job).getUint32(A.buffersIndex),he(0,new Uint8Array(A.job,A.buffersIndex+4,i),0),a=i,e=u+1;e<c;e++)(n=l[e]).signature==h&&(n.reduced=!0,o++,i=4*new DataView(n.job).getUint32(n.buffersIndex),he(0,new Uint8Array(n.job,n.buffersIndex+4,i),a),a+=i);o>0&&(y=new Uint8Array(A.buffersIndex+2*(4+a)),s=new DataView(y.buffer),y.set(new Uint8Array(A.job,0,A.buffersIndex),0),s.setUint32(A.buffersIndex,a/4),y.set(new Uint8Array(se.buffer,0,a),A.buffersIndex+4),ne.messagePackSize-=A.job.byteLength,ne.messagePackSize+=y.byteLength,A.job=y.buffer);break;case 9:case 11:case 7:for(o=0,0,i=new DataView(A.job).getUint32(A.buffersIndex),i*=4,he(0,new Uint8Array(A.job,A.buffersIndex+4,i),0),he(1,new Uint8Array(A.job,A.buffersIndex+4+i+4,i),0),a=i,e=u+1;e<c;e++)if((n=l[e]).signature==h&&(n.reduced=!0,ne.messagePackSize-=n.job.byteLength,o++,i=new DataView(n.job).getUint32(n.buffersIndex),i*=4,he(0,new Uint8Array(n.job,n.buffersIndex+4,i),a),he(1,new Uint8Array(n.job,n.buffersIndex+4+i+4,i),a),a+=i,11==f)){var v=A.job2.files,d=n.job2.files;for(t=0,r=d.length;t<r;t++){v[t]||(v[t]=[]);for(var b=0,g=d[t].length;b<g;b++)-1==v[t].indexOf(d[t][b])&&v[t].push(d[t][b])}}if(o>0){if(11==f){var p=ae(JSON.stringify(A.job2));y=new Uint8Array(6+p.byteLength+2*(4+a)),L=0,(s=new DataView(y.buffer)).setUint8(L,A.command),L+=1,s.setUint8(L,f),L+=1,s.setUint32(L,p.byteLength),L+=4,y.set(p,L),L+=p.byteLength,A.buffersIndex=L}else y=new Uint8Array(A.buffersIndex+2*(4+a)),s=new DataView(y.buffer),y.set(new Uint8Array(A.job,0,A.buffersIndex),0);s.setUint32(A.buffersIndex,a/4),y.set(new Uint8Array(se.buffer,0,a),A.buffersIndex+4),s.setUint32(A.buffersIndex+4+a,a/4),y.set(new Uint8Array(ie.buffer,0,a),A.buffersIndex+4+a+4),ne.messagePackSize-=A.job.byteLength,ne.messagePackSize+=y.byteLength,A.job=y.buffer}}}var y=new Uint8Array(ne.messagePackSize),L=0;for(u=0,c=ne.messageBufferIndex;u<c;u++){var A;(A=ne.messageBuffer[u]).reduced||(y.set(new Uint8Array(A.job),L),L+=ne.messageBuffer[u].job.byteLength)}ue({command:"addPackedCommands",buffer:y},[y.buffer]),ne.messageBufferIndex=0,ne.messagePackSize=0},yr=ce,Lr=ue,Ar=function(){oe.length>0&&(le.length>0?postMessage({command:"packed-events",messages:oe},le):postMessage({command:"packed-events",messages:oe}),oe=[],le=[])},mr=H,Nr=[],Ur=new Array(1024),wr=0,xr=new Array(1024),Sr=0,Mr=0;function Br(e,r,t,n,a,s,i){switch(rr.stylesheetLocals={},e){case"line-string":(or(n,"point",r,t)||or(n,"label",r,t))&&fr(r,t,n,a,s,i),cr(r,t,n,a,s,i);break;case"point-array":fr(r,t,n,a,s,i);break;case"polygon":vr(r,t,n,a,s,i)}}function Or(e,r,t,n,a){var s=rr.reduceParams;for(var i in rr.stylesheetLayers){var o=rr.stylesheetLayers[i];if("point-array"==e){var l=o["importance-source"];if(null==l&&r[0]&&r[0].importance&&(l="$importance"),null!=l)switch(rr.reduceMode){case"scr-count1":case"scr-count2":o.reduce=["top",100,l],o["dynamic-reduce"]=["scr-count2",s[0],s[1]];break;case"scr-count4":o["dynamic-reduce"]=["scr-count4",l];break;case"scr-count5":o["dynamic-reduce"]=["scr-count5",l];break;case"scr-count6":case"scr-count7":case"scr-count8":var u="scr-count8"==rr.reduceMode?s[6]:s[5];o["dynamic-reduce"]=[rr.reduceMode,l,void 0!==o["importance-weight"]?o["importance-weight"]:1],o["label-no-overlap-margin"]=[s[0]*u,s[0]*u],o["icon-no-overlap-margin"]=[s[0]*u,s[0]*u],o["label-no-overlap-factor"]=["div-by-dist",l]}}var c,f,h=o.filter,v=o.reduce;for(h&&((h=o["#filter"])||(o["#filter"]=sr(o.filter),h=o["#filter"])),wr=0,Sr=0,Mr=0,c=0,f=r.length;c<f;c++){var d=r[c];d.properties=d.properties||{},d.id&&(d.properties["#id"]=d.id),h&&!ur(h,d,n,a,o,"filter",t,0,!0)||(v?(Ur[wr]=d,wr++):kr(e,d,t,o,c))}if(v){var b=v[1],g=v[2];switch(v[0]){case"top":case"bottom":if("string"==typeof g&&"@"==g.charAt(0)&&void 0===(g=rr.stylesheetConstants[g]))break;if("string"==typeof g&&"$"==g.charAt(0)||"object"==typeof g){var p="object"==typeof g;p||(g=g.substr(1)),b>wr&&(b=wr);var y,L="top"==v[0],A=0,m=L?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;do{var N=L?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;for(Mr=Sr,c=0,f=wr;c<f;c++)d=Ur[c],A?y=d.tmp:(y=p?mr(o,null,d,t,g,0):parseFloat(d.properties[g]),d.tmp=y),!isNaN(y)&&(L&&y>=N&&y<m||y<=N&&y>m)&&(N!=y&&(Sr=Mr),xr[Sr]=d,Sr++,N=y);m=N,A++}while(A<b)}break;case"odd":case"even":for(c="odd"==v[0]?1:0,f=wr;c<f;c+=2)d=Ur[c],xr[Sr]=d,Sr++;case"every":for(b>wr&&(b=wr),c=0,f=wr;c<f;c+=b)d=Ur[c],xr[Sr]=d,Sr++}for(c=0,f=Sr;c<f;c++)d=xr[c],kr(e,xr[c],t,o,c)}}}function _r(e,r,t,n,a,s){var i,o=or(n,"next-pass",r,t);if(null!=o)for(var l=0,u=o.length;l<u;l++){var c=o[l][0];if(i=ir(o[l][1],e,a),or(i,"visible",r,t)){var f=or(i,"selected-layer",r,t),h=""!=f?ir(f,e,a):null,v=or(i,"selected-hover-layer",r,t),d=""!=v?ir(v,e,a):null,b=or(i,"hover-layer",r,t),g=""!=b?ir(b,e,a):null,p=(null!=g?256:0)|(null!=h?512:0)|(null!=d?1024:0),y=rr.hitState;null!=h&&(rr.hitState=2|p,Br(e,r,t,h,a,c,s)),null!=d&&(rr.hitState=3|p,Br(e,r,t,d,a,c,s)),null!=g&&(rr.hitState=1|p,Br(e,r,t,g,a,c,s)),Br(e,r,t,i,a,c,s),rr.hitState=y}}}function kr(e,r,t,n,a,s){if(or(n,"visible",r,t))if("point-array"==e&&n["visibility-switch"]){gr(5,17);var i=or(n,"z-index",r,t),o=r.properties;hr(r,t,n,a,i,o);for(var l=n["visibility-switch"],u=0,c=l.length;u<c;u++){if(l[u][1])kr(e,r,t,ir(l[u][1],e,a),a);gr(5,18,l[u][0])}gr(5,19)}else if(s||1!=n.pack||(rr.directPoints=[],gr(5,15),kr(e,r,t,n,a,!0),gr(5,16),!rr.directPoints)){i=or(n,"z-index",r,t);if(or(n,"export-geometry",r,t)&&void 0!==r.id&&!Nr[r]){switch(e){case"line-string":dr(r);break;case"point-array":br(r)}Nr[r]=!0}o=r.properties;var f=or(n,"selected-layer",r,t),h=""!=f?ir(f,e,a):null,v=or(n,"selected-hover-layer",r,t),d=""!=v?ir(v,e,a):null,b=or(n,"hover-layer",r,t),g=""!=b?ir(b,e,a):null,p=(null!=g?256:0)|(null!=h?512:0)|(null!=d?1024:0);null!=h&&(rr.hitState=2|p,Br(e,r,t,h,a,i,o),_r(e,r,t,h,a,o)),null!=d&&(rr.hitState=3|p,Br(e,r,t,d,a,i,o),_r(e,r,t,d,a,o)),null!=g&&(rr.hitState=1|p,Br(e,r,t,g,a,i,o),_r(e,r,t,g,a,o)),rr.hitState=0|p,Br(e,r,t,n,a,i,o),_r(e,r,t,n,a,o)}}function Ir(e,r){var t=e.id||"";rr.groupId=t;var n=e.bbox;if(n){var a=n[0],s=n[1];rr.bboxMin=a,rr.bboxMax=s;var i=[n[1][0]-n[0][0],n[1][1]-n[0][1],n[1][2]-n[0][2]],o=e.resolution||4096;rr.groupOrigin=[0,0,0],rr.forceScale=[i[0]/o,i[1]/o,i[2]/o],yr(9,0,{id:e.id,bbox:[a,s],origin:a},[],"");var l=e.points||[];rr.featureType="point",Or("point-array",l,r,"point",t);var u=e.lines||[];rr.featureType="line",Or("line-string",u,r,"line",t);var c=e.polygons||[];rr.featureType="polygon",Or("polygon",c,r,"polygon",t),gr(10,0),rr.groupOptimize&&pr()}}function Er(e,r){var t,n;yr(5,21,{volume:e.volume,precision:e.precision,tileset:e.tileset},[],"");var a=e.meshes||[];for(t=0,n=a.length;t<n;t++){var s=a[t];yr(5,23,{path:a[t]},[],s)}var i=e.nodes||[];for(t=0,n=i.length;t<n;t++)Er(i[t],r);yr(5,22,{},[],"")}self.onmessage=function(e){var r=e.data,t=r.command,n=r.data,a=null,s=!1;switch(t){case"config":rr.config=n;break;case"setStylesheet":n&&(rr.geocent=n.geocent,rr.metricUnits=n.metric,rr.reduceMode=n.reduceMode,rr.reduceParams=n.reduceParams,rr.log=n.log,rr.language=n.language,lr(n.data));break;case"setFont":tr(n);break;case"setFontMap":ar(n),postMessage({command:"styleDone"}),postMessage({command:"ready"});break;case"processGeodataRaw":if(a=n,n.length>2){var i=new DataView(n),o="";o+=String.fromCharCode(i.getUint8(0,!0)),"GE"!=(o+=String.fromCharCode(i.getUint8(1,!0)))&&(s=!0)}n=nr(n);case"processGeodata":rr.tileLod=r.lod||0,rr.tileIX=r.ix||0,rr.tileIY=r.iy||0,rr.tileSize=r.tileSize||1,rr.pixelSize=r.pixelSize||1,rr.pixelFactor=r.dpr||1,rr.invPixelFactor=1/rr.pixelFactor,rr.pixelsPerMM=rr.pixelFactor/96/2.54,rr.invPixelsPerMM=1/rr.pixelsPerMM,Nr=[],s?processGeodata2(i,rr.tileLod):function(e,r){if("string"==typeof e)try{var t=JSON.parse(e)}catch(e){t=null}else t=e;if(t){for(var n=t.groups||[],a=0,s=n.length;a<s;a++)Ir(n[a],r);var i=t.nodes||[];for(a=0,s=i.length;a<s;a++)yr(9,0,{},[],""),Er(i[a],r),gr(10,0)}}(n=JSON.parse(n),rr.tileLod),gr(7,0),rr.groupOptimize&&pr(),a?Lr({command:"ready",geodata:a},[a]):Lr({command:"ready"}),rr.config.mapPackLoaderEvents&&Ar()}}}]);\n//# sourceMappingURL=613b72349d2ca54e7f86.worker.js.map',null)}},function(e,t,r){e.exports=function(){return r(10)('/*!\n * Copyright (c) 2020 Melown Technologies SE\n *  *  For terms of use, see accompanying main file.\n *  *  For 3rd party libraries licenses, see 3rdpartylicenses.txt.\n * \n */!function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);var r={},a=r;function i(e,t){var n={valid:!0};return function(e,t,n){var r=n.data;t.flags=r.getUint8(n.index,!0),n.index+=1,e.version>1?(t.surfaceReference=r.getUint8(n.index,!0),n.index+=1):t.surfaceReference=0;t.textureLayer=r.getUint16(n.index,!0),n.index+=2,t.textureLayer2=t.textureLayer;var a=[],i=[];a[0]=r.getFloat64(n.index,!0),n.index+=8,a[1]=r.getFloat64(n.index,!0),n.index+=8,a[2]=r.getFloat64(n.index,!0),n.index+=8,i[0]=r.getFloat64(n.index,!0),n.index+=8,i[1]=r.getFloat64(n.index,!0),n.index+=8,i[2]=r.getFloat64(n.index,!0),n.index+=8,t.bboxMin=a,t.bboxMax=i}(e,n,t),e.version>=3?function(e,t,n){var r,i,u,c=n.data,f=n.index,l=n.uint8Data,h=a.config.map16bitMeshes,d=a.config.mapOnlyOneUVs&&1&t.flags,p=c.getUint16(f,!0);f+=2;var g=c.getUint16(f,!0);f+=2,p||(t.valid=!1);var v,m,b,y,x=t.bboxMin,M=t.bboxMax,w=[.5*(x[0]+M[0]),.5*(x[1]+M[1]),.5*(x[2]+M[2])],U=Math.abs(Math.max(M[0]-x[0],M[1]-x[1],M[2]-x[2])),S=1/g,A=null,z=h?new Uint16Array(3*p):new Float32Array(3*p),O=0,T=0,k=0,N=w[0],C=w[1],V=w[2],F=x[0],L=x[1],R=x[2],P=1/(M[0]-x[0]),q=1/(M[1]-x[1]),H=1/(M[2]-x[2]),j=[0,f];if(h)for(m=0;m<p;m++)s(l,j),O+=j[0],s(l,j),T+=j[0],s(l,j),k+=j[0],(y=(O*S*U+N-F)*P)<0&&(y=0),y>1&&(y=1),z[v=3*m]=65535*y,(y=(T*S*U+C-L)*q)<0&&(y=0),y>1&&(y=1),z[v+1]=65535*y,(y=(k*S*U+V-R)*H)<0&&(y=0),y>1&&(y=1),z[v+2]=65535*y;else for(m=0;m<p;m++)s(l,j),O+=j[0],s(l,j),T+=j[0],s(l,j),k+=j[0],z[v=3*m]=(O*S*U+N-F)*P,z[v+1]=(T*S*U+C-L)*q,z[v+2]=(k*S*U+V-R)*H;if(f=j[1],2&t.flags)if(g=c.getUint16(f,!0),f+=2,j[1]=f,d)for(m=0;m<p;m++)s(l,j),s(l,j);else if(S=h?65535/g:1/g,A=h?new Uint16Array(2*p):new Float32Array(2*p),O=0,T=0,h)for(m=0;m<p;m++){s(l,j),O+=j[0],s(l,j),T+=j[0],(y=O*S)<0&&(y=0),y>65535&&(y=65535),A[I=2*m]=y,(y=T*S)<0&&(y=0),y>65535&&(y=65535),A[I+1]=65535-y}else for(m=0;m<p;m++){var I;s(l,j),O+=j[0],s(l,j),T+=j[0],A[I=2*m]=O*S,A[I+1]=1-T*S}if(f=j[1],r=z,i=A,1&t.flags){var B=c.getUint16(f,!0);f+=2;var E=c.getUint16(f,!0);f+=2;var J=c.getUint16(f,!0);f+=2;var D=h?65536/E:1/E,G=h?65536/J:1/J;O=0,T=0;var Y=h?new Uint16Array(2*B):new Float32Array(2*B);if(j[1]=f,h)for(m=0,b=2*B;m<b;m+=2)s(l,j),O+=j[0],s(l,j),T+=j[0],(y=O*D)<0&&(y=0),y>65535&&(y=65535),Y[m]=y,(y=T*G)<0&&(y=0),y>65535&&(y=65535),Y[m+1]=65535-y;else for(m=0,b=2*B;m<b;m+=2)s(l,j),O+=j[0],s(l,j),T+=j[0],Y[m]=O*D,Y[m+1]=1-T*G;f=j[1],u=Y}var X=c.getUint16(f,!0);f+=2;var _=null;Y=null,A=null;var Z=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&!(1&t.flags),$=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&1&t.flags,W=Z||$;W?_=new Uint16Array(3*X):(z=h?new Uint16Array(3*X*3):new Float32Array(3*X*3),1&t.flags&&(Y=h?new Uint16Array(3*X*2):new Float32Array(3*X*2)),!d&&2&t.flags&&(A=h?new Uint16Array(3*X*2):new Float32Array(3*X*2)));var K,Q,ee,te,ne,re,ae=r,ie=i,oe=u,se=0;for(j[1]=f,m=0;m<X;m++)if(o(l,j),K=se-j[0],j[0]||se++,o(l,j),Q=se-j[0],j[0]||se++,o(l,j),ee=se-j[0],j[0]||se++,W)_[v=3*m]=K,_[v+1]=Q,_[v+2]=ee;else{var ue=3*K;z[v=9*m]=ae[ue],z[v+1]=ae[ue+1],z[v+2]=ae[ue+2],ue=3*Q,z[v+3]=ae[ue],z[v+4]=ae[ue+1],z[v+5]=ae[ue+2],ue=3*ee,z[v+6]=ae[ue],z[v+7]=ae[ue+1],z[v+8]=ae[ue+2],null!=A&&(A[v=6*m]=ie[2*K],A[v+1]=ie[2*K+1],A[v+2]=ie[2*Q],A[v+3]=ie[2*Q+1],A[v+4]=ie[2*ee],A[v+5]=ie[2*ee+1])}Z&&(z=r,A=i);$&&(z=h?new Uint16Array(oe.length/2*3):new Float32Array(oe.length/2*3),Y=u);if(se=0,null!=Y)for(m=0;m<X;m++)o(l,j),K=se-j[0],j[0]||se++,o(l,j),Q=se-j[0],j[0]||se++,o(l,j),ee=se-j[0],j[0]||se++,$?(te=3*_[v=3*m],ne=3*_[v+1],re=3*_[v+2],z[3*K]=ae[te],z[3*K+1]=ae[te+1],z[3*K+2]=ae[te+2],z[3*Q]=ae[ne],z[3*Q+1]=ae[ne+1],z[3*Q+2]=ae[ne+2],z[3*ee]=ae[re],z[3*ee+1]=ae[re+1],z[3*ee+2]=ae[re+2],_[v]=K,_[v+1]=Q,_[v+2]=ee):(Y[v=6*m]=oe[2*K],Y[v+1]=oe[2*K+1],Y[v+2]=oe[2*Q],Y[v+3]=oe[2*Q+1],Y[v+4]=oe[2*ee],Y[v+5]=oe[2*ee+1]);f=j[1],t.vertices=z,t.internalUVs=Y,t.externalUVs=A,t.indices=_,n.index=f,t.size=t.vertices.byteLength,t.internalUVs&&(t.size+=t.internalUVs.byteLength);t.externalUVs&&(t.size+=t.externalUVs.byteLength);t.indices&&(t.size+=t.indices.byteLength);t.faces=X}(0,n,t):function(e,t,n){var r=n.data,i=n.index,o=n.uint8Data,s=a.config.map16bitMeshes,u=r.getUint16(i,!0);i+=2,u||(t.valid=!1);var c,f,l,h=null,d=null,p=a.config.mapOnlyOneUVs&&1&t.flags,g=s?new Uint16Array(3*u):new Float32Array(3*u);2&t.flags&&(d=!!p||(s?new Uint16Array(2*u):new Float32Array(2*u)));var v,m,b=s?1:1/65535,y=0,x=0;for(v=0;v<u;v++)g[y]=(o[i]+(o[i+1]<<8))*b,g[y+1]=(o[i+2]+(o[i+3]<<8))*b,g[y+2]=(o[i+4]+(o[i+5]<<8))*b,y+=3,d?(p||(d[x]=(o[i+6]+(o[i+7]<<8))*b,d[x+1]=(65535-(o[i+8]+(o[i+9]<<8)))*b,x+=2),i+=10):i+=6;if(c=g,f=d,1&t.flags){var M=r.getUint16(i,!0);for(i+=2,h=s?new Uint16Array(2*M):new Float32Array(2*M),v=0,m=2*M;v<m;v+=2)h[v]=(o[i]+(o[i+1]<<8))*b,h[v+1]=(65535-(o[i+2]+(o[i+3]<<8)))*b,i+=4;l=h}var w=r.getUint16(i,!0);i+=2;var U=null;h=null,d=null;var S=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&!(1&t.flags),A=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&1&t.flags,z=S||A;z?U=new Uint16Array(3*w):(g=s?new Uint16Array(3*w*3):new Float32Array(3*w*3),1&t.flags&&(h=s?new Uint16Array(3*w*2):new Float32Array(3*w*2)),!p&&2&t.flags&&(d=s?new Uint16Array(3*w*2):new Float32Array(3*w*2)));var O,T,k,N,C,V,F,L=c,R=f,P=l;S&&(g=c,d=f);A&&(g=s?new Uint16Array(P.length/2*3):new Float32Array(P.length/2*3),h=l);for(v=0;v<w;v++)O=o[i]+(o[i+1]<<8),T=o[i+2]+(o[i+3]<<8),k=o[i+4]+(o[i+5]<<8),z?(y=3*v,null!=h?(N=o[i+6]+(o[i+7]<<8),C=o[i+8]+(o[i+9]<<8),V=o[i+10]+(o[i+11]<<8),g[3*N]=L[3*O],g[3*N+1]=L[3*O+1],g[3*N+2]=L[3*O+2],g[3*C]=L[3*T],g[3*C+1]=L[3*T+1],g[3*C+2]=L[3*T+2],g[3*V]=L[3*k],g[3*V+1]=L[3*k+1],g[3*V+2]=L[3*k+2],U[y]=N,U[y+1]=C,U[y+2]=V,i+=12):(U[y]=O,U[y+1]=T,U[y+2]=k,i+=6)):(F=3*O,g[y=9*v]=L[F],g[y+1]=L[F+1],g[y+2]=L[F+2],F=3*T,g[y+3]=L[F],g[y+4]=L[F+1],g[y+5]=L[F+2],F=3*k,g[y+6]=L[F],g[y+7]=L[F+1],g[y+8]=L[F+2],null!=d&&(d[y=6*v]=R[2*O],d[y+1]=R[2*O+1],d[y+2]=R[2*T],d[y+3]=R[2*T+1],d[y+4]=R[2*k],d[y+5]=R[2*k+1]),null!=h?(O=o[i+6]+(o[i+7]<<8),T=o[i+8]+(o[i+9]<<8),k=o[i+10]+(o[i+11]<<8),i+=12,h[y=6*v]=P[2*O],h[y+1]=P[2*O+1],h[y+2]=P[2*T],h[y+3]=P[2*T+1],h[y+4]=P[2*k],h[y+5]=P[2*k+1]):i+=6);t.vertices=g,t.internalUVs=h,t.externalUVs=d,t.indices=U,c=null,l=null,f=null,n.index=i,t.size=t.vertices.byteLength,t.internalUVs&&(t.size+=t.internalUVs.byteLength);t.externalUVs&&(t.size+=t.externalUVs.byteLength);t.indices&&(t.size+=t.indices.byteLength);t.faces=w}(0,n,t),n}function o(e,t){var n=e[t[1]];128&n?(t[0]=127&n|e[t[1]+1]<<7,t[1]+=2):(t[0]=n,t[1]++)}function s(e,t){var n=e[t[1]];128&n?1&(n=127&n|e[t[1]+1]<<7)?(t[0]=-(1+(n>>1)),t[1]+=2):(t[0]=n>>1,t[1]+=2):1&n?(t[0]=-(1+(n>>1)),t[1]++):(t[0]=n>>1,t[1]++)}var u={create:function(e){var t=new Array(3);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},add:function(e,t,n){return n&&e!=n?(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},subtract:function(e,t,n){return n&&e!=n?(n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},negate:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},scale:function(e,t,n){return n&&e!=n?(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n):(e[0]*=t,e[1]*=t,e[2]*=t,e)},normalize:function(e,t){t||(t=e);var n=e[0],r=e[1],a=e[2],i=Math.sqrt(n*n+r*r+a*a);return i?1==i?(t[0]=n,t[1]=r,t[2]=a,t):(i=1/i,t[0]=n*i,t[1]=r*i,t[2]=a*i,t):(t[0]=0,t[1]=0,t[2]=0,t)},normalize2:function(e,t,n){var r=e[t],a=e[t+1],i=e[t+2],o=Math.sqrt(r*r+a*a+i*i);return o?1==o?(n[0]=r,n[1]=a,n[2]=i,n):(o=1/o,n[0]=r*o,n[1]=a*o,void(n[2]=i*o)):(n[0]=0,n[1]=0,n[2]=0,n)},normalize3:function(e,t,n,r){var a=e[t],i=e[t+1],o=e[t+2],s=Math.sqrt(a*a+i*i+o*o);return s?1==s?(n[r]=a,n[r+1]=i,n[r+2]=o,n):(s=1/s,n[r]=a*s,n[r+1]=i*s,void(n[r+2]=o*s)):(n[r]=0,n[r+1]=0,n[r+2]=0,n)},normalize4:function(e,t){t||(t=e);var n=e[0],r=e[1],a=e[2],i=Math.sqrt(n*n+r*r+a*a);if(!i)return t[0]=0,t[1]=0,t[2]=0,t;if(1==i)return t[0]=n,t[1]=r,t[2]=a,t;var o=i;return i=1/i,t[0]=n*i,t[1]=r*i,t[2]=a*i,o},cross:function(e,t,n){n||(n=e);var r=e[0],a=e[1];e=e[2];var i=t[0],o=t[1];return t=t[2],n[0]=a*t-e*o,n[1]=e*i-r*t,n[2]=r*o-a*i,n},length:function(e){var t=e[0],n=e[1];return e=e[2],Math.sqrt(t*t+n*n+e*e)},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dot2:function(e,t,n){return e[0]*t[n]+e[1]*t[n+1]+e[2]*t[n+2]},dot3:function(e,t,n,r){return e[t]*n[r]+e[t+1]*n[r+1]+e[t+2]*n[r+2]},distance:function(e,t){var n=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(n*n+r*r+a*a)},squareDistance:function(e,t){var n=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return n*n+r*r+a*a},direction:function(e,t,n){n||(n=e);var r=e[0]-t[0],a=e[1]-t[1];return e=e[2]-t[2],(t=Math.sqrt(r*r+a*a+e*e))?(t=1/t,n[0]=r*t,n[1]=a*t,n[2]=e*t,n):(n[0]=0,n[1]=0,n[2]=0,n)},lerp:function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"}},c={create:function(e){var t=new Array(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},transpose:function(e,t){if(!t||e==t){var n=e[1],r=e[2],a=e[5];return e[1]=e[3],e[2]=e[6],e[3]=n,e[5]=e[7],e[6]=r,e[7]=a,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},toMat4:function(e,t){return t||(t=f.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},multiplyVec3:function(e,t,n){n||(n=t);var r=t[0],a=t[1];return t=t[2],n[0]=e[0]*r+e[3]*a+e[6]*t,n[1]=e[1]*r+e[4]*a+e[7]*t,n[2]=e[2]*r+e[5]*a+e[8]*t,n},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"}},f={create:function(e){var t=new Array(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},transpose:function(e,t){if(!t||e==t){var n=e[1],r=e[2],a=e[3],i=e[6],o=e[7],s=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=n,e[6]=e[9],e[7]=e[13],e[8]=r,e[9]=i,e[11]=e[14],e[12]=a,e[13]=o,e[14]=s,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},determinant:function(e){var t=e[0],n=e[1],r=e[2],a=e[3],i=e[4],o=e[5],s=e[6],u=e[7],c=e[8],f=e[9],l=e[10],h=e[11],d=e[12],p=e[13],g=e[14];return d*f*s*a-c*p*s*a-d*o*l*a+i*p*l*a+c*o*g*a-i*f*g*a-d*f*r*u+c*p*r*u+d*n*l*u-t*p*l*u-c*n*g*u+t*f*g*u+d*o*r*h-i*p*r*h-d*n*s*h+t*p*s*h+i*n*g*h-t*o*g*h-c*o*r*(e=e[15])+i*f*r*e+c*n*s*e-t*f*s*e-i*n*l*e+t*o*l*e},inverse:function(e,t){t||(t=e);var n=e[0],r=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],f=e[8],l=e[9],h=e[10],d=e[11],p=e[12],g=e[13],v=e[14],m=e[15],b=n*s-r*o,y=n*u-a*o,x=n*c-i*o,M=r*u-a*s,w=r*c-i*s,U=a*c-i*u,S=f*g-l*p,A=f*v-h*p,z=f*m-d*p,O=l*v-h*g,T=l*m-d*g,k=h*m-d*v,N=1/(b*k-y*T+x*O+M*z-w*A+U*S);return t[0]=(s*k-u*T+c*O)*N,t[1]=(-r*k+a*T-i*O)*N,t[2]=(g*U-v*w+m*M)*N,t[3]=(-l*U+h*w-d*M)*N,t[4]=(-o*k+u*z-c*A)*N,t[5]=(n*k-a*z+i*A)*N,t[6]=(-p*U+v*x-m*y)*N,t[7]=(f*U-h*x+d*y)*N,t[8]=(o*T-s*z+c*S)*N,t[9]=(-n*T+r*z-i*S)*N,t[10]=(p*w-g*x+m*b)*N,t[11]=(-f*w+l*x-d*b)*N,t[12]=(-o*O+s*A-u*S)*N,t[13]=(n*O-r*A+a*S)*N,t[14]=(-p*M+g*y-v*b)*N,t[15]=(f*M-l*y+h*b)*N,t},toRotationMat:function(e,t){return t||(t=f.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},toMat3:function(e,t){return t||(t=c.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},toInverseMat3:function(e,t){var n=e[0],r=e[1],a=e[2],i=e[4],o=e[5],s=e[6],u=e[8],f=e[9],l=e[10],h=l*o-s*f,d=-l*i+s*u,p=f*i-o*u,g=n*h+r*d+a*p;return g?(g=1/g,t||(t=c.create()),t[0]=h*g,t[1]=(-l*r+a*f)*g,t[2]=(s*r-a*o)*g,t[3]=d*g,t[4]=(l*n-a*u)*g,t[5]=(-s*n+a*i)*g,t[6]=p*g,t[7]=(-f*n+r*u)*g,t[8]=(o*n-r*i)*g,t):null},multiply:function(e,t,n){n||(n=e);var r=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],f=e[7],l=e[8],h=e[9],d=e[10],p=e[11],g=e[12],v=e[13],m=e[14];e=e[15];var b=t[0],y=t[1],x=t[2],M=t[3],w=t[4],U=t[5],S=t[6],A=t[7],z=t[8],O=t[9],T=t[10],k=t[11],N=t[12],C=t[13],V=t[14];return t=t[15],n[0]=b*r+y*s+x*l+M*g,n[1]=b*a+y*u+x*h+M*v,n[2]=b*i+y*c+x*d+M*m,n[3]=b*o+y*f+x*p+M*e,n[4]=w*r+U*s+S*l+A*g,n[5]=w*a+U*u+S*h+A*v,n[6]=w*i+U*c+S*d+A*m,n[7]=w*o+U*f+S*p+A*e,n[8]=z*r+O*s+T*l+k*g,n[9]=z*a+O*u+T*h+k*v,n[10]=z*i+O*c+T*d+k*m,n[11]=z*o+O*f+T*p+k*e,n[12]=N*r+C*s+V*l+t*g,n[13]=N*a+C*u+V*h+t*v,n[14]=N*i+C*c+V*d+t*m,n[15]=N*o+C*f+V*p+t*e,n},multiplyVec3:function(e,t,n){n||(n=t);var r=t[0],a=t[1];return t=t[2],n[0]=e[0]*r+e[4]*a+e[8]*t+e[12],n[1]=e[1]*r+e[5]*a+e[9]*t+e[13],n[2]=e[2]*r+e[6]*a+e[10]*t+e[14],n},multiplyVec4:function(e,t,n){n||(n=t);var r=t[0],a=t[1],i=t[2];return t=t[3],n[0]=e[0]*r+e[4]*a+e[8]*i+e[12]*t,n[1]=e[1]*r+e[5]*a+e[9]*i+e[13]*t,n[2]=e[2]*r+e[6]*a+e[10]*i+e[14]*t,n[3]=e[3]*r+e[7]*a+e[11]*i+e[15]*t,n},translate:function(e,t,n){var r=t[0],a=t[1];if(t=t[2],!n||e==n)return e[12]=e[0]*r+e[4]*a+e[8]*t+e[12],e[13]=e[1]*r+e[5]*a+e[9]*t+e[13],e[14]=e[2]*r+e[6]*a+e[10]*t+e[14],e[15]=e[3]*r+e[7]*a+e[11]*t+e[15],e;var i=e[0],o=e[1],s=e[2],u=e[3],c=e[4],f=e[5],l=e[6],h=e[7],d=e[8],p=e[9],g=e[10],v=e[11];return n[0]=i,n[1]=o,n[2]=s,n[3]=u,n[4]=c,n[5]=f,n[6]=l,n[7]=h,n[8]=d,n[9]=p,n[10]=g,n[11]=v,n[12]=i*r+c*a+d*t+e[12],n[13]=o*r+f*a+p*t+e[13],n[14]=s*r+l*a+g*t+e[14],n[15]=u*r+h*a+v*t+e[15],n},scale:function(e,t,n){var r=t[0],a=t[1];return t=t[2],n&&e!=n?(n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*a,n[5]=e[5]*a,n[6]=e[6]*a,n[7]=e[7]*a,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n):(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=a,e[5]*=a,e[6]*=a,e[7]*=a,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e)},rotate:function(e,t,n,r){var a=n[0],i=n[1];n=n[2];var o=Math.sqrt(a*a+i*i+n*n);if(!o)return null;1!=o&&(a*=o=1/o,i*=o,n*=o);var s=Math.sin(t),u=Math.cos(t),c=1-u;t=e[0],o=e[1];var f=e[2],l=e[3],h=e[4],d=e[5],p=e[6],g=e[7],v=e[8],m=e[9],b=e[10],y=e[11],x=a*a*c+u,M=i*a*c+n*s,w=n*a*c-i*s,U=a*i*c-n*s,S=i*i*c+u,A=n*i*c+a*s,z=a*n*c+i*s;return a=i*n*c-a*s,i=n*n*c+u,r?e!=r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=t*x+h*M+v*w,r[1]=o*x+d*M+m*w,r[2]=f*x+p*M+b*w,r[3]=l*x+g*M+y*w,r[4]=t*U+h*S+v*A,r[5]=o*U+d*S+m*A,r[6]=f*U+p*S+b*A,r[7]=l*U+g*S+y*A,r[8]=t*z+h*a+v*i,r[9]=o*z+d*a+m*i,r[10]=f*z+p*a+b*i,r[11]=l*z+g*a+y*i,r},rotateX:function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var a=e[4],i=e[5],o=e[6],s=e[7],u=e[8],c=e[9],f=e[10],l=e[11];return n?e!=n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[4]=a*t+u*r,n[5]=i*t+c*r,n[6]=o*t+f*r,n[7]=s*t+l*r,n[8]=a*-r+u*t,n[9]=i*-r+c*t,n[10]=o*-r+f*t,n[11]=s*-r+l*t,n},rotateY:function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var a=e[0],i=e[1],o=e[2],s=e[3],u=e[8],c=e[9],f=e[10],l=e[11];return n?e!=n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=a*t+u*-r,n[1]=i*t+c*-r,n[2]=o*t+f*-r,n[3]=s*t+l*-r,n[8]=a*r+u*t,n[9]=i*r+c*t,n[10]=o*r+f*t,n[11]=s*r+l*t,n},rotateZ:function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var a=e[0],i=e[1],o=e[2],s=e[3],u=e[4],c=e[5],f=e[6],l=e[7];return n?e!=n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=a*t+u*r,n[1]=i*t+c*r,n[2]=o*t+f*r,n[3]=s*t+l*r,n[4]=a*-r+u*t,n[5]=i*-r+c*t,n[6]=o*-r+f*t,n[7]=s*-r+l*t,n},frustum:function(e,t,n,r,a,i,o){o||(o=f.create());var s=t-e,u=r-n,c=i-a;return o[0]=2*a/s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*a/u,o[6]=0,o[7]=0,o[8]=(t+e)/s,o[9]=(r+n)/u,o[10]=-(i+a)/c,o[11]=-1,o[12]=0,o[13]=0,o[14]=-i*a*2/c,o[15]=0,o},perspective:function(e,t,n,r,a){return t*=e=n*Math.tan(e*Math.PI/360),f.frustum(-t,t,-e,e,n,r,a)},ortho:function(e,t,n,r,a,i,o){o||(o=f.create());var s=t-e,u=r-n,c=i-a;return o[0]=2/s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/u,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/c,o[11]=0,o[12]=-(e+t)/s,o[13]=-(r+n)/u,o[14]=-(i+a)/c,o[15]=1,o},lookAt:function(e,t,n,r){r||(r=f.create());var a=e[0],i=e[1];e=e[2];var o=n[0],s=n[1],u=n[2];n=t[1];var c,l,h,d,p=t[2];return a==t[0]&&i==n&&e==p?f.identity(r):(n=a-t[0],p=i-t[1],t=e-t[2],c=s*(t*=d=1/Math.sqrt(n*n+p*p+t*t))-u*(p*=d),u=u*(n*=d)-o*t,o=o*p-s*n,(d=Math.sqrt(c*c+u*u+o*o))?(c*=d=1/d,u*=d,o*=d):o=u=c=0,s=p*o-t*u,l=t*c-n*o,h=n*u-p*c,(d=Math.sqrt(s*s+l*l+h*h))?(s*=d=1/d,l*=d,h*=d):h=l=s=0,r[0]=c,r[1]=s,r[2]=n,r[3]=0,r[4]=u,r[5]=l,r[6]=p,r[7]=0,r[8]=o,r[9]=h,r[10]=t,r[11]=0,r[12]=-(c*a+u*i+o*e),r[13]=-(s*a+l*i+h*e),r[14]=-(n*a+p*i+t*e),r[15]=1,r)},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"}},l=f,h={isEqual:function(e,t,n){return Math.abs(e-t)<n},clamp:function(e,t,n){return e<t?e=t:e>n&&(e=n),e},radians:function(e){return e*Math.PI/180},degrees:function(e){return e/Math.PI*180},mix:function(e,t,n){return e+(t-e)*n},frustumMatrix:function(e,t,n,r,a,i){var o=t-e,s=r-n,u=i-a,c=l.create([2*a/o,0,(t+e)/o,0,0,2*a/s,(r+n)/s,0,0,0,-(i+a)/u,-2*i*a/u,0,0,-1,0]);return l.transpose(c),c},perspectiveMatrix:function(e,t,n,r){var a=n*Math.tan(e*Math.PI/180),i=a*t;return h.frustumMatrix(-i,i,-a,a,n,r)},orthographicMatrix:function(e,t,n,r){var a=.5*e*t,i=.5*e,o=r-n,s=l.create([1/a,0,0,0,0,1/i,0,0,0,0,-2/o,-(r+n)/o,0,0,0,1]);return l.transpose(s),s},rotationMatrix:function(e,t){var n=Math.cos(t),r=Math.sin(t);switch(e){case 0:return[1,0,0,0,0,n,r,0,0,-r,n,0,0,0,0,1];case 1:return[n,0,r,0,0,1,0,0,-r,0,n,0,0,0,0,1];default:return[n,r,0,0,-r,n,0,0,0,0,1,0,0,0,0,1]}},scaleMatrix:function(e,t,n){return[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]},scaleMatrixf:function(e){return h.scaleMatrix(e,e,e)},translationMatrix:function(e,t,n){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]},translationMatrix2f:function(e){return h.translationMatrix(e[0],e[1],0)},translationMatrix3f:function(e){return h.translationMatrix(e[0],e[1],e[2])}},d={isSameOrigin:function(e){if("string"!=typeof e)return!1;var t=document.location.hostname;return d.parse(e).hostname===t},parse:function(e){if("string"!=typeof e)return null;var t=document.createElement("a");return t.href=e,t},getParamsFromUrl:function(e){var t={},n=d.parse(e).search.substring(1).split("&");if(1!=n.length||""!=n[0])for(var r=0;r<n.length;r++){var a=n[r].split("=");if(void 0===t[a[0]])t[a[0]]=a[1];else if("string"==typeof t[a[0]]){var i=[t[a[0]],a[1]];t[a[0]]=i}else t[a[0]].push(a[1])}return t},getHost:function(e){var t=document.createElement("a");return t.href=e,t.hostname},getSchema:function(e){if(-1!=e.indexOf("http://"))return"http:";if(-1!=e.indexOf("https://"))return"https:";var t=document.createElement("a");return t.href=e,t.protocol},getOrigin:function(e){var t=document.createElement("a");return t.href=e,t.origin?t.origin:t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")},getBase:function(e){return e.split("?")[0].split("/").slice(0,-1).join("/")+"/"},makeAbsolute:function(e){var t=document.createElement("a");return t.href=e,t.href},getProcessUrl:function(e,t){if(!e||!t)return e;e=e.trim(),t=t.trim();var n=d.getBase(t),r=d.getSchema(t),a=d.getOrigin(t);return-1!=e.indexOf("://")?e:0==e.indexOf("//")?r+e:0==e.indexOf("/")?a+e:n+e}},p=h,g=d,v={useCredentials:!1,instanceCounter:0,validateBool:function(e,t){return"boolean"==typeof e?e:t},validateNumber:function(e,t,n,r){return"number"==typeof e?p.clamp(e,t,n):r},validateNumberArray:function(e,t,n,r,a){if(Array.isArray(e)&&e.length==t){for(var i=0;i<t;i++)e[i]=p.clamp(e[i],n[i],r[i]);return e}return a},validateString:function(e,t){return"string"==typeof e?e:t},padNumber:function(e,t){return e<0?(t--,(e=-e+"").length>=t?"-"+e:"-"+(new Array(t-e.length+1).join("0")+e)):(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e},decodeFloat16:function(e){var t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)},simpleFmtObj:function(e,t){return e&&""!=e?e.replace(/\\{([$a-zA-Z0-9][$a-zA-Z0-9]*)\\}/g,(function(e,n){return n in t?t[n]:e})):""},simpleWikiLinks:function(e,t){return e&&""!=e?v.simpleFmtObj(e,{copy:"&copy;",Y:(new Date).getFullYear()}).replace(/\\[([^\\]]*)\\]/g,(function(e,n){var r=(n=n.trim()).split(" ");return-1!=r[0].indexOf("//")?t?r.length>1?""+n.substring(r[0].length):""+r[0]:r.length>1?"<a href="+r[0]+\' target="blank">\'+n.substring(r[0].length)+"</a>":"<a href="+r[0]+\' target="blank">\'+r[0]+"</a>":n})):""},simpleFmtObjOrCall:function(e,t,n){return e&&""!=e?e.replace(/\\{([$a-zA-Z(-9][$a-zA-Z(-9]*)\\}/g,(function(e,r){return r in t?t[r]:n(r)})):""},getABGRFromHexaCode:function(e){var t=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(e);return t?[parseInt(t[4],16),parseInt(t[3],16),parseInt(t[2],16),parseInt(t[1],16)]:[0,0,0,255]},stringifyFunction:function(e){return"("+e+").call(self);"},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},fitToPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},getHash:function(e){if(!e||0===e.length)return 0;for(var t=0,n=0,r=e.length;n<r;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t},convertRGB2YCbCr:function(e,t,n){return[.299*e+.587*t+.114*n+0,-.169*e+-.331*t+.5*n+128,.5*e+-.419*t+-.081*n+128]},convertYCbCr2RGB:function(e,t,n){return[1*e+0*(t-128)+1.4*(n-128),1*e+-.343*(t-128)+-.711*(n-128),1*e+1.765*(t-128)+0*(n-128)]},convertHSL2RGB:function(e,t,n){var r,a,i,o,s,u;return(e/=60)<0&&(e=6- -e%6),e%=6,t=Math.max(0,Math.min(1,t/100)),n=Math.max(0,Math.min(1,n/100)),u=(s=(1-Math.abs(2*n-1))*t)*(1-Math.abs(e%2-1)),e<1?(r=s,a=u,i=0):e<2?(r=u,a=s,i=0):e<3?(r=0,a=s,i=u):e<4?(r=0,a=u,i=s):e<5?(r=u,a=0,i=s):(r=s,a=0,i=u),[r+(o=n-s/2),a+o,i+o]},getHashColor:function(e){var t=v.getHash(e),n=v.convertRGB2YCbCr(255&t,t>>8&255,t>>16&255);return n[0]=p.clamp(n[0],50,200),v.convertRGB2YCbCr(n[0],n[1],n[2])},getHashColor2:function(e){var t=Math.floor(e/18),n=50;return t>=1&&(n=t%2?50+10*n%30:50-10*(n-1)%30),t=e%18*20,v.convertHSL2RGB(t,100,n)},loadText:function(e,t,n,r,a){v.loadJSON(e,t,n,!0,r,a)},loadXML:function(e,t,n,r,a){v.loadJSON(e,(function(e){e=(new DOMParser).parseFromString(e,"text/xml"),t&&t(e)}),n,!0,r,a)},loadJSON:function(e,t,n,r,a,i){var o=new XMLHttpRequest;o.onreadystatechange=function(){switch(o.readyState){case 0:case 1:case 2:case 3:break;case 4:if(o.status>=400||0==o.status){n&&n(o.status);break}var a=o.response,i=a;if(!r)try{i=JSON.parse(a)}catch(t){return console.log("JSON Parse Error ("+e+"): "+(t.message?t.message:"")),void(n&&n(o.status))}t&&t(i)}}.bind(this),o.open("GET",e,!0),o.withCredentials=a,i&&i.token&&o.setRequestHeader("Accept","token/"+i.token+", */*"),i&&i.charset&&o.overrideMimeType("text/xml; charset="+i.charset),o.send("")},loadBinary:function(e,t,n,r,a,i){var o=new XMLHttpRequest;o.onreadystatechange=function(){switch(o.readyState){case 0:case 1:case 2:case 3:break;case 4:if(o.status>=400||0==o.status){n&&n(o.status);break}var e=o.response;if(!e){n&&n();break}t&&t(e);break;default:n&&n()}}.bind(this),o.open("GET",e,!0),o.responseType=i||"arraybuffer",o.withCredentials=r,a&&a.token&&o.setRequestHeader("Accept","token/"+a.token+", */*"),o.send("")},headRequest:function(e,t,n,r,a){var i=new XMLHttpRequest;i.onreadystatechange=function(){switch(i.readyState){case 0:case 1:case 2:case 3:break;case 4:null!=t&&t(i.getAllResponseHeaders(),i.status);break;default:null!=n&&n()}}.bind(this),i.onerror=function(){null!=n&&n()}.bind(this),i.open("HEAD",e,!0),i.withCredentials=r,a&&a.token&&i.setRequestHeader("Accept","token/"+a.token+", */*"),i.send("")},loadImage:function(e,t,n,r,a){var i=new Image;return i.onerror=n,i.onload=t,a||(i.crossOrigin=r?"use-credentials":"anonymous"),i.src=e,i},getParamsFromUrl:function(e){return g.getParamsFromUrl(e)}},m="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;v.unint8ArrayToString=function(e){if(m)return m.decode(e);var t="",n=new Uint8Array(e.byteLength);n.set(e);for(var r=new Uint32Array(n.buffer),a=0,i=r.length;a<i;++a){var o=r[a];o<=65535?t+=String.fromCharCode(o):(o-=65536,t+=String.fromCharCode(55296+(o>>10),56320+(1023&o)))}return t};var b=u,y=v,x=function(){this.bintree=null,this.pathTable=null,this.totalNodes=0,this.pathTableSize=1,this.nodesIndex=0,this.rootSize=1};x.prototype.countNode=function(e,t){this.totalNodes++;var n=e.content;if(n&&n.uri){var r=n.uri.split(".");if(r.length>1){var a=r[r.length-1];r.pop();var i=r.join(".");"json"==a?this.pathTableSize+=i.length+1+4:"mesh"==a&&(this.pathTableSize+=i.length+1)}}var o=e.children;if(o)for(var s=0,u=o.length;s<u;s++)this.countNode(o[s])},x.prototype.processNode=function(e,t,n,r){var a=9*t,i=e.content;if(i&&i.uri){var o=i.uri.split(".");if(o.length>1){var s=o[o.length-1];o.pop();var u=o.join(".");"json"==s?(this.bintree[a]=this.pathTableSize|1<<31,this.pathTableSize+=4):"mesh"==s&&(this.bintree[a]=this.pathTableSize);for(var c=0,f=u.length;c<f;c++)this.pathTable[this.pathTableSize++]=u.charCodeAt(c);this.pathTable[this.pathTableSize++]=0}}var l=e.children;if(l)for(c=0,f=l.length;c<f;c++){var h=l[c],d=h.boundingVolume;if(d){var p=h.extras,g=0;p&&(g=p.ci);if(d.region){this.totalNodes++;var v=this.totalNodes;this.bintree[a+1+g]=v,this.processNode(h,v,n+1)}}}},x.prototype.processJSON=function(e,t){if(e){if(this.rootPath="",this.countNode(e.root),this.bintree=new Uint32Array(9*this.totalNodes),this.pathTable=new Uint8Array(this.pathTableSize+1),this.totalNodes=0,this.pathTableSize=1,t.root){var n=e.extras,r=n.extents,a=[(r[0][0]+r[1][0]+r[2][0]+r[3][0]+r[4][0]+r[5][0]+r[6][0]+r[7][0])/8,(r[0][1]+r[1][1]+r[2][1]+r[3][1]+r[4][1]+r[5][1]+r[6][1]+r[7][1])/8,(r[0][2]+r[1][2]+r[2][2]+r[3][2]+r[4][2]+r[5][2]+r[6][2]+r[7][2])/8],i=[r[1][0]-r[0][0],r[1][1]-r[0][1],r[1][2]-r[0][2]],o=[r[1][0]-r[2][0],r[1][1]-r[2][1],r[1][2]-r[2][2]],s=[r[4][0]-r[0][0],r[4][1]-r[0][1],r[4][2]-r[0][2]];i[0]=-i[0],i[1]=-i[1],i[2]=-i[2],o[0]=-o[0],o[1]=-o[1],o[2]=-o[2];var u=r[1];this.rootPoints=[[u[0],u[1],u[2]],[u[0]+o[0],u[1]+o[1],u[2]+o[2]],[u[0]+o[0]+i[0],u[1]+o[1]+i[1],u[2]+o[2]+i[2]],[u[0]+i[0],u[1]+i[1],u[2]+i[2]],[u[0]+s[0],u[1]+s[1],u[2]+s[2]],[u[0]+o[0]+s[0],u[1]+o[1]+s[1],u[2]+o[2]+s[2]],[u[0]+o[0]+i[0]+s[0],u[1]+o[1]+i[1]+s[1],u[2]+o[2]+i[2]+s[2]],[u[0]+i[0]+s[0],u[1]+i[1]+s[1],u[2]+i[2]+s[2]]],this.rootCenter=a,this.rootRadius=b.distance(a,r[0]),this.rootTexelSize=n.nominalResolution*Math.pow(2,n.depth)}else this.rootPoints=[],this.rootCenter=[],this.rootRadius=1,this.rootTexelSize=1;this.processNode(e.root,0,0),this.totalNodes++}},x.prototype.loadJSON=function(e,t,n){y.loadJSON(e,this.onLoaded.bind(this,t,n),null)},x.prototype.onLoaded=function(e,t,n){this.processJSON(n,e),t&&t(e,{bintree:this.bintree,pathTable:this.pathTable,totalNodes:this.totalNodes,rootSize:this.rootSize,points:this.rootPoints,center:this.rootCenter,radius:this.rootRadius,texelSize:this.rootTexelSize})};var M=r,w=function(e){var t,n,r={},o=e.data,s="";if(o.length<2)return!1;if(s+=String.fromCharCode(o.getUint8(e.index,!0)),e.index+=1,s+=String.fromCharCode(o.getUint8(e.index,!0)),e.index+=1,"ME"!=s)return!1;if(r.version=o.getUint16(e.index,!0),e.index+=2,r.version>3)return!1;for(e.uint8Data=new Uint8Array(e.data.buffer),r.meanUndulation=o.getFloat64(e.index,!0),e.index+=8,r.numSubmeshes=o.getUint16(e.index,!0),e.index+=2,r.submeshes=[],r.gpuSize=0,r.faces=0,r.size=0,a.config.map16bitMeshes,t=0,n=r.numSubmeshes;t<n;t++){var u;(u=i(r,e)).valid&&(r.submeshes.push(u),r.size+=u.size,r.faces+=u.faces,r.gpuSize+=u.size)}r.numSubmeshes=r.submeshes.length;var c=[],f=[];for(t=0,n=r.numSubmeshes;t<n;t++)u=r.submeshes[t],c.push({bboxMax:u.bboxMax,bboxMin:u.bboxMin,externalUVs:u.externalUVs?u.externalUVs.buffer:null,faces:u.faces,flags:u.flags,gpuSize:u.gpuSize,indices:u.indices?u.indices.buffer:null,internalUVs:u.internalUVs?u.internalUVs.buffer:null,size:u.size,surfaceReference:u.surfaceReference,textureLayer:u.textureLayer,textureLayer2:u.textureLayer2,vertices:u.vertices.buffer}),u.externalUVs&&f.push(u.externalUVs.buffer),u.internalUVs&&f.push(u.internalUVs.buffer),u.vertices&&f.push(u.vertices.buffer),u.indices&&f.push(u.indices.buffer);return{mesh:{faces:r.faces,gpuSize:r.gpuSize,meanUndulation:r.meanUndulation,numSubmeshes:r.numSubmeshes,size:r.size,submeshes:r.submeshes,version:r.version},transferables:f}},U=x,S=[],A=[];function z(e,t){M.config.mapPackLoaderEvents?(S.push(e),t&&(A=A.concat(t))):t?postMessage(e,t):postMessage(e)}function O(e,t,n,r,a,i,o,s){var u=new XMLHttpRequest;u.onreadystatechange=function(){switch(u.readyState){case 0:case 1:case 2:case 3:break;case 4:if(u.status>=400||0==u.status){n&&z({command:"on-error",path:e,status:u.status});break}var r=u.response;if(!r){n&&z({command:"on-error",path:e});break}if(t)if("direct-texture"==o)createImageBitmap(r).then(function(t){z({command:"on-loaded",path:e,data:t,filesize:r.size},[t])}.bind(this));else if("direct-mesh"==o){var a=w({data:new DataView(r),index:0});z({command:"on-loaded",path:e,data:a.mesh},a.transferables)}else if("direct-3dtiles"==o){a=function(e,t){var n=new U;return n.processJSON(e,t),{geodata:{bintree:n.bintree,pathTable:n.pathTable,totalNodes:n.totalNodes,rootSize:n.rootSize,points:n.rootPoints,center:n.rootCenter,radius:n.rootRadius,texelSize:n.rootTexelSize},transferables:[n.bintree.buffer,n.pathTable.buffer]}}(JSON.parse(r),s);postMessage({command:"on-loaded",path:e,data:a.geodata},a.transferables)}else z({command:"on-loaded",path:e,data:r},[r]);break;default:n&&z({command:"on-error",path:e})}}.bind(this),u.open("GET",e,!0),u.responseType=i||"arraybuffer",u.withCredentials=r,a&&a.token&&u.setRequestHeader("Accept","token/"+a.token+", */*"),u.send("")}self.onmessage=function(e){var t=e.data;switch(t.command){case"config":M.config=t.data;break;case"tick":S.length>0&&(A.length>0?postMessage({command:"packed-events",messages:S},A):postMessage({command:"packed-events",messages:S})),S=[],A=[];break;case"load-binary":O(t.path,!0,!0,t.withCredentials,t.xhrParams,t.responseType,t.kind,t.options)}}}]);\n//# sourceMappingURL=3ed452ad1c49891b7e1e.worker.js.map',null)}},function(e,t,r){"use strict";r.r(t),r.d(t,"vec2",(function(){return m})),r.d(t,"vec3",(function(){return g})),r.d(t,"vec4",(function(){return v})),r.d(t,"mat3",(function(){return y})),r.d(t,"mat4",(function(){return b})),r.d(t,"math",(function(){return S})),r.d(t,"utils",(function(){return x})),r.d(t,"getCoreVersion",(function(){return c})),r.d(t,"checkSupport",(function(){return p})),r.d(t,"core",(function(){return T})),r.d(t,"proj4",(function(){return M})),r.d(t,"platform",(function(){return w}));var i=r(6),a=r(8),s=r.n(a);r.d(t,"earcut",(function(){return s.a}));var n=r(7),o=r(12),h=r(0),l=r(1),u=r(2),d=r(4),c=n.c,p=n.b,f=o.a,m=h.c,g=h.d,v=h.e,y=h.a,b=h.b,x=l.a,S=u.a,M=i.a,w=d.a;function T(e,t){return e="string"!=typeof e?e:document.getElementById(e),p()?new f(e,t):null}}]);
//# sourceMappingURL=vts-core.min.js.map