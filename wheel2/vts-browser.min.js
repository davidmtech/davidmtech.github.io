/*!
 * Copyright (c) 2020 Melown Technologies SE
 *  *  For terms of use, see accompanying vts-browser file.
 *  *  For 3rd party libraries licenses, see 3rdpartylicenses.txt.
 * 
 */
var vts=function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=20)}([function(e,t,i){"use strict";i.d(t,"c",(function(){return r})),i.d(t,"d",(function(){return a})),i.d(t,"e",(function(){return s})),i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o}));var r={create:function(e){var t=new Array(2);return e&&(t[0]=e[0],t[1]=e[1]),t}},s={create:function(e){var t=new Array(4);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},dot2:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]},dot3:function(e,t,i,r,s,a){return e[0]*(t[i]-r)+e[1]*(t[i+1]-s)+e[2]*(t[i+2]-a)+e[3]}},a={create:function(e){var t=new Array(3);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},add:function(e,t,i){return i&&e!=i?(i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},subtract:function(e,t,i){return i&&e!=i?(i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},negate:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},scale:function(e,t,i){return i&&e!=i?(i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i):(e[0]*=t,e[1]*=t,e[2]*=t,e)},normalize:function(e,t){t||(t=e);var i=e[0],r=e[1],s=e[2],a=Math.sqrt(i*i+r*r+s*s);return a?1==a?(t[0]=i,t[1]=r,t[2]=s,t):(a=1/a,t[0]=i*a,t[1]=r*a,t[2]=s*a,t):(t[0]=0,t[1]=0,t[2]=0,t)},normalize2:function(e,t,i){var r=e[t],s=e[t+1],a=e[t+2],n=Math.sqrt(r*r+s*s+a*a);return n?1==n?(i[0]=r,i[1]=s,i[2]=a,i):(n=1/n,i[0]=r*n,i[1]=s*n,void(i[2]=a*n)):(i[0]=0,i[1]=0,i[2]=0,i)},normalize3:function(e,t,i,r){var s=e[t],a=e[t+1],n=e[t+2],o=Math.sqrt(s*s+a*a+n*n);return o?1==o?(i[r]=s,i[r+1]=a,i[r+2]=n,i):(o=1/o,i[r]=s*o,i[r+1]=a*o,void(i[r+2]=n*o)):(i[r]=0,i[r+1]=0,i[r+2]=0,i)},normalize4:function(e,t){t||(t=e);var i=e[0],r=e[1],s=e[2],a=Math.sqrt(i*i+r*r+s*s);if(!a)return t[0]=0,t[1]=0,t[2]=0,t;if(1==a)return t[0]=i,t[1]=r,t[2]=s,t;var n=a;return a=1/a,t[0]=i*a,t[1]=r*a,t[2]=s*a,n},cross:function(e,t,i){i||(i=e);var r=e[0],s=e[1];e=e[2];var a=t[0],n=t[1];return t=t[2],i[0]=s*t-e*n,i[1]=e*a-r*t,i[2]=r*n-s*a,i},length:function(e){var t=e[0],i=e[1];return e=e[2],Math.sqrt(t*t+i*i+e*e)},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dot2:function(e,t,i){return e[0]*t[i]+e[1]*t[i+1]+e[2]*t[i+2]},dot3:function(e,t,i,r){return e[t]*i[r]+e[t+1]*i[r+1]+e[t+2]*i[r+2]},distance:function(e,t){var i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(i*i+r*r+s*s)},distance2:function(e,t,i,r){var s=i[r]-e[t],a=i[r+1]-e[t+1],n=i[r+2]-e[t+2];return Math.sqrt(s*s+a*a+n*n)},squareDistance:function(e,t){var i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s},direction:function(e,t,i){i||(i=e);var r=e[0]-t[0],s=e[1]-t[1];return e=e[2]-t[2],(t=Math.sqrt(r*r+s*s+e*e))?(t=1/t,i[0]=r*t,i[1]=s*t,i[2]=e*t,i):(i[0]=0,i[1]=0,i[2]=0,i)},lerp:function(e,t,i,r){return r||(r=e),r[0]=e[0]+i*(t[0]-e[0]),r[1]=e[1]+i*(t[1]-e[1]),r[2]=e[2]+i*(t[2]-e[2]),r},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"}},n={create:function(e){var t=new Array(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},transpose:function(e,t){if(!t||e==t){var i=e[1],r=e[2],s=e[5];return e[1]=e[3],e[2]=e[6],e[3]=i,e[5]=e[7],e[6]=r,e[7]=s,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},toMat4:function(e,t){return t||(t=o.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},multiplyVec3:function(e,t,i){i||(i=t);var r=t[0],s=t[1];return t=t[2],i[0]=e[0]*r+e[3]*s+e[6]*t,i[1]=e[1]*r+e[4]*s+e[7]*t,i[2]=e[2]*r+e[5]*s+e[8]*t,i},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"}},o={create:function(e){var t=new Array(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},transpose:function(e,t){if(!t||e==t){var i=e[1],r=e[2],s=e[3],a=e[6],n=e[7],o=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=i,e[6]=e[9],e[7]=e[13],e[8]=r,e[9]=a,e[11]=e[14],e[12]=s,e[13]=n,e[14]=o,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},determinant:function(e){var t=e[0],i=e[1],r=e[2],s=e[3],a=e[4],n=e[5],o=e[6],h=e[7],l=e[8],u=e[9],c=e[10],d=e[11],p=e[12],f=e[13],g=e[14];return p*u*o*s-l*f*o*s-p*n*c*s+a*f*c*s+l*n*g*s-a*u*g*s-p*u*r*h+l*f*r*h+p*i*c*h-t*f*c*h-l*i*g*h+t*u*g*h+p*n*r*d-a*f*r*d-p*i*o*d+t*f*o*d+a*i*g*d-t*n*g*d-l*n*r*(e=e[15])+a*u*r*e+l*i*o*e-t*u*o*e-a*i*c*e+t*n*c*e},inverse:function(e,t){t||(t=e);var i=e[0],r=e[1],s=e[2],a=e[3],n=e[4],o=e[5],h=e[6],l=e[7],u=e[8],c=e[9],d=e[10],p=e[11],f=e[12],g=e[13],m=e[14],v=e[15],y=i*o-r*n,b=i*h-s*n,x=i*l-a*n,w=r*h-s*o,M=r*l-a*o,S=s*l-a*h,A=u*g-c*f,C=u*m-d*f,T=u*v-p*f,P=c*m-d*g,F=c*v-p*g,L=d*v-p*m,E=1/(y*L-b*F+x*P+w*T-M*C+S*A);return t[0]=(o*L-h*F+l*P)*E,t[1]=(-r*L+s*F-a*P)*E,t[2]=(g*S-m*M+v*w)*E,t[3]=(-c*S+d*M-p*w)*E,t[4]=(-n*L+h*T-l*C)*E,t[5]=(i*L-s*T+a*C)*E,t[6]=(-f*S+m*x-v*b)*E,t[7]=(u*S-d*x+p*b)*E,t[8]=(n*F-o*T+l*A)*E,t[9]=(-i*F+r*T-a*A)*E,t[10]=(f*M-g*x+v*y)*E,t[11]=(-u*M+c*x-p*y)*E,t[12]=(-n*P+o*C-h*A)*E,t[13]=(i*P-r*C+s*A)*E,t[14]=(-f*w+g*b-m*y)*E,t[15]=(u*w-c*b+d*y)*E,t},toRotationMat:function(e,t){return t||(t=o.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},toMat3:function(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},toInverseMat3:function(e,t){var i=e[0],r=e[1],s=e[2],a=e[4],o=e[5],h=e[6],l=e[8],u=e[9],c=e[10],d=c*o-h*u,p=-c*a+h*l,f=u*a-o*l,g=i*d+r*p+s*f;return g?(g=1/g,t||(t=n.create()),t[0]=d*g,t[1]=(-c*r+s*u)*g,t[2]=(h*r-s*o)*g,t[3]=p*g,t[4]=(c*i-s*l)*g,t[5]=(-h*i+s*a)*g,t[6]=f*g,t[7]=(-u*i+r*l)*g,t[8]=(o*i-r*a)*g,t):null},multiply:function(e,t,i){i||(i=e);var r=e[0],s=e[1],a=e[2],n=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],d=e[9],p=e[10],f=e[11],g=e[12],m=e[13],v=e[14];e=e[15];var y=t[0],b=t[1],x=t[2],w=t[3],M=t[4],S=t[5],A=t[6],C=t[7],T=t[8],P=t[9],F=t[10],L=t[11],E=t[12],k=t[13],N=t[14];return t=t[15],i[0]=y*r+b*o+x*c+w*g,i[1]=y*s+b*h+x*d+w*m,i[2]=y*a+b*l+x*p+w*v,i[3]=y*n+b*u+x*f+w*e,i[4]=M*r+S*o+A*c+C*g,i[5]=M*s+S*h+A*d+C*m,i[6]=M*a+S*l+A*p+C*v,i[7]=M*n+S*u+A*f+C*e,i[8]=T*r+P*o+F*c+L*g,i[9]=T*s+P*h+F*d+L*m,i[10]=T*a+P*l+F*p+L*v,i[11]=T*n+P*u+F*f+L*e,i[12]=E*r+k*o+N*c+t*g,i[13]=E*s+k*h+N*d+t*m,i[14]=E*a+k*l+N*p+t*v,i[15]=E*n+k*u+N*f+t*e,i},multiplyVec3:function(e,t,i){i||(i=t);var r=t[0],s=t[1];return t=t[2],i[0]=e[0]*r+e[4]*s+e[8]*t+e[12],i[1]=e[1]*r+e[5]*s+e[9]*t+e[13],i[2]=e[2]*r+e[6]*s+e[10]*t+e[14],i},multiplyVec4:function(e,t,i){i||(i=t);var r=t[0],s=t[1],a=t[2];return t=t[3],i[0]=e[0]*r+e[4]*s+e[8]*a+e[12]*t,i[1]=e[1]*r+e[5]*s+e[9]*a+e[13]*t,i[2]=e[2]*r+e[6]*s+e[10]*a+e[14]*t,i[3]=e[3]*r+e[7]*s+e[11]*a+e[15]*t,i},translate:function(e,t,i){var r=t[0],s=t[1];if(t=t[2],!i||e==i)return e[12]=e[0]*r+e[4]*s+e[8]*t+e[12],e[13]=e[1]*r+e[5]*s+e[9]*t+e[13],e[14]=e[2]*r+e[6]*s+e[10]*t+e[14],e[15]=e[3]*r+e[7]*s+e[11]*t+e[15],e;var a=e[0],n=e[1],o=e[2],h=e[3],l=e[4],u=e[5],c=e[6],d=e[7],p=e[8],f=e[9],g=e[10],m=e[11];return i[0]=a,i[1]=n,i[2]=o,i[3]=h,i[4]=l,i[5]=u,i[6]=c,i[7]=d,i[8]=p,i[9]=f,i[10]=g,i[11]=m,i[12]=a*r+l*s+p*t+e[12],i[13]=n*r+u*s+f*t+e[13],i[14]=o*r+c*s+g*t+e[14],i[15]=h*r+d*s+m*t+e[15],i},scale:function(e,t,i){var r=t[0],s=t[1];return t=t[2],i&&e!=i?(i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i[4]=e[4]*s,i[5]=e[5]*s,i[6]=e[6]*s,i[7]=e[7]*s,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i):(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=s,e[5]*=s,e[6]*=s,e[7]*=s,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e)},rotate:function(e,t,i,r){var s=i[0],a=i[1];i=i[2];var n=Math.sqrt(s*s+a*a+i*i);if(!n)return null;1!=n&&(s*=n=1/n,a*=n,i*=n);var o=Math.sin(t),h=Math.cos(t),l=1-h;t=e[0],n=e[1];var u=e[2],c=e[3],d=e[4],p=e[5],f=e[6],g=e[7],m=e[8],v=e[9],y=e[10],b=e[11],x=s*s*l+h,w=a*s*l+i*o,M=i*s*l-a*o,S=s*a*l-i*o,A=a*a*l+h,C=i*a*l+s*o,T=s*i*l+a*o;return s=a*i*l-s*o,a=i*i*l+h,r?e!=r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=t*x+d*w+m*M,r[1]=n*x+p*w+v*M,r[2]=u*x+f*w+y*M,r[3]=c*x+g*w+b*M,r[4]=t*S+d*A+m*C,r[5]=n*S+p*A+v*C,r[6]=u*S+f*A+y*C,r[7]=c*S+g*A+b*C,r[8]=t*T+d*s+m*a,r[9]=n*T+p*s+v*a,r[10]=u*T+f*s+y*a,r[11]=c*T+g*s+b*a,r},rotateX:function(e,t,i){var r=Math.sin(t);t=Math.cos(t);var s=e[4],a=e[5],n=e[6],o=e[7],h=e[8],l=e[9],u=e[10],c=e[11];return i?e!=i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[4]=s*t+h*r,i[5]=a*t+l*r,i[6]=n*t+u*r,i[7]=o*t+c*r,i[8]=s*-r+h*t,i[9]=a*-r+l*t,i[10]=n*-r+u*t,i[11]=o*-r+c*t,i},rotateY:function(e,t,i){var r=Math.sin(t);t=Math.cos(t);var s=e[0],a=e[1],n=e[2],o=e[3],h=e[8],l=e[9],u=e[10],c=e[11];return i?e!=i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[0]=s*t+h*-r,i[1]=a*t+l*-r,i[2]=n*t+u*-r,i[3]=o*t+c*-r,i[8]=s*r+h*t,i[9]=a*r+l*t,i[10]=n*r+u*t,i[11]=o*r+c*t,i},rotateZ:function(e,t,i){var r=Math.sin(t);t=Math.cos(t);var s=e[0],a=e[1],n=e[2],o=e[3],h=e[4],l=e[5],u=e[6],c=e[7];return i?e!=i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]):i=e,i[0]=s*t+h*r,i[1]=a*t+l*r,i[2]=n*t+u*r,i[3]=o*t+c*r,i[4]=s*-r+h*t,i[5]=a*-r+l*t,i[6]=n*-r+u*t,i[7]=o*-r+c*t,i},frustum:function(e,t,i,r,s,a,n){n||(n=o.create());var h=t-e,l=r-i,u=a-s;return n[0]=2*s/h,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*s/l,n[6]=0,n[7]=0,n[8]=(t+e)/h,n[9]=(r+i)/l,n[10]=-(a+s)/u,n[11]=-1,n[12]=0,n[13]=0,n[14]=-a*s*2/u,n[15]=0,n},perspective:function(e,t,i,r,s){return t*=e=i*Math.tan(e*Math.PI/360),o.frustum(-t,t,-e,e,i,r,s)},ortho:function(e,t,i,r,s,a,n){n||(n=o.create());var h=t-e,l=r-i,u=a-s;return n[0]=2/h,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/u,n[11]=0,n[12]=-(e+t)/h,n[13]=-(r+i)/l,n[14]=-(a+s)/u,n[15]=1,n},lookAt:function(e,t,i,r){r||(r=o.create());var s=e[0],a=e[1];e=e[2];var n=i[0],h=i[1],l=i[2];i=t[1];var u,c,d,p,f=t[2];return s==t[0]&&a==i&&e==f?o.identity(r):(i=s-t[0],f=a-t[1],t=e-t[2],u=h*(t*=p=1/Math.sqrt(i*i+f*f+t*t))-l*(f*=p),l=l*(i*=p)-n*t,n=n*f-h*i,(p=Math.sqrt(u*u+l*l+n*n))?(u*=p=1/p,l*=p,n*=p):n=l=u=0,h=f*n-t*l,c=t*u-i*n,d=i*l-f*u,(p=Math.sqrt(h*h+c*c+d*d))?(h*=p=1/p,c*=p,d*=p):d=c=h=0,r[0]=u,r[1]=h,r[2]=i,r[3]=0,r[4]=l,r[5]=c,r[6]=f,r[7]=0,r[8]=n,r[9]=d,r[10]=t,r[11]=0,r[12]=-(u*s+l*a+n*e),r[13]=-(h*s+c*a+d*e),r[14]=-(i*s+f*a+t*e),r[15]=1,r)},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(2),s=i(3),a=r.a,n=s.a,o={useCredentials:!1,instanceCounter:0,validateBool:function(e,t){return"boolean"==typeof e?e:t},validateNumber:function(e,t,i,r){return"number"==typeof e?a.clamp(e,t,i):r},validateNumberArray:function(e,t,i,r,s){if(Array.isArray(e)&&e.length==t){for(var n=0;n<t;n++)e[n]=a.clamp(e[n],i[n],r[n]);return e}return s},validateString:function(e,t){return"string"==typeof e?e:t},padNumber:function(e,t){return e<0?(t--,(e=-e+"").length>=t?"-"+e:"-"+(new Array(t-e.length+1).join("0")+e)):(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e},decodeFloat16:function(e){var t=(31744&e)>>10,i=1023&e;return(e>>15?-1:1)*(t?31===t?i?NaN:1/0:Math.pow(2,t-15)*(1+i/1024):i/1024*6103515625e-14)},simpleFmtObj:function(e,t){return e&&""!=e?e.replace(/\{([$a-zA-Z0-9][$a-zA-Z0-9]*)\}/g,(function(e,i){return i in t?t[i]:e})):""},simpleWikiLinks:function(e,t){return e&&""!=e?o.simpleFmtObj(e,{copy:"&copy;",Y:(new Date).getFullYear()}).replace(/\[([^\]]*)\]/g,(function(e,i){var r=(i=i.trim()).split(" ");return-1!=r[0].indexOf("//")?t?r.length>1?""+i.substring(r[0].length):""+r[0]:r.length>1?"<a href="+r[0]+' target="blank">'+i.substring(r[0].length)+"</a>":"<a href="+r[0]+' target="blank">'+r[0]+"</a>":i})):""},simpleFmtObjOrCall:function(e,t,i){return e&&""!=e?e.replace(/\{([$a-zA-Z(-9][$a-zA-Z(-9]*)\}/g,(function(e,r){return r in t?t[r]:i(r)})):""},getABGRFromHexaCode:function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[4],16),parseInt(t[3],16),parseInt(t[2],16),parseInt(t[1],16)]:[0,0,0,255]},stringifyFunction:function(e){return"("+e+").call(self);"},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},fitToPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},getHash:function(e){if(!e||0===e.length)return 0;for(var t=0,i=0,r=e.length;i<r;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t},convertRGB2YCbCr:function(e,t,i){return[.299*e+.587*t+.114*i+0,-.169*e+-.331*t+.5*i+128,.5*e+-.419*t+-.081*i+128]},convertYCbCr2RGB:function(e,t,i){return[1*e+0*(t-128)+1.4*(i-128),1*e+-.343*(t-128)+-.711*(i-128),1*e+1.765*(t-128)+0*(i-128)]},convertHSL2RGB:function(e,t,i){var r,s,a,n,o,h;return(e/=60)<0&&(e=6- -e%6),e%=6,t=Math.max(0,Math.min(1,t/100)),i=Math.max(0,Math.min(1,i/100)),h=(o=(1-Math.abs(2*i-1))*t)*(1-Math.abs(e%2-1)),e<1?(r=o,s=h,a=0):e<2?(r=h,s=o,a=0):e<3?(r=0,s=o,a=h):e<4?(r=0,s=h,a=o):e<5?(r=h,s=0,a=o):(r=o,s=0,a=h),[r+(n=i-o/2),s+n,a+n]},getHashColor:function(e){var t=o.getHash(e),i=o.convertRGB2YCbCr(255&t,t>>8&255,t>>16&255);return i[0]=a.clamp(i[0],50,200),o.convertRGB2YCbCr(i[0],i[1],i[2])},getHashColor2:function(e){var t=Math.floor(e/18),i=50;return t>=1&&(i=t%2?50+10*i%30:50-10*(i-1)%30),t=e%18*20,o.convertHSL2RGB(t,100,i)},loadText:function(e,t,i,r,s){o.loadJSON(e,t,i,!0,r,s)},loadXML:function(e,t,i,r,s){o.loadJSON(e,(function(e){e=(new DOMParser).parseFromString(e,"text/xml"),t&&t(e)}),i,!0,r,s)},loadJSON:function(e,t,i,r,s,a){var n=new XMLHttpRequest;n.onreadystatechange=function(){switch(n.readyState){case 0:case 1:case 2:case 3:break;case 4:if(n.status>=400||0==n.status){i&&i(n.status);break}var s=n.response,a=s;if(!r)try{a=JSON.parse(s)}catch(t){return console.log("JSON Parse Error ("+e+"): "+(t.message?t.message:"")),void(i&&i(n.status))}t&&t(a)}}.bind(this),n.open("GET",e,!0),n.withCredentials=s,a&&a.token&&n.setRequestHeader("Accept","token/"+a.token+", */*"),a&&a.charset&&n.overrideMimeType("text/xml; charset="+a.charset),n.send("")},loadBinary:function(e,t,i,r,s,a){var n=new XMLHttpRequest;n.onreadystatechange=function(){switch(n.readyState){case 0:case 1:case 2:case 3:break;case 4:if(n.status>=400||0==n.status){i&&i(n.status);break}var e=n.response;if(!e){i&&i();break}t&&t(e);break;default:i&&i()}}.bind(this),n.open("GET",e,!0),n.responseType=a||"arraybuffer",n.withCredentials=r,s&&s.token&&n.setRequestHeader("Accept","token/"+s.token+", */*"),n.send("")},headRequest:function(e,t,i,r,s){var a=new XMLHttpRequest;a.onreadystatechange=function(){switch(a.readyState){case 0:case 1:case 2:case 3:break;case 4:null!=t&&t(a.getAllResponseHeaders(),a.status);break;default:null!=i&&i()}}.bind(this),a.onerror=function(){null!=i&&i()}.bind(this),a.open("HEAD",e,!0),a.withCredentials=r,s&&s.token&&a.setRequestHeader("Accept","token/"+s.token+", */*"),a.send("")},loadImage:function(e,t,i,r,s){var a=new Image;return a.onerror=i,a.onload=t,s||(a.crossOrigin=r?"use-credentials":"anonymous"),a.src=e,a},getParamsFromUrl:function(e){return n.getParamsFromUrl(e)}},h="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;o.unint8ArrayToString=function(e){if(h)return h.decode(e);var t="",i=new Uint8Array(e.byteLength);i.set(e);for(var r=new Uint32Array(i.buffer),s=0,a=r.length;s<a;++s){var n=r[s];n<=65535?t+=String.fromCharCode(n):(n-=65536,t+=String.fromCharCode(55296+(n>>10),56320+(1023&n)))}return t}},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(0).b,s={isEqual:function(e,t,i){return Math.abs(e-t)<i},clamp:function(e,t,i){return e<t?e=t:e>i&&(e=i),e},radians:function(e){return e*Math.PI/180},degrees:function(e){return e/Math.PI*180},mix:function(e,t,i){return e+(t-e)*i},frustumMatrix:function(e,t,i,s,a,n){var o=t-e,h=s-i,l=n-a,u=r.create([2*a/o,0,(t+e)/o,0,0,2*a/h,(s+i)/h,0,0,0,-(n+a)/l,-2*n*a/l,0,0,-1,0]);return r.transpose(u),u},perspectiveMatrix:function(e,t,i,r){var a=i*Math.tan(e*Math.PI/180),n=a*t;return s.frustumMatrix(-n,n,-a,a,i,r)},orthographicMatrix:function(e,t,i,s){var a=.5*e*t,n=.5*e,o=s-i,h=r.create([1/a,0,0,0,0,1/n,0,0,0,0,-2/o,-(s+i)/o,0,0,0,1]);return r.transpose(h),h},rotationMatrix:function(e,t){var i=Math.cos(t),r=Math.sin(t);switch(e){case 0:return[1,0,0,0,0,i,r,0,0,-r,i,0,0,0,0,1];case 1:return[i,0,r,0,0,1,0,0,-r,0,i,0,0,0,0,1];default:return[i,r,0,0,-r,i,0,0,0,0,1,0,0,0,0,1]}},scaleMatrix:function(e,t,i){return[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]},scaleMatrixf:function(e){return s.scaleMatrix(e,e,e)},translationMatrix:function(e,t,i){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1]},translationMatrix2f:function(e){return s.translationMatrix(e[0],e[1],0)},translationMatrix3f:function(e){return s.translationMatrix(e[0],e[1],e[2])}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var r={isSameOrigin:function(e){if("string"!=typeof e)return!1;var t=document.location.hostname;return r.parse(e).hostname===t},parse:function(e){if("string"!=typeof e)return null;var t=document.createElement("a");return t.href=e,t},getParamsFromUrl:function(e){var t={},i=r.parse(e).search.substring(1).split("&");if(1!=i.length||""!=i[0])for(var s=0;s<i.length;s++){var a=i[s].split("=");if(void 0===t[a[0]])t[a[0]]=a[1];else if("string"==typeof t[a[0]]){var n=[t[a[0]],a[1]];t[a[0]]=n}else t[a[0]].push(a[1])}return t},getHost:function(e){var t=document.createElement("a");return t.href=e,t.hostname},getSchema:function(e){if(-1!=e.indexOf("http://"))return"http:";if(-1!=e.indexOf("https://"))return"https:";var t=document.createElement("a");return t.href=e,t.protocol},getOrigin:function(e){var t=document.createElement("a");return t.href=e,t.origin?t.origin:t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")},getBase:function(e){return e.split("?")[0].split("/").slice(0,-1).join("/")+"/"},makeAbsolute:function(e){var t=document.createElement("a");return t.href=e,t.href},getProcessUrl:function(e,t){if(!e||!t)return e;e=e.trim(),t=t.trim();var i=r.getBase(t),s=r.getSchema(t),a=r.getOrigin(t);return-1!=e.indexOf("://")?e:0==e.indexOf("//")?s+e:0==e.indexOf("/")?a+e:i+e}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var r={initialized:!1,init:function(){var e=r;e.browser=e.searchString(e.dataBrowser)||"An unknown browser",e.version=e.searchVersion(navigator.userAgent.toLowerCase())||e.searchVersion(navigator.appVersion)||"an unknown version",e.OS=e.searchString(e.dataOS)||"an unknown os: ua: "+navigator.userAgent+" pl: "+navigator.platform,e.mobile="iphone/ipod"==e.OS||"android"==e.OS||"ipad"==e.OS||"windows ce"==e.OS||"windows phone"==e.OS||"kindle"==e.OS,e.mobileAndroid="android"==e.OS,e.initialized=!0},getBrowser:function(){return r.initialized||r.init(),r.browser},getBrowserVersion:function(){return r.initialized||r.init(),r.browser},getOS:function(){return r.initialized||r.init(),r.OS},isMobile:function(){return r.initialized||r.init(),r.mobile},isAndroid:function(){return r.initialized||r.init(),r.mobileAndroid},searchString:function(e){for(var t=r,i=0;i<e.length;i++){var s=e[i].string,a=e[i].prop;if(t.versionSearchString=e[i].versionSearch||e[i].identity,s){if(-1!=s.toLowerCase().indexOf(e[i].subString))return null!=e[i].version&&(t.version=e[i].version),e[i].identity}else if(a)return e[i].identity}},searchVersion:function(e){var t=r;if(null!=t.version)return t.version;var i=e.indexOf(t.versionSearchString);return-1!=i?parseFloat(e.substring(i+t.versionSearchString.length+1)):void 0},dataBrowser:[{string:navigator.userAgent,subString:"chrome",identity:"chrome"},{string:navigator.userAgent,subString:"firefox",identity:"firefox"},{string:navigator.vendor,subString:"apple",identity:"safari",versionSearch:"version"},{prop:window.opera,identity:"opera",versionSearch:"version"},{string:navigator.vendor,subString:"icab",identity:"icab"},{string:navigator.vendor,subString:"kde",identity:"konqueror"},{string:navigator.vendor,subString:"camino",identity:"camino"},{string:navigator.userAgent,subString:"netscape",identity:"netscape"},{string:navigator.userAgent,subString:"msie",identity:"explorer",versionSearch:"msie"},{string:navigator.userAgent,subString:"trident/",identity:"explorer",version:"11"},{string:navigator.userAgent,subString:"edge/",identity:"explorer",version:"12"},{string:navigator.userAgent,subString:"omniweb",versionSearch:"omniweb/",identity:"omniweb"},{string:navigator.userAgent,subString:"silk",versionSearch:"silk/",identity:"silk"},{string:navigator.userAgent,subString:"gecko",identity:"mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"mozilla",identity:"netscape",versionSearch:"mozilla"}],dataOS:[{string:navigator.userAgent,subString:"windows ce",identity:"windows ce"},{string:navigator.userAgent,subString:"windows phone",identity:"windows phone"},{string:navigator.platform,subString:"win",identity:"windows"},{string:navigator.platform,subString:"mac",identity:"mac"},{string:navigator.userAgent,subString:"iphone",identity:"iphone/ipod"},{string:navigator.userAgent,subString:"ipod",identity:"iphone/ipod"},{string:navigator.userAgent,subString:"ipad",identity:"ipad"},{string:navigator.userAgent,subString:"android",identity:"android"},{string:navigator.userAgent,subString:"silk",identity:"kindle"},{string:navigator.userAgent,subString:"blackberry",identity:"blackberry"},{string:navigator.platform,subString:"linux",identity:"linux"}]}},function(e,t,i){var r,s,a;(a={}).Constants={},a.Math={},a.Accumulator={},function(e){"use strict";e.WGS84={a:6378137,f:1/298.257223563},e.version={major:1,minor:51,patch:0},e.version_string="1.51"}(a.Constants),function(e){"use strict";e.digits=53,e.epsilon=Math.pow(.5,e.digits-1),e.degree=Math.PI/180,e.sq=function(e){return e*e},e.hypot=Math.hypot||function(e,t){var i,r;return e=Math.abs(e),t=Math.abs(t),i=Math.max(e,t),r=Math.min(e,t)/(i||1),i*Math.sqrt(1+r*r)},e.cbrt=Math.cbrt||function(e){var t=Math.pow(Math.abs(e),1/3);return e>0?t:e<0?-t:e},e.log1p=Math.log1p||function(e){var t=1+e,i=t-1;return 0===i?e:e*Math.log(t)/i},e.atanh=Math.atanh||function(t){var i=Math.abs(t);return i=e.log1p(2*i/(1-i))/2,t>0?i:t<0?-i:t},e.copysign=function(e,t){return Math.abs(e)*(t<0||0===t&&1/t<0?-1:1)},e.sum=function(e,t){var i=e+t,r=i-t,s=i-r;return{s:i,t:-((r-=e)+(s-=t))}},e.polyval=function(e,t,i,r){for(var s=e<0?0:t[i++];--e>=0;)s=s*r+t[i++];return s},e.AngRound=function(e){if(0===e)return e;var t=1/16,i=Math.abs(e);return i=i<t?t-(t-i):i,e<0?-i:i},e.remainder=function(e,t){return(e%=t)<-t/2?e+t:e<t/2?e:e-t},e.AngNormalize=function(t){return-180==(t=e.remainder(t,360))?180:t},e.LatFix=function(e){return Math.abs(e)>90?Number.NaN:e},e.AngDiff=function(t,i){var r=e.sum(e.AngNormalize(-t),e.AngNormalize(i)),s=e.AngNormalize(r.s),a=r.t;return e.sum(180===s&&a>0?-180:s,a)},e.sincosd=function(e){var t,i,r,s,a,n;switch(t=e%360,t-=90*(i=0+Math.round(t/90)),t*=this.degree,r=Math.sin(t),s=Math.cos(t),3&i){case 0:a=r,n=s;break;case 1:a=s,n=-r;break;case 2:a=-r,n=-s;break;default:a=-s,n=r}return 0!==e&&(a+=0,n+=0),{s:a,c:n}},e.atan2d=function(e,t){var i,r,s=0;switch(Math.abs(e)>Math.abs(t)&&(i=t,t=e,e=i,s=2),t<0&&(t=-t,++s),r=Math.atan2(e,t)/this.degree,s){case 1:r=(e>=0?180:-180)-r;break;case 2:r=90-r;break;case 3:r=-90+r}return r}}(a.Math),function(e,t){"use strict";e.Accumulator=function(e){this.Set(e)},e.Accumulator.prototype.Set=function(t){t||(t=0),t.constructor===e.Accumulator?(this._s=t._s,this._t=t._t):(this._s=t,this._t=0)},e.Accumulator.prototype.Add=function(e){var i=t.sum(e,this._t),r=t.sum(i.s,this._s);i=i.t,this._s=r.s,this._t=r.t,0===this._s?this._s=i:this._t+=i},e.Accumulator.prototype.Sum=function(t){var i;return t?((i=new e.Accumulator(this)).Add(t),i._s):this._s},e.Accumulator.prototype.Negate=function(){this._s*=-1,this._t*=-1},e.Accumulator.prototype.Remainder=function(e){this._s=t.remainder(this._s,e),this.Add(0)}}(a.Accumulator,a.Math),a.Geodesic={},a.GeodesicLine={},a.PolygonArea={},function(e,t,i,r,s){"use strict";var a,n,o,h,l,u,c,d,p,f,g,m=20+r.digits+10,v=r.epsilon,y=200*v,b=Math.sqrt(v),x=v*y,w=1e3*b;e.tiny_=Math.sqrt(Number.MIN_VALUE),e.nC1_=6,e.nC1p_=6,e.nC2_=6,e.nC3_=6,e.nC4_=6,a=e.nC3_*(e.nC3_-1)/2,n=e.nC4_*(e.nC4_+1)/2,e.CAP_C1=1,e.CAP_C1p=2,e.CAP_C2=4,e.CAP_C3=8,e.CAP_C4=16,e.NONE=0,e.ARC=64,e.LATITUDE=128,e.LONGITUDE=256|e.CAP_C3,e.AZIMUTH=512,e.DISTANCE=1024|e.CAP_C1,e.STANDARD=e.LATITUDE|e.LONGITUDE|e.AZIMUTH|e.DISTANCE,e.DISTANCE_IN=2048|e.CAP_C1|e.CAP_C1p,e.REDUCEDLENGTH=4096|e.CAP_C1|e.CAP_C2,e.GEODESICSCALE=8192|e.CAP_C1|e.CAP_C2,e.AREA=16384|e.CAP_C4,e.ALL=32671,e.LONG_UNROLL=32768,e.OUT_MASK=32640|e.LONG_UNROLL,e.SinCosSeries=function(e,t,i,r){var s=r.length,a=s-(e?1:0),n=2*(i-t)*(i+t),o=1&a?r[--s]:0,h=0;for(a=Math.floor(a/2);a--;)o=n*(h=n*o-h+r[--s])-o+r[--s];return e?2*t*i*o:i*(o-h)},o=function(e,t){var i,s,a,n,o,h,l,u,c,d,p,f,g=r.sq(e),m=r.sq(t),v=(g+m-1)/6;return 0===m&&v<=0?i=0:(h=v,(o=(s=g*m/4)*(s+2*(n=v*(a=r.sq(v)))))>=0?(l=s+n,l+=l<0?-Math.sqrt(o):Math.sqrt(o),h+=(u=r.cbrt(l))+(0!==u?a/u:0)):(c=Math.atan2(Math.sqrt(-o),-(s+n)),h+=2*v*Math.cos(c/3)),d=Math.sqrt(r.sq(h)+m),f=((p=h<0?m/(d-h):h+d)-m)/(2*d),i=p/(Math.sqrt(p+r.sq(f))+f)),i},h=[1,4,64,0,256],e.A1m1f=function(e){var t=Math.floor(3);return(r.polyval(t,h,0,r.sq(e))/h[t+1]+e)/(1-e)},l=[-1,6,-16,32,-9,64,-128,2048,9,-16,768,3,-5,512,-7,1280,-7,2048],e.C1f=function(t,i){var s,a,n=r.sq(t),o=t,h=0;for(s=1;s<=e.nC1_;++s)a=Math.floor((e.nC1_-s)/2),i[s]=o*r.polyval(a,l,h,n)/l[h+a+1],h+=a+2,o*=t},u=[205,-432,768,1536,4005,-4736,3840,12288,-225,116,384,-7173,2695,7680,3467,7680,38081,61440],e.C1pf=function(t,i){var s,a,n=r.sq(t),o=t,h=0;for(s=1;s<=e.nC1p_;++s)a=Math.floor((e.nC1p_-s)/2),i[s]=o*r.polyval(a,u,h,n)/u[h+a+1],h+=a+2,o*=t},c=[-11,-28,-192,0,256],e.A2m1f=function(e){var t=Math.floor(3);return(r.polyval(t,c,0,r.sq(e))/c[t+1]-e)/(1+e)},d=[1,2,16,32,35,64,384,2048,15,80,768,7,35,512,63,1280,77,2048],e.C2f=function(t,i){var s,a,n=r.sq(t),o=t,h=0;for(s=1;s<=e.nC2_;++s)a=Math.floor((e.nC2_-s)/2),i[s]=o*r.polyval(a,d,h,n)/d[h+a+1],h+=a+2,o*=t},e.Geodesic=function(e,t){if(this.a=e,this.f=t,this._f1=1-this.f,this._e2=this.f*(2-this.f),this._ep2=this._e2/r.sq(this._f1),this._n=this.f/(2-this.f),this._b=this.a*this._f1,this._c2=(r.sq(this.a)+r.sq(this._b)*(0===this._e2?1:(this._e2>0?r.atanh(Math.sqrt(this._e2)):Math.atan(Math.sqrt(-this._e2)))/Math.sqrt(Math.abs(this._e2))))/2,this._etol2=.1*b/Math.sqrt(Math.max(.001,Math.abs(this.f))*Math.min(1,1-this.f/2)/2),!(isFinite(this.a)&&this.a>0))throw new Error("Equatorial radius is not positive");if(!(isFinite(this._b)&&this._b>0))throw new Error("Polar semi-axis is not positive");this._A3x=new Array(6),this._C3x=new Array(a),this._C4x=new Array(n),this.A3coeff(),this.C3coeff(),this.C4coeff()},p=[-3,128,-2,-3,64,-1,-3,-1,16,3,-1,-2,8,1,-1,2,1,1],e.Geodesic.prototype.A3coeff=function(){var e,t,i=0,s=0;for(e=5;e>=0;--e)t=Math.min(6-e-1,e),this._A3x[s++]=r.polyval(t,p,i,this._n)/p[i+t+1],i+=t+2},f=[3,128,2,5,128,-1,3,3,64,-1,0,1,8,-1,1,4,5,256,1,3,128,-3,-2,3,64,1,-3,2,32,7,512,-10,9,384,5,-9,5,192,7,512,-14,7,512,21,2560],e.Geodesic.prototype.C3coeff=function(){var t,i,s,a=0,n=0;for(t=1;t<e.nC3_;++t)for(i=e.nC3_-1;i>=t;--i)s=Math.min(e.nC3_-i-1,i),this._C3x[n++]=r.polyval(s,f,a,this._n)/f[a+s+1],a+=s+2},g=[97,15015,1088,156,45045,-224,-4784,1573,45045,-10656,14144,-4576,-858,45045,64,624,-4576,6864,-3003,15015,100,208,572,3432,-12012,30030,45045,1,9009,-2944,468,135135,5792,1040,-1287,135135,5952,-11648,9152,-2574,135135,-64,-624,4576,-6864,3003,135135,8,10725,1856,-936,225225,-8448,4992,-1144,225225,-1440,4160,-4576,1716,225225,-136,63063,1024,-208,105105,3584,-3328,1144,315315,-128,135135,-2560,832,405405,128,99099],e.Geodesic.prototype.C4coeff=function(){var t,i,s,a=0,n=0;for(t=0;t<e.nC4_;++t)for(i=e.nC4_-1;i>=t;--i)s=e.nC4_-i-1,this._C4x[n++]=r.polyval(s,g,a,this._n)/g[a+s+1],a+=s+2},e.Geodesic.prototype.A3f=function(e){return r.polyval(5,this._A3x,0,e)},e.Geodesic.prototype.C3f=function(t,i){var s,a,n=1,o=0;for(s=1;s<e.nC3_;++s)a=e.nC3_-s-1,n*=t,i[s]=n*r.polyval(a,this._C3x,o,t),o+=a+1},e.Geodesic.prototype.C4f=function(t,i){var s,a,n=1,o=0;for(s=0;s<e.nC4_;++s)a=e.nC4_-s-1,i[s]=n*r.polyval(a,this._C4x,o,t),o+=a+1,n*=t},e.Geodesic.prototype.Lengths=function(t,i,r,s,a,n,o,h,l,u,c,d,p){var f,g,m,v,y={},b=0,x=0,w=0,M=0;if((c&=e.OUT_MASK)&(e.DISTANCE|e.REDUCEDLENGTH|e.GEODESICSCALE)&&(w=e.A1m1f(t),e.C1f(t,d),c&(e.REDUCEDLENGTH|e.GEODESICSCALE)&&(M=e.A2m1f(t),e.C2f(t,p),b=w-M,M=1+M),w=1+w),c&e.DISTANCE)f=e.SinCosSeries(!0,n,o,d)-e.SinCosSeries(!0,r,s,d),y.s12b=w*(i+f),c&(e.REDUCEDLENGTH|e.GEODESICSCALE)&&(x=b*i+(w*f-M*(e.SinCosSeries(!0,n,o,p)-e.SinCosSeries(!0,r,s,p))));else if(c&(e.REDUCEDLENGTH|e.GEODESICSCALE)){for(g=1;g<=e.nC2_;++g)p[g]=w*d[g]-M*p[g];x=b*i+(e.SinCosSeries(!0,n,o,p)-e.SinCosSeries(!0,r,s,p))}return c&e.REDUCEDLENGTH&&(y.m0=b,y.m12b=h*(s*n)-a*(r*o)-s*o*x),c&e.GEODESICSCALE&&(m=s*o+r*n,v=this._ep2*(l-u)*(l+u)/(a+h),y.M12=m+(v*n-o*x)*r/a,y.M21=m-(v*r-s*x)*n/h),y},e.Geodesic.prototype.InverseStart=function(t,i,s,a,n,h,l,u,c,d,p){var f,g,m,v,b,x,M,S,A,C,T,P,F,L,E,k,N,I,B,R,z={},U=a*i-n*t,D=n*i+a*t;return z.sig12=-1,f=a*i,f+=n*t,(g=D>=0&&U<.5&&n*l<.5)?(v=r.sq(t+a),v/=v+r.sq(i+n),z.dnm=Math.sqrt(1+this._ep2*v),m=l/(this._f1*z.dnm),b=Math.sin(m),x=Math.cos(m)):(b=u,x=c),z.salp1=n*b,z.calp1=x>=0?U+n*t*r.sq(b)/(1+x):f-n*t*r.sq(b)/(1-x),S=r.hypot(z.salp1,z.calp1),A=t*a+i*n*x,g&&S<this._etol2?(z.salp2=i*b,z.calp2=U-i*a*(x>=0?r.sq(b)/(1+x):1-x),M=r.hypot(z.salp2,z.calp2),z.salp2/=M,z.calp2/=M,z.sig12=Math.atan2(S,A)):Math.abs(this._n)>.1||A>=0||S>=6*Math.abs(this._n)*Math.PI*r.sq(i)||(R=Math.atan2(-u,-c),this.f>=0?(L=(F=r.sq(t)*this._ep2)/(2*(1+Math.sqrt(1+F))+F),C=R/(P=this.f*i*this.A3f(L)*Math.PI),T=f/(P*i)):(E=n*i-a*t,k=Math.atan2(f,E),T=l/(P=((C=(N=this.Lengths(this._n,Math.PI+k,t,-i,s,a,n,h,i,n,e.REDUCEDLENGTH,d,p)).m12b/(i*n*N.m0*Math.PI)-1)<-.01?f/C:-this.f*r.sq(i)*Math.PI)/i)),T>-y&&C>-1-w?this.f>=0?(z.salp1=Math.min(1,-C),z.calp1=-Math.sqrt(1-r.sq(z.salp1))):(z.calp1=Math.max(C>-y?0:-1,C),z.salp1=Math.sqrt(1-r.sq(z.calp1))):(I=o(C,T),B=P*(this.f>=0?-C*I/(1+I):-T*(1+I)/I),b=Math.sin(B),x=-Math.cos(B),z.salp1=n*b,z.calp1=f-n*t*r.sq(b)/(1-x))),z.salp1<=0?(z.salp1=1,z.calp1=0):(M=r.hypot(z.salp1,z.calp1),z.salp1/=M,z.calp1/=M),z},e.Geodesic.prototype.Lambda12=function(t,i,s,a,n,o,h,l,u,c,d,p,f,g){var m,v,y,b,x,w,M,S,A,C,T,P,F,L={};return 0===t&&0===l&&(l=-e.tiny_),v=h*i,y=r.hypot(l,h*t),L.ssig1=t,b=v*t,L.csig1=x=l*i,m=r.hypot(L.ssig1,L.csig1),L.ssig1/=m,L.csig1/=m,L.salp2=n!==i?v/n:h,L.calp2=n!==i||Math.abs(a)!==-t?Math.sqrt(r.sq(l*i)+(i<-t?(n-i)*(i+n):(t-a)*(t+a)))/n:Math.abs(l),L.ssig2=a,w=v*a,L.csig2=M=L.calp2*n,m=r.hypot(L.ssig2,L.csig2),L.ssig2/=m,L.csig2/=m,L.sig12=Math.atan2(Math.max(0,L.csig1*L.ssig2-L.ssig1*L.csig2),L.csig1*L.csig2+L.ssig1*L.ssig2),S=Math.max(0,x*w-b*M),A=x*M+b*w,T=Math.atan2(S*c-A*u,A*c+S*u),P=r.sq(y)*this._ep2,L.eps=P/(2*(1+Math.sqrt(1+P))+P),this.C3f(L.eps,g),C=e.SinCosSeries(!0,L.ssig2,L.csig2,g)-e.SinCosSeries(!0,L.ssig1,L.csig1,g),L.domg12=-this.f*this.A3f(L.eps)*v*(L.sig12+C),L.lam12=T+L.domg12,d&&(0===L.calp2?L.dlam12=-2*this._f1*s/t:(F=this.Lengths(L.eps,L.sig12,L.ssig1,L.csig1,s,L.ssig2,L.csig2,o,i,n,e.REDUCEDLENGTH,p,f),L.dlam12=F.m12b,L.dlam12*=this._f1/(L.calp2*n))),L},e.Geodesic.prototype.Inverse=function(t,i,s,a,n){var o,h;return n||(n=e.STANDARD),n===e.LONG_UNROLL&&(n|=e.STANDARD),n&=e.OUT_MASK,h=(o=this.InverseInt(t,i,s,a,n)).vals,n&e.AZIMUTH&&(h.azi1=r.atan2d(o.salp1,o.calp1),h.azi2=r.atan2d(o.salp2,o.calp2)),h},e.Geodesic.prototype.InverseInt=function(t,i,s,a,n){var o,h,l,u,c,d,p,f,g,y,b,w,M,S,A,C,T,P,F,L,E,k,N,I,B,R,z,U,D,_,O,G,V,j,H,W,q,Z,Y,J,K,Q,X,$,ee,te,ie,re,se,ae,ne,oe,he,le,ue,ce,de,pe,fe,ge,me,ve,ye,be,xe,we={};if(we.lat1=t=r.LatFix(t),we.lat2=s=r.LatFix(s),t=r.AngRound(t),s=r.AngRound(s),h=(o=r.AngDiff(i,a)).t,o=o.s,n&e.LONG_UNROLL?(we.lon1=i,we.lon2=i+o+h):(we.lon1=r.AngNormalize(i),we.lon2=r.AngNormalize(a)),o=(l=o>=0?1:-1)*r.AngRound(o),h=r.AngRound(180-o-l*h),A=o*r.degree,C=(u=r.sincosd(o>90?h:o)).s,T=(o>90?-1:1)*u.c,(c=Math.abs(t)<Math.abs(s)?-1:1)<0&&(l*=-1,u=t,t=s,s=u),t*=d=t<0?1:-1,s*=d,u=r.sincosd(t),p=this._f1*u.s,f=u.c,p/=u=r.hypot(p,f),f/=u,f=Math.max(e.tiny_,f),u=r.sincosd(s),g=this._f1*u.s,y=u.c,g/=u=r.hypot(g,y),y/=u,y=Math.max(e.tiny_,y),f<-p?y===f&&(g=g<0?p:-p):Math.abs(g)===-p&&(y=f),M=Math.sqrt(1+this._ep2*r.sq(p)),S=Math.sqrt(1+this._ep2*r.sq(g)),N=new Array(e.nC1_+1),I=new Array(e.nC2_+1),B=new Array(e.nC3_),(R=-90===t||0===C)&&(L=C,k=0,U=p,D=(F=T)*f,_=g,O=(E=1)*y,P=Math.atan2(Math.max(0,D*_-U*O),D*O+U*_),b=(z=this.Lengths(this._n,P,U,D,M,_,O,S,f,y,n|e.DISTANCE|e.REDUCEDLENGTH,N,I)).s12b,w=z.m12b,n&e.GEODESICSCALE&&(we.M12=z.M12,we.M21=z.M21),P<1||w>=0?(P<3*e.tiny_&&(P=w=b=0),w*=this._b,b*=this._b,we.a12=P/r.degree):R=!1),de=2,!R&&0===p&&(this.f<=0||h>=180*this.f))F=E=0,L=k=1,b=this.a*A,P=V=A/this._f1,w=this._b*Math.sin(P),n&e.GEODESICSCALE&&(we.M12=we.M21=Math.cos(P)),we.a12=o/this._f1;else if(!R)if(P=(z=this.InverseStart(p,f,M,g,y,S,A,C,T,N,I)).sig12,L=z.salp1,F=z.calp1,P>=0)k=z.salp2,E=z.calp2,j=z.dnm,b=P*this._b*j,w=r.sq(j)*this._b*Math.sin(P/j),n&e.GEODESICSCALE&&(we.M12=we.M21=Math.cos(P/j)),we.a12=P/r.degree,V=A/(this._f1*j);else{for(H=0,W=e.tiny_,q=1,Z=e.tiny_,Y=-1,J=!1,K=!1;H<m&&(Q=(z=this.Lambda12(p,f,M,g,y,S,L,F,C,T,H<20,N,I,B)).lam12,k=z.salp2,E=z.calp2,P=z.sig12,U=z.ssig1,D=z.csig1,_=z.ssig2,O=z.csig2,G=z.eps,fe=z.domg12,X=z.dlam12,!K&&Math.abs(Q)>=(J?8:1)*v);++H)Q>0&&(H<20||F/L>Y/Z)?(Z=L,Y=F):Q<0&&(H<20||F/L<q/W)&&(W=L,q=F),H<20&&X>0&&($=-Q/X,ee=Math.sin($),(ie=L*(te=Math.cos($))+F*ee)>0&&Math.abs($)<Math.PI)?(F=F*te-L*ee,L=ie,L/=u=r.hypot(L,F),F/=u,J=Math.abs(Q)<=16*v):(L=(W+Z)/2,F=(q+Y)/2,L/=u=r.hypot(L,F),F/=u,J=!1,K=Math.abs(W-L)+(q-F)<x||Math.abs(L-Z)+(F-Y)<x);re=n|(n&(e.REDUCEDLENGTH|e.GEODESICSCALE)?e.DISTANCE:e.NONE),b=(z=this.Lengths(G,P,U,D,M,_,O,S,f,y,re,N,I)).s12b,w=z.m12b,n&e.GEODESICSCALE&&(we.M12=z.M12,we.M21=z.M21),w*=this._b,b*=this._b,we.a12=P/r.degree,n&e.AREA&&(be=Math.sin(fe),de=C*(xe=Math.cos(fe))-T*be,pe=T*xe+C*be)}return n&e.DISTANCE&&(we.s12=0+b),n&e.REDUCEDLENGTH&&(we.m12=0+w),n&e.AREA&&(se=L*f,0!==(ae=r.hypot(F,L*p))&&0!==se?(U=p,D=F*f,_=g,O=E*y,G=(oe=r.sq(ae)*this._ep2)/(2*(1+Math.sqrt(1+oe))+oe),he=r.sq(this.a)*ae*se*this._e2,U/=u=r.hypot(U,D),D/=u,_/=u=r.hypot(_,O),O/=u,le=new Array(e.nC4_),this.C4f(G,le),ue=e.SinCosSeries(!1,U,D,le),ce=e.SinCosSeries(!1,_,O,le),we.S12=he*(ce-ue)):we.S12=0,!R&&de>1&&(de=Math.sin(V),pe=Math.cos(V)),!R&&pe>-.7071&&g-p<1.75?(fe=1+pe,ge=1+f,me=1+y,ne=2*Math.atan2(de*(p*me+g*ge),fe*(p*g+ge*me))):(ye=E*F+k*L,0==(ve=k*F-E*L)&&ye<0&&(ve=e.tiny_*F,ye=-1),ne=Math.atan2(ve,ye)),we.S12+=this._c2*ne,we.S12*=c*l*d,we.S12+=0),c<0&&(u=L,L=k,k=u,u=F,F=E,E=u,n&e.GEODESICSCALE&&(u=we.M12,we.M12=we.M21,we.M21=u)),{vals:we,salp1:L*=c*l,calp1:F*=c*d,salp2:k*=c*l,calp2:E*=c*d}},e.Geodesic.prototype.GenDirect=function(i,r,s,a,n,o){return o?o===e.LONG_UNROLL&&(o|=e.STANDARD):o=e.STANDARD,a||(o|=e.DISTANCE_IN),new t.GeodesicLine(this,i,r,s,o).GenPosition(a,n,o)},e.Geodesic.prototype.Direct=function(e,t,i,r,s){return this.GenDirect(e,t,i,!1,r,s)},e.Geodesic.prototype.ArcDirect=function(e,t,i,r,s){return this.GenDirect(e,t,i,!0,r,s)},e.Geodesic.prototype.Line=function(e,i,r,s){return new t.GeodesicLine(this,e,i,r,s)},e.Geodesic.prototype.DirectLine=function(e,t,i,r,s){return this.GenDirectLine(e,t,i,!1,r,s)},e.Geodesic.prototype.ArcDirectLine=function(e,t,i,r,s){return this.GenDirectLine(e,t,i,!0,r,s)},e.Geodesic.prototype.GenDirectLine=function(i,r,s,a,n,o){var h;return o||(o=e.STANDARD|e.DISTANCE_IN),a||(o|=e.DISTANCE_IN),(h=new t.GeodesicLine(this,i,r,s,o)).GenSetDistance(a,n),h},e.Geodesic.prototype.InverseLine=function(i,s,a,n,o){var h,l,u;return o||(o=e.STANDARD|e.DISTANCE_IN),h=this.InverseInt(i,s,a,n,e.ARC),u=r.atan2d(h.salp1,h.calp1),o&e.OUT_MASK&e.DISTANCE_IN&&(o|=e.DISTANCE),(l=new t.GeodesicLine(this,i,s,u,o,h.salp1,h.calp1)).SetArc(h.vals.a12),l},e.Geodesic.prototype.Polygon=function(e){return new i.PolygonArea(this,e)},e.WGS84=new e.Geodesic(s.WGS84.a,s.WGS84.f)}(a.Geodesic,a.GeodesicLine,a.PolygonArea,a.Math,a.Constants),function(e,t,i){"use strict";t.GeodesicLine=function(t,r,s,a,n,o,h){var l,u,c,d,p,f;n||(n=e.STANDARD|e.DISTANCE_IN),this.a=t.a,this.f=t.f,this._b=t._b,this._c2=t._c2,this._f1=t._f1,this.caps=n|e.LATITUDE|e.AZIMUTH|e.LONG_UNROLL,this.lat1=i.LatFix(r),this.lon1=s,void 0===o||void 0===h?(this.azi1=i.AngNormalize(a),l=i.sincosd(i.AngRound(this.azi1)),this.salp1=l.s,this.calp1=l.c):(this.azi1=a,this.salp1=o,this.calp1=h),l=i.sincosd(i.AngRound(this.lat1)),c=this._f1*l.s,u=l.c,c/=l=i.hypot(c,u),u/=l,u=Math.max(e.tiny_,u),this._dn1=Math.sqrt(1+t._ep2*i.sq(c)),this._salp0=this.salp1*u,this._calp0=i.hypot(this.calp1,this.salp1*c),this._ssig1=c,this._somg1=this._salp0*c,this._csig1=this._comg1=0!==c||0!==this.calp1?u*this.calp1:1,l=i.hypot(this._ssig1,this._csig1),this._ssig1/=l,this._csig1/=l,this._k2=i.sq(this._calp0)*t._ep2,d=this._k2/(2*(1+Math.sqrt(1+this._k2))+this._k2),this.caps&e.CAP_C1&&(this._A1m1=e.A1m1f(d),this._C1a=new Array(e.nC1_+1),e.C1f(d,this._C1a),this._B11=e.SinCosSeries(!0,this._ssig1,this._csig1,this._C1a),p=Math.sin(this._B11),f=Math.cos(this._B11),this._stau1=this._ssig1*f+this._csig1*p,this._ctau1=this._csig1*f-this._ssig1*p),this.caps&e.CAP_C1p&&(this._C1pa=new Array(e.nC1p_+1),e.C1pf(d,this._C1pa)),this.caps&e.CAP_C2&&(this._A2m1=e.A2m1f(d),this._C2a=new Array(e.nC2_+1),e.C2f(d,this._C2a),this._B21=e.SinCosSeries(!0,this._ssig1,this._csig1,this._C2a)),this.caps&e.CAP_C3&&(this._C3a=new Array(e.nC3_),t.C3f(d,this._C3a),this._A3c=-this.f*this._salp0*t.A3f(d),this._B31=e.SinCosSeries(!0,this._ssig1,this._csig1,this._C3a)),this.caps&e.CAP_C4&&(this._C4a=new Array(e.nC4_),t.C4f(d,this._C4a),this._A4=i.sq(this.a)*this._calp0*this._salp0*t._e2,this._B41=e.SinCosSeries(!1,this._ssig1,this._csig1,this._C4a)),this.a13=this.s13=Number.NaN},t.GeodesicLine.prototype.GenPosition=function(t,r,s){var a,n,o,h,l,u,c,d,p,f,g,m,v,y,b,x,w,M,S,A,C,T,P,F,L,E,k={};return s?s===e.LONG_UNROLL&&(s|=e.STANDARD):s=e.STANDARD,s&=this.caps&e.OUT_MASK,k.lat1=this.lat1,k.azi1=this.azi1,k.lon1=s&e.LONG_UNROLL?this.lon1:i.AngNormalize(this.lon1),t?k.a12=r:k.s12=r,t||this.caps&e.DISTANCE_IN&e.OUT_MASK?(h=0,l=0,t?(a=r*i.degree,n=(P=i.sincosd(r)).s,o=P.c):(d=r/(this._b*(1+this._A1m1)),p=Math.sin(d),f=Math.cos(d),a=d-((h=-e.SinCosSeries(!0,this._stau1*f+this._ctau1*p,this._ctau1*f-this._stau1*p,this._C1pa))-this._B11),n=Math.sin(a),o=Math.cos(a),Math.abs(this.f)>.01&&(u=this._ssig1*o+this._csig1*n,c=this._csig1*o-this._ssig1*n,h=e.SinCosSeries(!0,u,c,this._C1a),a-=((1+this._A1m1)*(a+(h-this._B11))-r/this._b)/Math.sqrt(1+this._k2*i.sq(u)),n=Math.sin(a),o=Math.cos(a))),u=this._ssig1*o+this._csig1*n,c=this._csig1*o-this._ssig1*n,S=Math.sqrt(1+this._k2*i.sq(u)),s&(e.DISTANCE|e.REDUCEDLENGTH|e.GEODESICSCALE)&&((t||Math.abs(this.f)>.01)&&(h=e.SinCosSeries(!0,u,c,this._C1a)),l=(1+this._A1m1)*(h-this._B11)),v=this._calp0*u,0===(y=i.hypot(this._salp0,this._calp0*c))&&(y=c=e.tiny_),w=this._salp0,M=this._calp0*c,t&&s&e.DISTANCE&&(k.s12=this._b*((1+this._A1m1)*a+l)),s&e.LONGITUDE&&(b=this._salp0*u,x=c,m=i.copysign(1,this._salp0),g=((s&e.LONG_UNROLL?m*(a-(Math.atan2(u,c)-Math.atan2(this._ssig1,this._csig1))+(Math.atan2(m*b,x)-Math.atan2(m*this._somg1,this._comg1))):Math.atan2(b*this._comg1-x*this._somg1,x*this._comg1+b*this._somg1))+this._A3c*(a+(e.SinCosSeries(!0,u,c,this._C3a)-this._B31)))/i.degree,k.lon2=s&e.LONG_UNROLL?this.lon1+g:i.AngNormalize(i.AngNormalize(this.lon1)+i.AngNormalize(g))),s&e.LATITUDE&&(k.lat2=i.atan2d(v,this._f1*y)),s&e.AZIMUTH&&(k.azi2=i.atan2d(w,M)),s&(e.REDUCEDLENGTH|e.GEODESICSCALE)&&(A=e.SinCosSeries(!0,u,c,this._C2a),C=(1+this._A2m1)*(A-this._B21),T=(this._A1m1-this._A2m1)*a+(l-C),s&e.REDUCEDLENGTH&&(k.m12=this._b*(S*(this._csig1*u)-this._dn1*(this._ssig1*c)-this._csig1*c*T)),s&e.GEODESICSCALE&&(P=this._k2*(u-this._ssig1)*(u+this._ssig1)/(this._dn1+S),k.M12=o+(P*u-c*T)*this._ssig1/this._dn1,k.M21=o-(P*this._ssig1-this._csig1*T)*u/S)),s&e.AREA&&(F=e.SinCosSeries(!1,u,c,this._C4a),0===this._calp0||0===this._salp0?(L=w*this.calp1-M*this.salp1,E=M*this.calp1+w*this.salp1):(L=this._calp0*this._salp0*(o<=0?this._csig1*(1-o)+n*this._ssig1:n*(this._csig1*n/(1+o)+this._ssig1)),E=i.sq(this._salp0)+i.sq(this._calp0)*this._csig1*c),k.S12=this._c2*Math.atan2(L,E)+this._A4*(F-this._B41)),t||(k.a12=a/i.degree),k):(k.a12=Number.NaN,k)},t.GeodesicLine.prototype.Position=function(e,t){return this.GenPosition(!1,e,t)},t.GeodesicLine.prototype.ArcPosition=function(e,t){return this.GenPosition(!0,e,t)},t.GeodesicLine.prototype.GenSetDistance=function(e,t){e?this.SetArc(t):this.SetDistance(t)},t.GeodesicLine.prototype.SetDistance=function(t){var i;this.s13=t,i=this.GenPosition(!1,this.s13,e.ARC),this.a13=0+i.a12},t.GeodesicLine.prototype.SetArc=function(t){var i;this.a13=t,i=this.GenPosition(!0,this.a13,e.DISTANCE),this.s13=0+i.s12}}(a.Geodesic,a.GeodesicLine,a.Math),function(e,t,i,r){"use strict";var s,a,n,o;s=function(e,t){var r;return e=i.AngNormalize(e),t=i.AngNormalize(t),r=i.AngDiff(e,t).s,e<=0&&t>0&&r>0?1:t<=0&&e>0&&r<0?-1:0},a=function(e,t){return((t%=720)<=0&&t>-360||t>360?1:0)-((e%=720)<=0&&e>-360||e>360?1:0)},n=function(e,t,i,r,s){return e.Remainder(t),1&i&&e.Add((e.Sum()<0?1:-1)*t/2),r||e.Negate(),s?e.Sum()>t/2?e.Add(-t):e.Sum()<=-t/2&&e.Add(+t):e.Sum()>=t?e.Add(-t):e.Sum()<0&&e.Add(+t),0+e.Sum()},o=function(e,t,r,s,a){return e=i.remainder(e,t),1&r&&(e+=(e<0?1:-1)*t/2),s||(e*=-1),a?e>t/2?e-=t:e<=-t/2&&(e+=t):e>=t?e-=t:e<0&&(e+=t),0+e},e.PolygonArea=function(e,i){this._geod=e,this.a=this._geod.a,this.f=this._geod.f,this._area0=4*Math.PI*e._c2,this.polyline=i||!1,this._mask=t.LATITUDE|t.LONGITUDE|t.DISTANCE|(this.polyline?t.NONE:t.AREA|t.LONG_UNROLL),this.polyline||(this._areasum=new r.Accumulator(0)),this._perimetersum=new r.Accumulator(0),this.Clear()},e.PolygonArea.prototype.Clear=function(){this.num=0,this._crossings=0,this.polyline||this._areasum.Set(0),this._perimetersum.Set(0),this._lat0=this._lon0=this.lat=this.lon=Number.NaN},e.PolygonArea.prototype.AddPoint=function(e,t){var i;0===this.num?(this._lat0=this.lat=e,this._lon0=this.lon=t):(i=this._geod.Inverse(this.lat,this.lon,e,t,this._mask),this._perimetersum.Add(i.s12),this.polyline||(this._areasum.Add(i.S12),this._crossings+=s(this.lon,t)),this.lat=e,this.lon=t),++this.num},e.PolygonArea.prototype.AddEdge=function(e,t){var i;this.num&&(i=this._geod.Direct(this.lat,this.lon,e,t,this._mask),this._perimetersum.Add(t),this.polyline||(this._areasum.Add(i.S12),this._crossings+=a(this.lon,i.lon2)),this.lat=i.lat2,this.lon=i.lon2),++this.num},e.PolygonArea.prototype.Compute=function(e,t){var i,a,o={number:this.num};return this.num<2?(o.perimeter=0,this.polyline||(o.area=0),o):this.polyline?(o.perimeter=this._perimetersum.Sum(),o):(i=this._geod.Inverse(this.lat,this.lon,this._lat0,this._lon0,this._mask),o.perimeter=this._perimetersum.Sum(i.s12),(a=new r.Accumulator(this._areasum)).Add(i.S12),o.area=n(a,this._area0,this._crossings+s(this.lon,this._lon0),e,t),o)},e.PolygonArea.prototype.TestPoint=function(e,t,i,r){var a,n,h,l,u={number:this.num+1};if(0===this.num)return u.perimeter=0,this.polyline||(u.area=0),u;for(u.perimeter=this._perimetersum.Sum(),n=this.polyline?0:this._areasum.Sum(),h=this._crossings,l=0;l<(this.polyline?1:2);++l)a=this._geod.Inverse(0===l?this.lat:e,0===l?this.lon:t,0!==l?this._lat0:e,0!==l?this._lon0:t,this._mask),u.perimeter+=a.s12,this.polyline||(n+=a.S12,h+=s(0===l?this.lon:t,0!==l?this._lon0:t));return this.polyline||(u.area=o(n,this._area0,h,i,r)),u},e.PolygonArea.prototype.TestEdge=function(e,t,i,r){var n,h,l,u={number:this.num?this.num+1:0};return 0===this.num||(u.perimeter=this._perimetersum.Sum()+t,this.polyline||(h=this._areasum.Sum(),l=this._crossings,h+=(n=this._geod.Direct(this.lat,this.lon,e,t,this._mask)).S12,l+=a(this.lon,n.lon2),l+=s(n.lon2,this._lon0),n=this._geod.Inverse(n.lat2,n.lon2,this._lat0,this._lon0,this._mask),u.perimeter+=n.s12,h+=n.S12,u.area=o(h,this._area0,l,i,r))),u}}(a.PolygonArea,a.Geodesic,a.Math,a.Accumulator),a.DMS={},function(e){"use strict";var t,i,r,s,a=["degrees","minutes","seconds"];t=function(e,t){return e.indexOf(t.toUpperCase())},i=function(e,t){return String("0000").substr(0,Math.max(0,Math.min(4,t-e.length)))+e},e.NONE=0,e.LATITUDE=1,e.LONGITUDE=2,e.AZIMUTH=3,e.DEGREE=0,e.MINUTE=1,e.SECOND=2,e.Decode=function(i){var s,a,n,o,h,l,u,c,d=i,p=0,f=0,g=e.NONE;for(s=(d=d.replace(/\u00b0/g,"d").replace(/\u00ba/g,"d").replace(/\u2070/g,"d").replace(/\u02da/g,"d").replace(/\u2218/g,"d").replace(/\*/g,"d").replace(/`/g,"d").replace(/\u2032/g,"'").replace(/\u2035/g,"'").replace(/\u00b4/g,"'").replace(/\u2018/g,"'").replace(/\u2019/g,"'").replace(/\u201b/g,"'").replace(/\u02b9/g,"'").replace(/\u02ca/g,"'").replace(/\u02cb/g,"'").replace(/\u2033/g,'"').replace(/\u2036/g,'"').replace(/\u02dd/g,'"').replace(/\u201c/g,'"').replace(/\u201d/g,'"').replace(/\u201f/g,'"').replace(/\u02ba/g,'"').replace(/\u2795/g,"+").replace(/\u2064/g,"+").replace(/\u2010/g,"-").replace(/\u2011/g,"-").replace(/\u2013/g,"-").replace(/\u2014/g,"-").replace(/\u2212/g,"-").replace(/\u2796/g,"-").replace(/\u00a0/g,"").replace(/\u2007/g,"").replace(/\u2009/g,"").replace(/\u200a/g,"").replace(/\u200b/g,"").replace(/\u202f/g,"").replace(/\u2063/g,"").replace(/''/g,'"').trim()).length,l=0;l<s;l=c,++f)if(u=l,0===f&&t("SNWE",d.charAt(u))>=0&&++u,(f>0||u<s&&t("-+",d.charAt(u))>=0)&&++u,(a=d.substr(u,s-u).indexOf("-"))<0?a=s:a+=u,(n=d.substr(u,s-u).indexOf("+"))<0?n=s:n+=u,c=Math.min(a,n),p+=(o=r(d.substr(l,c-l))).val,h=o.ind,g===e.NONE)g=h;else if(h!==e.NONE&&g!==h)throw new Error("Incompatible hemisphere specifies in "+d.substr(0,c));if(0===f)throw new Error("Empty or incomplete DMS string "+d);return{val:p,ind:g}},r=function(i){var r,n,o,h,l,u,c,d,p,f,g,m,v,y,b,x,w={},M="";do{if(r=1,n=0,o=i.length,h=e.NONE,l=-1,o>n&&(l=t("SNWE",i.charAt(n)))>=0&&(h=2&l?e.LONGITUDE:e.LATITUDE,r=1&l?1:-1,++n),o>n&&(l=t("SNWE",i.charAt(o-1)))>=0&&l>=0){if(h!==e.NONE){M=i.charAt(n-1).toUpperCase()===i.charAt(o-1).toUpperCase()?"Repeated hemisphere indicators "+i.charAt(n-1)+" in "+i.substr(n-1,o-n+1):"Contradictory hemisphere indicators "+i.charAt(n-1)+" and "+i.charAt(o-1)+" in "+i.substr(n-1,o-n+1);break}h=2&l?e.LONGITUDE:e.LATITUDE,r=1&l?1:-1,--o}if(o>n&&(l=t("-+",i.charAt(n)))>=0&&l>=0&&(r*=l?1:-1,++n),o===n){M="Empty or incomplete DMS string "+i;break}for(u=[0,0,0],c=[0,0,0],d=0,p=0,f=0,g=0,m=n,v=!1,y=0,b=0;m<o;)if(x=i.charAt(m++),(l=t("0123456789",x))>=0)++g,y>0?++y:(p=10*p+l,++b);else if("."===x){if(v){M="Multiple decimal points in "+i.substr(n,o-n);break}v=!0,y=1}else{if(!((l=t("D'\":",x))>=0)){if(t("-+",x)>=0){M="Internal sign in DMS string "+i.substr(n,o-n);break}M="Illegal character "+x+" in DMS string "+i.substr(n,o-n);break}if(l>=3){if(m===o){M="Illegal for colon to appear at the end of "+i.substr(n,o-n);break}l=d}if(l===d-1){M="Repeated "+a[l]+" component in "+i.substr(n,o-n);break}if(l<d){M=a[l]+" component follows "+a[d-1]+" component in "+i.substr(n,o-n);break}if(0===g){M="Missing numbers in "+a[l]+" component of "+i.substr(n,o-n);break}y>0&&(f=parseFloat(i.substr(m-b-y-1,b+y)),p=0),u[l]=p,c[l]=p+f,m<o&&(d=l+1,p=f=0,g=y=b=0)}if(M.length)break;if(t("D'\":",i.charAt(m-1))<0){if(d>=3){M="Extra text following seconds in DMS string "+i.substr(n,o-n);break}if(0===g){M="Missing numbers in trailing component of "+i.substr(n,o-n);break}y>0&&(f=parseFloat(i.substr(m-b-y,b+y)),p=0),u[d]=p,c[d]=p+f}if(v&&0===y){M="Decimal point in non-terminal component of "+i.substr(n,o-n);break}if(u[1]>=60||c[1]>60){M="Minutes "+c[1]+" not in range [0,60)";break}if(u[2]>=60||c[2]>60){M="Seconds "+c[2]+" not in range [0,60)";break}return w.ind=h,w.val=r*(c[2]?(60*(60*c[0]+c[1])+c[2])/3600:c[1]?(60*c[0]+c[1])/60:c[0]),w}while(0);if(w.val=s(i),0===w.val)throw new Error(M);return w.ind=e.NONE,w},s=function(e){var t,i,r,s;return e.length<3?0:(i="-"===(t=e.toUpperCase().replace(/0+$/,"")).charAt(0)?-1:1,r="-"===t.charAt(0)||"+"===t.charAt(0)?1:0,1+(s=t.length-1)<r+3?0:"NAN"===(t=t.substr(r,s+1-r))||"1.#QNAN"===t||"1.#SNAN"===t||"1.#IND"===t||"1.#R"===t?Number.NaN:"INF"===t||"1.#INF"===t?i*Number.POSITIVE_INFINITY:0)},e.DecodeLatLon=function(t,i,r){var s,a,n={},o=e.Decode(t),h=e.Decode(i),l=o.val,u=o.ind,c=h.val,d=h.ind;if(r||(r=!1),u===e.NONE&&d===e.NONE?(u=r?e.LONGITUDE:e.LATITUDE,d=r?e.LATITUDE:e.LONGITUDE):u===e.NONE?u=e.LATITUDE+e.LONGITUDE-d:d===e.NONE&&(d=e.LATITUDE+e.LONGITUDE-u),u===d)throw new Error("Both "+t+" and "+i+" interpreted as "+(u===e.LATITUDE?"latitudes":"longitudes"));if(s=u===e.LATITUDE?l:c,a=u===e.LATITUDE?c:l,Math.abs(s)>90)throw new Error("Latitude "+s+" not in [-90,90]");return n.lat=s,n.lon=a,n},e.DecodeAngle=function(t){var i=e.Decode(t),r=i.val;if(i.ind!==e.NONE)throw new Error("Arc angle "+t+" includes a hemisphere N/E/W/S");return r},e.DecodeAzimuth=function(t){var i=e.Decode(t),r=i.val;if(i.ind===e.LATITUDE)throw new Error("Azimuth "+t+" has a latitude hemisphere N/S");return r},e.Encode=function(t,r,s,a){var n,o,h,l,u,c,d,p,f,g=1;if(a||(a=e.NONE),!isFinite(t))return String(t<0?"-inf":t>0?"inf":"nan");for(s=Math.min(15-2*r,s),n=0;n<r;++n)g*=60;for(n=0;n<s;++n)g*=10;for(a===e.AZIMUTH&&(t-=360*Math.floor(t/360)),l=((t*=o=t<0?-1:1)-(h=Math.floor(t)))*g+.5,l=(u=Math.floor(l))===l&&1==(1&u)?u-1:u,l/=g,(l=Math.floor((t-h)*g+.5)/g)>=1&&(h+=1,l-=1),c=[l,0,0],n=1;n<=r;++n)d=Math.floor(c[n-1]),p=c[n-1]-d,c[n]=60*p,c[n-1]=d;switch(c[0]+=h,f="",a===e.NONE&&o<0&&(f+="-"),r){case e.DEGREE:f+=i(c[0].toFixed(s),a===e.NONE?0:1+Math.min(a,2)+s+(s?1:0))+"°'\"".charAt(0);break;default:switch(f+=i(c[0].toFixed(0),a===e.NONE?0:1+Math.min(a,2))+"°'\"".charAt(0),r){case e.MINUTE:f+=i(c[1].toFixed(s),2+s+(s?1:0))+"°'\"".charAt(1);break;case e.SECOND:f+=i(c[1].toFixed(0),2)+"°'\"".charAt(1),f+=i(c[2].toFixed(s),2+s+(s?1:0))+"°'\"".charAt(2)}}return a!==e.NONE&&a!==e.AZIMUTH&&(f+="SNWE".charAt((a===e.LATITUDE?0:2)+(o<0?0:1))),f}}(a.DMS),s=a,e.exports?e.exports=s:void 0===(r=function(){return s}.apply(t,[]))||(e.exports=r)},function(e,t,i){"use strict";var r=484813681109536e-20,s=Math.PI/2,a=void 0===Number.EPSILON?1e-10:Number.EPSILON,n=.017453292519943295,o=57.29577951308232,h=Math.PI/4,l=2*Math.PI,u=3.14159265359,c={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},d={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},p=/[\s_\-\/\(\)]/g;function f(e,t){if(e[t])return e[t];for(var i,r=Object.keys(e),s=t.toLowerCase().replace(p,""),a=-1;++a<r.length;)if((i=r[a]).toLowerCase().replace(p,"")===s)return e[i]}var g=function(e){var t,i,r,s={},a=e.split("+").map((function(e){return e.trim()})).filter((function(e){return e})).reduce((function(e,t){var i=t.split("=");return i.push(!0),e[i[0].toLowerCase()]=i[1],e}),{}),o={proj:"projName",datum:"datumCode",rf:function(e){s.rf=parseFloat(e)},lat_0:function(e){s.lat0=e*n},lat_1:function(e){s.lat1=e*n},lat_2:function(e){s.lat2=e*n},lat_ts:function(e){s.lat_ts=e*n},lon_0:function(e){s.long0=e*n},lon_1:function(e){s.long1=e*n},lon_2:function(e){s.long2=e*n},alpha:function(e){s.alpha=parseFloat(e)*n},lonc:function(e){s.longc=e*n},x_0:function(e){s.x0=parseFloat(e)},y_0:function(e){s.y0=parseFloat(e)},k_0:function(e){s.k0=parseFloat(e)},k:function(e){s.k0=parseFloat(e)},a:function(e){s.a=parseFloat(e)},b:function(e){s.b=parseFloat(e)},r_a:function(){s.R_A=!0},zone:function(e){s.zone=parseInt(e,10)},south:function(){s.utmSouth=!0},towgs84:function(e){s.datum_params=e.split(",").map((function(e){return parseFloat(e)}))},to_meter:function(e){s.to_meter=parseFloat(e)},units:function(e){s.units=e;var t=f(d,e);t&&(s.to_meter=t.to_meter)},from_greenwich:function(e){s.from_greenwich=e*n},pm:function(e){var t=f(c,e);s.from_greenwich=(t||parseFloat(e))*n},nadgrids:function(e){"@null"===e?s.datumCode="none":s.nadgrids=e},axis:function(e){3===e.length&&-1!=="ewnsud".indexOf(e.substr(0,1))&&-1!=="ewnsud".indexOf(e.substr(1,1))&&-1!=="ewnsud".indexOf(e.substr(2,1))&&(s.axis=e)}};for(t in a)i=a[t],t in o?"function"==typeof(r=o[t])?r(i):s[r]=i:s[t]=i;return"string"==typeof s.datumCode&&"WGS84"!==s.datumCode&&(s.datumCode=s.datumCode.toLowerCase()),s},m=function(e){return new M(e).output()},v=/\s/,y=/[A-Za-z]/,b=/[A-Za-z84]/,x=/[,\]]/,w=/[\d\.E\-\+]/;function M(e){if("string"!=typeof e)throw new Error("not a string");this.text=e.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=1}function S(e,t,i){Array.isArray(t)&&(i.unshift(t),t=null);var r=t?{}:e,s=i.reduce((function(e,t){return A(t,e),e}),r);t&&(e[t]=s)}function A(e,t){if(Array.isArray(e)){var i=e.shift();if("PARAMETER"===i&&(i=e.shift()),1===e.length)return Array.isArray(e[0])?(t[i]={},void A(e[0],t[i])):void(t[i]=e[0]);if(e.length)if("TOWGS84"!==i){if("AXIS"===i)return i in t||(t[i]=[]),void t[i].push(e);var r;switch(Array.isArray(i)||(t[i]={}),i){case"UNIT":case"PRIMEM":case"VERT_DATUM":return t[i]={name:e[0].toLowerCase(),convert:e[1]},void(3===e.length&&A(e[2],t[i]));case"SPHEROID":case"ELLIPSOID":return t[i]={name:e[0],a:e[1],rf:e[2]},void(4===e.length&&A(e[3],t[i]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return e[0]=["name",e[0]],void S(t,i,e);default:for(r=-1;++r<e.length;)if(!Array.isArray(e[r]))return A(e,t[i]);return S(t,i,e)}}else t[i]=e;else t[i]=!0}else t[e]=!0}M.prototype.readCharicter=function(){var e=this.text[this.place++];if(4!==this.state)for(;v.test(e);){if(this.place>=this.text.length)return;e=this.text[this.place++]}switch(this.state){case 1:return this.neutral(e);case 2:return this.keyword(e);case 4:return this.quoted(e);case 5:return this.afterquote(e);case 3:return this.number(e);case-1:return}},M.prototype.afterquote=function(e){if('"'===e)return this.word+='"',void(this.state=4);if(x.test(e))return this.word=this.word.trim(),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in afterquote yet, index '+this.place)},M.prototype.afterItem=function(e){return","===e?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=1)):"]"===e?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=1,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},M.prototype.number=function(e){if(!w.test(e)){if(x.test(e))return this.word=parseFloat(this.word),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in number yet, index '+this.place)}this.word+=e},M.prototype.quoted=function(e){'"'!==e?this.word+=e:this.state=5},M.prototype.keyword=function(e){if(b.test(e))this.word+=e;else{if("["===e){var t=[];return t.push(this.word),this.level++,null===this.root?this.root=t:this.currentObject.push(t),this.stack.push(this.currentObject),this.currentObject=t,void(this.state=1)}if(!x.test(e))throw new Error("havn't handled \""+e+'" in keyword yet, index '+this.place);this.afterItem(e)}},M.prototype.neutral=function(e){if(y.test(e))return this.word=e,void(this.state=2);if('"'===e)return this.word="",void(this.state=4);if(w.test(e))return this.word=e,void(this.state=3);if(!x.test(e))throw new Error("havn't handled \""+e+'" in neutral yet, index '+this.place);this.afterItem(e)},M.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};function C(e){return.017453292519943295*e}var T=function(e){var t=m(e),i=t.shift(),r=t.shift();t.unshift(["name",r]),t.unshift(["type",i]);var s={};return A(t,s),function(e){if("GEOGCS"===e.type?e.projName="longlat":"LOCAL_CS"===e.type?(e.projName="identity",e.local=!0):"object"==typeof e.PROJECTION?e.projName=Object.keys(e.PROJECTION)[0]:e.projName=e.PROJECTION,e.AXIS){for(var t="",i=0,r=e.AXIS.length;i<r;++i){var s=e.AXIS[i][0].toLowerCase();-1!==s.indexOf("north")?t+="n":-1!==s.indexOf("south")?t+="s":-1!==s.indexOf("east")?t+="e":-1!==s.indexOf("west")&&(t+="w")}2===t.length&&(t+="u"),3===t.length&&(e.axis=t)}e.UNIT&&(e.units=e.UNIT.name.toLowerCase(),"metre"===e.units&&(e.units="meter"),e.UNIT.convert&&("GEOGCS"===e.type?e.DATUM&&e.DATUM.SPHEROID&&(e.to_meter=e.UNIT.convert*e.DATUM.SPHEROID.a):e.to_meter=e.UNIT.convert));var a=e.GEOGCS;function n(t){return t*(e.to_meter||1)}"GEOGCS"===e.type&&(a=e),a&&(a.DATUM?e.datumCode=a.DATUM.name.toLowerCase():e.datumCode=a.name.toLowerCase(),"d_"===e.datumCode.slice(0,2)&&(e.datumCode=e.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==e.datumCode&&"new_zealand_1949"!==e.datumCode||(e.datumCode="nzgd49"),"wgs_1984"!==e.datumCode&&"world_geodetic_system_1984"!==e.datumCode||("Mercator_Auxiliary_Sphere"===e.PROJECTION&&(e.sphere=!0),e.datumCode="wgs84"),"_ferro"===e.datumCode.slice(-6)&&(e.datumCode=e.datumCode.slice(0,-6)),"_jakarta"===e.datumCode.slice(-8)&&(e.datumCode=e.datumCode.slice(0,-8)),~e.datumCode.indexOf("belge")&&(e.datumCode="rnb72"),a.DATUM&&a.DATUM.SPHEROID&&(e.ellps=a.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===e.ellps.toLowerCase().slice(0,13)&&(e.ellps="intl"),e.a=a.DATUM.SPHEROID.a,e.rf=parseFloat(a.DATUM.SPHEROID.rf,10)),a.DATUM&&a.DATUM.TOWGS84&&(e.datum_params=a.DATUM.TOWGS84),~e.datumCode.indexOf("osgb_1936")&&(e.datumCode="osgb36"),~e.datumCode.indexOf("osni_1952")&&(e.datumCode="osni52"),(~e.datumCode.indexOf("tm65")||~e.datumCode.indexOf("geodetic_datum_of_1965"))&&(e.datumCode="ire65"),"ch1903+"===e.datumCode&&(e.datumCode="ch1903"),~e.datumCode.indexOf("israel")&&(e.datumCode="isr93")),e.b&&!isFinite(e.b)&&(e.b=e.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_2","Standard_Parallel_2"],["false_easting","False_Easting"],["false_northing","False_Northing"],["central_meridian","Central_Meridian"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",C],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",C],["x0","false_easting",n],["y0","false_northing",n],["long0","central_meridian",C],["lat0","latitude_of_origin",C],["lat0","standard_parallel_1",C],["lat1","standard_parallel_1",C],["lat2","standard_parallel_2",C],["azimuth","Azimuth"],["alpha","azimuth",C],["srsCode","name"]].forEach((function(t){return i=e,s=(r=t)[0],a=r[1],void(!(s in i)&&a in i&&(i[s]=i[a],3===r.length&&(i[s]=r[2](i[s]))));var i,r,s,a})),e.long0||!e.longc||"Albers_Conic_Equal_Area"!==e.projName&&"Lambert_Azimuthal_Equal_Area"!==e.projName||(e.long0=e.longc),e.lat_ts||!e.lat1||"Stereographic_South_Pole"!==e.projName&&"Polar Stereographic (variant B)"!==e.projName||(e.lat0=C(e.lat1>0?90:-90),e.lat_ts=e.lat1)}(s),s};function P(e){var t=this;if(2===arguments.length){var i=arguments[1];"string"==typeof i?"+"===i.charAt(0)?P[e]=g(arguments[1]):P[e]=T(arguments[1]):P[e]=i}else if(1===arguments.length){if(Array.isArray(e))return e.map((function(e){Array.isArray(e)?P.apply(t,e):P(e)}));if("string"==typeof e){if(e in P)return P[e]}else"EPSG"in e?P["EPSG:"+e.EPSG]=e:"ESRI"in e?P["ESRI:"+e.ESRI]=e:"IAU2000"in e?P["IAU2000:"+e.IAU2000]=e:console.log(e);return}}!function(e){e("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),e("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),e("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),e.WGS84=e["EPSG:4326"],e["EPSG:3785"]=e["EPSG:3857"],e.GOOGLE=e["EPSG:3857"],e["EPSG:900913"]=e["EPSG:3857"],e["EPSG:102113"]=e["EPSG:3857"]}(P);var F=P;var L=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];var E=function(e){return function(e){return"string"==typeof e}(e)?function(e){return e in F}(e)?F[e]:function(e){return L.some((function(t){return e.indexOf(t)>-1}))}(e)?T(e):function(e){return"+"===e[0]}(e)?g(e):void 0:e},k=function(e,t){var i,r;if(e=e||{},!t)return e;for(r in t)void 0!==(i=t[r])&&(e[r]=i);return e},N=function(e,t,i){var r=e*t;return i/Math.sqrt(1-r*r)},I=function(e){return e<0?-1:1},B=function(e){return Math.abs(e)<=u?e:e-I(e)*l},R=function(e,t,i){var r=e*i,a=.5*e;return r=Math.pow((1-r)/(1+r),a),Math.tan(.5*(s-t))/r},z=function(e,t){for(var i,r,a=.5*e,n=s-2*Math.atan(t),o=0;o<=15;o++)if(i=e*Math.sin(n),n+=r=s-2*Math.atan(t*Math.pow((1-i)/(1+i),a))-n,Math.abs(r)<=1e-10)return n;return-9999};function U(e){return e}var D=[{init:function(){var e=this.b/this.a;this.es=1-e*e,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=N(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(e){var t,i,r=e.x,n=e.y;if(n*o>90&&n*o<-90&&r*o>180&&r*o<-180)return null;if(Math.abs(Math.abs(n)-s)<=a)return null;if(this.sphere)t=this.x0+this.a*this.k0*B(r-this.long0),i=this.y0+this.a*this.k0*Math.log(Math.tan(h+.5*n));else{var l=Math.sin(n),u=R(this.e,n,l);t=this.x0+this.a*this.k0*B(r-this.long0),i=this.y0-this.a*this.k0*Math.log(u)}return e.x=t,e.y=i,e},inverse:function(e){var t,i,r=e.x-this.x0,a=e.y-this.y0;if(this.sphere)i=s-2*Math.atan(Math.exp(-a/(this.a*this.k0)));else{var n=Math.exp(-a/(this.a*this.k0));if(-9999===(i=z(this.e,n)))return null}return t=B(this.long0+r/(this.a*this.k0)),e.x=t,e.y=i,e},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:U,inverse:U,names:["longlat","identity"]}],_={},O=[];function G(e,t){var i=O.length;return e.names?(O[i]=e,e.names.forEach((function(e){_[e.toLowerCase()]=i})),this):(console.log(t),!0)}var V={start:function(){D.forEach(G)},add:G,get:function(e){if(!e)return!1;var t=e.toLowerCase();return void 0!==_[t]&&O[_[t]]?O[_[t]]:void 0}},j={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},H=j.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};j.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var W={};W.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},W.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},W.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},W.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},W.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},W.potsdam={towgs84:"606.0,23.0,413.0",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},W.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},W.hermannskogel={towgs84:"653.0,-212.0,449.0",ellipse:"bessel",datumName:"Hermannskogel"},W.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},W.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},W.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},W.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},W.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},W.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},W.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},W.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var q=function(e,t,i,s,a,n){var o={};return o.datum_type=void 0===e||"none"===e?5:4,t&&(o.datum_params=t.map(parseFloat),0===o.datum_params[0]&&0===o.datum_params[1]&&0===o.datum_params[2]||(o.datum_type=1),o.datum_params.length>3&&(0===o.datum_params[3]&&0===o.datum_params[4]&&0===o.datum_params[5]&&0===o.datum_params[6]||(o.datum_type=2,o.datum_params[3]*=r,o.datum_params[4]*=r,o.datum_params[5]*=r,o.datum_params[6]=o.datum_params[6]/1e6+1))),o.a=i,o.b=s,o.es=a,o.ep2=n,o};function Z(e,t){if(!(this instanceof Z))return new Z(e);t=t||function(e){if(e)throw e};var i=E(e);if("object"==typeof i){var r=Z.projections.get(i.projName);if(r){if(i.datumCode&&"none"!==i.datumCode){var s=f(W,i.datumCode);s&&(i.datum_params=s.towgs84?s.towgs84.split(","):null,i.ellps=s.ellipse,i.datumName=s.datumName?s.datumName:i.datumCode)}i.k0=i.k0||1,i.axis=i.axis||"enu",i.ellps=i.ellps||"wgs84";var n,o,h,l,u,c,d,p=function(e,t,i,r,s){if(!e){var n=f(j,r);n||(n=H),e=n.a,t=n.b,i=n.rf}return i&&!t&&(t=(1-1/i)*e),(0===i||Math.abs(e-t)<a)&&(s=!0,t=e),{a:e,b:t,rf:i,sphere:s}}(i.a,i.b,i.rf,i.ellps,i.sphere),g=(n=p.a,o=p.b,p.rf,h=i.R_A,c=((l=n*n)-(u=o*o))/l,d=0,h?(l=(n*=1-c*(.16666666666666666+c*(.04722222222222222+.022156084656084655*c)))*n,c=0):d=Math.sqrt(c),{es:c,e:d,ep2:(l-u)/u}),m=i.datum||q(i.datumCode,i.datum_params,p.a,p.b,g.es,g.ep2);k(this,i),k(this,r),this.a=p.a,this.b=p.b,this.rf=p.rf,this.sphere=p.sphere,this.es=g.es,this.e=g.e,this.ep2=g.ep2,this.datum=m,this.init(),t(null,this)}else t(e)}else t(e)}Z.projections=V,Z.projections.start();var Y=Z;function J(e,t,i){var r,a,n,o,h=e.x,l=e.y,u=e.z?e.z:0;if(l<-s&&l>-1.001*s)l=-s;else if(l>s&&l<1.001*s)l=s;else if(l<-s||l>s)return null;return h>Math.PI&&(h-=2*Math.PI),a=Math.sin(l),o=Math.cos(l),n=a*a,{x:((r=i/Math.sqrt(1-t*n))+u)*o*Math.cos(h),y:(r+u)*o*Math.sin(h),z:(r*(1-t)+u)*a}}function K(e,t,i,r){var a,n,o,h,l,u,c,d,p,f,g,m,v,y,b,x=e.x,w=e.y,M=e.z?e.z:0;if(a=Math.sqrt(x*x+w*w),n=Math.sqrt(x*x+w*w+M*M),a/i<1e-12){if(y=0,n/i<1e-12)return s,b=-r,{x:e.x,y:e.y,z:e.z}}else y=Math.atan2(w,x);o=M/n,d=(h=a/n)*(1-t)*(l=1/Math.sqrt(1-t*(2-t)*h*h)),p=o*l,v=0;do{v++,u=t*(c=i/Math.sqrt(1-t*p*p))/(c+(b=a*d+M*p-c*(1-t*p*p))),m=(g=o*(l=1/Math.sqrt(1-u*(2-u)*h*h)))*d-(f=h*(1-u)*l)*p,d=f,p=g}while(m*m>1e-24&&v<30);return{x:y,y:Math.atan(g/Math.abs(f)),z:b}}function Q(e){return 1===e||2===e}var X=function(e,t,i){return function(e,t){return e.datum_type===t.datum_type&&(!(e.a!==t.a||Math.abs(e.es-t.es)>5e-11)&&(1===e.datum_type?e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]:2!==e.datum_type||e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]&&e.datum_params[3]===t.datum_params[3]&&e.datum_params[4]===t.datum_params[4]&&e.datum_params[5]===t.datum_params[5]&&e.datum_params[6]===t.datum_params[6]))}(e,t)||5===e.datum_type||5===t.datum_type?i:e.es!==t.es||e.a!==t.a||Q(e.datum_type)||Q(t.datum_type)?(i=J(i,e.es,e.a),Q(e.datum_type)&&(i=function(e,t,i){if(1===t)return{x:e.x+i[0],y:e.y+i[1],z:e.z+i[2]};if(2===t){var r=i[0],s=i[1],a=i[2],n=i[3],o=i[4],h=i[5],l=i[6];return{x:l*(e.x-h*e.y+o*e.z)+r,y:l*(h*e.x+e.y-n*e.z)+s,z:l*(-o*e.x+n*e.y+e.z)+a}}}(i,e.datum_type,e.datum_params)),Q(t.datum_type)&&(i=function(e,t,i){if(1===t)return{x:e.x-i[0],y:e.y-i[1],z:e.z-i[2]};if(2===t){var r=i[0],s=i[1],a=i[2],n=i[3],o=i[4],h=i[5],l=i[6],u=(e.x-r)/l,c=(e.y-s)/l,d=(e.z-a)/l;return{x:u+h*c-o*d,y:-h*u+c+n*d,z:o*u-n*c+d}}}(i,t.datum_type,t.datum_params)),K(i,t.es,t.a,t.b)):i},$=function(e,t,i){var r,s,a,n=i.x,o=i.y,h=i.z||0,l={};for(a=0;a<3;a++)if(!t||2!==a||void 0!==i.z)switch(0===a?(r=n,s="x"):1===a?(r=o,s="y"):(r=h,s="z"),e.axis[a]){case"e":l[s]=r;break;case"w":l[s]=-r;break;case"n":l[s]=r;break;case"s":l[s]=-r;break;case"u":void 0!==i[s]&&(l.z=r);break;case"d":void 0!==i[s]&&(l.z=-r);break;default:return null}return l},ee=function(e){var t={x:e[0],y:e[1]};return e.length>2&&(t.z=e[2]),e.length>3&&(t.m=e[3]),t};function te(e,t,i){var r;return Array.isArray(i)&&(i=ee(i)),e.datum&&t.datum&&function(e,t){return(1===e.datum.datum_type||2===e.datum.datum_type)&&"WGS84"!==t.datumCode||(1===t.datum.datum_type||2===t.datum.datum_type)&&"WGS84"!==e.datumCode}(e,t)&&(i=te(e,r=new Y("WGS84"),i),e=r),"enu"!==e.axis&&(i=$(e,!1,i)),"longlat"===e.projName?(i.x*=n,i.y*=n):e.isGeocent?(e.to_meter&&(i.x*=e.to_meter,i.y*=e.to_meter,i.z*=e.to_meter),i=K(i,t.es,t.a,t.b)):(e.to_meter&&(i.x*=e.to_meter,i.y*=e.to_meter),i=e.inverse(i)),e.from_greenwich&&(i.x+=e.from_greenwich),i=X(e.datum,t.datum,i),t.from_greenwich&&(i.x-=t.from_greenwich),"longlat"===t.projName?(i.x*=o,i.y*=o):t.isGeocent?(i=J(i,t.es,t.a),t.to_meter&&(i.x/=t.to_meter,i.y/=t.to_meter,i.z/=t.to_meter)):(t.forward(i),t.to_meter&&(i.x/=t.to_meter,i.y/=t.to_meter)),"enu"!==t.axis?$(t,!0,i):i}var ie=Y("WGS84");function re(e,t,i){var r;return Array.isArray(i)?(r=te(e,t,i),3===i.length?[r.x,r.y,r.z]:[r.x,r.y]):te(e,t,i)}function se(e){return e instanceof Y?e:e.oProj?e.oProj:Y(e)}var ae=function(e,t,i,r){if(r)return e;e=se(e);var s,a=!1;return void 0===t?(t=e,e=ie,a=!0):(void 0!==t.x||Array.isArray(t))&&(i=t,t=e,e=ie,a=!0),t=se(t),i?re(e,t,i):(s={forward:function(i){return re(e,t,i)},inverse:function(i){return re(t,e,i)},info:function(){return{a:t.a,b:t.b,ra:t.R_A,"proj-name":t.projName}}},a&&(s.oProj=t),s)},ne=73,oe=79,he={forward:le,inverse:function(e){var t=pe(me(e.toUpperCase()));if(t.lat&&t.lon)return[t.lon,t.lat,t.lon,t.lat];return[t.left,t.bottom,t.right,t.top]},toPoint:ue};function le(e,t){return t=t||5,function(e,t){var i="00000"+e.easting,r="00000"+e.northing;return e.zoneNumber+e.zoneLetter+(p=e.easting,f=e.northing,g=e.zoneNumber,m=ge(g),v=Math.floor(p/1e5),y=Math.floor(f/1e5)%20,s=v,a=y,n=m,o=n-1,h="AJSAJS".charCodeAt(o),l="AFAFAF".charCodeAt(o),u=h+s-1,c=l+a,d=!1,u>90&&(u=u-90+65-1,d=!0),(u===ne||h<ne&&u>ne||(u>ne||h<ne)&&d)&&u++,(u===oe||h<oe&&u>oe||(u>oe||h<oe)&&d)&&++u===ne&&u++,u>90&&(u=u-90+65-1),c>86?(c=c-86+65-1,d=!0):d=!1,(c===ne||l<ne&&c>ne||(c>ne||l<ne)&&d)&&c++,(c===oe||l<oe&&c>oe||(c>oe||l<oe)&&d)&&++c===ne&&c++,c>86&&(c=c-86+65-1),String.fromCharCode(u)+String.fromCharCode(c))+i.substr(i.length-5,t)+r.substr(r.length-5,t);var s,a,n,o,h,l,u,c,d;var p,f,g,m,v,y}(function(e){var t,i,r,s,a,n,o,h=e.lat,l=e.lon,u=6378137,c=ce(h),d=ce(l);o=Math.floor((l+180)/6)+1,180===l&&(o=60);h>=56&&h<64&&l>=3&&l<12&&(o=32);h>=72&&h<84&&(l>=0&&l<9?o=31:l>=9&&l<21?o=33:l>=21&&l<33?o=35:l>=33&&l<42&&(o=37));n=ce(6*(o-1)-180+3),.006739496752268451,t=u/Math.sqrt(1-.00669438*Math.sin(c)*Math.sin(c)),i=Math.tan(c)*Math.tan(c),r=.006739496752268451*Math.cos(c)*Math.cos(c),s=Math.cos(c)*(d-n),a=u*(.9983242984503243*c-.002514607064228144*Math.sin(2*c)+2639046602129982e-21*Math.sin(4*c)-3.418046101696858e-9*Math.sin(6*c));var p=.9996*t*(s+(1-i+r)*s*s*s/6+(5-18*i+i*i+72*r-.39089081163157013)*s*s*s*s*s/120)+5e5,f=.9996*(a+t*Math.tan(c)*(s*s/2+(5-i+9*r+4*r*r)*s*s*s*s/24+(61-58*i+i*i+600*r-2.2240339282485886)*s*s*s*s*s*s/720));h<0&&(f+=1e7);return{northing:Math.round(f),easting:Math.round(p),zoneNumber:o,zoneLetter:fe(h)}}({lat:e[1],lon:e[0]}),t)}function ue(e){var t=pe(me(e.toUpperCase()));return t.lat&&t.lon?[t.lon,t.lat]:[(t.left+t.right)/2,(t.top+t.bottom)/2]}function ce(e){return e*(Math.PI/180)}function de(e){return e/Math.PI*180}function pe(e){var t=e.northing,i=e.easting,r=e.zoneLetter,s=e.zoneNumber;if(s<0||s>60)return null;var a,n,o,h,l,u,c,d,p=6378137,f=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),g=i-5e5,m=t;r<"N"&&(m-=1e7),u=6*(s-1)-180+3,d=(c=m/.9996/6367449.145945056)+(3*f/2-27*f*f*f/32)*Math.sin(2*c)+(21*f*f/16-55*f*f*f*f/32)*Math.sin(4*c)+151*f*f*f/96*Math.sin(6*c),a=p/Math.sqrt(1-.00669438*Math.sin(d)*Math.sin(d)),n=Math.tan(d)*Math.tan(d),o=.006739496752268451*Math.cos(d)*Math.cos(d),h=.99330562*p/Math.pow(1-.00669438*Math.sin(d)*Math.sin(d),1.5),l=g/(.9996*a);var v=d-a*Math.tan(d)/h*(l*l/2-(5+3*n+10*o-4*o*o-.06065547077041606)*l*l*l*l/24+(61+90*n+298*o+45*n*n-1.6983531815716497-3*o*o)*l*l*l*l*l*l/720);v=de(v);var y,b=(l-(1+2*n+o)*l*l*l/6+(5-2*o+28*n-3*o*o+.05391597401814761+24*n*n)*l*l*l*l*l/120)/Math.cos(d);if(b=u+de(b),e.accuracy){var x=pe({northing:e.northing+e.accuracy,easting:e.easting+e.accuracy,zoneLetter:e.zoneLetter,zoneNumber:e.zoneNumber});y={top:x.lat,right:x.lon,bottom:v,left:b}}else y={lat:v,lon:b};return y}function fe(e){var t="Z";return 84>=e&&e>=72?t="X":72>e&&e>=64?t="W":64>e&&e>=56?t="V":56>e&&e>=48?t="U":48>e&&e>=40?t="T":40>e&&e>=32?t="S":32>e&&e>=24?t="R":24>e&&e>=16?t="Q":16>e&&e>=8?t="P":8>e&&e>=0?t="N":0>e&&e>=-8?t="M":-8>e&&e>=-16?t="L":-16>e&&e>=-24?t="K":-24>e&&e>=-32?t="J":-32>e&&e>=-40?t="H":-40>e&&e>=-48?t="G":-48>e&&e>=-56?t="F":-56>e&&e>=-64?t="E":-64>e&&e>=-72?t="D":-72>e&&e>=-80&&(t="C"),t}function ge(e){var t=e%6;return 0===t&&(t=6),t}function me(e){if(e&&0===e.length)throw"MGRSPoint coverting from nothing";for(var t,i=e.length,r=null,s="",a=0;!/[A-Z]/.test(t=e.charAt(a));){if(a>=2)throw"MGRSPoint bad conversion from: "+e;s+=t,a++}var n=parseInt(s,10);if(0===a||a+3>i)throw"MGRSPoint bad conversion from: "+e;var o=e.charAt(a++);if(o<="A"||"B"===o||"Y"===o||o>="Z"||"I"===o||"O"===o)throw"MGRSPoint zone letter "+o+" not handled: "+e;r=e.substring(a,a+=2);for(var h=ge(n),l=function(e,t){var i="AJSAJS".charCodeAt(t-1),r=1e5,s=!1;for(;i!==e.charCodeAt(0);){if(++i===ne&&i++,i===oe&&i++,i>90){if(s)throw"Bad character: "+e;i=65,s=!0}r+=1e5}return r}(r.charAt(0),h),u=function(e,t){if(e>"V")throw"MGRSPoint given invalid Northing "+e;var i="AFAFAF".charCodeAt(t-1),r=0,s=!1;for(;i!==e.charCodeAt(0);){if(++i===ne&&i++,i===oe&&i++,i>86){if(s)throw"Bad character: "+e;i=65,s=!0}r+=1e5}return r}(r.charAt(1),h);u<ve(o);)u+=2e6;var c=i-a;if(c%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+e;var d,p,f,g=c/2,m=0,v=0;return g>0&&(d=1e5/Math.pow(10,g),p=e.substring(a,a+g),m=parseFloat(p)*d,f=e.substring(a+g),v=parseFloat(f)*d),{easting:m+l,northing:v+u,zoneLetter:o,zoneNumber:n,accuracy:d}}function ve(e){var t;switch(e){case"C":t=11e5;break;case"D":t=2e6;break;case"E":t=28e5;break;case"F":t=37e5;break;case"G":t=46e5;break;case"H":t=55e5;break;case"J":t=64e5;break;case"K":t=73e5;break;case"L":t=82e5;break;case"M":t=91e5;break;case"N":t=0;break;case"P":t=8e5;break;case"Q":t=17e5;break;case"R":t=26e5;break;case"S":t=35e5;break;case"T":t=44e5;break;case"U":t=53e5;break;case"V":t=62e5;break;case"W":t=7e6;break;case"X":t=79e5;break;default:t=-1}if(t>=0)return t;throw"Invalid zone letter: "+e}function ye(e,t,i){if(!(this instanceof ye))return new ye(e,t,i);if(Array.isArray(e))this.x=e[0],this.y=e[1],this.z=e[2]||0;else if("object"==typeof e)this.x=e.x,this.y=e.y,this.z=e.z||0;else if("string"==typeof e&&void 0===t){var r=e.split(",");this.x=parseFloat(r[0],10),this.y=parseFloat(r[1],10),this.z=parseFloat(r[2],10)||0}else this.x=e,this.y=t,this.z=i||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}ye.fromMGRS=function(e){return new ye(ue(e))},ye.prototype.toMGRS=function(e){return le([this.x,this.y],e)};var be=ye,xe=i(9),we=.01068115234375,Me=function(e){var t=[];t[0]=1-e*(.25+e*(.046875+e*(.01953125+e*we))),t[1]=e*(.75-e*(.046875+e*(.01953125+e*we)));var i=e*e;return t[2]=i*(.46875-e*(.013020833333333334+.007120768229166667*e)),i*=e,t[3]=i*(.3645833333333333-.005696614583333333*e),t[4]=i*e*.3076171875,t},Se=function(e,t,i,r){return i*=t,t*=t,r[0]*e-i*(r[1]+t*(r[2]+t*(r[3]+t*r[4])))},Ae=function(e,t,i){for(var r=1/(1-t),s=e,n=20;n;--n){var o=Math.sin(s),h=1-t*o*o;if(s-=h=(Se(s,o,Math.cos(s),i)-e)*(h*Math.sqrt(h))*r,Math.abs(h)<a)return s}return s};var Ce={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=Me(this.es),this.ml0=Se(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(e){var t,i,r,s=e.x,n=e.y,o=B(s-this.long0),h=Math.sin(n),l=Math.cos(n);if(this.es){var u=l*o,c=Math.pow(u,2),d=this.ep2*Math.pow(l,2),p=Math.pow(d,2),f=Math.abs(l)>a?Math.tan(n):0,g=Math.pow(f,2),m=Math.pow(g,2);t=1-this.es*Math.pow(h,2),u/=Math.sqrt(t);var v=Se(n,h,l,this.en);i=this.a*(this.k0*u*(1+c/6*(1-g+d+c/20*(5-18*g+m+14*d-58*g*d+c/42*(61+179*m-m*g-479*g)))))+this.x0,r=this.a*(this.k0*(v-this.ml0+h*o*u/2*(1+c/12*(5-g+9*d+4*p+c/30*(61+m-58*g+270*d-330*g*d+c/56*(1385+543*m-m*g-3111*g))))))+this.y0}else{var y=l*Math.sin(o);if(Math.abs(Math.abs(y)-1)<a)return 93;if(i=.5*this.a*this.k0*Math.log((1+y)/(1-y))+this.x0,r=l*Math.cos(o)/Math.sqrt(1-Math.pow(y,2)),(y=Math.abs(r))>=1){if(y-1>a)return 93;r=0}else r=Math.acos(r);n<0&&(r=-r),r=this.a*this.k0*(r-this.lat0)+this.y0}return e.x=i,e.y=r,e},inverse:function(e){var t,i,r,n,o=(e.x-this.x0)*(1/this.a),h=(e.y-this.y0)*(1/this.a);if(this.es)if(t=this.ml0+h/this.k0,i=Ae(t,this.es,this.en),Math.abs(i)<s){var l=Math.sin(i),u=Math.cos(i),c=Math.abs(u)>a?Math.tan(i):0,d=this.ep2*Math.pow(u,2),p=Math.pow(d,2),f=Math.pow(c,2),g=Math.pow(f,2);t=1-this.es*Math.pow(l,2);var m=o*Math.sqrt(t)/this.k0,v=Math.pow(m,2);r=i-(t*=c)*v/(1-this.es)*.5*(1-v/12*(5+3*f-9*d*f+d-4*p-v/30*(61+90*f-252*d*f+45*g+46*d-v/56*(1385+3633*f+4095*g+1574*g*f)))),n=B(this.long0+m*(1-v/6*(1+2*f+d-v/20*(5+28*f+24*g+8*d*f+6*d-v/42*(61+662*f+1320*g+720*g*f))))/u)}else r=s*I(h),n=0;else{var y=Math.exp(o/this.k0),b=.5*(y-1/y),x=this.lat0+h/this.k0,w=Math.cos(x);t=Math.sqrt((1-Math.pow(w,2))/(1+Math.pow(b,2))),r=Math.asin(t),h<0&&(r=-r),n=0===b&&0===w?0:B(Math.atan2(b,w)+this.long0)}return e.x=n,e.y=r,e},names:["Transverse_Mercator","Transverse Mercator","tmerc"]},Te=function(e){var t=Math.exp(e);return t=(t-1/t)/2},Pe=function(e,t){e=Math.abs(e),t=Math.abs(t);var i=Math.max(e,t),r=Math.min(e,t)/(i||1);return i*Math.sqrt(1+Math.pow(r,2))},Fe=function(e){var t=Math.abs(e);return t=function(e){var t=1+e,i=t-1;return 0===i?e:e*Math.log(t)/i}(t*(1+t/(Pe(1,t)+1))),e<0?-t:t},Le=function(e,t){for(var i,r=2*Math.cos(2*t),s=e.length-1,a=e[s],n=0;--s>=0;)i=r*a-n+e[s],n=a,a=i;return t+i*Math.sin(2*t)},Ee=function(e,t,i){for(var r,s,a=Math.sin(t),n=Math.cos(t),o=Te(i),h=function(e){var t=Math.exp(e);return t=(t+1/t)/2}(i),l=2*n*h,u=-2*a*o,c=e.length-1,d=e[c],p=0,f=0,g=0;--c>=0;)r=f,s=p,d=l*(f=d)-r-u*(p=g)+e[c],g=u*f-s+l*p;return[(l=a*h)*d-(u=n*o)*g,l*g+u*d]};var ke={init:function(){if(void 0===this.es||this.es<=0)throw new Error("incorrect elliptical usage");this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var e=this.es/(1+Math.sqrt(1-this.es)),t=e/(2-e),i=t;this.cgb[0]=t*(2+t*(-2/3+t*(t*(116/45+t*(26/45+t*(-2854/675)))-2))),this.cbg[0]=t*(t*(2/3+t*(4/3+t*(-82/45+t*(32/45+t*(4642/4725)))))-2),i*=t,this.cgb[1]=i*(7/3+t*(t*(-227/45+t*(2704/315+t*(2323/945)))-1.6)),this.cbg[1]=i*(5/3+t*(-16/15+t*(-13/9+t*(904/315+t*(-1522/945))))),i*=t,this.cgb[2]=i*(56/15+t*(-136/35+t*(-1262/105+t*(73814/2835)))),this.cbg[2]=i*(-26/15+t*(34/21+t*(1.6+t*(-12686/2835)))),i*=t,this.cgb[3]=i*(4279/630+t*(-332/35+t*(-399572/14175))),this.cbg[3]=i*(1237/630+t*(t*(-24832/14175)-2.4)),i*=t,this.cgb[4]=i*(4174/315+t*(-144838/6237)),this.cbg[4]=i*(-734/315+t*(109598/31185)),i*=t,this.cgb[5]=i*(601676/22275),this.cbg[5]=i*(444337/155925),i=Math.pow(t,2),this.Qn=this.k0/(1+t)*(1+i*(1/4+i*(1/64+i/256))),this.utg[0]=t*(t*(2/3+t*(-37/96+t*(1/360+t*(81/512+t*(-96199/604800)))))-.5),this.gtu[0]=t*(.5+t*(-2/3+t*(5/16+t*(41/180+t*(-127/288+t*(7891/37800)))))),this.utg[1]=i*(-1/48+t*(-1/15+t*(437/1440+t*(-46/105+t*(1118711/3870720))))),this.gtu[1]=i*(13/48+t*(t*(557/1440+t*(281/630+t*(-1983433/1935360)))-.6)),i*=t,this.utg[2]=i*(-17/480+t*(37/840+t*(209/4480+t*(-5569/90720)))),this.gtu[2]=i*(61/240+t*(-103/140+t*(15061/26880+t*(167603/181440)))),i*=t,this.utg[3]=i*(-4397/161280+t*(11/504+t*(830251/7257600))),this.gtu[3]=i*(49561/161280+t*(-179/168+t*(6601661/7257600))),i*=t,this.utg[4]=i*(-4583/161280+t*(108847/3991680)),this.gtu[4]=i*(34729/80640+t*(-3418889/1995840)),i*=t,this.utg[5]=i*(-20648693/638668800),this.gtu[5]=.6650675310896665*i;var r=Le(this.cbg,this.lat0);this.Zb=-this.Qn*(r+function(e,t){for(var i,r=2*Math.cos(t),s=e.length-1,a=e[s],n=0;--s>=0;)i=r*a-n+e[s],n=a,a=i;return Math.sin(t)*i}(this.gtu,2*r))},forward:function(e){var t=B(e.x-this.long0),i=e.y;i=Le(this.cbg,i);var r=Math.sin(i),s=Math.cos(i),a=Math.sin(t),n=Math.cos(t);i=Math.atan2(r,n*s),t=Math.atan2(a*s,Pe(r,s*n)),t=Fe(Math.tan(t));var o,h,l=Ee(this.gtu,2*i,2*t);return i+=l[0],t+=l[1],Math.abs(t)<=2.623395162778?(o=this.a*(this.Qn*t)+this.x0,h=this.a*(this.Qn*i+this.Zb)+this.y0):(o=1/0,h=1/0),e.x=o,e.y=h,e},inverse:function(e){var t,i,r=(e.x-this.x0)*(1/this.a),s=(e.y-this.y0)*(1/this.a);if(s=(s-this.Zb)/this.Qn,r/=this.Qn,Math.abs(r)<=2.623395162778){var a=Ee(this.utg,2*s,2*r);s+=a[0],r+=a[1],r=Math.atan(Te(r));var n=Math.sin(s),o=Math.cos(s),h=Math.sin(r),l=Math.cos(r);s=Math.atan2(n*l,Pe(h,l*o)),r=Math.atan2(h,l*o),t=B(r+this.long0),i=Le(this.cgb,s)}else t=1/0,i=1/0;return e.x=t,e.y=i,e},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc"]};var Ne={init:function(){var e=function(e,t){if(void 0===e){if((e=Math.floor(30*(B(t)+Math.PI)/Math.PI)+1)<0)return 0;if(e>60)return 60}return e}(this.zone,this.long0);if(void 0===e)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(e)-183)*n,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,ke.init.apply(this),this.forward=ke.forward,this.inverse=ke.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"},Ie=function(e,t){return Math.pow((1-e)/(1+e),t)};var Be={init:function(){var e=Math.sin(this.lat0),t=Math.cos(this.lat0);t*=t,this.rc=Math.sqrt(1-this.es)/(1-this.es*e*e),this.C=Math.sqrt(1+this.es*t*t/(1-this.es)),this.phic0=Math.asin(e/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+h)/(Math.pow(Math.tan(.5*this.lat0+h),this.C)*Ie(this.e*e,this.ratexp))},forward:function(e){var t=e.x,i=e.y;return e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*i+h),this.C)*Ie(this.e*Math.sin(i),this.ratexp))-s,e.x=this.C*t,e},inverse:function(e){for(var t=e.x/this.C,i=e.y,r=Math.pow(Math.tan(.5*i+h)/this.K,1/this.C),a=20;a>0&&(i=2*Math.atan(r*Ie(this.e*Math.sin(e.y),-.5*this.e))-s,!(Math.abs(i-e.y)<1e-14));--a)e.y=i;return a?(e.x=t,e.y=i,e):null},names:["gauss"]};var Re={init:function(){Be.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(e){var t,i,r,s;return e.x=B(e.x-this.long0),Be.forward.apply(this,[e]),t=Math.sin(e.y),i=Math.cos(e.y),r=Math.cos(e.x),s=this.k0*this.R2/(1+this.sinc0*t+this.cosc0*i*r),e.x=s*i*Math.sin(e.x),e.y=s*(this.cosc0*t-this.sinc0*i*r),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){var t,i,r,s,a;if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,a=Math.sqrt(e.x*e.x+e.y*e.y)){var n=2*Math.atan2(a,this.R2);t=Math.sin(n),i=Math.cos(n),s=Math.asin(i*this.sinc0+e.y*t*this.cosc0/a),r=Math.atan2(e.x*t,a*this.cosc0*i-e.y*this.sinc0*t)}else s=this.phic0,r=0;return e.x=r,e.y=s,Be.inverse.apply(this,[e]),e.x=B(e.x+this.long0),e},names:["Stereographic_North_Pole","Oblique_Stereographic","Polar_Stereographic","sterea","Oblique Stereographic Alternative"]};var ze={init:function(){this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=a&&(this.k0=.5*(1+I(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=a&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=a&&(this.k0=.5*this.cons*N(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/R(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=N(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-s,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(e){var t,i,r,n,o,h,l=e.x,u=e.y,c=Math.sin(u),d=Math.cos(u),p=B(l-this.long0);return Math.abs(Math.abs(l-this.long0)-Math.PI)<=a&&Math.abs(u+this.lat0)<=a?(e.x=NaN,e.y=NaN,e):this.sphere?(t=2*this.k0/(1+this.sinlat0*c+this.coslat0*d*Math.cos(p)),e.x=this.a*t*d*Math.sin(p)+this.x0,e.y=this.a*t*(this.coslat0*c-this.sinlat0*d*Math.cos(p))+this.y0,e):(i=2*Math.atan(this.ssfn_(u,c,this.e))-s,n=Math.cos(i),r=Math.sin(i),Math.abs(this.coslat0)<=a?(o=R(this.e,u*this.con,this.con*c),h=2*this.a*this.k0*o/this.cons,e.x=this.x0+h*Math.sin(l-this.long0),e.y=this.y0-this.con*h*Math.cos(l-this.long0),e):(Math.abs(this.sinlat0)<a?(t=2*this.a*this.k0/(1+n*Math.cos(p)),e.y=t*r):(t=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*r+this.cosX0*n*Math.cos(p))),e.y=t*(this.cosX0*r-this.sinX0*n*Math.cos(p))+this.y0),e.x=t*n*Math.sin(p)+this.x0,e))},inverse:function(e){var t,i,r,n,o;e.x-=this.x0,e.y-=this.y0;var h=Math.sqrt(e.x*e.x+e.y*e.y);if(this.sphere){var l=2*Math.atan(h/(.5*this.a*this.k0));return t=this.long0,i=this.lat0,h<=a?(e.x=t,e.y=i,e):(i=Math.asin(Math.cos(l)*this.sinlat0+e.y*Math.sin(l)*this.coslat0/h),t=Math.abs(this.coslat0)<a?this.lat0>0?B(this.long0+Math.atan2(e.x,-1*e.y)):B(this.long0+Math.atan2(e.x,e.y)):B(this.long0+Math.atan2(e.x*Math.sin(l),h*this.coslat0*Math.cos(l)-e.y*this.sinlat0*Math.sin(l))),e.x=t,e.y=i,e)}if(Math.abs(this.coslat0)<=a){if(h<=a)return i=this.lat0,t=this.long0,e.x=t,e.y=i,e;e.x*=this.con,e.y*=this.con,r=h*this.cons/(2*this.a*this.k0),i=this.con*z(this.e,r),t=this.con*B(this.con*this.long0+Math.atan2(e.x,-1*e.y))}else n=2*Math.atan(h*this.cosX0/(2*this.a*this.k0*this.ms1)),t=this.long0,h<=a?o=this.X0:(o=Math.asin(Math.cos(n)*this.sinX0+e.y*Math.sin(n)*this.cosX0/h),t=B(this.long0+Math.atan2(e.x*Math.sin(n),h*this.cosX0*Math.cos(n)-e.y*this.sinX0*Math.sin(n)))),i=-1*z(this.e,Math.tan(.5*(s+o)));return e.x=t,e.y=i,e},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)"],ssfn_:function(e,t,i){return t*=i,Math.tan(.5*(s+e))*Math.pow((1-t)/(1+t),.5*i)}};var Ue={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),i=this.a,r=1/this.rf,s=2*r-Math.pow(r,2),a=this.e=Math.sqrt(s);this.R=this.k0*i*Math.sqrt(1-s)/(1-s*Math.pow(t,2)),this.alpha=Math.sqrt(1+s/(1-s)*Math.pow(Math.cos(e),4)),this.b0=Math.asin(t/this.alpha);var n=Math.log(Math.tan(Math.PI/4+this.b0/2)),o=Math.log(Math.tan(Math.PI/4+e/2)),h=Math.log((1+a*t)/(1-a*t));this.K=n-this.alpha*o+this.alpha*a/2*h},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),i=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),r=-this.alpha*(t+i)+this.K,s=2*(Math.atan(Math.exp(r))-Math.PI/4),a=this.alpha*(e.x-this.lambda0),n=Math.atan(Math.sin(a)/(Math.sin(this.b0)*Math.tan(s)+Math.cos(this.b0)*Math.cos(a))),o=Math.asin(Math.cos(this.b0)*Math.sin(s)-Math.sin(this.b0)*Math.cos(s)*Math.cos(a));return e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,e.x=this.R*n+this.x0,e},inverse:function(e){for(var t=e.x-this.x0,i=e.y-this.y0,r=t/this.R,s=2*(Math.atan(Math.exp(i/this.R))-Math.PI/4),a=Math.asin(Math.cos(this.b0)*Math.sin(s)+Math.sin(this.b0)*Math.cos(s)*Math.cos(r)),n=Math.atan(Math.sin(r)/(Math.cos(this.b0)*Math.cos(r)-Math.sin(this.b0)*Math.tan(s))),o=this.lambda0+n/this.alpha,h=0,l=a,u=-1e3,c=0;Math.abs(l-u)>1e-7;){if(++c>20)return;h=1/this.alpha*(Math.log(Math.tan(Math.PI/4+a/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(l))/2)),u=l,l=2*Math.atan(Math.exp(h))-Math.PI/2}return e.x=o,e.y=l,e},names:["somerc"]};var De={init:function(){this.no_off=this.no_off||!1,this.no_rot=this.no_rot||!1,isNaN(this.k0)&&(this.k0=1);var e=Math.sin(this.lat0),t=Math.cos(this.lat0),i=this.e*e;this.bl=Math.sqrt(1+this.es/(1-this.es)*Math.pow(t,4)),this.al=this.a*this.bl*this.k0*Math.sqrt(1-this.es)/(1-i*i);var r,s,a=R(this.e,this.lat0,e),n=this.bl/t*Math.sqrt((1-this.es)/(1-i*i));if(n*n<1&&(n=1),isNaN(this.longc)){var o=R(this.e,this.lat1,Math.sin(this.lat1)),h=R(this.e,this.lat2,Math.sin(this.lat2));this.lat0>=0?this.el=(n+Math.sqrt(n*n-1))*Math.pow(a,this.bl):this.el=(n-Math.sqrt(n*n-1))*Math.pow(a,this.bl);var l=Math.pow(o,this.bl),u=Math.pow(h,this.bl);s=.5*((r=this.el/l)-1/r);var c=(this.el*this.el-u*l)/(this.el*this.el+u*l),d=(u-l)/(u+l),p=B(this.long1-this.long2);this.long0=.5*(this.long1+this.long2)-Math.atan(c*Math.tan(.5*this.bl*p)/d)/this.bl,this.long0=B(this.long0);var f=B(this.long1-this.long0);this.gamma0=Math.atan(Math.sin(this.bl*f)/s),this.alpha=Math.asin(n*Math.sin(this.gamma0))}else r=this.lat0>=0?n+Math.sqrt(n*n-1):n-Math.sqrt(n*n-1),this.el=r*Math.pow(a,this.bl),s=.5*(r-1/r),this.gamma0=Math.asin(Math.sin(this.alpha)/n),this.long0=this.longc-Math.asin(s*Math.tan(this.gamma0))/this.bl;this.no_off?this.uc=0:this.lat0>=0?this.uc=this.al/this.bl*Math.atan2(Math.sqrt(n*n-1),Math.cos(this.alpha)):this.uc=-1*this.al/this.bl*Math.atan2(Math.sqrt(n*n-1),Math.cos(this.alpha))},forward:function(e){var t,i,r,n=e.x,o=e.y,l=B(n-this.long0);if(Math.abs(Math.abs(o)-s)<=a)r=o>0?-1:1,i=this.al/this.bl*Math.log(Math.tan(h+r*this.gamma0*.5)),t=-1*r*s*this.al/this.bl;else{var u=R(this.e,o,Math.sin(o)),c=this.el/Math.pow(u,this.bl),d=.5*(c-1/c),p=.5*(c+1/c),f=Math.sin(this.bl*l),g=(d*Math.sin(this.gamma0)-f*Math.cos(this.gamma0))/p;i=Math.abs(Math.abs(g)-1)<=a?Number.POSITIVE_INFINITY:.5*this.al*Math.log((1-g)/(1+g))/this.bl,t=Math.abs(Math.cos(this.bl*l))<=a?this.al*this.bl*l:this.al*Math.atan2(d*Math.cos(this.gamma0)+f*Math.sin(this.gamma0),Math.cos(this.bl*l))/this.bl}return this.no_rot?(e.x=this.x0+t,e.y=this.y0+i):(t-=this.uc,e.x=this.x0+i*Math.cos(this.alpha)+t*Math.sin(this.alpha),e.y=this.y0+t*Math.cos(this.alpha)-i*Math.sin(this.alpha)),e},inverse:function(e){var t,i;this.no_rot?(i=e.y-this.y0,t=e.x-this.x0):(i=(e.x-this.x0)*Math.cos(this.alpha)-(e.y-this.y0)*Math.sin(this.alpha),t=(e.y-this.y0)*Math.cos(this.alpha)+(e.x-this.x0)*Math.sin(this.alpha),t+=this.uc);var r=Math.exp(-1*this.bl*i/this.al),n=.5*(r-1/r),o=.5*(r+1/r),h=Math.sin(this.bl*t/this.al),l=(h*Math.cos(this.gamma0)+n*Math.sin(this.gamma0))/o,u=Math.pow(this.el/Math.sqrt((1+l)/(1-l)),1/this.bl);return Math.abs(l-1)<a?(e.x=this.long0,e.y=s):Math.abs(l+1)<a?(e.x=this.long0,e.y=-1*s):(e.y=z(this.e,u),e.x=B(this.long0-Math.atan2(n*Math.cos(this.gamma0)-h*Math.sin(this.gamma0),Math.cos(this.bl*t/this.al))/this.bl)),e},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","omerc"]};var _e={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<a)){var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),i=Math.cos(this.lat1),r=N(this.e,t,i),s=R(this.e,this.lat1,t),n=Math.sin(this.lat2),o=Math.cos(this.lat2),h=N(this.e,n,o),l=R(this.e,this.lat2,n),u=R(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>a?this.ns=Math.log(r/h)/Math.log(s/l):this.ns=t,isNaN(this.ns)&&(this.ns=t),this.f0=r/(this.ns*Math.pow(s,this.ns)),this.rh=this.a*this.f0*Math.pow(u,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(e){var t=e.x,i=e.y;Math.abs(2*Math.abs(i)-Math.PI)<=a&&(i=I(i)*(s-2*a));var r,n,o=Math.abs(Math.abs(i)-s);if(o>a)r=R(this.e,i,Math.sin(i)),n=this.a*this.f0*Math.pow(r,this.ns);else{if((o=i*this.ns)<=0)return null;n=0}var h=this.ns*B(t-this.long0);return e.x=this.k0*(n*Math.sin(h))+this.x0,e.y=this.k0*(this.rh-n*Math.cos(h))+this.y0,e},inverse:function(e){var t,i,r,a,n,o=(e.x-this.x0)/this.k0,h=this.rh-(e.y-this.y0)/this.k0;this.ns>0?(t=Math.sqrt(o*o+h*h),i=1):(t=-Math.sqrt(o*o+h*h),i=-1);var l=0;if(0!==t&&(l=Math.atan2(i*o,i*h)),0!==t||this.ns>0){if(i=1/this.ns,r=Math.pow(t/(this.a*this.f0),i),-9999===(a=z(this.e,r)))return null}else a=-s;return n=B(l/this.ns+this.long0),e.x=n,e.y=a,e},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_2SP","lcc"]};var Oe={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(e){var t,i,r,s,a,n,o,h=e.x,l=e.y,u=B(h-this.long0);return t=Math.pow((1+this.e*Math.sin(l))/(1-this.e*Math.sin(l)),this.alfa*this.e/2),i=2*(Math.atan(this.k*Math.pow(Math.tan(l/2+this.s45),this.alfa)/t)-this.s45),r=-u*this.alfa,s=Math.asin(Math.cos(this.ad)*Math.sin(i)+Math.sin(this.ad)*Math.cos(i)*Math.cos(r)),a=Math.asin(Math.cos(i)*Math.sin(r)/Math.cos(s)),n=this.n*a,o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(s/2+this.s45),this.n),e.y=o*Math.cos(n)/1,e.x=o*Math.sin(n)/1,this.czech||(e.y*=-1,e.x*=-1),e},inverse:function(e){var t,i,r,s,a,n,o,h=e.x;e.x=e.y,e.y=h,this.czech||(e.y*=-1,e.x*=-1),a=Math.sqrt(e.x*e.x+e.y*e.y),s=Math.atan2(e.y,e.x)/Math.sin(this.s0),r=2*(Math.atan(Math.pow(this.ro0/a,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),t=Math.asin(Math.cos(this.ad)*Math.sin(r)-Math.sin(this.ad)*Math.cos(r)*Math.cos(s)),i=Math.asin(Math.cos(r)*Math.sin(s)/Math.cos(t)),e.x=this.long0-i/this.alfa,n=t,o=0;var l=0;do{e.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(t/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(n))/(1-this.e*Math.sin(n)),this.e/2))-this.s45),Math.abs(n-e.y)<1e-10&&(o=1),n=e.y,l+=1}while(0===o&&l<15);return l>=15?null:e},names:["Krovak","krovak"]},Ge=function(e,t,i,r,s){return e*s-t*Math.sin(2*s)+i*Math.sin(4*s)-r*Math.sin(6*s)},Ve=function(e){return 1-.25*e*(1+e/16*(3+1.25*e))},je=function(e){return.375*e*(1+.25*e*(1+.46875*e))},He=function(e){return.05859375*e*e*(1+.75*e)},We=function(e){return e*e*e*(35/3072)},qe=function(e,t,i){var r=t*i;return e/Math.sqrt(1-r*r)},Ze=function(e){return Math.abs(e)<s?e:e-I(e)*Math.PI},Ye=function(e,t,i,r,s){var a,n;a=e/t;for(var o=0;o<15;o++)if(a+=n=(e-(t*a-i*Math.sin(2*a)+r*Math.sin(4*a)-s*Math.sin(6*a)))/(t-2*i*Math.cos(2*a)+4*r*Math.cos(4*a)-6*s*Math.cos(6*a)),Math.abs(n)<=1e-10)return a;return NaN};var Je={init:function(){this.sphere||(this.e0=Ve(this.es),this.e1=je(this.es),this.e2=He(this.es),this.e3=We(this.es),this.ml0=this.a*Ge(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(e){var t,i,r=e.x,s=e.y;if(r=B(r-this.long0),this.sphere)t=this.a*Math.asin(Math.cos(s)*Math.sin(r)),i=this.a*(Math.atan2(Math.tan(s),Math.cos(r))-this.lat0);else{var a=Math.sin(s),n=Math.cos(s),o=qe(this.a,this.e,a),h=Math.tan(s)*Math.tan(s),l=r*Math.cos(s),u=l*l,c=this.es*n*n/(1-this.es);t=o*l*(1-u*h*(1/6-(8-h+8*c)*u/120)),i=this.a*Ge(this.e0,this.e1,this.e2,this.e3,s)-this.ml0+o*a/n*u*(.5+(5-h+6*c)*u/24)}return e.x=t+this.x0,e.y=i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,i,r=e.x/this.a,n=e.y/this.a;if(this.sphere){var o=n+this.lat0;t=Math.asin(Math.sin(o)*Math.cos(r)),i=Math.atan2(Math.tan(r),Math.cos(o))}else{var h=this.ml0/this.a+n,l=Ye(h,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(l)-s)<=a)return e.x=this.long0,e.y=s,n<0&&(e.y*=-1),e;var u=qe(this.a,this.e,Math.sin(l)),c=u*u*u/this.a/this.a*(1-this.es),d=Math.pow(Math.tan(l),2),p=r*this.a/u,f=p*p;t=l-u*Math.tan(l)/c*p*p*(.5-(1+3*d)*p*p/24),i=p*(1-f*(d/3+(1+3*d)*d*f/15))/Math.cos(l)}return e.x=B(i+this.long0),e.y=Ze(t),e},names:["Cassini","Cassini_Soldner","cass"]},Ke=function(e,t){var i;return e>1e-7?(1-e*e)*(t/(1-(i=e*t)*i)-.5/e*Math.log((1-i)/(1+i))):2*t};var Qe={init:function(){var e,t=Math.abs(this.lat0);if(Math.abs(t-s)<a?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(t)<a?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=Ke(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(e){var t,i=[];return i[0]=.3333333333333333*e,t=e*e,i[0]+=.17222222222222222*t,i[1]=.06388888888888888*t,t*=e,i[0]+=.10257936507936508*t,i[1]+=.0664021164021164*t,i[2]=.016415012942191543*t,i}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),e=Math.sin(this.lat0),this.sinb1=Ke(this.e,e)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*e*e)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(e){var t,i,r,n,o,l,u,c,d,p,f=e.x,g=e.y;if(f=B(f-this.long0),this.sphere){if(o=Math.sin(g),p=Math.cos(g),r=Math.cos(f),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((i=this.mode===this.EQUIT?1+p*r:1+this.sinph0*o+this.cosph0*p*r)<=a)return null;t=(i=Math.sqrt(2/i))*p*Math.sin(f),i*=this.mode===this.EQUIT?o:this.cosph0*o-this.sinph0*p*r}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(r=-r),Math.abs(g+this.phi0)<a)return null;i=h-.5*g,t=(i=2*(this.mode===this.S_POLE?Math.cos(i):Math.sin(i)))*Math.sin(f),i*=r}}else{switch(u=0,c=0,d=0,r=Math.cos(f),n=Math.sin(f),o=Math.sin(g),l=Ke(this.e,o),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(u=l/this.qp,c=Math.sqrt(1-u*u)),this.mode){case this.OBLIQ:d=1+this.sinb1*u+this.cosb1*c*r;break;case this.EQUIT:d=1+c*r;break;case this.N_POLE:d=s+g,l=this.qp-l;break;case this.S_POLE:d=g-s,l=this.qp+l}if(Math.abs(d)<a)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:d=Math.sqrt(2/d),i=this.mode===this.OBLIQ?this.ymf*d*(this.cosb1*u-this.sinb1*c*r):(d=Math.sqrt(2/(1+c*r)))*u*this.ymf,t=this.xmf*d*c*n;break;case this.N_POLE:case this.S_POLE:l>=0?(t=(d=Math.sqrt(l))*n,i=r*(this.mode===this.S_POLE?d:-d)):t=i=0}}return e.x=this.a*t+this.x0,e.y=this.a*i+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,i,r,n,o,h,l,u,c,d,p=e.x/this.a,f=e.y/this.a;if(this.sphere){var g,m=0,v=0;if((i=.5*(g=Math.sqrt(p*p+f*f)))>1)return null;switch(i=2*Math.asin(i),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(v=Math.sin(i),m=Math.cos(i)),this.mode){case this.EQUIT:i=Math.abs(g)<=a?0:Math.asin(f*v/g),p*=v,f=m*g;break;case this.OBLIQ:i=Math.abs(g)<=a?this.phi0:Math.asin(m*this.sinph0+f*v*this.cosph0/g),p*=v*this.cosph0,f=(m-Math.sin(i)*this.sinph0)*g;break;case this.N_POLE:f=-f,i=s-i;break;case this.S_POLE:i-=s}t=0!==f||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(p,f):0}else{if(l=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(p/=this.dd,f*=this.dd,(h=Math.sqrt(p*p+f*f))<a)return e.x=0,e.y=this.phi0,e;n=2*Math.asin(.5*h/this.rq),r=Math.cos(n),p*=n=Math.sin(n),this.mode===this.OBLIQ?(l=r*this.sinb1+f*n*this.cosb1/h,o=this.qp*l,f=h*this.cosb1*r-f*this.sinb1*n):(l=f*n/h,o=this.qp*l,f=h*r)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(f=-f),!(o=p*p+f*f))return e.x=0,e.y=this.phi0,e;l=1-o/this.qp,this.mode===this.S_POLE&&(l=-l)}t=Math.atan2(p,f),u=Math.asin(l),c=this.apa,d=u+u,i=u+c[0]*Math.sin(d)+c[1]*Math.sin(d+d)+c[2]*Math.sin(d+d+d)}return e.x=B(this.long0+t),e.y=i,e},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4},Xe=function(e){return Math.abs(e)>1&&(e=e>1?1:-1),Math.asin(e)};var $e={init:function(){Math.abs(this.lat1+this.lat2)<a||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=N(this.e3,this.sin_po,this.cos_po),this.qs1=Ke(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=N(this.e3,this.sin_po,this.cos_po),this.qs2=Ke(this.e3,this.sin_po,this.cos_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Ke(this.e3,this.sin_po,this.cos_po),Math.abs(this.lat1-this.lat2)>a?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(e){var t=e.x,i=e.y;this.sin_phi=Math.sin(i),this.cos_phi=Math.cos(i);var r=Ke(this.e3,this.sin_phi,this.cos_phi),s=this.a*Math.sqrt(this.c-this.ns0*r)/this.ns0,a=this.ns0*B(t-this.long0),n=s*Math.sin(a)+this.x0,o=this.rh-s*Math.cos(a)+this.y0;return e.x=n,e.y=o,e},inverse:function(e){var t,i,r,s,a,n;return e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns0>=0?(t=Math.sqrt(e.x*e.x+e.y*e.y),r=1):(t=-Math.sqrt(e.x*e.x+e.y*e.y),r=-1),s=0,0!==t&&(s=Math.atan2(r*e.x,r*e.y)),r=t*this.ns0/this.a,this.sphere?n=Math.asin((this.c-r*r)/(2*this.ns0)):(i=(this.c-r*r)/this.ns0,n=this.phi1z(this.e3,i)),a=B(s/this.ns0+this.long0),e.x=a,e.y=n,e},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(e,t){var i,r,s,n,o=Xe(.5*t);if(e<a)return o;for(var h=e*e,l=1;l<=25;l++)if(o+=n=.5*(s=1-(r=e*(i=Math.sin(o)))*r)*s/Math.cos(o)*(t/(1-h)-i/s+.5/e*Math.log((1-r)/(1+r))),Math.abs(n)<=1e-7)return o;return null}};var et={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(e){var t,i,r,s,n,o,h,l=e.x,u=e.y;return r=B(l-this.long0),t=Math.sin(u),i=Math.cos(u),s=Math.cos(r),1,(n=this.sin_p14*t+this.cos_p14*i*s)>0||Math.abs(n)<=a?(o=this.x0+1*this.a*i*Math.sin(r)/n,h=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*i*s)/n):(o=this.x0+this.infinity_dist*i*Math.sin(r),h=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*i*s)),e.x=o,e.y=h,e},inverse:function(e){var t,i,r,s,a,n;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(t=Math.sqrt(e.x*e.x+e.y*e.y))?(s=Math.atan2(t,this.rc),i=Math.sin(s),r=Math.cos(s),n=Xe(r*this.sin_p14+e.y*i*this.cos_p14/t),a=Math.atan2(e.x*i,t*this.cos_p14*r-e.y*this.sin_p14*i),a=B(this.long0+a)):(n=this.phic0,a=0),e.x=a,e.y=n,e},names:["gnom"]};var tt={init:function(){this.sphere||(this.k0=N(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t,i,r=e.x,s=e.y,a=B(r-this.long0);if(this.sphere)t=this.x0+this.a*a*Math.cos(this.lat_ts),i=this.y0+this.a*Math.sin(s)/Math.cos(this.lat_ts);else{var n=Ke(this.e,Math.sin(s));t=this.x0+this.a*this.k0*a,i=this.y0+this.a*n*.5/this.k0}return e.x=t,e.y=i,e},inverse:function(e){var t,i;return e.x-=this.x0,e.y-=this.y0,this.sphere?(t=B(this.long0+e.x/this.a/Math.cos(this.lat_ts)),i=Math.asin(e.y/this.a*Math.cos(this.lat_ts))):(i=function(e,t){var i=1-(1-e*e)/(2*e)*Math.log((1-e)/(1+e));if(Math.abs(Math.abs(t)-i)<1e-6)return t<0?-1*s:s;for(var r,a,n,o,h=Math.asin(.5*t),l=0;l<30;l++)if(a=Math.sin(h),n=Math.cos(h),o=e*a,h+=r=Math.pow(1-o*o,2)/(2*n)*(t/(1-e*e)-a/(1-o*o)+.5/e*Math.log((1-o)/(1+o))),Math.abs(r)<=1e-10)return h;return NaN}(this.e,2*e.y*this.k0/this.a),t=B(this.long0+e.x/(this.a*this.k0))),e.x=t,e.y=i,e},names:["cea"]};var it={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,i=e.y,r=B(t-this.long0),s=Ze(i-this.lat0);return e.x=this.x0+this.a*r*this.rc,e.y=this.y0+this.a*s,e},inverse:function(e){var t=e.x,i=e.y;return e.x=B(this.long0+(t-this.x0)/(this.a*this.rc)),e.y=Ze(this.lat0+(i-this.y0)/this.a),e},names:["Equirectangular","Equidistant_Cylindrical","eqc"]};var rt={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Ve(this.es),this.e1=je(this.es),this.e2=He(this.es),this.e3=We(this.es),this.ml0=this.a*Ge(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,i,r,s=e.x,n=e.y,o=B(s-this.long0);if(r=o*Math.sin(n),this.sphere)Math.abs(n)<=a?(t=this.a*o,i=-1*this.a*this.lat0):(t=this.a*Math.sin(r)/Math.tan(n),i=this.a*(Ze(n-this.lat0)+(1-Math.cos(r))/Math.tan(n)));else if(Math.abs(n)<=a)t=this.a*o,i=-1*this.ml0;else{var h=qe(this.a,this.e,Math.sin(n))/Math.tan(n);t=h*Math.sin(r),i=this.a*Ge(this.e0,this.e1,this.e2,this.e3,n)-this.ml0+h*(1-Math.cos(r))}return e.x=t+this.x0,e.y=i+this.y0,e},inverse:function(e){var t,i,r,s,n,o,h,l,u;if(r=e.x-this.x0,s=e.y-this.y0,this.sphere)if(Math.abs(s+this.a*this.lat0)<=a)t=B(r/this.a+this.long0),i=0;else{var c;for(o=this.lat0+s/this.a,h=r*r/this.a/this.a+o*o,l=o,n=20;n;--n)if(l+=u=-1*(o*(l*(c=Math.tan(l))+1)-l-.5*(l*l+h)*c)/((l-o)/c-1),Math.abs(u)<=a){i=l;break}t=B(this.long0+Math.asin(r*Math.tan(l)/this.a)/Math.sin(i))}else if(Math.abs(s+this.ml0)<=a)i=0,t=B(this.long0+r/this.a);else{var d,p,f,g,m;for(o=(this.ml0+s)/this.a,h=r*r/this.a/this.a+o*o,l=o,n=20;n;--n)if(m=this.e*Math.sin(l),d=Math.sqrt(1-m*m)*Math.tan(l),p=this.a*Ge(this.e0,this.e1,this.e2,this.e3,l),f=this.e0-2*this.e1*Math.cos(2*l)+4*this.e2*Math.cos(4*l)-6*this.e3*Math.cos(6*l),l-=u=(o*(d*(g=p/this.a)+1)-g-.5*d*(g*g+h))/(this.es*Math.sin(2*l)*(g*g+h-2*o*g)/(4*d)+(o-g)*(d*f-2/Math.sin(2*l))-f),Math.abs(u)<=a){i=l;break}d=Math.sqrt(1-this.es*Math.pow(Math.sin(i),2))*Math.tan(i),t=B(this.long0+Math.asin(r*d/this.a)/Math.sin(i))}return e.x=t,e.y=i,e},names:["Polyconic","poly"]};var st={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(e){var t,i=e.x,s=e.y-this.lat0,a=i-this.long0,n=s/r*1e-5,o=a,h=1,l=0;for(t=1;t<=10;t++)h*=n,l+=this.A[t]*h;var u,c=l,d=o,p=1,f=0,g=0,m=0;for(t=1;t<=6;t++)u=f*c+p*d,p=p*c-f*d,f=u,g=g+this.B_re[t]*p-this.B_im[t]*f,m=m+this.B_im[t]*p+this.B_re[t]*f;return e.x=m*this.a+this.x0,e.y=g*this.a+this.y0,e},inverse:function(e){var t,i,s=e.x,a=e.y,n=s-this.x0,o=(a-this.y0)/this.a,h=n/this.a,l=1,u=0,c=0,d=0;for(t=1;t<=6;t++)i=u*o+l*h,l=l*o-u*h,u=i,c=c+this.C_re[t]*l-this.C_im[t]*u,d=d+this.C_im[t]*l+this.C_re[t]*u;for(var p=0;p<this.iterations;p++){var f,g=c,m=d,v=o,y=h;for(t=2;t<=6;t++)f=m*c+g*d,g=g*c-m*d,m=f,v+=(t-1)*(this.B_re[t]*g-this.B_im[t]*m),y+=(t-1)*(this.B_im[t]*g+this.B_re[t]*m);g=1,m=0;var b=this.B_re[1],x=this.B_im[1];for(t=2;t<=6;t++)f=m*c+g*d,g=g*c-m*d,m=f,b+=t*(this.B_re[t]*g-this.B_im[t]*m),x+=t*(this.B_im[t]*g+this.B_re[t]*m);var w=b*b+x*x;c=(v*b+y*x)/w,d=(y*b-v*x)/w}var M=c,S=d,A=1,C=0;for(t=1;t<=9;t++)A*=M,C+=this.D[t]*A;var T=this.lat0+C*r*1e5,P=this.long0+S;return e.x=P,e.y=T,e},names:["New_Zealand_Map_Grid","nzmg"]};var at={init:function(){},forward:function(e){var t=e.x,i=e.y,r=B(t-this.long0),s=this.x0+this.a*r,a=this.y0+this.a*Math.log(Math.tan(Math.PI/4+i/2.5))*1.25;return e.x=s,e.y=a,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=B(this.long0+e.x/this.a),i=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Math.PI/4);return e.x=t,e.y=i,e},names:["Miller_Cylindrical","mill"]};var nt={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=Me(this.es)},forward:function(e){var t,i,r=e.x,s=e.y;if(r=B(r-this.long0),this.sphere){if(this.m)for(var n=this.n*Math.sin(s),o=20;o;--o){var h=(this.m*s+Math.sin(s)-n)/(this.m+Math.cos(s));if(s-=h,Math.abs(h)<a)break}else s=1!==this.n?Math.asin(this.n*Math.sin(s)):s;t=this.a*this.C_x*r*(this.m+Math.cos(s)),i=this.a*this.C_y*s}else{var l=Math.sin(s),u=Math.cos(s);i=this.a*Se(s,l,u,this.en),t=this.a*r*u/Math.sqrt(1-this.es*l*l)}return e.x=t,e.y=i,e},inverse:function(e){var t,i,r,n;return e.x-=this.x0,r=e.x/this.a,e.y-=this.y0,t=e.y/this.a,this.sphere?(t/=this.C_y,r/=this.C_x*(this.m+Math.cos(t)),this.m?t=Xe((this.m*t+Math.sin(t))/this.n):1!==this.n&&(t=Xe(Math.sin(t)/this.n)),r=B(r+this.long0),t=Ze(t)):(t=Ae(e.y/this.a,this.es,this.en),(n=Math.abs(t))<s?(n=Math.sin(t),i=this.long0+e.x*Math.sqrt(1-this.es*n*n)/(this.a*Math.cos(t)),r=B(i)):n-a<s&&(r=this.long0)),e.x=r,e.y=t,e},names:["Sinusoidal","sinu"]};var ot={init:function(){},forward:function(e){for(var t=e.x,i=e.y,r=B(t-this.long0),s=i,n=Math.PI*Math.sin(i),o=0;;o++){var h=-(s+Math.sin(s)-n)/(1+Math.cos(s));if(s+=h,Math.abs(h)<a)break}s/=2,Math.PI/2-Math.abs(i)<a&&(r=0);var l=.900316316158*this.a*r*Math.cos(s)+this.x0,u=1.4142135623731*this.a*Math.sin(s)+this.y0;return e.x=l,e.y=u,e},inverse:function(e){var t,i;e.x-=this.x0,e.y-=this.y0,i=e.y/(1.4142135623731*this.a),Math.abs(i)>.999999999999&&(i=.999999999999),t=Math.asin(i);var r=B(this.long0+e.x/(.900316316158*this.a*Math.cos(t)));r<-Math.PI&&(r=-Math.PI),r>Math.PI&&(r=Math.PI),i=(2*t+Math.sin(2*t))/Math.PI,Math.abs(i)>1&&(i=1);var s=Math.asin(i);return e.x=r,e.y=s,e},names:["Mollweide","moll"]};var ht={init:function(){Math.abs(this.lat1+this.lat2)<a||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Ve(this.es),this.e1=je(this.es),this.e2=He(this.es),this.e3=We(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=N(this.e,this.sinphi,this.cosphi),this.ml1=Ge(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<a?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=N(this.e,this.sinphi,this.cosphi),this.ml2=Ge(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Ge(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(e){var t,i=e.x,r=e.y;if(this.sphere)t=this.a*(this.g-r);else{var s=Ge(this.e0,this.e1,this.e2,this.e3,r);t=this.a*(this.g-s)}var a=this.ns*B(i-this.long0),n=this.x0+t*Math.sin(a),o=this.y0+this.rh-t*Math.cos(a);return e.x=n,e.y=o,e},inverse:function(e){var t,i,r,s;e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns>=0?(i=Math.sqrt(e.x*e.x+e.y*e.y),t=1):(i=-Math.sqrt(e.x*e.x+e.y*e.y),t=-1);var a=0;if(0!==i&&(a=Math.atan2(t*e.x,t*e.y)),this.sphere)return s=B(this.long0+a/this.ns),r=Ze(this.g-i/this.a),e.x=s,e.y=r,e;var n=this.g-i/this.a;return r=Ye(n,this.e0,this.e1,this.e2,this.e3),s=B(this.long0+a/this.ns),e.x=s,e.y=r,e},names:["Equidistant_Conic","eqdc"]};var lt={init:function(){this.R=this.a},forward:function(e){var t,i,r=e.x,n=e.y,o=B(r-this.long0);Math.abs(n)<=a&&(t=this.x0+this.R*o,i=this.y0);var h=Xe(2*Math.abs(n/Math.PI));(Math.abs(o)<=a||Math.abs(Math.abs(n)-s)<=a)&&(t=this.x0,i=n>=0?this.y0+Math.PI*this.R*Math.tan(.5*h):this.y0+Math.PI*this.R*-Math.tan(.5*h));var l=.5*Math.abs(Math.PI/o-o/Math.PI),u=l*l,c=Math.sin(h),d=Math.cos(h),p=d/(c+d-1),f=p*p,g=p*(2/c-1),m=g*g,v=Math.PI*this.R*(l*(p-m)+Math.sqrt(u*(p-m)*(p-m)-(m+u)*(f-m)))/(m+u);o<0&&(v=-v),t=this.x0+v;var y=u+p;return v=Math.PI*this.R*(g*y-l*Math.sqrt((m+u)*(u+1)-y*y))/(m+u),i=n>=0?this.y0+v:this.y0-v,e.x=t,e.y=i,e},inverse:function(e){var t,i,r,s,n,o,h,l,u,c,d,p;return e.x-=this.x0,e.y-=this.y0,d=Math.PI*this.R,n=(r=e.x/d)*r+(s=e.y/d)*s,d=3*(s*s/(l=-2*(o=-Math.abs(s)*(1+n))+1+2*s*s+n*n)+(2*(h=o-2*s*s+r*r)*h*h/l/l/l-9*o*h/l/l)/27)/(u=(o-h*h/3/l)/l)/(c=2*Math.sqrt(-u/3)),Math.abs(d)>1&&(d=d>=0?1:-1),p=Math.acos(d)/3,i=e.y>=0?(-c*Math.cos(p+Math.PI/3)-h/3/l)*Math.PI:-(-c*Math.cos(p+Math.PI/3)-h/3/l)*Math.PI,t=Math.abs(r)<a?this.long0:B(this.long0+Math.PI*(n-1+Math.sqrt(1+2*(r*r-s*s)+n*n))/2/r),e.x=t,e.y=i,e},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]};var ut={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t,i,r,n,o,h,l,u,c,d,p,f,g,m,v,y,b,x,w,M,S,A,C=e.x,T=e.y,P=Math.sin(e.y),F=Math.cos(e.y),L=B(C-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=a?(e.x=this.x0+this.a*(s-T)*Math.sin(L),e.y=this.y0-this.a*(s-T)*Math.cos(L),e):Math.abs(this.sin_p12+1)<=a?(e.x=this.x0+this.a*(s+T)*Math.sin(L),e.y=this.y0+this.a*(s+T)*Math.cos(L),e):(x=this.sin_p12*P+this.cos_p12*F*Math.cos(L),b=(y=Math.acos(x))/Math.sin(y),e.x=this.x0+this.a*b*F*Math.sin(L),e.y=this.y0+this.a*b*(this.cos_p12*P-this.sin_p12*F*Math.cos(L)),e):(t=Ve(this.es),i=je(this.es),r=He(this.es),n=We(this.es),Math.abs(this.sin_p12-1)<=a?(o=this.a*Ge(t,i,r,n,s),h=this.a*Ge(t,i,r,n,T),e.x=this.x0+(o-h)*Math.sin(L),e.y=this.y0-(o-h)*Math.cos(L),e):Math.abs(this.sin_p12+1)<=a?(o=this.a*Ge(t,i,r,n,s),h=this.a*Ge(t,i,r,n,T),e.x=this.x0+(o+h)*Math.sin(L),e.y=this.y0+(o+h)*Math.cos(L),e):(l=P/F,u=qe(this.a,this.e,this.sin_p12),c=qe(this.a,this.e,P),d=Math.atan((1-this.es)*l+this.es*u*this.sin_p12/(c*F)),w=0===(p=Math.atan2(Math.sin(L),this.cos_p12*Math.tan(d)-this.sin_p12*Math.cos(L)))?Math.asin(this.cos_p12*Math.sin(d)-this.sin_p12*Math.cos(d)):Math.abs(Math.abs(p)-Math.PI)<=a?-Math.asin(this.cos_p12*Math.sin(d)-this.sin_p12*Math.cos(d)):Math.asin(Math.sin(L)*Math.cos(d)/Math.sin(p)),f=this.e*this.sin_p12/Math.sqrt(1-this.es),y=u*w*(1-(M=w*w)*(v=(g=this.e*this.cos_p12*Math.cos(p)/Math.sqrt(1-this.es))*g)*(1-v)/6+(S=M*w)/8*(m=f*g)*(1-2*v)+(A=S*w)/120*(v*(4-7*v)-3*f*f*(1-7*v))-A*w/48*m),e.x=this.x0+y*Math.sin(p),e.y=this.y0+y*Math.cos(p),e))},inverse:function(e){var t,i,r,n,o,h,l,u,c,d,p,f,g,m,v,y,b,x,w,M,S,A;if(e.x-=this.x0,e.y-=this.y0,this.sphere){if((t=Math.sqrt(e.x*e.x+e.y*e.y))>2*s*this.a)return;return i=t/this.a,r=Math.sin(i),n=Math.cos(i),o=this.long0,Math.abs(t)<=a?h=this.lat0:(h=Xe(n*this.sin_p12+e.y*r*this.cos_p12/t),l=Math.abs(this.lat0)-s,o=Math.abs(l)<=a?this.lat0>=0?B(this.long0+Math.atan2(e.x,-e.y)):B(this.long0-Math.atan2(-e.x,e.y)):B(this.long0+Math.atan2(e.x*r,t*this.cos_p12*n-e.y*this.sin_p12*r))),e.x=o,e.y=h,e}return u=Ve(this.es),c=je(this.es),d=He(this.es),p=We(this.es),Math.abs(this.sin_p12-1)<=a?(f=this.a*Ge(u,c,d,p,s),t=Math.sqrt(e.x*e.x+e.y*e.y),h=Ye((f-t)/this.a,u,c,d,p),o=B(this.long0+Math.atan2(e.x,-1*e.y)),e.x=o,e.y=h,e):Math.abs(this.sin_p12+1)<=a?(f=this.a*Ge(u,c,d,p,s),t=Math.sqrt(e.x*e.x+e.y*e.y),h=Ye((t-f)/this.a,u,c,d,p),o=B(this.long0+Math.atan2(e.x,e.y)),e.x=o,e.y=h,e):(t=Math.sqrt(e.x*e.x+e.y*e.y),v=Math.atan2(e.x,e.y),g=qe(this.a,this.e,this.sin_p12),y=Math.cos(v),x=-(b=this.e*this.cos_p12*y)*b/(1-this.es),w=3*this.es*(1-x)*this.sin_p12*this.cos_p12*y/(1-this.es),A=1-x*(S=(M=t/g)-x*(1+x)*Math.pow(M,3)/6-w*(1+3*x)*Math.pow(M,4)/24)*S/2-M*S*S*S/6,m=Math.asin(this.sin_p12*Math.cos(S)+this.cos_p12*Math.sin(S)*y),o=B(this.long0+Math.asin(Math.sin(v)*Math.sin(S)/Math.cos(m))),h=Math.atan((1-this.es*A*this.sin_p12/Math.sin(m))*Math.tan(m)/(1-this.es)),e.x=o,e.y=h,e)},names:["Azimuthal_Equidistant","aeqd"]};var ct={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,i,r,s,n,o,h,l=e.x,u=e.y;return r=B(l-this.long0),t=Math.sin(u),i=Math.cos(u),s=Math.cos(r),1,((n=this.sin_p14*t+this.cos_p14*i*s)>0||Math.abs(n)<=a)&&(o=1*this.a*i*Math.sin(r),h=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*i*s)),e.x=o,e.y=h,e},inverse:function(e){var t,i,r,n,o,h,l;return e.x-=this.x0,e.y-=this.y0,t=Math.sqrt(e.x*e.x+e.y*e.y),i=Xe(t/this.a),r=Math.sin(i),n=Math.cos(i),h=this.long0,Math.abs(t)<=a?(l=this.lat0,e.x=h,e.y=l,e):(l=Xe(n*this.sin_p14+e.y*r*this.cos_p14/t),o=Math.abs(this.lat0)-s,Math.abs(o)<=a?(h=this.lat0>=0?B(this.long0+Math.atan2(e.x,-e.y)):B(this.long0-Math.atan2(-e.x,e.y)),e.x=h,e.y=l,e):(h=B(this.long0+Math.atan2(e.x*r,t*this.cos_p14*n-e.y*this.sin_p14*r)),e.x=h,e.y=l,e))},names:["ortho"]};function dt(e){return e}var pt={init:function(){this.isGeocent=!0},forward:dt,inverse:dt,names:["geocent"]},ft=1,gt=2,mt=3,vt=4,yt=5,bt=6,xt=1,wt=2,Mt=3,St=4;function At(e,t,i,r){var n;return e<a?(r.value=xt,n=0):(n=Math.atan2(t,i),Math.abs(n)<=h?r.value=xt:n>h&&n<=s+h?(r.value=wt,n-=s):n>s+h||n<=-(s+h)?(r.value=Mt,n=n>=0?n-u:n+u):(r.value=St,n+=s)),n}function Ct(e,t){var i=e+t;return i<-u?i+=l:i>+u&&(i-=l),i}var Tt,Pt={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=s-h/2?this.face=yt:this.lat0<=-(s-h/2)?this.face=bt:Math.abs(this.long0)<=h?this.face=ft:Math.abs(this.long0)<=s+h?this.face=this.long0>0?gt:vt:this.face=mt,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(e){var t,i,r,a,n,o,l={x:0,y:0},c={value:0};if(e.x-=this.long0,t=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(e.y)):e.y,i=e.x,this.face===yt)a=s-t,i>=h&&i<=s+h?(c.value=xt,r=i-s):i>s+h||i<=-(s+h)?(c.value=wt,r=i>0?i-u:i+u):i>-(s+h)&&i<=-h?(c.value=Mt,r=i+s):(c.value=St,r=i);else if(this.face===bt)a=s+t,i>=h&&i<=s+h?(c.value=xt,r=-i+s):i<h&&i>=-h?(c.value=wt,r=-i):i<-h&&i>=-(s+h)?(c.value=Mt,r=-i-s):(c.value=St,r=i>0?-i+u:-i-u);else{var d,p,f,g,m,v;this.face===gt?i=Ct(i,+s):this.face===mt?i=Ct(i,+u):this.face===vt&&(i=Ct(i,-s)),g=Math.sin(t),m=Math.cos(t),v=Math.sin(i),d=m*Math.cos(i),p=m*v,f=g,this.face===ft?r=At(a=Math.acos(d),f,p,c):this.face===gt?r=At(a=Math.acos(p),f,-d,c):this.face===mt?r=At(a=Math.acos(-d),f,-p,c):this.face===vt?r=At(a=Math.acos(-p),f,d,c):(a=r=0,c.value=xt)}return o=Math.atan(12/u*(r+Math.acos(Math.sin(r)*Math.cos(h))-s)),n=Math.sqrt((1-Math.cos(a))/(Math.cos(o)*Math.cos(o))/(1-Math.cos(Math.atan(1/Math.cos(r))))),c.value===wt?o+=s:c.value===Mt?o+=u:c.value===St&&(o+=1.5*u),l.x=n*Math.cos(o),l.y=n*Math.sin(o),l.x=l.x*this.a+this.x0,l.y=l.y*this.a+this.y0,e.x=l.x,e.y=l.y,e},inverse:function(e){var t,i,r,a,n,o,h,l,c,d,p,f,g={lam:0,phi:0},m={value:0};if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,i=Math.atan(Math.sqrt(e.x*e.x+e.y*e.y)),t=Math.atan2(e.y,e.x),e.x>=0&&e.x>=Math.abs(e.y)?m.value=xt:e.y>=0&&e.y>=Math.abs(e.x)?(m.value=wt,t-=s):e.x<0&&-e.x>=Math.abs(e.y)?(m.value=Mt,t=t<0?t+u:t-u):(m.value=St,t+=s),c=u/12*Math.tan(t),n=Math.sin(c)/(Math.cos(c)-1/Math.sqrt(2)),o=Math.atan(n),(h=1-(r=Math.cos(t))*r*(a=Math.tan(i))*a*(1-Math.cos(Math.atan(1/Math.cos(o)))))<-1?h=-1:h>1&&(h=1),this.face===yt)l=Math.acos(h),g.phi=s-l,m.value===xt?g.lam=o+s:m.value===wt?g.lam=o<0?o+u:o-u:m.value===Mt?g.lam=o-s:g.lam=o;else if(this.face===bt)l=Math.acos(h),g.phi=l-s,m.value===xt?g.lam=-o+s:m.value===wt?g.lam=-o:m.value===Mt?g.lam=-o-s:g.lam=o<0?-o-u:-o+u;else{var v,y,b;c=(v=h)*v,y=(c+=(b=c>=1?0:Math.sqrt(1-c)*Math.sin(o))*b)>=1?0:Math.sqrt(1-c),m.value===wt?(c=y,y=-b,b=c):m.value===Mt?(y=-y,b=-b):m.value===St&&(c=y,y=b,b=-c),this.face===gt?(c=v,v=-y,y=c):this.face===mt?(v=-v,y=-y):this.face===vt&&(c=v,v=y,y=-c),g.phi=Math.acos(-b)-s,g.lam=Math.atan2(y,v),this.face===gt?g.lam=Ct(g.lam,-s):this.face===mt?g.lam=Ct(g.lam,-u):this.face===vt&&(g.lam=Ct(g.lam,+s))}return 0!==this.es&&(d=g.phi<0?1:0,p=Math.tan(g.phi),f=this.b/Math.sqrt(p*p+this.one_minus_f_squared),g.phi=Math.atan(Math.sqrt(this.a*this.a-f*f)/(this.one_minus_f*f)),d&&(g.phi=-g.phi)),g.lam+=this.long0,e.x=g.lam,e.y=g.phi,e},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]};ae.defaultDatum="WGS84",ae.Proj=Y,ae.WGS84=new ae.Proj("WGS84"),ae.Point=be,ae.toPoint=ee,ae.defs=F,ae.transform=te,ae.mgrs=he,ae.version=xe.a,(Tt=ae).Proj.projections.add(Ce),Tt.Proj.projections.add(ke),Tt.Proj.projections.add(Ne),Tt.Proj.projections.add(Re),Tt.Proj.projections.add(ze),Tt.Proj.projections.add(Ue),Tt.Proj.projections.add(De),Tt.Proj.projections.add(_e),Tt.Proj.projections.add(Oe),Tt.Proj.projections.add(Je),Tt.Proj.projections.add(Qe),Tt.Proj.projections.add($e),Tt.Proj.projections.add(et),Tt.Proj.projections.add(tt),Tt.Proj.projections.add(it),Tt.Proj.projections.add(rt),Tt.Proj.projections.add(st),Tt.Proj.projections.add(at),Tt.Proj.projections.add(nt),Tt.Proj.projections.add(ot),Tt.Proj.projections.add(ht),Tt.Proj.projections.add(lt),Tt.Proj.projections.add(ut),Tt.Proj.projections.add(ct),Tt.Proj.projections.add(pt),Tt.Proj.projections.add(Pt);t.a=ae},function(e,t,i){"use strict";i.d(t,"a",(function(){return xa})),i.d(t,"c",(function(){return wa})),i.d(t,"b",(function(){return Ma}));var r=i(6),s=i(0),a=i(1),n=i(4),o=function(e,t,i){this.map=e,this.parse(t,i)};o.prototype.parse=function(e,t){if(this.freeLayers=e.freeLayers||{},this.surfaces={},this.options=e.options||{},e.surfaces){var i=e.surfaces;if(Array.isArray(i))for(var r=0,s=i.length;r<s;r++)this.surfaces[i[r]]=[];else this.surfaces=i}if(!this.freeLayers||Array.isArray(this.freeLayers))this.freeLayers={};else if(this.freeLayers=JSON.parse(JSON.stringify(this.freeLayers)),t)for(var a in this.freeLayers){var n=this.freeLayers[a];"string"==typeof n.style&&(n.style=this.processUrl(n.style,""))}this.surfaces=JSON.parse(JSON.stringify(this.surfaces)),this.options=JSON.parse(JSON.stringify(this.options))},o.prototype.processUrl=function(e,t){return e?"string"!=typeof e||-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.map.url.baseUrlSchema+e:0==e.indexOf("/")?this.map.url.baseUrlOrigin+e:this.map.url.baseUrl+e:t},o.prototype.getInfo=function(){var e={surfaces:JSON.parse(JSON.stringify(this.surfaces)),freeLayers:JSON.parse(JSON.stringify(this.freeLayers)),options:JSON.parse(JSON.stringify(this.options))};this.map.renderer;if(this.map.renderer.getSuperElevationState()){var t=this.map.renderer.getSuperElevation();e.options={superelevation:[[t[0],t[2]],[t[1],t[3]]]}}return e};var h=o,l=a.a,u=function(e,t,i,r,s,a,n,o,h,l){this.gpu=e,this.gl=e.gl,this.texture=null,this.framebuffer=null,this.size=0,this.fileSize=r,this.width=0,this.height=0,this.repeat=a||!1,this.filter=n||"linear",this.image=null,this.loaded=!1,this.trilinear=!1,this.core=i,null!=t&&this.load(t,h,l,s,o)};u.prototype.kill=function(){this.gl.deleteTexture(this.texture),this.texture=null},u.prototype.getSize=function(){return this.size},u.prototype.createFromData=function(e,t,i,r,s){var a=this.gl;this.texture=a.createTexture(),a.bindTexture(a.TEXTURE_2D,this.texture),s?(s=a.REPEAT,this.repeat=!0):s=a.CLAMP_TO_EDGE,a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,s),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,s);var n=!1;switch(r){case"linear":a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);break;case"trilinear":a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),n=!0;break;default:a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST)}a.pixelStorei(a.UNPACK_ALIGNMENT,1),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,e,t,0,a.RGBA,a.UNSIGNED_BYTE,i),n&&a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null),this.width=e,this.height=t,this.size=e*t*4,this.loaded=!0},u.prototype.createFromImage=function(e,t,i,r){var s=this.gl,a=e.naturalWidth,n=e.naturalHeight,o=e;this.texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.texture),i?(i=s.REPEAT,this.repeat=!0):i=s.CLAMP_TO_EDGE,s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,i);var h=!1;switch(this.filter=t,t){case"linear":s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR);break;case"trilinear":s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),h=!0;break;default:s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST)}if((this.repeat||h)&&(!l.isPowerOfTwo(a)||!l.isPowerOfTwo(n))){a=l.nearestPowerOfTwo(a),n=l.nearestPowerOfTwo(n);var u=document.createElement("canvas");u.width=a,u.height=n,u.getContext("2d").drawImage(e,0,0,a,n),o=u}var c=this.gpu;c.anisoLevel&&s.texParameterf(s.TEXTURE_2D,c.anisoExt.TEXTURE_MAX_ANISOTROPY_EXT,c.anisoLevel),!0!==c.noTextures&&(s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,o),h&&s.generateMipmap(s.TEXTURE_2D)),s.bindTexture(s.TEXTURE_2D,null),this.width=a,this.height=n,this.size=a*n*4,this.loaded=!0},u.prototype.load=function(e,t,i,r,s){this.image=l.loadImage(e,function(){null!=this.core&&this.core.killed||(this.createFromImage(this.image,this.filter,this.repeat),s||(this.image=null),t?t():this.core.map&&this.core.map.markDirty&&this.core.map.markDirty())}.bind(this),function(){null!=this.core&&this.core.killed||i&&i()}.bind(this),null,r)},u.prototype.createFramebufferFromData=function(e,t,i){var r=this.gl,s=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,s),s.width=e,s.height=t;var a=r.createTexture();r.bindTexture(r.TEXTURE_2D,a),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.pixelStorei(r.UNPACK_ALIGNMENT,1),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,e,t,0,r.RGBA,r.UNSIGNED_BYTE,i);var n=r.createRenderbuffer();r.bindRenderbuffer(r.RENDERBUFFER,n),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,e,t),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,a,0),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,n),this.width=e,this.height=t,this.size=e*t*4,this.texture=a,this.renderbuffer=n,this.framebuffer=s,r.bindTexture(r.TEXTURE_2D,null),r.bindRenderbuffer(r.RENDERBUFFER,null),r.bindFramebuffer(r.FRAMEBUFFER,null)},u.prototype.createFramebuffer=function(e,t){if(null!=this.texture){var i=this.gl,r=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,r),r.width=e,r.height=t,i.bindTexture(i.TEXTURE_2D,this.texture);var s=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,s),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.texture,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,s),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),this.framebuffer=r,this.renderbuffer=s}},u.prototype.readFramebufferPixels=function(e,t,i,r,s,a){if(null!=this.texture){this.gpu.bindTexture(this),s||this.gpu.setFramebuffer(this);var n=this.gl;return a||(a=new Uint8Array(i*r*4)),n.readPixels(e,t,i,r,n.RGBA,n.UNSIGNED_BYTE,a),s||this.gpu.setFramebuffer(null),a}};var c=u,p=i(2),f=s.d,g=c,m=p.a,v=[[-1,-1,0,0],[0,-1,.5,1],[1,-1,1,0],[-1,0,0,.5],[0,0,.5,.5],[1,0,1,.5],[-1,1,0,1],[0,1,.5,0],[1,1,1,1]],y=[[0,1,3],[2,1,5],[6,3,7],[8,7,5]],b=function(e,t,i){this.map=e,this.id=i,this.parent=t,this.viewCounter=e.viewCounter,this.drawCounter=0,this.childrenReadyCount=0,this.renderReady=!1,this.geodataCounter=0,this.gridRenderCounter=0,this.texelSize=1,this.texelSize2=1,this.distance=1,this.tiltAngle=1,this.seCounter=0,this.metanode=null,this.lastMetanode=null,this.boundmetaresources=null,this.surface=null,this.surfaceMesh=null,this.surfaceGeodata=null,this.surfaceGeodataView=null,this.surfaceTextures=[],this.resourceSurface=null,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.resetDrawCommands=!1,this.drawCommands=[[],[],[]],this.bounds={},this.boundLayers={},this.boundTextures={},this.updateBounds=!0,this.hmap=null,this.heightMap=null,this.drawCommands=[[],[],[]],this.imageryCredits={},this.glueImageryCredits={},this.mapdataCredits={},this.resources=this.map.resourcesTree.findNode(i,!0),this.metaresources=this.map.resourcesTree.findAgregatedNode(i,5,!0),this.boundresources=this.map.resourcesTree.findAgregatedNode(i,8,!0),this.children=[null,null,null,null]};b.prototype.kill=function(){for(var e=0;e<4;e++)null!=this.children[e]&&this.children[e].kill();this.resources=null,this.metaresources=null,this.metanode=null,this.surface=null,this.surfaceMesh=null,this.surfaceTextures=[],this.surfaceGeodata=null,this.surfaceGeodataView=null,this.resourceSurface=null,this.bounds={},this.boundLayers={},this.boundTextures={},this.updateBounds=!0,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.renderReady=!1,this.lastSurface=null,this.lastState=null,this.lastRenderState=null,this.hmap=null,this.heightMap=null,this.drawCommands=[[],[],[]],this.imageryCredits={},this.glueImageryCredits={},this.mapdataCredits={},this.verifyChildren=!1,this.children=[null,null,null,null];var t=this.parent;this.parent=null,null!=t&&t.removeChild(this)},b.prototype.validate=function(){null==this.metaresources||this.metaresources.getMetatile(this.surface,null,this)},b.prototype.viewSwitched=function(){for(var e in this.lastSurface=this.surface,this.lastState={surfaceMesh:this.surfaceMesh,surfaceTextures:this.surfaceTextures,boundTextures:this.boundTextures,surfaceGeodata:this.surfaceGeodata,surfaceGeodataView:this.surfaceGeodataView,resourceSurface:this.resourceSurface},this.drawCommands[0].length>0?this.lastRenderState={drawCommands:this.drawCommands,imageryCredits:this.imageryCredits,mapdataCredits:this.mapdataCredits}:this.lastRenderState=null,this.verifyChildren=!0,this.renderReady=!1,this.lastMetanode=this.metanode,this.metanode=null,this.map.config.mapSoftViewSwitch||(this.metanode&&(this.metanode.border=null,this.metanode.border2=null,this.metanode.border3=null,this.metanode.borderNodes=null,this.metanode.borderReady=null),this.lastState=null,this.lastRenderState=null,this.lastMetanode=null,this.metanode=null,this.gridPoints=null),this.bounds)this.bounds[e]={sequence:[],alpha:[],transparent:!1,viewCoutner:0};this.boundLayers={},this.boundTextures={},this.updateBounds=!0,this.transparentBounds=!1,this.surface=null,this.surfaceMesh=null,this.surfaceTextures=[],this.surfaceGeodata=null,this.surfaceGeodataView=null,this.resourceSurface=null,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.virtualSurfacesUncomplete=!1,this.drawCommands=[[],[],[]],this.imageryCredits={},this.glueImageryCredits={},this.mapdataCredits={}},b.prototype.restoreLastState=function(){this.lastState&&(this.surfaceMesh=this.lastState.surfaceMesh,this.surfaceTextures=this.lastState.surfaceTextures,this.boundTextures=this.lastState.boundTextures,this.surfaceGeodata=this.lastState.surfaceGeodata,this.surfaceGeodataView=this.lastState.surfaceGeodataView,this.resourceSurface=this.lastState.resourceSurface,this.lastSurface=null,this.lastState=null,this.lastResourceSurface=null)},b.prototype.addChild=function(e){if(!this.children[e]){var t=this.id,i=[t[0]+1,t[1]<<1,t[2]<<1];switch(e){case 1:i[1]++;break;case 2:i[2]++;break;case 3:i[1]++,i[2]++}this.children[e]=new b(this.map,this,i)}},b.prototype.removeChildByIndex=function(e){null!=this.children[e]&&(this.children[e].kill(),this.children[e]=null)},b.prototype.removeChild=function(e){for(var t=0;t<4;t++)this.children[t]==e&&(this.children[t].kill(),this.children[t]=null)},b.prototype.isMetanodeReady=function(e,t,i){if((this.map.viewCounter!=this.viewCoutner&&(this.viewSwitched(),this.viewCoutner=this.map.viewCounter,this.map.markDirty()),!i)&&((this.virtualSurfacesUncomplete||null==this.surface&&0==this.virtualSurfaces.length)&&this.checkSurface(e,t),(null==this.metanode||this.lastMetanode)&&!this.virtualSurfacesUncomplete&&!(this.checkMetanode(e,t)||null!=this.metanode&&this.lastMetanode)))return!1;if(null==this.metanode)return!1;if(this.metanode.metatile.used(),this.lastSurface&&this.lastSurface==this.surface&&(this.lastSurface=null,this.restoreLastState()),this.surface&&(this.surface.virtual?(this.resourceSurface=this.surface.getSurface(this.metanode.sourceReference),this.resourceSurface||(this.resourceSurface=this.surface)):this.resourceSurface=this.surface),this.seCounter!=this.map.renderer.seCounter){var r=this.map.renderer;this.seCounter=r.seCounter;var s=this.metanode;r.useSuperElevation?(s.minZ=r.getSuperElevatedHeight(s.minZ2),s.maxZ=r.getSuperElevatedHeight(s.maxZ2)):(s.minZ=s.minZ2,s.maxZ=s.maxZ2),r.seCounter>0&&(this.gridPoints=null,s.border=null,s.border2=null,s.border3=null,s.borderReady=!1,s.generateCullingHelpers())}return!0},b.prototype.checkSurface=function(e,t){if(this.surface=null,this.virtual=!1,this.virtualReady=!1,this.virtualSurfaces=[],this.virtualSurfacesUncomplete=!1,e.freeLayerSurface)this.surface=e.freeLayerSurface;else{for(var i=e.surfaceSequence,r=0,s=i.length;r<s;r++){var a=i[r][0],n=i[r][1];if(a.hasTile2(this.id)[0]){if(this.id[0]>0){var o=this.parent;if(o){if(o.virtualSurfacesUncomplete)return this.virtualSurfacesUncomplete=!0,void(this.virtualSurfaces=[]);var h=o.metaresources.getMetatile(a,null,this);if(!h)continue;if(!h.isReady(t)){this.virtualSurfacesUncomplete=!0;continue}var l=h.getNode(o.id);if(!l)continue;if(!l.hasChildById(this.id))continue}}this.virtualSurfaces.push([a,n])}}this.virtualSurfaces.length>1?this.virtual=!0:this.surface=this.virtualSurfaces[0]?this.virtualSurfaces[0][0]:null}},b.prototype.checkMetanode=function(e,t){if(this.virtual){if(!this.isVirtualMetanodeReady(e,t))return!1;this.metanode=this.createVirtualMetanode(e,t),this.lastMetanode=null,this.map.markDirty()}var i=this.surface;if(null==i)return!1;var r=this.metaresources.getMetatile(i,!0,this);if(!r.isReady(t))return!1;if(this.virtual||(this.metanode=r.getNode(this.id),this.lastMetanode=null,this.map.markDirty()),null!=this.metanode){this.metanode.tile=this,this.lastMetanode=null,this.map.markDirty();for(var s=0;s<4;s++)this.metanode.hasChild(s)?this.addChild(s):this.removeChildByIndex(s)}return!0},b.prototype.isVirtualMetanodeReady=function(e,t){for(var i=this.virtualSurfaces,r=0,s=0,a=i.length;s<a;s++){var n=i[s][0];this.metaresources.getMetatile(n,!0,this).isReady(t)&&r++}return r==a},b.prototype.createVirtualMetanode=function(e,t){var i,r,s,a,n,o=this.virtualSurfaces,h=null;for(i=0,r=o.length;i<r;i++){s=o[i][0];var l=o[i][1];if((a=this.metaresources.getMetatile(s,null,this)).isReady(t)&&null!=(n=a.getNode(this.id))){if(l!=n.alien)continue;if(!l&&s.glue&&!n.hasGeometry()&&n.internalTextureCount>0){var u=n.internalTextureCount-1;u=this.map.getSurface(s.id[u]).viewSurfaceIndex;for(var c=!1,d=i;d<r;d++)if(o[d].viewSurfaceIndex<=u){c=d>i,i=d-1;break}if(c)continue}if(n.hasGeometry()){h=n.clone(),this.surface=s;break}}}for(i=0,r=o.length;i<r;i++)s=o[i][0],(a=this.metaresources.getMetatile(s,null,this)).isReady(t)&&null!=(n=a.getNode(this.id))&&(h?(h.flags|=240&n.flags,a.useVersion<4&&(h.bbox.min[0]=Math.min(h.bbox.min[0],n.bbox.min[0]),h.bbox.min[1]=Math.min(h.bbox.min[1],n.bbox.min[1]),h.bbox.min[2]=Math.min(h.bbox.min[2],n.bbox.min[2]),h.bbox.max[0]=Math.max(h.bbox.max[0],n.bbox.max[0]),h.bbox.max[1]=Math.max(h.bbox.max[1],n.bbox.max[1]),h.bbox.max[2]=Math.max(h.bbox.max[2],n.bbox.max[2]))):(h=n.clone(),this.surface=s));return h&&h.generateCullingHelpers(!0),h},b.prototype.bboxVisible=function(e,t,i,r){var s=this.map,a=s.camera;if(e[0]<s.measure.minDivisionNodeDepth)return!0;if(!s.config.mapDisableCulling&&s.isGeocent&&r){var n=r.diskPos,o=a.position,h=[n[0]-o[0],n[1]-o[1],n[2]-o[2]],l=f.normalize4(h)*a.distanceFactor,u=f.dot(h,r.diskNormal);if(this.tiltAngle=u,l>15e4&&u>r.diskAngle)return!1}return r.metatile.useVersion>=4?a.camera.pointsVisible(r.bbox2,i):!s.isGeocent||!s.config.mapPreciseBBoxTest||e[0]<4?a.camera.bboxVisible(t,i):a.camera.pointsVisible(r.bbox2,i)},b.prototype.insideCone=function(e,t,i){return!!this.map.isGeocent&&Math.acos(f.dot(e,i.diskNormal))<t+i.diskAngle2A},b.prototype.getPixelSize=function(e,t,i,r,s){var a=e.min,n=e.max,o=a[0]-i[0],h=a[1]-i[1],l=n[0]-i[0],u=a[1]-i[1],c=n[0]-i[0],d=n[1]-i[1],p=a[0]-i[0],f=n[1]-i[1],g=a[2]-i[2],m=n[2]-i[2];if(i[0]>a[0]&&i[0]<n[0]&&i[1]>a[1]&&i[1]<n[1]&&i[2]>a[2]&&i[2]<n[2])return s?[Number.POSITIVE_INFINITY,.1]:Number.POSITIVE_INFINITY;var v=0,y=this.map.camera.camera;return v=0<h?0<o?0>m?y.scaleFactor([o,h,m],s):0<g?y.scaleFactor([o,h,g],s):y.scaleFactor([o,h,.5*(g+m)],s):0>l?0>m?y.scaleFactor([l,u,m],s):0<g?y.scaleFactor([l,u,g],s):y.scaleFactor([l,u,.5*(g+m)],s):0>m?y.scaleFactor([.5*(o+l),u,m],s):0<g?y.scaleFactor([.5*(o+l),u,g],s):y.scaleFactor([.5*(o+l),u,.5*(g+m)],s):0>f?0<p?0>m?y.scaleFactor([p,f,m],s):0<g?y.scaleFactor([p,f,g],s):y.scaleFactor([p,f,.5*(g+m)],s):0>c?0>m?y.scaleFactor([c,d,m],s):0<g?y.scaleFactor([c,d,g],s):y.scaleFactor([c,d,.5*(g+m)],s):0>m?y.scaleFactor([.5*(p+c),d,m],s):0<g?y.scaleFactor([.5*(p+c),d,g],s):y.scaleFactor([.5*(p+c),d,.5*(g+m)],s):0<p?0>m?y.scaleFactor([o,.5*(u+d),m],s):0<g?y.scaleFactor([o,.5*(u+d),g],s):y.scaleFactor([o,.5*(u+d),.5*(g+m)],s):0>c?0>m?y.scaleFactor([l,.5*(u+d),m],s):0<g?y.scaleFactor([l,.5*(u+d),g],s):y.scaleFactor([l,.5*(u+d),.5*(g+m)],s):0>m?y.scaleFactor([.5*(o+l),.5*(u+d),m],s):0<g?y.scaleFactor([.5*(o+l),.5*(u+d),g],s):y.scaleFactor([.5*(o+l),.5*(u+d),.5*(g+m)],s),s?[v[0]*t,v[1]]:v*t},b.prototype.getPixelSize3Old=function(e,t,i){var r=this.map.camera,s=r.geocentDistance*i-e.diskDistance;s<0&&(s=-s);var a=f.dot(r.geocentNormal,e.diskNormal);if(a<e.diskAngle2){var n=Math.acos(a);n-=Math.acos(e.diskAngle2);var o=Math.tan(n)*e.diskDistance;s=Math.sqrt(o*o+s*s)}return[(i=r.camera.scaleFactor2(s))*t,s]},b.prototype.getPixelSize3=function(e,t){var i,r=this.map.camera,s=r.geocentDistance,a=f.dot(r.geocentNormal,e.diskNormal),n=s-(e.diskDistance+(e.maxZ-e.minZ));if(a<e.diskAngle2){var o=Math.acos(a);o-=e.diskAngle2A;var h=Math.tan(o)*e.diskDistance;n<0?(i=s-e.diskDistance)<0?(n=-i,n=Math.sqrt(h*h+n*n)):n=h:n=Math.sqrt(h*h+n*n)}else if(n<0){if(!((i=s-e.diskDistance)<0))return[Number.POSITIVE_INFINITY,.1];n=-i}return[r.camera.scaleFactor2(n)*t,n]},b.prototype.updateTexelSize=function(){var e,t,i,r,s=this.map,a=s.draw,n=s.camera,o=a.texelSizeFit,h=this.metanode,l=s.camera.position,u=s.isGeocent&&(s.config.mapPreciseDistanceTest||h.metatile.useVersion>=4);if(h.hasGeometry()){var c=Number.POSITIVE_INFINITY;if(h.usedTexelSize()?c=a.ndcToScreenPixel*h.pixelSize:h.usedDisplaySize()&&(c=a.ndcToScreenPixel*((h.bbox?h.bbox.maxSize:h.bboxMaxSize)/h.displaySize)),n.camera.ortho){var d=n.camera.getViewHeight();e=[2*c/d,d]}else h.usedDisplaySize()?u?(c=a.isGeocent?a.ndcToScreenPixel*(h.diskAngle2A*a.planetRadius*1.41421356236/h.displaySize):a.ndcToScreenPixel*((h.bbox?h.bbox.maxSize:h.bboxMaxSize)/h.displaySize),e=this.getPixelSize3(h,c)):(c=a.ndcToScreenPixel*((h.bbox?h.bbox.maxSize:h.bboxMaxSize)/256),t=h.displaySize/256*n.distance,i=n.vector,r=[l[0]-i[0]*t,l[1]-i[1]*t,l[2]-i[2]*t],e=this.getPixelSize(h.bbox,c,r,r,!0)):!u&&o>1.1?(c=a.ndcToScreenPixel*h.pixelSize*(o/1.1),t=o/1.1*n.distance,i=n.vector,r=[l[0]-i[0]*t,l[1]-i[1]*t,l[2]-i[2]*t],e=this.getPixelSize(h.bbox,c,r,r,!0)):e=u?this.getPixelSize3(h,c):this.getPixelSize(h.bbox,c,l,l,!0)}else(e=u?this.getPixelSize3(h,1,1):this.getPixelSize(h.bbox,1,l,l,!0))[0]=Number.POSITIVE_INFINITY;if(this.texelSize=e[0],this.distance=e[1],s.config.mapDegradeHorizon&&!(a.degradeHorizonFactor<1)){var p=s.config.mapDegradeHorizonParams,f=p[1],g=p[2],m=a.degradeHorizonFactor*a.degradeHorizonTiltFactor,v=this.distance*n.distanceFactor;v<f?m=1:v>f&&v<g&&(m=1+(v-f)/(g-f)*(m-1)),m=Math.max(m,1);var y=n.perceivedDistance,b=p[3];y>b?m=1:y<b&&m>1&&(m=1+(m-1)*(1-y/b)),this.texelSize/=m}},b.prototype.drawGrid=function(e,t,i,r,s){if(!((this.texelSize==Number.POSITIVE_INFINITY||this.texelSize>4.4)&&this.metanode&&this.metanode.hasChildren())&&this.metanode){var a,n,o,h,l=this.map;if(!l.draw.gridSkipped){t?(a=t[0],n=t[1][0],o=t[1][1]):(a=(h=l.measure.getSpatialDivisionNodeAndExtents(this.id))[0],n=h[1][0],o=h[1][1]);var u=[.5*(o[0]+n[0]),.5*(o[1]+n[1])],c=l.referenceFrame.hasPoles;if(i=i||this.metanode.diskAngle2,c&&!a.isPole&&Math.acos(i)>.1*Math.PI)return i=Math.cos(.5*Math.acos(i)),this.drawGrid(e,[a,[[n[0],n[1]],[u[0],u[1]]]],i,!1,!0),this.drawGrid(e,[a,[[u[0],n[1]],[o[0],u[1]]]],i,!1,!0),this.drawGrid(e,[a,[[n[0],u[1]],[u[0],o[1]]]],i,!1,!0),void this.drawGrid(e,[a,[[u[0],u[1]],[o[0],o[1]]]],i,!1,!0);var d=a.extents.ur[1]-a.extents.ll[1],p=this.distance,f=Math.log(5*d/p)/l.log2;f=Math.max(0,f-8+a.id[0]);var g,b,x,w=l.draw,M=e[0],S=(M=e[0],e[1]),A=e[2],C=w.planeBuffer,T=w.gridFlat,P=w.gridGlues,F=this.gridPoints,L=l.config.mapGridSurrogatez;if(!F){g=L?this.metanode.surrogatez:this.metanode.minZ;var E=a.getPhysicalCoords([o[0],o[1],g],!0),k=a.getPhysicalCoords([o[0],n[1],g],!0),N=a.getPhysicalCoords([n[0],n[1],g],!0),I=a.getPhysicalCoords([n[0],o[1],g],!0),B=a.getPhysicalCoords([u[0],o[1],g],!0),R=a.getPhysicalCoords([u[0],n[1],g],!0),z=a.getPhysicalCoords([n[0],u[1],g],!0),U=a.getPhysicalCoords([o[0],u[1],g],!0);if(u[2]=g,u=a.getPhysicalCoords(u,!0),t)C[0]=I[0]-M,C[1]=I[1]-S,C[2]=I[2]-A,C[3]=B[0]-M,C[4]=B[1]-S,C[5]=B[2]-A,C[6]=E[0]-M,C[7]=E[1]-S,C[8]=E[2]-A,C[9]=z[0]-M,C[10]=z[1]-S,C[11]=z[2]-A,C[12]=u[0]-M,C[13]=u[1]-S,C[14]=u[2]-A,C[15]=U[0]-M,C[16]=U[1]-S,C[17]=U[2]-A,C[18]=N[0]-M,C[19]=N[1]-S,C[20]=N[2]-A,C[21]=R[0]-M,C[22]=R[1]-S,C[23]=R[2]-A,C[24]=k[0]-M,C[25]=k[1]-S,C[26]=k[2]-A;else{F=[I[0],I[1],I[2],B[0],B[1],B[2],E[0],E[1],E[2],z[0],z[1],z[2],u[0],u[1],u[2],U[0],U[1],U[2],N[0],N[1],N[2],R[0],R[1],R[2],k[0],k[1],k[2]];this.gridPoints=F}}if(!T){var D,_,O,G=this.metanode,V=G.border,j=G.borderNodes,H=l.tree,W=this.id;V||(G.border=new Array(9),G.borderNodes=new Array(9),V=G.border,j=G.borderNodes,V[4]=L?G.surrogatez:G.minZ);var q=v,Z=!1;if(!G.borderReady)for(D=0;D<9;D++)4==D||j[D]||((O=H.getNodeById([W[0],W[1]+q[D][0],W[2]+q[D][1]],!0))?(j[D]=O,V[D]=L?O.surrogatez:O.minZ):(V[D]=V[4],Z=!0));var Y=G.border2;if(g=L?G.surrogatez:G.minZ,Y&&G.borderReady||(Y=[.25*(V[0]+V[1]+V[3]+V[4])-g,.5*(V[1]+V[4])-g,.25*(V[2]+V[1]+V[5]+V[4])-g,.5*(V[3]+V[4])-g,V[4]-g,.5*(V[5]+V[4])-g,.25*(V[6]+V[7]+V[3]+V[4])-g,.5*(V[7]+V[4])-g,.25*(V[8]+V[7]+V[5]+V[4])-g],G.border2=Y),Z||(G.borderReady=!0),r)return;if(P){var J=y,K=this.nodeTable;for(K||(K=new Array(9),this.nodeTable=K),D=0,_=q.length;D<_;D++)4!=D&&(K[D]=H.getRenderedNodeById([W[0],W[1]+q[D][0],W[2]+q[D][1]],w.drawCounter));var Q=G.border3;for(Q||(Q=new Array(9),G.border3=Q),D=0,_=J.length;D<_;D++){for(var X=K[J[D][0]],$=1;$<3;$++)(O=K[J[D][$]])&&(X?O.id[0]<X.id[0]&&(X=O):X=O);K[J[D][0]]=X}for(D=0,_=q.length;D<_;D++)if(O=K[D],4!=D&&O&&O.id[0]<W[0]){var ee;switch(D){case 0:ee=[G.llx,G.lly];break;case 1:ee=[.5*(G.urx+G.llx),G.lly];break;case 2:ee=[G.urx,G.lly];break;case 3:ee=[G.llx,.5*(G.ury+G.lly)];break;case 5:ee=[G.urx,.5*(G.ury+G.lly)];break;case 6:ee=[G.llx,G.ury];break;case 7:ee=[.5*(G.urx+G.llx),G.ury];break;case 8:ee=[G.urx,G.ury]}O.border2||O.tile.drawGrid(e,t,i,!0),O.border2?G.border3[D]=O.getGridHeight(ee,O.border2,3)+(L?O.surrogatez:O.minZ)-g:Y[D]}else G.border3[D]=Y[D]}}var te=l.renderer,ie=te.camera.getModelviewMatrix(),re=te.camera.getProjectionMatrix();if(F&&(C[0]=F[0]-M,C[1]=F[1]-S,C[2]=F[2]-A,C[3]=F[3]-M,C[4]=F[4]-S,C[5]=F[5]-A,C[6]=F[6]-M,C[7]=F[7]-S,C[8]=F[8]-A,C[9]=F[9]-M,C[10]=F[10]-S,C[11]=F[11]-A,C[12]=F[12]-M,C[13]=F[13]-S,C[14]=F[14]-A,C[15]=F[15]-M,C[16]=F[16]-S,C[17]=F[17]-A,C[18]=F[18]-M,C[19]=F[19]-S,C[20]=F[20]-A,C[21]=F[21]-M,C[22]=F[22]-S,C[23]=F[23]-A,C[24]=F[24]-M,C[25]=F[25]-S,C[26]=F[26]-A),c&&!l.poleRadius&&1==a.id[0]&&!a.isPole){var se=a.getPhysicalCoords([a.extents.ur[0],a.extents.ur[1],0]);l.poleRadius=Math.sqrt(se[0]*se[0]+se[1]*se[1]),l.poleRadiusFactor=8*Math.pow(2,552058/l.poleRadius)}b=1;var ae=""!=l.config.mapGridTextureLayer;if(ae){if(!this.gridTexture){var ne=l.boundLayers[l.config.mapGridTextureLayer],oe=this;if(!ne||oe<ne.lodRange[0])ae=!1;else{for(var he=m.clamp(oe.id[0]-l.config.mapGridTextureLevel,ne.lodRange[0],ne.lodRange[3]);oe.id[0]>he;)oe=oe.parent;this.gridTexture=this.resources.getTexture("gmap#"+l.config.mapGridTextureLayer,null,{sourceTile:oe,layer:ne,tile:this},null,null,null)}}ae&&!this.gridTexture.isReady(!1,0,!1)&&(ae=!1)}var le=te.onlyDepth;if(c&&a.isPole)b=l.poleRadiusFactor,x=le?te.progPlane2D:te.progPlane2,te.gpu.useProgram(x,["aPosition","aTexCoord"]),x.setVec4("uParams4",[-M,-S,l.poleRadius,0]);else if(T)x=te.progPlane,te.gpu.useProgram(x,["aPosition","aTexCoord"]);else x=le?te.progPlane3D:te.progPlane3,te.gpu.useProgram(x,["aPosition","aTexCoord"]),V=P?G.border3:G.border2,x.setFloatArray("uHeights",V),x.setVec3("uVector",G.diskNormal);x.setMat4("uMV",ie),x.setMat4("uProj",re),x.setFloatArray("uPoints",C);var ue=a.gridStep1*b,ce=1/(o[0]-n[0]),de=1/(n[1]-o[1]),pe=ue/((a.extents.ur[0]-a.extents.ll[0])*ce),fe=ue/((a.extents.ur[1]-a.extents.ll[1])*de),ge=(n[0]-a.extents.ll[0])*ce*pe,me=(o[1]-a.extents.ll[1])*de*fe;if(ae){te.gpu.bindTexture(this.gridTexture.getGpuTexture()),x.setVec4("uParams",[ue*b,w.fogDensity,1/15,a.gridStep2*b]);var ve=this.gridTexture.getTransform();x.setVec4("uParams3",[ve[2],ve[3],ve[0],ve[1]]),x.setVec4("uParams2",[0,0,0,0])}else te.gpu.bindTexture(te.heightmapTexture),x.setVec4("uParams",[ue*b,w.fogDensity,1/15,a.gridStep2*b]),x.setVec4("uParams3",[me-Math.floor(me),ge-Math.floor(ge),fe,pe]),x.setVec4("uParams2",[0,0,a.gridBlend,0]);x.setVec4("uFogColor",w.atmoColor),te.planeMesh.draw(x,"aPosition","aTexCoord"),this.map.stats.drawnFaces+=te.planeMesh.polygons}}},b.prototype.drawHmapTile=function(e,t,i,r,s){if(this.metanode){var a,n,o,h,l=this.map,u=l.renderer;u.progHmapPlane||u.initProceduralShaders(),t?(a=t[0],n=t[1][0],o=t[1][1]):(a=(h=l.measure.getSpatialDivisionNodeAndExtents(this.id))[0],n=h[1][0],o=h[1][1]);var c=[.5*(o[0]+n[0]),.5*(o[1]+n[1])],d=l.referenceFrame.hasPoles;if(i=i||this.metanode.diskAngle2,d&&!a.isPole&&Math.acos(i)>.1*Math.PI)return i=Math.cos(.5*Math.acos(i)),this.drawHmapTile(e,[a,[[n[0],n[1]],[c[0],c[1]]]],i),this.drawHmapTile(e,[a,[[c[0],n[1]],[o[0],c[1]]]],i),this.drawHmapTile(e,[a,[[n[0],c[1]],[c[0],o[1]]]],i),void this.drawHmapTile(e,[a,[[c[0],c[1]],[o[0],o[1]]]],i);var p=a.extents.ur[1]-a.extents.ll[1],m=this.distance,v=Math.log(5*p/m)/l.log2;v=Math.max(0,v-8+a.id[0]);var y,b,x=l.draw,w=e[0],M=(w=e[0],e[1]),S=e[2],A=x.planeBuffer,C=this.gridPoints;l.config.mapGridSurrogatez;if(!C){0;var T=a.getPhysicalCoords([o[0],o[1],0],!0),P=a.getPhysicalCoords([o[0],n[1],0],!0),F=a.getPhysicalCoords([n[0],n[1],0],!0),L=a.getPhysicalCoords([n[0],o[1],0],!0),E=a.getPhysicalCoords([c[0],o[1],0],!0),k=a.getPhysicalCoords([c[0],n[1],0],!0),N=a.getPhysicalCoords([n[0],c[1],0],!0),I=a.getPhysicalCoords([o[0],c[1],0],!0);if(c[2]=0,c=a.getPhysicalCoords(c,!0),t)A[0]=L[0]-w,A[1]=L[1]-M,A[2]=L[2]-S,A[3]=E[0]-w,A[4]=E[1]-M,A[5]=E[2]-S,A[6]=T[0]-w,A[7]=T[1]-M,A[8]=T[2]-S,A[9]=N[0]-w,A[10]=N[1]-M,A[11]=N[2]-S,A[12]=c[0]-w,A[13]=c[1]-M,A[14]=c[2]-S,A[15]=I[0]-w,A[16]=I[1]-M,A[17]=I[2]-S,A[18]=F[0]-w,A[19]=F[1]-M,A[20]=F[2]-S,A[21]=k[0]-w,A[22]=k[1]-M,A[23]=k[2]-S,A[24]=P[0]-w,A[25]=P[1]-M,A[26]=P[2]-S;else{C=[L[0],L[1],L[2],E[0],E[1],E[2],T[0],T[1],T[2],N[0],N[1],N[2],c[0],c[1],c[2],I[0],I[1],I[2],F[0],F[1],F[2],k[0],k[1],k[2],P[0],P[1],P[2]];this.gridPoints=C}}var B=u.camera.getModelviewMatrix(),R=u.camera.getProjectionMatrix();if(C&&(A[0]=C[0]-w,A[1]=C[1]-M,A[2]=C[2]-S,A[3]=C[3]-w,A[4]=C[4]-M,A[5]=C[5]-S,A[6]=C[6]-w,A[7]=C[7]-M,A[8]=C[8]-S,A[9]=C[9]-w,A[10]=C[10]-M,A[11]=C[11]-S,A[12]=C[12]-w,A[13]=C[13]-M,A[14]=C[14]-S,A[15]=C[15]-w,A[16]=C[16]-M,A[17]=C[17]-S,A[18]=C[18]-w,A[19]=C[19]-M,A[20]=C[20]-S,A[21]=C[21]-w,A[22]=C[22]-M,A[23]=C[23]-S,A[24]=C[24]-w,A[25]=C[25]-M,A[26]=C[26]-S),d&&!l.poleRadius&&1==a.id[0]&&!a.isPole){var z=a.getPhysicalCoords([a.extents.ur[0],a.extents.ur[1],0]);l.poleRadius=Math.sqrt(z[0]*z[0]+z[1]*z[1]),l.poleRadiusFactor=8*Math.pow(2,552058/l.poleRadius)}var U=this.metanode,D=x.debug.drawTestMode;if(y=1,d&&a.isPole)y=l.poleRadiusFactor,b=u.progPlane2,u.gpu.useProgram(b,["aPosition","aTexCoord"]),b.setVec4("uParams4",[-w,-M,l.poleRadius,0]);else{switch(D){default:case 0:b=u.progHmapPlane;break;case 1:b=u.progHmapPlane2;break;case 2:b=u.progHmapPlane5;break;case 3:b=u.progHmapPlane6;break;case 4:b=u.progHmapPlane7;break;case 8:b=u.progHmapPlane4;break;case 9:b=1==r?u.progHmapPlane3:u.progHmapPlane8}if(3!=D&&4!=D||u.ntextures||(u.ntextures=[new g(u.gpu,"./textures/test/test001.png",u.core,null),new g(u.gpu,"./textures/test/test002.png",u.core,null),new g(u.gpu,"./textures/test003.jpg",u.core,null),new g(u.gpu,"./textures/download.png",u.core,null),new g(u.gpu,"./textures/test009.jpg",u.core,null),new g(u.gpu,"./textures/test004.jpg",u.core,null),new g(u.gpu,"./textures/test005.jpg",u.core,null),new g(u.gpu,"./textures/nor_sand.jpg",u.core,null),new g(u.gpu,"./textures/test007.jpg",u.core,null),new g(u.gpu,"./textures/test008.jpg",u.core,null),new g(u.gpu,"./textures/download (1).png",u.core,null),new g(u.gpu,"./textures/test010.jpg",u.core,null),new g(u.gpu,"./textures/test011.jpg",u.core,null),new g(u.gpu,"./textures/test012.jpg",u.core,null),new g(u.gpu,"./textures/test013.jpg",u.core,null),new g(u.gpu,"./textures/test014.jpg",u.core,null),new g(u.gpu,"./textures/test015.jpg",u.core,null),new g(u.gpu,"./textures/test016.jpg",u.core,null),new g(u.gpu,"./textures/test017.jpg",u.core,null),new g(u.gpu,"./textures/test018.jpg",u.core,null)]),u.gpu.useProgram(b,["aPosition"]),b.setVec3("uVector",U.diskNormal),C){var _=[C[15]-C[12],C[16]-C[13],C[17]-C[14]],O=[C[21]-C[12],C[22]-C[13],C[23]-C[14]];f.normalize(_),f.normalize(O);var G=U.diskNormal.slice(),V=(B=l.camera.camera.modelview,vts.mat3.create());vts.mat4.toInverseMat3(B,V),vts.mat3.transpose(V),vts.mat3.multiplyVec3(V,O),vts.mat3.multiplyVec3(V,G),vts.mat3.multiplyVec3(V,_);var j=[_[0],_[1],_[2],O[0],O[1],O[2],G[0],G[1],G[2]];b.setMat3("uSpace",j)}}b.setMat4("uMV",B),b.setMat4("uProj",R),b.setFloatArray("uPoints",A);var H=a.gridStep1*y;if(b.setVec4("uParams",[H*y,x.fogDensity,1/127,a.gridStep2*y]),D>=3&&D<=4)b.setVec4("uParams3",[1,1,0,0]);else if(s)b.setVec4("uParams3",s.getTransform());else{var W=1/(o[0]-n[0]),q=1/(n[1]-o[1]),Z=H/((a.extents.ur[0]-a.extents.ll[0])*W),Y=H/((a.extents.ur[1]-a.extents.ll[1])*q),J=(n[0]-a.extents.ll[0])*W*Z,K=(o[1]-a.extents.ll[1])*q*Y;b.setVec4("uParams3",[Y,Z,K-Math.floor(K),J-Math.floor(J)])}if(b.setVec4("uParams2",[0,0,a.gridBlend,0]),b.setVec4("uFogColor",x.atmoColor),this.hmap.extraBound?(U=this.hmap.extraBound.sourceTile.metanode,b.setVec3("uHeights",[U.minHeight,U.maxHeight,1/U.pixelSize]),b.setVec4("uTransform",this.hmap.getTransform())):(b.setVec3("uHeights",[U.minHeight,U.maxHeight,1/U.pixelSize]),b.setVec4("uTransform",[1,1,0,0])),D>=3&&D<=4){if(!u.ntextures[x.debug.drawTestData].loaded)return;u.gpu.bindTexture(u.ntextures[x.debug.drawTestData])}else s?u.gpu.bindTexture(s.getGpuTexture()):u.gpu.bindTexture(u.heightmapTexture);b.setSampler("uSampler",0),u.gpu.bindTexture(this.hmap.getGpuTexture(),1),b.setSampler("uSampler2",1),u.planeMesh2.draw(b,"aPosition"),this.map.stats.drawnFaces+=u.planeMesh2.polygons}};var x=b,w=s.d,M=x,S=function(e,t,i){this.map=e,this.camera=e.camera,this.rootId=[0,0,0],this.freeLayer=t,this.freeLayerSurface=i,this.metaBinaryOrder=this.map.referenceFrame.params.metaBinaryOrder,this.surfaceTree=new M(this.map,null,this.rootId),this.surfaceSequence=[],this.surfaceOnlySequence=[],this.config=this.map.config,this.cameraPos=[0,0,0],this.worldPos=[0,0,0],this.ndcToScreenPixel=1,this.counter=0};S.prototype.kill=function(){this.surfaceTree=null,this.metastorageTree=null,this.surfaceTracer=null,this.heightTracer=null},S.prototype.findSurfaceTile=function(e){for(var t=this.surfaceTree,i=e[0];i>0;i--){var r=1<<i-1,s=0;if(0!=(e[1]&r)&&(s+=1),0!=(e[2]&r)&&(s+=2),!(t=t.children[s]))return null}return t},S.prototype.findNavTile=function(e){var t=this.surfaceTree;if(0==e[0])return t.metanode&&t.metanode.hasNavtile()?t:null;for(var i=null,r=e[0];r>0;r--){var s=1<<r-1,a=0;if(0!=(e[1]&s)&&(a+=1),0!=(e[2]&s)&&(a+=2),!(t=t.children[a]))return i;t.metanode&&t.metanode.hasNavtile()&&(i=t)}return i},S.prototype.draw=function(e){this.cameraPos=[0,0,0],this.worldPos=[0,0,0];var t=this.map,i=t.draw;this.ndcToScreenPixel=i.ndcToScreenPixel;var r=t.getPhysicalSrs().periodicity;if(!this.freeLayerSurface||!this.freeLayerSurface.geodata||0==i.drawChannel)if(null!=r)this.drawSurface([0,0,0]),"X"==r.type&&(this.drawSurface([r.period,0,0],e),this.drawSurface([-r.period,0,0],e));else switch(this.freeLayerSurface&&this.freeLayerSurface.geodata?t.config.mapGeodataLoadMode:t.config.mapLoadMode){case"topdown":t.config.mapSplitMeshes?this.drawSurfaceWithSpliting([0,0,0],e):this.drawSurface([0,0,0],e);break;case"downtop":this.drawSurfaceDownTop([0,0,0],e);break;case"fit":this.drawSurfaceFit([0,0,0],e);break;case"fitonly":this.drawSurfaceFitOnly([0,0,0],e)}},S.prototype.updateNodeHeightExtents=function(e,t){if(!t.heightReady&&t.metatile.useVersion<4){for(var i=e.parent;i;){var r=i.metanode;if(r.hasNavtile()){t.minHeight=r.minHeight,t.maxHeight=r.maxHeight,t.minZ=r.minZ,t.maxZ=r.maxZ,t.minZ2=r.minZ2,t.maxZ2=r.maxZ2,t.generateCullingHelpers();break}i=i.parent}t.heightReady=!0}},S.prototype.logTileInfo=function(e,t,i){if(e&&t){var r=e.bboxVisible(e.id,t.bbox,i,t);e.updateTexelSize(),console.log("tile: "+JSON.stringify(e.id)+" visible: "+r+" texelsize: "+e.texelSize+" center: "+JSON.stringify(t.diskPos)+" vec: "+t.diskNormal+"ang: "+t.diskAngle+" dist: "+t.diskDistance)}},S.prototype.drawSurface=function(e,t){this.counter++;var i=this.surfaceTree;if(i.isMetanodeReady(this,0)){var r=this.map,s=i.metanode,a=r.camera.position;if(i.bboxVisible(i.id,s.bbox,a,s)){i.updateTexelSize();var n=(this.freeLayerSurface,1),o=r.draw,h=o.drawTiles,l=o.drawBuffer,u=o.processBuffer,c=o.processBuffer2,d=0,p=0,f=0,g=0,m=0;u[0]=i,p=1;var v=o.texelSizeFit,y=o.replay,b=y.storeNodes||y.storeFreeNodes,x=y.nodeBuffer;o.drawCounter++;var w,M,S,A=1,C=1,T=1,P=o.drawCounter;do{var F=0;for(f=0,w=p-1;w>=0;w--)if((s=(i=u[w]).metanode)&&(A++,s.metatile.drawCounter!=P&&(s.metatile.drawCounter=P,C++)),i.bboxVisible(i.id,s.bbox,a,s))if(T++,i.texelSize!=Number.POSITIVE_INFINITY&&i.texelSize>F&&(F=i.texelSize),b&&x.push(i),i.texelSize<=v)g+=m=o.getDrawCommandsGpuSize(i.drawCommands[o.drawChannel]||i.lastRenderState.drawCommands[o.drawChannel]),m,i.drawCounter=o.drawCounter,l[d]=i,d++;else{g+=m=o.getDrawCommandsGpuSize(i.drawCommands[o.drawChannel]||i.lastRenderState.drawCommands[o.drawChannel]);var L=0,E=0,k=[];for(M=0;M<4;M++){var N=i.children[M];if(N&&(L++,N.isMetanodeReady(this,N.id[0]))){this.updateNodeHeightExtents(N,N.metanode),N.updateTexelSize(1);var I=N.id[0]*n*N.distance;i.surface&&N.metanode.hasGeometry()?h.drawSurfaceTile(N,N.metanode,a,N.texelSize,I,!0,!1,!0)&&(E++,k.push(N)):(E++,k.push(N))}}if(/*!(gpuNeeded > gpuMax) &&*/L>0&&L==E){do{var B=!0;for(M=0,S=k.length-1;M<S;M++)if(k[M].distance>k[M+1].distance){var R=k[M];k[M]=k[M+1],k[M+1]=R,B=!1}}while(!B);for(M=0,S=k.length;M<S;M++)c[f]=k[M],f++}else m,i.drawCounter=o.drawCounter,l[d]=i,d++}var z=u;u=c,c=z,p=f}while(p>0);if(t)this.storeDrawBufferGeometry(d);else{0>o.bestMeshTexelSize&&(o.bestMeshTexelSize=0);var U=r.stats;U.usedNodes=T,U.processedNodes=A,U.processedMetatiles=C,U.gpuNeeded=g,this.processDrawBuffer(o,h,a,r,U,!1,!1,y,l,d,!0)}}}},S.prototype.drawSurfaceWithSpliting=function(e,t){this.counter++;var i=this.surfaceTree;if(i.isMetanodeReady(this,0)){var r=this.map,s=i.metanode,a=r.camera.position;if(i.bboxVisible(i.id,s.bbox,a,s)){i.updateTexelSize();var n=(this.freeLayerSurface,1),o=r.draw,h=o.drawTiles,l=o.drawBuffer,u=o.processBuffer,c=o.processBuffer2,d=0,p=0,f=0,g=0,m=0;u[0]=i,p=1;var v=o.texelSizeFit,y=o.replay,b=y.storeNodes||y.storeFreeNodes,x=y.nodeBuffer;o.drawCounter++;var w,M,S,A=1,C=1,T=1,P=o.drawCounter;do{var F=0;for(f=0,w=p-1;w>=0;w--)if((s=(i=u[w]).metanode)&&(A++,s.metatile.drawCounter!=P&&(s.metatile.drawCounter=P,C++)),i.splitMask=null,i.visibleCounter==P||i.bboxVisible(i.id,s.bbox,a,s))if(T++,i.texelSize!=Number.POSITIVE_INFINITY&&i.texelSize>F&&(F=i.texelSize),b&&x.push(i),i.texelSize<=v)i.skipRenderCounter!=P&&(g+=m=o.getDrawCommandsGpuSize(i.drawCommands[o.drawChannel]||i.lastRenderState.drawCommands[o.drawChannel]),m,i.drawCounter=P,l[d]=i,d++);else{g+=m=o.getDrawCommandsGpuSize(i.drawCommands[o.drawChannel]||i.lastRenderState.drawCommands[o.drawChannel]);var L=0,E=[],k=[1,1,1,1],N=!1;for(M=0;M<4;M++){var I=i.children[M];if(I)if(L++,I.skipRenderCounter=i.skipRenderCounter,I.isMetanodeReady(this,I.id[0])){if(this.updateNodeHeightExtents(I,I.metanode),I.updateTexelSize(1),!I.bboxVisible(I.id,I.metanode.bbox,a,I.metanode))continue;I.visibleCounter=o.drawCounter;var B=I.id[0]*n*I.distance;i.surface&&I.metanode.hasGeometry()?h.drawSurfaceTile(I,I.metanode,a,I.texelSize,B,!0,!1,!0)?(E.push(I),k[M]=0):(E.push(I),I.skipRenderCounter=P,N=!0):E.push(I)}else N=!0}if(E.length>0){do{var R=!0;for(M=0,S=E.length-1;M<S;M++)if(E[M].distance>E[M+1].distance){var z=E[M];E[M]=E[M+1],E[M+1]=z,R=!1}}while(!R);for(M=0,S=E.length;M<S;M++)c[f]=E[M],f++}(0==L||N)&&i.skipRenderCounter!=P&&(m,i.splitMask=N?k:null,i.drawCounter=P,l[d]=i,d++)}var U=u;u=c,c=U,p=f}while(p>0);if(t)this.storeDrawBufferGeometry(d);else{0>o.bestMeshTexelSize&&(o.bestMeshTexelSize=0);var D=r.stats;D.usedNodes=T,D.processedNodes=A,D.processedMetatiles=C,D.gpuNeeded=g,this.processDrawBuffer(o,h,a,r,D,!1,!1,y,l,d,!0)}}}},S.prototype.drawSurfaceFitOnly=function(e,t,i){this.counter++;var r=this.surfaceTree;if(r.isMetanodeReady(this,0)){var s=this.map,a=r.metanode,n=s.camera.position;if(r.bboxVisible(r.id,a.bbox,n,a)){r.updateTexelSize();var o=s.draw,h=o.drawTiles,l=o.drawBuffer,u=o.processBuffer,c=o.processBuffer2,d=0,p=0,f=0;u[0]=r,p=1;var g=o.texelSizeFit,m=s.draw.replay,v=m.storeNodes||m.storeFreeNodes,y=m.nodeBuffer;o.drawCounter++;var b,x,w,M=1,S=1,A=1,C=o.drawCounter;do{var T=0;for(f=0,b=p-1;b>=0;b--)if((a=(r=u[b]).metanode)&&(S++,a.metatile.drawCounter!=C&&(a.metatile.drawCounter=C,A++)),r.bboxVisible(r.id,a.bbox,n,a))if(M++,v&&y.push(r),r.texelSize!=Number.POSITIVE_INFINITY&&r.texelSize>T&&(T=r.texelSize),r.texelSize<=g)r.drawCounter=o.drawCounter,l[d]=r,d++;else{var P=0,F=0,L=[];for(x=0;x<4;x++){var E=r.children[x];E&&(P++,E.isMetanodeReady(this,E.id[0])&&(this.updateNodeHeightExtents(E,E.metanode),E.updateTexelSize(),L.push(E),F++))}if(P>0&&(!i||P==F)){do{var k=!0;for(x=0,w=L.length-1;x<w;x++)if(L[x].distance>L[x+1].distance){var N=L[x];L[x]=L[x+1],L[x+1]=N,k=!1}}while(!k);for(x=0,w=L.length;x<w;x++)c[f]=L[x],f++}else r.drawCounter=o.drawCounter,l[d]=r,d++}var I=u;u=c,c=I,p=f}while(p>0);if(t){if(i){I=o.drawBuffer2;o.drawBuffer2=o.drawBuffer,o.drawBuffer=I}else this.storeDrawBufferGeometry(d);return d}var B=s.stats;B.usedNodes=M,B.processedNodes=S,B.processedMetatiles=A,this.processDrawBuffer(o,h,n,s,B,!1,!1,m,l,d,!0)}}},S.prototype.drawSurfaceFit=function(e,t){this.counter++;var i=this.surfaceTree;if(i.isMetanodeReady(this,0)){var r=this.map,s=i.metanode,a=r.camera.position;if(i.bboxVisible(i.id,s.bbox,a,s)){i.updateTexelSize();var n=i.surface?i.surface.geodata:null,o=i.surface.maxLod||i.surface.lodRange[1],h=i.surface?i.surface.free:null,l=!n&&!h&&r.config.mapHeightfiledWhenUnloaded,u=4,c=2e3;this.freeLayerSurface&&(u=0,c=.1);var d=r.draw,p=d.drawTiles,f=d.replay,g=d.drawBuffer,m=d.processBuffer,v=d.processBuffer2,y=0,b=0,x=0;m[0]=[i,0],b=1;var w=d.texelSizeFit,M=f.storeNodes||f.storeFreeNodes,S=f.nodeBuffer;d.drawCounter++;var A,C,T,P,F,L,E,k,N=1,I=1,B=1,R=d.drawCounter,z=r.config.mapMaxHiresLodLevels,U=!1;do{var D=0;for(x=0,A=b-1;A>=0;A--){var _=m[A];i=_[0];var O=_[1];if(i.childrenReadyCount=0,O>=z)l&&(E=(L=i).parent,L.id[0]>3&&0!=O&&E&&0==E.childrenReadyCount&&(k=E.children,O>=1&&L.parent&&(k[0]&&0!=k[0].childrenReadyCount||k[1]&&0!=k[1].childrenReadyCount||k[2]&&0!=k[2].childrenReadyCount||k[3]&&0!=k[3].childrenReadyCount)||(L=L.parent)),L.drawCounter==d.drawCounter||L.parent&&L.parent.drawCounter==d.drawCounter||(L.drawCounter=d.drawCounter,g[y]=[L,!0],y++,U=!0));else{if((s=i.metanode)&&(I++,s.metatile.drawCounter!=R&&(s.metatile.drawCounter=R,B++)),i.bboxVisible(i.id,s.bbox,a,s)){N++,i.texelSize!=Number.POSITIVE_INFINITY&&i.texelSize>D&&(D=i.texelSize),M&&S.push(i);var G=x,V=y;if(!s.hasChildren()||i.texelSize<=w||n&&i.id[0]>=o)if(F=(i.id[0]+u)*c*i.distance,s.hasChildren()&&!p.drawSurfaceTile(i,i.metanode,a,i.texelSize,F,!0,O>0,!0)){for(O++,C=0;C<4;C++)(P=i.children[C])&&P.isMetanodeReady(this,P.id[0],!0)&&(this.updateNodeHeightExtents(P,P.metanode),P.updateTexelSize(),p.drawSurfaceTile(P,P.metanode,a,P.texelSize,F,!0,O>0,!0)?(i.childrenReadyCount++,P.drawCounter=d.drawCounter,g[y]=[P,!1],y++):(v[x]=[P,O],x++));G==x&&V==y&&O--}else i.drawCounter=d.drawCounter,g[y]=[i,!1],y++;else if(0==O&&s.hasGeometry()&&i.texelSize<=2*w){var j=0,H=0,W=[];for(C=0;C<4;C++)(P=i.children[C])&&(j++,P.isMetanodeReady(this,P.id[0])&&(this.updateNodeHeightExtents(P,P.metanode),P.updateTexelSize(),F=(P.id[0]+u)*c*P.distance,p.drawSurfaceTile(P,P.metanode,a,P.texelSize,F,!0,!0,!0)&&(H++,W.push(P))));if(j>0&&j==H){do{var q=!0;for(C=0,T=W.length-1;C<T;C++)if(W[C].distance>W[C+1].distance){var Z=W[C];W[C]=W[C+1],W[C+1]=Z,q=!1}}while(!q);for(C=0,T=W.length;C<T;C++)v[x]=[W[C],O],x++}else if(F=(i.id[0]+u)*c*i.distance,p.drawSurfaceTile(i,i.metanode,a,i.texelSize,F,!0,!0,!0))for(i.drawCounter=d.drawCounter,g[y]=[i,!1],y++,C=0;C<4;C++)(P=i.children[C])&&P.isMetanodeReady(this,P.id[0])&&(F=(P.id[0]+u)*c*P.distance,p.drawSurfaceTile(P,P.metanode,a,P.texelSize,F,!0,!1,!0));else for(C=0;C<4;C++)(P=i.children[C])&&P.isMetanodeReady(this,P.id[0])&&(this.updateNodeHeightExtents(P,P.metanode),P.updateTexelSize(),v[x]=[P,O],x++)}else for(C=0;C<4;C++)(P=i.children[C])&&P.isMetanodeReady(this,P.id[0])&&(this.updateNodeHeightExtents(P,P.metanode),P.updateTexelSize(),v[x]=[P,O],x++)}l&&G==x&&V==y&&(E=(L=i).parent,L.id[0]>3&&0!=O&&E&&0==E.childrenReadyCount&&(k=E.children,O>=1&&L.parent&&(k[0]&&0!=k[0].childrenReadyCount||k[1]&&0!=k[1].childrenReadyCount||k[2]&&0!=k[2].childrenReadyCount||k[3]&&0!=k[3].childrenReadyCount)||(L=L.parent)),L&&L.drawCounter!=d.drawCounter&&(L.drawCounter=d.drawCounter,g[y]=[L,!0],y++,U=!0))}}var Y=m;m=v,v=Y,b=x}while(b>0);if(t)this.storeDrawBufferGeometry(y);else{var J=r.stats;J.usedNodes=N,J.processedNodes=I,J.processedMetatiles=B,this.processDrawBuffer(d,p,a,r,J,l,U,f,g,y)}}}},S.prototype.drawSurfaceDownTop=function(e,t){this.counter++;var i=this.map,r=i.camera.position,s=this.surfaceTree;if(s.isMetanodeReady(this,0)){s.updateTexelSize();var a=s,n=s.metanode;if(s.bboxVisible(s.id,n.bbox,r,n)){var o,h,l=(O=i.draw).drawTiles,u=O.drawBuffer,c=O.drawBuffer2,d=0,p=!1,f=O.texelSizeFit,g=0,m=O.processBuffer,v=O.processBuffer2,y=0,b=0;m[0]=s,y=1;f=O.texelSizeFit;O.drawCounter++;var x,w,M,S,A,C=(V=i.draw.replay).storeNodes||V.storeFreeNodes,T=V.nodeBuffer,P=O.drawCounter;p=!1;do{var F=0;for(b=0,x=y-1;x>=0;x--)if((n=(s=m[x]).metanode)&&(n.metatile.drawCounter!=P&&(n.metatile.drawCounter=P)),s.bboxVisible(s.id,n.bbox,r,n))if(C&&T.push(s),s.texelSize!=Number.POSITIVE_INFINITY&&s.texelSize>F&&(F=s.texelSize),s.texelSize<=f)s.drawCounter=P,u[d]=s,d++;else{var L=0,E=0,k=[];for(w=0;w<4;w++){var N;(N=s.children[w])&&(L++,N.isMetanodeReady(this,N.id[0])&&(this.updateNodeHeightExtents(N,N.metanode),N.updateTexelSize(),k.push(N),E++))}if(L>0&&L==E){do{var I=!0;for(w=0,M=k.length-1;w<M;w++)if(k[w].distance>k[w+1].distance){var B=k[w];k[w]=k[w+1],k[w+1]=B,I=!1}}while(!I);for(w=0,M=k.length;w<M;w++)v[b]=k[w],b++}else s.drawCounter=P,u[d]=[s,!0],d++}var R=m;m=v,v=R,y=b}while(y>0);if(0!=d){R=O.drawBuffer2;O.drawBuffer2=O.drawBuffer,O.drawBuffer=R,u=O.drawBuffer;c=O.drawBuffer2;var z=d;d=0;var U=4,D=2e3;this.freeLayerSurface&&(U=0,D=.1);var _=function(){var e=!1;if(s!=a){for(h=s.parent;h!=a;){if(o=(h.id[0]+U)*D,l.drawSurfaceTile(h,h.metanode,r,h.texelSize,o,!0,!0,!1)){u[d]=[h,!1],h.drawCounter=P,e=!0;for(var t=0;t<4;t++)(N=h.children[t])&&N.isMetanodeReady(this,N.id[0])&&(l.drawSurfaceTile(N,N.metanode,r,N.texelSize,o,!0,!1,!1)||g++);break}h=h.parent}e||(o=(s.id[0]+U)*D,l.drawSurfaceTile(s,s.metanode,r,s.texelSize,o,!0,!1,!1)?(u[d]=[s,!1],s.drawCounter=P):(u[d]=[s,!0],s.drawCounter=P,g++))}};for(x=z-1;x>=0;x--){if((S=c[x])[1]){if(!(s=S[0]).isMetanodeReady(this,s.id[0]))continue;u[d]=[s,!0],p=!0,o=20,_()}else n=(s=S).metanode,u[d]=[s,!1],o=(s.id[0]+U)*D,l.drawSurfaceTile(s,s.metanode,r,s.texelSize,o,!0,!1,!1)?s.drawCounter=P:(_(),g++);d++}R=c;c=u,u=R;z=d;for(d=0,x=0;x<z;x++){if(S=c[x],A=!1,(s=S[0])!=a)for(h=s.parent;h!=a;){if(h.drawCounter==P){A=!0;break}h=h.parent}A||(u[d]=c[x],d++)}if(0==g)for(x=0;x<d;x++)if(S=u[x],A=!1,(s=S[0])!=a)for(h=s.parent;h!=a&&(o=(100-s.id[0]+U)*D,l.drawSurfaceTile(h,h.metanode,r,h.texelSize,o,!0,!1,!1));)h=h.parent;var O,G=i.stats,V=(l=(O=i.draw).drawTiles,O.replay),j=s.surface?s.surface.geodata:null,H=s.surface?s.surface.free:null,W=!j&&!H&&i.config.mapHeightfiledWhenUnloaded;this.processDrawBuffer(O,l,r,i,G,W,p,V,u,d)}}}},S.prototype.processDrawBuffer=function(e,t,i,r,s,a,n,o,h,l,u){if(o.storeTiles||o.storeFreeTiles){e.tileBuffer[0]||(e.tileBuffer[0]=[]);var c=e.tileBuffer[0];for(y=l-1;y>=0;y--)c.push(h[y])}var d,p,f,g,m,v,y,b,x,M=!this.freeLayerSurface&&2==r.config.mapFeatureStickMode[0],S=-999999,A=999999,C=r.renderer;this.camera.getMvpMatrix();r.gpuCache.skipCostCheck=!0;var T=a&&r.config.mapGridUnderSurface>0&&n;if(T){for(y=l-1;y>=0;y--)h[y][0].drawGrid(i);r.renderer.gpu.clear(!0,!1)}for(y=l-1;y>=0;y--){var P=h[y];if(x=(b=u?P:P[0]).metanode,M&&x&&(p=x.diskPos,d=C.cameraPosition,f=[p[0]-d[0],p[1]-d[1],p[2]-d[2]],g=w.normalize4(f),(m=-w.dot(f,x.diskNormal))<0&&(m=0),m=1-m,v=C.camera.fovDist/g*m,x.minZ*v<A&&(A=x.minZ*v),x.maxZ*v>S&&(S=x.maxZ*v)),u){if(s.gpuRenderUsed>=e.maxGpuUsed)break;t.drawSurfaceTile(b,b.metanode,i,b.texelSize,0,!1,!1)}else T?P[1]||s.gpuRenderUsed>=e.maxGpuUsed?t.debug.drawBBoxes&&t.drawTileInfo(b,b.metanode,i):t.drawSurfaceTile(b,b.metanode,i,b.texelSize,0,!1,!1):a&&P[1]||s.gpuRenderUsed>=e.maxGpuUsed?(t.debug.drawBBoxes&&t.drawTileInfo(b,b.metanode,i),b.drawGrid(i)):P[1]||t.drawSurfaceTile(b,b.metanode,i,b.texelSize,0,!1,!1)}M&&(C.gridHmax=S,C.gridHmin=A),r.gpuCache.skipCostCheck=!1,r.gpuCache.checkCost()},S.prototype.storeDrawBufferGeometry=function(e){var t=this.map.draw.drawBuffer;this.storeGeometry(t,e)},S.prototype.storeGeometry=function(e,t){var i=this.map,r=e;i.storedTilesRes=new Array(t);for(var s=t-1;s>=0;s--){var a=r[s];if(a.metanode&&a.surface&&a.metanode.hasGeometry()&&a.surfaceMesh&&a.surfaceMesh.isReady(!0,0,!0)){for(var n=a.surfaceMesh,o=[],h=0,l=n.submeshes.length;h<l;h++){for(var u=n.submeshes[h],c=u.vertices.slice(),d=u.bbox.min,p=u.bbox.max,f=[p[0]-d[0],p[1]-d[1],p[2]-d[2]],g=0,m=c.length;g<m;g+=3)c[g]=c[g]*f[0]+d[0],c[g+1]=c[g+1]*f[1]+d[1],c[g+2]=c[g+2]*f[2]+d[2];o.push({bbox:[d.slice(),p.slice()],vertices:c})}i.storedTilesRes[s]={id:a.id.slice(),type:"mesh",submeshes:o}}}},S.prototype.traceHeight=function(e,t,i){if(e){this.params=t;var r=i?this.traceHeightTileByNodeOnly:this.traceHeightTileByMap;(1!=e.id[0]||(this.traceHeightTile(e.parent,0,!0),e.parent.metanode))&&this.traceHeightTile(e,0,!1,r)}},S.prototype.traceHeightTile=function(e,t,i,r){if(null!=e)if(e.isMetanodeReady(this,0)&&!i){if(e.metanode.metatile.used(),e.lastSurface&&e.lastSurface==e.surface&&(e.lastSurface=null,e.restoreLastState()),r(e,this.params,t)){var s=this.traceHeightChild(e,this.params),a=e.children[s];a||(this.params.finalNode=!0),this.traceHeightTile(a,0,!1,r)}}else this.params.waitingForNode=!0},S.prototype.traceHeightChild=function(e,t){var i=t.coords,r=t.extents,s=[.5*(r.ll[0]+r.ur[0]),.5*(r.ll[1]+r.ur[1])],a=i[0]>=s[0],n=i[1]>=s[1];return a?(r.ll[0]=s[0],n?r.ll[1]=s[1]:r.ur[1]=s[1]):(r.ur[0]=s[0],n?r.ll[1]=s[1]:r.ur[1]=s[1]),a?n?1:3:n?0:2},S.prototype.traceHeightTileByMap=function(e,t){if(!e||e.id[0]>t.desiredLod&&t.heightMap)return!1;var i=e.metanode;if(!i)return!1;if(!i.hasNavtile())return t.heightMap||(t.metanode=i),!0;if(t.bestHeightMap=e.id[0],e.heightMap){if(e.heightMap.isReady(null,null,!0))return t.parent={metanode:t.metanode,heightMap:t.heightMap,heightMapExtents:t.heightMapExtents},t.metanode=i,t.heightMap=e.heightMap,t.heightMapExtents={ll:t.extents.ll.slice(),ur:t.extents.ur.slice()},e.id[0]!=t.desiredLod}else{if(!e.surface||!e.resourceSurface)return!1;if(!e.resourceSurface.getNavUrl)return!1;var r=e.resourceSurface.getNavUrl(e.id);e.heightMap=e.resources.getTexture(r,!0)}return!1},S.prototype.traceHeightTileByNodeOnly=function(e,t){if(!e||e.id[0]>t.desiredLod)return!1;var i=e.metanode;return!!i&&(t.parent={metanode:t.metanode},t.metanode=i,e.id[0]!=t.desiredLod)},S.prototype.getNodeById=function(e,t){var i=this.surfaceTree;if(null!=i){for(var r=e[0];r>0;r--){var s=1<<r-1,a=0;if(0!=(e[1]&s)&&(a+=1),0!=(e[2]&s)&&(a+=2),!i.children[a]){if(!i.isMetanodeReady(this,0,t))return null;if(!i.metanode.hasChild(a))return null;i.addChild(a)}i=i.children[a]}if(i&&i.isMetanodeReady(this,0,t)){var n=i.metanode;return i.metanode.metatile.used(),n}}},S.prototype.getRenderedNodeById=function(e,t){var i=this.surfaceTree;if(null!=i){if(i.drawCounter==t){if(!i.isMetanodeReady(this,0))return;return i.metanode}for(var r=e[0];r>0;r--){var s=1<<r-1,a=0;if(0!=(e[1]&s)&&(a+=1),0!=(e[2]&s)&&(a+=2),!i.children[a]){if(!i.isMetanodeReady(this,0))return;if(!i.metanode.hasChild(a))return}if((i=i.children[a]).drawCounter==t){if(!i.isMetanodeReady(this,0))return;return i.metanode}if(1==r)return i.metanode}}},S.prototype.chekTileMesh=function(e){if(this.params.loadMeshes||this.params.loadTextures){var t=this.config.mapNoTextures;this.config.mapNoTextures=!this.params.loadTextures,this.map.draw.drawTiles.drawSurfaceTile(e,e.metanode,this.map.renderer.cameraPosition,e.texelSize,0,!0,!1,!0)||(this.params.loaded=!1),this.config.mapNoTextures=t}},S.prototype.traceAreaTiles=function(e,t,i){if(null!=e){if(!e.isMetanodeReady(this,0)||i)return this.params.loaded=!1,void e.isMetanodeReady(this,0);if(e.metanode.metatile.used(),e.lastSurface&&e.lastSurface==e.surface&&(e.lastSurface=null,e.restoreLastState()),e.insideCone(this.params.coneVec,this.params.coneAngle,e.metanode)){if("lod"==this.params.mode?e.id[0]>=this.params.limit:e.metanode.pixelSize<=this.params.limit)return this.chekTileMesh(e),void this.params.areaTiles.push(e);if(e.metanode.hasChildren())for(var r=0;r<4;r++)this.traceAreaTiles(e.children[r],t,i);else this.chekTileMesh(e),this.params.areaTiles.push(e)}}};var A=S,C=a.a,T=c,P=function(e,t,i,r,s){this.map=e,this.stats=e.stats,this.tile=r,this.internal=s,this.image=null,this.imageData=null,this.imageExtents=null,this.gpuTexture=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.neverReady=!1,this.mapLoaderUrl=t,this.type=i||!1,this.statsCounter=0,this.checkStatus=0,this.checkType=null,this.checkValue=null,this.fastHeaderCheck=!1,this.gpuSize=0,this.fileSize=0,this.cacheItem=null,this.gpuCacheItem=null};P.prototype.kill=function(){this.killImage(),this.killGpuTexture(),this.mask&&(this.mask.killImage(),this.mask.killGpuTexture())},P.prototype.killImage=function(e){this.image=null,this.imageData=null,!0!==e&&this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),this.mask&&this.mask.killImage(),this.gpuTexture||(this.loadState=0),this.cacheItem=null},P.prototype.killGpuTexture=function(e){null!=this.gpuTexture&&(this.stats.gpuTextures-=this.gpuTexture.size,this.gpuTexture.kill(),this.stats.graphsFluxTexture[1][0]++,this.stats.graphsFluxTexture[1][1]+=this.gpuTexture.size,this.mask&&this.mask.killGpuTexture()),this.gpuTexture=null,!0!==e&&this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.image||this.imageData||(this.loadState=0),this.gpuCacheItem=null},P.prototype.isReady=function(e,t,i,r){var s=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||s,this.neverReady)return!1;switch(r.checkType){case 2:case 3:case 4:if(2!=this.checkStatus){if(this.checkType=r.checkType,this.checkValue=r.checkValue,0==this.checkStatus)this.scheduleHeadRequest(t,4==this.checkType);else if(3==this.checkStatus)this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleHeadRequest(t,4==this.checkType);else if(-1==this.checkStatus&&r.extraInfo)for(r.extraBound||(r.extraBound={tile:r.extraInfo.tile,layer:r.extraInfo.layer},r.setBoundTexture(r.extraBound.tile.parent,r.extraBound.layer));r.extraBound.texture.extraBound||-1==r.extraBound.texture.checkStatus;)r.setBoundTexture(r.extraBound.sourceTile.parent,r.extraBound.layer);return!1}}if(2==this.loadState){var a;if(!e&&this.cacheItem&&this.map.resourcesCache.updateItem(this.cacheItem),i)return 1==this.type&&(this.imageData||(a=performance.now(),this.buildHeightMap(),this.stats.renderBuild+=performance.now()-a)),!0;if(1==this.type)this.imageData||(a=performance.now(),this.buildHeightMap(),this.stats.renderBuild+=performance.now()-a);else{if(!this.gpuTexture){if(this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed)return!1;if(s)return!1;a=performance.now(),this.buildGpuTexture(),this.stats.renderBuild+=performance.now()-a}!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem)}return!0}return 0==this.loadState?e||this.scheduleLoad(t):3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t),!1},P.prototype.scheduleLoad=function(e,t){this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this,t),e,this.tile,this.internal?"texture-in":"texture-ex")},P.prototype.onLoad=function(e,t,i,r){this.mapLoaderCallLoaded=i,this.mapLoaderCallError=r;var s=this.onLoadError.bind(this),a=this.onLoaded.bind(this);e?this.checkStatus=1:this.loadState=1,this.map.config.mapXhrImageLoad?this.map.loader.processLoadBinary(t,this.onBinaryLoaded.bind(this),s,null,"texture"):this.image=C.loadImage(t,a,s,!!this.map.core.tokenCookieHost&&-1!=t.indexOf(this.map.core.tokenCookieHost))},P.prototype.onLoadError=function(e){this.map.killed||(e&&window.URL.revokeObjectURL(this.image.src),this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},P.prototype.onBinaryLoaded=function(e,t,i){if(this.fastHeaderCheck&&this.checkType&&1!=this.checkType&&(this.onHeadLoaded(null,e,null),-1==this.checkStatus))this.mapLoaderCallLoaded();else{if(t)return this.onLoaded(!1,e),void(this.fileSize=i);if(this.fileSize=e.size,this.map.config.mapAsyncImageDecode)createImageBitmap(e).then(this.onLoaded.bind(this,!1));else{var r=new Image;r.onerror=this.onLoadError.bind(this,!0,null),r.onload=this.onLoaded.bind(this,!0,null),this.image=r,r.src=window.URL.createObjectURL(e)}}},P.prototype.onLoaded=function(e,t){if(!this.map.killed){e&&window.URL.revokeObjectURL(this.image.src),t&&(this.image=t,this.image.naturalWidth=t.width,this.image.naturalHeight=t.height);var i=this.image.naturalWidth*this.image.naturalHeight*(this.heightMap,3);this.gpuSize=this.image.naturalWidth*this.image.naturalHeight*4,this.cacheItem=this.map.resourcesCache.insert(this.killImage.bind(this,!0),i),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},P.prototype.scheduleHeadRequest=function(e,t){this.map.config.mapXhrImageLoad&&this.fastHeaderCheck?this.scheduleLoad(e,!0):this.map.loader.load(this.mapLoaderUrl,this.onLoadHead.bind(this,t),e,this.tile,this.internal,this.internal?"texture-in":"texture-ex")},P.prototype.onLoadHead=function(e,t,i,r){this.mapLoaderCallLoaded=i,this.mapLoaderCallError=r;var s=this.onLoadHeadError.bind(this,e),a=this.onHeadLoaded.bind(this,e);this.checkStatus=1,e?this.map.loader.processLoadBinary(t,onLoad,s,null,"texture"):C.headRequest(t,a,s,!!C.useCredentials&&-1!=this.mapLoaderUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams,"blob")},P.prototype.onLoadHeadError=function(){this.map.killed||(this.checkStatus=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},P.prototype.onHeadLoaded=function(e,t,i){if(!this.map.killed)if(this.checkStatus=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.map.config.mapXhrImageLoad&&this.fastHeaderCheck)switch(this.checkType){case 4:t&&t.size==this.checkValue&&(this.checkStatus=-1);break;case 2:t&&t.type==this.checkValue&&(this.checkStatus=-1);break;case 3:i&&-1!=this.checkValue.indexOf(i)&&(this.checkStatus=-1)}else{switch(this.checkType){case 4:t&&t.byteLength==this.checkValue&&(this.checkStatus=-1);break;case 2:t&&-1!=t.indexOf(this.checkValue)&&(this.checkStatus=-1);break;case 3:i&&-1!=this.checkValue.indexOf(i)&&(this.checkStatus=-1)}this.mapLoaderCallLoaded()}},P.prototype.buildGpuTexture=function(){if(this.map.config.mapCheckTextureSize&&(this.image.naturalWidth>1024||this.image.naturalHeight>1024)){console.log("very large texture: "+this.image.naturalWidth+"x"+this.image.naturalHeight+" "+this.mapLoaderUrl);for(var e=new Uint8Array(1024),t=0;t<16;t++)for(var i=0;i<16;i++){var r=4*(16*t+i);e[r]=0,e[r+1]=0,e[r+2]=0,e[r+3]=255}return this.gpuTexture=new T(this.map.renderer.gpu),this.gpuTexture.createFromData(16,16,e),this.gpuTexture.width=this.image.naturalWidth,this.gpuTexture.height=this.image.naturalHeight,void(this.gpuSize=0)}this.gpuTexture=new T(this.map.renderer.gpu,null,this.map.core),this.gpuTexture.createFromImage(this.image,2==this.type?"nearest":"linear",!1),this.gpuSize=this.gpuTexture.getSize(),this.stats.gpuTextures+=this.gpuSize,this.stats.graphsFluxTexture[0][0]++,this.stats.graphsFluxTexture[0][1]+=this.gpuSize,this.gpuCacheItem=this.map.gpuCache.insert(this.killGpuTexture.bind(this,!0),this.gpuSize)},P.prototype.buildHeightMap=function(){var e=document.createElement("canvas");e.width=this.image.naturalWidth,e.height=this.image.naturalHeight;var t=e.getContext("2d");t.drawImage(this.image,0,0),this.imageData=t.getImageData(0,0,this.image.naturalWidth,this.image.naturalHeight).data,this.imageExtents=[this.image.naturalWidth,this.image.naturalHeight],this.image=null},P.prototype.getGpuTexture=function(){return this.gpuTexture},P.prototype.getHeightMapValue=function(e,t){return this.imageData?this.imageData[4*(t*this.imageExtents[0]+e)]:0};var F=P,L=F,E=function(e,t,i,r,s,a,n){if(this.map=e,this.stats=e.stats,this.tile=a,this.internal=n,this.mainTexture=a?a.resources.getSubtexture(this,t,i,a,n):new L(e,t,i,a,n),this.maskTexture=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.neverReady=!1,this.maskTexture=null,this.mapLoaderUrl=t,this.type=i||0,this.extraBound=r,this.extraInfo=s,this.statsCounter=0,this.checkStatus=0,this.checkType=null,this.checkValue=null,this.fastHeaderCheck=!1,this.fileSize=0,s&&s.layer){var o=s.layer;if(o.availability)switch(this.checkType=o.availability.type,this.checkType){case 2:this.checkValue=o.availability.mime;break;case 3:this.checkValue=o.availability.codes;break;case 4:this.checkValue=o.availability.size}}};E.prototype.kill=function(){this.mainTexture.killImage(),this.mainTexture.killGpuTexture(),this.mainTexture=null,this.maskTexture&&(this.maskTexture.killImage(),this.maskTexture.killGpuTexture())},E.prototype.killImage=function(){this.mainTexture.killImage(),this.maskTexture&&this.maskTexture.killImage()},E.prototype.killGpuTexture=function(){this.mainTexture.killGpuTexture(),this.maskTexture&&this.maskTexture.killGpuTexture()},E.prototype.setBoundTexture=function(e,t,i){if(e){if(i){if(this.extraBound.sourceTile=e,this.extraBound.hmap=i,!e.hmap){var r=e.resourceSurface.getHMapUrl(e.id,!0);e.hmap=e.resources.getTexture(r,null,null,{tile:e,hmap:i},this.tile,this.internal)}this.extraBound.texture=e.hmap}else if(t){if(this.extraBound.sourceTile=e,this.extraBound.layer=t,!e.boundTextures[t.id]){e.boundLayers[t.id]=t;r=t.getUrl(e.id);e.boundTextures[t.id]=e.resources.getTexture(r,null,null,{tile:e,layer:t},this.tile,this.internal)}this.extraBound.texture=e.boundTextures[t.id]}this.extraBound.transform=this.map.draw.drawTiles.getTileTextureTransform(e,this.extraBound.tile),this.map.markDirty()}},E.prototype.isReady=function(e,t,i){var r,s=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||s,this.neverReady)return!1;if(this.extraBound){if(this.extraBound.texture){for(;this.extraBound.texture.extraBound||-1==this.extraBound.texture.checkStatus;){if(r=this.extraBound.sourceTile.parent,this.extraBound.hmap){if(!r||r.id[0]<1)return this.neverReady=!0,this.extraBound.tile.resetDrawCommands=!0,this.map.markDirty(),!1}else if(this.extraBound.layer&&r.id[0]<this.extraBound.layer.lodRange[0])return this.neverReady=!0,this.extraBound.tile.resetDrawCommands=!0,this.map.markDirty(),!1;this.setBoundTexture(r,this.extraBound.layer)}var a=this.extraBound.texture.isReady(e,t,i);return a&&this.checkMask&&(this.extraBound.tile.resetDrawCommands=null!=this.extraBound.texture.getMaskTexture(),this.checkMask=!1),a}return this.setBoundTexture(this.extraBound.sourceTile,this.extraBound.layer,this.extraBound.hmap),this.isReady(e,t,i)}switch(this.checkType){case 1:if(2!=this.checkStatus){if(0==this.checkStatus&&this.extraInfo&&this.extraInfo.tile){var n=this.extraInfo.tile.boundmetaresources;n||(n=this.map.resourcesTree.findAgregatedNode(this.extraInfo.tile.id,8),this.extraInfo.tile.boundmetaresources=n);var o=this.extraInfo.layer,h=this.extraInfo.metaPath;this.extraInfo.metaPath||(h=o.getMetatileUrl(n.id),this.extraInfo.metaPath=h);var l=n.getTexture(h,!0,null,null,this.tile,this.internal);if(this.maskTexture)this.maskTexture.isReady(e,t,i,this)&&(this.checkStatus=2);else if(l.isReady(e,t,i)){var u=this.extraInfo.tile,c=l.getHeightMapValue(255&u.id[1],255&u.id[2]);this.checkStatus=128&c?2:-1,2==this.checkStatus&&(64&c||(h=o.getMaskUrl(u.id),this.maskTexture=u.resources.getTexture(h,null,null,null,this.tile,this.internal),this.checkStatus=0)),u.resetDrawCommands=!0,this.map.markDirty()}}if(-1==this.checkStatus){if(!this.extraBound){if((r=this.extraInfo.tile.parent).id[0]<this.extraInfo.layer.lodRange[0])return this.neverReady=!0,this.extraInfo.tile.resetDrawCommands=!0,this.map.markDirty(),!1;this.extraBound={tile:this.extraInfo.tile,layer:this.extraInfo.layer},this.setBoundTexture(this.extraBound.tile.parent,this.extraBound.layer),this.checkMask=!0}for(;this.extraBound.texture.extraBound||-1==this.extraBound.texture.checkStatus;){if((r=this.extraBound.sourceTile.parent).id[0]<this.extraBound.layer.lodRange[0])return this.neverReady=!0,this.extraBound.tile.resetDrawCommands=!0,this.map.markDirty(),!1;this.setBoundTexture(r,this.extraBound.layer)}}return!1}}var d=!0;return this.maskTexture&&(d=this.maskTexture.isReady(e,t,i,this)),this.mainTexture.isReady(e,t,i,this)&&d},E.prototype.isMaskPosible=function(){var e=this;return this.extraBound&&this.extraBound.texture&&(e=this.extraBound.texture),1==e.checkType},E.prototype.isMaskInfoReady=function(){var e=this;return this.extraBound&&this.extraBound.texture&&(e=this.extraBound.texture),1!=e.checkType||!(!this.maskTexture&&2!=e.checkStatus&&-1!=e.checkStatus)},E.prototype.getGpuTexture=function(){return this.extraBound?this.extraBound.texture?this.extraBound.texture.getGpuTexture():null:this.mainTexture.getGpuTexture()},E.prototype.getMaskTexture=function(){return this.extraBound&&this.extraBound.texture?this.extraBound.texture.getMaskTexture():this.maskTexture},E.prototype.getGpuMaskTexture=function(){return this.extraBound?this.extraBound.texture&&this.extraBound.texture.maskTexture?this.extraBound.texture.getGpuMaskTexture():null:this.maskTexture?this.maskTexture.getGpuTexture():null},E.prototype.getGpuSize=function(){return(this.mainTexture&&this.mainTexture.gpuSize?this.mainTexture.gpuSize:0)+(this.maskTexture&&this.maskTexture.gpuSize?this.maskTexture.gpuSize:0)},E.prototype.getImageData=function(){return this.mainTexture.imageData},E.prototype.getImageExtents=function(){return this.mainTexture.imageExtents},E.prototype.getHeightMapValue=function(e,t){return this.mainTexture.getHeightMapValue(e,t)},E.prototype.getTransform=function(){return this.extraBound?this.extraBound.texture?this.extraBound.transform:null:[1,1,0,0]};var k=E,N=function(e,t,i,r,s,a){this.min=[],this.max=[],this.min[0]=null!=e?e:Number.POSITIVE_INFINITY,this.min[1]=null!=t?t:Number.POSITIVE_INFINITY,this.min[2]=null!=i?i:Number.POSITIVE_INFINITY,this.max[0]=null!=r?r:Number.NEGATIVE_INFINITY,this.max[1]=null!=s?s:Number.NEGATIVE_INFINITY,this.max[2]=null!=a?a:Number.NEGATIVE_INFINITY,this.updateMaxSize()};N.prototype.clone=function(){return new N(this.min[0],this.min[1],this.min[2],this.max[0],this.max[1],this.max[2])},N.prototype.side=function(e){return this.max[e]-this.min[e]},N.prototype.updateMaxSize=function(){this.maxSize=Math.abs(Math.max(this.max[0]-this.min[0],this.max[1]-this.min[1],this.max[2]-this.min[2]))},N.prototype.center=function(e){return null!=e?(e[0]=.5*(this.min[0]+this.max[0]),e[1]=.5*(this.min[1]+this.max[1]),e):(this.middle||(this.middle=[.5*(this.min[0]+this.max[0]),.5*(this.min[1]+this.max[1]),.5*(this.min[2]+this.max[2])],isNaN(this.middle[0])&&(this.middle[0]=0),isNaN(this.middle[1])&&(this.middle[1]=0),isNaN(this.middle[2])&&(this.middle[2]=0)),this.middle)},N.prototype.translateXY=function(e){return new N(this.min[0]-e[0],this.min[1]-e[1],this.min[2],this.max[0]-e[0],this.max[1]-e[1],this.max[2])};var I=N,B=s.d,R=s.b,z=I,U=p.a,D=a.a,_=function(e,t,i,r){this.metatile=e,this.map=e.map,this.id=t,this.credits=[],this.alien=!1,this.ready=!1,this.heightReady=!1,this.divisionNode=r,this.diskPos=new Array(3),this.diskDistance=1,this.diskNormal=new Array(3),this.diskAngle=1,this.diskAngle2=1,this.diskAngle2A=1,this.bbox2=new Array(24),i&&this.parseMetanode(i)};_.prototype.kill=function(){},_.prototype.hasChild=function(e){return 0!=(this.flags&1<<e+4)},_.prototype.hasChildById=function(e){var t=e[1]-(this.id[1]<<1),i=e[2]-(this.id[2]<<1);return this.hasChild((i<<1)+t)},_.prototype.hasChildren=function(){return 0!=(240&this.flags)},_.prototype.parseExtentBits=function(e,t,i){for(var r=0,s=0,a=t;s<a;s++){var n=7&i;e[i>>3]&1<<7-n&&(r|=1<<a-s-1),i++}return r/=(1<<a)-1},_.prototype.hasGeometry=function(){return 0!=(1&this.flags)},_.prototype.hasNavtile=function(){return 0!=(2&this.flags)},_.prototype.usedTexelSize=function(){return 0!=(4&this.flags)},_.prototype.usedDisplaySize=function(){return 0!=(8&this.flags)},_.prototype.parseMetanode=function(e){var t=e.data,i=this.metatile.version;if(this.flags=t.getUint8(e.index,!0),e.index+=1,i<5){for(var r=6*(this.id[0]+2)+7>>3,s=this.map.metanodeBuffer,a=0,n=r;a<n;a++)s[a]=t.getUint8(e.index,!0),e.index+=1;var o=this.id[0]+2,h=[0,0,0],l=[0,0,0],u=0,c=this.map.spaceExtentSize,d=this.map.spaceExtentOffset;for(a=0;a<3;a++)h[a]=this.parseExtentBits(s,o,u)*c[a]+d[a],u+=o,l[a]=this.parseExtentBits(s,o,u)*c[a]+d[a],u+=o;var p=0;for(a=0,n=s.length;a<n;a++)p+=s[a];0==p&&(h[0]=Number.POSITIVE_INFINITY,h[1]=Number.POSITIVE_INFINITY,h[2]=Number.POSITIVE_INFINITY,l[0]=Number.NEGATIVE_INFINITY,l[1]=Number.NEGATIVE_INFINITY,l[2]=Number.NEGATIVE_INFINITY),this.bbox=new z(h[0],h[1],h[2],l[0],l[1],l[2])}i>=4&&(this.minZ=t.getFloat32(e.index,!0),e.index+=4,this.maxZ=t.getFloat32(e.index,!0),e.index+=4,this.surrogatez=t.getFloat32(e.index,!0),e.index+=4),i>=5&&(t.getFloat32(e.index,!0),e.index+=4,t.getFloat32(e.index,!0),e.index+=4,t.getFloat32(e.index,!0),e.index+=4,t.getFloat32(e.index,!0),e.index+=4),this.internalTextureCount=t.getUint8(e.index,!0),e.index+=1,this.pixelSize=D.decodeFloat16(t.getUint16(e.index,!0)),e.index+=2,this.displaySize=t.getUint16(e.index,!0),e.index+=2,this.displaySize=this.metatile.surface.displaySize,0==(4&this.flags)&&(this.pixelSize=Number.POSITIVE_INFINITY),0==(8&this.flags)&&(this.displaySize=256),this.minHeight=t.getInt16(e.index,!0),e.index+=2,this.maxHeight=t.getInt16(e.index,!0),e.index+=2,i<4&&(this.minZ=this.minHeight,this.maxZ=this.maxHeight,this.surrogatez=this.minHeight),this.minZ2=this.minZ,this.maxZ2=this.maxZ,this.metatile.version>=3&&(128&this.metatile.flags?(this.sourceReference=t.getUint16(e.index,!0),e.index+=2):64&this.metatile.flags&&(this.sourceReference=t.getUint8(e.index,!0),e.index+=1)),this.heightReady=this.hasNavtile(),this.alien=!1,this.generateCullingHelpers()},_.prototype.clone=function(){var e=new _(this.metatile,this.id);e.flags=this.flags,e.minHeight=this.minHeight,e.maxHeight=this.maxHeight,e.minZ=this.minZ,e.maxZ=this.maxZ,e.minZ2=this.minZ2,e.maxZ2=this.maxZ2,e.llx=this.llx,e.lly=this.lly,e.urx=this.urx,e.ury=this.ury,e.surrogatez=this.surrogatez,e.internalTextureCount=this.internalTextureCount,e.pixelSize=this.pixelSize,e.displaySize=this.displaySize,e.ready=this.ready,e.stream=this.stream,e.heightReady=this.heightReady,e.credits=new Array(this.credits.length);for(var t=0,i=this.credits.length;t<i;t++)e.credits[t]=this.credits[t];return this.bbox&&(e.bbox=this.bbox.clone()),e.diskPos=this.diskPos,e.diskNormal=this.diskNormal,e.diskAngle=this.diskAngle,e.diskAngle2=this.diskAngle2,e.diskAngle2A=this.diskAngle2A,e.diskDistance=this.diskDistance,e.bbox2=this.bbox2,e.divisionNode=this.divisionNode,this.plane&&(e.plane=this.plane.slice()),e},_.prototype.generateCullingHelpers=function(e){this.ready=!0;var t=this.map,i=t.draw,r=t.isGeocent,s=this.metatile.useVersion;if(!(this.id[0]<t.measure.minDivisionNodeDepth||!r&&s<4)&&(t.config.mapPreciseCulling||s>=4)){if(e)return;var a,n,o,h,l,u=i.tmpVec3;if(this.id[0]>t.measure.maxDivisionNodeDepth){var c=i.tmpVec5;if(!(a=t.measure.getSpatialDivisionNodeFromId(this.id)))return;t.measure.getSpatialDivisionNodeAndExtents2(this.id,c,a),n=c[1],o=c[2],h=c[3],l=c[4],this.divisionNode=a}else{var d=t.measure.getSpatialDivisionNodeAndExtents(this.id);if(!(a=d?d[0]:null))return;n=d[1][0][0],o=d[1][0][1],h=d[1][1][0],l=d[1][1][1],this.divisionNode=a}this.llx=n,this.lly=o,this.urx=h,this.ury=l;var p=this.minZ;u[0]=.5*(h+n),u[1]=.5*(l+o),u[2]=p,a.getPhysicalCoordsFast(u,!0,this.diskPos,0,0),r?(this.diskDistance=B.length(this.diskPos),B.normalize(this.diskPos,this.diskNormal)):(this.diskNormal[0]=0,this.diskNormal[1]=0,this.diskNormal[2]=1);var f=this.diskNormal;u[0]=h,u[1]=l,u[2]=p;var g,m,v=this.bbox2;if(a.getPhysicalCoordsFast(u,!0,v,0,0),u[1]=o,a.getPhysicalCoordsFast(u,!0,v,0,3),u[0]=n,a.getPhysicalCoordsFast(u,!0,v,0,6),u[1]=l,a.getPhysicalCoordsFast(u,!0,v,0,9),!r)return g=this.maxZ-p,v[12]=v[0],v[13]=v[1],v[14]=v[2]+g,v[15]=v[3],v[16]=v[4],v[17]=v[5]+g,v[18]=v[6],v[19]=v[7],v[20]=v[8]+g,v[21]=v[9],v[22]=v[10],void(v[23]=v[11]+g);var y,b,x,w,M,S=B.dot;if(t.config.mapPreciseBBoxTest||s>=4)if(g=this.maxZ-p,this.id[0]<=3){(m=B.normalize2)(v,0,u),y=S(f,u),m(v,3,u),b=S(f,u),m(v,6,u),x=S(f,u),m(v,9,u),w=S(f,u),M=Math.min(y,b,x,w),u[0]=.5*(h+n),u[1]=l,u[2]=p,a.getPhysicalCoordsFast(u,!0,v,0,12),u[1]=o,a.getPhysicalCoordsFast(u,!0,v,0,15),u[0]=h,u[1]=.5*(l+o),a.getPhysicalCoordsFast(u,!0,v,0,18),u[0]=n,a.getPhysicalCoordsFast(u,!0,v,0,21);var A=this.diskPos,C=Math.max(v[0],v[3],v[6],v[9],v[12],v[15],v[18],v[21],A[0]),T=Math.min(v[0],v[3],v[6],v[9],v[12],v[15],v[18],v[21],A[0]),P=Math.max(v[1],v[4],v[7],v[10],v[13],v[16],v[19],v[22],A[1]),F=Math.min(v[1],v[4],v[7],v[10],v[13],v[16],v[19],v[22],A[1]),L=Math.max(v[2],v[5],v[8],v[11],v[14],v[17],v[20],v[23],A[2]),E=Math.min(v[2],v[5],v[8],v[11],v[14],v[17],v[20],v[23],A[2]);this.id[0]<=1&&(u[0]=h+.25*(n-h),u[1]=.5*(l+o),a.getPhysicalCoordsFast(u,!0,v,0,12),u[0]=h+.75*(n-h),a.getPhysicalCoordsFast(u,!0,v,0,15),u[0]=.5*(h+n),u[1]=l+.25*(o-l),a.getPhysicalCoordsFast(u,!0,v,0,18),u[1]=l+.75*(o-l),a.getPhysicalCoordsFast(u,!0,v,0,21),C=Math.max(C,v[12],v[15],v[18],v[21]),T=Math.min(T,v[12],v[15],v[18],v[21]),P=Math.max(P,v[13],v[16],v[19],v[22]),F=Math.min(F,v[13],v[16],v[19],v[22]),L=Math.max(L,v[14],v[17],v[20],v[23]),E=Math.min(E,v[14],v[17],v[20],v[23]),M=-1),v[0]=T,v[1]=F,v[2]=E,v[3]=C,v[4]=F,v[5]=E,v[6]=C,v[7]=P,v[8]=E,v[9]=T,v[10]=P,v[11]=E,v[12]=T,v[13]=F,v[14]=L,v[15]=C,v[16]=F,v[17]=L,v[18]=C,v[19]=P,v[20]=L,v[21]=T,v[22]=P,v[23]=L}else{if(m=B.normalize3,S=B.dot2,m(v,0,v,12),y=S(f,v,12),m(v,3,v,15),b=S(f,v,15),m(v,6,v,18),x=S(f,v,18),m(v,9,v,21),w=S(f,v,21),M=Math.min(y,b,x,w),this.id[0]<=8){u=this.diskPos;var k=.024*(5-(this.id[0]-4));v[0]+=(v[0]-u[0])*k,v[1]+=(v[1]-u[1])*k,v[2]+=(v[2]-u[2])*k,v[3]+=(v[3]-u[0])*k,v[4]+=(v[4]-u[1])*k,v[5]+=(v[5]-u[2])*k,v[6]+=(v[6]-u[0])*k,v[7]+=(v[7]-u[1])*k,v[8]+=(v[8]-u[2])*k,v[9]+=(v[9]-u[0])*k,v[10]+=(v[10]-u[1])*k,v[11]+=(v[11]-u[2])*k}g+=i.planetRadius-i.planetRadius*M,v[12]=v[0]+v[12]*g,v[13]=v[1]+v[13]*g,v[14]=v[2]+v[14]*g,v[15]=v[3]+v[15]*g,v[16]=v[4]+v[16]*g,v[17]=v[5]+v[17]*g,v[18]=v[6]+v[18]*g,v[19]=v[7]+v[19]*g,v[20]=v[8]+v[20]*g,v[21]=v[9]+v[21]*g,v[22]=v[10]+v[22]*g,v[23]=v[11]+v[23]*g}else(m=B.normalize2)(v,0,u),y=S(f,u),m(v,3,u),b=S(f,u),m(v,6,u),x=S(f,u),m(v,9,u),w=S(f,u),M=Math.min(y,b,x,w);s>=5&&this.usedDisplaySize()&&(this.bboxMaxSize=Math.max(B.distance2(v,0,v,3),B.distance2(v,3,v,6),B.distance2(v,0,v,12))),this.diskAngle=Math.cos(Math.max(0,.5*Math.PI-Math.acos(M))),this.diskAngle2=M,this.diskAngle2A=Math.acos(M)}},_.prototype.getWorldMatrix=function(e,t){var i=t;return null!=i?(i[0]=this.bbox.side(0),i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=this.bbox.side(1),i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=this.bbox.side(2),i[11]=0,i[12]=this.bbox.min[0]-e[0],i[13]=this.bbox.min[1]-e[1],i[14]=this.bbox.min[2]-e[2],i[15]=1):(i=R.create(),R.multiply(U.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),U.scaleMatrix(this.bbox.side(0),this.bbox.side(1),this.bbox.side(2)),i)),i},_.prototype.drawBBox=function(e){if(this.metatile.useVersion>=4)return this.drawBBox2(e);var t=this.map.renderer;t.gpu.useProgram(t.progBBox,["aPosition"]);var i=R.create(),r=R.create();R.multiply(t.camera.getModelviewMatrix(),this.getWorldMatrix(e),r);var s=t.camera.getProjectionMatrix();R.multiply(s,r,i),t.progBBox.setMat4("uMVP",i),t.bboxMesh.draw(t.progBBox,"aPosition")},_.prototype.drawBBox2=function(){for(var e=this.bbox2,t=this.map.draw.bboxBuffer,i=this.map.camera.position,r=this.map.renderer,s=r.progBBox2,a=0;a<24;a+=3)t[a]=e[a]-i[0],t[a+1]=e[a+1]-i[1],t[a+2]=e[a+2]-i[2];r.gpu.useProgram(s,["aPosition"]),s.setFloatArray("uPoints",t);var n=r.camera.getMvpMatrix();s.setMat4("uMVP",n),r.bboxMesh2.draw(s,"aPosition")},_.prototype.drawPlane=function(e,t){var i=this.map.renderer,r=this.map.draw.planeBuffer,s=this.plane;if(s){i.gpu.useProgram(i.progPlane,["aPosition","aTexCoord"]);var a=R.create(),n=i.camera.getModelviewMatrix(),o=i.camera.getProjectionMatrix();R.multiply(o,n,a);for(var h=e[0],l=e[1],u=e[2],c=0;c<9;c++){var d=3*c;r[d]=s[d]-h,r[d+1]=s[d+1]-l,r[d+2]=s[d+2]-u}var p=i.progPlane;p.setMat4("uMV",n),p.setMat4("uProj",o),p.setFloatArray("uPoints",r);var f=Math.max(10,t.distance+20),g=Math.log(f)/Math.log(8),m=g-Math.floor(g);p.setVec4("uParams",[4,0,1/15,8]),p.setVec4("uParams2",[0,0,m,0]),i.gpu.bindTexture(i.heightmapTexture),i.planeMesh.draw(i.progPlane,"aPosition","aTexCoord")}},_.prototype.getGridHeight=function(e,t,i){var r=e[0]-this.llx,s=e[1]-this.lly,a=i-1,n=i-1;(r=a*(r/(this.urx-this.llx)))<0&&(r=0),(s=n*(s/(this.ury-this.lly)))<0&&(s=0),r>a&&(r=a),s>n&&(s=n);var o=Math.floor(r),h=Math.floor(s),l=r-o,u=s-h,c=h*i,d=h==n?c:c+i,p=o==a?o:o+1,f=t[c+o],g=t[c+p],m=t[d+o],v=f+(g-f)*l;return v+(m+(t[d+p]-m)*l-v)*u};var O=_,G=(a.a,O),V=function(e,t,i){this.metaresources=e,this.map=e.map,this.surface=t,this.id=e.id,this.tile=i,this.nodes=[],this.drawCounter=0,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.size=0,this.cacheItem=null};V.prototype.kill=function(e){!0!==e&&null!=this.cacheItem&&this.map.metatileCache.remove(this.cacheItem),this.metaresources&&this.metaresources.removeMetatile(this),this.loadState=0,this.surface=0,this.cacheItem=null,this.nodes=[]},V.prototype.clone=function(e){var t=new V(this.metaresources,e);return t.nodes=this.nodes,t.loadState=this.loadState,t.nodes=this.nodes,t.size=this.size,t.lod=this.lod,t.metatileIdx=this.metatileIdx,t.metatileIdy=this.metatileIdy,t.offsetx=this.offsetx,t.offsety=this.offsety,t.sizex=this.sizex,t.sizey=this.sizey,t.version=this.version,t.credits=this.credits,this.version<2?t.nodeSize=this.nodeSize:(t.flags=this.flags,t.creditCount=this.creditCount,t.flagPlanes=this.flagPlanes),t.cacheItem=this.map.metatileCache.insert(t.kill.bind(t,!0),t.size),t},V.prototype.isReady=function(e){return 2==this.loadState||(0==this.loadState&&(3==this.loadState?this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(e):this.scheduleLoad(e)),!1)},V.prototype.used=function(){null!=this.cacheItem&&this.map.metatileCache.updateItem(this.cacheItem)},V.prototype.getNode=function(e){var t=e[1]-this.id[1]-this.offsetx,i=e[2]-this.id[2]-this.offsety;if(t<0||i<0||t>=this.sizex||i>=this.sizey)return null;var r=this.nodes[this.sizex*i+t];if(!r){var s=this.sizex*i+t,a={data:this.data,index:this.metanodesIndex+s*this.metanodeSize};r=new G(this,[this.lod,this.metatileIdx+this.offsetx+t,this.metatileIdy+this.offsety+i],a,this.divisionNode),this.nodes[s]=r,this.applyMetanodeCredits(t,i),this.applyMetatanodeBitplanes(t,i)}return r},V.prototype.scheduleLoad=function(){null==this.mapLoaderUrl&&(this.mapLoaderUrl=this.surface.getMetaUrl(this.id)),this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),null,this.tile,"metatile")},V.prototype.onLoad=function(e,t,i){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=i,this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"metadata"),this.loadState=1},V.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},V.prototype.onLoaded=function(e,t){if(!this.map.killed){if(!t)return this.map.markDirty(),void this.map.addProcessingTask(this.onLoaded.bind(this,e,!0));e=new DataView(e),this.size+=4*e.byteLength,this.data=e;var i=performance.now();this.parseMetatatile({data:e,index:0}),this.map.stats.renderBuild+=performance.now()-i,this.cacheItem=this.map.metatileCache.insert(this.kill.bind(this,!0),this.size),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},V.prototype.parseMetatatile=function(e){var t=e.data,i="";i+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,i+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,"MT"==i&&(this.version=t.getUint16(e.index,!0),e.index+=2,this.version>5||(this.lod=t.getUint8(e.index,!0),e.index+=1,this.metatileIdx=t.getUint32(e.index,!0),e.index+=4,this.metatileIdy=t.getUint32(e.index,!0),e.index+=4,this.offsetx=t.getUint16(e.index,!0),e.index+=2,this.offsety=t.getUint16(e.index,!0),e.index+=2,this.sizex=t.getUint16(e.index,!0),e.index+=2,this.sizey=t.getUint16(e.index,!0),e.index+=2,this.flagPlanes=new Array(8),this.version<2?(this.nodeSize=t.getUint8(e.index,!0),e.index+=1):(this.flags=t.getUint8(e.index,!0),e.index+=1,this.creditCount=t.getUint8(e.index,!0),e.index+=1,this.parseFlagPlanes(e)),this.parseMetatatileCredits(e),this.parseMetatatileNodes(e),this.useVersion=this.map.config.mapForceMetatileV3&&this.version<5?3:this.version))},V.prototype.parseFlagPlanes=function(e){for(var t=e.data,i=this.sizex*this.sizey+7>>3,r=0;r<6;r++)if(0!=(this.flags&1<<r)){for(var s=new Uint8Array(i),a=0;a<i;a++)s[a]=t.getUint8(e.index,!0),e.index+=1;this.flagPlanes[r]=s}},V.prototype.parseMetatatileCredits=function(e){var t=e.data;if(this.version<2&&(this.creditCount=t.getUint8(e.index,!0),e.index+=1,this.creditSize=t.getUint16(e.index,!0),e.index+=2),0!=this.creditCount){var i=this.sizex*this.sizey+7>>3;this.credits=new Array(this.creditCount);for(var r=0,s=this.credits.length;r<s;r++){var a=t.getUint16(e.index,!0);e.index+=2;for(var n=new Uint8Array(i),o=0;o<i;o++)n[o]=t.getUint8(e.index,!0),e.index+=1;var h=this.map.getCreditByNumber(a),l=h?h.key:null;this.credits[r]={creditId:l,creditMask:n}}}else this.credits=[]},V.prototype.applyMetatatileBitplanes=function(){for(var e=0;e<1;e++)if(this.flagPlanes[e])for(var t=this.flagPlanes[e],i=0;i<this.sizey;i++)for(var r=0;r<this.sizex;r++){var s=this.sizex*i+r,a=1<<(7&s);if(t[s>>=3]&a)switch(e){case 0:this.nodes[i*this.sizex+r].alien=!0}}},V.prototype.applyMetatanodeBitplanes=function(e,t){for(var i=0;i<1;i++)if(this.flagPlanes[i]){var r=this.flagPlanes[i],s=this.sizex*t+e,a=1<<(7&s);if(r[s>>=3]&a)switch(i){case 0:this.nodes[t*this.sizex+e].alien=!0}}},V.prototype.applyMetatatileCredits=function(){for(var e=0;e<this.sizey;e++)for(var t=0;t<this.sizex;t++){var i=this.sizex*e+t,r=1<<(7&i);i>>=3;for(var s=0,a=this.credits.length;s<a;s++)if(this.credits[s].creditMask[i]&r){var n=this.credits[s].creditId;n&&this.nodes[e*this.sizex+t].credits.push(n)}}},V.prototype.applyMetanodeCredits=function(e,t){var i=this.sizex*t+e,r=1<<(7&i);i>>=3;for(var s=0,a=this.credits.length;s<a;s++)if(this.credits[s].creditMask[i]&r){var n=this.credits[s].creditId;n&&this.nodes[t*this.sizex+e].credits.push(n)}},V.prototype.parseMetatatileNodes=function(e){this.metanodesIndex=e.index,this.metanodeSize=10,this.version>=5?this.metanodeSize+=28:(this.metanodeSize+=Math.floor((6*(this.id[0]+2)+7)/8),4==this.version&&(this.metanodeSize+=12)),this.version>=3&&(128&this.flags?this.metanodeSize+=2:64&this.flags&&(this.metanodeSize+=1)),this.lod>=this.map.measure.minDivisionNodeDepth?(this.divisionNode=this.map.measure.getSpatialDivisionNodeAndExtents([this.lod,this.metatileIdx+this.offsetx,this.metatileIdy+this.offsety]),this.divisionNode&&(this.divisionNode=this.divisionNode[0])):this.divisionNode=null,this.nodes=new Array(this.sizex*this.sizey)};var j=V,H=function(e,t,i,r,s,a,n){this.gpu=e,this.gl=e.gl,this.bbox=t.bbox,this.fileSize=i,this.core=r,this.vertexBuffer=null,this.uvBuffer=null,this.uv2Buffer=null,this.use16bit=!!a,this.verticesUnnormalized=!!n,this.size=0;var o=t.vertices,h=t.uvs,l=t.uvs2,u=t.indices,c=t.vertexSize||3,d=t.uvSize||2,p=t.uv2Size||2,f=this.gl;if(o&&f){this.vertexBuffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.vertexBuffer),f.bufferData(f.ARRAY_BUFFER,s?o:new Float32Array(o),f.STATIC_DRAW),this.vertexBuffer.itemSize=c,this.vertexBuffer.numItems=o.length/c,null!=h&&(this.uvBuffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.uvBuffer),f.bufferData(f.ARRAY_BUFFER,s?h:new Float32Array(h),f.STATIC_DRAW),this.uvBuffer.itemSize=d,this.uvBuffer.numItems=h.length/d),null!=l&&(this.uv2Buffer=f.createBuffer(),f.bindBuffer(f.ARRAY_BUFFER,this.uv2Buffer),f.bufferData(f.ARRAY_BUFFER,s?l:new Float32Array(l),f.STATIC_DRAW),this.uv2Buffer.itemSize=p,this.uv2Buffer.numItems=l.length/p),null!=u&&(this.indexBuffer=f.createBuffer(),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,this.indexBuffer),f.bufferData(f.ELEMENT_ARRAY_BUFFER,s?u:new Uint16Array(u),f.STATIC_DRAW),this.indexBuffer.itemSize=1,this.indexBuffer.numItems=u.length);var g=this.use16bit?2:4;this.size=this.vertexBuffer.numItems*c*g,this.size+=h?this.uvBuffer.numItems*d*g:0,this.size+=l?this.uv2Buffer.numItems*p*g:0,this.size+=u?2*u.length:0,this.polygons=u?u.length/3:this.vertexBuffer.numItems/3,this.valid=!0}};H.prototype.kill=function(){this.gl&&this.valid&&(this.vertexBuffer&&this.gl.deleteBuffer(this.vertexBuffer),this.uvBuffer&&this.gl.deleteBuffer(this.uvBuffer),this.uv2Buffer&&this.gl.deleteBuffer(this.uv2Buffer),this.indexBuffer&&this.gl.deleteBuffer(this.indexBuffer),this.vertexBuffer=null,this.uvBuffer=null,this.uv2Buffer=null,this.indexBuffer=null)},H.prototype.draw=function(e,t,i,r,s,a){var n=this.gl;if(null!=n&&this.valid){if(this.use16bit){var o=e.getAttribute(t);if(n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.vertexAttribPointer(o,this.vertexBuffer.itemSize,n.UNSIGNED_SHORT,!this.verticesUnnormalized,0,0),this.uvBuffer&&i){var h=e.getAttribute(i);n.bindBuffer(n.ARRAY_BUFFER,this.uvBuffer),n.vertexAttribPointer(h,this.uvBuffer.itemSize,n.UNSIGNED_SHORT,!0,0,0)}if(this.uv2Buffer&&r){var l=e.getAttribute(r);n.bindBuffer(n.ARRAY_BUFFER,this.uv2Buffer),n.vertexAttribPointer(l,this.uv2Buffer.itemSize,n.UNSIGNED_SHORT,!0,0,0)}}else{o=e.getAttribute(t);if(n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.vertexAttribPointer(o,this.vertexBuffer.itemSize,n.FLOAT,!1,0,0),this.uvBuffer&&i){h=e.getAttribute(i);n.bindBuffer(n.ARRAY_BUFFER,this.uvBuffer),n.vertexAttribPointer(h,this.uvBuffer.itemSize,n.FLOAT,!1,0,0)}if(this.uv2Buffer&&r){l=e.getAttribute(r);n.bindBuffer(n.ARRAY_BUFFER,this.uv2Buffer),n.vertexAttribPointer(l,this.uv2Buffer.itemSize,n.FLOAT,!1,0,0)}}if(s&&s){var u=e.getAttribute(s);-1!=u&&(n.bindBuffer(n.ARRAY_BUFFER,this.gpu.barycentricBuffer),n.vertexAttribPointer(u,this.gpu.barycentricBuffer.itemSize,n.FLOAT,!1,0,0))}this.indexBuffer?(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer),a||n.drawElements(n.TRIANGLES,this.indexBuffer.numItems,n.UNSIGNED_SHORT,0)):a||n.drawArrays(n.TRIANGLES,0,this.vertexBuffer.numItems)}},H.prototype.getSize=function(){return this.size},H.prototype.getBBox=function(){return this.bbox},H.prototype.getPolygons=function(){return this.polygons};var W=H,q=s.b,Z=p.a,Y=W,J=I,K=function(e,t){this.generateLines=!0,this.map=e.map,this.vertices=null,this.internalUVs=null,this.externalUVs=null,this.indices=null,this.mesh=e,this.statsCounter=0,this.valid=!0,this.killed=!1,this.use16bit=e.use16bit,this.texture=null,this.bbox=new J,this.size=0,this.faces=0,this.uvArea=0,this.uvAreaComputed=!1,this.flagsInternalTexcoords=1,this.flagsExternalTexcoords=2,this.flagsPerVertexUndulation=4,this.flagsTextureMode=8,t&&this.parseSubmesh(t)};K.prototype.kill=function(){this.killed=!0,this.vertices=null,this.internalUVs=null,this.externalUVs=null,this.indices=null,this.texture&&(this.texture.kill(),this.texture=null)},K.prototype.parseSubmesh=function(e){this.parseHeader(e),this.mesh.version>=3?this.parseVerticesAndFaces2(e):this.parseVerticesAndFaces(e)},K.prototype.parseHeader=function(e){var t=e.data;this.flags=t.getUint8(e.index,!0),e.index+=1,this.mesh.version>1?(this.surfaceReference=t.getUint8(e.index,!0),e.index+=1):this.surfaceReference=0,this.textureLayer=t.getUint16(e.index,!0),e.index+=2,this.textureLayer2=this.textureLayer;var i=this.bbox.min,r=this.bbox.max;i[0]=t.getFloat64(e.index,!0),e.index+=8,i[1]=t.getFloat64(e.index,!0),e.index+=8,i[2]=t.getFloat64(e.index,!0),e.index+=8,r[0]=t.getFloat64(e.index,!0),e.index+=8,r[1]=t.getFloat64(e.index,!0),e.index+=8,r[2]=t.getFloat64(e.index,!0),e.index+=8,this.bbox.updateMaxSize()},K.prototype.parseVerticesAndFaces=function(e){var t=e.data,i=e.index,r=e.uint8Data,s=t.getUint16(i,!0);i+=2,s||(this.valid=!1);var a=null,n=null,o=this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,h=this.use16bit?new Uint16Array(3*s):new Float32Array(3*s);this.flags&this.flagsExternalTexcoords&&(n=!!o||(this.use16bit?new Uint16Array(2*s):new Float32Array(2*s)));var l,u,c=this.use16bit?1:1/65535,d=0,p=0;for(l=0;l<s;l++)h[d]=(r[i]+(r[i+1]<<8))*c,h[d+1]=(r[i+2]+(r[i+3]<<8))*c,h[d+2]=(r[i+4]+(r[i+5]<<8))*c,d+=3,n?(o||(n[p]=(r[i+6]+(r[i+7]<<8))*c,n[p+1]=(65535-(r[i+8]+(r[i+9]<<8)))*c,p+=2),i+=10):i+=6;if(this.tmpVertices=h,this.tmpExternalUVs=n,this.flags&this.flagsInternalTexcoords){var f=t.getUint16(i,!0);for(i+=2,a=this.use16bit?new Uint16Array(2*f):new Float32Array(2*f),l=0,u=2*f;l<u;l+=2)a[l]=(r[i]+(r[i+1]<<8))*c,a[l+1]=(65535-(r[i+2]+(r[i+3]<<8)))*c,i+=4;this.tmpInternalUVs=a}var g=t.getUint16(i,!0);i+=2;var m=null;a=null,n=null;var v=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&!(this.flags&this.flagsInternalTexcoords),y=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,b=v||y;b?m=new Uint16Array(3*g):(h=this.use16bit?new Uint16Array(3*g*3):new Float32Array(3*g*3),this.flags&this.flagsInternalTexcoords&&(a=this.use16bit?new Uint16Array(3*g*2):new Float32Array(3*g*2)),!o&&this.flags&this.flagsExternalTexcoords&&(n=this.use16bit?new Uint16Array(3*g*2):new Float32Array(3*g*2)));var x,w,M,S,A,C,T,P=this.tmpVertices,F=this.tmpExternalUVs,L=this.tmpInternalUVs;for(v&&(h=this.tmpVertices,n=this.tmpExternalUVs),y&&(h=this.use16bit?new Uint16Array(L.length/2*3):new Float32Array(L.length/2*3),a=this.tmpInternalUVs),l=0;l<g;l++)x=r[i]+(r[i+1]<<8),w=r[i+2]+(r[i+3]<<8),M=r[i+4]+(r[i+5]<<8),b?(d=3*l,null!=a?(S=r[i+6]+(r[i+7]<<8),A=r[i+8]+(r[i+9]<<8),C=r[i+10]+(r[i+11]<<8),h[3*S]=P[3*x],h[3*S+1]=P[3*x+1],h[3*S+2]=P[3*x+2],h[3*A]=P[3*w],h[3*A+1]=P[3*w+1],h[3*A+2]=P[3*w+2],h[3*C]=P[3*M],h[3*C+1]=P[3*M+1],h[3*C+2]=P[3*M+2],m[d]=S,m[d+1]=A,m[d+2]=C,i+=12):(m[d]=x,m[d+1]=w,m[d+2]=M,i+=6)):(T=3*x,h[d=9*l]=P[T],h[d+1]=P[T+1],h[d+2]=P[T+2],T=3*w,h[d+3]=P[T],h[d+4]=P[T+1],h[d+5]=P[T+2],T=3*M,h[d+6]=P[T],h[d+7]=P[T+1],h[d+8]=P[T+2],null!=n&&(n[d=6*l]=F[2*x],n[d+1]=F[2*x+1],n[d+2]=F[2*w],n[d+3]=F[2*w+1],n[d+4]=F[2*M],n[d+5]=F[2*M+1]),null!=a?(x=r[i+6]+(r[i+7]<<8),w=r[i+8]+(r[i+9]<<8),M=r[i+10]+(r[i+11]<<8),i+=12,a[d=6*l]=L[2*x],a[d+1]=L[2*x+1],a[d+2]=L[2*w],a[d+3]=L[2*w+1],a[d+4]=L[2*M],a[d+5]=L[2*M+1]):i+=6);this.vertices=h,this.internalUVs=a,this.externalUVs=n,this.indices=m,this.tmpVertices=null,this.tmpInternalUVs=null,this.tmpExternalUVs=null,e.index=i,this.size=this.vertices.byteLength,this.internalUVs&&(this.size+=this.internalUVs.byteLength),this.externalUVs&&(this.size+=this.externalUVs.byteLength),this.indices&&(this.size+=this.indices.byteLength),this.faces=g},K.prototype.parseWord=function(e,t){var i=e[t[1]];128&i?(t[0]=127&i|e[t[1]+1]<<7,t[1]+=2):(t[0]=i,t[1]++)},K.prototype.parseDelta=function(e,t){var i=e[t[1]];128&i?1&(i=127&i|e[t[1]+1]<<7)?(t[0]=-(1+(i>>1)),t[1]+=2):(t[0]=i>>1,t[1]+=2):1&i?(t[0]=-(1+(i>>1)),t[1]++):(t[0]=i>>1,t[1]++)},K.prototype.parseVerticesAndFaces2=function(e){var t=e.data,i=e.index,r=e.uint8Data,s=this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,a=t.getUint16(i,!0);i+=2;var n=t.getUint16(i,!0);i+=2,a||(this.valid=!1);var o,h,l,u,c=this.bbox.center(),d=this.bbox.maxSize,p=1/n,f=null,g=this.use16bit?new Uint16Array(3*a):new Float32Array(3*a),m=0,v=0,y=0,b=c[0],x=c[1],w=c[2],M=this.bbox.min[0],S=this.bbox.min[1],A=this.bbox.min[2],C=1/(this.bbox.max[0]-this.bbox.min[0]),T=1/(this.bbox.max[1]-this.bbox.min[1]),P=1/(this.bbox.max[2]-this.bbox.min[2]),F=[0,i];if(this.use16bit)for(h=0;h<a;h++)this.parseDelta(r,F),m+=F[0],this.parseDelta(r,F),v+=F[0],this.parseDelta(r,F),y+=F[0],(u=(m*p*d+b-M)*C)<0&&(u=0),u>1&&(u=1),g[o=3*h]=65535*u,(u=(v*p*d+x-S)*T)<0&&(u=0),u>1&&(u=1),g[o+1]=65535*u,(u=(y*p*d+w-A)*P)<0&&(u=0),u>1&&(u=1),g[o+2]=65535*u;else for(h=0;h<a;h++)this.parseDelta(r,F),m+=F[0],this.parseDelta(r,F),v+=F[0],this.parseDelta(r,F),y+=F[0],g[o=3*h]=(m*p*d+b-M)*C,g[o+1]=(v*p*d+x-S)*T,g[o+2]=(y*p*d+w-A)*P;if(i=F[1],this.flags&this.flagsExternalTexcoords)if(n=t.getUint16(i,!0),i+=2,F[1]=i,s)for(h=0;h<a;h++)this.parseDelta(r,F),this.parseDelta(r,F);else if(p=this.use16bit?65535/n:1/n,f=this.use16bit?new Uint16Array(2*a):new Float32Array(2*a),m=0,v=0,this.use16bit)for(h=0;h<a;h++){this.parseDelta(r,F),m+=F[0],this.parseDelta(r,F),v+=F[0],(u=m*p)<0&&(u=0),u>65535&&(u=65535),f[L=2*h]=u,(u=v*p)<0&&(u=0),u>65535&&(u=65535),f[L+1]=65535-u}else for(h=0;h<a;h++){var L;this.parseDelta(r,F),m+=F[0],this.parseDelta(r,F),v+=F[0],f[L=2*h]=m*p,f[L+1]=1-v*p}if(i=F[1],this.tmpVertices=g,this.tmpExternalUVs=f,this.flags&this.flagsInternalTexcoords){var E=t.getUint16(i,!0);i+=2;var k=t.getUint16(i,!0);i+=2;var N=t.getUint16(i,!0);i+=2;var I=this.use16bit?65536/k:1/k,B=this.use16bit?65536/N:1/N;m=0,v=0;var R=this.use16bit?new Uint16Array(2*E):new Float32Array(2*E);if(F[1]=i,this.use16bit)for(h=0,l=2*E;h<l;h+=2)this.parseDelta(r,F),m+=F[0],this.parseDelta(r,F),v+=F[0],(u=m*I)<0&&(u=0),u>65535&&(u=65535),R[h]=u,(u=v*B)<0&&(u=0),u>65535&&(u=65535),R[h+1]=65535-u;else for(h=0,l=2*E;h<l;h+=2)this.parseDelta(r,F),m+=F[0],this.parseDelta(r,F),v+=F[0],R[h]=m*I,R[h+1]=1-v*B;i=F[1],this.tmpInternalUVs=R}var z=t.getUint16(i,!0);i+=2;var U=null;R=null,f=null;var D=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&!(this.flags&this.flagsInternalTexcoords),_=this.map.config.mapIndexBuffers&&this.map.config.mapOnlyOneUVs&&this.flags&this.flagsInternalTexcoords,O=D||_;O?U=new Uint16Array(3*z):(g=this.use16bit?new Uint16Array(3*z*3):new Float32Array(3*z*3),this.flags&this.flagsInternalTexcoords&&(R=this.use16bit?new Uint16Array(3*z*2):new Float32Array(3*z*2)),!s&&this.flags&this.flagsExternalTexcoords&&(f=this.use16bit?new Uint16Array(3*z*2):new Float32Array(3*z*2)));var G,V,j,H,W,q,Z=this.tmpVertices,Y=this.tmpExternalUVs,J=this.tmpInternalUVs,K=0;for(F[1]=i,h=0;h<z;h++)if(this.parseWord(r,F),G=K-F[0],F[0]||K++,this.parseWord(r,F),V=K-F[0],F[0]||K++,this.parseWord(r,F),j=K-F[0],F[0]||K++,O)U[o=3*h]=G,U[o+1]=V,U[o+2]=j;else{var Q=3*G;g[o=9*h]=Z[Q],g[o+1]=Z[Q+1],g[o+2]=Z[Q+2],Q=3*V,g[o+3]=Z[Q],g[o+4]=Z[Q+1],g[o+5]=Z[Q+2],Q=3*j,g[o+6]=Z[Q],g[o+7]=Z[Q+1],g[o+8]=Z[Q+2],null!=f&&(f[o=6*h]=Y[2*G],f[o+1]=Y[2*G+1],f[o+2]=Y[2*V],f[o+3]=Y[2*V+1],f[o+4]=Y[2*j],f[o+5]=Y[2*j+1])}if(D&&(g=this.tmpVertices,f=this.tmpExternalUVs),_&&(g=this.use16bit?new Uint16Array(J.length/2*3):new Float32Array(J.length/2*3),R=this.tmpInternalUVs),K=0,null!=R)for(h=0;h<z;h++)this.parseWord(r,F),G=K-F[0],F[0]||K++,this.parseWord(r,F),V=K-F[0],F[0]||K++,this.parseWord(r,F),j=K-F[0],F[0]||K++,_?(H=3*U[o=3*h],W=3*U[o+1],q=3*U[o+2],g[3*G]=Z[H],g[3*G+1]=Z[H+1],g[3*G+2]=Z[H+2],g[3*V]=Z[W],g[3*V+1]=Z[W+1],g[3*V+2]=Z[W+2],g[3*j]=Z[q],g[3*j+1]=Z[q+1],g[3*j+2]=Z[q+2],U[o]=G,U[o+1]=V,U[o+2]=j):(R[o=6*h]=J[2*G],R[o+1]=J[2*G+1],R[o+2]=J[2*V],R[o+3]=J[2*V+1],R[o+4]=J[2*j],R[o+5]=J[2*j+1]);i=F[1],this.vertices=g,this.internalUVs=R,this.externalUVs=f,this.indices=U,this.tmpVertices=null,this.tmpInternalUVs=null,this.tmpExternalUVs=null,e.index=i,this.size=this.vertices.byteLength,this.internalUVs&&(this.size+=this.internalUVs.byteLength),this.externalUVs&&(this.size+=this.externalUVs.byteLength),this.indices&&(this.size+=this.indices.byteLength),this.faces=z},K.prototype.getSize=function(){return this.size},K.prototype.getFileSize=function(){return this.fileSize},K.prototype.buildGpuMesh=function(){return new Y(this.map.renderer.gpu,{bbox:this.bbox,vertices:this.vertices,uvs:this.internalUVs,uvs2:this.externalUVs,indices:this.indices},1,this.map.core,!0,this.use16bit)},K.prototype.computeUVArea=function(e){var t=this.internalUVs||this.externalUVs,i=0,r=e.width/65535,s=e.height/65535,a=function(e,i,a){var n=(t[i]-t[e])*r,o=(t[i+1]-t[e+1])*s,h=Math.sqrt(n*n+o*o);n=(t[a]-t[i])*r,o=(t[a+1]-t[i+1])*s;var l=Math.sqrt(n*n+o*o);n=(t[e]-t[a])*s,o=(t[e+1]-t[a+1])*s;var u=Math.sqrt(n*n+o*o),c=.5*(h+l+u);return Math.sqrt(Math.max(0,c*(c-h)*(c-l)*(c-u)))};if(t){var n=this.indices;if(n)for(var o=0,h=0,l=this.faces;o<l;o++,h+=3)i+=a(2*n[3*o],2*n[3*o+1],2*n[3*o+2]);else for(o=0,h=0,l=this.faces;o<l;o++,h+=3)i+=a(3*o*2,3*o*2+1,3*o*2+2)}this.uvAreaComputed=!0,this.uvArea=i},K.prototype.getWorldMatrix=function(e,t){var i=t;return i?(i[0]=this.bbox.side(0),i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=this.bbox.side(1),i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=this.bbox.side(2),i[11]=0,i[12]=this.bbox.min[0]-e[0],i[13]=this.bbox.min[1]-e[1],i[14]=this.bbox.min[2]-e[2],i[15]=1):(i=q.create(),q.multiply(Z.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),Z.scaleMatrix(this.bbox.side(0),this.bbox.side(1),this.bbox.side(2)),i)),i},K.prototype.getWorldMatrixSE=function(e,t){var i=t;return i?(i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=this.bbox.min[0]-e[0],i[13]=this.bbox.min[1]-e[1],i[14]=this.bbox.min[2]-e[2],i[15]=1):i=Z.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),i},K.prototype.drawBBox=function(e){var t=this.map.renderer;t.gpu.useProgram(t.progBBox,["aPosition"]);var i=q.create(),r=q.create();q.multiply(t.camera.getModelviewMatrix(),this.getWorldMatrix(e),r);var s=t.camera.getProjectionMatrix();q.multiply(s,r,i),t.progBBox.setMat4("uMVP",i),t.bboxMesh.draw(t.progBBox,"aPosition")};var Q=K,X=function(e,t,i,r){this.gpu=e,this.gl=e.gl,this.vertex=t,this.fragment=i,this.program=null,this.uniformLocationCache=[],this.attributeLocationCache=[],this.m=new Float32Array(16),this.ready=!1,this.createProgram(t,i),this.variants=r||[],this.programs={}};X.prototype.createShader=function(e,t){var i,r=this.gl;if(!e||!r)return null;if(i=!0!==t?r.createShader(r.FRAGMENT_SHADER):r.createShader(r.VERTEX_SHADER),r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){var s=r.getShaderInfoLog(i);return console.log("An error occurred compiling the "+(!0!==t?"fragment":"vertex")+" shaders: "+s),this.gpu.renderer.core.callListener("renderer-shader-error",{where:"compilation",info:s}),null}return i},X.prototype.createProgram=function(e,t){var i=this.gl;if(null!=i){var r=this.createShader(e,!0),s=this.createShader(t,!1);if(r&&s){var a=i.createProgram();i.attachShader(a,r),i.attachShader(a,s),i.linkProgram(a),i.getProgramParameter(a,i.LINK_STATUS)||(console.log("Unable to initialize the shader program."),this.gpu.renderer.core.callListener("renderer-shader-error",{where:"linking"})),i.useProgram(a),this.program=a,this.ready=!0}}},X.prototype.setSampler=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniform1i(r,t)}},X.prototype.isReady=function(e,t){return this.ready},X.prototype.setMat4=function(e,t,i){var r=this.gl;if(null!=r&&null!=this.program){var s=this.getUniform(e);if(null!=s)if(i){i=2*(1+i)-1;var a=this.m;a[0]=t[0],a[1]=t[1],a[2]=t[2]*i,a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6]*i,a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10]*i,a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14]*i,a[15]=t[15],r.uniformMatrix4fv(s,!1,a)}else r.uniformMatrix4fv(s,!1,t)}},X.prototype.setMat3=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniformMatrix3fv(r,!1,t)}},X.prototype.setVec2=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniform2fv(r,t)}},X.prototype.setVec3=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniform3fv(r,t)}},X.prototype.setVec4=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniform4fv(r,t)}},X.prototype.setFloat=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniform1f(r,t)}},X.prototype.setFloatArray=function(e,t){var i=this.gl;if(null!=i&&null!=this.program){var r=this.getUniform(e);null!=r&&i.uniform1fv(r,t)}},X.prototype.getAttribute=function(e){var t=this.gl;if(null!=t&&null!=this.program){var i=this.attributeLocationCache[e];return null==i&&(i=t.getAttribLocation(this.program,e),this.attributeLocationCache[e]=i),i}},X.prototype.getUniform=function(e){var t=this.gl;if(null!=t&&null!=this.program){var i=this.uniformLocationCache[e];return null==i&&(i=t.getUniformLocation(this.program,e),this.uniformLocationCache[e]=i),i}};var $=X,ee={bboxVertexShader:"attribute vec3 aPosition;\nuniform mat4 uMVP;\nvoid main(){ \ngl_Position = uMVP * vec4(aPosition, 1.0);\n}",bbox2VertexShader:"attribute vec3 aPosition;\nuniform mat4 uMVP;\nuniform float uPoints[8*3];\nvoid main(){ \nint index = int(aPosition.z) * 3; \ngl_Position = uMVP * vec4(uPoints[index], uPoints[index+1], uPoints[index+2], 1.0);\n}",bboxFragmentShader:"precision mediump float;\nvoid main() {\ngl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);\n}",text2VertexShader:"attribute vec4 aPosition;\nvoid main(){ \n}",pointsVertexShader:"attribute vec3 aPosition;\nattribute vec3 aColor;\nvarying vec3 vColor;\nuniform mat4 uMVP;\nvoid main(){ \nvColor= aColor;\ngl_Position = uMVP * vec4(aPosition, 1.0);\n}",pointsFragmentShader:"precision mediump float;\nvarying vec3 vColor;\nvoid main() {\ngl_FragColor = vec4(vColor.x, vColor.y, vColor.z, 1.0);\n}",lineVertexShader:"#ifndef dataPoints2\nuniform mat4 uMVP;\n#else\nuniform mat4 uMV, uProj;\n#endif\n#ifdef pixelLine\n#ifdef dataPoints2\nattribute vec3 aPosition;\n#else\nattribute vec4 aPosition;\nattribute vec4 aNormal;\n#endif\n#ifdef dataPoints\nuniform vec3 uScale;\nuniform vec3 uPoints[32];\n#else\nuniform vec2 uScale;\n#endif\n#ifdef dataPoints2\nvec4 getClippedPixelLinePoint(vec3 p1, vec3 p2, vec3 params) {\nvec2 pp1, pp2, n;\nvec4 wp0 = (uMV * vec4(p1.xyz, 1.0)), pp0, pp3;\nfloat near = gl_DepthRange.near + 0.1;\nif (params.y < 0.0) {\nif (wp0.z > -near) return vec4(8.0, 0.0, 0.0, 1.0);\npp0 = uProj * wp0;\nif (params.y == -1.0) return pp0;\nreturn pp0 + vec4((vec3(-sin(params.z)*uScale.x*uScale.z*pp0.w, cos(params.z)*uScale.y*uScale.z*pp0.w, 0.0)), 0.0);\n} else {\nvec3 p2 = uPoints[int(params.y)];\nvec4 wp3 = (uMV * vec4(p2.xyz, 1.0));\nif (wp0.z > -near) {\nvec3 dir = (wp3.xyz - wp0.xyz);\nfloat l = length(dir);\ndir = normalize(dir);\nfloat denominator = -dir.z;\nif (abs(denominator) < 0.0000001) return vec4(8.0, 0.0, 0.0, 1.0);\nfloat t = (near + wp0.z) / denominator;\nif (t < 0.0 || t > l) return vec4(8.0, 0.0, 0.0, 1.0);\nwp0.xyz = wp0.xyz + (dir * t);\n}\npp0 = uProj * wp0;\npp3 = uProj * wp3;\npp1 = pp0.xy / pp0.w;\npp2 = pp3.xy / pp3.w;\nn = normalize(pp2 - pp1);\nreturn pp0 + vec4((vec3(-n.y*uScale.x*params.z*uScale.z*pp0.w, n.x*uScale.y*params.z*uScale.z*pp0.w, 0.0)), 0.0);\n}\n}\n#endif\n#else\n#ifdef lineLabel2\nattribute vec2 aPosition;\nuniform vec4 uData[DSIZE];\nuniform float uFile;\nvarying vec2 vTexCoord;\n#else\n#ifdef lineLabel\nattribute vec4 aPosition;\nattribute vec4 aTexCoord;\nuniform vec4 uVec;\nuniform float uFile;\nvarying vec2 vTexCoord;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef dynamicWidth\nattribute vec4 aNormal;\nuniform vec4 uParams;\n#endif\n#endif\n#endif\n#ifdef applySE\nuniform mat4 uParamsSE;\n#endif\n#ifdef withElements\nattribute float aElement;\nvarying float vElement;\n#endif\nvoid main() {\n#ifdef withElements\nvElement = aElement;\n#endif\n#ifdef dataPoints\nvec3 p1 = uPoints[int(aPosition.x)];\n#else \n#ifndef lineLabel2\nvec3 p1 = aPosition.xyz;\n#endif\n#endif\n#ifdef pixelLine\n#ifndef dataPoints\nvec3 p2 = aNormal.xyz;\n#endif\n#endif\n#ifdef applySE\nvec3 geoPos2 = p1.xyz*vec3(uParamsSE[0][3],uParamsSE[1][0],uParamsSE[1][1]);\nvec3 geoPos = geoPos2+vec3(uParamsSE[0][0],uParamsSE[0][1],uParamsSE[0][2]);\ngeoPos.z *= uParamsSE[3][3];\nfloat ll = length(geoPos);\nvec3 v = geoPos * (1.0/(ll+0.0001));\nfloat h = ll - uParamsSE[3][2];\nfloat h2 = clamp(h, uParamsSE[2][1], uParamsSE[2][3]);\nfloat h3 = h;\nh *= (uParamsSE[2][2] + ((h2 - uParamsSE[2][1]) * uParamsSE[3][0]) * uParamsSE[3][1]);\ngeoPos2.xyz += v * (h - h3);\n#ifdef pixelLine\nvec4 pp0 = uMVP * vec4(geoPos2, 1.0);\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uScale.x*pp0.w, aNormal.y*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\ngeoPos2 = p2.xyz*vec3(uParamsSE[0][3],uParamsSE[1][0],uParamsSE[1][1]);\ngeoPos = geoPos2+vec3(uParamsSE[0][0],uParamsSE[0][1],uParamsSE[0][2]);\ngeoPos.z *= uParamsSE[3][3];\nll = length(geoPos);\nv = geoPos * (1.0/(ll+0.0001));\nh = ll - uParamsSE[3][2];\nh2 = clamp(h, uParamsSE[2][1], uParamsSE[2][3]);\nh3 = h;\nh *= (uParamsSE[2][2] + ((h2 - uParamsSE[2][1]) * uParamsSE[3][0]) * uParamsSE[3][1]);\ngeoPos2.xyz += v * (h - h3);\nvec4 pp3 = uMVP * vec4(geoPos2, 1.0);\nvec2 pp1 = pp0.xy / pp0.w;\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uScale.x*aNormal.w*pp0.w, n.x*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n#else\n#ifdef lineLabel\nvTexCoord = aTexCoord.xy;\nif (dot(uVec.xyz, vec3(aTexCoord.z, aTexCoord.w, aPosition.w)) < 0.0) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\nfloat file = floor(aTexCoord.y/4.0);\nvTexCoord.y = mod(aTexCoord.y,4.0);\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\ngl_Position = uMVP * vec4(geoPos2, 1.0);\n}\n}\n#else\ngl_Position = uMVP * vec4(geoPos2, 1.0);\n#endif\n#endif\n#else\n#ifdef pixelLine\n#ifdef dataPoints2\nvec3 p2 = uPoints[int(aPosition.y)];\ngl_Position = getClippedPixelLinePoint(p1.xyz, p2.xyz, aPosition.xyz);\n#else\nvec4 pp0 = (uMVP * vec4(p1.xyz, 1.0));\n#ifdef dataPoints\nif (aPosition.y < 0.0) {\nif (aPosition.y == -1.0) {\ngl_Position = pp0;\n} else {\ngl_Position = pp0 + vec4((vec3(-sin(aPosition.z)*uScale.x*uScale.z, cos(aPosition.z)*uScale.y*uScale.z, 0.0)), 0.0);\n}\n} else {\nvec3 p2 = uPoints[int(aPosition.y)];\nvec4 pp3 = (uMVP * vec4(p2.xyz, 1.0));\nvec2 pp1 = pp0.xy / pp0.w;\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uScale.x*aPosition.z*uScale.z, n.x*uScale.y*aPosition.z*uScale.z, 0.0)), 0.0);\n}\n#else\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uScale.x*pp0.w, aNormal.y*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\nvec4 pp3 = (uMVP * vec4(p2.xyz, 1.0));\nvec2 pp1 = pp0.xy / pp0.w;\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uScale.x*aNormal.w*pp0.w, n.x*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n#endif\n#endif\n#else\n#ifdef lineLabel2\nint index = int(aPosition.x) * 3;\nvec4 data = uData[index];\nvec4 data2 = uData[index+1];\nvec4 data3 = uData[index+2];\nvec3 pos = vec3(data[0],data[1],data[2]);\nvec4 q = vec4(data[3],data2[0],data2[1],data2[2]);\nvec2 factor = vec2(data2[3],data3[0]);\nvec2 uv = vec2(data3[1],data3[2]);\nfloat duv = data3[3];\nfloat x=q[0], y=q[1], z=q[2], w=q[3];\nfloat x2=x+x, y2=y+y, z2=z+z, xx=x*x2, yx=y*x2, yy=y*y2;\nfloat zx=z*x2, zy=z*y2, zz=z*z2, wx=w*x2, wy=w*y2, wz=w*z2;\nvec3 right = vec3(1.0-yy-zz, yx-wz, zx+wy) * factor.x;\nvec3 up = vec3(yx+wz, 1.0-xx-zz, zy-wx) * (-factor.y);\nfloat file = floor(uv.y/4.0);\nuv.y = (uv.y-file*4.0);\nint corner = int(aPosition.y);\nif (corner==1){ pos+=right; uv.x+=floor(duv)*(1.0/1024.0);  }\nif (corner==2){ pos+=right; pos+=up; uv.x+=floor(duv)*(1.0/1024.0); uv.y+=fract(duv); }\nif (corner==3){ pos+=up; uv.y+=fract(duv); }\nvTexCoord = uv;\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\ngl_Position = uMVP * vec4(pos.xyz, 1.0);\n}\n#else\n#ifdef lineLabel\nvTexCoord = aTexCoord.xy;\nif (dot(uVec.xyz, vec3(aTexCoord.z, aTexCoord.w, aPosition.w)) < 0.0) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\nfloat file = floor(aTexCoord.y/4.0);\nvTexCoord.y = mod(aTexCoord.y,4.0);\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\ngl_Position = uMVP * vec4(aPosition.xyz, 1.0);\n}\n}\n#else\n#ifdef dynamicWidth\ngl_Position = uMVP * vec4(aPosition.xyz + aNormal.xyz*(abs(aNormal.w)*uParams[3]), 1.0);\n#else\ngl_Position = uMVP * vec4(aPosition, 1.0);\n#endif\n#endif\n#endif\n#endif\n#endif\n}",lineFragmentShader:"precision mediump float;\nuniform vec4 uColor;\n#ifdef withElements\nvarying float vElement;\n#endif\nvoid main() {\n#ifdef withElements\ngl_FragColor.xyz = fract(vec3(1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vElement) + (-0.5/255.0);\ngl_FragColor.w = 1.0;\n#else\ngl_FragColor = uColor;\n#endif\n}",tlineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying vec2 vTexCoord;\nvoid main(){ \nvec4 p=vec4(aPosition.xyz, 1.0);\np.xyz+=aNormal.xyz*(abs(aNormal.w)*uParams[3]);\nif (aNormal.w < 0.0){\nvTexCoord=vec2(abs(aPosition.w)*uParams[0], (uParams[1]+uParams[2])*0.5);\n} else {\nvTexCoord=vec2(abs(aPosition.w)*uParams[0], aPosition.w < 0.0 ? uParams[1] : uParams[2]);\n}\ngl_Position = uMVP * p;\n}",etlineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nattribute float aElement;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying float vElement;\nvoid main(){ \nvec4 p=vec4(aPosition.xyz, 1.0);\np.xyz+=aNormal.xyz*(abs(aNormal.w)*uParams[3]);\nvElement = aElement;\ngl_Position = uMVP * p;\n}",tplineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying vec2 vTexCoord;\nvoid main(){ \nvec4 pp0 = (uMVP * vec4(aPosition.xyz, 1.0));\nvTexCoord=vec2(abs(aPosition.w)*uParams[0], aPosition.w < 0.0 ? uParams[1] : uParams[2]);\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uParams[3]*uScale.x*pp0.w, aNormal.y*uParams[3]*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\nvec2 pp1 = pp0.xy / pp0.w;\nvec4 pp3 = (uMVP * vec4(aNormal.xyz, 1.0));\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uParams[3]*uScale.x*aNormal.w*pp0.w, n.x*uParams[3]*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n}",etplineVertexShader:"attribute vec4 aPosition;\nattribute vec4 aNormal;\nattribute float aElement;\nuniform mat4 uMVP;\nuniform vec2 uScale;\nuniform vec4 uParams;\nvarying float vElement;\nvoid main(){ \nvec4 pp0 = (uMVP * vec4(aPosition.xyz, 1.0));\nvElement = aElement;\nif (aNormal.w == 0.0) {\ngl_Position = pp0 + vec4((vec3(aNormal.x*uParams[3]*uScale.x*pp0.w, aNormal.y*uParams[3]*uScale.y*pp0.w, 0.0)), 0.0);\n} else {\nvec2 pp1 = pp0.xy / pp0.w;\nvec4 pp3 = (uMVP * vec4(aNormal.xyz, 1.0));\nvec2 pp2 = pp3.xy / pp3.w;\nvec2 n = normalize(pp2 - pp1);\ngl_Position = pp0 + vec4((vec3(-n.y*uParams[3]*uScale.x*aNormal.w*pp0.w, n.x*uParams[3]*uScale.y*aNormal.w*pp0.w, 0.0)), 0.0);\n}\n}",tlineFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform vec4 uColor2;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 c=texture2D(uSampler, vTexCoord)*uColor;\ngl_FragColor = c;\n}",tblineFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform vec4 uColor2;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 c1=texture2D(uSampler, vTexCoord)*uColor;\nvec4 c2=uColor2,c=c1;\nc.xyz*=c.w; c2.xyz*=c2.w;\nc=mix(c,c2,1.0-c.w);\nc.xyz/=(c.w+0.00001);\nc.w=max(c1.w,c2.w);\ngl_FragColor = c;\n}",polygonVertexShader:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uMVP;\nuniform mat4 uRot;\nuniform vec4 uColor;\nvarying vec4 vColor;\nvoid main(){ \nfloat l = dot((uRot*vec4(aNormal,1.0)).xyz, vec3(0.0,0.0,1.0)) * 0.5;\nvec3 c = uColor.xyz;\nc = (l > 0.0) ? mix(c,vec3(1.0,1.0,1.0),l) : mix(vec3(0.0,0.0,0.0),c,1.0+l);\nvColor = vec4(c, uColor.w);\ngl_Position = uMVP * vec4(aPosition, 1.0);\n}",polygonFragmentShader:"precision mediump float;\nvarying vec4 vColor;\nvoid main() {\ngl_FragColor = vColor;\n}",iconVertexShader:"attribute vec4 aPosition;\nattribute vec4 aTexCoord;\nattribute vec3 aOrigin;\nuniform mat4 uMVP;\nuniform vec4 uScale;\nvarying vec2 vTexCoord;\nvoid main(){ \nvTexCoord = aTexCoord.xy * uScale[2];\nvec4 pos = (uMVP * vec4(aOrigin, 1.0));\ngl_Position = pos + vec4(aPosition.x*uScale.x*pos.w, (aPosition.y+uScale.w)*uScale.y*pos.w, 0.0, 0.0);\n}",icon2VertexShader:"attribute vec4 aPosition;\nattribute vec4 aTexCoord;\nattribute vec3 aOrigin;\nuniform mat4 uMVP;\nuniform vec4 uScale;\nuniform float uFile;\nvarying vec2 vTexCoord;\nvoid main(){ \nvTexCoord = aTexCoord.xy * uScale[2];\nfloat file = floor(aTexCoord.y/4.0);\nvTexCoord.y = mod(aTexCoord.y,4.0);\nif (file != floor(uFile)) {\ngl_Position = uMVP * vec4(8.0, 0.0, 0.0, 1.0);\n}else{\nvec4 pos = (uMVP * vec4(aOrigin, 1.0));\ngl_Position = pos + vec4(aPosition.x*uScale.x*pos.w, (aPosition.y+uScale.w)*uScale.y*pos.w, 0.0, 0.0);\n}}",icon3VertexShader:"attribute vec2 aPosition;\nuniform mat4 uProjectionMatrix;\nuniform vec4 uScale;\nuniform vec3 uOrigin;\nuniform vec4 uData[DSIZE];\nuniform float uFile;\nvarying vec2 vTexCoord;\nvoid main(){ \nint index = int(aPosition.x);\nvec4 data = uData[index];\nvec4 data2 = uData[index+1];\nvec4 v;\nint corner = int(aPosition.y);\nif (corner==0) v = vec4(data.x, data.y, data2.x, data2.y);\nif (corner==1) v = vec4(data.z, data.y, data2.z, data2.y);\nif (corner==2) v = vec4(data.z, data.w, data2.z, data2.w);\nif (corner==3) v = vec4(data.x, data.w, data2.x, data2.w);\nvTexCoord = vec2(v.z, v.w);\nfloat file = floor(v.w/4.0);\nvTexCoord.y = (v.w-file*4.0);\nif (file != floor(uFile)) {\ngl_Position = uProjectionMatrix * vec4(2.0, 0.0, 0.0, 2.0);\n}else{\nvec4 pos = (uProjectionMatrix * vec4(uOrigin.xyz, 1.0));\ngl_Position = pos + vec4(v.x*uScale.x*pos.w, v.y*uScale.y*pos.w, 0.0, 0.0);\n}}",textFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nvarying vec2 vTexCoord;\nvoid main() {\nvec4 c=texture2D(uSampler, vTexCoord);\nif(c.w < 0.01){ discard; }\ngl_FragColor = c*uColor;\n}",text2FragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform vec2 uParams;\nvarying vec2 vTexCoord;\nfloat round(float x) { return floor(x + 0.5); }\nvoid main() {\nvec2 uv=(vTexCoord);\nuv.y=fract(uv.y);\nvec4 c=texture2D(uSampler, uv);\nfloat r = 0.0;\nint i=int(floor(vTexCoord.y));\nif (i == 0) r=c.x;else\nif (i == 1) r=c.y;else\nif (i == 2) r=c.z;else\nif (i == 3) r=c.w;\nfloat u_buffer = uParams[0];\nfloat u_gamma = uParams[1];\nfloat alpha = uColor.a * smoothstep(u_buffer - u_gamma, u_buffer + u_gamma, r);\nif(alpha < 0.01){ discard; }\ngl_FragColor = vec4(uColor.rgb, alpha);\n}",skydomeVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMVP;\nvarying vec2 vTexCoord;\nvoid main(){ \ngl_Position = uMVP * vec4(aPosition, 1.0);\nvTexCoord = aTexCoord;\n}",skydomeFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nvarying vec2 vTexCoord;\nconst vec4 gray = vec4(0.125, 0.125, 0.125, 1.0);\nvoid main() {\nfloat fade = smoothstep(0.51, 0.55, vTexCoord.t);\ngl_FragColor = mix(texture2D(uSampler, vTexCoord), gray, fade);\n}",stardomeFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uSampler, vTexCoord);\n}",atmoVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform mat3 uNorm;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\nvoid main(){ \nvec4 camSpacePos = uMV * vec4(aPosition, 1.0);\ngl_Position = uProj * camSpacePos;\nvec4 c = uMV * vec4(aPosition, 1.0);\nvNormal = (aPosition.xyz - vec3(0.5));\nvPosition = camSpacePos;\n}",atmoFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uParams;\nuniform vec4 uParams2;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nuniform vec4 uFogColor;\nuniform vec4 uFogColor2;\nvoid main() {\nfloat l = dot(normalize(vNormal),-uParams2.xyz);\nl = (1.0-pow(abs(l),uParams.x));\nvec4 c = mix(uFogColor2, uFogColor, l);\ngl_FragColor = vec4(c.xyz, c.w*l);\n}",atmoFragmentShader2:"precision mediump float;\nuniform sampler2D uSampler;\nuniform float uNFactor;\nuniform vec2 uRadius;\nuniform vec3 uPos;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nuniform vec4 uFogColor;\nvoid main() {\nvec3 ldir = normalize(-vPosition.xyz);\nvec3 diff = uPos;\nfloat a = dot(ldir, ldir);\nfloat b = 2 * dot(ldir, diff);\nfloat c = dot(diff, diff) - (uRadius[0] * uRadius[0]);\nfloat i = 0;\nfloat discr = b * b - 4 * a * c;\nif (discr > 0.0) {}\n}\ngl_FragColor = uFogColor;\n}",atmoVertexShader3:"attribute vec3 aPosition;\nuniform mat4 uMV, uProj;\nuniform vec4 uParams;\nuniform vec4 uParams2;\nvarying vec2 vTexcoords;\nvoid main(){ \ngl_Position = uProj * (uMV * vec4(aPosition, 1.0));\nvec3 position = (aPosition.xyz - vec3(0.5)) * vec3(uParams.w * 2.0);\nvec4 camPos = uParams2;\nfloat SurfaceRadius = uParams.x;\nfloat AtmosphereRadius = uParams.y;\nfloat StretchAmt = uParams.z;\nfloat camHeight = length(camPos.xyz);\nvec3 camToPos = position - camPos.xyz;\nfloat farDist = length(camToPos);\nfloat altitude = max(0.0,camHeight - SurfaceRadius);\nfloat horizonDist = sqrt((altitude*altitude) + (2.0 * SurfaceRadius * altitude));\nfloat maxDot = horizonDist / camHeight;\naltitude = max(0.0,camHeight - AtmosphereRadius);\nhorizonDist = sqrt((altitude*altitude) + (2.0 * AtmosphereRadius * altitude));\nfloat tweakAmount = 0.1;\nfloat minDot = max(tweakAmount,horizonDist / camHeight);\nfloat minDot2 = ((camHeight - SurfaceRadius) * (1.0 / (AtmosphereRadius  - SurfaceRadius))) - (1.0 - tweakAmount);\nminDot = min(minDot, minDot2);\nfloat posDot = dot(camToPos / farDist,-camPos.xyz / camHeight) - minDot;\nfloat height = posDot * (1.0 / (maxDot - minDot));\nvTexcoords.y = height;\nheight -= min(0.0,minDot2 + ((1.0 + StretchAmt) * minDot2));\nvTexcoords.x = height;\n}",atmoFragmentShader3:"precision mediump float;\nvarying vec2 vTexcoords;\nuniform vec4 uParams3;\nuniform vec4 uFogColor;\nuniform vec4 uFogColor2;\nconst vec4 fogColor3 = vec4(0.0/255.0, 0.0/255.0, 0.0/255.0, 1.0);\nvoid main() {\nfloat l = vTexcoords.y;\nif (l > uParams3.z){ discard; } else {\nfloat l2 = clamp((l*l)*0.9+0.1, 0.0, 1.5);\nvec4 c = mix(uFogColor2, uFogColor, l2);\ngl_FragColor = vec4(c.xyz, c.w*l);\nif (l > uParams3.x){ gl_FragColor.xyz = mix(gl_FragColor.xyz, fogColor3.xyz, (l-uParams3.x)*uParams3.y); }\n}}",heightmapVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform float uFogDensity;\nuniform mat4 uGridMat;\nuniform float uGridStep1, uGridStep2;\nconst int HMSize = 5;\nconst float HMSize1 = float(HMSize-1);\nuniform float uHeight[HMSize*HMSize];\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vFogFactor;\nfloat round(float x) { return floor(x + 0.5); }\nvoid main() {\nvec3 pos = aPosition;\nfloat z = uHeight[int(round(pos.y*HMSize1)*float(HMSize) + round(pos.x*HMSize1))];\nvec4 camSpacePos = uMV * vec4(pos.xy, z, 1.0);\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvFogFactor = exp(uFogDensity * camDist);\nvec4 gridCoord = uGridMat * vec4(pos, 1.0);\nvTexCoord1 = aTexCoord;\nvTexCoord1 = gridCoord.xy * vec2(uGridStep1);\nvTexCoord2 = gridCoord.xy * vec2(uGridStep2);\n}",heightmapFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform float uGridBlend;\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vFogFactor;\nuniform vec4 uFogColor;\nvoid main() {\nvec4 gridColor = mix(texture2D(uSampler, vTexCoord1), texture2D(uSampler, vTexCoord2), uGridBlend);\ngl_FragColor = mix(uFogColor, gridColor, vFogFactor);\n}",heightmapDepthVertexShader:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform float uFogDensity;\nuniform mat4 uGridMat;\nuniform float uGridStep1, uGridStep2;\nconst int HMSize = 5;\nconst float HMSize1 = float(HMSize-1);\nuniform float uHeight[HMSize*HMSize];\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vDepth;\nfloat round(float x) { return floor(x + 0.5); }\nvoid main() {\nvec3 pos = aPosition;\nfloat z = uHeight[int(round(pos.y*HMSize1)*float(HMSize) + round(pos.x*HMSize1))];\nvec4 camSpacePos = uMV * vec4(pos.xy, z, 1.0);\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvDepth = camDist;\nvec4 gridCoord = uGridMat * vec4(pos, 1.0);\nvTexCoord1 = aTexCoord;\nvTexCoord1 = gridCoord.xy * vec2(uGridStep1);\nvTexCoord2 = gridCoord.xy * vec2(uGridStep2);\n}",heightmapDepthFragmentShader:"precision mediump float;\nuniform sampler2D uSampler;\nuniform float uGridBlend;\nvarying vec2 vTexCoord1;\nvarying vec2 vTexCoord2;\nvarying float vDepth;\nvoid main() {\ngl_FragColor = fract(vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vDepth) + (-0.5/255.0);\n}",quadPoint:"vec3 quadPoint(int i1, int i2, int i3, float t, float t2) {\nfloat p1x = uPoints[i1], p1y = uPoints[i1+1], p1z = uPoints[i1+2];\nfloat p3x = uPoints[i3], p3y = uPoints[i3+1], p3z = uPoints[i3+2];\nfloat p2x = 2.0*uPoints[i2]-p1x*0.5-p3x*0.5;\nfloat p2y = 2.0*uPoints[i2+1]-p1y*0.5-p3y*0.5;\nfloat p2z = 2.0*uPoints[i2+2]-p1z*0.5-p3z*0.5;\nreturn vec3(t2*t2*p1x+2.0*t2*t*p2x+t*t*p3x, t2*t2*p1y+2.0*t2*t*p2y+t*t*p3y, t2*t2*p1z+2.0*t2*t*p2z+t*t*p3z); }\n"};ee.planeVertexShader="attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMV, uProj;\nuniform vec4 uParams;\nuniform vec4 uParams3;\nuniform float uPoints[9*3];\n#ifndef poles\nuniform vec3 uVector;\nuniform float uHeights[9];\n#endif\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvarying float vFogFactor;\n"+ee.quadPoint+"#ifndef poles\nfloat linearHeight(float x, float y) {\nint ix = int(x);\nint iy = int(y);\nint index = (2-iy)*3+ix;\nint index2 = (2-(iy+1))*3+ix;\nfloat fx = fract(x);\nfloat fy = fract(y);\nfloat w0 = (uHeights[index] + (uHeights[index+1] - uHeights[index])*fx);\nfloat w1 = (uHeights[index2] + (uHeights[index2+1] - uHeights[index2])*fx);\nreturn (w0 + (w1 - w0)*fy);\n}\n#endif\nvoid main() {\nvec3 indices = aPosition;\nfloat t = aPosition.y * uParams[2];\nfloat tt = t;\nfloat t2 = (1.0-t);\nvec3 p1 = quadPoint(0, 3, 6, t, t2);\nvec3 p2 = quadPoint(9, 9+3, 9+6, t, t2);\nvec3 p3 = quadPoint(18, 18+3, 18+6, t, t2);\nt = aPosition.x * uParams[2];\nfloat tt2 = t;\nt2 = (1.0-t);\nfloat p2x = 2.0*p2.x-p1.x*0.5-p3.x*0.5;\nfloat p2y = 2.0*p2.y-p1.y*0.5-p3.y*0.5;\nfloat p2z = 2.0*p2.z-p1.z*0.5-p3.z*0.5;\nvec4 p = vec4(t2*t2*p1.x+2.0*t2*t*p2x+t*t*p3.x, t2*t2*p1.y+2.0*t2*t*p2y+t*t*p3.y, t2*t2*p1.z+2.0*t2*t*p2z+t*t*p3.z, 1);\n#ifndef poles\n#ifndef flat\np.xyz += uVector * linearHeight(tt*2.0, tt2*2.0);\n#endif\n#endif\nvec4 camSpacePos = uMV * p;\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\n#ifdef depth\nvFogFactor = camDist;\n#else\nvFogFactor = exp(uParams[1] * camDist);\n#endif\nvec2 uv;\nuv.x = aTexCoord.y * uParams3[2] + uParams3[0];\nuv.y = (1.0-aTexCoord.x) * uParams3[3] + uParams3[1];\nvTexCoord = uv;\nvTexCoord2 = p.xy;\n}",ee.planeFragmentShader="precision mediump float;\nuniform sampler2D uSampler;\nuniform vec4 uParams2;\n#ifdef poles\nuniform vec4 uParams4;\nvarying vec2 vTexCoord2;\n#endif\nvarying vec2 vTexCoord;\nvarying float vFogFactor;\nuniform vec4 uFogColor;\nvoid main() {\n#ifdef poles\nif (length(uParams4.xy - vTexCoord2.xy) > uParams4.z){ discard; }\n#endif\n#ifdef depth\ngl_FragColor = fract(vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vFogFactor) + (-0.5/255.0);\n#else\nvec4 c = mix(texture2D(uSampler, vTexCoord), texture2D(uSampler, vTexCoord*8.0), uParams2[2]);\ngl_FragColor = mix(uFogColor, c, vFogFactor);\n#endif\n}",ee.getHFNormal="vec3 getHFNormal(vec2 uv, float texelSize, float heightDelta) {\nvec4 h;\nh[0] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0,-1.0))).r * heightDelta;\nh[1] = texture2D(uSampler2, uv + (texelSize * vec2(-1.0, 0.0))).r * heightDelta;\nh[2] = texture2D(uSampler2, uv + (texelSize * vec2( 1.0, 0.0))).r * heightDelta;\nh[3] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0, 1.0))).r * heightDelta;\nreturn normalize(vec3(h[1] - h[2], h[3] - h[0], 2.0));}\n",ee.getHFNormal2="vec2 getHFNormal2(vec2 uv, float texelSize, float heightDelta) {\nvec4 h;\nh[0] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0,-1.0))).r * heightDelta;\nh[1] = texture2D(uSampler2, uv + (texelSize * vec2(-1.0, 0.0))).r * heightDelta;\nh[2] = texture2D(uSampler2, uv + (texelSize * vec2( 1.0, 0.0))).r * heightDelta;\nh[3] = texture2D(uSampler2, uv + (texelSize * vec2( 0.0, 1.0))).r * heightDelta;\nreturn vec2(h[1] - h[2], h[3] - h[0]);}\n",ee.planeVertex4Shader="#define newspace\nuniform sampler2D uSampler2;\nattribute vec3 aPosition;\nuniform mat4 uMV, uProj;\nuniform vec4 uParams;\nuniform vec4 uParams3;\nuniform float uPoints[9*3];\nuniform vec3 uVector;\nuniform vec3 uHeights;\nuniform vec4 uTransform;\nvarying vec2 vTexCoord;\nvarying vec2 vTexCoord2;\nvarying vec3 vBarycentric;\n#ifdef newspace\nvarying mat3 vTBN;\n#else\nvarying vec3 vNormal;\n#endif\nvarying float vFogFactor;\n"+ee.quadPoint+ee.getHFNormal+ee.getHFNormal2+"void main() {\nvec3 indices = aPosition;\nfloat t = aPosition.y * uParams[2];\nfloat tt = t;\nfloat t2 = (1.0-t);\nvec3 p1 = quadPoint(0, 3, 6, t, t2);\nvec3 p2 = quadPoint(9, 9+3, 9+6, t, t2);\nvec3 p3 = quadPoint(18, 18+3, 18+6, t, t2);\nt = aPosition.x * uParams[2];\nfloat tt2 = t;\nt2 = (1.0-t);\nfloat p2x = 2.0*p2.x-p1.x*0.5-p3.x*0.5;\nfloat p2y = 2.0*p2.y-p1.y*0.5-p3.y*0.5;\nfloat p2z = 2.0*p2.z-p1.z*0.5-p3.z*0.5;\nvec4 p = vec4(t2*t2*p1.x+2.0*t2*t*p2x+t*t*p3.x, t2*t2*p1.y+2.0*t2*t*p2y+t*t*p3.y, t2*t2*p1.z+2.0*t2*t*p2z+t*t*p3.z, 1);\nvec2 uv2 = vec2(tt, 1.0-tt2);\nuv2 = vec2(uTransform[0] * uv2[0] + uTransform[2], uTransform[1] * uv2[1] + uTransform[3]);\np.xyz += uVector * (uHeights[0] + (uHeights[1]-uHeights[0])*texture2D(uSampler2, uv2).x);\nvec4 camSpacePos = uMV * p;\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvFogFactor = exp(uParams[1] * camDist);\nvec2 uv = vec2(tt, 1.0-tt2);\nuv.x = uv.x * uParams3[0] + uParams3[2];\nuv.y = uv.y * uParams3[1] + uParams3[3];\nvTexCoord = uv;\nvBarycentric = camSpacePos.xyz;\n#ifdef newspace\nvec2 d = getHFNormal2(uv2, 1.0/(128.0), (uHeights[1]-uHeights[0]) * uHeights[2]);\nvec3 T = vec3(2.0,0.0,-d.x); vec3 B = vec3(0.0,2.0,-d.y);\nvTBN = mat3(normalize(T), normalize(B), cross(T,B));\n#else\nvec3 n = getHFNormal(uv2, 1.0/(128.0), (uHeights[1]-uHeights[0]) * uHeights[2]);\nvNormal = normalize(n);\n#endif\n}",ee.planeFragmentShader2="precision mediump float;\n#extension GL_OES_standard_derivatives : enable\n#define newspace\nuniform sampler2D uSampler;\nuniform vec4 uParams2;\nuniform mat3 uSpace;\nvarying vec2 vTexCoord;\nvarying float vFogFactor;\nvarying vec3 vBarycentric;\n#ifdef newspace\nvarying mat3 vTBN;\n#else\nvarying vec3 vNormal;\n#endif\nuniform vec4 uFogColor;\nvoid main() {\nvec3 ldir = normalize(-vBarycentric);\n#ifdef flat\nvec3 nx = dFdx(vBarycentric);\nvec3 ny = dFdy(vBarycentric);\nvec3 normal2 = normalize(cross(nx,ny));\nvec4 c2 = vec4(vec3(max(0.0,normal2.z*(204.0/255.0))+(32.0/255.0)),1.0);\n#else\n#ifdef newspace\n#ifdef nmix\nvec3 normal = vTBN * normalize((texture2D(uSampler, vTexCoord).xyz-0.5)*2.0);\n#else\nvec3 normal = vTBN * vec3(0.0,0.0,1.0);\n#endif\n#else\nvec3 normal = vNormal;\n#endif\nnormal = normalize(uSpace * normal);\nvec3 eyeDir = ldir;\nvec3 refDir = reflect(-ldir, normal);\nfloat specW = min(1.0, pow(max(dot(refDir, eyeDir), 0.0), 90.0));\nfloat diffW = min(1.0, max(dot(normal, ldir), 0.0));\nfloat lcolor = (dot(normal, ldir) + 1.0) * 0.5;\n#ifdef normals\nvec4 c2 = vec4(normal*0.5+0.5,1.0);\n#else\nvec4 c2 = vec4(vec3(dot(vec3(0.0,0.0,1.0), normal)),1.0);\n#endif\n#endif\n#ifdef grid\nvec4 c = mix(texture2D(uSampler, vTexCoord), texture2D(uSampler, vTexCoord*8.0), uParams2[2]);\nc = mix(c, c2, 0.5);\n#else\n#ifdef exmap\nvec4 c = texture2D(uSampler, vTexCoord);\n#ifdef classmap\nint i = int(c.x*255.0);\nif (i == 1 || i == 2 || i == 5 || i == 6) c = vec4(146.0, 178.0, 144.0, 255.0);\nif (i == 3 || i == 4) c = vec4(94.0, 169.0, 133.0, 255.0);\nif (i == 8 || i == 11) c = vec4(238.0, 221.0, 185.0, 255.0);\nif (i == 7) c = vec4(226.0, 192.0, 154.0, 255.0);\nif (i == 9 || i == 10 || i == 12) c = vec4(250.0, 246.0, 167.0, 255.0);\nif (i == 13 || i == 16) c = vec4(245.0, 236.0, 211.0, 255.0);\nif (i == 14) c = vec4(139.0, 185.0, 166.0, 255.0);\nif (i == 15) c = vec4(199.0, 219.0, 155.0, 255.0);\nif (i == 17) c = vec4(149.0, 132.0, 162.0, 255.0);\nif (i == 18 || i == 0) c = vec4(188.0, 221.0, 255.0, 255.0);\nif (i == 19) c = vec4(255.0, 255.0, 255.0, 255.0);\nc = (c*(1.0/255.0)) * c2;\n#endif\n#else\nvec4 c = c2;\n#endif\n#endif\n#ifdef fog\ngl_FragColor = mix(uFogColor, c, vFogFactor);\n#else\ngl_FragColor = c;\n#endif\n}",ee.tileVertexShader="attribute vec3 aPosition;\n#ifdef onlyFog\nvarying float vFogFactor;\n#else\n#ifdef externalTex\nattribute vec2 aTexCoord2;\n#else\nattribute vec2 aTexCoord;\n#endif\nvarying vec3 vTexCoord;\n#endif\n#ifdef clip4\n#ifndef externalTex\nattribute vec2 aTexCoord2;\n#endif\nvarying vec2 vClipCoord;\n#endif\n#ifdef clip8\n#ifndef externalTex\nattribute vec2 aTexCoord2;\n#endif\nvarying vec3 vClipCoord;\nuniform mat4 uParamsC8;\nfloat getLinePointParametricDist(vec3 c, vec3 v, vec3 p) {\nvec3 w = p - c;\nfloat c1 = dot(w,v);\nif (c1 <= 0.0) return 0.0;\nfloat c2 = dot(v,v);\nif (c2 <= c1) return 1.0;\nreturn c1 / c2;\n}\n#endif\n#ifdef depth\nvarying float vDepth;\n#endif\n#ifdef flatShadeVar\nvarying vec3 vBarycentric;\n#endif\nuniform mat4 uMV, uProj, uParams;\n#ifdef applySE\nuniform mat4 uParamsSE;\n#endif\nvoid main() {\n#ifdef applySE\nvec3 geoPos2 = aPosition*vec3(uParamsSE[0][3],uParamsSE[1][0],uParamsSE[1][1]);\nvec3 geoPos = geoPos2+vec3(uParamsSE[0][0],uParamsSE[0][1],uParamsSE[0][2]);\ngeoPos.z *= uParamsSE[3][3];\nfloat ll = length(geoPos);\nvec3 v = geoPos * (1.0/(ll+0.0001));\nfloat h = ll - uParamsSE[3][2];\nfloat h2 = clamp(h, uParamsSE[2][1], uParamsSE[2][3]);\nfloat h3 = h;\nh *= (uParamsSE[2][2] + ((h2 - uParamsSE[2][1]) * uParamsSE[3][0]) * uParamsSE[3][1]);\ngeoPos2.xyz += v * (h - h3);\nvec4 camSpacePos = uMV * vec4(geoPos2, 1.0);\nfloat l = dot(v, vec3(uParams[1][0],uParams[1][1],uParams[1][2]));\n#else\nvec4 camSpacePos = uMV * vec4(aPosition, 1.0);\nvec3 worldPos = vec3(aPosition.x * uParams[0][2] + uParams[3][1], aPosition.y * uParams[0][3] + uParams[3][2], aPosition.z * uParams[3][0] + uParams[3][3]);\nfloat l = dot(normalize(worldPos.xyz), vec3(uParams[1][0],uParams[1][1],uParams[1][2]));\n#endif\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\n#ifdef depth\nvDepth = camDist;\n#endif\n#ifdef flatShadeVar\nvBarycentric = camSpacePos.xyz;\n#endif\nfloat fogFactor = 1.0-exp(uParams[0][1] * camDist);\nfogFactor = clamp((1.0-abs(l))*uParams[1][3] + fogFactor, 0.0, 1.0);\n#ifdef onlyFog\nvFogFactor = fogFactor;\n#else\nvTexCoord.z = fogFactor;\n#ifdef externalTex\nvTexCoord.xy = vec2(uParams[2][0] * aTexCoord2[0] + uParams[2][2], uParams[2][1] * aTexCoord2[1] + uParams[2][3]);\n#else\nvTexCoord.xy = aTexCoord;\n#endif\n#endif\n#ifdef clip4\nvClipCoord.xy = aTexCoord2.xy;\n#endif\n#ifdef clip8\nvec3 worldPos2 = vec3(aPosition.x * uParams[0][2] + uParamsC8[0][3], aPosition.y * uParams[0][3] + uParamsC8[1][3], aPosition.z * uParams[3][0] + uParamsC8[2][3]);\nvClipCoord.x = getLinePointParametricDist(vec3(uParamsC8[0][0],uParamsC8[0][1],uParamsC8[0][2]), vec3(uParamsC8[1][0],uParamsC8[1][1],uParamsC8[1][2]), worldPos2.xyz);\nvClipCoord.y = getLinePointParametricDist(vec3(uParamsC8[0][0],uParamsC8[0][1],uParamsC8[0][2]), vec3(uParamsC8[2][0],uParamsC8[2][1],uParamsC8[2][2]), worldPos2.xyz);\nvClipCoord.z = 1.0-getLinePointParametricDist(vec3(uParamsC8[0][0],uParamsC8[0][1],uParamsC8[0][2]), vec3(uParamsC8[3][0],uParamsC8[3][1],uParamsC8[3][2]), worldPos2.xyz);\n#endif\n}",ee.tileFragmentShader="precision mediump float;\n#ifdef clip4\nuniform float uClip[4];\nvarying vec2 vClipCoord;\n#endif\n#ifdef clip8\nuniform float uClip[8];\nvarying vec3 vClipCoord;\n#endif\n#ifdef onlyFog\nvarying float vFogFactor;\n#else\nvarying vec3 vTexCoord;\nuniform sampler2D uSampler;\n#ifdef mask\nuniform sampler2D uSampler2;\n#endif\n#endif\n#ifdef depth\nvarying float vDepth;\n#endif\n#ifdef flatShadeVar\nvarying vec3 vBarycentric;\n#ifdef fogAndColor\nuniform vec4 uColor;\n#endif\n#endif\nuniform vec4 uParams2;\nvoid main() {\n#ifdef clip4_nomargin\nif (vClipCoord.y > 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[3] == 0.0) discard;\n} else {\nif (uClip[2] == 0.0) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[1] == 0.0) discard;\n} else {\nif (uClip[0] == 0.0) discard;\n}\n}\n#endif\n#ifdef clip4\nif (vClipCoord.y > 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[3] == 0.0 && !(vClipCoord.x < TMAX && uClip[2] != 0.0) && !(vClipCoord.y < TMAX && uClip[1] != 0.0)) discard;\n} else {\nif (uClip[2] == 0.0 && !(vClipCoord.x > TMIN && uClip[3] != 0.0) && !(vClipCoord.y < TMAX && uClip[0] != 0.0)) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[1] == 0.0 && !(vClipCoord.x < TMAX && uClip[0] != 0.0) && !(vClipCoord.y > TMIN && uClip[3] != 0.0)) discard;\n} else {\nif (uClip[0] == 0.0 && !(vClipCoord.x > TMIN && uClip[1] != 0.0) && !(vClipCoord.y > TMIN && uClip[2] != 0.0)) discard;\n}\n}\n#endif\n#ifdef clip8\nif (vClipCoord.z <= 0.5){\nif (vClipCoord.y <= 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[5] == 0.0) discard;\n} else {\nif (uClip[4] == 0.0) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[7] == 0.0) discard;\n} else {\nif (uClip[6] == 0.0) discard;\n}\n}\n} else {\nif (vClipCoord.y <= 0.5){\nif (vClipCoord.x > 0.5){\nif (uClip[1] == 0.0) discard;\n} else {\nif (uClip[0] == 0.0) discard;\n}\n} else {\nif (vClipCoord.x > 0.5){\nif (uClip[3] == 0.0) discard;\n} else {\nif (uClip[2] == 0.0) discard;\n}\n}\n}\n#endif\n#ifdef flatShadeVar\n#ifdef flatShadeVarFallback\nvec4 flatShadeData = vec4(1.0);\n#else\n#ifdef GL_OES_standard_derivatives\nvec3 nx = dFdx(vBarycentric);\nvec3 ny = dFdy(vBarycentric);\nvec3 normal=normalize(cross(nx,ny));\nvec4 flatShadeData = vec4(vec3(max(0.0,normal.z*(204.0/255.0))+(32.0/255.0)),1.0);\n#else\nvec4 flatShadeData = vec4(1.0);\n#endif\n#endif\n#endif\n#ifdef flatShade\n#ifdef fogAndColor\ngl_FragColor = vec4(uColor.xyz * flatShadeData.xyz, uColor.w);\n#else\ngl_FragColor = vec4(flatShadeData.xyz, 1.0);\n#endif\n#else\nvec4 fogColor = vec4(uParams2.xyz, 1.0);\n#ifdef onlyFog\ngl_FragColor = vec4(fogColor.xyz, vFogFactor);\n#else\n#ifdef depth\ngl_FragColor = fract(vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/16581375.0) * vDepth) + (-0.5/255.0);\n#else\n#ifdef externalTex\nvec4 c = texture2D(uSampler, vTexCoord.xy);\n__FILTER__vec4 cc = mix(c, fogColor, vTexCoord.z);\n#ifdef mask\nvec4 c2 = texture2D(uSampler2, vTexCoord.xy);\ncc.w = c.w * uParams2.w * c2.x;\n#else\ncc.w = c.w * uParams2.w;\n#endif\ngl_FragColor = cc;\n#else\ngl_FragColor = mix(texture2D(uSampler, vTexCoord.xy), fogColor, vTexCoord.z);\n#endif\n#endif\n#endif\n#endif\n}",ee.shadedMeshVertexShader="attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nuniform mat4 uMV, uProj;\nuniform mat3 uNorm;\nuniform float uFogDensity;\nvarying vec2 vTexCoord;\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nvarying float vFogFactor;\nvoid main() {\nvec4 camSpacePos = uMV * vec4(aPosition, 1.0);\ngl_Position = uProj * camSpacePos;\nfloat camDist = length(camSpacePos.xyz);\nvFogFactor = exp(uFogDensity * camDist);\nvTexCoord = aTexCoord;\nvPosition = camSpacePos;\nvNormal = aNormal * uNorm;\n}",ee.shadedMeshFragmentShader="precision mediump float;\n#ifdef textured\nuniform sampler2D uSampler;\nvarying vec2 vTexCoord;\n#endif\nvarying vec4 vPosition;\nvarying vec3 vNormal;\nuniform mat4 uMaterial;\nvarying float vFogFactor;\nuniform vec4 uFogColor;\nvoid main() {\nvec3 ldir = normalize(-vPosition.xyz);\nvec3 normal = normalize(vNormal);\nvec3 eyeDir = ldir;\nvec3 refDir = reflect(-ldir, normal);\nfloat specW = min(1.0, pow(max(dot(refDir, eyeDir), 0.0), uMaterial[3][0]));\nfloat diffW = min(1.0, max(dot(normal, ldir), 0.0));\nvec4 lcolor = uMaterial[0]+(uMaterial[1]*diffW)+(uMaterial[2]*specW);\n#ifdef textured\nvec4 tcolor = texture2D(uSampler, vTexCoord);\ngl_FragColor = mix(uFogColor, vec4(lcolor.xyz*(1.0/255.0), 1.0) * tcolor, vFogFactor); gl_FragColor.w *= uMaterial[3][1];\n#else\ngl_FragColor = mix(uFogColor, vec4(lcolor.xyz*(1.0/255.0), 1.0), vFogFactor);  gl_FragColor.w = uMaterial[3][1];\n#endif\n}",ee.tileWireFrameBasicShader="precision mediump float;\nuniform vec4 uColor;\nvoid main() {\ngl_FragColor = uColor;\n}",ee.imageVertexShader="\nattribute vec4 aPosition;\nuniform mat4 uProjectionMatrix;\nuniform mat4 uData;\nuniform vec4 uColor;\nuniform float uDepth;\nvarying vec4 vColor;\nvarying vec2 vTexcoords;\nvoid main(void){\nint i=int(aPosition.x);\nvec4 p;\nif(i==0) p = vec4(floor(uData[0][0]+0.1),floor(uData[0][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[0][2], uData[0][3]);\nif(i==1) p = vec4(floor(uData[1][0]+0.1),floor(uData[1][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[1][2], uData[1][3]);\nif(i==2) p = vec4(floor(uData[2][0]+0.1),floor(uData[2][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[2][2], uData[2][3]);\nif(i==3) p = vec4(floor(uData[3][0]+0.1),floor(uData[3][1]+0.1),uDepth,1.0), vTexcoords=vec2(uData[3][2], uData[3][3]);\ngl_Position=uProjectionMatrix*p;\nvec4 c=uColor;\nc.w*=1.0;\nvColor=c;\n}",ee.imageFragmentShader="precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTexcoords;\nuniform sampler2D uSampler;\nvoid main(void){\nvec4 c=texture2D(uSampler, vec2(vTexcoords.x, vTexcoords.y) );\nc*=vColor;\nif(c.w < 0.01){ discard; }\ngl_FragColor = c;\n}";var te=ee,ie=s.b,re=I,se=Q,ae=(a.a,$),ne=te,oe=function(e,t,i){this.generateLines=!0,this.map=e,this.stats=e.stats,this.mapLoaderUrl=t,this.tile=i,this.use16bit=e.config.map16bitMeshes,this.bbox=new re,this.size=0,this.gpuSize=0,this.fileSize=0,this.faces=0,this.cacheItem=null,this.gpuCacheItem=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.mBuffer=new Float32Array(16),this.mBuffer2=new Float32Array(16),this.vBuffer=new Float32Array(4),this.submeshes=[],this.gpuSubmeshes=[],this.submeshesKilled=!1};oe.prototype.kill=function(){this.bbox=null,this.killSubmeshes(),this.killGpuSubmeshes()},oe.prototype.killSubmeshes=function(e){for(var t=0,i=this.submeshes.length;t<i;t++)this.submeshes[t].kill();this.submeshesKilled=!0,!0!==e&&this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),0==this.gpuSubmeshes.length&&(this.loadState=0),this.cacheItem=null},oe.prototype.killGpuSubmeshes=function(e){for(var t=0,i=0,r=this.gpuSubmeshes.length;i<r;i++)this.gpuSubmeshes[i].kill(),t+=this.gpuSubmeshes[i].getSize();r>0&&(this.stats.gpuMeshes-=t,this.stats.graphsFluxMesh[1][0]++,this.stats.graphsFluxMesh[1][1]+=t),this.gpuSubmeshes=[],!0!==e&&this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.submeshesKilled&&(this.loadState=0),this.gpuCacheItem=null},oe.prototype.isReady=function(e,t,i){var r=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||r,2==this.loadState){if(this.cacheItem&&this.map.resourcesCache.updateItem(this.cacheItem),i)return!0;if(0==this.gpuSubmeshes.length){if(this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed)return!1;if(r)return!1;var s=performance.now();this.buildGpuSubmeshes(),this.stats.renderBuild+=performance.now()-s}return!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem),!0}return 0==this.loadState?e||this.scheduleLoad(t):3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t),!1},oe.prototype.scheduleLoad=function(e){this.mapLoaderUrl||(this.mapLoaderUrl=this.map.url.makeUrl(this.tile.resourceSurface.meshUrl,{lod:this.tile.id[0],ix:this.tile.id[1],iy:this.tile.id[2]})),this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),e,this.tile,"mesh")},oe.prototype.onLoad=function(e,t,i){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=i,this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"mesh"),this.loadState=1},oe.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},oe.prototype.onLoaded=function(e,t,i){if(!this.map.killed){if(!t)return this.map.markDirty(),void this.map.addProcessingTask(this.onLoaded.bind(this,e,!0,i));var r=performance.now();if(i)this.parseWorkerData(e);else{this.fileSize=e.byteLength;var s={data:new DataView(e),buffer:e,index:0};this.parseMapMesh(s)}this.map.stats.renderBuild+=performance.now()-r,this.submeshesKilled=!1,this.cacheItem=this.map.resourcesCache.insert(this.killSubmeshes.bind(this,!0),this.size),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},oe.prototype.parseWorkerData=function(e){this.faces=e.faces,this.gpuSize=e.gpuSize,this.meanUndulation=e.meanUndulation,this.numSubmeshes=e.numSubmeshes,this.size=e.size,this.version=e.version,this.submeshes=[];for(var t=e.submeshes,i=0,r=t.length;i<r;i++){var s=new se(this),a=t[i];s.bbox.min=a.bboxMin,s.bbox.max=a.bboxMax,s.externalUVs=a.externalUVs,s.faces=a.faces,s.flags=a.flags,s.gpuSize=a.gpuSize,s.indices=a.indices,s.internalUVs=a.internalUVs,s.size=a.size,s.surfaceReference=a.surfaceReference,s.textureLayer=a.textureLayer,s.textureLayer2=a.textureLayer2,s.vertices=a.vertices,this.submeshes.push(s)}this.bbox.updateMaxSize()},oe.prototype.parseMapMesh=function(e){this.killSubmeshes();var t=e.data,i="";if(t.length<2)return!1;if(i+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,i+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,"ME"!=i)return!1;if(this.version=t.getUint16(e.index,!0),e.index+=2,this.version>3)return!1;e.uint8Data=new Uint8Array(e.buffer),this.meanUndulation=t.getFloat64(e.index,!0),e.index+=8,this.numSubmeshes=t.getUint16(e.index,!0),e.index+=2,this.submeshes=[],this.gpuSize=0,this.faces=0;for(var r=0,s=this.numSubmeshes;r<s;r++){var a=new se(this,e);a.valid&&(this.submeshes.push(a),this.size+=a.getSize(),this.faces+=a.faces,this.gpuSize+=a.getSize())}this.numSubmeshes=this.submeshes.length},oe.prototype.addSubmesh=function(e){this.submeshes.push(e),this.size+=e.size,this.faces+=e.faces},oe.prototype.buildGpuSubmeshes=function(){var e=0;this.gpuSubmeshes=new Array(this.submeshes.length);for(var t=0,i=this.submeshes.length;t<i;t++)this.gpuSubmeshes[t]=this.submeshes[t].buildGpuMesh(),e+=this.gpuSubmeshes[t].getSize();this.stats.gpuMeshes+=e,this.stats.graphsFluxMesh[0][0]++,this.stats.graphsFluxMesh[0][1]+=e,this.gpuCacheItem=this.map.gpuCache.insert(this.killGpuSubmeshes.bind(this,!0),e),this.gpuSize=e},oe.prototype.generateTileShader=function(e,t,i,r){var s="";r&&(this.map.config.mapSplitMargin?(4==r.length?s+="#define clip4\n":s+="#define clip8\n",s+="#define TMIN "+(.5-this.map.config.mapSplitMargin)+"\n#define TMAX "+(.5+this.map.config.mapSplitMargin)+"\n"):4==r.length?s+="#define clip4_nomargin\n":s+="#define clip8\n"),i&&(s+="#define applySE\n");var a=new ae(this.map.renderer.gpu,e[0].vertex.replace("#define variants\n",s),e[0].fragment.replace("#define variants\n",s));return e[t]=a,a},oe.prototype.drawSubmesh=function(e,t,i,r,s,a,n,o,h){null!=this.gpuSubmeshes[t]||null==this.submeshes[t]||this.submeshes[t].killed||(this.gpuSubmeshes[t]=this.submeshes[t].buildGpuMesh());var l=this.submeshes[t],u=this.gpuSubmeshes[t];if(u){var c=this.map.renderer,d=this.map.draw,p=null,f=null,g=null,m=null,v=d.debug.drawWireframe,y=c.useSuperElevation,b=["aPosition"],x=y?4:0;if(o&&(x|=1,6!=r&&5!=r&&(m="aTexCoord2",b.push("aTexCoord2"))),i&&d.debug.meshStats&&(l.uvAreaComputed||l.computeUVArea(i.getGpuTexture()),this.stats.meshesUVArea+=l.uvArea,this.stats.meshesFaces+=l.faces),1==r)(p=c.progDepthTile[x])||(p=this.generateTileShader(c.progDepthTile,x,y,o));else if(2==r)(p=c.progFlatShadeTile[x])||(p=this.generateTileShader(c.progFlatShadeTile,x,y,o));else{if(v>0&&3==r)return;if(1==v||3==v)(p=c.progFlatShadeTile[x])||(p=this.generateTileShader(c.progFlatShadeTile,x,y,o));else switch(r){case 4:case 5:g="aTexCoord",b.push("aTexCoord"),(p=c.progTile[x])||(p=this.generateTileShader(c.progTile,x,y,o));break;case 6:case 7:var w,M,S=c.progTile2;if(i&&(f=i.getGpuMaskTexture())&&(S=c.progTile3),(p=S[x])||(p=this.generateTileShader(S,x,y,o)),a&&(a.shaderFilters||a.shaderFilter))if(n&&a.shaderFilters&&(w=a.shaderFilters[n.id])&&(w.varFlatShade&&(M=!0),w=w.filter),w||(w=a.shaderFilter),w){var A=f?"progTile3":"progTile2";if(y&&(A+="se"),M&&(A+="fs"),o&&(A+="c4"),A+=w,!(p=(c=this.map.renderer).progMap[A])){var C,T=c.gpu,P="";o&&(this.map.config.mapSplitMargin?(P+="#define clip4\n",P+="#define TMIN "+(.5-this.map.config.mapSplitMargin)+"\n#define TMAX "+(.5+this.map.config.mapSplitMargin)+"\n"):P+="#define clip4_nomargin\n");var F="#define externalTex\n"+P+(y?"#define applySE\n":"")+ne.tileVertexShader;C=f?"#define externalTex\n#define mask\n"+P+ne.tileFragmentShader:"#define externalTex\n"+P+ne.tileFragmentShader,M&&(F="#define flatShadeVar\n"+F,C=(C="#extension GL_OES_standard_derivatives : enable\n#define flatShadeVar\n"+C).replace("mediump","highp")),p=new ae(T,F,C.replace("__FILTER__",w)),c.progMap[A]=p}}m="aTexCoord2",b.push("aTexCoord2");break;case 3:(p=c.progFogTile[x])||(p=this.generateTileShader(c.progFogTile,x,y,o))}}if(p&&p.isReady()){if(c.gpu.useProgram(p,b,f),i){var L=i.getGpuTexture();if(!L)return;i.statsCoutner!=this.stats.counter&&(i.statsCoutner=this.stats.counter,this.stats.gpuRenderUsed+=L.getSize()),c.gpu.bindTexture(L),f&&c.gpu.bindTexture(f,1)}else if(3!=r&&1!=r&&2!=r)return;var E=this.mBuffer,k=this.mBuffer2;x=this.vBuffer;if(y){k=this.mBuffer;var N=c.superElevation;k[0]=l.bbox.min[0],k[1]=l.bbox.min[1],k[2]=l.bbox.min[2],k[3]=l.bbox.side(0),k[4]=l.bbox.side(1),k[5]=l.bbox.side(2),k[9]=N[0],k[10]=N[1],k[11]=N[2],k[12]=N[6],k[13]=N[5],k[14]=c.earthRadius,k[15]=c.earthERatio,p.setMat4("uParamsSE",k),ie.multiply(c.camera.getModelviewFMatrix(),l.getWorldMatrixSE(e,k),E)}else ie.multiply(c.camera.getModelviewFMatrix(),l.getWorldMatrix(e,k),E);var I=c.camera.getProjectionFMatrix();if(p.setMat4("uMV",E),d.zbufferOffset?p.setMat4("uProj",I,c.getZoffsetFactor(d.zbufferOffset)):p.setMat4("uProj",I),o){p.setFloatArray("uClip",o);var B=this.map.camera.position,R=h;if(h){k[0]=R[0][0]-B[0],k[1]=R[0][1]-B[1],k[2]=R[0][2]-B[2],k[4]=R[1][0]-R[0][0],k[5]=R[1][1]-R[0][1],k[6]=R[1][2]-R[0][2],k[8]=R[2][0]-R[1][0],k[9]=R[2][1]-R[1][1],k[10]=R[2][2]-R[1][2],k[12]=R[4][0]-R[0][0],k[13]=R[4][1]-R[0][1],k[14]=R[4][2]-R[0][2];var z=l.bbox.min,U=l.bbox.max;k[3]=z[0]-B[0],k[7]=z[1]-B[1],k[11]=z[2]-B[2],p.setMat4("uParamsC8",k)}}if(0==v){var D,_=this.map.camera.vector2,O=d.atmoColor;z=l.bbox.min,U=l.bbox.max;switch(r){case 4:case 3:case 5:k[0]=d.zFactor,k[1]=5==r?0:d.fogDensity,k[2]=U[0]-z[0],k[3]=U[1]-z[1],k[4]=_[0],k[5]=_[1],k[6]=_[2],k[7]=_[3],k[12]=U[2]-z[2],k[13]=z[0],k[14]=z[1],k[15]=z[2],p.setMat4("uParams",k),x[0]=O[0],x[1]=O[1],x[2]=O[2],p.setVec4("uParams2",x);break;case 6:case 7:D=i.getTransform(),k[0]=d.zFactor,k[1]=6==r?d.fogDensity:0,k[2]=U[0]-z[0],k[3]=U[1]-z[1],k[4]=_[0],k[5]=_[1],k[6]=_[2],k[7]=_[3],k[8]=D[0],k[9]=D[1],k[10]=D[2],k[11]=D[3],k[12]=U[2]-z[2],k[13]=z[0],k[14]=z[1],k[15]=z[2],p.setMat4("uParams",k),x[0]=O[0],x[1]=O[1],x[2]=O[2],x[3]=6==r?1:s,p.setVec4("uParams2",x)}}if(l.statsCoutner!=this.stats.counter&&(l.statsCoutner=this.stats.counter,this.stats.gpuRenderUsed+=u.getSize()),u.draw(p,"aPosition",g,m,0!=v?"aBarycentric":null,2==v),1==v||2==v){(p=c.progWireFrameBasic[x])||(p=this.generateTileShader(c.progWireFrameBasic,x,y,o)),c.gpu.useProgram(p,b,f),y&&p.setMat4("uParamsSE",k),p.setMat4("uMV",E),p.setVec4("uColor",[0,0,0,1]),p.setMat4("uProj",I,c.getZoffsetFactor([-.001,0,0])),o&&p.setFloatArray("uClip",o);var G=u.gl;if(u.indexBuffer)for(var V=0,j=2*u.indexBuffer.numItems;V<j;V+=3)G.drawElements(G.LINE_LOOP,3,G.UNSIGNED_SHORT,V);else for(V=0,j=2*u.vertexBuffer.numItems;V<j;V+=3)G.drawArrays(G.LINE_LOOP,V,3)}this.stats.drawnFaces+=this.faces,this.stats.drawCalls++}}};var he=oe,le=s.d,ue=function(e,t){switch(this.map=e,this.data=t,this.camera=e.camera,this.renderer=e.renderer,t.type){case"point-geometry":this.type=1,this.vertexBuffer=this.data.geometryBuffer;break;case"line-geometry":this.type=2,this.vertexBuffer=this.data.geometryBuffer,this.indicesBuffer=this.data.indicesBuffer;break;case"polygon-geometry":this.type=3,this.vertexBuffer=this.data.geometryBuffer,this.surface=this.data.surface,this.borders=this.data.borders}};ue.prototype.getType=function(){switch(this.type){case 1:return"point";case 2:return"line";case 3:return"polygon"}},ue.prototype.getElement=function(e){var t=this.vertexBuffer,i=3*e;switch(this.type){case 1:return[t[i],t[i+1],t[i+2]];case 2:return[[t[i],t[i+1],t[i+2]],[t[i+3],t[i+4],t[i+5]]];case 3:var r=this.surface,s=r[i],a=r[i+1],n=r[i+2];return[[t[s][0],t[s][1],t[s][2]],[t[a][0],t[a][1],t[a][2]],[t[n][0],t[n][1],t[n][2]]]}},ue.prototype.getElements=function(e){switch(this.type){case 1:case 3:return this.surface.length/3;case 2:e=e||0;var t=3*this.indicesBuffer[e],i=e+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[e];return Math.max(0,(i-t)/3-1)}},ue.prototype.getRelationToCanvasPoint=function(e,t,i){var r,s,a,n,o,h,l,u,c,d,p,f,g=this.vertexBuffer,m=3*e;switch(r=this.camera.position,s=this.renderer.getScreenRay(t,i),this.type){case 1:var v,y=[(v=[g[m],g[m+1],g[m+2]])[0]-o[0],v[0]-o[0]];return le.cross(s,y,[0,0,0]),{distance:h=le.length(v),point:v};case 2:var b=[g[m],g[m+1],g[m+2]],x=[g[m+3],g[m+4],g[m+5]];p=s,g=[x[0]-b[0],x[1]-b[1],x[2]-b[2]],f=[r[0]-b[0],r[1]-b[1],r[2]-b[2]],a=le.dot(p,p),n=le.dot(p,g),o=le.dot(g,g),h=le.dot(p,f),l=le.dot(g,f),(u=a*o-n*n)<1e-7?(c=0,d=n>o?h/n:l/o):(c=(n*l-o*h)/u,d=(a*l-n*h)/u);var w=[f[0]+p[0]*c-g[0]*d,f[1]+p[1]*c-g[1]*d,f[2]+p[2]*c-g[2]*d];return{closest:[b[0]+g[0]*d,b[1]+g[1]*d,b[2]+g[2]*d],"line-distance":le.length(w),distance:d,line:[b,x]}}},ue.prototype.getPathElement=function(e,t){if(2!=this.type)return null;var i=3*(this.indicesBuffer[t||0]+e),r=this.vertexBuffer;return[[r[i],r[i+1],r[i+2]],[r[i+3],r[i+4],r[i+5]]]},ue.prototype.getPathPoint=function(e,t){t=t||0;for(var i,r,s=3*this.indicesBuffer[t],a=t+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[t],n=0,o=this.vertexBuffer,h=s;h<a-3;h+=3){if(i=[o[h+3]-o[h],o[h+4]-o[h+1],o[h+5]-o[h+2]],n+(r=le.length(i))>e){var l=(e-n)/r;return[o[h]+i[0]*l,o[h+1]+i[1]*l,o[h+2]+i[2]*l]}n+=r}return[o[a-3],o[a-2],o[a-1]]},ue.prototype.getPathNED=function(e,t,i){i=i||0;for(var r,s,a,n=3*this.indicesBuffer[i],o=i+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[i],h=0,l=this.vertexBuffer,u=n;u<o-5;u+=3){if(s=[l[u+3]-l[u],l[u+4]-l[u+1],l[u+5]-l[u+2]],h+(a=le.length(s))>e){var c=(h+a)/e;r=[l[u]+d[0]*c,l[u+1]+d[1]*c,l[u+2]+d[2]*c];break}h+=a}r||(r=[l[o-3],l[o-2],l[o-1]]);var p=[0,0,0],f=[0,0,0],g=[0,0,0];le.nomalize(s,p),le.nomalize(r,g),le.cross(g,p,f),t&&le.cross(g,f,p);return{east:f,direction:p,north:g,position:r,matrix:[f[0],f[1],f[2],0,g[0],g[1],g[2],0,p[0],p[1],p[2],0,0,0,0,1]}},ue.prototype.getPathLengthToElement=function(e,t){t=t||0;for(var i,r,s=3*this.indicesBuffer[t],a=t+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[t],n=0,o=this.vertexBuffer,h=0,l=s;l<a-5;l+=3){if(i=[o[l+3]-o[l],o[l+4]-o[l+1],o[l+5]-o[l+2]],r=le.length(i),e==h)return{lengthToElement:n,elementLengh:r};h++,n+=r}return n},ue.prototype.getPathLength=function(e){e=e||0;for(var t,i=3*this.indicesBuffer[e],r=e+1>=this.indicesBuffer.length?this.vertexBuffer.length:3*this.indicesBuffer[e],s=0,a=this.vertexBuffer,n=i;n<r-5;n+=3)t=[a[n+3]-a[n],a[n+4]-a[n+1],a[n+5]-a[n+2]],s+=le.length(t);return s},ue.prototype.getPathsCount=function(){return 2!=this.type?0:this.indicesBuffer.length},ue.prototype.getSurfaceArea=function(){if(3!=this.type)return 0;if(!this.surfaceArea){var e,t,i,r,s,a,n,o,h,l,u,c=this.vertexBuffer,d=this.surface;this.surfaceArea=0;for(var p=0,f=d.length;p<f;p+=3)e=c[d[p]],t=c[d[p+1]],i=c[d[p+2]],n=t[0]-e[0],o=t[1]-e[1],h=t[2]-e[2],r=Math.sqrt(n*n+o*o+h*h),n=t[0]-i[0],o=t[1]-i[1],h=t[2]-i[2],s=Math.sqrt(n*n+o*o+h*h),n=i[0]-e[0],o=i[1]-e[1],h=i[2]-e[2],l=(r+s+(a=Math.sqrt(n*n+o*o+h*h)))/2,u=Math.sqrt(l*((l-r)*(l-s)*(l-a))),this.surfaceArea+=u}return this.surfaceArea};var ce=ue,de=function(e,t,i,r){this.builder=e,this.map=e.map,this.heightMode=t||"float",this.srs=i,r=r||{},this.groupIdPrefix=r.groupIdPrefix||"",this.dontCreateGroups=r.dontCreateGroups,this.tesselation=r.tesselation};de.prototype.processGeometry=function(e,t){var i=e.coordinates;if(i)switch(e.type){case"Point":this.builder.addPoint(i,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"MultiPoint":this.builder.addPointArray(i,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"LineString":this.builder.addLineString(i,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"MultiLineString":this.builder.addLineStringArray(i,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs);break;case"Polygon":i.length>0&&this.builder.addPolygon(i[0],i.length>1?i.slice(1):[],null,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs,this.tesselation);break;case"MultiPolygon":for(var r=0,s=i.length;r<s;r++){var a=i[r];a.length>0&&this.builder.addPolygon(a[0],a.length>1?a.slice(1):[],null,this.heightMode,t.properties,t.properties?t.properties.id:null,this.srs,this.tesselation)}break;case"GeometryCollection":var n=e.gemetries;if(n)for(r=0,s=n.length;r<s;r++)this.processGeometry(n[r],t)}},de.prototype.processFeature=function(e){var t=e.geometry;t&&this.processGeometry(t,e)},de.prototype.processCollection=function(e){var t=e.features;if(t)for(var i=0,r=t.length;i<r;i++)this.processFeature(t[i])},de.prototype.processJSON=function(e){if(e)if(e.type)switch(e.type){case"FeatureCollection":this.dontCreateGroups||this.builder.addGroup(""!=this.groupIdPrefix?this.groupIdPrefix:null),this.processCollection(e);break;case"Feature":this.dontCreateGroups||this.builder.addGroup(""!=this.groupIdPrefix?this.groupIdPrefix:null),this.processFeature(e)}else for(var t in e){var i=e[t];switch(this.dontCreateGroups||this.builder.addGroup(this.groupIdPrefix+t),e.type){case"FeatureCollection":this.processCollection(i);break;case"Feature":this.processFeature(i)}}};var pe=de,fe=function(e,t,i){this.builder=e,this.map=e.map,this.groupIdPrefix=t||"",this.dontCreateGroups=i};fe.prototype.processJSON=function(e){if(e){var t,i,r,s,a,n,o,h,l,u=e.groups,c=this.builder;if(u)for(t=0,i=u.length;t<i;t++){var d=u[t],p=d.bbox,f=d.resolution;if(p&&f){var g=p[0],m=p[1];if(g&&m){this.dontCreateGroups||c.addGroup(this.groupIdPrefix+(d.id||""));var v=(m[0]-g[0])/f,y=(m[1]-g[1])/f,b=(m[2]-g[2])/f,x=d.points;if(x)for(l=x.points,r=0,s=x.length;r<s;r++){var w=x[r],M=w.points,S=new Array(M.length);for(a=0,n=M.length;a<n;a++)o=M[a],S[a]=[g[0]+o[0]*v,g[1]+o[1]*y,g[2]+o[2]*b];c.addPointArray(S,"fix",w.properties,w.id,null,!0)}var A=d.lines;if(A)for(r=0,s=A.length;r<s;r++){var C=A[r],T=C.lines,P=new Array(T.length);for(a=0,n=T.length;a<n;a++){l=T[a],h=new Array(l.length);for(var F=0,L=l.length;F<L;F++)o=l[F],h[F]=[g[0]+o[0]*v,g[1]+o[1]*y,g[2]+o[2]*b];P[a]=h}c.addLineStringArray(P,"fix",C.properties,C.id,null,!0)}var E=d.polygons;if(E){var k={sx:v,sy:y,sz:b,px:g[0],py:g[1],pz:g[2]};for(r=0,s=E.length;r<s;r++){var N=E[r];c.addPolygonRAW(N.vertices,N.surface,N.borders,N.middle,"fix",N.properties,N.id,null,!0,k)}}}}}}};var ge=ce,me=pe,ve=fe,ye=s.d,be=(s.b,function(e){this.map=e,this.groups=[],this.nodes=[],this.currentGroup=null,this.bboxMin=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],this.bboxMax=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],this.navSrs=this.map.getNavigationSrs(),this.physSrs=this.map.getPhysicalSrs(),this.heightsToProcess=0,this.heightsProcessBuffer=null,this.heightsProcessBufferFirst=null,this.heightsProcessBufferLast=null,this.heightsLod=8,this.heightsSource="heightmap-by-precision",this.updateCallback=null,this.processingHeights=!1,this.processHeightsCalls=[]});be.prototype.addToHeightsBuffer=function(e){var t={coords:e,prev:null,next:this.heightsProcessBufferFirst};null!=this.heightsProcessBufferFirst&&(this.heightsProcessBufferFirst.prev=t),this.heightsProcessBufferFirst=t,null==this.heightsProcessBufferLast&&(this.heightsProcessBufferLast=t)},be.prototype.removeFromHeightsBuffer=function(e){var t=!1;e==this.heightsProcessBufferFirst&&(this.heightsProcessBufferFirst=e.next,t=!0,null!=this.heightsProcessBufferFirst&&(this.heightsProcessBufferFirst.prev=null)),e==this.heightsProcessBufferLast&&(this.heightsProcessBufferLast=e.prev,t=!0,null!=this.heightsProcessBufferLast&&(this.heightsProcessBufferLast.next=null)),t||(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev))},be.prototype.addGroup=function(e){return this.groups.push({points:[],lines:[],polygons:[],id:e}),this.currentGroup=this.groups[this.groups.length-1],this},be.prototype.addNode=function(e,t,i,r){var s={meshes:[],precision:i,volume:t,tileset:!!r,nodes:[]};return e||(e=this),e.nodes.push(s),s},be.prototype.addMesh=function(e,t){e&&e.meshes.push(t)},be.prototype.addLoadNode=function(e,t){e&&(e.loadNodes||(e.loadNodes=[]),e.loadNodes.push(t))},be.prototype.addPoint=function(e,t,i,r,s,a){this.currentGroup||this.addGroup("some-group");var n,o={id:r,properties:i};return!t||"float"==t?(n=[e[0],e[1],e[2]||0,o,null,null],this.addToHeightsBuffer(n),o.points=[n],o.floatHeights=!0,o.srs=s||this.navSrs,o.heightsToProcess=1,this.heightsToProcess++):o.points=a?[[e[0],e[1],e[2]]]:[this.physSrs.convertCoordsFrom(e,s||this.navSrs)],this.currentGroup.points.push(o),this},be.prototype.addPointArray=function(e,t,i,r,s,a){this.currentGroup||this.addGroup("some-group");var n,o,h,l,u=!t||"float"==t;s=s||this.navSrs;var c={id:r,properties:i},d=new Array(e.length);if(u){for(n=0,o=e.length;n<o;n++)l=[(h=e[n])[0],h[1],h[2]||0,c,null,null],this.addToHeightsBuffer(l),d[n]=l;c.floatHeights=!0,c.srs=s,c.heightsToProcess=o,this.heightsToProcess++}else if(a)for(n=0,o=e.length;n<o;n++)h=e[n],d[n]=[h[0],h[1],h[2]];else for(n=0,o=e.length;n<o;n++)d[n]=this.physSrs.convertCoordsFrom(e[n],s);return c.points=d,this.currentGroup.points.push(c),this},be.prototype.addLineString=function(e,t,i,r,s,a){this.currentGroup||this.addGroup("some-group");var n,o,h,l,u=!t||"float"==t;s=s||this.navSrs;var c={id:r,properties:i},d=new Array(e.length);if(u){for(n=0,o=e.length;n<o;n++)l=[(h=e[n])[0],h[1],h[2]||0,c,null,null],this.addToHeightsBuffer(l),d[n]=l;c.floatHeights=!0,c.srs=s,c.heightsToProcess=o,this.heightsToProcess+=o}else if(a)for(n=0,o=e.length;n<o;n++)h=e[n],d[n]=[h[0],h[1],h[2]];else for(n=0,o=e.length;n<o;n++)d[n]=this.physSrs.convertCoordsFrom(e[n],s);return c.lines=[d],this.currentGroup.lines.push(c),this},be.prototype.addLineStringArray=function(e,t,i,r,s,a){this.currentGroup||this.addGroup("some-group");var n,o,h,l,u,c,d,p,f=!t||"float"==t;s=s||this.navSrs;var g={id:r,properties:i},m=new Array(e.length);if(f){var v=0;for(h=0,l=e.length;h<l;h++){for(n=e[h],o=new Array(n.length),u=0,c=n.length;u<c;u++)p=[(d=n[u])[0],d[1],d[2]||0,g,null,null],this.addToHeightsBuffer(p),o[u]=p;v+=c,m[h]=o}g.floatHeights=!0,g.srs=s,g.heightsToProcess=v,this.heightsToProcess+=v}else for(h=0,l=e.length;h<l;h++){if(n=e[h],o=new Array(n.length),a)for(u=0,c=n.length;u<c;u++)d=n[u],o[u]=[d[0],d[1],d[2]];else for(u=0,c=n.length;u<c;u++)o[u]=this.physSrs.convertCoordsFrom(n[u],s);m[h]=o}return g.lines=m,this.currentGroup.lines.push(g),this},be.prototype.addPolygon=function(e,t,i,r,s,a,n,o){return this.addPolygon3(e,t,i,r,s,a,n,o)},be.prototype.getPolygonCenter=function(e,t,i){if(e&&!e.length)return[0,0];var r=0,s=0,a=0;if(t){for(var n=0,o=e.length;n<o;n++){r+=(h=e[n])[0],s+=h[1],a+=h[2]}return[r/o,s/o,a/o]}for(n=0,o=e.length;n<o;n++){var h=e[n],l=i.forward(h);r+=l[0],s+=l[1],a+=l[2]}var u=r/o,c=s/o,d=a/o;return[(h=i.inverse([u,c,d]))[0],h[1],0]},be.prototype.insidePolygon=function(e,t,i){for(var r=e[0],s=e[1],a=!1,n=0,o=(i=i||Math.round(t.length/3))-1,h=i;n<h;o=n++){var l=t[3*n],u=t[3*n+1],c=t[3*o],d=t[3*o+1];u>s!=d>s&&r<(c-l)*(s-u)/(d-u)+l&&(a=!a)}return a},be.prototype.addPolygon3=function(e,t,i,r,s,a,n,o){n=n||this.navSrs.srsProj4;var h,l,u,c,d,p,f,g,m,v,y,b,x,w,M,S=e,A=(t=t||[],[]),C=[],T=!0,P=0,F=t.length;(o=o||{}).mode=o.mode||"auto","by-length"==o.mode&&(o.length=o.length||2e5);-1!=n.indexOf("+proj=longlat")&&(T=!1,m=this.map.proj4(n,"+proj=geocent +datum=WGS84 +units=m +no_defs"));var L=3*e.length;for(h=0,l=e.length;h<l;h++)e[h][2]=e[h][2]||0;for(h=0,l=t.length;h<l;h++)for(L+=3*(g=t[h]).length,u=0,c=g.length;u<c;u++)g[u][2]=g[u][2]||0;var E,k,N,I=this.getPolygonCenter(e,T,m),B=this.map.measure.getNewNED(I);N=B.direction,E=B.direction,k=B.east,S=new Array(L),y=new Array(L),u=0;var R,z=new Array(t.length+1),U=new Array(e.length);for(z[0]=U,R=m?m.forward(I):I,h=0,l=e.length;h<l;h++)U[h]=h,A=e[h],y[u]=A[0],y[u+1]=A[1],y[u+2]=A[2],m?(C=m.forward(e[h]),A=[k[0]*C[0]+k[1]*C[1]+k[2]*C[2],E[0]*C[0]+E[1]*C[1]+E[2]*C[2],0]):A=C=e[h],(M=(b=C[0]-R[0])*b+(x=C[1]-R[1])*x+(w=C[2]-R[2])*w)>P&&(P=M,e[h]),S[u]=A[0],S[u+1]=A[1],S[u+2]=A[2],u+=3;var D,_,O,G,V,j=0;for(h=0,l=3*e.length;h<l;h+=3)D=S[h],_=S[h+1],h<l-3?(O=S[h+3],G=S[h+4]):(O=S[0],G=S[1]),j+=D*G,j-=O*_;if(j<0){var H=y.slice(),W=S.slice();for(h=0,l=3*e.length;h<l;h+=3)y[h]=H[l-h-3],y[h+1]=H[l-h-2],y[h+2]=H[l-h-1],S[h]=W[l-h-3],S[h+1]=W[l-h-2],S[h+2]=W[l-h-1]}for(new Array(t.length),v=new Array(t.length),h=0,l=t.length;h<l;h++){for(g=t[h],V=Math.round(u/3),v[h]=V,h<F&&(U=new Array(g.length),z[h+1]=U),f=V,d=0,p=g.length;d<p;d++)A=g[d],y[u]=A[0],y[u+1]=A[1],y[u+2]=A[2],m?(C=m.forward(g[d]),A=[k[0]*C[0]+k[1]*C[1]+k[2]*C[2],N[0]*C[0]+N[1]*C[1]+N[2]*C[2],0]):A=g[d],S[u]=A[0],S[u+1]=A[1],S[u+2]=A[2],u+=3,h<F&&(U[d]=f,f++);for(j=0,V*=3,d=0,p=3*g.length;d<p;d+=3)D=S[V+d],_=S[V+d+1],d<p-3?(O=S[V+d+3],G=S[V+d+4]):(O=S[V+0],G=S[V+1]),j+=D*G,j-=O*_;if(j>0){H=y.slice(),W=S.slice();for(d=0,p=3*g.length;d<p;d+=3)y[V+d]=H[V+p-d-3],y[V+d+1]=H[V+p-d-2],y[V+d+2]=H[V+p-d-1],S[V+d]=W[V+p-d-3],S[V+d+1]=W[V+p-d-2],S[V+d+2]=W[V+p-d-1]}}var q,Z,Y,J,K,Q,X,$,ee,te=vts.earcut(S,v,3),ie=Number.POSITIVE_INFINITY;switch(o.mode){case"auto":ie=Math.sqrt(P)/19;break;case"by-length":ie=o.length}var re,se=new Array(z.length);for(h=0,l=z.length;h<l;h++)se[h]=z[h].slice();var ae,ne,oe,he,le,ue,ce=new Array(196608),de=new Array(196608),pe=new Array(196608),fe=0,ge=0,me=0,ve=new Array(196608);for(h=0,l=y.length;h<l;h+=3)ve[h]=y[h],ve[h+1]=y[h+1],ve[h+2]=y[h+2];var be=Math.round(l/3),xe=ie;for(h=0,l=te.length;h<l;h+=3){q=te[h],Z=te[h+1],Y=te[h+2],fe=3;var we=null,Me=null,Se=null;for(u=0,c=z.length;u<c;u++)for(U=z[u],re=se[u],d=0,p=U.length;d<p;d++){var Ae=d<U.length-1?d+1:0;(q==U[d]&&Z==U[Ae]||q==U[Ae]&&Z==U[d])&&(re[d]=[U[d]],we=re[d]),(Z==U[d]&&Y==U[Ae]||Z==U[Ae]&&Y==U[d])&&(re[d]=[U[d]],Me=re[d]),(Y==U[d]&&q==U[Ae]||q==U[Ae]&&Y==U[d])&&(re[d]=[U[d]],Se=re[d])}ce[0]=[q,we],ce[1]=[Z,Me],ce[2]=[Y,Se];do{for(u=0,c=fe;u<c;u+=3)if(he=ce[u][0],le=ce[u+1][0],ue=ce[u+2][0],we=ce[u][1],Me=ce[u+1][1],Se=ce[u+2][1],J=[ve[3*he],ve[3*he+1],ve[3*he+2]],K=[ve[3*le],ve[3*le+1],ve[3*le+2]],Q=[ve[3*ue],ve[3*ue+1],ve[3*ue+2]],m&&(J=m.forward(J),K=m.forward(K),Q=m.forward(Q)),ae=ye.length([J[0]-K[0],J[1]-K[1],J[2]-K[2]]),ne=ye.length([K[0]-Q[0],K[1]-Q[1],K[2]-Q[2]]),oe=ye.length([Q[0]-J[0],Q[1]-J[1],Q[2]-J[2]]),(f=Math.max(ae,ne,oe))<ie)pe[me]=he,pe[me+1]=le,pe[me+2]=ue,me+=3;else{X=[.5*(J[0]+K[0]),.5*(J[1]+K[1]),.5*(J[2]+K[2])],m&&((X=m.inverse(X))[2]=.5*(ve[3*he+2]+ve[3*le+2])),$=[.5*(K[0]+Q[0]),.5*(K[1]+Q[1]),.5*(K[2]+Q[2])],m&&(($=m.inverse($))[2]=.5*(ve[3*le+2]+ve[3*ue+2])),ee=[.5*(Q[0]+J[0]),.5*(Q[1]+J[1]),.5*(Q[2]+J[2])],m&&((ee=m.inverse(ee))[2]=.5*(ve[3*ue+2]+ve[3*he+2]));var Ce=3*be;ae==f?(ve[Ce]=X[0],ve[Ce+1]=X[1],ve[Ce+2]=X[2],we&&(we[0]=[[we[0]],[-be]],we=we[0]),de[f=ge]=[he,we?we[0]:null],de[f+1]=[be,null],de[f+2]=[ue,Se||null],de[f+3]=[be,we?we[1]:null],de[f+4]=[le,Me||null],de[f+5]=[ue,null]):ne==f?(ve[Ce]=$[0],ve[Ce+1]=$[1],ve[Ce+2]=$[2],Me&&(Me[0]=[[Me[0]],[-be]],Me=Me[0]),de[f=ge]=[he,we||null],de[f+1]=[le,Me?Me[0]:null],de[f+2]=[be,null],de[f+3]=[be,Me?Me[1]:null],de[f+4]=[ue,Se||null],de[f+5]=[he,null]):oe==f&&(ve[Ce]=ee[0],ve[Ce+1]=ee[1],ve[Ce+2]=ee[2],Se&&(Se[0]=[[Se[0]],[-be]],Se=Se[0]),de[f=ge]=[he,we||null],de[f+1]=[le,null],de[f+2]=[be,Se?Se[1]:null],de[f+3]=[be,null],de[f+4]=[le,Me||null],de[f+5]=[ue,Se?Se[0]:null]),be+=1,ge+=6}var Te=ce;ce=de,de=Te,fe=ge,ge=0}while(fe>0);ie=xe}var Pe=new Array(196608),Fe=0,Le=function(e){for(var t=0,i=e.length;t<i;t++)Array.isArray(e[t])?Le(e[t]):(Pe[Fe]=e[t],Fe++)},Ee=0;for(h=0,l=se.length;h<l;h++)Le(se[h]),se[h]=Pe.slice(Ee,Fe),Ee=Fe;for(te=new Array(fe),h=0,l=me;h<l;h+=3)te[h]=pe[h],te[h+1]=pe[h+1],te[h+2]=pe[h+2];for(y=new Array(3*be),u=0,h=0,l=3*be;h<l;h+=3)y[h]=ve[h],y[h+1]=ve[h+1],y[h+2]=ve[h+2],u++;this.addPolygonRAW(y,te,se,i,r,s,a,n)},be.prototype.addPolygonRAW=function(e,t,i,r,s,a,n,o,h,l){this.currentGroup||this.addGroup("some-group");var u,c,d,p=!s||"float"==s,f=0;o=o||this.navSrs;var g={id:n,properties:a},m=new Array(Math.round(e.length/3));if(p){for(u=0,c=e.length;u<c;u+=3)d=[e[u],e[u+1],e[u+2],g,null,null],this.addToHeightsBuffer(d),m[f++]=d;g.floatHeights=!0,g.srs=o,g.heightsToProcess=m.length,this.heightsToProcess+=m.length}else for(u=0,c=e.length;u<c;u+=3)m[f++]=h?l?[e[u]*l.sx+l.px,e[u+1]*l.sy+l.py,e[u+2]*l.sz+l.pz]:[e[u],e[u+1],e[u+2]]:this.physSrs.convertCoordsFrom([e[u],e[u+1],e[u+2]],o);var v=t.slice(),y=new Array(i.length);for(u=0,c=i.length;u<c;u++)y[u]=i[u].slice();return g.vertices=m,g.surface=v,g.borders=y,this.currentGroup.polygons.push(g),this},be.prototype.importVTSGeodata=function(e,t,i){return new ve(this,t,i).processJSON(e)},be.prototype.importGeoJson=function(e,t,i,r){return new me(this,t,i,r).processJSON(e)},be.prototype.import3DTiles=function(e,t){return new MapGeodataImport3DTiles(this,t).processJSON(e)},be.prototype.load3DTiles=function(e,t,i){new MapGeodataImport3DTiles(this,t).loadJSON(e,t,i)},be.prototype.load3DTiles2=function(e,t,i){this.binPath=e,onMapLoaded&&onMapLoaded()},be.prototype.processHeights=function(e,t,i){if(this.heightsToProcess<=0)i&&i(this);else{this.processingHeights&&this.processHeightsCalls.push(this.processHeights.bind(this,e,t)),this.processingHeights=!0,this.heightsSource=e,this.heightsLod=t;var r,s,a,n,o,h,l,u=this.heightsProcessBufferFirst;if(u){switch(e){case"node-by-precision":o=!0;case"heightmap-by-precision":s=(h=u.coords)[3].srs?this.navSrs.convertCoordsFrom(h,h[3].srs):h,n=this.map.measure.getOptimalHeightLodBySampleSize(s,t);break;case"node-by-lod":o=!0,t-=8;case"heightmap-by-lod":n=t;break;case"none":l=!0}do{h=u.coords,l||null!=h[4]||(s=h[3].srs?this.navSrs.convertCoordsFrom(h,h[3].srs):h,a=this.map.measure.getSpatialDivisionNode(s),h[4]=a[0],h[5]=a[1]),((a=l?[0,!0,!0]:this.map.measure.getSurfaceHeight(h,n,null,h[4],h[5],null,o))[1]||a[2])&&(h[2]+=a[0],this.removeFromHeightsBuffer(u,r),h[3].heightsToProcess--,this.heightsToProcess--,h[3].heightsToProcess<=0&&(h[3].floatHeights=!1),s=[h[0],h[1],h[2]],s=this.physSrs.convertCoordsFrom(s,h[3].srs),h[0]=s[0],h[1]=s[1],h[2]=s[2]),r=u,u=u.next}while(u)}this.heightsToProcess<=0?(this.updateCallback&&this.updateCallback(),this.processingHeights=!1,i&&i(this),this.processHeightsCalls.length>1&&this.processHeightsCalls.shift()()):this.updateCallback||(this.updateCallback=this.map.core.on("map-update",this.processHeights.bind(this,this.heightsSource,this.heightsLod,i)))}},be.prototype.extractGeometry=function(e){for(var t,i,r,s,a,n,o=0,h=this.groups.length;o<h;o++){var l,u,c=this.groups[o],d=c.points,p=c.lines,f=c.polygons;for(l=0,u=d.length;l<u;l++)d[l].id==e&&(t=d[l]);for(l=0,u=p.length;l<u;l++)p[l].id==e&&(t=p[l]);for(l=0,u=f.length;l<u;l++)f[l].id==e&&(t=f[l])}if(t){if(t.points){if((m=t.points).length>0)for(r=new Float64Array(3*m.length),o=0,h=m.length;o<h;o++)a=3*o,n=m[o],r[a]=n[0],r[a+1]=n[1],r[a+2]=n[2];return new ge(this.map,{type:"point-geometry",id:t.id,geometryBuffer:r})}if(t.lines){if((i=t.lines).length>0){var g=0;for(o=0,h=i.length;o<h;o++)g+=i[o].length;for(r=new Float64Array(3*g),s=new Uint32Array(h),a=0,o=0,h=i.length;o<h;o++){var m;for(l=0,u=(m=i[o]).length;l<u;l++)n=m[l],r[a]=n[0],r[a+1]=n[1],r[a+2]=n[2],a+=3}}return new ge(this.map,{type:"line-geometry",id:t.id,geometryBuffer:r,indicesBuffer:s})}return t.vertices?new ge(this.map,{type:"polygon-geometry",id:t.id,geometryBuffer:t.vertices,surface:t.surface}):void 0}},be.prototype.compileGroup=function(e,t){var i,r,s,a,n,o,h,l,u,c,d,p,f,g=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],v={},y=e.points,b=e.lines,x=e.polygons;for(v.id=e.id,h=0,l=y.length;h<l;h++)for(u=0,c=(i=y[h].points).length;u<c;u++)(r=i[u])[0]>m[0]&&(m[0]=r[0]),r[1]>m[1]&&(m[1]=r[1]),r[2]>m[2]&&(m[2]=r[2]),r[0]<g[0]&&(g[0]=r[0]),r[1]<g[1]&&(g[1]=r[1]),r[2]<g[2]&&(g[2]=r[2]);for(h=0,l=b.length;h<l;h++)for(u=0,c=(n=b[h].lines).length;u<c;u++)for(d=0,p=(o=n[u]).length;d<p;d++)(r=o[d])[0]>m[0]&&(m[0]=r[0]),r[1]>m[1]&&(m[1]=r[1]),r[2]>m[2]&&(m[2]=r[2]),r[0]<g[0]&&(g[0]=r[0]),r[1]<g[1]&&(g[1]=r[1]),r[2]<g[2]&&(g[2]=r[2]);for(h=0,l=x.length;h<l;h++)for(u=0,c=(i=x[h].vertices).length;u<c;u++)(r=i[u])[0]>m[0]&&(m[0]=r[0]),r[1]>m[1]&&(m[1]=r[1]),r[2]>m[2]&&(m[2]=r[2]),r[0]<g[0]&&(g[0]=r[0]),r[1]<g[1]&&(g[1]=r[1]),r[2]<g[2]&&(g[2]=r[2]);t||(t=Math.max(m[0]-g[0]+1,m[1]-g[1]+1,m[2]-g[2]+1)/.25,t=Math.max(t,1024),t=Math.min(t,2<<20));v.resolution=t;var w=[t/(m[0]-g[0]+1),t/(m[1]-g[1]+1),t/(m[2]-g[2]+1)];for(v.points=new Array(y.length),h=0,l=y.length;h<l;h++){i=(s=y[h]).points;var M=new Array(i.length);for(u=0,c=i.length;u<c;u++)r=i[u],M[u]=[Math.round((r[0]-g[0])*w[0]),Math.round((r[1]-g[1])*w[1]),Math.round((r[2]-g[2])*w[2])];a={points:M},s.id&&(a.id=s.id),s.properties&&(a.properties=s.properties),v.points[h]=a}for(v.lines=new Array(b.length),h=0,l=b.length;h<l;h++){n=(s=b[h]).lines;var S=new Array(n.length);for(u=0,c=n.length;u<c;u++){for(o=n[u],M=new Array(o.length),d=0,p=o.length;d<p;d++)r=o[d],M[d]=[Math.round((r[0]-g[0])*w[0]),Math.round((r[1]-g[1])*w[1]),Math.round((r[2]-g[2])*w[2])];S[u]=M}a={lines:S},s.id&&(a.id=s.id),s.properties&&(a.properties=s.properties),v.lines[h]=a}for(v.polygons=new Array(x.length),h=0,l=x.length;h<l;h++){i=(s=x[h]).vertices;var A=new Array(i.length);for(d=0,u=0,c=i.length;u<c;u++)r=i[u],A[d++]=Math.round((r[0]-g[0])*w[0]),A[d++]=Math.round((r[1]-g[1])*w[1]),A[d++]=Math.round((r[2]-g[2])*w[2]);a={vertices:A,surface:s.surface.slice()},f=s.borders;var C=new Array(f.length);for(u=0,c=C.length;u<c;u++)C[u]=f[u].slice();a.borders=C,s.id&&(a.id=s.id),s.properties&&(a.properties=s.properties),v.polygons[h]=a}return v.bbox=[g,m],m[0]>this.bboxMax[0]&&(this.bboxMax[0]=m[0]),m[1]>this.bboxMax[1]&&(this.bboxMax[1]=m[1]),m[2]>this.bboxMax[2]&&(this.bboxMax[2]=m[2]),g[0]<this.bboxMin[0]&&(this.bboxMin[0]=g[0]),g[1]<this.bboxMin[1]&&(this.bboxMin[1]=g[1]),g[2]<this.bboxMin[2]&&(this.bboxMin[2]=g[2]),v},be.prototype.makeGeodata=function(e){this.bboxMin=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],this.bboxMax=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];var t={version:1,groups:[]};this.binPath&&(t.binPath=this.binPath);for(var i=0,r=this.groups.length;i<r;i++)t.groups.push(this.compileGroup(this.groups[i],e));if(this.nodes.length>0)for(t.nodes=[],i=0,r=this.nodes.length;i<r;i++)t.nodes.push(this.nodes[i]);return t},be.prototype.makeFreeLayer=function(e,t,i){return i||(i=this.makeGeodata(t)),e||(e={layers:{"my-lines":{filter:["==","#type","line"],line:!0,"line-width":4,"line-color":[255,0,255,255],"zbuffer-offset":[-5,0,0]},"my-points":{filter:["==","#type","point"],point:!0,"point-radius":10,"point-color":[0,0,255,255],"zbuffer-offset":[-5,0,0]}}}),{credits:[],displaySize:1024,extents:{ll:this.bboxMin,ur:this.bboxMax},geodata:i,style:e,type:"geodata"}};var xe=be,we=I,Me=a.a,Se=function(e,t,i){this.map=e,this.stats=e.stats,this.mapLoaderUrl=t,this.extraInfo=i,this.bbox=new we,this.size=0,this.fileSize=0,this.geodata=null,this.type="geodata",this.cacheItem=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.map.markDirty()};Se.prototype.kill=function(){this.bbox=null,this.killGeodata()},Se.prototype.killGeodata=function(e){this.geodata&&(this.geodata=null),!0!==e&&null!=this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),this.loadState=0,this.size=0,this.fileSize=0,this.cacheItem=null},Se.prototype.isReady=function(e,t,i,r){var s=this.map.stats.gpuRenderUsed>=this.map.maxGpuUsed;if(e=e||s,2==this.loadState)return this.map.resourcesCache.updateItem(this.cacheItem),!0;if(0==this.loadState)if(e);else{if("object"==typeof this.mapLoaderUrl)return this.geodata=r?this.mapLoaderUrl:JSON.stringify(this.mapLoaderUrl),this.loadState=2,this.size=this.geodata.length?this.geodata.length:0,this.cacheItem=this.map.resourcesCache.insert(this.killGeodata.bind(this,!0),this.size),this.map.resourcesCache.updateItem(this.cacheItem),!0;this.scheduleLoad(t)}else 3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t);return!1},Se.prototype.scheduleLoad=function(e){this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),e,this.extraInfo.tile,"geodata")},Se.prototype.onLoad=function(e,t,i){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=i,this.loadState=1,this.map.config.mapGeodataBinaryLoad?this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"geodata"):Me.loadJSON(e,this.onLoaded.bind(this),this.onLoadError.bind(this),!0,!!Me.useCredentials&&-1!=this.mapLoaderUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)},Se.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},Se.prototype.onLoaded=function(e){if(!this.map.killed){var t=e.length||e.byteLength;t||(t=0),this.size=t,this.fileSize=t,this.geodata=e,this.cacheItem=this.map.resourcesCache.insert(this.killGeodata.bind(this,!0),t),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}};var Ae=Se,Ce=function(e,t,i,r,s){this.gpu=e,this.gl=e.gl,this.bbox=null,this.fileSize=i,this.core=r,this.vertexBuffer=null,this.colorBuffer=null;var a=t.vertices,n=t.colors,o=this.gl;a&&n&&o&&(this.vertexBuffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.vertexBuffer),o.bufferData(o.ARRAY_BUFFER,s?a:new Uint8Array(a),o.STATIC_DRAW),this.vertexBuffer.itemSize=3,this.vertexBuffer.numItems=a.length/3,this.colorBuffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.colorBuffer),o.bufferData(o.ARRAY_BUFFER,s?n:new Uint8Array(n),o.STATIC_DRAW),this.colorBuffer.itemSize=3,this.colorBuffer.numItems=n.length/3,this.size=3*this.vertexBuffer.numItems,this.size+=3*this.colorBuffer.numItems,this.points=this.vertexBuffer.numItems,this.valid=!0)};Ce.prototype.kill=function(){this.gl&&this.valid&&(this.vertexBuffer&&this.gl.deleteBuffer(this.vertexBuffer),this.colorBuffer&&this.gl.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null,this.colorBuffer=null)},Ce.prototype.draw=function(e,t,i,r){var s=this.gl;if(null!=s&&this.valid){var a=e.getAttribute(t);s.bindBuffer(s.ARRAY_BUFFER,this.vertexBuffer),s.vertexAttribPointer(a,this.vertexBuffer.itemSize,s.UNSIGNED_BYTE,!0,0,0);var n=e.getAttribute(i);s.bindBuffer(s.ARRAY_BUFFER,this.colorBuffer),s.vertexAttribPointer(n,this.colorBuffer.itemSize,s.UNSIGNED_BYTE,!0,0,0),r||s.drawArrays(s.POINTS,0,this.vertexBuffer.numItems)}},Ce.prototype.getSize=function(){return this.size},Ce.prototype.getPoints=function(){return this.points};var Te=Ce,Pe=s.b,Fe=I,Le=a.a,Ee=Te,ke=function(e,t,i,r,s){this.generateLines=!0,this.map=e,this.stats=e.stats,this.mapLoaderUrl=t,this.rangeOffset=r,this.rangeSize=s,this.tile=i,this.bbox=new Fe,this.size=0,this.gpuSize=0,this.fileSize=0,this.faces=0,this.cacheItem=null,this.gpuCacheItem=null,this.loadState=0,this.loadErrorTime=null,this.loadErrorCounter=0,this.mBuffer=new Float32Array(16),this.mBuffer2=new Float32Array(16),this.vBuffer=new Float32Array(4),this.subclouds=[],this.gpuSubclouds=[],this.subcloudsKilled=!1};ke.prototype.kill=function(){this.bbox=null,this.killSubclouds(),this.killGpuSubcloud()},ke.prototype.killSubclouds=function(e){for(var t=0,i=this.subclouds.length;t<i;t++)this.subclouds[t].kill();this.subcloudsKilled=!0,!0!==e&&this.cacheItem&&this.map.resourcesCache.remove(this.cacheItem),0==this.gpuSubclouds.length&&(this.loadState=0),this.cacheItem=null},ke.prototype.killGpuSubclouds=function(e){for(var t=0,i=0,r=this.gpuSubclouds.length;i<r;i++)this.gpuSubclouds[i].kill(),t+=this.gpuSubclouds[i].getSize();r>0&&(this.stats.gpuMeshes-=t,this.stats.graphsFluxMesh[1][0]++,this.stats.graphsFluxMesh[1][1]+=t),this.gpuSubclouds=[],!0!==e&&this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.subcloudsKilled&&(this.loadState=0),this.gpuCacheItem=null},ke.prototype.isReady=function(e,t,i){var r=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||r,2==this.loadState){if(this.cacheItem&&this.map.resourcesCache.updateItem(this.cacheItem),i)return!0;if(0==this.gpuSubclouds.length){if(this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed)return!1;if(r)return!1;var s=performance.now();this.buildGpuSubclouds(),this.stats.renderBuild+=performance.now()-s}return!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem),!0}return 0==this.loadState?e||this.scheduleLoad(t):3==this.loadState&&this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&performance.now()>this.loadErrorTime+this.map.config.mapLoadErrorRetryTime&&this.scheduleLoad(t),!1},ke.prototype.scheduleLoad=function(e){this.map.loader.load(this.mapLoaderUrl,this.onLoad.bind(this),e,this.tile,"pointcloud")},ke.prototype.onLoad=function(e,t,i){this.mapLoaderCallLoaded=t,this.mapLoaderCallError=i,this.map.loader.processLoadBinary(e,this.onLoaded.bind(this),this.onLoadError.bind(this),null,"pointcloud",{offset:this.rangeOffset,size:this.rangeSize}),this.loadState=1},ke.prototype.onLoadError=function(){this.map.killed||(this.loadState=3,this.loadErrorTime=performance.now(),this.loadErrorCounter++,this.loadErrorCounter<=this.map.config.mapLoadErrorMaxRetryCount&&setTimeout(function(){this.map.killed||this.map.markDirty()}.bind(this),this.map.config.mapLoadErrorRetryTime),this.mapLoaderCallError())},ke.prototype.onLoaded=function(e,t,i){if(!this.map.killed){if(!t)return this.map.markDirty(),void this.map.addProcessingTask(this.onLoaded.bind(this,e,!0,i));var r=performance.now();if(i)this.parseWorkerData(e);else{this.fileSize=e.byteLength;var s={data:new DataView(e),buffer:e,index:0};this.parseMapPointCloud(s)}this.map.stats.renderBuild+=performance.now()-r,this.subcloudsKilled=!1,this.cacheItem=this.map.resourcesCache.insert(this.killSubclouds.bind(this,!0),this.size),this.map.markDirty(),this.loadState=2,this.loadErrorTime=null,this.loadErrorCounter=0,this.mapLoaderCallLoaded()}},ke.prototype.parseMapPointCloud=function(e){var t=e.data,i="";if(t.length<2)return!1;if(i+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,i+=String.fromCharCode(t.getUint8(e.index,!0)),e.index+=1,"pc"!=i)return!1;this.version=t.getUint16(e.index,!0),e.index+=2;var r=t.getUint32(e.index,!0);e.index+=4;var s=Le.unint8ArrayToString(new Uint8Array(t.buffer,e.index,r));e.index+=r;try{s=JSON.parse(s)}catch(e){}var a=r+2+2+4,n=s.features,o=s.attributes;if(!n||n.length<1)return!1;if(!o||o.length<1)return!1;for(var h=0,l=n.length;h<l;h++){var u=n[h],c=o[u.attributes];if(c){var d={},p=u.offset+a,f=u.size;if(d.size=f,"color"in c)switch(c.color){case 0:d.colors=new Uint8Array(t.buffer,p,3*f),p+=3*f}if("position"in c)switch(c.position){case 0:d.vertices=new Uint8Array(t.buffer,p,3*f),p+=3*f}this.addSubcloud(d)}}},ke.prototype.addSubcloud=function(e){this.subclouds.push(e),this.size+=3*e.size*2,this.points+=e.size},ke.prototype.buildGpuSubclouds=function(){this.gpuSubclouds=new Array(this.subclouds.length);for(var e=this.map.renderer,t=0,i=this.subclouds.length;t<i;t++){var r=this.subclouds[t];this.gpuSubclouds[t]=new Ee(e.gpu,{vertices:r.vertices,colors:r.colors},r.size,this.map.core,!0)}this.stats.gpuMeshes+=0,this.stats.graphsFluxMesh[0][0]++,this.stats.graphsFluxMesh[0][1]+=0,this.gpuCacheItem=this.map.gpuCache.insert(this.killGpuSubclouds.bind(this,!0),0),this.gpuSize=0},ke.prototype.getWorldMatrix=function(e,t){var i=t;return i?(i[0]=this.transform[3],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=this.transform[3],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=this.transform[3],i[11]=0,i[12]=this.transform[0]-e[0],i[13]=this.transform[1]-e[1],i[14]=this.transform[2]-e[2],i[15]=1):(i=Pe.create(),Pe.multiply(math.translationMatrix(this.bbox.min[0]-e[0],this.bbox.min[1]-e[1],this.bbox.min[2]-e[2]),math.scaleMatrix(this.bbox.side(0),this.bbox.side(1),this.bbox.side(2)),i)),i},ke.prototype.drawSubcloud=function(e,t,i,r,s,a,n,o,h){var l=this.map.renderer;this.gpuSubclouds[t]||!this.subclouds[t]||this.subclouds[t].killed||(this.gpuSubclouds[t]=new Ee(l.gpu,{vertices:this.subclouds[t].vertices,colors:this.subclouds[t].colors},this.subclouds[t].size,this.map.core,!0));var u=this.subclouds[t],c=this.gpuSubclouds[t];if(c){var d=l.progPCloud,p=this.mBuffer,f=this.mBuffer2;this.vBuffer;Pe.multiply(l.camera.getModelviewFMatrix(),this.getWorldMatrix(e,f),p),l.gpu.useProgram(d,["aPosition","aColor"],null);var g=l.camera.getProjectionMatrix();Pe.multiply(g,p,f),d.setMat4("uMVP",f),c.draw(d,"aPosition","aColor"),this.stats.drawnFaces+=u.size,this.stats.drawCalls++}},ke.prototype.draw=function(e,t,i){for(var r=0,s=this.subclouds.length;r<s;r++)this.drawSubcloud(e,r,t,i)};var Ne=k,Ie=F,Be=j,Re=he,ze=Ae,Ue=ke,De=function(e,t,i){this.map=e,this.id=i,this.parent=t,this.metatiles={},this.meshes={},this.textures={},this.subtextures={},this.geodata={},this.credits={},this.children=[null,null,null,null]};De.prototype.kill=function(){for(var e=0;e<4;e++)null!=this.children[e]&&this.children[e].kill();this.children=[null,null,null,null];var t=this.parent;this.parent=null,null!=t&&t.removeChild(this)},De.prototype.addChild=function(e){if(!this.children[e]){var t=this.id,i=[t[0]+1,t[1]<<1,t[2]<<1];switch(e){case 1:i[1]++;break;case 2:i[2]++;break;case 3:i[1]++,i[2]++}this.children[e]=new De(this.map,this,i)}},De.prototype.removeChildByIndex=function(e){null!=this.children[e]&&(this.children[e].kill(),this.children[e]=null)},De.prototype.removeChild=function(e){for(var t=0;t<4;t++)this.children[t]==e&&(this.children[t].kill(),this.children[t]=null)},De.prototype.getMesh=function(e,t){var i=this.meshes[e];return i||(i=new Re(this.map,e,t),this.meshes[e]=i),i},De.prototype.getPointCloud=function(e,t,i,r){this.pointclouds||(this.pointclouds={});var s=i?e+"@"+i:e,a=this.pointclouds[s];return a||(a=new Ue(this.map,e,t,i,r),this.pointclouds[s]=a),a},De.prototype.getGeodata=function(e,t){var i=this.geodata[e];return i||(i=new ze(this.map,e,t),this.geodata[e]=i),i},De.prototype.getTexture=function(e,t,i,r,s,a){var n;if(r&&(r.layer||r.hmap)){var o=e+(r.hmap?"":r.layer.id);(n=this.textures[o])||(n=new Ne(this.map,e,t,i,r,s,a),this.textures[o]=n)}else(n=this.textures[e])||(n=new Ne(this.map,e,t,i,r,s,a),this.textures[e]=n);return n},De.prototype.getSubtexture=function(e,t,i,r,s,a,n){return(e=this.subtextures[t])||(e=new Ie(this.map,t,i,r,s,a,n),this.subtextures[t]=e),e},De.prototype.addMetatile=function(e,t){this.metatiles[e]=t},De.prototype.removeMetatile=function(e){for(var t in this.metatiles)this.metatiles[t]==e&&delete this.metatiles[t]},De.prototype.getMetatile=function(e,t,i){var r,s=this.metatiles;for(var a in s)if(s[a].surface==e)return s[a];var n=e.getMetaUrl(this.id);return s[n]?(r=s[n].clone(e),this.addMetatile(n,r),r):t?(r=new Be(this,e,i),this.addMetatile(n,r),r):null};var _e=De,Oe=_e,Ge=function(e){this.map=e,this.tree=new Oe(e,null,[0,0,0])};Ge.prototype.kill=function(){this.tree.kill()},Ge.prototype.findNode=function(e,t){for(var i=this.tree,r=e[0];r>0;r--){var s=1<<r-1,a=0;if(0!=(e[1]&s)&&(a+=1),0!=(e[2]&s)&&(a+=2),!i.children[a]){if(!t)return null;i.addChild(a)}i=i.children[a]}return i},Ge.prototype.findAgregatedNode=function(e,t,i){for(var r=this.tree,s=e[1]>>t<<t,a=e[2]>>t<<t,n=e[0];n>0;n--){var o=1<<n-1,h=0;if(0!=(s&o)&&(h+=1),0!=(a&o)&&(h+=2),!r.children[h]){if(!i)return null;r.addChild(h)}r=r.children[h]}return r};var Ve=Ge,je=i(5),He=i.n(je),We=k,qe=p.a,Ze=He.a,Ye=function(e,t,i){if(this.map=e,this.id=t,this.proj4=e.proj4,this.comment=i.comment||null,this.srsDef=i.srsDef||null,this.srsModifiers=i.srsModifiers||[],this.type=i.type||"projected",this.vdatum=i.vdatum||"orthometric",this.srsDef=i.srsDefEllps||this.srsDef,this.periodicity=this.parsePeriodicity(i.periodicity),this.srsInfo=this.proj4(this.srsDef).info(),this.geoidGrid=null,this.geoidGridMap=null,this.srsProj4=this.proj4(this.srsDef,null,null,!0),this.latlonProj4=null,this.proj4Cache={},i.geoidGrid){var r=i.geoidGrid;if(this.geoidGrid={definition:r.definition||null,srsDefEllps:r.srsDefEllps||null,valueRange:r.valueRange||[0,1]},r.extents?this.geoidGrid.extents={ll:r.extents.ll,ur:r.extents.ur}:this.geoidGrid.extents={ll:[0,0],ur:[1,1]},this.geoidGrid.definition){var s=this.map.url.makeUrl(this.geoidGrid.definition,{},null);this.geoidGridMap=new We(this.map,s,!0)}this.geoidGrid.srsDefEllps&&(this.geoidGrid.srsProj4=this.proj4(this.geoidGrid.srsDefEllps,null,null,!0))}"geographic"==this.type&&(this.spheroid=i.spheroid||null,this.spheroid)};Ye.prototype.parsePeriodicity=function(e){return null==e?null:{type:e.type||"",period:e.period||0}},Ye.prototype.getInfo=function(){return{comment:this.comment,srsDef:this.srsDef,srsModifiers:this.srsModifiers,type:this.type,vdatum:this.vdatum,srsDefEllps:this.srsDef,a:this.srsInfo.a,b:this.srsInfo.b}},Ye.prototype.getSrsInfo=function(){return this.srsInfo},Ye.prototype.isReady=function(){return this.isGeoidGridReady()},Ye.prototype.isGeoidGridReady=function(){return null==this.geoidGrid||null!=this.geoidGridMap&&this.geoidGridMap.isReady()},Ye.prototype.isProjected=function(){return"projected"==this.type},Ye.prototype.getOriginalHeight=function(e){var t=e[2]||0;return t/=this.getVerticalAdjustmentFactor(e),t+=this.getGeoidGridDelta(e)},Ye.prototype.getFinalHeight=function(e){var t=e[2]||0;return t-=this.getGeoidGridDelta(e),t*=this.getVerticalAdjustmentFactor(e)},Ye.prototype.getGeoidGridDelta=function(e){if(null!=this.geoidGridMap&&this.isGeoidGridReady()){var t=this.proj4(this.srsProj4,this.geoidGrid.srsProj4,[e[0],e[1]]),i=t[0]-this.geoidGrid.extents.ll[0],r=this.geoidGrid.extents.ur[1]-t[1],s=this.geoidGridMap.getImageExtents();i*=s[0]/(this.geoidGrid.extents.ur[0]-this.geoidGrid.extents.ll[0]),r*=s[1]/(this.geoidGrid.extents.ur[1]-this.geoidGrid.extents.ll[1]),i=qe.clamp(i,0,s[0]-2),r=qe.clamp(r,0,s[1]-2);var a=Math.floor(i),n=Math.floor(r),o=i-a,h=r-n,l=this.geoidGridMap.getImageData(),u=n*s[0],c=u+s[0],d=l[4*(u+a)],p=l[4*(u+a+1)],f=l[4*(c+a)],g=d+(p-d)*o,m=g+(f+(l[4*(c+a+1)]-f)*o-g)*h;return m=this.geoidGrid.valueRange[0]+m*((this.geoidGrid.valueRange[1]-this.geoidGrid.valueRange[0])/255)}return 0},Ye.prototype.getVerticalAdjustmentFactor=function(e){if(-1!=this.srsModifiers.indexOf("adjustVertical")){var t=this.getSrsInfo(),i="+proj=longlat  +alpha=0 +gamma=0 +a="+t.a+" +b="+t.b+" +x0=0 +y0=0";this.latlonProj4||(this.latlonProj4=this.proj4(i,null,null,!0));var r=this.proj4(this.srsProj4,this.latlonProj4,[e[0],e[1]]),s=new Ze.Geodesic.Geodesic(t.a,t.a/t.b-1).Direct(r[1],r[0],90,1e3);r=[s.lon2,s.lat2];var a=(r=this.proj4(this.latlonProj4,this.srsProj4,r))[0]-e[0],n=r[1]-e[1];return Math.sqrt(a*a+n*n)/1e3}return 1},Ye.prototype.convertCoordsTo=function(e,t,i){if(this.isReady(),"string"!=typeof t){if(t.id==this.id)return e.slice();t.isReady()}var r="string"==typeof t;(e=e.slice())[2]=this.getOriginalHeight(e);var s=r?t:t.srsProj4,a=r?t:t.srsDef,n=this.proj4Cache[a];n||(n=this.proj4(this.srsProj4,s),this.proj4Cache[a]=n);var o=n.forward(e);return i||r||(o[2]=t.getFinalHeight(o)),o},Ye.prototype.convertCoordsToFast=function(e,t,i,r,s,a){var n=t.srsProj4,o=t.srsDef,h=this.proj4Cache[o];h||(h=this.proj4(this.srsProj4,n),this.proj4Cache[o]=h);var l=h.forward(e);r[a]=l[0],r[a+1]=l[1],r[a+2]=l[2],t.geoidGrid&&(r[a+2]-=t.getGeoidGridDelta(e))},Ye.prototype.convertCoordsFrom=function(e,t){if(this.isReady(),"string"!=typeof t){if(t.id==this.id)return e.slice();t.isReady()}e=e.slice(),"string"!=typeof t&&(e[2]=t.getOriginalHeight(e));var i="string"==typeof t?t:t.srsProj4,r="string"==typeof t?t:t.srsDef,s=this.proj4Cache[r];s||(s=this.proj4(this.srsProj4,i),this.proj4Cache[r]=s);var a=s.inverse(e);return a[2]=this.getFinalHeight(a),a},Ye.prototype.phi2z=function(e,t){for(var i,r,s=.5*Math.PI,a=.5*e,n=s-2*Math.atan(t),o=0;o<=15;o++)if(i=e*Math.sin(n),n+=r=s-2*Math.atan(t*Math.pow((1-i)/(1+i),a))-n,Math.abs(r)<=1e-10)return n;return-9999},Ye.prototype.convertMercToWGS=function(e,t,i,r){var s=2*Math.PI,a=.5*Math.PI,n=this.srsProj4,o=e[i]-n.x0,h=e[i+1]-n.y0;if(n.sphere)t[r+1]=a-2*Math.atan(Math.exp(-h/(n.a*n.k0)));else{var l=Math.exp(-h/(n.a*n.k0)),u=this.phi2z(n.e,l);if(t[r+1]=u,-9999===u)return}o=n.long0+o/(n.a*n.k0);t[r]=Math.abs(o)<=3.14159265359?o:o-(o<0?-1:1)*s,t[r+2]=e[i+2]},Ye.prototype.convertWGSToGeocent=function(e,t,i,r,s){var a,n,o,h,l=t.datum,u=.5*Math.PI,c=e[r],d=e[r+1],p=e[r+2];if(d<-u&&d>-1.001*u)d=-u;else if(d>u&&d<1.001*u)d=u;else if(d<-u||d>u)return null;c>Math.PI&&(c-=2*Math.PI),n=Math.sin(d),h=Math.cos(d),o=n*n,a=l.a/Math.sqrt(1-l.es*o),i[s]=(a+p)*h*Math.cos(c),i[s+1]=(a+p)*h*Math.sin(c),i[s+2]=(a*(1-l.es)+p)*n};var Je=Ye,Ke=function(e,t){this.map=e,this.maxCost=null!=t?t:Number.MAX_VALUE,this.skipCostCheck=!1,this.last=null,this.first=null,this.totalCost=0,this.totalItems=0};Ke.prototype.updateItem=function(e){if(null!=e&&this.first!=e){null!=e.prev&&(e.prev.next=e.next),null!=e.next&&(e.next.prev=e.prev),this.last==e&&(this.last=e.prev);var t=this.first;this.first=e,this.first.next=t,this.first.prev=null,t.prev=this.first}},Ke.prototype.getMaxCost=function(){return this.maxCost},Ke.prototype.setMaxCost=function(e){this.maxCost=e,this.checkCost()},Ke.prototype.clear=function(){for(var e=this.first;null!=e;)null!=e.destructor&&e.destructor(),e=e.next;this.last=null,this.first=null,this.totalCost=0,this.totalItems=0},Ke.prototype.insert=function(e,t){this.totalItems++;var i={destructor:e,cost:t,prev:null,next:this.first};return null!=this.first&&(this.first.prev=i),this.first=i,null==this.last&&(this.last=i),this.totalCost+=t,this.checkCost(),i},Ke.prototype.remove=function(e){this.totalItems++;var t=!1;e==this.first&&(this.first=e.next,t=!0,null!=this.first&&(this.first.prev=null)),e==this.last&&(this.last=e.prev,t=!0,null!=this.last&&(this.last.next=null)),t||(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev)),this.totalCost-=e.cost,e.destructor(),this.checkCost()},Ke.prototype.checkCost=function(){if(!this.skipCostCheck)for(;this.totalCost>this.maxCost;){this.totalItems--;var e=this.last;if(null==e)break;this.last=this.last.prev,null!=this.last&&(this.last.next=null),this.totalCost-=e.cost,e.destructor()}},Ke.prototype.addItem=function(e,t){return this.insert(t,e)},Ke.prototype.removeItem=function(e){return this.remove(e)},Ke.prototype.itemUsed=function(e){return this.updateItem(e)};var Qe=Ke,Xe=s.d,$e=p.a,et=function(e){this.map=e,this.camera=e.renderer.camera,this.distance=10,this.distance2=10,this.position=[0,0,0],this.vector=[0,0,1],this.vector2=[0,0,1,1],this.center=[0,0,0],this.height=0,this.terrainHeight=0,this.lastTerrainHeight=0,this.near=2};et.prototype.update=function(){var e=this.map;e.position.check();var t=e.position.getHeight(),i=e.measure.getOptimalHeightLod(e.position.getCoords(),e.position.getViewExtent(),e.config.mapNavSamplesPerViewExtent),r=e.measure.getSurfaceHeight(e.position.getCoords(),i,!0);e.stats.heightTerrain=r[0],e.stats.heightDelta=t,"float"==e.position.getHeightMode()&&(t+=r[0]),e.renderer.useSuperElevation&&(t=e.renderer.getSuperElevatedHeight(t));var s=e.measure.getPositionCameraInfo(e.position,e.getNavigationSrs().isProjected());this.camera.setPosition(s.orbitCoords),this.camera.setRotationMatrix(s.rotMatrix),this.vector=s.vector,this.vector2=s.vector2,this.position=s.orbitCoords,this.height=s.orbitHeight+t,this.terrainHeight=this.height-r[0],this.distance2=e.position.getViewDistance(),this.distance=Math.max(this.terrainHeight,this.distance2),this.distance=$e.clamp(this.distance,.1,this.camera.getFar()),this.distanceFactor=Math.tan($e.radians(.5*e.position.getFov())),this.perceivedDistance=Math.max(this.terrainHeight,this.distance2*this.distanceFactor),e.renderer.cameraDistance=this.distance,e.renderer.viewExtent=e.position.getViewExtent(),this.camera.setViewHeight(e.position.getViewExtent());var a=e.position.getCoords(),n=e.convert.convertCoords([a[0],a[1],t],"navigation","physical");if(this.center=[n[0],n[1],n[2]],n[0]+=s.orbitCoords[0],n[1]+=s.orbitCoords[1],n[2]+=s.orbitCoords[2],this.camera.setPosition([0,0,0]),this.position=n,this.vector2=[-n[0],-n[1],-n[2],1],Xe.normalize(this.vector2),this.mapIsProjected=e.getNavigationSrs().isProjected(),this.mapIsProjected)this.vector2[3]=0;else{this.geocentDistance=Xe.length(this.position);var o=[0,0,0];Xe.normalize(this.position,o),this.geocentNormal=o}var h=Math.max(this.height,this.distance)/6e5,l=Math.max(this.near,this.near*(20*h)),u=10*(h=Math.max(1,h))*6e5;return this.camera.setParams(.5*e.position.getFov(),l,2*u),s},et.prototype.getCameraHeight=function(){return this.cameraHeight},et.prototype.getMvpMatrix=function(){return this.camera.getMvpMatrix()},et.prototype.getRotationMatrix=function(){return this.camera.getRotationMatrix()},et.prototype.getRotationviewMatrix=function(){return this.camera.getRotationviewMatrix()},et.prototype.getFar=function(){return this.camera.getFar()},et.prototype.getFov=function(){return this.camera.getFov()},et.prototype.getAspect=function(){return this.camera.getAspect()};var tt=et,it=a.a,rt=function(e,t){this.map=e,this.id=t.id||null,this.notice=t.notice||null,this.copyrighted=t.copyrighted||!0,this.url=t.url||null,this.html=it.simpleWikiLinks(this.notice),this.plain=it.simpleWikiLinks(this.notice)};rt.prototype.getInfo=function(){return{id:this.id,notice:this.notice,html:this.html,plain:this.plain}};var st=rt,at=i(3),nt=a.a,ot=at.a,ht=st,lt=function(e,t,i){if(this.map=e,this.id=i,this.currentAlpha=1,this.tileSize=[256,256],this.lodRange=[0,100],this.credits=[],this.tileRange=[[0,0],[0,0]],this.jsonUrl=null,this.baseUrl=this.map.url.baseUrl,this.baseUrlSchema=this.map.url.baseUrlSchema,this.baseUrlOrigin=this.map.url.baseUrlOrigin,this.ready=!1,this.dataType=0,this.shaderFilters=null,"esri-world-imagery"==i&&(t.availability={type:"negative-size",size:2521}),"string"==typeof t){this.jsonUrl=this.map.url.processUrl(t),this.baseUrl=ot.getBase(this.jsonUrl),this.baseUrlSchema=ot.getSchema(this.jsonUrl),this.baseUrlOrigin=ot.getOrigin(this.jsonUrl);var r=function(e){this.parseJson(e),this.ready=!0,this.map.refreshView()}.bind(this),s=function(){}.bind(this);nt.loadJSON(this.jsonUrl,r,s,null,!!nt.useCredentials&&-1!=this.jsonUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)}else this.parseJson(t),this.ready=!0};lt.prototype.parseJson=function(e){switch(this.numberId=e.id||null,this.type=e.type||"raster",this.url=this.processUrl(e.url,""),this.tileSize=e.tileSize||[256,256],this.lodRange=e.lodRange||[0,0],this.tileRange=e.tileRange||[[0,0],[0,0]],this.metaUrl=this.processUrl(e.metaUrl),this.maskUrl=this.processUrl(e.maskUrl),this.isTransparent=e.isTransparent||!1,this.options=e.options||{},this.credits=e.credits||[],this.creditsUrl=null,this.shaderFilter=this.options.shaderFilter||null,e.dataType){default:case"color":this.dataType=0;break;case"height":this.dataType=1;break;case"classification":this.dataType=2}if(this.specificity=Math.pow(2,this.lodRange[0])/((this.tileRange[1][0]-this.tileRange[1][0]+1)*(this.tileRange[1][1]-this.tileRange[1][1]+1)),this.availability=e.availability?{}:null,this.availability){var t=e.availability;switch(t.type){case"negative-type":this.availability.type=2;break;case"negative-code":this.availability.type=3;break;case"negative-size":this.availability.type=4}this.availability.mime=t.mime,this.availability.codes=t.codes,this.availability.size=t.size}switch(this.metaUrl&&this.maskUrl&&(this.availability={type:1}),typeof this.credits){case"string":this.creditsUrl=this.credits,this.credits=[];break;case"object":if(!Array.isArray(this.credits)){var i=this.credits;for(var r in this.credits=[],i)this.map.addCredit(r,new ht(this.map,i[r])),this.credits.push(r)}}},lt.prototype.kill=function(){},lt.prototype.setOptions=function(){},lt.prototype.getOptions=function(){return this.getInfo()},lt.prototype.getInfo=function(){return{type:this.type,url:this.url,tileSize:this.tileSize,credits:this.credits,lodRange:this.lodRange,tileRange:this.tileRange,mataUrl:this.metaUrl,maskUrl:this.maskUrl,isTransparent:this.isTransparent}},lt.prototype.processUrl=function(e,t){return e?-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},lt.prototype.hasTile=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var i=e[1]>>t,r=e[2]>>t;return!(e[0]<this.lodRange[0]||e[0]>this.lodRange[1]||i<this.tileRange[0][0]||i>this.tileRange[1][0]||r<this.tileRange[0][1]||r>this.tileRange[1][1])},lt.prototype.hasTileOrInfluence=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var i=e[1]>>t,r=e[2]>>t;return i<this.tileRange[0][0]||i>this.tileRange[1][0]||r<this.tileRange[0][1]||r>this.tileRange[1][1]?0:e[0]>this.lodRange[1]?1:2},lt.prototype.getUrl=function(e,t){return this.map.url.makeUrl(this.url,{lod:e[0],ix:e[1],iy:e[2]},null,t)},lt.prototype.getMetatileUrl=function(e,t){return this.map.url.makeUrl(this.metaUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},lt.prototype.getMaskUrl=function(e,t){return this.map.url.makeUrl(this.maskUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)};var ut=lt,ct=function(e,t,i,r,s,a){this.map=e,this.id=t,this.srs=this.map.getMapsSrs(i),this.extents=r,this.heightRange=s,this.partitioning=a,this.isPole=1==t[0]&&(0==t[1]&&1==t[2]||1==t[1]&&0==t[2])};ct.prototype.getInnerCoords=function(e){return this.srs.convertCoordsFrom(e,this.map.getNavigationSrs())},ct.prototype.getOuterCoords=function(e){return this.srs.convertCoordsTo(e,this.map.getNavigationSrs())},ct.prototype.getPhysicalCoords=function(e,t){return this.srs.convertCoordsTo(e,this.map.getPhysicalSrs(),t)},ct.prototype.getPhysicalCoordsFast=function(e,t,i,r,s){return this.srs.convertCoordsToFast(e,this.map.getPhysicalSrs(),t,i,r,s)},ct.prototype.getExtents=function(e){return this.srs.convertCoordsFrom(e,this.map.getNavigationSrs())};var dt=ct,pt=function(e,t){this.map=e,this.proj4=e.proj4,this.valid=!1,this.id=t.id||null,this.description=t.description||"",this.nodesMap=[];var i=t.model;if(null!=i){if(this.model={physicalSrs:e.getMapsSrs(i.physicalSrs),navigationSrs:e.getMapsSrs(i.navigationSrs),publicSrs:e.getMapsSrs(i.publicSrs)},this.body=t.body?e.getBody(t.body):null,this.params={},null!=t.parameters){var r=t.parameters;this.params.metaBinaryOrder=r.metaBinaryOrder||1,this.params.navDelta=r.navDelta||8}var s=t.division;if(null!=s){this.division={rootLod:s.rootLod||0,arity:s.arity||null,heightRange:s.heightRange||[0,1]};var a=this.parseSpaceExtents(s.extents);this.division.extents=a,e.spaceExtentSize=[a.ur[0]-a.ll[0],a.ur[1]-a.ll[1],a.ur[2]-a.ll[2]],e.spaceExtentOffset=a.ll;var n=s.nodes;if(this.division.nodes=[],null!=n){this.hasPoles=4==n.length;for(var o=0,h=n.length;o<h;o++){var l=this.parseNode(n[o]);this.nodesMap[l.id[0]+"."+l.id[1]+"."+l.id[2]]=l,this.division.nodes.push(l)}this.valid=!0}}}};pt.prototype.getInfo=function(){return{id:this.id,physicalSrs:this.model.physicalSrs.id,navigationSrs:this.model.navigationSrs.id,publicSrs:this.model.publicSrs.id}},pt.prototype.getGlobalHeightRange=function(){return this.division.heightRange},pt.prototype.parseNode=function(e){var t={srs:e.srs,partitioning:e.partitioning};t.extents=this.parseExtents(e.extents);var i=e.id;if(null!=i)return t.id={lod:i.lod||0,position:i.position||[0,0]},new dt(this.map,[t.id.lod,t.id.position[0],t.id.position[1]],t.srs,t.extents,this.heightRange,t.partitioning)},pt.prototype.parseExtents=function(e){return null==e?{ll:[0,0],ur:[1,1]}:{ll:e.ll||[0,0],ur:e.ur||[1,1]}},pt.prototype.parseSpaceExtents=function(e){return null==e?{ll:[0,0,0],ur:[1,1,1]}:{ll:e.ll||[0,0,0],ur:e.ur||[1,1,1]}},pt.prototype.getSpatialDivisionNodes=function(){return this.division.nodes},pt.prototype.convertCoords=function(e,t,i){var r,s;switch(t){case"public":r=this.model.publicSrs;break;case"physical":r=this.model.physicalSrs;break;case"navigation":r=this.model.navigationSrs}switch(i){case"public":s=this.model.publicSrs;break;case"physical":s=this.model.physicalSrs;break;case"navigation":s=this.model.navigationSrs}return r.convertCoordsTo(e,s)};var ft=pt,gt=function(e,t){this.parse(t)};gt.prototype.parse=function(e){this.class=e.class||"",this.comment=e.comment||"",this.parent=e.parent||"",this.atmosphere=e.atmosphere||null,this.atmosphere&&(this.atmosphere.colorHorizon||(this.atmosphere.colorHorizon=[0,0,0,0]),this.atmosphere.colorZenith||(this.atmosphere.colorZenith=[0,0,0,0]),this.atmosphere.thickness||(this.atmosphere.thickness=1e5),this.atmosphere.visibility||(this.atmosphere.visibility=1e5))},gt.prototype.getInfo=function(){return{class:this.class,comment:this.comment,parent:this.parent,atmosphere:JSON.parse(JSON.stringify(this.atmosphere))}};var mt=gt,vt=a.a,yt=function(e,t,i,r){this.generateLines=!0,this.map=e,this.renderer=this.map.renderer,this.stats=e.stats,this.id=t,this.url=null,this.data=null,this.loadState=0,this.size=0,this.fileSize=0,this.freeLayer=r,this.fonts={},this.fontsReady=!1,"object"==typeof i?(this.data=i,this.setFonts(this.data),this.loadState=2,this.map.markDirty()):(this.freeLayer?this.url=this.freeLayer.processUrl(i,""):this.url=this.map.url.processUrl(i),vt.loadJSON(this.url,this.onLoaded.bind(this),this.onLoadError.bind(this),null,!!vt.useCredentials&&-1!=this.url.indexOf(this.map.url.baseUrl),this.map.core.xhrParams),this.loadState=1)};yt.prototype.kill=function(){},yt.prototype.setData=function(e){this.data=e,this.setFonts(e),this.loadState=2,this.checkFonts()},yt.prototype.checkFonts=function(){var e=!0;for(var t in this.fonts)e=e&&this.renderer.getFont(this.fonts[t]).isReady();return this.fontsReady=e,e},yt.prototype.isReady=function(e,t){return 2==this.loadState?!!this.fontsReady||this.checkFonts():(0==this.loadState&&(e||this.scheduleLoad(t)),!1)},yt.prototype.scheduleLoad=function(e){this.map.loader.load(this.url,this.onLoad.bind(this),e)},yt.prototype.onLoad=function(){this.loadState=1},yt.prototype.onLoadError=function(){this.map.killed},yt.prototype.setFonts=function(e){this.fonts=e.fonts||{},this.fonts["#default"]||(this.fonts["#default"]=this.map.core.config.mapDefaultFont)},yt.prototype.onLoaded=function(e){this.map.killed||(this.data=e,this.setFonts(e),this.loadState=2,this.map.markDirty())};var bt=yt,xt=st,wt=bt,Mt=A,St=I,At=a.a,Ct=at.a,Tt=function(e,t,i){if(this.map=e,this.id=null,this.type="basic",this.metaBinaryOrder=1,this.metaUrl="",this.navUrl="",this.navDelta=1,this.meshUrl="",this.textureUrl="",this.baseUrl=this.map.url.baseUrl,this.baseUrlSchema=this.map.url.baseUrlSchema,this.baseUrlOrigin=this.map.url.baseUrlOrigin,this.lodRange=[0,0],this.tileRange=[[0,0],[0,0]],this.textureLayer=null,this.boundLayerSequence=[],this.glue="glue"==i,this.free="free"==i,this.virtual=!1,this.zFactor=0,this.ready=!1,this.geodataProcessor=null,this.geodataCounter=0,this.geodataNavtileInfo=!1,this.monoGeodata=null,this.monoGeodataView=null,this.monoGeodataCounter=-1,this.creditsNumbers=[],this.surfaceCounter=e.surfaceCounter,e.surfaceCounter++,this.style=null,this.stylesheet=null,this.originalStyle=null,this.originalStylesheet=null,this.styleChanged=!0,this.free?this.tree=new Mt(this.map,!0,this):this.tree=null,"string"==typeof t){this.jsonUrl=this.map.url.processUrl(t),this.baseUrl=Ct.getBase(this.jsonUrl),this.baseUrlSchema=Ct.getSchema(this.jsonUrl),this.baseUrlOrigin=Ct.getOrigin(this.jsonUrl);var r=function(e){this.parseJson(e),this.ready=!0,this.map.refreshView()}.bind(this),s=function(){}.bind(this);At.loadJSON(this.jsonUrl,r,s,null,!!At.useCredentials&&-1!=this.jsonUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)}else this.parseJson(t),this.ready=!0};Tt.prototype.parseJson=function(e){var t,i;if(this.id=e.id||null,this.type=e.type||"basic",this.metaBinaryOrder=e.metaBinaryOrder||1,this.metaUrl=this.processUrl(e.metaUrl,""),this.navUrl=this.processUrl(e.navUrl,""),this.hmapUrl=this.processUrl(e.hmapUrl,e.navUrl+"00"),this.pipeline=this.map.config.mapForcePipeline?this.map.config.mapForcePipeline:e.pipeline,this.navDelta=e.navDelta||1,this.meshUrl=this.processUrl(e.meshUrl,""),this.textureUrl=this.processUrl(e.textureUrl,""),this.geodataUrl=this.processUrl(e.geodataUrl||e.geodata,""),this.lodRange=e.lodRange||[0,0],this.tileRange=e.tileRange||[[0,0],[0,0]],this.textureLayer=e.textureLayer||null,this.geodata="geodata"==this.type||"geodata-tiles"==this.type,this.credits=e.credits||[],this.creditsUrl=null,this.displaySize=e.displaySize||1024,e.extents){var r=e.extents.ll,s=e.extents.ur;this.extents=new St(r[0],r[1],r[2],s[0],s[1],s[2])}else this.extents=new St(0,0,0,1,1,1);switch(this.specificity=Math.pow(2,this.lodRange[0])/((this.tileRange[1][0]-this.tileRange[1][0]+1)*(this.tileRange[1][1]-this.tileRange[1][1]+1)),typeof this.credits){case"string":this.creditsUrl=this.credits,this.credits=[];break;case"object":if(!Array.isArray(this.credits)){var a=this.credits;for(var n in this.credits=[],a)this.map.addCredit(n,new xt(this.map,a[n])),this.credits.push(n)}for(t=0,i=this.credits.length;t<i;t++){var o=this.map.getCreditById(this.credits[t]);this.creditsNumbers.push(o?o.id:null)}}if(this.geodataUrl&&"string"==typeof this.geodataUrl&&-1!=this.geodataUrl.indexOf("{geonavtile}")&&(this.geodataNavtileInfo=!1),this.geodata){var h=e.style;"string"==typeof this.credits&&(h=this.processUrl(h,"")),this.originalStyle=h,h&&(this.setStyle(h),this.originalStylesheet=this.stylesheet)}if(this.surfaceReference=[],this.glue)for(t=0,i=this.id.length;t<i;t++)this.surfaceReference.push(this.map.getSurface(this.id[t]))},Tt.prototype.kill=function(){this.geodataProcessor&&(this.geodataProcessor.kill(),this.geodataProcessor=null),this.geodataUrl=null,this.style=null,this.stylesheet=null,this.originalStyle=null,this.originalStylesheet=null},Tt.prototype.setOptions=function(){},Tt.prototype.getOptions=function(){return this.getInfo()},Tt.prototype.getInfo=function(){return this.geodata?{type:this.type,metaUrl:this.metaUrl,geodataUrl:this.geodataUrl,lodRange:this.lodRange,tileRange:this.tileRange,style:this.originalStyle}:{type:this.type,metaUrl:this.metaUrl,navUrl:this.navUrl,meshUrl:this.meshUrl,textureUrl:this.textureUrl,lodRange:this.lodRange,tileRange:this.tileRange,textureLayer:this.textureLayer}},Tt.prototype.processUrl=function(e,t){return e?"string"!=typeof e||-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},Tt.prototype.hasTile=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var i=e[1]>>t,r=e[2]>>t;return!(e[0]<this.lodRange[0]||e[0]>this.lodRange[1]||i<this.tileRange[0][0]||i>this.tileRange[1][0]||r<this.tileRange[0][1]||r>this.tileRange[1][1])},Tt.prototype.hasTile2=function(e){var t=e[0]-this.lodRange[0],i=t<0;if(e[0]<this.lodRange[0]){t=-t;var r=this.tileRange[0][0]>>t,s=this.tileRange[0][1]>>t,a=this.tileRange[1][0]>>t,n=this.tileRange[1][1]>>t;if(e[0]>this.lodRange[1]||e[1]<r||e[1]>a||e[2]<s||e[2]>n)return[!1,!1]}else{var o=e[1]>>t,h=e[2]>>t;if(e[0]>this.lodRange[1]||o<this.tileRange[0][0]||o>this.tileRange[1][0]||h<this.tileRange[0][1]||h>this.tileRange[1][1])return[!1,!1]}return[!0,i]},Tt.prototype.hasMetatile=function(e){if(e[0]>this.lodRange[1])return!1;var t=e[0]-this.lodRange[0];if(t>=0){var i=e[1]>>t,r=e[2]>>t;if(i<this.tileRange[0][0]||i>this.tileRange[1][0]||r<this.tileRange[0][1]||r>this.tileRange[1][1])return!1}else if(t=-t,e[1]<this.tileRange[0][0]>>t||e[1]>this.tileRange[1][0]>>t||e[2]<this.tileRange[0][1]>>t||e[2]>this.tileRange[1][1]>>t)return!1;return!0},Tt.prototype.setStyle=function(e){if(this.style!=e){var t=e;"object"!=typeof t?t=this.processUrl(t,""):(t=JSON.stringify(t),t="#obj#"+(t=At.getHash(t)).toString(16)),this.stylesheet=this.map.getStylesheet(t),this.stylesheet||(this.stylesheet=new wt(this.map,t,e,this),this.map.addStylesheet(t,this.stylesheet)),this.style=e,this.styleChanged=!0,this.geodataCounter++,this.map.markDirty()}},Tt.prototype.getSurfaceReference=function(e){return this.surfaceReference[e-1]},Tt.prototype.getMetaUrl=function(e,t){return this.map.url.makeUrl(this.metaUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Tt.prototype.getNavUrl=function(e,t){return this.map.url.makeUrl(this.navUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Tt.prototype.getHMapUrl=function(e,t){return this.map.url.makeUrl(this.hmapUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Tt.prototype.getMeshUrl=function(e,t){return this.map.url.makeUrl(this.meshUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)},Tt.prototype.getTextureUrl=function(e,t,i){return this.map.url.makeUrl(this.textureUrl,{lod:e[0],ix:e[1],iy:e[2]},t,i)},Tt.prototype.getGeodataUrl=function(e,t,i){return this.map.url.makeUrl(this.geodataUrl,{lod:e[0],ix:e[1],iy:e[2]},t,i)},Tt.prototype.getMonoGeodataUrl=function(e,t){return this.map.url.makeUrl(this.geodataUrl,{},null,t)};var Pt=Tt,Ft=I,Lt=a.a,Et=function(e,t){this.map=e,this.id=null,this.metaUrl="",this.mappingUrl="",this.baseUrl=this.map.url.baseUrl,this.baseUrlSchema=this.map.url.baseUrlSchema,this.baseUrlOrigin=this.map.url.baseUrlOrigin,this.lodRange=[0,0],this.tileRange=[[0,0],[0,0]],this.surfaces=[],this.parseJson(t),this.virtual=!0,this.ready=!1};Et.prototype.parseJson=function(e){if(this.id=e.id||null,this.metaUrl=this.processUrl(e.metaUrl,""),this.mappingUrl=this.processUrl(e.mapping,""),this.lodRange=e.lodRange||[0,0],this.tileRange=e.tileRange||[[0,0],[0,0]],this.strId=this.id?this.id.join(";"):null,this.id){var t=this.id.slice();t.sort(),this.strId=t.join(";")}if(e.extents){var i=e.extents.ll,r=e.extents.ur;this.extents=new Ft(i[0],i[1],i[2],r[0],r[1],r[2])}else this.extents=new Ft(0,0,0,1,1,1);this.specificity=Math.pow(2,this.lodRange[0])/((this.tileRange[1][0]-this.tileRange[1][0]+1)*(this.tileRange[1][1]-this.tileRange[1][1]+1)),Lt.loadBinary(this.mappingUrl,this.onMappingFileLoaded.bind(this),this.onMappingFileLoadError.bind(this),!!Lt.useCredentials&&-1!=this.jsonUrl.indexOf(this.map.url.baseUrl),this.map.core.xhrParams)},Et.prototype.onMappingFileLoaded=function(e){this.parseMappingFile(new DataView(e)),this.ready=!0,this.map.refreshView()},Et.prototype.onMappingFileLoadError=function(){},Et.prototype.parseMappingFile=function(e){var t=0,i="";if(i+=String.fromCharCode(e.getUint8(t,!0)),t+=1,i+=String.fromCharCode(e.getUint8(t,!0)),t+=1,"TM"!=i)return!1;var r=e.getUint16(t,!0);t+=2;for(var s=0;s<r;s++){var a=e.getUint8(t,!0);t+=1;for(var n=[],o=0;o<a;o++){var h=e.getUint16(t,!0);t+=2,(h=this.id[h])&&n.push(h)}1==n.length?this.surfaces.push(this.map.getSurface(n[0])):this.surfaces.push(this.map.getGlue(n.join(";")))}return!0},Et.prototype.getInfo=function(){return{metaUrl:this.metaUrl,mapping:this.mappingUrl,lodRange:this.lodRange,tileRange:this.tileRange}},Et.prototype.processUrl=function(e,t){return e?-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},Et.prototype.hasTile=function(e){var t=e[0]-this.lodRange[0];if(t<0)return!1;var i=e[1]>>t,r=e[2]>>t;return!(e[0]<this.lodRange[0]||e[0]>this.lodRange[1]||i<this.tileRange[0][0]||i>this.tileRange[1][0]||r<this.tileRange[0][1]||r>this.tileRange[1][1])},Et.prototype.hasTile2=function(e){var t=e[0]-this.lodRange[0],i=t<0;if(e[0]<this.lodRange[0]){t=-t;var r=this.tileRange[0][0]>>t,s=this.tileRange[0][1]>>t,a=this.tileRange[1][0]>>t,n=this.tileRange[1][1]>>t;if(e[0]>this.lodRange[1]||e[1]<r||e[1]>a||e[2]<s||e[2]>n)return[!1,!1]}else{var o=e[1]>>t,h=e[2]>>t;if(e[0]>this.lodRange[1]||o<this.tileRange[0][0]||o>this.tileRange[1][0]||h<this.tileRange[0][1]||h>this.tileRange[1][1])return[!1,!1]}return[!0,i]},Et.prototype.hasMetatile=function(e){if(e[0]>this.lodRange[1])return!1;var t=e[0]-this.lodRange[0];if(t>=0){var i=e[1]>>t,r=e[2]>>t;if(i<this.tileRange[0][0]||i>this.tileRange[1][0]||r<this.tileRange[0][1]||r>this.tileRange[1][1])return!1}else if(t=-t,e[1]<this.tileRange[0][0]>>t||e[1]>this.tileRange[1][0]>>t||e[2]<this.tileRange[0][1]>>t||e[2]>this.tileRange[1][1]>>t)return!1;return!0},Et.prototype.getSurface=function(e){return this.surfaces[e-1]},Et.prototype.getMetaUrl=function(e,t){return this.map.url.makeUrl(this.metaUrl,{lod:e[0],ix:e[1],iy:e[2]},null,t)};var kt=st,Nt=ut,It=ft,Bt=h,Rt=Je,zt=mt,Ut=Pt,Dt=Et,_t=bt,Ot=function(e,t){this.map=e,this.mapConfig=t,this.parseConfig()};Ot.prototype.parseConfig=function(){this.parseSrses()&&this.parseBodies()&&this.parseReferenceFrame()&&this.parseCredits()&&this.parseStylesheets()&&this.parseSurfaces()&&this.parseGlues()&&this.parseVirtualSurfaces()&&this.parseBoundLayers()&&this.parseFreeLayers()&&this.parseViews()&&this.parseParams()&&this.parseBrowserOptions();var e=this.map.stats;e.loadedCount=0,e.loadErrorCount=0,e.loadFirst=performance.now(),e.loadLast=this.map.loadFirst},Ot.prototype.afterConfigParsed=function(){null!=this.mapConfig.position&&this.map.setPosition(this.mapConfig.position,!1),this.map.setView(this.map.initialView)},Ot.prototype.parseSrses=function(){var e=this.mapConfig.srses;if(this.map.srses={},null==e)return!1;for(var t in e)this.map.addSrs(t,new Rt(this.map,t,e[t]));return!0},Ot.prototype.parseBodies=function(){var e=this.mapConfig.bodies;if(this.map.bodies={},null==e)return!0;for(var t in e)this.map.addBody(t,new zt(this.map,e[t]));return!0},Ot.prototype.parseReferenceFrame=function(){var e=this.mapConfig.referenceFrame;return null!=e&&(this.map.referenceFrame=new It(this.map,e),!!this.map.referenceFrame.valid)},Ot.prototype.parseCredits=function(){var e=this.mapConfig.credits;if(this.map.credits={},null==e)return!1;for(var t in e)this.map.addCredit(t,new kt(this.map,e[t]));return!0},Ot.prototype.parseSurfaces=function(){var e=this.mapConfig.surfaces;if(this.map.surfaces=[],null==e)return!1;for(var t=0,i=e.length;t<i;t++){var r=new Ut(this.map,e[t]);this.map.addSurface(r.id,r)}return!0},Ot.prototype.parseVirtualSurfaces=function(){var e=this.mapConfig.virtualSurfaces;if(this.map.virtualSurfaces=[],!this.map.config.mapVirtualSurfaces)return!0;if(null==e)return!0;for(var t=0,i=e.length;t<i;t++){var r=new Dt(this.map,e[t]);this.map.virtualSurfaces[r.strId]=r}return!0},Ot.prototype.parseViews=function(){var e=this.mapConfig.namedViews;if(this.map.namedViews=[],e)for(var t in e)this.map.addNamedView(t,new Bt(this.map,e[t],!0));var i=this.mapConfig.view;return"string"==typeof i&&(i=this.map.namedViews[i]),!i||(i=new Bt(this.map,i,!0),this.map.initialView=i.getInfo(),!0)},Ot.prototype.parseGlues=function(){var e=this.mapConfig.glue;if(this.map.glues=[],null==e)return!0;for(var t=0,i=e.length;t<i;t++){var r=new Ut(this.map,e[t],"glue");this.map.addGlue(r.id.join(";"),r)}return!0},Ot.prototype.parseBoundLayers=function(){var e=this.mapConfig.boundLayers;if(this.map.boundLayers=[],null==e)return!0;for(var t in e){var i=new Nt(this.map,e[t],t);this.map.addBoundLayer(t,i)}return!0},Ot.prototype.parseFreeLayers=function(){var e=this.mapConfig.freeLayers;if(this.map.freeLayers=[],null==e)return!0;for(var t in e){var i=new Ut(this.map,e[t],"free");this.map.addFreeLayer(t,i)}return!0},Ot.prototype.parseStylesheets=function(){var e=this.mapConfig.stylesheets;if(this.map.stylesheets=[],null==e)return!0;for(var t in e){var i=new _t(this.map,t,e[t]);this.map.addStylesheet(t,i)}return!0},Ot.prototype.parseParams=function(){return!0},Ot.prototype.parseBrowserOptions=function(){var e=this.mapConfig.browserOptions;return this.map.browserOptions={},null==e||(this.map.browserOptions=JSON.parse(JSON.stringify(e))),!0},Ot.prototype.cloneConfig=function(){return JSON.parse(JSON.stringify(this.mapConfig))};var Gt=Ot,Vt=s.b,jt=p.a,Ht=(He.a,function(e){this.map=e,this.renderer=e.renderer,this.config=e.config,this.measure=e.measure,this.isProjected=this.map.getNavigationSrs().isProjected()});Ht.prototype.convertCoords=function(e,t,i){return this.map.referenceFrame.convertCoords(e,t,i)},Ht.prototype.movePositionCoordsTo=function(e,t,i,r){var s=e.getCoords();this.map.getNavigationSrs().getSrsInfo();if(r=null==r?1:r,this.isProjected){var a=jt.radians(t),n=[-Math.sin(a),Math.cos(a)];e.setCoords2([s[0]+n[0]*i,s[1]+n[1]*i])}else{var o=this.measure.getGeodesic().Direct(s[1],s[0],t,i);e.setCoords2([o.lon2,o.lat2]);var h=e.getOrientation();h[0]-=(o.azi1-o.azi2)*r,e.setOrientation(h)}return e},Ht.prototype.convertPositionViewMode=function(e,t){if(t==e.pos[0])return e;if("obj"==t){if("float"==e.getHeightMode()){var i=!0;this.convertPositionHeightMode(e,"fix",!0)}var r,s=e.getViewDistance(),a=e.getOrientation(),n=jt.radians(-a[1]),o=s*Math.sin(n);if(s*=Math.cos(n),this.isProjected){var h=jt.radians(a[0]),l=[-Math.sin(h),Math.cos(h)];(r=e.getCoords())[0]=r[0]+l[0]*s,r[1]=r[1]+l[1]*s}else this.movePositionCoordsTo(e,-a[0],s),r=e.getCoords();r[2]-=o,e.setCoords(r),i&&this.convertPositionHeightMode(e,"float",!0)}else"subj"==t&&(r=this.getPositionCameraCoords(e,e.getHeightMode()),e.setCoords(r));return e.pos[0]=t,e},Ht.prototype.convertPositionHeightMode=function(e,t,i){if(e.pos[3]==t)return e;var r=this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent),s=this.measure.getSurfaceHeight(e.getCoords(),r);return s[1],"float"==t?(e.pos[3]=t,e.pos[4]=e.pos[4]-s[0]):"fix"==t&&(e.pos[3]=t,e.pos[4]=e.pos[4]+s[0]),e},Ht.prototype.getPositionCameraCoords=function(e,t){var i=e.getOrientation(),r=Vt.create();Vt.multiply(jt.rotationMatrix(2,jt.radians(-i[0])),jt.rotationMatrix(0,jt.radians(i[1])),r);var s,a,n=0,o=-1;if("obj"==e.getViewMode()){s=e.getCoords(),"float"==e.getHeightMode()&&(o=this.measure.getOptimalHeightLod(s,e.getViewExtent(),this.config.mapNavSamplesPerViewExtent),n=(a=this.measure.getSurfaceHeight(s,o))[0]);var h=this.measure.getPositionCameraInfo(e,this.isProjected);if(this.isProjected)s[0]+=h.orbitCoords[0],s[1]+=h.orbitCoords[1],s[2]+=h.orbitCoords[2]+n;else{var l=this.convertCoords([s[0],s[1],s[2]+n],"navigation","physical");l[0]+=h.orbitCoords[0],l[1]+=h.orbitCoords[1],l[2]+=h.orbitCoords[2],s=this.convertCoords(l,"physical","navigation")}return"fix"==t||(-1==o&&(o=this.measure.getOptimalHeightLod(s,e.getViewExtent(),this.config.mapNavSamplesPerViewExtent)),a=this.measure.getSurfaceHeight(s,o),s[2]-=a[0]),s}return e.getHeightMode()==t?e.getCoords():(o=this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent),a=this.measure.getSurfaceHeight(e.getCoords(),o),s=e.getCoords(),"fix"==t?s[2]+=a[0]:s[2]-=a[0],s)},Ht.prototype.getPositionNavCoordsFromPublic=function(e,t){var i=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var r=this.measure.getSurfaceHeight(e.getCoords(),t);i[2]+=r[0]}return this.convertCoords(i,"public","navigation")},Ht.prototype.getPositionPublicCoords=function(e,t){var i=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var r=this.measure.getSurfaceHeight(e.getCoords(),t);i[2]+=r[0]}return this.convertCoords(i,"navigation","public")},Ht.prototype.getPositionPhysCoords=function(e,t,i){var r=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var s=this.measure.getSurfaceHeight(e.getCoords(),t);r[2]+=s[0]}return this.renderer.useSuperElevation&&i&&(r[2]=this.renderer.getSuperElevatedHeight(r[2])),this.convertCoords(r,"navigation","physical")},Ht.prototype.getPositionCameraSpaceCoords=function(e,t){var i=e.getCoords();if("float"==e.getHeightMode()){t=null!=t?t:this.measure.getOptimalHeightLod(e.getCoords(),e.getViewExtent(),this.config.mapNavSamplesPerViewExtent);var r=this.measure.getSurfaceHeight(e.getCoords(),t);i[2]+=r[0]}this.renderer.useSuperElevation&&(i[2]=this.renderer.getSuperElevatedHeight(i[2]));var s=this.convertCoords(i,"navigation","physical"),a=this.map.camera.position;return s[0]-=a[0],s[1]-=a[1],s[2]-=a[2],s},Ht.prototype.getPositionCanvasCoords=function(e,t,i,r){var s;if(i){var a=this.map.camera.position,n=e.getCoords();this.renderer.useSuperElevation&&!r&&(n=this.renderer.transformPointBySE(n)),s=[n[0]-a[0],n[1]-a[1],n[2]-a[2]]}else s=this.getPositionCameraSpaceCoords(e,t);return this.map.renderer.project2(s,this.map.camera.getMvpMatrix())},Ht.prototype.transformPhysCoordsBySE=function(e){return this.renderer.useSuperElevation?this.renderer.transformPointBySE(e):e},Ht.prototype.convertCoordsFromPhysToNav=function(e,t,i,r){if(e=this.convertCoords(e,"physical","navigation"),this.renderer.useSuperElevation&&r&&(e[2]=this.renderer.getUnsuperElevatedHeight(e[2])),"float"==t){i=null!=i?i:this.measure.getOptimalHeightLod(e,10,this.config.mapNavSamplesPerViewExtent);var s=this.measure.getSurfaceHeight(e,i);e[2]-=s[0]}return e},Ht.prototype.getGeodesicLinePoints=function(e,t,i,r){var s,a,n,o,h,l,u=this.measure.navigationSrsInfo,c=t[0]-e[0],d=t[1]-e[1],p=t[2]-e[2];this.isProjected?(n=Math.sqrt(c*c+d*d+p*p),h=1e6):(n=(a=(s=this.measure.getGeodesic()).Inverse(e[1],e[0],t[1],t[0])).s12,o=a.azi1,h=2*u.a*Math.PI/4007.5*10);for(var f=[e],g=h;g<n;g+=h)l=g/n,this.isProjected?f.push([e[0]+c*l,e[1]+d*l,e[2]+p*l]):(a=s.Direct(e[1],e[0],o,g),f.push([a.lon2,a.lat2,e[2]+p*l]));return f.push(t),f};var Wt=Ht,qt=s.d,Zt=s.b,Yt=p.a,Jt=He.a,Kt=function(e){this.map=e,this.config=e.config,this.convert=e.convert,this.getPhysicalSrs=this.map.getPhysicalSrs(),this.navigationSrs=this.map.getNavigationSrs(),this.publicSrs=this.map.getPublicSrs(),this.navigationSrsInfo=this.navigationSrs.getSrsInfo(),this.isProjected=this.navigationSrs.isProjected();var t=this.getSpatialDivisionNodeDepths();this.minDivisionNodeDepth=t[0],this.maxDivisionNodeDepth=t[1]};Kt.prototype.getSurfaceAreaGeometry=function(e,t,i,r,s,a){var n=this.map.tree;0==n.surfaceSequence.length&&reurn[[]];var o=this.convert.convertCoords(e,"navigation","physical"),h=[0,0,0];qt.normalize(o,h);var l=qt.length(o),u=Math.atan(Math.tan(t/l));return n.params={coneVec:h,coneAngle:u,mode:i,limit:r,loaded:!0,areaTiles:[],loadMeshes:!0===s,loadTextures:!0===a},n.traceAreaTiles(n.surfaceTree,0,!1),[n.params.loaded,n.params.areaTiles]},Kt.prototype.getSurfaceHeight=function(e,t,i,r,s,a,n){var o=this.map.tree;if(0==o.surfaceSequence.length)return[0,!0,!0,null,null,null];if(!r){var h=this.getSpatialDivisionNode(e);r=h[0],s=h[1]}if(this.config.mapHeightLodBlend||(t=Math.floor(t)),n||this.config.mapIgnoreNavtiles)return this.getSurfaceHeightNodeOnly(null,t+8,i,t,null,r,s,a);if(null!=r&&null!==t){var l=o.findSurfaceTile(r.id),u={ll:r.extents.ll.slice(),ur:r.extents.ur.slice()},c={coords:s,desiredLod:Math.ceil(t),extents:u,metanode:null,heightMap:null,heightMapExtents:null,traceHeight:!0,waitingForNode:!1,finalNode:!1,bestHeightMap:999};o.traceHeight(l,c,!1);var d,p,f,g=c.metanode;if(c.heightMap){if(i){var m=this.map.stats;m.heightClass=2,m.heightLod=t,m.heightNode=g.id[0]}var v,y,b,x=g.id[0]>=Math.ceil(t);if(this.config.mapHeightLodBlend&&g.id[0]>0&&c.parent&&c.parent.heightMap&&t<=g.id[0]){y=this.getHeightmapValue(s,c.parent.metanode,c.parent),b=this.getHeightmapValue(s,g,c);var w=t-Math.floor(t);if(f=y+(b-y)*w,a)for(v=new Array(a.length),d=0,p=a.length;d<p;d++){var M=a[d];y=this.getHeightmapValue(M,c.parent.metanode,c.parent),b=this.getHeightmapValue(M,g,c),v[d]=[y+(b-y)*w,x,!0]}}else if(f=this.getHeightmapValue(s,g,c),a)for(v=new Array(a.length),d=0,p=a.length;d<p;d++)b=this.getHeightmapValue(a[d],g,c),v[d]=[b,x,!0];return[f,x,!0,null,null,v]}if(g)return[(x=this.getSurfaceHeightNodeOnly(e,t+8,i,t,null,r,s,a))[0],x[1],x[2],null,null,x[5]]}return[0,!1,!1,null,null,null]},Kt.prototype.getSurfaceHeightNodeOnly=function(e,t,i,r,s,a,n,o){var h,l=this.map.stats,u=this.map.tree;if(0==u.surfaceSequence.length)return[0,!0,!0,null,null,null];if(s)a=s[0],n=s[1];else{if(!a){var c=this.getSpatialDivisionNode(e);a=c[0],n=c[1]}if(o){h=new Array(o.length);for(var d=0,p=o.length;d<p;d++)h[d]=this.getSurfaceHeightNodeOnly(null,t,i,r,s,a,o[d])}}if(this.config.mapHeightLodBlend||(t=Math.floor(t)),!s&&this.config.mapHeightNodeBlend){var f=this.getSurfaceHeightNodeOnly(null,t,i,r,[a,[n[0],n[1],n[2]]]);if(f[2]){var g=f[3].ur[0]-f[3].ll[0],m=f[3].ur[1]-f[3].ll[1],v=(n[0]-f[3].ll[0])/g,y=(n[1]-f[3].ll[1])/m,b=this.getSurfaceHeightNodeOnly(null,t,i,r,[a,[n[0]+g,n[1],n[2]]]),x=this.getSurfaceHeightNodeOnly(null,t,i,r,[a,[n[0],n[1]+m,n[2]]]),w=this.getSurfaceHeightNodeOnly(null,t,i,r,[a,[n[0]+g,n[1]+m,n[2]]]),M=f[0]+(b[0]-f[0])*v;return[M+(x[0]+(w[0]-x[0])*v-M)*y,f[1],f[2],f[3],null,h]}return[f[0],f[1],f[2],f[3],null,h]}if(null!=a&&null!==t){var S=u.findSurfaceTile(a.id),A={ll:a.extents.ll.slice(),ur:a.extents.ur.slice()},C={coords:n,desiredLod:Math.ceil(t),extents:A,metanode:null,heightMap:null,heightMapExtents:null,traceHeight:!0,waitingForNode:!1,finalNode:!1,bestHeightMap:999};u.traceHeight(S,C,!0);var T,P,F=C.metanode;if(null!=F){if(F.metatile.version>=5?T=this.convert.convertCoords(F.diskPos,"physical","navigation"):F.bbox.maxSize<8e3?(T=F.bbox.center(),T=this.convert.convertCoords(T,"physical","navigation")):T=[0,0,n[2]],i&&(l.heightClass=1,l.heightLod=r,l.heightNode=F.id[0]),this.config.mapHeightLodBlend&&F.id[0]>0&&C.parent&&C.parent.metanode){P=C.parent.metanode.metatile.version>=5?this.convert.convertCoords(C.parent.metanode.diskPos,"physical","navigation"):C.parent.metanode.bbox.maxSize<8e3?this.convert.convertCoords(C.parent.metanode.bbox.center(),"physical","navigation"):[0,0,n[2]];var L=t-Math.floor(t);return[T[2]+(P[2]-T[2])*L,F.id[0]>=Math.floor(t)||C.finalNode,!C.waitingForNode||F.id[0]>=Math.floor(t)||C.finalNode,C.extents,F,h]}return[T[2],F.id[0]>=Math.floor(t)||C.finalNode,!C.waitingForNode||F.id[0]>=Math.floor(t)||C.finalNode,C.extents,F,h]}}return i&&(l.heightClass=0,l.heightLod=r,l.heightNode=0),[0,!1,!1,null,null,h]},Kt.prototype.getHeightmapValue=function(e,t,i){var r=i.heightMap,s=r.getImageData(),a=r.getImageExtents(),n=i.heightMapExtents,o=e[0]-n.ll[0],h=n.ur[1]-e[1],l=a[0]-1,u=a[1]-1;(o=l*(o/(n.ur[0]-n.ll[0])))<0&&(o=0),(h=u*(h/(n.ur[1]-n.ll[1])))<0&&(h=0),o>l&&(o=l),h>u&&(h=u);var c=Math.floor(o),d=Math.floor(h),p=o-c,f=h-d,g=d*a[0],m=d==u?g:g+a[0],v=c==l?c:c+1,y=s[4*(g+c)],b=s[4*(g+v)],x=s[4*(m+c)],w=y+(b-y)*p,M=w+(x+(s[4*(m+v)]-x)*p-w)*f;return M=t.minHeight+(t.maxHeight-t.minHeight)*(M/255)},Kt.prototype.getSpatialDivisionNode=function(e){for(var t=this.map.referenceFrame.getSpatialDivisionNodes(),i=null,r=-1,s=[0,0],a=0,n=t.length;a<n;a++){var o=t[a],h=o.getInnerCoords(e),l=o.extents;h[0]>=l.ll[0]&&h[0]<=l.ur[0]&&h[1]>=l.ll[1]&&h[1]<=l.ur[1]&&o.id[0]>r&&(i=o,r=o.id[0],s=h)}return[i,s]},Kt.prototype.getSpatialDivisionNodeAndExtents=function(e){for(var t,i=this.map.referenceFrame.getSpatialDivisionNodes(),r=null,s=[0,0],a=0,n=i.length;a<n;a++){var o=i[a];if((t=e[0]-o.id[0])>=0){var h=e[1]>>t,l=e[2]>>t;o.id[1]==h&&o.id[2]==l&&(r=o,s=[o.id[1]<<t,o.id[2]<<t])}}if(!r)return null;t=e[0]-r.id[0];var u=1/Math.pow(2,t),c=r.extents.ur,d=r.extents.ll,p=(c[0]-d[0])*u,f=(d[1]-c[1])*u,g=e[1]-s[0],m=e[2]-s[1];return[r,[[d[0]+p*g,c[1]+f*m],[d[0]+p*(g+1),c[1]+f*(m+1)]]]},Kt.prototype.getSpatialDivisionNodeFromId=function(e){var t=e[0]-this.maxDivisionNodeDepth,i=e[1]>>t,r=e[2]>>t;return this.map.referenceFrame.nodesMap[this.maxDivisionNodeDepth+"."+i+"."+r]},Kt.prototype.getSpatialDivisionNodeAndExtents2=function(e,t,i){if(!i)return[null,0,0,0,0];var r=e[0]-i.id[0],s=1/Math.pow(2,r),a=i.extents.ur,n=i.extents.ll,o=(a[0]-n[0])*s,h=(n[1]-a[1])*s,l=e[1]-(i.id[1]<<r),u=e[2]-(i.id[2]<<r);t[0]=i,t[1]=n[0]+o*l,t[2]=a[1]+h*u,t[3]=n[0]+o*(l+1),t[4]=a[1]+h*(u+1)},Kt.prototype.getSpatialDivisionNodeDepths=function(){for(var e=this.map.referenceFrame.getSpatialDivisionNodes(),t=-1,i=Number.MAX_VALUE,r=0,s=e.length;r<s;r++){var a=e[r];a.id[0]<i&&(i=a.id[0]),a.id[0]>t&&(t=a.id[0])}return[i,t]},Kt.prototype.getOptimalHeightLodBySampleSize=function(e,t){var i=this.getSpatialDivisionNode(e)[0];if(null!=i){var r=i.id[0],s=i.extents.ur[1]-i.extents.ll[1],a=Math.log(s/t)/Math.log(2);return a=a-8+r,Math.max(0,a)}return null},Kt.prototype.getOptimalHeightLod=function(e,t,i){var r=this.getSpatialDivisionNode(e)[0];if(null!=r){var s=r.id[0],a=r.extents.ur[1]-r.extents.ll[1],n=Math.log(i*a/t)/Math.log(2);return n=n-8+s,Math.max(0,n)}return null},Kt.prototype.getDistance=function(e,t,i,r){var s=r?this.publicSrs:this.navigationSrs,a=this.getPhysicalSrs.convertCoordsFrom(e,s),n=this.getPhysicalSrs.convertCoordsFrom(t,s),o=n[0]-a[0],h=n[1]-a[1],l=n[2]-a[2],u=Math.sqrt(o*o+h*h+l*l),c=this.navigationSrsInfo;if(this.isProjected)return[Math.sqrt(o*o+h*h),Yt.degrees(Math.atan2(o,h)),u];var d=this.getGeodesic().Inverse(e[1],e[0],t[1],t[0]);return d.s12>2*c.a*Math.PI/4007.5?i?[Math.sqrt(d.s12*d.s12+l*l),-d.azi1,u]:[d.s12,-d.azi1,u]:i?[Math.sqrt(o*o+h*h+l*l),-d.azi1,u]:[d.s12,-d.azi1,u]},Kt.prototype.getGeodesic=function(){var e=this.navigationSrsInfo;return new Jt.Geodesic.Geodesic(e.a,e.a/e.b-1)},Kt.prototype.getAzimuthCorrection=function(e,t){if(!this.getNavigationSrs().isProjected()){var i=this.getGeodesic().Inverse(e[0],e[1],t[0],t[1]),r=i.azi1-i.azi2;return isNaN(r)&&(r=0),r}return 0},Kt.prototype.getNED=function(e){var t,i,r=this.convert.convertCoords([e[0],e[1],0],"navigation","physical");if(this.isProjected)t=this.convert.convertCoords([e[0],e[1]+100,0],"navigation","physical"),i=this.convert.convertCoords([e[0]+100,e[1],0],"navigation","physical");else{var s=e[1]+90-1e-4,a=e[0]+180+1e-4;if(s<0||a>180){var n=this.getGeodesic(),o=n.Direct(e[1],e[0],0,-100);t=this.convert.convertCoords([o.lon2,o.lat2,0],"navigation","physical"),o=n.Direct(e[1],e[0],90,100),i=this.convert.convertCoords([o.lon2,o.lat2,0],"navigation","physical")}else t=this.convert.convertCoords([e[0],e[1]-1e-4,0],"navigation","physical"),i=this.convert.convertCoords([e[0]+1e-4,e[1],0],"navigation","physical")}var h=[t[0]-r[0],t[1]-r[1],t[2]-r[2]],l=[i[0]-r[0],i[1]-r[1],i[2]-r[2]],u=[0,0,0];return qt.normalize(h),qt.normalize(l),qt.cross(h,l,u),qt.normalize(u),{east:l,direction:h,north:u}},Kt.prototype.getNewNED=function(e,t){var i,r,s=this.convert.convertCoords([e[0],e[1],0],"navigation","physical");if(this.isProjected)i=this.convert.convertCoords([e[0],e[1]+100,0],"navigation","physical"),r=this.convert.convertCoords([e[0]+100,e[1],0],"navigation","physical");else{var a=e[1]+90+1e-4,n=e[0]+180+1e-4;if(a<0||n>180){var o=this.getGeodesic(),h=o.Direct(e[1],e[0],0,-100);i=this.convert.convertCoords([h.lon2,h.lat2,0],"navigation","physical"),h=o.Direct(e[1],e[0],90,-100),r=this.convert.convertCoords([h.lon2,h.lat2,0],"navigation","physical")}else i=this.convert.convertCoords([e[0],e[1]+1e-4,0],"navigation","physical"),r=this.convert.convertCoords([e[0]+1e-4,e[1],0],"navigation","physical")}var l=[i[0]-s[0],i[1]-s[1],i[2]-s[2]],u=[r[0]-s[0],r[1]-s[1],r[2]-s[2]],c=[0,0,0];if(qt.normalize(l),qt.normalize(u),qt.cross(l,u,c),qt.normalize(c),t){return[u[0],u[1],u[2],0,c[0],c[1],c[2],0,l[0],l[1],l[2],0,0,0,0,1]}return{east:u,direction:l,north:c}},Kt.prototype.getPositionCameraInfo=function(e,t,i){var r=e.getOrientation(),s=e.getViewDistance();i&&(r[1]=Yt.clamp(r[1],-89,90));var a,n,o,h,l,u,c,d,p,f,g,m,v,y=Yt.clamp(r[1],-89.5,89.5),b=Zt.create();Zt.multiply(Yt.rotationMatrix(2,Yt.radians(-r[0])),Yt.rotationMatrix(0,Yt.radians(y)),b),"obj"==e.getViewMode()?(a=[0,-s,0],Zt.multiplyVec3(b,a)):a=[0,0,0];var x={orbitCoords:null,distance:s,rotMatrix:null,vector:null,orbitHeight:a[2]},w=e.getCoords();if(t){b=Zt.create(),Zt.multiply(Yt.rotationMatrix(0,Yt.radians(-y-90)),Yt.rotationMatrix(2,Yt.radians(r[0])),b),o=(n=this.getNED(w)).north,h=n.east,l=n.direction,u=[h[0],h[1],h[2],0,l[0],l[1],l[2],0,o[0],o[1],o[2],0,0,0,0,1],d=[1,0,0],f=[0,1,0],p=[0,0,1],g=[1,0,0],m=[0,0,-1],v=[0,0,0],qt.cross(g,m,v),Zt.multiplyVec3(b,p),Zt.multiplyVec3(b,d),Zt.multiplyVec3(b,f),Zt.multiplyVec3(b,g),Zt.multiplyVec3(b,m),Zt.multiplyVec3(b,v);var M=0;M=g[0],g[0]=g[1],g[1]=M,M=m[0],m[0]=m[1],m[1]=M,M=v[0],v[0]=v[1],v[1]=M,g[2]=-g[2],m[2]=-m[2],v[2]=-v[2],c=[d[0],d[1],d[2],0,f[0],f[1],f[2],0,p[0],p[1],p[2],0,0,0,0,1],x.vector=qt.normalize([-a[0],-a[1],-a[2]]),x.vector2=x.vector,x.orbitCoords=a,x.rotMatrix=c}else{o=(n=this.getNED(w)).north,h=n.east,l=n.direction,u=[h[0],h[1],h[2],0,l[0],l[1],l[2],0,o[0],o[1],o[2],0,0,0,0,1];var S=Zt.create();Zt.multiply(Yt.rotationMatrix(0,Yt.radians(-y-90)),Yt.rotationMatrix(2,Yt.radians(r[0])),S),d=[1,0,0],f=[0,1,0],p=[0,0,1],w=e.getCoords();var A=Zt.create();Zt.multiply(Yt.rotationMatrix(0,Yt.radians(w[1]-90)),Yt.rotationMatrix(2,Yt.radians(-w[0]-90)),A),Zt.multiplyVec3(A,p),Zt.multiplyVec3(A,d),Zt.multiplyVec3(A,f),u=[d[0],d[1],d[2],0,f[0],f[1],f[2],0,p[0],p[1],p[2],0,0,0,0,1],v=[1,0,0],g=[0,1,0],m=[0,0,1],Zt.multiplyVec3(u,g),Zt.multiplyVec3(u,m),Zt.multiplyVec3(u,v),Zt.multiplyVec3(S,v),Zt.multiplyVec3(S,g),Zt.multiplyVec3(S,m),c=[v[0],v[1],v[2],0,g[0],g[1],g[2],0,m[0],m[1],m[2],0,0,0,0,1],u=Zt.inverse(u),Zt.multiplyVec3(u,a),x.vector=[-c[2],-c[6],-c[10]]}return x.orbitCoords=a,x.rotMatrix=c,x};var Qt=Kt,Xt=(p.a,s.d),$t=a.a,ei=(at.a,function(){this.bintree=null,this.pathTable=null,this.totalNodes=0,this.pathTableSize=1,this.nodesIndex=0,this.rootSize=1});ei.prototype.processNode=function(e,t,i,r,s){for(var a=9*i,n=e[t],o=0;o<8;o++)if(this.bintree[a]=t,n&1<<o){this.totalNodes++;var h=this.totalNodes,l=o;this.bintree[a+1+l]=h,this.processNode(e,h,h,r+1)}},ei.prototype.processTree=function(e,t){var i=new DataView(e),r=0,s="";if(e.length<2)return!1;if(s+=String.fromCharCode(i.getUint8(r,!0)),r+=1,s+=String.fromCharCode(i.getUint8(r,!0)),r+=1,"tr"!=s)return!1;this.version=i.getUint16(r,!0),r+=2;var a=i.getUint32(r,!0);r+=4;var n=$t.unint8ArrayToString(new Uint8Array(e,r,a));r+=a;try{n=JSON.parse(n)}catch(e){}var o,h=a+2+2+4;n.bbox&&n.bbox.offset&&(o=n.bbox.offset),this.texelSize=n.texelSize;var l=n.node;if(!l)return!1;if(!l.features||!l.features.legnth<1)return!1;var u=i.getUint32(r,!0);r+=4;var c=new Uint8Array(e,r,u);r+=u;var d=l.features;this.features=[];for(var p=0,f=d.length;p<f;p++){var g={type:d[p].type,uri:d[p].uri};d[p].offset&&(g.indices=new Uint32Array(e.slice(d[p].offset+h,d[p].offset+h+4*(u+1)))),this.features.push(g)}if(o&&(this.bbox=new Float64Array(e.slice(h+o,h+o+192))),this.bintree=new Uint32Array(9*u),this.totalNodes=0,t.root){var m=this.bbox,v=[(m[0]+m[3]+m[6]+m[9]+m[12]+m[15]+m[18]+m[21])/8,(m[1]+m[4]+m[7]+m[10]+m[13]+m[16]+m[19]+m[22])/8,(m[2]+m[5]+m[8]+m[11]+m[14]+m[17]+m[20]+m[23])/8];this.rootPoints=[[m[0],m[1],m[2]],[m[3],m[4],m[5]],[m[9],m[10],m[11]],[m[6],m[7],m[8]],[m[12],m[13],m[14]],[m[15],m[16],m[17]],[m[21],m[22],m[23]],[m[18],m[19],m[20]]],this.rootCenter=v,this.rootRadius=Xt.distance(v,this.rootPoints[0]),this.rootTexelSize=this.texelSize?this.texelSize:Xt.distance(this.rootPoints[0],this.rootPoints[1])/256}else this.rootPoints=[],this.rootCenter=[],this.rootRadius=1,this.rootTexelSize=1;this.processNode(c,0,0,0),this.totalNodes++},ei.prototype.load=function(e,t,i){$t.loadBinary(e,this.onLoaded.bind(this,t,i),null)},ei.prototype.onLoaded=function(e,t,i){this.processTree(i,e),t&&t(e,{bintree:this.bintree,pathTable:this.pathTable,totalNodes:this.totalNodes,rootSize:this.rootSize,points:this.rootPoints,center:this.rootCenter,radius:this.rootRadius,texelSize:this.rootTexelSize,features:this.features,vtsFormat:!0})};var ti=ei,ii=s.d,ri=s.b,si=I,ai=p.a,ni=a.a,oi=_e,hi=ti,li=at.a,ui=!1,ci=function(e,t,i,r,s){this.id=e,this.bbox=null,this.origin=i||[0,0,0],this.gpu=r,this.gl=r.gl,this.renderer=s,this.jobs=[],this.reduced=0,this.geometries={},this.subjob=null,this.mv=new Float32Array(16),this.mvp=new Float32Array(16),this.loadMode=0,this.geFactor=1/16,this.geFactor2=.5,this.geNormalized=!1,null!=t&&null!=t[0]&&null!=t[1]&&(this.bbox=new si(t[0][0],t[0][1],t[0][2],t[1][0],t[1][1],t[1][2])),this.binFiles=[],this.size=0,this.polygons=0};function di(e,t){if(null==e||"object"!=typeof e)return this;if(null==e.points)return this;var i=e.points,r=e.color||[255,255,255,255],s=null!=e.depthOffset?e.depthOffset:null,a=e.size||2,n=null==e.screenSpace||e.screenSpace,o=null!=e.depthTest&&e.depthTest,h=null!=e.blend&&e.blend,l=null!=e.writeDepth&&e.writeDepth,u=null!=e.useState&&e.useState;return r=[r[0]*(1/255),r[1]*(1/255),r[2]*(1/255),r[3]*(1/255)],t.draw.drawLineString(i,n,a,r,s,o,h,l,u),this}ci.prototype.kill=function(){for(var e=0,t=this.jobs.length;e<t;e++){var i=this.jobs[e];switch(i.type){case 1:case 11:i.vertexPositionBuffer&&this.gl.deleteBuffer(i.vertexPositionBuffer),i.vertexElementBuffer&&this.gl.deleteBuffer(i.vertexElementBuffer);break;case 3:case 2:case 4:case 5:i.vertexPositionBuffer&&this.gl.deleteBuffer(i.vertexPositionBuffer),i.vertexNormalBuffer&&this.gl.deleteBuffer(i.vertexNormalBuffer),i.vertexElementBuffer&&this.gl.deleteBuffer(i.vertexElementBuffer);break;case 6:i.vertexPositionBuffer&&this.gl.deleteBuffer(i.vertexPositionBuffer),i.vertexTexcoordBuffer&&this.gl.deleteBuffer(i.vertexTexcoordBuffer),i.vertexElementBuffer&&this.gl.deleteBuffer(i.vertexElementBuffer);break;case 7:case 8:i.vertexPositionBuffer&&this.gl.deleteBuffer(i.vertexPositionBuffer),i.vertexTexcoordBuffer&&this.gl.deleteBuffer(i.vertexTexcoordBuffer),i.vertexOriginBuffer&&this.gl.deleteBuffer(i.vertexOriginBuffer),i.vertexElementBuffer&&this.gl.deleteBuffer(i.vertexElementBuffer)}}for(var r in this.geometries){var s=this.geometries[r],a=this.renderer.geometries[r];for(this.geometries[r]=null,e=0,t=s.length;e<t;e++)s[e]==a&&(this.renderer.geometries[r]=null)}},ci.prototype.getSize=function(){return this.size},ci.prototype.getZbufferOffset=function(){return this.size},ci.prototype.addGeometry=function(e){var t=e.id;this.geometries[t]?this.geometries[t].push(e):this.geometries[t]=[e],this.renderer.geometries[t]=e},ci.prototype.convertColor=function(e){var t=1/255;return[e[0]*t,e[1]*t,e[2]*t,e[3]*t]},ci.prototype.addLineJob=function(e){var t=this.gl,i=e.vertexBuffer,r={};if(13==e.type?r.type=11:r.type=1,r.program=this.renderer.progLine,r.color=this.convertColor(e.color),r.zIndex=e["z-index"]+256,r.clickEvent=e["click-event"],r.hoverEvent=e["hover-event"],r.enterEvent=e["enter-event"],r.leaveEvent=e["leave-event"],r.advancedHit=e.advancedHit,r.hitable=e.hitable,r.eventInfo=e.eventInfo,r.style=e.style||0,r.stencil=!1!==e.stencil,r.culling=e.culling||0,r.state=e.state,r.center=e.center,r.lod=e.lod,r.lineWidth=e["line-width"],r.zbufferOffset=e["zbuffer-offset"],r.reduced=!1,r.ready=!0,r.bbox=this.bbox,r.program.isReady()&&(!r.advancedHit||(r.program2=this.renderer.progELine,r.program2.isReady()))){if(r.vertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r.vertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),r.vertexPositionBuffer.itemSize=3,r.vertexPositionBuffer.numItems=i.length/3,r.advancedHit){r.program=this.renderer.progLine;var s=e.elementBuffer;r.vertexElementBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r.vertexElementBuffer),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW),r.vertexElementBuffer.itemSize=1,r.vertexElementBuffer.numItems=s.length}this.jobs.push(r),this.size+=4*i.length,this.polygons+=i.length/9}},ci.prototype.addExtentedLineJob=function(e){var t=this.gl,i=e.vertexBuffer,r=e.normalBuffer,s={};switch(s.type=e.type,s.type){case 6:s.type=3;break;case 7:s.type=2;break;case 9:s.type=4;break;case 10:s.type=5}if(s.color=this.convertColor(e.color),s.zIndex=e["z-index"]+256,s.clickEvent=e["click-event"],s.hoverEvent=e["hover-event"],s.hitable=e.hitable,s.eventInfo=e.eventInfo,s.enterEvent=e["enter-event"],s.leaveEvent=e["leave-event"],s.advancedHit=e.advancedHit,s.widthByRatio="ratio"==e["width-units"],s.state=e.state,s.center=e.center,s.lod=e.lod,s.lineWidth=e["line-width"],s.zbufferOffset=e["zbuffer-offset"],s.reduced=!1,s.ready=!0,s.bbox=this.bbox,null!=e.texture){var a=e.texture,n=a[0];s.texture=[this.renderer.getBitmap(n.url,n.filter||"linear",n.tiled||!1),a[1],a[2],a[3],a[4]];var o=this.convertColor(e.background);0!=o[3]&&(s.background=o)}switch(s.type){case 3:s.program=0!=o[3]?this.renderer.progTBLine:this.renderer.progTLine;break;case 2:s.program=this.renderer.progRLine;break;case 4:s.program=this.renderer.progLine3;break;case 5:s.program=0!=o[3]?this.renderer.progTPBLine:this.renderer.progTPLine}if(s.program.isReady()){if(s.advancedHit){switch(s.type){case 3:s.program2=this.renderer.progETLine;break;case 2:s.program2=this.renderer.progERLine;break;case 4:s.program2=this.renderer.progELine3;break;case 5:s.program2=this.renderer.progETPLine}if(!s.program2.isReady())return}if(s.vertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s.vertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW),s.vertexPositionBuffer.itemSize=4,s.vertexPositionBuffer.numItems=i.length/4,s.vertexNormalBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s.vertexNormalBuffer),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),s.vertexNormalBuffer.itemSize=4,s.vertexNormalBuffer.numItems=r.length/4,s.advancedHit){var h=e.elementBuffer;s.vertexElementBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,s.vertexElementBuffer),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),s.vertexElementBuffer.itemSize=1,s.vertexElementBuffer.numItems=h.length}this.jobs.push(s),this.size+=4*i.length+4*r.length,this.polygons+=i.length/12}},ci.prototype.processReduce=function(e){if(e.reduce){switch(e.reduce[0]){case"tilt":e.reduce[0]=1;break;case"tilt-cos":e.reduce[0]=2;break;case"tilt-cos2":e.reduce[0]=3;break;case"scr-count":e.reduce[0]=4;break;case"scr-count2":e.reduce[0]=5,this.renderer.drawnGeodataTilesUsed=!0;break;case"scr-count3":e.reduce[0]=6,this.renderer.drawnGeodataTilesUsed=!0;break;case"scr-count4":e.reduce[0]=7;break;case"scr-count5":e.reduce[0]=8;break;case"scr-count6":e.reduce[0]=9;break;case"scr-count7":e.reduce[0]=10;break;case"scr-count8":e.reduce[0]=11}e.reduce[5]=0,e.reduce[6]=0,e.reduce[7]=0,e.reduce[0]>=7&&e.reduce[0]<=11&&(10==e.reduce[0]||11==e.reduce[0]?(e.reduce[1]=Math.abs(e.reduce[1]),e.reduce[3]=e.reduce[1]*e.reduce[2],e.reduce[2]=e.reduce[1],e.reduce[4]=0):(e.reduce[2]=Math.abs(e.reduce[1]),this.renderer.config.mapFeaturesReduceFactor>=1||9==e.reduce[0]?e.reduce[1]=e.reduce[2]:e.reduce[1]=Math.floor(Math.log(500*e.reduce[2])/Math.log(1.0017)+5e3)))}},ci.prototype.addLineLabelJob=function(e){var t=this.gl;if(e.singleBuffer)var i=e.singleBuffer,r=e.singleBuffer2;else var s=e.vertexBuffer,a=e.texcoordsBuffer;var n={type:6};n.program=this.renderer.progText,n.color=this.convertColor(e.color),n.color2=this.convertColor(e.color2),n.outline=e.outline,n.zIndex=e["z-index"]+256,n.visibility=e.visibility,n.culling=e.culling,n.clickEvent=e["click-event"],n.hoverEvent=e["hover-event"],n.enterEvent=e["enter-event"],n.leaveEvent=e["leave-event"],n.hitable=e.hitable,n.eventInfo=e.eventInfo,n.state=e.state,n.center=e.center,n.lod=e.lod,n.labelPoints=e.labelPoints,n.labelIndex=e.labelIndex,n.labelSize=e.labelSize,n.zbufferOffset=e["zbuffer-offset"],n.hysteresis=e.hysteresis,n.noOverlap=e.noOverlap,n.labelPointsBuffer={id:-1,points:[],points2:[]},n.id=n.hysteresis?n.hysteresis[2]:null,n.reduced=!1,n.ready=!0,n.bbox=this.bbox,n.reduce=e.reduce,this.processReduce(n),n.files=e.files||[];var o=e.fonts||["#default"];n.fonts=o;for(var h=0,l=o.length;h<l;h++)o[h]=this.renderer.fonts[o[h]];n.program=this.renderer.progText2,n.program.isReady()&&(i?(n.singleBuffer=i,n.singleBuffer2=r,n.textVector=e.textVector,this.polygons+=i.length/12*2):(n.vertexPositionBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n.vertexPositionBuffer),t.bufferData(t.ARRAY_BUFFER,s,t.STATIC_DRAW),n.vertexPositionBuffer.itemSize=4,n.vertexPositionBuffer.numItems=s.length/4,n.vertexTexcoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,n.vertexTexcoordBuffer),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),n.vertexTexcoordBuffer.itemSize=4,n.vertexTexcoordBuffer.numItems=a.length/4,this.size+=4*s.length+4*a.length,this.polygons+=s.length/12),this.jobs.push(n))},ci.prototype.addIconJob=function(e,t,i){var r=this.gl,s=e.vertexBuffer,a=e.texcoordsBuffer,n=e.originBuffer,o=e.singleBuffer,h=e.stick,l=1/255,u={tile:i};if(u.type=t?8:7,u.program=this.renderer.progIcon,u.color=this.convertColor(e.color),u.zIndex=e["z-index"]+256,u.visibility=e.visibility,u.culling=e.culling,u.clickEvent=e["click-event"],u.hoverEvent=e["hover-event"],u.enterEvent=e["enter-event"],u.leaveEvent=e["leave-event"],u.hitable=e.hitable,u.eventInfo=e.eventInfo,u.state=e.state,u.center=e.center,u.stick=[h[0],h[1],h[2],h[3]*l,h[4]*l,h[5]*l,h[6]*l,h[7]],u.lod=e.lod,u.zbufferOffset=e["zbuffer-offset"],u.hysteresis=e.hysteresis,u.noOverlap=e.noOverlap,u.id=u.hysteresis?u.hysteresis[2]:null,u.reduced=!1,u.ready=!0,u.reduce=e.reduce,this.processReduce(u),u.program.isReady()){if(!0!==t){var c=e.icon;u.texture=this.renderer.getBitmap(null,c.filter||"linear",c.tiled||!1,c.hash,!0),u.files=[]}else{u.color2=this.convertColor(e.color2),u.outline=e.outline,u.size=e.size,u.origin=e.origin,u.files=e.files||[],u.index=e.index||0;var d=e.fonts||["#default"];u.fonts=d,u.gamma=[1.4142*u.outline[2]/u.size,1.4142*u.outline[3]/u.size],u.origin&&(u.origin=new Float32Array(u.origin));for(var p=0,f=d.length;p<f;p++)d[p]=this.renderer.fonts[d[p]];u.program=this.renderer.progIcon2}null==u.visibility||Array.isArray(u.visibility)||(u.visibility=[u.visibility]),o?(u.singleBuffer=o,this.polygons+=2):(u.vertexPositionBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,u.vertexPositionBuffer),r.bufferData(r.ARRAY_BUFFER,s,r.STATIC_DRAW),u.vertexPositionBuffer.itemSize=4,u.vertexPositionBuffer.numItems=s.length/4,u.vertexTexcoordBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,u.vertexTexcoordBuffer),r.bufferData(r.ARRAY_BUFFER,a,r.STATIC_DRAW),u.vertexTexcoordBuffer.itemSize=4,u.vertexTexcoordBuffer.numItems=a.length/4,u.vertexOriginBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,u.vertexOriginBuffer),r.bufferData(r.ARRAY_BUFFER,n,r.STATIC_DRAW),u.vertexOriginBuffer.itemSize=3,u.vertexOriginBuffer.numItems=n.length/3,this.size+=4*u.vertexPositionBuffer.numItems+4*u.vertexOriginBuffer.numItems+4*u.vertexTexcoordBuffer.numItems,this.polygons+=u.vertexPositionBuffer.numItems/12),this.subjobs?this.subjobs.push(u):this.vsjobs?this.vsjobs.push(u):this.jobs.push(u)}},ci.prototype.addPack=function(e){if(this.subjobs.length){for(var t={type:9,subjobs:this.subjobs,culling:180,zIndex:0,ready:!0},i=0,r=t.subjobs.length;i<r;i++){var s=t.subjobs[i];if(s.noOverlap){if(t.noOverlap){var a=t.noOverlap,n=s.noOverlap;n[0]<a[0]&&(a[0]=n[0]),n[1]<a[1]&&(a[1]=n[1]),n[2]>a[2]&&(a[2]=n[2]),n[3]>a[3]&&(a[3]=n[3])}else t.noOverlap=s.noOverlap;s.noOverlap=null}s.culling<=t.culling&&(t.culling=s.culling,s.culling=180),s.visibility&&(t.visibility=s.visibility,s.visibility=null),s.stick&&(t.stick=s.stick,s.stick=[0,0,0,255,255,255,255,0]),s.zIndex>t.zIndex&&(t.zIndex=s.zIndex),s.center&&(t.center=s.center),t.eventInfo=s.eventInfo,t.reduce=s.reduce,t.hysteresis=s.hysteresis,t.id=s.id}this.vsjobs?this.vsjobs.push(t):this.jobs.push(t),this.subjobs=null}else this.subjobs=null},ci.prototype.addVSPoint=function(e,t){var i={tile:t,type:10};i.zIndex=e["z-index"]+256,i.visibility=e.visibility,i.culling=e.culling,i.hitable=!1,i.eventInfo=e.eventInfo,i.state=e.state,i.center=e.center,i.lod=e.lod,i.hysteresis=e.hysteresis,i.id=i.hysteresis?i.hysteresis[2]:null,i.reduced=!1,i.ready=!0,i.reduce=e.reduce,i.vswitch=[],this.vsjob=i},ci.prototype.storeVSJobs=function(e){this.vsjob.vswitch.push([e.viewExtent,this.vsjobs]),this.vsjobs=[]},ci.prototype.addVSwitch=function(){this.vsjob&&this.jobs.push(this.vsjob),this.vsjobs=null},ci.prototype.addMeshJob=function(e,t){var i={type:12};if(i.path=e.path,i.textures=[],i.resources=new oi(this.renderer.core.map,null,null),i.path){var r=i.path.split(".");r.length>1&&(r.pop(),i.texturePath=r.join(".")),i.mesh=i.resources.getMesh(i.path,null)}this.jobs.push(i)},ci.prototype.copyBuffer=function(e,t,i){return new Uint8Array(e.buffer).set(new Uint8Array(t.buffer,i,e.byteLength)),e},ci.prototype.addRenderJob2=function(e,t,i,r){var s,a,n,o;if(r)o=r.type,s=r.data;else{var h=new DataView(e.buffer);o=e[t],t+=1,15!=o&&16!=o&&17!=o&&19!=o&&18!=o&&(n=h.getUint32(t),t+=4,a=ni.unint8ArrayToString(new Uint8Array(e.buffer,t,n)),t+=n,s=JSON.parse(a))}switch(o){case 13:case 6:s.type=o,n=h.getUint32(t),t+=4,s.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.vertexBuffer.byteLength,s.advancedHit&&(n=h.getUint32(t),t+=4,s.elementBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.elementBuffer.byteLength),this.addLineJob(s);break;case 8:case 7:case 9:case 10:s.type=o,n=h.getUint32(t),t+=4,s.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.vertexBuffer.byteLength,n=h.getUint32(t),t+=4,s.normalBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.normalBuffer.byteLength,s.advancedHit&&(n=h.getUint32(t),t+=4,s.elementBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.elementBuffer.byteLength),this.addExtentedLineJob(s);break;case 11:n=h.getUint32(t),t+=4,s.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.vertexBuffer.byteLength,n=h.getUint32(t),t+=4,s.texcoordsBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.texcoordsBuffer.byteLength,this.addLineLabelJob(s);break;case 12:n=h.getUint32(t),t+=4,s.singleBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.singleBuffer.byteLength,n=h.getUint32(t),t+=4,s.singleBuffer2=this.copyBuffer(new Float32Array(n),e,t),t+=s.singleBuffer2.byteLength,this.addLineLabelJob(s);break;case 3:case 1:n=h.getUint32(t),t+=4,s.singleBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.singleBuffer.byteLength,this.addIconJob(s,1==o,i);break;case 4:case 2:n=h.getUint32(t),t+=4,s.vertexBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.vertexBuffer.byteLength,n=h.getUint32(t),t+=4,s.originBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.originBuffer.byteLength,n=h.getUint32(t),t+=4,s.texcoordsBuffer=this.copyBuffer(new Float32Array(n),e,t),t+=s.texcoordsBuffer.byteLength,this.addIconJob(s,2==o,i);break;case 5:case 14:n=h.getUint32(t),t+=4,s.geometryBuffer=this.copyBuffer(new Float64Array(n),e,t),t+=s.originBuffer.byteLength,n=h.getUint32(t),t+=4,s.indicesBuffer=this.copyBuffer(new Uint32Array(n),e,t),t+=s.indicesBuffer.byteLength,n=h.getUint32(t),t+=4,this.addGeometry(s);break;case 15:this.subjobs=[],t+=4;break;case 16:this.addPack(),t+=4;break;case 20:this.addVSPoint(s,i);break;case 17:this.vsjobs=[],this.vsjob=null,t+=4;break;case 19:this.addVSwitch(),t+=4;break;case 18:s={viewExtent:h.getUint32(t)},t+=4,this.storeVSJobs(s);break;case 21:var l=s;if(l.nodes=[],l.jobs=[],l.parent=this.currentNode,l.volume){var u=l.volume.points,c=[u[0][0],u[0][1],u[0][2],u[1][0],u[1][1],u[1][2],u[2][0],u[2][1],u[2][2],u[3][0],u[3][1],u[3][2],u[4][0],u[4][1],u[4][2],u[5][0],u[5][1],u[5][2],u[6][0],u[6][1],u[6][2],u[7][0],u[7][1],u[7][2]];l.volume.points2=c}this.rootNode?(this.currentNode.nodes.push(l),this.currentNode=l):(this.rootNode=l,this.currentNode=l,this.oldJobs=this.jobs),this.jobs=l.jobs;break;case 22:this.currentNode.parent?(this.currentNode=this.currentNode.parent,this.jobs=this.currentNode.jobs):(this.currentNode=this.currentNode.parent,this.jobs=this.oldJobs);break;case 23:this.addMeshJob(s,i);break;case 24:this.currentNode&&(this.currentNode.path=s.path)}return t},ci.prototype.addRenderJob=function(e,t){switch(e.type){case"polygon":case"flat-line":this.addLineJob(e);break;case"flat-tline":case"flat-rline":case"pixel-line":case"pixel-tline":this.addExtentedLineJob(e);break;case"line-label":this.addLineLabelJob(e);break;case"icon":this.addIconJob(e);break;case"label":this.addIconJob(e,!0,t);break;case"point-geometry":case"line-geometry":this.addGeometry(e);break;case"pack-begin":this.subjobs=[];break;case"pack-end":this.addPack();break;case"vspoint":this.addVSPoint(e,t);break;case"vswitch-begin":this.vsjobs=[],this.vsjob=null;break;case"vswitch-store":this.storeVSJobs(e);break;case"vswitch-end":this.addVSwitch();break;case"node-begin":this.nodeBegin();break;case"node-end":this.nodeEnd();break;case"mesh":this.addMesh()}},ci.prototype.getNodeLOD=function(e){for(var t=0;e.parent;)t++,e=e.parent;return t},ci.prototype.getNodeTexelSize=function(e,t){var i=e.volume.center,r=this.renderer.cameraPosition,s=ii.length([i[0]-r[0],i[1]-r[1],i[2]-r[2]]);return(s-=e.volume.radius)<=0?[Number.POSITIVE_INFINITY,.1]:[this.renderer.camera.scaleFactor2(s)*t,s]},ci.prototype.drawNodeVolume=function(e,t){var i=this.renderer;di({points:[e[0],e[1],e[2],e[3],e[0],e[4],e[5],e[6],e[7],e[4]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},i),di({points:[e[1],e[5]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},i),di({points:[e[2],e[6]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},i),di({points:[e[3],e[7]],size:1,color:t,depthTest:!1,screenSpace:!1,blend:!1},i)},ci.prototype.drawNode=function(e,t,i,r){var s=this.renderer,a=this.map.draw.debug,n=e.jobs;if(s.drawnNodes++,a.drawNBBoxes){var o=e.volume.points,h=[255,0,255,255];e.tileset&&(h=[0,255,0,255]),t&&(h=[255,255,0,255]),a.drawSpaceBBox&&e.volume2?this.drawNodeVolume(e.volume2.points,[255,0,0,255]):this.drawNodeVolume(o,h);var l=this.renderer.cameraPosition,u=e.volume.center,c=[l[0]-u[0],l[1]-u[1],l[2]-u[2]];ii.normalize(c),ii.scale(c,e.volume.radius),u=[u[0]+c[0]-l[0],u[1]+c[1]-l[1],u[2]+c[2]-l[2]],u=this.renderer.core.getRendererInterface().getCanvasCoords(u,this.renderer.camera.getMvpMatrix());if(a.drawLods&&(f=""+e.lod,s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]-8),8,f,[1,0,0,1],u[2])),a.drawOctants&&(f=""+e.index,s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+6),8,f,[1,1,0,1],u[2])),a.drawDistance){var d=this.getNodeTexelSize(e,e.precision*s.curSize[0]);f=d[1].toFixed(2)+" "+d[0].toFixed(2)+" "+e.precision.toFixed(3),s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+34),8,f,[.5,.5,1,1],u[2])}if(a.drawFaceCount)(p=n[0]&&12==n[0].type?n[0].mesh:null)&&(f=p.faces+" - "+p.submeshes.length,s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+20),8,f,[0,1,0,1],u[2]));if(a.drawResources&&n[0]&&(f=(this.getGpuSize(n[0])/1048576).toFixed(2)+"MB",s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+6),8,f,[0,1,0,1],u[2])),a.drawSurfaces&&n[0]){var p,f="";if(p=n[0]&&12==n[0].type?n[0].mesh:null){var g=p.mapLoaderUrl,m=(g=g.replace(".mesh","")).split("/");f=m.length>1?m[m.length-2]+"/"+m[m.length-1]:m[0]}s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+20),8,f,[0,1,0,1],u[2])}if(a.drawTextureSize)if(p=n[0]&&12==n[0].type?n[0].mesh:null){var v=p.submeshes;for(x=0,w=v.length;x<w;x++){var y;if(v[x].internalUVs){if(y=n[0].direct?v[x].texture:n[0].textures[x]){var b=y.getGpuTexture();b&&(f="["+x+"]: "+b.width+" x "+b.height,s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+2*(17+4*x*2)),8,f,[1,1,1,1],u[2]))}}else f="["+x+"]: 256 x 256",s.draw.drawText(Math.round(u[0]-.5*s.draw.getTextSize(8,f)),Math.round(u[1]+2*(17+4*x*2)),8,f,[1,1,1,1],u[2])}}}for(var x=0,w=n.length;x<w;x++){var M=n[x];switch(M.type){case 12:this.isMeshReady(M,null,null,null,!0,e)&&this.drawMesh(M,e,i,r);break;case 13:M.pointcloud.isReady()&&M.pointcloud.draw(this.renderer.cameraPosition)}}},ci.prototype.isMeshReady=function(e,t,i,r,s,a){var n=e.mesh,o=n.submeshes,h=!0,l=this.map.stats;if(n.isReady(t,i,r)){s||(l.gpuNeeded+=n.gpuSize);for(var u=0,c=o.length;u<c;u++){var d=o[u];if(d.internalUVs){var p;if(e.direct){if(!d.texture){g=(g=n.mapLoaderUrl).replace(".mesh","-"+u+".jpg");var f=new oi(this.renderer.core.map,null,null);d.texture=f.getTexture(g,0,null,null,null,!0)}p=d.texture}else{if(!e.texturePath)continue;if(!e.textures[u]){var g=e.texturePath+"-"+u+".jpg";e.textures[u]=e.resources.getTexture(g,0,null,null,null,!0)}p=e.textures[u]}p.isReady(t,i,r)||(h=!1),s||(l.gpuNeeded+=p.getGpuSize())}}}else h=!1;return h},ci.prototype.getGpuSize=function(e){var t=e.mesh;if(!t)return 0;var i=t.submeshes,r=0;if(t.isReady(!0)){r+=t.gpuSize;for(var s=0,a=i.length;s<a;s++){i[s].internalUVs&&e.texturePath&&e.textures[s]&&(r+=e.textures[s].getGpuSize())}}return r},ci.prototype.drawMesh=function(e,t,i,r){for(var s=e.mesh,a=s.submeshes,n=this.renderer.cameraPosition,o=0,h=a.length;o<h;o++){var l=a[o];e.direct?l.texture&&s.drawSubmesh(n,o,l.texture,4,null,null,null,i,r):e.textures[o]&&s.drawSubmesh(n,o,e.textures[o],4,null,null,null,i,r)}},ci.prototype.generateNode=function(e,t,i,r,s,a,n,o,h){var l=[];if(h)if(t.vtsFormat)for(var u=0,c=t.features.length;u<c;u++){var d=t.features[u];switch(d.type){case 1:l.push({type:12,mesh:d.resources[e],direct:!0});break;case 2:l.push({type:13,pointcloud:d.resources[e],direct:!0})}}else l=[{type:12,mesh:t.meshes[e],direct:!0}];return{lod:i,index:r,precision:s,volume:{points:a,center:n,radius:o},jobs:l}},ci.prototype.traverseBinNode=function(e,t,i,r,s,a,n,o,h,l,u){var c=this.renderer,d=this.renderer.cameraPosition;if(h||c.camera.pointsVisible2(t,d)){var p=9*n,f=o.tree,g=(o.vtsFormat,this.getBinNodeTexelSize(i,r,s*c.curSize[0])),m=f[p],v=268435455&m;if(m&1<<31){var y=o.pathTable;if(2!=y[v])return;var b=y[v+1]|y[v+2]<<8|y[v+3]<<16;n=0,v=268435455&(m=(f=(o=this.binFiles[b]).tree)[p=0])}var x=0!=v;//!!!!!!!!!!!!!!!! DEBUG
if(o.vtsFormat&&(x=!0),this.map.config.mapTraverseToMeshNode=!1,1==this.loadMode){var w=a*g[1];if(!(f[p+1]||f[p+2]||f[p+3]||f[p+4]||f[p+5]||f[p+6]||f[p+7]||f[p+8])||g[0]<=this.map.draw.texelSizeFit&&(x||!this.map.config.mapTraverseToMeshNode)){if(!u&&this.isBinNodeReady(t,i,n,o,null,w,null,!0)){var M=this.generateNode(n,o,a,e,s,t,i,r,x);this.drawNode(M)}}else{var S,A,C,T=[0,0,0,0,0,0,0,0],P=[],F=[],L=!1,E=0,k=this.map.config.mapSplitLods,N=(a+1)*g[1],I=[.5*(t[2][0]-t[1][0]),.5*(t[2][1]-t[1][1]),.5*(t[2][2]-t[1][2])],B=[.5*(t[1][0]-t[0][0]),.5*(t[1][1]-t[0][1]),.5*(t[1][2]-t[0][2])],R=[.5*(t[0][0]-t[4][0]),.5*(t[0][1]-t[4][1]),.5*(t[0][2]-t[4][2])];R[0]=-R[0],R[1]=-R[1],R[2]=-R[2];for(var z=0,U=8;z<U;z++){if(V=f[p+1+z]){var D=9*V;switch(z){case 0:S=-1,A=-1,C=-1;break;case 1:S=0,A=-1,C=-1;break;case 2:S=-1,A=0,C=-1;break;case 3:S=0,A=0,C=-1;break;case 4:S=-1,A=-1,C=0;break;case 5:S=0,A=-1,C=0;break;case 6:S=-1,A=0,C=0;break;case 7:S=0,A=0,C=0}var _=[i[0]+B[0]*S+I[0]*A+R[0]*C,i[1]+B[1]*S+I[1]*A+R[1]*C,i[2]+B[2]*S+I[2]*A+R[2]*C],O=[[_[0],_[1],_[2]],[_[0]+B[0],_[1]+B[1],_[2]+B[2]],[_[0]+B[0]+I[0],_[1]+B[1]+I[1],_[2]+B[2]+I[2]],[_[0]+I[0],_[1]+I[1],_[2]+I[2]],[_[0]+R[0],_[1]+R[1],_[2]+R[2]],[_[0]+B[0]+R[0],_[1]+B[1]+R[1],_[2]+B[2]+R[2]],[_[0]+B[0]+I[0]+R[0],_[1]+B[1]+I[1]+R[1],_[2]+B[2]+I[2]+R[2]],[_[0]+I[0]+R[0],_[1]+I[1]+R[1],_[2]+I[2]+R[2]]],G=[(O[0][0]+O[1][0]+O[2][0]+O[3][0]+O[4][0]+O[5][0]+O[6][0]+O[7][0])/8,(O[0][1]+O[1][1]+O[2][1]+O[3][1]+O[4][1]+O[5][1]+O[6][1]+O[7][1])/8,(O[0][2]+O[1][2]+O[2][2]+O[3][2]+O[4][2]+O[5][2]+O[6][2]+O[7][2])/8];if(P[z]=O,F[z]=G,k)this.getBinNodeTexelSize(G,.5*r,.5*s*c.curSize[0])[0]<=this.map.draw.texelSizeFit?f[D]|=1<<29:f[D]&=~(1<<29);if(!c.camera.pointsVisible2(O,d)){f[D]&=~(1<<30);continue}f[D]|=1<<30,!this.isBinNodeReady(O,G,V,o,null,N,!0,u)||k&&f[p]&1<<29?(L=!0,T[z]=1):E++}}for(z=0,U=8;z<U;z++){var V;if(V=f[p+1+z])if(f[D=9*V]&1<<30&&!(k&&f[D]&1<<29)){var j=u||1==T[z];this.traverseBinNode(z,P[z],F[z],.5*r,.5*s,a+1,V,o,!0,null,j)}}if(L&&!u&&this.isBinNodeReady(t,i,n,o,null,w,null,!0)){M=this.generateNode(n,o,a,e,s,t,i,r,x);E>0?this.drawNode(M,null,T,t):this.drawNode(M)}}}}},ci.prototype.getPath=function(e,t){for(var i="";0!=e[t];)(i+=String.fromCharCode(e[t++])).length;return i},ci.prototype.isBinNodeReady=function(e,t,i,r,s,a,n,o){var h=!0,l=r.tree,u=9*i,c=l[u],d=268435455&c;if(c&1<<31){var p=r.pathTable;if(2!=p[d]){if(0==p[d]){p[d]=1,this.binFiles.push({});var f=this.getPath(p,d+4);if(f=li.getProcessUrl(f,this.rootPath),ui){var g=new MapGeodataImport3DTiles2;g.navSrs=this.map.getNavigationSrs(),g.physSrs=this.map.getPhysicalSrs(),g.srs=g.navSrs,g.loadJSON(f+".json",{index:this.binFiles.length-1,nodeFile:r.index,nodeOffset:d,root:!1},this.onBinFileLoaded.bind(this))}else this.map.loader.processLoadBinary(f+".json",this.onBinFileLoaded.bind(this,{index:this.binFiles.length-1,nodeFile:r.index,nodeOffset:d,root:!1}),null,"text","direct-3dtiles",{root:!1})}return!1}var m=p[d+1]|p[d+2]<<8|p[d+3]<<16;i=0,d=268435455&(c=(l=(r=this.binFiles[m]).tree)[u=0])}var v=0!=d;if(r.vtsFormat&&(v=!0),v)if(r.vtsFormat)for(var y=0,b=r.features.length;y<b;y++){var x=r.features[y];switch(x.type){case 1:break;case 2:var w=x.resources[i];if(!w&&x.indices){f=li.getProcessUrl(x.uri,this.rootPath);w=(M=new oi(this.renderer.core.map,null,null)).getPointCloud(f,null,x.indices[i]-1,x.indices[i+1]-x.indices[i]),x.resources[i]=w,w.transform=[e[0][0],e[0][1],e[0][2],Math.abs(e[1][0]-e[0][0])]}w.isReady(s,a,n)||(h=!1)}}else{if(!r.meshes[i]){f=this.getPath(r.pathTable,d);f=li.getProcessUrl(f,this.rootPath);var M=new oi(this.renderer.core.map,null,null);r.meshes[i]=M.getMesh(f+".mesh",null)}var S={mesh:r.meshes[i],direct:!0};this.isMeshReady(S,s,a,n,o)||(h=!1)}return h},ci.prototype.getBinNodeTexelSize=function(e,t,i){var r=this.renderer.cameraPosition,s=ii.length([e[0]-r[0],e[1]-r[1],e[2]-r[2]]);return(s-=t)<=0?[Number.POSITIVE_INFINITY,.1]:[this.renderer.camera.scaleFactor2(s)*i*.5,s]},ci.prototype.onBinFileLoaded=function(e,t){var i=this.binFiles[e.index];if(i.loadState=2,i.tree=t.bintree,i.pathTable=t.pathTable,i.rootSize=t.rootSize,i.index=e.index,this.map.stats.octoNodes+=t.totalNodes,this.map.stats.octoNodesMemSize+=i.tree.byteLength+16+32+24,t.vtsFormat){var r=this.renderer.cameraPosition,s=this.renderer.cameraDistance,a=this.renderer.cameraVector,n=[r[0]+a[0]*s,r[1]+a[1]*s,r[2]+a[2]*s];ii.add(t.center,n),ii.add(t.points[0],n),ii.add(t.points[1],n),ii.add(t.points[2],n),ii.add(t.points[3],n),ii.add(t.points[4],n),ii.add(t.points[5],n),ii.add(t.points[6],n),ii.add(t.points[7],n),i.vtsFormat=t.vtsFormat,i.features=t.features;for(var o=0,h=i.features.length;o<h;o++){var l=i.features[o];l.resources=new Array(t.totalNodes),this.map.stats.octoNodesMemSize+=4*l.resources.length+l.indices?l.indices.byteLength:0}}else i.meshes=new Array(t.totalNodes),this.map.stats.octoNodesMemSize+=i.pathTable.byteLength+4*i.meshes.length;if(e.nodeOffset){var u=this.binFiles[e.nodeFile].pathTable;u[e.nodeOffset]=2,u[e.nodeOffset+1]=255&e.index,u[e.nodeOffset+2]=e.index>>8&255,u[e.nodeOffset+3]=e.index>>16&255}e.root&&(this.rootPoints=t.points,this.rootCenter=t.center,this.rootRadius=t.radius,this.rootTexelSize=t.texelSize),this.renderer.core.map.dirty=!0},ci.prototype.draw=function(e,t,i,r,s){if(null==this.id||!1!==this.renderer.layerGroupVisible[this.id]){var a=this.renderer,n=[[a.geoRenderCounter,e,t,this]],o=a.core.map;if(this.map=o,this.binPath){if(0==this.binFiles.length){var h;if(this.binFiles.push({loadState:1}),this.rootPath=li.makeAbsolute(this.binPath),this.rootPath=li.getBase(this.rootPath),ui=!0)if(-1!=this.binPath.indexOf(".json"))(h=new MapGeodataImport3DTiles2).navSrs=this.map.getNavigationSrs(),h.physSrs=this.map.getPhysicalSrs(),h.srs=h.navSrs,h.loadJSON(li.makeAbsolute(this.binPath),{index:0,root:!0},this.onBinFileLoaded.bind(this));else(h=new hi).load(li.makeAbsolute(this.binPath),{index:0,root:!0},this.onBinFileLoaded.bind(this));else o.loader.processLoadBinary(li.makeAbsolute(this.binPath),this.onBinFileLoaded.bind(this,{index:0,root:!0}),null,"text","direct-3dtiles",{root:!0});return}if(1==this.binFiles[0].loadState)return;switch(a.drawnNodes=0,this.map.config.mapLoadMode){case"topdown":this.loadMode=1;break;case"fit":this.loadMode=2;break;case"fitonly":this.loadMode=3}var l=this.binFiles[0];this.traverseBinNode(0,this.rootPoints,this.rootCenter,this.rootRadius,this.rootTexelSize,0,0,l,null,null,null)}if(i){var u=ri.create(),c=ri.create(),d=this.renderer.position,p=this.origin;p=[p[0]-d[0],p[1]-d[1],p[2]],ri.multiply(e,ai.translationMatrix(p[0],p[1],p[2]),c),ri.multiply(t,c,u),e=c,t=u}for(var f=a.cameraPosition,g=a.jobZBuffer,m=a.jobZBufferSize,v=(a.jobZBuffer2,a.jobZBuffer2Size,a.onlyHitLayers),y=0,b=this.jobs.length;y<b;y++){var x=this.jobs[y];if((7==x.type||8==x.type)&&x.visibility>0){var w=x.center;if(ii.length([w[0]-f[0],w[1]-f[1],w[2]-f[2]])>x.visibility)continue}if(!v||x.hitable){x.mv=e,x.mvp=t,x.renderCounter=n,x.tiltAngle=r,x.texelSize=s;var M=x.zIndex;g[M][m[M]]=x,m[M]++}}}};var pi=ci,fi=function(e,t){this.layer=e,this.map=e.map,this.renderer=this.map.renderer,this.killed=!1,this.listener=t,this.busy=!1,this.ready=!0,this.waitingForStylesheet=!1,this.stylesheet=null,this.fonts={},this.processCounter=0;var r=i(13);this.processWorker=new r,this.processWorker.onerror=function(e){throw new Error(e.message+" ("+e.filename+":"+e.lineno+")")},this.processWorker.onmessage=this.onMessage.bind(this),this.processWorker.postMessage({command:"config",data:this.map.config})};fi.prototype.kill=function(){this.killed||(this.killed=!0,null!=this.processWorker&&this.processWorker.terminate())},fi.prototype.isReady=function(){return this.waitingForStylesheet&&(this.waitingForStylesheet=!this.stylesheet.isReady()),(this.ready&&!this.busy||this.killed)&&!this.waitingForStylesheet},fi.prototype.onMessage=function(e,t){if(!this.killed){t||(e=e.data);var i=e.command;if("ready"==i)this.ready=!0;else if("styleDone"==i)this.busy=!1;else if("loadBitmaps"==i){var r=e.bitmaps;for(var s in r){var a=r[s];this.renderer.getBitmap(a.url,a.filter||"linear",a.tiled||!1,a.hash,!0)}}if(null!=this.listener){if("packed-events"==i){for(var n=e.messages,o=0,h=n.length;o<h;o++)this.onMessage(n[o],!0);return}this.listener(i,e)}}},fi.prototype.setListener=function(e){this.listener=e},fi.prototype.sendCommand=function(e,t,i,r){if(!this.killed){this.ready=!1;var s={command:e,data:t};i&&i.id&&(s.lod=i.id[0],s.ix=i.id[1],s.iy=i.id[2],i.metanode&&(s.tileSize=Math.tan(i.metanode.diskAngle2A)*i.metanode.diskDistance,s.pixelSize=.70710678118*s.tileSize/i.metanode.displaySize)),r&&(s.dpr=r),this.processWorker.postMessage(s)}},fi.prototype.setStylesheet=function(e,t){if(this.stylesheet=e,e.isReady()){this.busy=!0;var i=96*(window.devicePixelRatio||1),r=this.map.config,s=r.mapFeaturesReduceParams,a=function(e){return void 0!==e},n=r.mapFeaturesReduceMode;switch(n){case"scr-count1":case"scr-count2":s?(s[0]=a(s[0])?s[0]:1,s[1]=a(s[1])?s[1]:50,s[2]=a(s[2])?s[2]:0):s=[1,50,0],r.mapFeaturesSortByTop="scr-count2"==n;break;case"scr-count4":s?(s[0]=a(s[0])?s[0]:.18,s[1]=a(s[1])?s[1]:0,s[2]=a(s[2])?s[2]:1):s=[.18,0,0],r.mapFeaturesSortByTop=!0;break;case"scr-count5":s?(s[0]=a(s[0])?s[0]:2,s[1]=a(s[1])?s[1]:1,s[2]=a(s[2])?s[2]:1):s=[2,1,0],r.mapFeaturesSortByTop=!0;break;case"scr-count6":case"scr-count7":s?(s[0]=a(s[0])?s[0]:.2,s[1]=a(s[1])?s[1]:0,s[2]=a(s[2])?s[2]:"scr-count6"==n?1:2,s[3]=a(s[3])?s[3]:1,s[4]=a(s[4])?s[4]:1,s[5]=i,r.mapFeaturesSortByTop=!0):s=[.2,0,"scr-count6"==n?1:2,1,1];break;case"scr-count8":s?(s[0]=a(s[0])?s[0]:.2,s[1]=a(s[1])?s[1]:.6,s[2]=a(s[2])?s[2]:11,s[3]=a(s[3])?s[3]:1,s[4]=a(s[4])?s[4]:1e3,s[5]=a(s[5])?s[5]:5,s[6]=i,r.mapFeaturesSortByTop=!0):s=[.2,.6,11,1,1e3,5]}r.mapFeaturesReduceParams=s,r.mapFeaturesReduceFactor=s[2],r.mapFeaturesReduceFactor2=s[3],r.mapFeaturesReduceFactor3=s[4],this.sendCommand("setStylesheet",{data:e.data,geocent:!this.map.getNavigationSrs().isProjected(),metric:r.mapMetricUnits,language:r.mapLanguage,reduceMode:n,reduceParams:r.mapFeaturesReduceParams,log:r.mapLogGeodataStyles});var o=e.fonts,h={};for(var l in o){var u=o[l],c=this.renderer.fonts[u];h[l]=u,c&&this.setFont(u,c)}this.processCounter++,this.sendCommand("setFontMap",{map:h})}else this.waitingForStylesheet=!0},fi.prototype.setFont=function(e,t){this.fonts[e]||(this.fonts[e]=t,this.sendCommand("setFont",{url:e,data:t.data},[t.data]))};var gi=fi,mi=s.b,vi=p.a,yi=a.a,bi=pi,xi=gi,wi=function(e,t,i){if(this.map=e,this.stats=e.stats,this.geodata=t,this.gpu=this.map.renderer.gpu,this.renderer=this.map.renderer,this.gpuGroups=[],this.currentGpuGroup=null,this.tile=i.tile,this.surface=i.surface,this.surface.geodataProcessor)this.surface.styleChanged&&(this.surface.geodataProcessor.setStylesheet(this.surface.stylesheet),this.surface.styleChanged=!1);else{var r=new xi(this,this.onGeodataProcessorMessage.bind(this));r.setStylesheet(this.surface.stylesheet),this.surface.geodataProcessor=r,this.map.geodataProcessors.push(r)}this.geodataProcessor=this.surface.geodataProcessor,this.processing=!1,this.statsCounter=0,this.size=0,this.killed=!1,this.killedByCache=!1,this.ready=!1,this.isReady()};wi.prototype.kill=function(){this.killed=!0,this.geodata=null,this.killGeodataView(!1)},wi.prototype.killGeodataView=function(e){this.killedByCache=e;for(var t=0,i=this.gpuGroups.length;t<i;t++)this.gpuGroups[t].kill();this.gpuGroups=[],!0!==e&&null!=this.gpuCacheItem&&this.map.gpuCache.remove(this.gpuCacheItem),this.stats.gpuGeodata-=this.size,this.stats.graphsFluxGeodata[1][0]++,this.stats.graphsFluxGeodata[1][1]+=this.size,this.ready=!1,this.size=0,this.gpuCacheItem=null},wi.prototype.processPackedCommands=function(e,t){var i,r,s,a=e.byteLength,n=this.map.config.mapMaxGeodataProcessingTime,o=performance.now(),h=new DataView(e.buffer);do{var l=e[t];switch(t+=1,l){case 9:t+=1,i=h.getUint32(t),t+=4,r=yi.unint8ArrayToString(new Uint8Array(e.buffer,t,i)),t+=i,s=JSON.parse(r),this.currentGpuGroup=new bi(s.id,s.bbox,s.origin,this.gpu,this.renderer),this.gpuGroups.push(this.currentGpuGroup);break;case 10:this.size+=this.currentGpuGroup.size,t+=5;break;case 5:t=this.currentGpuGroup.addRenderJob2(e,t,this.tile);break;case 7:this.map.markDirty(),this.gpuCacheItem=this.map.gpuCache.insert(this.killGeodataView.bind(this,!0),this.size),this.stats.gpuGeodata+=this.size,this.stats.graphsFluxGeodata[0][0]++,this.stats.graphsFluxGeodata[0][1]+=this.size,this.ready=!0,this.processing=!1,t+=5}if(performance.now()-o>n&&t<a)return t}while(t<a);return this.stats.renderBuild+=performance.now()-o,-1},wi.prototype.onGeodataProcessorMessage=function(e,t,i){if(!this.killed&&!this.killedByCache)switch(e){case"addPackedCommands":if(i){var r=this.processPackedCommands(t.buffer,t.index);if(!(r<0))return t.index=r,-123;this.map.markDirty()}else t.index=0,this.map.markDirty(),this.map.addProcessingTask2(this.onGeodataProcessorMessage.bind(this,e,t,!0));break;case"ready":if(this.geodataProcessor.processCounter>0&&(this.geodataProcessor.processCounter--,this.geodataProcessor.processCounter>0)){this.map.markDirty();break}t.geodata&&(this.geodata.geodata=t.geodata),this.geodataProcessor.busy=!1,this.map.markDirty()}},wi.prototype.directParseNode=function(e,t){this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:21,data:{volume:e.volume,precision:e.precision,tileset:e.tileset}});var i,r,s=e.meshes||[];for(i=0,r=s.length;i<r;i++)this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:23,data:{path:s[i]}});var a=e.nodes||[];for(i=0,r=a.length;i<r;i++)this.directParseNode(a[i],t+1);var n=e.loadNodes||[];for(i=0,r=n.length;i<r;i++)this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:24,data:{path:n[i]}});this.currentGpuGroup.addRenderJob2(null,null,this.tile,{type:22,data:{}})},wi.prototype.directParse=function(e){if(e)for(var t=e.nodes||[],i=0,r=t.length;i<r;i++)this.currentGpuGroup=new bi(null,null,null,this.gpu,this.renderer),this.gpuGroups.push(this.currentGpuGroup),this.directParseNode(t[i],0),this.size+=this.currentGpuGroup.size},wi.prototype.directBinParse=function(e){this.currentGpuGroup=new bi(null,null,null,this.gpu,this.renderer),this.gpuGroups.push(this.currentGpuGroup),this.currentGpuGroup.binPath=e},wi.prototype.isReady=function(e,t,i){if(this.killed)return!1;var r=this.map.stats.gpuRenderUsed>=this.map.draw.maxGpuUsed;if(e=e||r,!this.ready&&!this.processing&&!e&&this.surface.stylesheet.isReady()&&this.geodata.isReady(e,t,i,this.surface.options.fastParse)&&this.geodataProcessor.isReady())if(this.surface.options.fastParse)"object"==typeof this.geodata.geodata?this.geodata.geodata.binPath?this.directBinParse(this.geodata.geodata.binPath):this.directParse(this.geodata.geodata):this.directParse(JSON.parse(this.geodata.geodata)),this.map.markDirty(),this.ready=!0;else{var s=this.geodata.geodata;this.processing=!0,this.killedByCache=!1,this.geodataProcessor.setListener(this.onGeodataProcessorMessage.bind(this)),this.map.config.mapGeodataBinaryLoad&&"string"!=typeof s?this.geodataProcessor.sendCommand("processGeodataRaw",s,this.tile,window.devicePixelRatio||1,[s]):this.geodataProcessor.sendCommand("processGeodata",s,this.tile,window.devicePixelRatio||1),this.geodataProcessor.busy=!0}return!e&&this.gpuCacheItem&&this.map.gpuCache.updateItem(this.gpuCacheItem),this.ready},wi.prototype.getWorldMatrix=function(e,t,i){var r=i;return null!=r?(r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=e.min[0]-t[0],r[13]=e.min[1]-t[1],r[14]=e.min[2]-t[2],r[15]=1):(r=mi.create(),mi.multiply(vi.translationMatrix(e.min[0]-t[0],e.min[1]-t[1],e.min[2]-t[2]),vi.scaleMatrix(1,1,1),r)),r},wi.prototype.draw=function(e){if(this.ready){for(var t=this.renderer,i=this.tile?Math.abs(this.tile.tiltAngle):t.cameraTiltFator,r=(t.useSuperElevation,0),s=this.gpuGroups.length;r<s;r++){var a=this.gpuGroups[r];if(a.rootNode||a.binPath)a.draw(o,n,null,i,this.tile?this.tile.texelSize:1);else if(a.jobs.length||a.rootNode){var n=a.mvp,o=a.mv,h=n;mi.multiply(t.camera.getModelviewFMatrix(),this.getWorldMatrix(a.bbox,e,h),o);var l=t.camera.getProjectionFMatrix();mi.multiply(l,o,n),a.draw(o,n,null,i,this.tile?this.tile.texelSize:1),this.stats.drawnFaces+=a.polygons,this.stats.drawCalls+=a.jobs.length}}this.statsCoutner!=this.stats.counter&&(this.statsCoutner=this.stats.counter,this.stats.gpuRenderUsed+=this.size)}return this.ready};var Mi=wi,Si=Mi,Ai=a.a,Ci=function(e,t){this.map=e,this.config=e.config,this.isProjected=this.map.getNavigationSrs().isProjected(),this.stats=e.stats,this.draw=t,this.debug=t.debug,this.core=e.core,this.camera=e.camera,this.renderer=e.renderer,this.getTextSize=this.renderer.draw.getTextSize.bind(this.renderer.draw),this.drawText=this.renderer.draw.drawText.bind(this.renderer.draw)};Ci.prototype.drawSurfaceTile=function(e,t,i,r,s,a,n,o){if(this.stats.gpuRenderUsed>=this.draw.maxGpuUsed)return!1;if(e.renderReady=!1,e.surface){if(t.hasGeometry()){if(this.debug.drawBBoxes&&!a&&(!e.surface.geodata&&this.debug.drawGeodataOnly||this.drawTileInfo(e,t,i,e.surfaceMesh,r)),this.debug.heightmapOnly&&!a)return e.surface.geodata||e.drawGrid(i),!0;if(!a&&(this.stats.renderedLods[e.id[0]]++,this.stats.drawnTiles++,e.surface.geodata&&this.renderer.drawnGeodataTilesUsed)){var h=this.renderer.project2([.25*(t.bbox2[12]+t.bbox2[15]+t.bbox2[18]+t.bbox2[21])-i[0],.25*(t.bbox2[13]+t.bbox2[16]+t.bbox2[19]+t.bbox2[22])-i[1],.25*(t.bbox2[14]+t.bbox2[17]+t.bbox2[20]+t.bbox2[23])-i[2]],this.camera.getMvpMatrix());h[0]<0||h[1]<0||h[0]>this.renderer.curSize[0]||h[1]>this.renderer.curSize[1]||(this.stats.drawnGeodataTilesPerLayer++,this.stats.drawnGeodataTilesFactor+=Math.pow(Math.abs(e.tiltAngle*e.texelSize),.5)),this.stats.drawnGeodataTiles++}var l=0;do{if(e.resetDrawCommands){if(e.drawCommands=[[],[],[]],e.updateBounds=!0,e.bounds)for(var u in e.bounds)e.bounds[u].viewCoutner=0;e.resetDrawCommands=!1}var c;if(c=e.surface.geodata?this.drawGeodataTile(e,t,i,r,s,a,n,o):this.drawMeshTile(e,t,i,r,s,a,n,o),++l>10)break}while(e.resetDrawCommands);return c}return!0}if(!a&&e.lastRenderState){var d=this.draw.drawChannel;return this.draw.processDrawCommands(i,e.lastRenderState.drawCommands[d],s,!0,e),this.map.applyCredits(e),!0}},Ci.prototype.drawMeshTile=function(e,t,i,r,s,a,n,o){var h;if(!e.surfaceMesh){if(e.resourceSurface.virtual)return!0;h=e.resourceSurface.getMeshUrl(e.id),e.surfaceMesh=e.resources.getMesh(h,e)}var l,u,c,d=this.draw,p=d.drawChannel,f=!1;if(e.drawCommands[p].length>0&&this.draw.areDrawCommandsReady(e.drawCommands[p],s,n,o))return a||(d.processDrawCommands(i,e.drawCommands[p],s,null,e),this.map.applyCredits(e)),e.lastRenderState=null,!0;if(e.lastRenderState)if(e.surfaceMesh.isReady(!0,s,o)&&e.drawCommands[p].length>0){if(this.draw.areDrawCommandsReady(e.lastRenderState.drawCommands[p],s,n,o))return a||(d.processDrawCommands(i,e.lastRenderState.drawCommands[p],s,!0,e),this.map.applyCredits(e)),!0}else this.draw.areDrawCommandsReady(e.lastRenderState.drawCommands[p],s,n,o)&&(a||(d.processDrawCommands(i,e.lastRenderState.drawCommands[p],s,!0,e),this.map.applyCredits(e)),f=!0);if(e.drawCommands[p].length>0)return!(!this.config.mapHeightfiledWhenUnloaded||a)&&(e.drawGrid(i),!1);if(e.surfaceMesh.isReady(n,s,o)&&!n){var g=e.surfaceMesh.submeshes;e.drawCommands=[[],[],[]],e.imageryCredits={},e.boundsDebug={};var m,v,y,b,x,w,M,S=0;if((M=e.resourceSurface)||(M=e.surface),M.glue){var A=M.id;for(m=0,v=A.length;m<v;m++){var C=this.map.getSurface(A[m]);C&&(S=Math.max(S,C.specificity))}for(x=0,w=t.credits.length;x<w;x++)e.glueImageryCredits[t.credits[x]]=S}else for(S=M.specificity,x=0,w=t.credits.length;x<w;x++)e.imageryCredits[t.credits[x]]=S;for(m=0,v=g.length;m<v;m++){var T=g[m];if(this.debug.drawBBoxes&&this.debug.drawMeshBBox&&!a&&T.drawBBox(i),T.externalUVs){if(e.updateBounds&&(e.updateBounds=!1,this.updateTileBounds(e,g)),M=e.resourceSurface,e.resourceSurface.glue&&(M=e.resourceSurface.getSurfaceReference(T.surfaceReference)),null!=M){var P=e.bounds[M.id];if(P)if(T.externalUVs)if(P.sequence.length>0)if(P.transparent){T.internalUVs&&(null==e.surfaceTextures[m]&&(h=e.resourceSurface.getTextureUrl(e.id,m),e.surfaceTextures[m]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:e.surfaceTextures[m],material:5})),e.drawCommands[0].push({type:1,state:d.drawBlendedTileState});var F=P.sequence;for(y=0,b=F.length;y<b;y++)if(l=e.boundTextures[F[y]]){for(e.boundsDebug[M.id]||(e.boundsDebug[M.id]=[]),e.boundsDebug[M.id].push(F[y]),x=0,w=(c=(u=e.boundLayers[F[y]]).credits).length;x<w;x++)e.imageryCredits[c[x]]=u.specificity;e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:l,alpha:P.alpha[F[y]][1],material:7,layer:u,surface:M})}e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:null,material:3}),e.drawCommands[0].push({type:1,state:d.drawTileState})}else{var L=P.sequence[P.sequence.length-1];if(l=e.boundTextures[L]){for(e.boundsDebug[M.id]||(e.boundsDebug[M.id]=[]),e.boundsDebug[M.id].push(L),x=0,w=(c=(u=e.boundLayers[L]).credits).length;x<w;x++)e.imageryCredits[c[x]]=u.specificity;e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:l,material:6,layer:u,surface:M})}}else if(T.textureLayer){if((u=this.map.getBoundLayerByNumber(T.textureLayer))&&(l=e.boundTextures[u.id])){for(e.boundsDebug[M.id]||(e.boundsDebug[M.id]=[]),e.boundsDebug[M.id].push(u.id),x=0,w=(c=(u=e.boundLayers[u.id]).credits).length;x<w;x++)e.imageryCredits[c[x]]=u.specificity;e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:l,material:6,layer:u,surface:M})}}else T.internalUVs?(null==e.surfaceTextures[m]&&(h=e.resourceSurface.getTextureUrl(e.id,m),e.surfaceTextures[m]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:e.surfaceTextures[m],material:4})):e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:null,material:2});else T.internalUVs&&(null==e.surfaceTextures[m]&&(h=e.resourceSurface.getTextureUrl(e.id,m),e.surfaceTextures[m]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:e.surfaceTextures[m],material:4}))}}else T.internalUVs&&(null==e.surfaceTextures[m]&&(h=e.resourceSurface.getTextureUrl(e.id,m),e.surfaceTextures[m]=e.resources.getTexture(h,0,null,null,e,!0)),e.drawCommands[0].push({type:2,mesh:e.surfaceMesh,submesh:m,texture:e.surfaceTextures[m],material:4}));e.drawCommands[1].push({type:2,mesh:e.surfaceMesh,submesh:m,material:1})}if(M.pipeline>0)for(this.updateTileHmap(e,t),y=0;y<2;y++){var E=e.drawCommands[y];for(m=0,v=E.length;m<v;m++)2==E[m].type&&(E[m].pipeline=M.pipeline,E[m].hmap=e.hmap)}if(e.resetDrawCommands)return!1;if(d.areDrawCommandsReady(e.drawCommands[p],s,n,o)){if(e.resetDrawCommands)return!1;a||(d.processDrawCommands(i,e.drawCommands[p],s,null,e),this.map.applyCredits(e)),e.lastRenderState=null,f=!0}else e.lastRenderState?this.draw.areDrawCommandsReady(e.lastRenderState.drawCommands[p],s,n,o)&&(a||(d.processDrawCommands(i,e.lastRenderState.drawCommands[p],s,!0,e),this.map.applyCredits(e)),f=!0):this.config.mapHeightfiledWhenUnloaded&&!a&&(e.drawGrid(i),f=!(e.drawCommands[p].length>0))}else e.lastRenderState||!this.config.mapHeightfiledWhenUnloaded||a||(e.drawGrid(i),f=!(e.drawCommands[p].length>0));return f},Ci.prototype.drawGeodataTile=function(e,t,i,r,s,a,n,o){if(e.id[0]<=1)return!0;if(null==e.surfaceGeodata){var h;if(e.surface.geodataNavtileInfo){var l=this.tree.findNavTile(e.id);if(l&&l.surface){var u=l.surface.getNavUrl(l.id)+";"+l.id[0]+"-"+l.id[1]+"-"+l.id[2]+";"+l.metanode.minHeight+";"+l.metanode.maxHeight;h=e.surface.getGeodataUrl(e.id,encodeURIComponent(u))}}h||(h=e.resourceSurface.getGeodataUrl(e.id,"")),e.surfaceGeodata=e.resources.getGeodata(h,{tile:e,surface:e.surface})}var c=this.draw.drawChannel;if(e.geodataCounter!=e.surface.geodataCounter&&(e.drawCommands=[[],[],[]],null!=e.surfaceGeodataView&&e.surfaceGeodataView.kill(),e.surfaceGeodataView=null,e.geodataCounter=e.surface.geodataCounter),e.drawCommands[c].length>0&&this.draw.areDrawCommandsReady(e.drawCommands[c],s,n,o))return a||(this.draw.processDrawCommands(i,e.drawCommands[c],s,null,e),this.map.applyCredits(e)),e.lastRenderState=null,!0;if(e.surfaceGeodataView||e.surfaceGeodata.isReady(n,s,o)&&!n&&(e.surfaceGeodataView=new Si(this.map,e.surfaceGeodata,{tile:e,surface:e.surface})),e.surfaceGeodataView){e.mapdataCredits={};for(var d=e.surface?e.surface.specificity:0,p=0,f=t.credits.length;p<f;p++)e.mapdataCredits[t.credits[p]]=d;return e.drawCommands[c][0]={type:3,geodataView:e.surfaceGeodataView},e.surfaceGeodataView.isReady()}return!1},Ci.prototype.updateTileHmap=function(e,t){if(t&&t.hasNavtile()&&e.surface){if(!e.surface||!e.resourceSurface)return!1;if(!e.resourceSurface.getHMapUrl)return!1;var i=e.resourceSurface.getHMapUrl(e.id,!0);e.hmap=e.resources.getTexture(i)}else{for(var r=e.parent,s=null;r&&r.id[0]>0;){if(r.metanode&&r.metanode.hasNavtile()){s={sourceTile:r,sourceTexture:null,hmap:!0,tile:e};break}r=r.parent}if(s){i=e.resourceSurface.getHMapUrl(e.id,!0);e.hmap=e.resources.getTexture(i,null,s,{tile:e,hmap:!0},e,!1),e.hmap.neverReady&&(e.hmap=null)}else e.hmap=null}},Ci.prototype.updateTileBounds=function(e,t){for(var i=0,r=t.length;i<r;i++){var s=t[i];if(s.externalUVs){var a=e.resourceSurface;if(e.resourceSurface.glue&&(a=e.resourceSurface.getSurfaceReference(s.surfaceReference)),a){var n=e.bounds[a.id];n||(n={sequence:[],alpha:[],transparent:!1,viewCoutner:0},e.bounds[a.id]=n),n.viewCoutner!=e.viewCoutner&&this.updateTileSurfaceBounds(e,s,a,n,n.viewCoutner!=e.viewCoutner)}}}for(var o in e.bounds)e.bounds[o].viewCoutner=e.viewCoutner},Ci.prototype.getParentTile=function(e,t){for(;e&&e.id[0]>t;)e=e.parent;return e},Ci.prototype.getTileTextureTransform=function(e,t){var i=t.id[0]-e.id[0],r=e.id[1]<<i,s=e.id[2]<<i,a=1/Math.pow(2,i);return[a,a,(t.id[1]-r)*a,(t.id[2]-s)*a]},Ci.prototype.updateTileSurfaceBounds=function(e,t,i,r,s){var a,n,o,h;if(!this.config.mapNoTextures)if(i.boundLayerSequence.length>0){if(s){r.sequence=[];for(var l=[],u=[],c=0,d=0,p=i.boundLayerSequence.length;d<p;d++)if((o=i.boundLayerSequence[d][0])&&o.ready&&o.hasTileOrInfluence(e.id)&&i.boundLayerSequence[d][1]>0){if(n=null,e.id[0]>o.lodRange[1]&&(n={sourceTile:this.getParentTile(e,o.lodRange[1]),sourceTexture:null,layer:o,tile:e}),(h=e.boundTextures[o.id])||(a=o.getUrl(e.id),1==(h=e.resources.getTexture(a,o.dataType,n,{tile:e,layer:o},e,!1)).checkType&&(h.checkMask=!0),h.isReady(!0),e.boundTextures[o.id]=h),h.neverReady)continue;var f=!1,g=!1;h.isMaskPosible()&&(h.isMaskInfoReady()?h.getMaskTexture()&&(r.transparent=!0,f=!0):(g=!0,f=!0)),u.push(f);var m=!(i.boundLayerSequence[d][1]<1||f||o.isTransparent);if(m&&c++,l.push(m),r.sequence.push(o.id),r.alpha[o.id]=i.boundLayerSequence[d],e.boundLayers[o.id]=o,(r.alpha[o.id][1]<1||o.isTransparent)&&(r.transparent=!0),g)break}if(c>0){for(var v=[],y=r.sequence.length-1;y>=0;y--){var b=r.sequence[y];if(l[y]){v.unshift(b);break}h=e.boundTextures[b],(r.alpha[b][1]<1||e.boundLayers[b].isTransparent||u[y])&&v.unshift(b)}r.sequence=v}}}else null!=i.textureLayer?s&&(o=this.map.getBoundLayerById(i.textureLayer))&&o.hasTileOrInfluence(e.id)&&(n=null,e.id[0]>o.lodRange[1]&&(n={sourceTile:this.getParentTile(e,o.lodRange[1]),sourceTexture:null,layer:o,tile:e}),r.sequence.push(o.id),e.boundLayers[o.id]=o,e.boundTextures[o.id]||(a=o.getUrl(e.id),e.boundTextures[o.id]=e.resources.getTexture(a,o.dataType,n,{tile:e,layer:o},e,!1))):0!=t.textureLayer&&(o=this.map.getBoundLayerByNumber(t.textureLayer))&&o.hasTileOrInfluence(e.id)&&(n=null,e.id[0]>o.lodRange[1]&&(n={sourceTile:this.getParentTile(e,o.lodRange[1]),sourceTexture:null,layer:o,tile:e}),e.boundLayers[o.id]=o,e.boundTextures[o.id]||(a=o.getUrl(e.id),e.boundTextures[o.id]=e.resources.getTexture(a,o.dataType,n,{tile:e,layer:o},e,!1)))},Ci.prototype.drawTileInfo=function(e,t,i,r){var s,a=this.debug;if(a.drawMeshBBox||t.drawBBox(i),t.metatile.useVersion<4){var n=t.bbox.min,o=t.bbox.max;(s=this.core.getRendererInterface().getCanvasCoords([n[0]+.5*(o[0]-n[0])-i[0],n[1]+.5*(o[1]-n[1])-i[1],o[2]-i[2]],this.camera.getMvpMatrix()))[2]=.9992*s[2]}else{var h=t.bbox2[3]-t.bbox2[0],l=t.bbox2[4]-t.bbox2[1],u=t.bbox2[5]-t.bbox2[2],c=Math.sqrt(h*h+l*l+u*u);s=this.core.getRendererInterface().getCanvasCoords([.25*(t.bbox2[12]+t.bbox2[15]+t.bbox2[18]+t.bbox2[21])+t.diskNormal[0]*c*.1-i[0],.25*(t.bbox2[13]+t.bbox2[16]+t.bbox2[19]+t.bbox2[22])+t.diskNormal[1]*c*.1-i[1],.25*(t.bbox2[14]+t.bbox2[17]+t.bbox2[20]+t.bbox2[23])+t.diskNormal[2]*c*.1-i[2]],this.camera.getMvpMatrix())}var d,p,f,g,m=a.debugTextSize;if(a.drawLods&&(d=""+e.id[0],this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]-4*m),4*m,d,[1,0,0,1],s[2])),a.drawIndices&&(d=e.id[1]+" "+e.id[2],this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]-11*m),4*m,d,[0,1,1,1],s[2])),a.drawPositions){var v=t.border2;v&&(d=Math.floor(v[0])+" "+Math.floor(v[1])+" "+Math.floor(v[2])+" "+Math.floor(v[3])+" "+Math.floor(v[4])+" "+Math.floor(v[5])+" "+Math.floor(v[6])+" "+Math.floor(v[7])+" "+Math.floor(v[8]),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+3*m),4*m,d,[0,1,1,1],s[2])),(v=t.border)&&(draw.getDrawCommandsGpuSize(e.drawCommands[draw.drawChannel]||e.lastRenderState.drawCommands[draw.drawChannel]),Math.floor(v[0]),Math.floor(v[1]),Math.floor(v[2]),Math.floor(v[3]),Math.floor(v[4]),Math.floor(v[5]),Math.floor(v[6]),Math.floor(v[7]),Math.floor(v[8]),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[0,1,1,1],s[2]))}if(a.drawResources&&r&&(d=(this.draw.getDrawCommandsGpuSize(e.drawCommands[0]||e.lastRenderState.drawCommands[0])/1048576).toFixed(2)+"MB",this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[0,1,0,1],s[2])),a.drawFaceCount&&r&&(d=r.faces+" - "+r.submeshes.length+(e.surface&&e.surface.glue?" - 1":" - 0"),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[0,1,0,1],s[2])),a.drawGPixelSize&&(d=""+(Math.tan(e.metanode.diskAngle2A)*e.metanode.diskDistance*.70710678118/t.displaySize).toFixed(2),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[0,1,0,1],s[2])),a.drawOrder&&(d=this.drawTileCounter+" cmds: "+e.drawCommands[0].length,this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[0,1,0,1],s[2])),(a.drawSurfaces||a.drawSurfaces2)&&(d=JSON.stringify(e.surface.id),g=a.drawSurfaces2?[(g=Ai.getHashColor2(e.surface.surfaceCounter))[0],g[1],g[2],1]:[1,1,1,1],t.alien&&(d="[A]"+d),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,g,s[2])),a.drawBoundLayers&&e.boundsDebug){var y=e.resourceSurface;if(y.glue)for(p=0,f=y.id.length;p<f;p++)e.boundsDebug[y.id[p]]&&(d="< "+y.id[p]+" >",this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+(10+7*p*2)*m),4*m,d,[1,1,1,1],s[2]),d=JSON.stringify(e.boundsDebug[y.id[p]]),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+(17+7*p*2)*m),4*m,d,[1,1,1,1],s[2]));else e.boundsDebug[y.id]&&(d="< "+y.id+" >",this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[1,1,1,1],s[2]),d=JSON.stringify(e.boundsDebug[y.id]),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+17*m),4*m,d,[1,1,1,1],s[2]))}if(a.drawCredits){for(var b in d="{ ",e.imageryCredits)e.imageryCredits[b]&&(d+=b+":"+e.imageryCredits[b]+", ");for(b in e.glueImageryCredits)e.imageryCredits[b]||(d+=b+":"+e.glueImageryCredits[b]+", ");d+="}",this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+10*m),4*m,d,[1,1,1,1],s[2])}if(a.drawDistance&&(d=e.distance.toFixed(2)+"  "+e.texelSize.toFixed(3)+"  "+t.pixelSize.toFixed(3),d+="--"+e.texelSize2.toFixed(3),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+17*m),4*m,d,[1,0,1,1],s[2])),a.drawNodeInfo){var x=(240&t.flags)>>4;d="v"+t.metatile.version+"-"+t.flags.toString(2)+"-"+(1&x?"1":"0")+(2&x?"1":"0")+(4&x?"1":"0")+(8&x?"1":"0"),d+="-"+t.minHeight+"/"+t.maxHeight+"-"+Math.floor(t.minZ)+"/"+Math.floor(t.maxZ)+"-"+Math.floor(t.surrogatez),this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]-18*m),4*m,d,[1,0,1,1],s[2])}if(a.drawTextureSize&&r){var w=r.submeshes;for(p=0,f=w.length;p<f;p++)if(w[p].internalUVs){var M=e.surfaceTextures[p];if(M){var S=M.getGpuTexture();S&&(d="["+p+"]: "+S.width+" x "+S.height,this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+(17+4*p*2)*m),4*m,d,[1,1,1,1],s[2]))}}else d="["+p+"]: 256 x 256",this.drawText(Math.round(s[0]-.5*this.getTextSize(4*m,d)),Math.round(s[1]+(17+4*p*2)*m),4*m,d,[1,1,1,1],s[2])}};var Ti=Ci,Pi=s.d,Fi=p.a,Li=Ti,Ei=Mi,ki=Ae,Ni=function(e){this.map=e,this.config=e.config,this.isProjected=e.getNavigationSrs().isProjected(),this.isGeocent=e.isGeocent,this.renderer=e.renderer,this.stats=e.stats,this.camera=e.camera,this.tree=e.tree,this.ndcToScreenPixel=.5*this.renderer.curSize[0],this.debug={heightmapOnly:!1,blendHeightmap:!0,drawBBoxes:!1,drawNBBoxes:!1,drawSpaceBBox:!1,drawMeshBBox:!1,drawLods:!1,drawPositions:!1,drawTexelSize:!1,drawWireframe:0,drawTestMode:0,drawTestData:0,drawFaceCount:!1,drawDistance:!1,drawMaxLod:!1,drawGeodataOnly:!1,drawTextureSize:!1,drawNodeInfo:!1,drawLayers:!0,drawBoundLayers:!1,drawSurfaces:!1,drawCredits:!1,drawOrder:!1,drawOctants:!1,drawLabelBoxes:!1,drawAllLabels:!1,drawHiddenLabels:!1,drawEarth:!0,drawGridCells:!1,drawTileCounter:0,drawPolyWires:!1,drawFog:this.config.mapFog,drawGPixelSize:!1,debugTextSize:2,ignoreTexelSize:!1,maxZoom:!1},this.gridFlat=!1,this.gridGlues=!1,this.gridSkipped=!1,this.atmoColor=[216/255,232/255,243/255,1],this.atmoColor2=[72/255,154/255,1,1],this.atmoHeight=5e4,this.atmoHeightFactor=1,this.atmoDensity=1,this.fogDensity=0,this.zFactor=0,this.zFactor2=.003,this.zbufferOffset=null,this.zShift=0,this.zLastShift=0,this.bestMeshTexelSize=1,this.bestGeodataTexelSize=1,this.log8=Math.log(8),this.log2=Math.log(2),this.geodataTilesPerLayer=0,this.drawCounter=0,this.drawChannel=0,this.drawChannelNames=["base","hit"],this.planetRadius=this.isGeocent?e.getNavigationSrs().getSrsInfo().a:100,this.tileBuffer=new Array(500),this.processBuffer=new Array(6e4),this.processBuffer2=new Array(6e4),this.drawBuffer=new Array(6e4),this.drawBuffer2=new Array(6e4),this.tmpVec3=new Array(3),this.tmpVec5=new Array(5),this.bboxBuffer=new Float32Array(24),this.planeBuffer=new Float32Array(27);var t=this.renderer.gpu;this.drawTileState=t.createState({}),this.drawStardomeState=t.createState({zwrite:!1,ztest:!1}),this.drawBlendedTileState=t.createState({zequal:!0,blend:!0}),this.drawAuraState=t.createState({zwrite:!1,blend:!0}),this.drawAtmoState=t.createState({zwrite:!1,ztest:!1,blend:!0}),this.drawAtmoState2=t.createState({zwrite:!1,ztest:!0,blend:!1}),this.degradeHorizonFactor=0,this.degradeHorizonTiltFactor=0,this.replay={camera:null,drawnTiles:null,drawnFreeTiles:null,nodeBuffer:null,tracedNodes:null,tracedFreeNodes:null,storeTiles:!1,storeFreeTiles:!1,storeNodes:!1,storeFreeNodes:!1,storeLoaded:this.config.mapStoreLoadStats,drawGlobe:!1,drawTiles:!1,drawNodes:!1,drawFreeTiles:!1,drawFreeNodes:!1,drawLoaded:!1,lod:30,singleLod:!1,loadedIndex:0,singleLodedIndex:0,loaded:[],loadFirst:0,loadLast:0},this.drawTiles=new Li(e,this)};Ni.prototype.drawMap=function(e){var t=this.map,i=this.renderer,r=this.camera,s=this.replay,a=i.gpu,n=this.debug;1!=this.drawChannel&&(a.setViewport(),t.visibleCredits={imagery:{},glueImagery:{},mapdata:{}});var o=this.isProjected;switch(this.config.mapGridMode){case"none":this.gridSkipped=!0,this.gridFlat=!1,this.gridGlues=!1;break;case"flat":this.gridSkipped=!1,this.gridFlat=!0,this.gridGlues=!1;break;case"linear":this.gridSkipped=!1,this.gridFlat=!1,this.gridGlues=!0;break;case"fastlinear":this.gridSkipped=!1,this.gridFlat=!1,this.gridGlues=!1}var h=this.drawTiles,l=r.update();if((i=this.renderer).debugStr="AsyncImageDecode: "+this.config.mapAsyncImageDecode,i.dirty=!0,i.drawFog=this.debug.drawFog,i.debug=this.debug,i.mapHack=t,i.benevolentMargins=this.config.mapBenevolentMargins,this.config.mapForceFrameTime?-1!=this.config.mapForceFrameTime?i.frameTime=this.config.mapForceFrameTime:i.frameTime=0:i.frameTime=this.stats.frameTime,i.hoverFeatureCounter=0,i.hoverFeatureList=t.hoverFeatureList,i.hoverFeature=t.hoverFeature,i.cameraPosition=r.position,i.cameraOrientation=t.position.getOrientation(),i.cameraTiltFator=Math.cos(Fi.radians(i.cameraOrientation[1])),i.cameraVector=r.vector,i.cameraViewExtent=t.position.getViewExtent(),i.cameraViewExtent2=Math.pow(2,Math.max(1,Math.floor(Math.log(t.position.getViewExtent())/Math.log(2)))),i.drawLabelBoxes=this.debug.drawLabelBoxes,i.drawGridCells=this.debug.drawGridCells,i.drawAllLabels=this.debug.drawAllLabels,i.drawHiddenLabels=this.debug.drawHiddenLabels,i.debug=this.debug,i.fmaxDist=Number.NEGATIVE_INFINITY,i.fminDist=Number.POSITIVE_INFINITY,o){var u=Fi.radians(i.cameraOrientation[0]);i.labelVector=[-Math.sin(u),Math.cos(u),0,0,0]}else{var c=l.vector;i.labelVector=[c[0],c[1],c[2],0]}i.distanceFactor=1/Math.max(1,Math.log(r.distance)/Math.log(1.04)),i.tiltFactor=Math.abs(i.cameraOrientation[1]/-90),i.localViewExtentFactor=2*Math.tan(Fi.radians(.5*t.position.getFov())),this.degradeHorizonFactor=200*this.config.mapDegradeHorizonParams[0],this.degradeHorizonTiltFactor=.5*(1+Math.cos(Fi.radians(Math.min(180,Math.abs(2*i.cameraOrientation[1]*3))))),1!=this.drawChannel?2==n.drawWireframe?a.clear(!0,!0,[255,255,255,255]):a.clear(!0,!0,[0,0,0,255]):a.clear(!0,!0,[255,255,255,255]),a.setState(this.drawStardomeState),a.setState(this.drawTileState),this.setupDetailDegradation(),t.loader.setChannel(0),this.zFactor=0,this.ndcToScreenPixel=.5*i.curSize[0],this.updateFogDensity(),this.updateGridFactors(),this.maxGpuUsed=Math.max(3929856,t.gpuCache.getMaxCost()-3929856),this.stats.renderBuild=0,this.drawTileCounter=0;var d,p,f,g,m,v,y,b,x,w,M=r.position;if(t.freeLayersHaveGeodata&&0==this.drawChannel&&i.draw.clearJobBuffer(),this.debug.drawEarth){if((s.storeNodes||s.storeFreeNodes)&&(s.nodeBuffer=[]),s.drawGlobe||s.drawTiles||s.drawFreeTiles||s.drawNodes||s.drawFreeNodes||s.drawLoaded){var S=s.lod,A=s.singleLod;if(s.drawTiles&&s.drawnTiles)for(d=0,p=(v=s.drawnTiles).length;d<p;d++)v[d][1]?(m=v[d][0],h.debug.drawBBoxes&&h.drawTileInfo(m,m.metanode,M),m.drawGrid(M)):(m=v[d][0])&&(A&&m.id[0]==S||!A&&m.id[0]<=S)&&h.drawSurfaceTile(m,m.metanode,M,m.pixelSize,m.priority,!1,!1);if(s.drawFreeTiles&&s.drawnFreeTiles)for(d=0,p=(v=s.drawnFreeTiles).length;d<p;d++)v[d][1]||(m=v[d][0])&&(A&&m.id[0]==S||!A&&m.id[0]<=S)&&h.drawSurfaceTile(m,m.metanode,M,m.pixelSize,m.priority,!1,!1);if(s.drawNodes&&s.tracedNodes){for(v=s.tracedNodes,y=n.drawBBoxes,n.drawBBoxes=!0,d=0,p=v.length;d<p;d++)(m=v[d])&&(A&&m.id[0]==S||!A&&m.id[0]<=S)&&h.drawTileInfo(m,m.metanode,M,m.surfaceMesh,m.pixelSize);n.drawBBoxes=y}if(s.drawFreeNodes&&s.tracedFreeNodes){for(v=s.tracedFreeNodes,y=n.drawBBoxes,n.drawBBoxes=!0,d=0,p=v.length;d<p;d++)m=v[d],(A&&m.id[0]==S||!A&&m.id[0]<=S)&&h.drawTileInfo(m,m.metanode,M,m.surfaceMesh,m.pixelSize);n.drawBBoxes=y}var C=s.loadedIndex,T=s.singleLodedIndex;if(s.drawLoaded&&s.loaded){var P=s.loaded;for(n.drawBBoxes=!0,d=0,p=P.length;d<p;d++){var F=P[d];F&&F.tile&&F.tile.id&&(m=F.tile,(T&&d==C||!T&&d<=C)&&(A&&m.id[0]==S||!A&&m.id[0]<=S)&&m.metanode&&(m.metanode.hasGeometry()?h.drawSurfaceTile(m,m.metanode,M,m.pixelSize,m.priority,!1,!1):h.drawTileInfo(m,m.metanode,M,m.surfaceMesh,m.pixelSize)))}n.drawBBoxes=y}return void((s.drawFreeTiles&&s.drawnFreeTiles||s.drawLoaded&&s.loaded)&&this.freeLayersHaveGeodata&&0==this.drawChannel&&(i.drawnGeodataTiles=this.stats.drawnGeodataTilesPerLayer,i.drawnGeodataTilesFactor=this.stats.drawnGeodataTilesFactor,i.draw.drawGpuJobs()))}for(d=0,p=this.tileBuffer.length;d<p;d++)this.tileBuffer[d]=null;if(this.tree.surfaceSequence.length>0&&this.tree.draw(),s.storeTiles){for(x=[],d=0,p=this.tileBuffer.length;d<p;d++)if(v=this.tileBuffer[d])for(f=0,g=v.length;f<g;f++)x.push(v[f]);s.cameraPos=M,s.drawnTiles=x,s.storeTiles=!1}if(s.storeNodes){for(w=[],d=0,p=s.nodeBuffer.length;d<p;d++)m=s.nodeBuffer[d],w.push(m);s.cameraPos=M,s.tracedNodes=w,s.storeNodes=!1}for(d=0,p=t.freeLayerSequence.length;d<p;d++)(b=t.freeLayerSequence[d]).ready&&b.tree&&(!b.geodata||b.stylesheet&&b.stylesheet.isReady())&&0==this.drawChannel&&(b.zFactor&&(this.zbufferOffset=b.zFactor),"geodata"==b.type?this.drawMonoliticGeodata(b):b.tree.draw(),this.zbufferOffset=null);if(s.storeFreeTiles){for(x=[],d=0,p=this.tileBuffer.length;d<p;d++)if(v=this.tileBuffer[d])for(f=0,g=v.length;f<g;f++)(m=v[f]).surface&&m.surface.free&&x.push(m);s.cameraPos=M,s.drawnFreeTiles=x,s.storeFreeTiles=!1}if(s.storeFreeNodes){for(w=[],d=0,p=s.nodeBuffer.length;d<p;d++)(m=s.nodeBuffer[d]).surface&&m.surface.free&&w.push(m);s.cameraPos=M,s.tracedFreeNodes=w,s.storeFreeNodes=!1}}var L=t.referenceFrame.body;if(1!=this.drawChannel&&!o&&n.drawFog&&(L&&L.atmosphere||"melown2015"==t.referenceFrame.id||"mars-qsc"==t.referenceFrame.id||"earth-qsc"==t.referenceFrame.id)&&i.progAtmo.isReady()&&i.progAtmo2.isReady()){var E=t.getNavigationSrs().getSrsInfo(),k=E.a,N=E.b,I=this.atmoHeight;i.earthRadius=k,i.earthRadius2=N,i.earthERatio=k/N;Pi.normalize(r.position,[0,0,0,0]);var B,R,z=t.getPosition(),U=1-Fi.clamp(Math.max(.1*I,r.geocentDistance-k)/(10*I),0,1),D=Math.max(2,128*U);D=[2,(k+I)/k*2,.25,(k+I)/k*2];var _=1/k*2;B=[r.position[0]*_,r.position[1]*_,r.position[2]*_,1];var O=k/(.5*z.getViewExtent()/Math.tan(Fi.radians(.5*z.getFov()))+k);R=[Fi.mix(4.4,1.01,O),1,Fi.mix(5,1.05,O),0],a.setState(this.drawAuraState),i.draw.drawBall([-r.position[0],-r.position[1],-r.position[2]],k+I,N+I,i.progAtmo,D,B,R,this.atmoColor,this.atmoColor2),a.setState(this.drawTileState)}n.drawEarth&&(e||t.freeLayersHaveGeodata&&0==this.drawChannel&&(i.drawnGeodataTiles=this.stats.drawnGeodataTilesPerLayer,i.drawnGeodataTilesFactor=this.stats.drawnGeodataTilesFactor,i.draw.drawGpuJobs())),this.config.mapForceFrameTime&&-1!=this.config.mapForceFrameTime&&(i.frameTime=0,this.config.mapForceFrameTime=-1)},Ni.prototype.drawToTexture=function(e){this.renderer.switchToFramebuffer("texture",e),this.drawChannel=0,this.map.renderSlots.processRenderSlots(),this.renderer.switchToFramebuffer("base")},Ni.prototype.drawHitmap=function(){this.drawChannel=1,this.renderer.switchToFramebuffer("depth"),this.map.renderSlots.processRenderSlots(),this.renderer.switchToFramebuffer("base"),this.renderer.hitmapMode>2&&this.renderer.copyHitmap(),this.drawChannel=0,this.map.hitMapDirty=!1},Ni.prototype.drawGeodataHitmap=function(){this.renderer.gpu.setState(this.drawTileState),this.renderer.switchToFramebuffer("geo"),this.renderer.draw.drawGpuJobs(),this.renderer.advancedPassNeeded&&(this.renderer.switchToFramebuffer("geo2"),this.renderer.draw.drawGpuJobs()),this.renderer.switchToFramebuffer("base"),this.map.geoHitMapDirty=!1},Ni.prototype.getDrawCommandsGpuSize=function(e){for(var t=0,i=0,r=e.length;i<r;i++){var s=e[i];switch(s.type){case 2:var a=s.mesh,n=this.config.mapNoTextures?0:s.texture;a&&(t+=a.gpuSize),n&&(t+=n.getGpuSize());break;case 3:var o=s.geodataView;o&&(t+=o.size)}}return t},Ni.prototype.areDrawCommandsReady=function(e,t,i,r){for(var s=!0,a=!!r,n=0,o=e.length;n<o;n++){var h=e[n];switch(h.type){case 2:if(h.pipeline){var l=h.hmap;if(l&&l.isReady(i,t)||(s=!1),9==this.debug.drawTestMode){var u=h.texture;(p=!!this.config.mapNoTextures||(!u||u&&u.isReady(i,t,a)))||(s=!1)}break}var c=h.mesh,d=(u=h.texture,c&&c.isReady(i,t,a)),p=!!this.config.mapNoTextures||(!u||u&&u.isReady(i,t,a));d&&p||(s=!1);break;case 3:var f=h.geodataView;f&&f.isReady(i,t,a)||(s=!1)}}return s},Ni.prototype.processDrawCommands=function(e,t,i,r,s){t.length>0&&this.drawTileCounter++;for(var a=0,n=t.length;a<n;a++){var o=t[a];switch(o.type){case 1:this.renderer.gpu.setState(o.state);break;case 2:var h=o.pipeline;if(h){var l=o.hmap;if(9==this.debug.drawTestMode){var u=o.texture;(c=!!this.config.mapNoTextures||(!u||u&&u.isReady(r,i)))&&l&&l.isReady(r,i)&&s.drawHmapTile(e,null,null,h,u)}else l&&l.isReady(r,i)&&s.drawHmapTile(e,null,null,h);return}var c,d=o.mesh,p=(u=o.texture,d&&d.isReady(r,i));if(this.config.mapNoTextures?(c=!0,u=null):c=!u||u&&u.isReady(r,i),p&&c)if(this.debug.drawBBoxes&&this.debug.drawMeshBBox&&d.submeshes[o.submesh].drawBBox(e),u)d.drawSubmesh(e,o.submesh,u,o.material,o.alpha,o.layer,o.surface,s.splitMask);else{var f=o.material;switch(f){case 6:case 4:f=2}d.drawSubmesh(e,o.submesh,u,f,o.alpha,o.layer,o.surface,s.splitMask)}break;case 3:var g=o.geodataView;g&&g.isReady(r,i,!0)&&g.draw(e)}}},Ni.prototype.drawMonoliticGeodata=function(e){var t;if(e&&0==this.drawChannel&&(this.camera.camera.bboxVisible(e.extents,this.camera.position)&&(null==e.monoGeodata&&(t="object"==typeof e.geodataUrl?e.geodataUrl:e.getMonoGeodataUrl(e.id),e.monoGeodata=new ki(this.map,t,{tile:null,surface:e})),e.monoGeodataCounter!=e.geodataCounter&&(e.monoGeodataView=null,e.monoGeodataCounter=e.geodataCounter),e.monoGeodata.isReady(null,null,null,e.options.fastParse)&&(e.monoGeodataView||(e.monoGeodataView=new Ei(this.map,e.monoGeodata,{tile:null,surface:e})),e.monoGeodataView.isReady())))){for(var i=this.map.visibleCredits.mapdata,r=0,s=e.credits.length;r<s;r++){var a=e.credits[r],n=i[a];i[a]=n?10>n?10:n:10}e.monoGeodataView.draw(this.camera.position)}},Ni.prototype.updateFogDensity=function(){var e=this.map.getPosition().getOrientation(),t=this.camera.getFar(),i=Math.max(5,-e[1])/90,r=Math.log(.05)/(this.atmoDensity*t*this.atmoHeightFactor*Math.max(1,1e-4*this.camera.height)*i);r*=5/(Math.min(5e4,Math.max(this.camera.distance,1e3))/5e3),this.debug.drawFog||(r=0),this.fogDensity=r,this.renderer.fogDensity=r},Ni.prototype.updateGridFactors=function(){for(var e=this.map.referenceFrame.getSpatialDivisionNodes(),t=0,i=e.length;t<i;t++){var r=e[t],s=Math.max(10,this.camera.distance+20),a=2*(r.extents.ur[0]-r.extents.ll[0]),n=Math.log(Math.min(a,s))/this.log8;n=Math.log(a)/this.log8-n,r.gridBlend=n-Math.floor(n),n=Math.floor(Math.floor(n))+1,r.gridStep1=Math.pow(8,n),r.gridStep2=8*r.gridStep1}},Ni.prototype.setupDetailDegradation=function(e){var t=0;this.map.mobile&&(t=this.config.mapMobileDetailDegradation),e&&(t+=e);this.texelSizeFit=this.config.mapTexelSizeFit*Math.pow(2,t)*1};var Ii=Ni,Bi=a.a,Ri=function(e,t){if(this.map=e,this.core=e.core,this.killed=!1,this.config=e.config,this.maxThreads=t||1,this.usedThreads=0,this.maxPending=2*this.maxThreads,this.fadeout=.95,this.pending=[[],[]],this.channel=0,this.downloading=[],this.downloadingTime=[],this.workerTask={},this.lastDownloadTime=0,this.downloaded=0,this.processWorker=null,this.updateThreadCount(),this.config.mapSeparateLoader){var r=i(14);this.processWorker=new r,this.processWorker.onerror=function(e){throw new Error(e.message+" ("+e.filename+":"+e.lineno+")")},this.processWorker.onmessage=this.onWorkerMessage.bind(this),this.processWorker.postMessage({command:"config",data:this.config})}};Ri.prototype.updateThreadCount=function(){this.maxThreads=this.config.mapDownloadThreads,this.maxPending=Math.max(20,2*this.maxThreads),this.fadeout=(this.maxPending-1)/this.maxPending},Ri.prototype.setChannel=function(e){this.channel=e},Ri.prototype.onWorkerMessage=function(e,t){if(!this.killed){t||(e=e.data);var i=e.command;if("packed-events"!=i){var r=e.path,s=this.workerTask[r];if(s){switch(i){case"on-loaded":if(s.onLoaded)switch(s.kind){case"direct-texture":s.onLoaded(e.data,!0,e.filesize);break;case"direct-mesh":s.onLoaded(e.data,!1,!0,e.filesize);break;case"texture":s.onLoaded(new Blob([e.data]));break;default:s.onLoaded(e.data)}break;case"on-error":s.onError&&s.onError()}delete this.workerTask[r]}}else for(var a=e.messages,n=0,o=a.length;n<o;n++)this.onWorkerMessage(a[n],!0)}},Ri.prototype.processLoadBinary=function(e,t,i,r,s,a){var n=!!Bi.useCredentials&&-1!=this.mapLoaderUrl.indexOf(this.map.url.baseUrl);if(this.processWorker){switch(s){case"texture":this.config.mapAsyncImageDecode&&(r="blob",s="direct-texture");break;case"mesh":this.config.mapParseMeshInWorker&&(s="direct-mesh")}switch(s){case"texture":case"direct-texture":case"mesh":case"pointcloud":case"direct-mesh":case"metadata":case"geodata":case"direct-3dtiles":this.workerTask[e]={onLoaded:t,onError:i,kind:s},this.processWorker.postMessage({command:"load-binary",path:e,withCredentials:n,xhrParams:this.map.core.xhrParams,responseType:r,kind:s,options:a});break;default:Bi.loadBinary(e,t,i,n,this.map.core.xhrParams,r)}}else"texture"==s&&this.config.mapAsyncImageDecode&&(r="blob"),Bi.loadBinary(e,t,i,n,this.map.core.xhrParams,r)},Ri.prototype.load=function(e,t,i,r,s){var a=this.downloading.indexOf(e);if(-1==a){var n=this.pending[this.channel];-1!=(a=this.map.searchArrayIndexById(n,e))?n[a].priority=i:n.unshift({id:e,call:t,priority:i||0,tile:r,kind:s});do{for(var o=!0,h=0,l=n.length-1;h<l;h++)if(n[h].priority>n[h+1].priority){var u=n[h];n[h]=n[h+1],n[h+1]=u,o=!1}}while(!o);n.length>this.maxPending&&n.pop()}},Ri.prototype.remove=function(e){var t=this.map.searchArrayIndexById(this.pending[this.channel],e);-1!=t&&this.pending[this.channel].splice(t,1)},Ri.prototype.onLoaded=function(e){var t=this.downloading.indexOf(e.id),i=performance.now(),r=this.map.stats;this.map.draw.replay.storeLoaded&&this.map.draw.replay.loaded.push({url:e.id,kind:e.kind,tile:e.tile,priority:e.priority,time:i,duration:i-this.downloadingTime[t],interval:i-this.lastDownloadTime,threads:this.downloading.length}),this.downloading.splice(t,1),this.downloadingTime.splice(t,1),this.lastDownloadTime=i,this.usedThreads--,this.map.markDirty(),this.update(!0),r.loadedCount++,r.loadLast=i},Ri.prototype.onLoadError=function(e){var t=this.downloading.indexOf(e.id),i=performance.now(),r=this.map.stats;this.map.draw.replay.storeLoaded&&this.map.draw.replay.loaded.push({url:e.id,kind:e.kind,tile:e.tile,priority:e.priority,time:i,duration:i-this.downloadingTime[t],interval:i-this.lastDownloadTime,threads:this.downloading.length}),this.downloading.splice(t,1),this.downloadingTime.splice(t,1),this.lastDownloadTime=i,this.usedThreads--,this.map.markDirty(),this.update(!0),r.loadErrorCount++,r.loadLast=i},Ri.prototype.updateChannel=function(e){var t=this.pending[e];this.updateThreadCount();for(var i=0,r=t.length;i<r;i++)t[i].priority*=this.fadeout;for(var s=performance.now();t.length>0&&this.usedThreads<this.maxThreads;){var a=t.shift();-1==this.downloading.indexOf(a.id)&&null!=a.call&&(this.downloading.push(a.id),this.downloadingTime.push(s),this.usedThreads++,this.downloaded++,a.call(a.id,this.onLoaded.bind(this,a),this.onLoadError.bind(this,a)))}},Ri.prototype.update=function(e){if(!this.map.loaderSuspended&&!this.core.contextLost){!e&&this.processWorker&&this.config.mapPackLoaderEvents&&this.downloading.length&&this.processWorker.postMessage({command:"tick"});for(var t=this.pending.length-1;t>=0;t--)if(this.pending[t].length>0){this.updateChannel(t);break}}};var zi=Ri,Ui=p.a,Di=function(e){e instanceof Di?this.pos=e.pos.slice():(this.pos=null!=e&&e instanceof Array?e.slice():[],this.validate())};Di.prototype.clone=function(){return new Di(this.pos)},Di.prototype.getCoords=function(){return[this.pos[1],this.pos[2],this.pos[4]]},Di.prototype.getCoords2=function(){return[this.pos[1],this.pos[2]]},Di.prototype.setCoords=function(e){return this.pos[1]=e[0],this.pos[2]=e[1],this.pos[4]=e[2],this},Di.prototype.setCoords2=function(e){return this.pos[1]=e[0],this.pos[2]=e[1],this},Di.prototype.getHeight=function(){return this.pos[4]},Di.prototype.setHeight=function(e){return this.pos[4]=e,this},Di.prototype.getOrientation=function(){return[this.pos[5],this.pos[6],this.pos[7]]},Di.prototype.setOrientation=function(e){return this.pos[5]=e[0],this.pos[6]=e[1],this.pos[7]=e[2],this},Di.prototype.getFov=function(){return this.pos[9]},Di.prototype.setFov=function(e){return this.pos[9]=e,this},Di.prototype.getViewExtent=function(){return this.pos[8]},Di.prototype.setViewExtent=function(e){return this.pos[8]=e,this},Di.prototype.getViewDistance=function(){return.5*this.getViewExtent()/Math.tan(Ui.radians(.5*this.getFov()))},Di.prototype.getViewMode=function(){return this.pos[0]},Di.prototype.getHeightMode=function(){return this.pos[3]},Di.prototype.check=function(){this.getViewMode(),this.pos[6]=Ui.clamp(this.pos[6],-90,90),this.pos[5]=this.pos[5]%360,this.pos[7]=this.pos[7]%360},Di.prototype.isSame=function(e){return e=e.pos,this.pos[0]==e[0]&&Ui.isEqual(this.pos[1],e[1],1e-7)&&Ui.isEqual(this.pos[2],e[2],1e-7)&&this.pos[3]==e[3]&&Ui.isEqual(this.pos[4],e[4],.001)&&Ui.isEqual(this.pos[5],e[5],.001)&&Ui.isEqual(this.pos[6],e[6],.001)&&Ui.isEqual(this.pos[7],e[7],.001)&&Ui.isEqual(this.pos[8],e[8],.001)&&Ui.isEqual(this.pos[9],e[9],.001)},Di.prototype.validate=function(){var e=this.pos;"fixed"==e[0]&&(e[0]="obj",e[9]=e[8],e[8]=e[7],e[7]=e[6],e[6]=e[5],e[5]=e[4],e[4]=e[3],e[3]="fix"),e[0]="obj"==e[0]||"subj"==e[0]?e[0]:"obj",e[1]=null!=e[1]?e[1]:0,e[2]=null!=e[2]?e[2]:0,e[3]="fix"==e[3]||"fixed"==e[3]||"float"==e[3]?e[3]:"float",e[4]=null!=e[4]?e[4]:0,e[5]=null!=e[5]?e[5]:0,e[6]=null!=e[6]?e[6]:-90,e[7]=null!=e[7]?e[7]:0,e[8]=null!=e[8]?e[8]:900,e[9]=null!=e[9]?e[9]:45,e[3]="fixed"==e[3]?"fix":e[3]},Di.prototype.toString=function(){var e=this.pos;return e[0]+", "+e[1].toFixed(0)+", "+e[2].toFixed(0)+", "+e[3]+", "+e[4].toFixed(0)+", "+e[5].toFixed(0)+", "+e[6].toFixed(0)+", "+e[7].toFixed(0)+", , "+e[8].toFixed(0)+", "+e[9].toFixed(0)},Di.prototype.toArray=function(){return this.pos.slice()};var _i=Di,Oi=function(e){this.map=e,this.draw=e.draw,this.renderer=e.renderer,this.config=e.config,this.renderSlots=[]};Oi.prototype.createRenderSlot=function(e,t,i){return{id:e,callback:t,enabled:i}},Oi.prototype.addRenderSlot=function(e,t,i){this.renderSlots.push(this.createRenderSlot(e,t,i))},Oi.prototype.getRenderSlotIndex=function(e){return this.map.searchArrayIndexById(this.renderSlots,e)},Oi.prototype.checkRenderSlotId=function(e){return"after-map-render"==e?"map":e},Oi.prototype.moveRenderSlotBefore=function(e,t){var i=this.getRenderSlotIndex(this.checkRenderSlotId(e)),r=this.getRenderSlotIndex(t);-1!=i&&-1!=r&&r!=i-1&&this.renderSlots.splice(r,0,this.renderSlots.splice(i,1)[0])},Oi.prototype.moveRenderSlotAfter=function(e,t){var i=this.getRenderSlotIndex(this.checkRenderSlotId(e)),r=this.getRenderSlotIndex(t);-1!=i&&-1!=r&&r!=i+1&&(r++,this.renderSlots.splice(r,0,this.renderSlots.splice(i,1)[0]))},Oi.prototype.removeRenderSlot=function(e){var t=this.getRenderSlotIndex(e);-1!=t&&this.renderSlots.splice(t,1)},Oi.prototype.setRenderSlotEnabled=function(e,t){var i=this.getRenderSlotIndex(e);-1!=i&&(this.renderSlots[i].enabled=t)},Oi.prototype.getRenderSlotEnabled=function(e){var t=this.getRenderSlotIndex(e);return-1!=t&&this.renderSlots[t].enabled},Oi.prototype.processRenderSlots=function(){1!=this.draw.drawChannel&&this.renderer.gpu.setViewport();for(var e=0,t=this.renderSlots.length;e<t;e++){var i=this.renderSlots[e];i.enabled&&i.callback&&(this.renderer.gpu.setState(this.draw.drawTileState),i.callback(this.draw.drawChannelNames[this.draw.drawChannel]))}};var Gi=Oi,Vi=function(e){this.map=e,this.core=e.core,this.inspector=e.core.inspector,this.drawnTiles=0,this.drawnGeodataTiles=0,this.drawnGeodataTilesFactor=0,this.drawnGeodataTilesPerLayer=0,this.drawnFaces=0,this.drawCalls=0,this.usedNodes=0,this.processedNodes=0,this.processedMetatiles=0,this.counter=0,this.statsCycle=0,this.fps=0,this.frameTime=0,this.renderTime=0,this.renderTimeTmp=0,this.renderTimeBegin=0,this.renderBuild=0,this.lastRenderTime=0,this.lastFrameTime=0,this.renderedLods=new Array(32),this.debugIds={},this.recordGraphs=!1,this.graphsTimeIndex=0,this.graphsLastTimeIndex=0,this.graphsTimeSamples=900,this.graphsRenderTimes=new Array(this.graphsTimeSamples),this.graphsCreateMeshTimes=new Array(this.graphsTimeSamples),this.graphsCreateGpuMeshTimes=new Array(this.graphsTimeSamples),this.graphsCreateTextureTimes=new Array(this.graphsTimeSamples),this.graphsFrameTimes=new Array(this.graphsTimeSamples),this.graphsCpuMemoryMetatiles=new Array(this.graphsTimeSamples),this.graphsCpuMemoryUsed=new Array(this.graphsTimeSamples),this.graphsGpuMemoryTextures=new Array(this.graphsTimeSamples),this.graphsGpuMemoryMeshes=new Array(this.graphsTimeSamples),this.graphsGpuMemoryGeodata=new Array(this.graphsTimeSamples),this.graphsGpuMemoryRender=new Array(this.graphsTimeSamples),this.graphsPolygons=new Array(this.graphsTimeSamples),this.graphsLODs=new Array(this.graphsTimeSamples),this.graphsBuild=new Array(this.graphsTimeSamples),this.graphsFluxTextures=new Array(this.graphsTimeSamples),this.graphsFluxMeshes=new Array(this.graphsTimeSamples),this.graphsFluxGeodatas=new Array(this.graphsTimeSamples),this.graphsFluxTexture=[[0,0],[0,0]],this.graphsFluxMesh=[[0,0],[0,0]],this.graphsFluxGeodata=[[0,0],[0,0]],this.graphsCreateTextureTime=0,this.graphsCreateGpuMeshTime=0,this.graphsCreateMeshTime=0,this.resetGraphs(),this.meshesFaces=0,this.meshesUVArea=0,this.gpuMeshes=0,this.gpuTextures=0,this.gpuGeodata=0,this.gpuUsed=0,this.resourcesUsed=0,this.metaUsed=0,this.gpuRenderUsed=0,this.loadedCount=0,this.loadErrorCount=0,this.loadFirst=0,this.loadLast=0,this.gpuNeeded=0,this.gpuNeeded2=0,this.octoNodes=0,this.octoNodesMemSize=0,this.heightClass=0,this.heightLod=0,this.heightNode=0,this.heightTerrain=0,this.heightDelta=0,this.debugStr=null};Vi.prototype.resetGraphs=function(){this.graphsTimeIndex=0;for(var e=0;e<this.graphsTimeSamples;e++)this.graphsRenderTimes[e]=0,this.graphsCreateMeshTimes[e]=0,this.graphsCreateGpuMeshTimes[e]=0,this.graphsCreateTextureTimes[e]=0,this.graphsFrameTimes[e]=0,this.graphsCpuMemoryUsed[e]=0,this.graphsCpuMemoryMetatiles[e]=0,this.graphsGpuMemoryTextures[e]=0,this.graphsGpuMemoryMeshes[e]=0,this.graphsGpuMemoryGeodata[e]=0,this.graphsGpuMemoryRender[e]=0,this.graphsPolygons[e]=0,this.graphsLODs[e]=[0,[]],this.graphsBuild[e]=0,this.graphsFluxTextures[e]=[[0,0],[0,0]],this.graphsFluxMeshes[e]=[[0,0],[0,0]],this.graphsFluxGeodatas[e]=[[0,0],[0,0]]},Vi.prototype.begin=function(e){if(e){this.drawnTiles=0,this.drawnGeodataTiles=0,this.drawnGeodataTilesFactor=0,this.drawnGeodataTilesPerLayer=0,this.drawCalls=0,this.drawnFaces=0,this.gpuRenderUsed=0,this.gpuNeeded=0,this.usedNodes=0,this.processedNodes=0,this.processedMetatiles=0,this.meshesFaces=0,this.meshesUVArea=0;for(var t=0,i=this.renderedLods.length;t<i;t++)this.renderedLods[t]=0}this.debugIds={},this.counter++,this.statsCycle++,this.renderTimeBegin=performance.now(),e&&(this.lastFrameTime&&(this.frameTime=this.renderTimeBegin-this.lastFrameTime),this.lastFrameTime=this.renderTimeBegin)},Vi.prototype.end=function(e){var t=performance.now()-this.renderTimeBegin;if(e?(this.renderTimeTmp+=t,this.lastRenderTime=t):this.renderTimeTmp+=this.lastRenderTime,this.recordGraphs){var i=this.graphsTimeIndex;this.graphsRenderTimes[i]=t,this.graphsCreateMeshTimes[i]=0,this.graphsCreateGpuMeshTimes[i]=0,this.graphsCreateTextureTimes[i]=0,this.graphsFrameTimes[i]=this.frameTime,this.graphsCpuMemoryUsed[i]=this.map.resourcesCache.totalCost,this.graphsCpuMemoryMetatiles[i]=this.map.metatileCache.totalCost,this.graphsGpuMemoryTextures[i]=this.gpuTextures,this.graphsGpuMemoryMeshes[i]=this.gpuMeshes,this.graphsGpuMemoryGeodata[i]=this.gpuGeodata,this.graphsGpuMemoryRender[i]=this.gpuRenderUsed,this.graphsPolygons[i]=this.drawnFaces,this.graphsFluxTextures[i]=[[this.graphsFluxTexture[0][0],this.graphsFluxTexture[0][1]],[this.graphsFluxTexture[1][0],this.graphsFluxTexture[1][1]]],this.graphsFluxMeshes[i]=[[this.graphsFluxMesh[0][0],this.graphsFluxMesh[0][1]],[this.graphsFluxMesh[1][0],this.graphsFluxMesh[1][1]]],this.graphsFluxGeodatas[i]=[[this.graphsFluxGeodata[0][0],this.graphsFluxGeodata[0][1]],[this.graphsFluxGeodata[1][0],this.graphsFluxGeodata[1][1]]],this.graphsLODs[i]=[this.drawnTiles,this.renderedLods.slice()],this.graphsBuild[i]=this.renderBuild,this.graphsTimeIndex=(this.graphsTimeIndex+1)%this.graphsTimeSamples,this.inspector&&this.inspector.graphs&&this.inspector.graphs.updateGraphs(this)}this.statsCycle%50==0&&(this.renderTime=this.renderTimeTmp/100,this.fps=1e3/this.renderTime,this.renderTimeTmp=0,this.inspector&&this.inspector.stats&&(this.gpuUsed=this.map.gpuCache.totalCost,this.resourcesUsed=this.map.resourcesCache.totalCost,this.metaUsed=this.map.metatileCache.totalCost,this.inspector.stats.updateStatsPanel(this))),this.graphsFluxTexture=[[0,0],[0,0]],this.graphsFluxMesh=[[0,0],[0,0]],this.graphsFluxGeodata=[[0,0],[0,0]],this.debugStr=this.map.renderer.debugStr};var ji=Vi,Hi=function(e){this.map=e};Hi.prototype.generateSurfaceSequence=function(){var e=this.map.currentView,t=this.map.tree;if(t){t.surfaceSequence=[],t.surfaceSequenceIndices=[],t.surfaceOnlySequence=[];var i,r,s,a,n,o,h,l,u={},c=0,d=[],p=[];for(l in e.surfaces)(i=this.map.getSurface(l))&&(p.push(i.id),c++,u[l]=i.index+1,d.push([[i.index+1],i,!0,!1]));if(c>=1&&(p.sort(),p=p.join(";"),(i=this.map.virtualSurfaces[p])&&(d=[[[i.index+1],i,!0,!1]],c=1)),c>1){var f=[];for(l in this.map.glues)if((r=this.map.glues[l])&&r.id){var g=r.id;if(g.length<=c){var m=!1;for(o=0,h=g.length;o<h;o++)if(!u[g[o]]){m=!0;break}if(!m){for(s=[],o=0,h=g.length;o<h;o++)s.unshift(u[g[o]]);f.push([s,r,!1,!1])}}}for(a=0,n=f.length;a<n;a++){var v=f[a];(r=v[1]).flagProper=!0,r.flagAlien=!0,r.flagProper&&d.push(v),r.flagAlien&&(s=v[0].slice(1),d.push([s,v[1],!1,!0]))}do{var y=!0;for(a=0,n=d.length-1;a<n;a++){var b=d[a][0],x=d[a+1][0],w=!1;for(o=0,h=Math.min(b.length,x.length);o<h;o++)if(b[o]<x[o]||o==h-1&&b[o]==x[o]&&x.length>b.length){w=!0;break}if(w){var M=d[a];d[a]=d[a+1],d[a+1]=M,y=!1}}}while(!y);var S=c-1;for(a=0,n=d.length;a<n;a++)t.surfaceSequence.push([d[a][1],d[a][3]]),d[a][1].viewSurfaceIndex=S,d[a][2]&&(S--,t.surfaceOnlySequence.push(d[a][1]))}else 1==c&&(t.surfaceSequence.push([d[0][1],d[0][3]]),d[0][1].viewSurfaceIndex=c-1,t.surfaceOnlySequence=[d[0][1]]);for(l in this.map.freeLayersHaveGeodata=!1,e.freeLayers){var A=this.map.getFreeLayer(l);A&&(A.surfaceSequence=[A],A.surfaceOnlySequence=[A],A.geodata&&(this.map.freeLayersHaveGeodata=!0))}this.map.renderer.draw.clearJobBuffer()}},Hi.prototype.generateBoundLayerSequence=function(){var e,t,i,r,s,a,n=this.map.currentView,o=this.map.boundLayers;for(var h in o)o[h].shaderFilters=null;for(h in n.surfaces){var l=n.surfaces[h],u=this.map.getSurface(h);if(null!=u)for(u.boundLayerSequence=[],r=0,s=l.length;r<s;r++)"string"==typeof(e=l[r])?(t=this.map.getBoundLayerById(e))&&u.boundLayerSequence.push([t,1]):(t=this.map.getBoundLayerById(e.id))&&(i=1,void 0!==e.alpha&&(i=parseFloat(e.alpha)),u.boundLayerSequence.push([t,i]),(a=e.options||e).shaderVarFlatShade&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].varFlatShade=a.shaderVarFlatShade),a.shaderFilter&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].filter=a.shaderFilter))}for(h in n.freeLayers){var c=n.freeLayers[h],d=this.map.getFreeLayer(h);if(null!=d&&d.ready){d.options=c.options||{},d.boundLayerSequence=[];var p=c.boundLayers;if(p&&Array.isArray(p))for(r=0,s=p.length;r<s;r++)"string"==typeof(e=p[r])?(t=this.map.getBoundLayerById(e))&&d.boundLayerSequence.push([t,1]):(t=this.map.getBoundLayerById(e.id))&&(i=1,void 0!==e.alpha&&(i=parseFloat(e.alpha)),d.boundLayerSequence.push([t,i]),e.shaderVarFlatShade&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].varFlatShade=e.shaderVarFlatShade),e.shaderFilter&&(t.shaderFilters||(t.shaderFilters={}),t.shaderFilters[u.id]||(t.shaderFilters[u.id]={}),t.shaderFilters[u.id].filter=e.shaderFilter))}}};var Wi=Hi,qi=i(11),Zi=s.d,Yi=a.a,Ji=n.a,Ki=h,Qi=A,Xi=Ve,$i=Je,er=Qe,tr=tt,ir=Gt,rr=Wt,sr=Qt,ar=Ii,nr=zi,or=_i,hr=Gi,lr=ji,ur=Wi,cr=qi.a,dr=c,pr=function(e,t,i,r,s){this.config=r||{},this.setConfigParams(r),this.setLoaderParams(t,s),this.core=e,this.proj4=this.core.getProj4(),this.coreConfig=e.coreConfig,this.killed=!1,this.config=r||{},this.loaderSuspended=!1,this.url=new cr(this,i),this.position=new or(["obj",0,0,"fix",0,0,0,0,0,0]),this.lastPosition=this.position.clone(),this.srses={},this.bodies={},this.referenceFrame={},this.credits={},this.creditsByNumber={},this.surfaces={},this.virtualSurfaces={},this.glues={},this.freeLayers={},this.boundLayers={},this.stylesheets={},this.processingTasks=[],this.processingTasks2=[],this.geodataProcessors=[],this.surfaceSequence=new ur(this),this.initialView=null,this.currentView=new Ki(this,{}),this.currentViewString="",this.namedViews={},this.viewCounter=0,this.srsReady=!1,this.surfaceCounter=0,this.freeLayerSequence=[],this.freeLayersHaveGeodata=!1,this.visibleCredits={imagery:{},glueImagery:{},mapdata:{}},this.mobile=!1,this.metanodeBuffer=new Uint8Array(1024),this.gpuCache=new er(this,1024*this.config.mapGPUCache*1024),this.resourcesCache=new er(this,1024*this.config.mapCache*1024),this.metatileCache=new er(this,1024*this.config.mapMetatileCache*1024),this.setupMobileMode(this.config.mapMobileMode),this.setupCache(),this.loader=new nr(this,this.config.mapDownloadThreads),this.renderer=this.core.renderer,this.camera=new tr(this),this.stats=new lr(this),this.resourcesTree=new Xi(this),this.mapConfig=new ir(this,t),this.convert=new rr(this),this.measure=new sr(this),this.convert.measure=this.measure,this.isGeocent=!this.getNavigationSrs().isProjected(),this.tree=new Qi(this,!1),this.mapConfig.afterConfigParsed(),this.updateCoutner=0,this.dirty=!0,this.dirtyCountdown=0,this.hitMapDirty=!0,this.geoHitMapDirty=!0,this.clickEvent=null,this.hoverEvent=null,this.hoverFeature=null,this.hoverFeatureId=null,this.lastHoverFeature=null,this.lastHoverFeatureId=null,this.hoverFeatureCounter=0,this.hoverFeatureList=[],this.draw=new ar(this),this.draw.setupDetailDegradation();var a,n=this.referenceFrame.body;if(n&&n.atmosphere)a=n.atmosphere.colorHorizon,this.draw.atmoColor=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],a=n.atmosphere.colorZenith,this.draw.atmoColor2=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],this.draw.atmoHeight=n.atmosphere.thickness/1e5*5e4,this.draw.atmoDensity=n.atmosphere.visibility/1e5*(1e5/n.atmosphere.thickness);else switch(this.referenceFrame.id){case"melown2015":case"earth-qsc":this.draw.atmoColor=[216/255,232/255,243/255,1],this.draw.atmoColor2=[72/255,154/255,1,1],this.draw.atmoHeight=5e4;break;case"mars-qsc":this.draw.atmoColor=[1,187/255,157/255,1],this.draw.atmoColor2=[1,155/255,113/255,1],this.draw.atmoHeight=25e3,this.draw.atmoDensity=4}this.draw.atmoHeightFactor=this.draw.atmoHeight/5e4,this.renderSlots=new hr(this),this.renderSlots.addRenderSlot("map",this.drawMap.bind(this),!0)};pr.prototype.kill=function(){for(var e in this.killed=!0,this.tree&&this.tree.kill(),this.freeLayers){var t=this.freeLayers[e];t&&t.tree&&t.tree.kill()}this.gpuCache.clear(),this.resourcesCache.clear(),this.metatileCache.clear(),null!=this.renderer&&(this.renderer.kill(),this.renderer=null)},pr.prototype.setupMobileMode=function(){this.mobile=this.config.mapMobileMode,!this.mobile&&this.config.mapMobileModeAutodect&&(this.mobile=Ji.isMobile()),this.setupCache()},pr.prototype.setupCache=function(){if(this.resourcesCache){var e=1/(this.mobile?Math.pow(2,Math.max(0,this.config.mapMobileDetailDegradation-1)):1);e=.5*(e+1/(this.mobile?Math.pow(2,this.config.mapMobileDetailDegradation):1)),this.resourcesCache.setMaxCost(1024*this.config.mapCache*1024*e),this.gpuCache.setMaxCost(1024*this.config.mapGPUCache*1024*e),this.metatileCache.setMaxCost(1024*this.config.mapMetatileCache*1024*(e<.8?.5:1))}},pr.prototype.getCoreInterface=function(){return this.core.interface},pr.prototype.getRendererInterface=function(){return this.core.interface.getRendererInterface()},pr.prototype.setOption=function(){},pr.prototype.getOption=function(){},pr.prototype.addSrs=function(e,t){this.srses[e]=t},pr.prototype.getSrs=function(e){return this.srses[e]},pr.prototype.getSrses=function(){return this.getMapKeys(this.srses)},pr.prototype.addBody=function(e,t){this.bodies[e]=t},pr.prototype.getBody=function(e){return this.bodies[e]},pr.prototype.getBodies=function(){return this.getMapKeys(this.bodies)},pr.prototype.setReferenceFrame=function(e){this.referenceFrame=e},pr.prototype.addCredit=function(e,t){this.credits[e]=t,this.creditsByNumber[t.id]=t,t.key=e},pr.prototype.getCreditByNumber=function(e){return this.creditsByNumber[e]},pr.prototype.getCreditById=function(e){return this.credits[e]},pr.prototype.getCredits=function(){return this.getMapKeys(this.credits)},pr.prototype.getVisibleCredits=function(){var e,t,i,r,s=this.visibleCredits.imagery,a=this.visibleCredits.glueImagery,n=[],o=[];for(var h in a)s[h]||(s[h]=a[h]);for(h in this.visibleCredits.glueImagery={},s)n.push(h),o.push(s[h]);do{for(r=!0,e=0,t=o.length-1;e<t;e++)o[e]<o[e+1]&&(i=o[e],o[e]=o[e+1],o[e+1]=i,i=n[e],n[e]=n[e+1],n[e+1]=i,r=!1)}while(!r);var l=this.visibleCredits.mapdata,u=[],c=[];for(h in l)u.push(h),c.push(l[h]);do{for(r=!0,e=0,t=c.length-1;e<t;e++)c[e]<c[e+1]&&(i=c[e],c[e]=c[e+1],c[e+1]=i,i=u[e],u[e]=u[e+1],u[e+1]=i,r=!1)}while(!r);return{"3D":[],imagery:n,mapdata:u}},pr.prototype.addSurface=function(e,t){this.surfaces.push(t),t.index=this.surfaces.length-1},pr.prototype.getSurface=function(e){return this.searchArrayById(this.surfaces,e)},pr.prototype.getSurfaces=function(){for(var e=[],t=0,i=this.surfaces.length;t<i;t++)e.push(this.surfaces[t].id);return e},pr.prototype.addGlue=function(e,t){this.glues[e]=t},pr.prototype.getGlue=function(e){return this.glues[e]},pr.prototype.addBoundLayer=function(e,t){this.boundLayers[e]=t},pr.prototype.setBoundLayerOptions=function(e,t){this.boundLayers[e]&&this.boundLayers[e].setOptions(t)},pr.prototype.getBoundLayerOptions=function(e){return this.boundLayers[e]?this.boundLayers[e].getOptions():null},pr.prototype.removeBoundLayer=function(e){this.boundLayers[e]&&(this.boundLayers[e].kill(),this.boundLayers[e]=null)},pr.prototype.getBoundLayerByNumber=function(e){var t=this.boundLayers;for(var i in t)if(t[i].numberId==e)return t[i];return null},pr.prototype.getBoundLayerById=function(e){return this.boundLayers[e]},pr.prototype.getBoundLayers=function(){return this.getMapKeys(this.boundLayers)},pr.prototype.addFreeLayer=function(e,t){this.freeLayers[e]=t,this.setView(this.getView()),this.markDirty()},pr.prototype.removeFreeLayer=function(e){this.freeLayers[e]&&(this.freeLayers[e].kill(),this.freeLayers[e]=null,this.setView(this.getView()),this.markDirty())},pr.prototype.setFreeLayerOptions=function(e,t){this.freeLayers[e]&&this.freeLayers[e].setOptions(t)},pr.prototype.getFreeLayerOptions=function(e){return this.freeLayers[e]?this.freeLayers[e].getOptions():null},pr.prototype.getFreeLayer=function(e){return this.freeLayers[e]},pr.prototype.getFreeLayers=function(){var e=[];for(var t in this.freeLayers)e.push(t);return e},pr.prototype.getMapsSrs=function(e){return null==e?null:-1!=e.indexOf("+proj")?new $i(this,{srsDef:e}):this.srses[e]},pr.prototype.addNamedView=function(e,t){this.namedViews[e]=t},pr.prototype.getNamedView=function(e){return this.namedViews[e]},pr.prototype.getNamedViews=function(){return this.getMapKeys(this.namedViews)},pr.prototype.setView=function(e,t,i){if(null!=e){if(i&&this.convert){var r=this.getPosition();r=this.convert.convertPositionHeightMode(r,"fix",!0),this.setPosition(r)}if("string"==typeof e)if("{"==(e=e.trim()).charAt(0))try{e=JSON.parse(e)}catch(e){return}else{if(!(e=this.getNamedView(e)))return;e=e.getInfo()}var s={};e.surfaces&&(s.surfaces=e.surfaces),e.freeLayers&&(s.freeLayers=e.freeLayers),s=JSON.stringify(s);var a=this.renderer;if(e.options){var n=e.options.superelevation;n&&n[0]&&n[1]&&n[0].length>=2&&n[1].length>=2?(a.setSuperElevationState(!0),a.setSuperElevation(n[0][0],n[1][0],n[0][1],n[1][1])):a.setSuperElevationState(!1)}else a.setSuperElevationState(!1);(s!=this.currentViewString||t)&&(this.currentView.parse(e),this.currentViewString=s,this.viewCounter++,a.draw.clearJobHBuffer()),this.surfaceSequence.generateSurfaceSequence(),this.surfaceSequence.generateBoundLayerSequence(),this.refreshFreelayesInView(),this.markDirty()}},pr.prototype.addStylesheet=function(e,t){this.stylesheets[e]=t},pr.prototype.getStylesheet=function(e){return this.stylesheets[e]},pr.prototype.getStylesheets=function(){var e=[];for(var t in this.stylesheets)e.push(t);return e},pr.prototype.getStylesheetData=function(e){var t=this.getStylesheet(e);return t?{url:t.url,data:t.data}:{url:null,data:{}}},pr.prototype.setStylesheetData=function(e,t){var i=this.getStylesheet(e);if(this.renderer.draw.clearJobHBuffer(),i)for(var r in t&&i.setData(t),this.freeLayers){var s=this.getFreeLayer(r);s&&s.geodata&&s.stylesheet==i&&(s.geodataProcessor&&s.geodataProcessor.setStylesheet(s.stylesheet),s.geodataCounter++)}this.markDirty()},pr.prototype.getView=function(){return this.currentView.getInfo()},pr.prototype.refreshFreelayesInView=function(){var e=this.currentView.freeLayers;for(var t in this.freeLayerSequence=[],e){var i=this.getFreeLayer(t);i&&(i.zFactor=e[t].depthOffset,i.maxLod=e[t].maxLod,this.freeLayerSequence.push(i),e[t].style?i.setStyle(e[t].style):i.setStyle(i.originalStyle))}},pr.prototype.refreshView=function(){this.viewCounter++,this.surfaceSequence.generateSurfaceSequence(),this.surfaceSequence.generateBoundLayerSequence(),this.refreshFreelayesInView(),this.markDirty()},pr.prototype.searchArrayIndexById=function(e,t){for(var i=0,r=e.length;i<r;i++)if(e[i].id==t)return i;return-1},pr.prototype.searchArrayById=function(e,t){for(var i=0,r=e.length;i<r;i++)if(e[i].id==t)return e[i];return null},pr.prototype.searchMapByInnerId=function(e,t){for(var i in e)if(e[i].id==t)return e[i];return null},pr.prototype.getMapKeys=function(e){var t=[];for(var i in e)t.push(i);return t},pr.prototype.getMapIds=function(e){var t=[];for(var i in e)t.push(i.id);return t},pr.prototype.setPosition=function(e){this.position=new or(e),this.markDirty()},pr.prototype.isReferenceFrameReady=function(){return this.referenceFrame.model.physicalSrs.isReady()&&this.referenceFrame.model.publicSrs.isReady()&&this.referenceFrame.model.navigationSrs.isReady()},pr.prototype.getPhysicalSrs=function(){return this.referenceFrame.model.physicalSrs},pr.prototype.getPublicSrs=function(){return this.referenceFrame.model.publicSrs},pr.prototype.getNavigationSrs=function(){return this.referenceFrame.model.navigationSrs},pr.prototype.getPosition=function(){return this.position.clone()},pr.prototype.setLoaderParams=function(e,t){var i=[];e&&e.browserOptions&&i.push(e.browserOptions),t&&i.push(t);for(var r=0,s=i.length;r<s;r++){var a=i[r];for(var n in a)switch(n){case"mapSeparateLoader":case"mapGeodataBinaryLoad":case"mapPackLoaderEvents":case"mapParseMeshInWorker":case"mapPackGeodataEvents":this.setConfigParam(n,a[n])}}},pr.prototype.setConfigParams=function(e){if("object"==typeof e&&null!==e)for(var t in e)this.setConfigParam(t,e[t])},pr.prototype.setConfigParam=function(e,t){switch(e){case"map":this.config.map=Yi.validateString(t,null);break;case"mapCache":this.config.mapCache=Yi.validateNumber(t,10,Number.MAXINTEGER,900),this.setupCache();break;case"mapGPUCache":this.config.mapGPUCache=Yi.validateNumber(t,10,Number.MAXINTEGER,360),this.setupCache();break;case"mapMetatileCache":this.config.mapMetatileCache=Yi.validateNumber(t,10,Number.MAXINTEGER,60),this.setupCache();break;case"mapTexelSizeFit":this.config.mapTexelSizeFit=Yi.validateNumber(t,1e-4,Number.MAXINTEGER,1.1);break;case"mapDownloadThreads":this.config.mapDownloadThreads=Yi.validateNumber(t,1,Number.MAXINTEGER,6);break;case"mapMaxProcessingTime":this.config.mapMaxProcessingTime=Yi.validateNumber(t,1,Number.MAXINTEGER,50);break;case"mapMaxGeodataProcessingTime":this.config.mapMaxGeodataProcessingTime=Yi.validateNumber(t,1,Number.MAXINTEGER,10);break;case"mapMobileMode":this.config.mapMobileMode=Yi.validateBool(t,!1),this.setupMobileMode();break;case"mapMobileModeAutodect":this.config.mapMobileModeAutodect=Yi.validateBool(t,!1);break;case"mapMobileDetailDegradation":this.config.mapMobileDetailDegradation=Yi.validateNumber(t,1,Number.MAXINTEGER,2);break;case"mapNavSamplesPerViewExtent":this.config.mapNavSamplesPerViewExtent=Yi.validateNumber(t,1e-11,Number.MAXINTEGER,4);break;case"mapFog":this.config.mapFog=Yi.validateBool(t,!1),this.draw&&(this.draw.debug.drawFog=this.config.mapFog,this.dirty=!0);break;case"mapFlatshade":this.config.mapFlatshade=Yi.validateBool(t,!1),this.draw&&(this.draw.debug.drawWireframe=this.config.mapFlatshade?3:0,this.dirty=!0);break;case"mapIgnoreNavtiles":this.config.mapIgnoreNavtiles=Yi.validateBool(t,!1);break;case"mapAllowHires":this.config.mapAllowHires=Yi.validateBool(t,!0);break;case"mapAllowLowres":this.config.mapAllowLowres=Yi.validateBool(t,!0);break;case"mapAllowSmartSwitching":this.config.mapAllowSmartSwitching=Yi.validateBool(t,!0);break;case"mapDisableCulling":this.config.mapDisableCulling=Yi.validateBool(t,!1);break;case"mapPreciseCulling":this.config.mapPreciseCulling=Yi.validateBool(t,!1);break;case"mapHeightLodBlend":this.config.mapHeightLodBlend=Yi.validateBool(t,!0);break;case"mapHeightNodeBlend":this.config.mapHeightNodeBlend=Yi.validateBool(t,!0);break;case"mapBasicTileSequence":this.config.mapBasicTileSequence=Yi.validateBool(t,!0);break;case"mapSmartNodeParsing":this.config.mapSmartNodeParsing=Yi.validateBool(t,!0);break;case"mapStoreLoadStats":this.config.mapStoreLoadStats=Yi.validateBool(t,!0),this.draw&&this.draw.replay&&(this.draw.replay.storeLoaded=this.config.mapStoreLoadStats);break;case"mapXhrImageLoad":this.config.mapXhrImageLoad=Yi.validateBool(t,!1);break;case"mapLoadMode":this.config.mapLoadMode=Yi.validateString(t,"topdown");break;case"mapGeodataLoadMode":this.config.mapGeodataLoadMode=Yi.validateString(t,"fit");break;case"mapGridMode":this.config.mapGridMode=Yi.validateString(t,"linear");break;case"mapGridSurrogatez":this.config.mapGridSurrogatez=Yi.validateBool(t,!1);break;case"mapGridUnderSurface":this.config.mapGridUnderSurface=Yi.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,0);break;case"mapGridTextureLevel":this.config.mapGridTextureLevel=Yi.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,-1);break;case"mapGridTextureLayer":this.config.mapGridTextureLayer=Yi.validateString(t,"");break;case"mapPreciseBBoxTest":this.config.mapPreciseBBoxTest=Yi.validateBool(t,!0);break;case"mapPreciseDistanceTest":this.config.mapPreciseDistanceTest=Yi.validateBool(t,!1);break;case"mapHeightfiledWhenUnloaded":this.config.mapHeightfiledWhenUnloaded=Yi.validateBool(t,!1);break;case"mapForceMetatileV3":this.config.mapForceMetatileV3=Yi.validateBool(t,!1);break;case"mapVirtualSurfaces":this.config.mapVirtualSurfaces=Yi.validateBool(t,!0);break;case"mapDegradeHorizon":this.config.mapDegradeHorizon=Yi.validateBool(t,!0);break;case"mapDegradeHorizonParams":this.config.mapDegradeHorizonParams=Yi.validateNumberArray(t,4,[0,1,1,1],[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],[1,3e3,15e3,7e3]);break;case"mapRefreshCycles":this.config.mapRefreshCycles=Yi.validateNumber(t,0,Number.MAXINTEGER,3);break;case"mapDefaultFont":this.config.mapDefaultFont=Yi.validateString(t,"");break;case"mapMetricUnits":this.config.mapMetricUnits=Yi.validateBool(t,!0);break;case"mapLanguage":this.config.mapLanguage=Yi.validateString(t,"en");break;case"mapNoTextures":this.config.mapNoTextures=this.config.mapDisableCulling=Yi.validateBool(t,!1);break;case"mapForceFrameTime":this.config.mapForceFrameTime=Yi.validateNumber(t,-1,Number.MAXINTEGER,0);break;case"mapForcePipeline":this.config.mapForcePipeline=Yi.validateNumber(t,0,Number.MAXINTEGER,0);break;case"mapFeatureGridCells":this.config.mapFeatureGridCells=Yi.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,0);break;case"mapFeaturesPerSquareInch":this.config.mapFeaturesPerSquareInch=Yi.validateNumber(t,1e-6,Number.MAXINTEGER,0);break;case"mapFeaturesSortByTop":this.config.mapFeaturesSortByTop=Yi.validateBool(t,!1);break;case"mapFeaturesReduceParams":this.config.mapFeaturesReduceParams=t;break;case"mapLogGeodataStyles":this.config.mapLogGeodataStyles=Yi.validateBool(t,!0);break;case"map16bitMeshes":this.config.map16bitMeshes=Yi.validateBool(t,!1);break;case"mapOnlyOneUVs":this.config.mapOnlyOneUVs=Yi.validateBool(t,!1);break;case"mapIndexBuffers":this.config.mapIndexBuffers=Yi.validateBool(t,!1);break;case"mapSoftViewSwitch":this.config.mapSoftViewSwitch=Yi.validateBool(t,!0);break;case"mapAsyncImageDecode":this.config.mapAsyncImageDecode=!(!Yi.validateBool(t,!1)||"undefined"==typeof createImageBitmap);break;case"mapFeatureStickMode":this.config.mapFeatureStickMode=Yi.validateNumberArray(t,2,[0,1],[Number.MAX_VALUE,Number.MAX_VALUE],[0,1]);break;case"mapSeparateLoader":this.config.mapSeparateLoader=Yi.validateBool(t,!0);break;case"mapGeodataBinaryLoad":this.config.mapGeodataBinaryLoad=Yi.validateBool(t,!0);break;case"mapPackLoaderEvents":this.config.mapPackLoaderEvents=Yi.validateBool(t,!0);break;case"mapParseMeshInWorker":this.config.mapParseMeshInWorker=Yi.validateBool(t,!0);break;case"mapPackGeodataEvents":this.config.mapPackGeodataEvents=Yi.validateBool(t,!0);break;case"mapSortHysteresis":this.config.mapSortHysteresis=Yi.validateBool(t,!1);break;case"mapHysteresisWait":this.config.mapHysteresisWait=Yi.validateNumber(t,0,Number.MAXINTEGER,0);break;case"mapBenevolentMargins":this.config.mapBenevolentMargins=Yi.validateBool(t,!1);break;case"mapCheckTextureSize":this.config.mapCheckTextureSize=Yi.validateBool(t,!1);break;case"mapTraverseToMeshNode":this.config.mapTraverseToMeshNode=Yi.validateBool(t,!0);break;case"mapNormalizeOctantTexelSize":this.config.mapNormalizeOctantTexelSize=Yi.validateBool(t,!0);break;case"mapDMapSize":this.config.mapDMapSize=Yi.validateNumber(t,16,Number.MAXINTEGER,512);break;case"mapDMapMode":this.config.mapDMapMode=Yi.validateNumber(t,1,Number.MAXINTEGER,1);break;case"mapSplitSpace":this.config.mapSplitSpace=t;break;case"mario":this.config.mario=Yi.validateBool(t,!0);break;case"mapFeaturesReduceMode":"auto"==(t=Yi.validateString(t,"scr-count4"))&&(t="scr-count2"),"legacy"==t&&(t="scr-count2"),"gridcells"==t&&(t="scr-count4"),"singlepass"==t&&(t="scr-count5"),"margin"==t&&(t="scr-count6"),this.config.mapFeaturesReduceMode=t}},pr.prototype.getConfigParam=function(e){switch(e){case"map":return this.config.map;case"mapCache":return this.config.mapCache;case"mapGPUCache":return this.config.mapGPUCache;case"mapMetatileCache":return this.config.mapMetatileCache;case"mapTexelSizeFit":return this.config.mapTexelSizeFit;case"mapDownloadThreads":return this.config.mapDownloadThreads;case"mapMaxProcessingTime":return this.config.mapMaxProcessingTime;case"mapMaxGeodataProcessingTime":return this.config.mapMaxGeodataProcessingTime;case"mapMobileMode":return this.config.mapMobileMode;case"mapMobileModeAutodect":return this.config.mapMobileModeAutodect;case"mapMobileDetailDegradation":return this.config.mapMobileDetailDegradation;case"mapNavSamplesPerViewExtent":return this.config.mapNavSamplesPerViewExtent;case"mapFog":return this.config.mapFog;case"mapFlatshade":return this.config.mapFlatshade;case"mapIgnoreNavtiles":return this.config.mapIgnoreNavtiles;case"mapAllowHires":return this.config.mapAllowHires;case"mapAllowLowres":return this.config.mapAllowLowres;case"mapAllowSmartSwitching":return this.config.mapAllowSmartSwitching;case"mapDisableCulling":return this.config.mapDisableCulling;case"mapPreciseCulling":return this.config.mapPreciseCulling;case"mapHeightLodBlend":return this.config.mapHeightLodBlend;case"mapHeightNodeBlend":return this.config.mapHeightNodeBlend;case"mapBasicTileSequence":return this.config.mapBasicTileSequence;case"mapSmartNodeParsing":return this.config.mapSmartNodeParsing;case"mapStoreLoadStats":return this.config.mapStoreLoadStats;case"mapXhrImageLoad":return this.config.mapXhrImageLoad;case"mapLoadMode":return this.config.mapLoadMode;case"mapGeodataLoadMode":return this.config.mapGeodataLoadMode;case"mapGridMode":return this.config.mapGridMode;case"mapGridSurrogatez":return this.config.mapGridSurrogatez;case"mapGridUnderSurface":return this.config.mapGridUnderSurface;case"mapGridTextureLevel":return this.config.mapGridTextureLevel;case"mapGridTextureLayer":return this.config.mapGridTextureLayer;case"mapPreciseBBoxTest":return this.config.mapPreciseBBoxTest;case"mapPreciseDistanceTest":return this.config.mapPreciseDistanceTest;case"mapHeightfiledWhenUnloaded":return this.config.mapHeightfiledWhenUnloaded;case"mapForceMetatileV3":return this.config.mapForceMetatileV3;case"mapVirtualSurfaces":return this.config.mapVirtualSurfaces;case"mapDegradeHorizon":return this.config.mapDegradeHorizon;case"mapDegradeHorizonParams":return this.config.mapDegradeHorizonParams;case"mapRefreshCycles":return this.config.mapRefreshCycles;case"mapDefaultFont":return this.config.mapDefaultFont;case"mapMetricUnits":return this.config.mapMetricUnits;case"mapLanguage":return this.config.mapLanguage;case"mapNoTextures":return this.config.mapNoTextures;case"mapForceFrameTime":return this.config.mapForceFrameTime;case"mapForcePipeline":return this.config.mapForcePipeline;case"mapFeatureGridCells":return this.config.mapFeatureGridCells;case"mapFeaturesPerSquareInch":return this.config.mapFeaturesPerSquareInch;case"mapFeaturesSortByTop":return this.config.mapFeaturesSortByTop;case"mapFeaturesReduceMode":return this.config.mapFeaturesReduceMode;case"mapFeaturesReduceParams":return this.config.mapFeaturesReduceParams;case"mapLogGeodataStyles":return this.config.mapLogGeodataStyles;case"map16bitMeshes":return this.config.map16bitMeshes;case"mapOnlyOneUVs":return this.config.mapOnlyOneUVs;case"mapIndexBuffers":return this.config.mapIndexBuffers;case"mapSoftViewSwitch":return this.config.mapSoftViewSwitch;case"mapAsyncImageDecode":return this.config.mapAsyncImageDecode;case"mapFeatureStickMode":return this.config.mapFeatureStickMode;case"mapSeparateLoader":return this.config.mapSeparateLoader;case"mapGeodataBinaryLoad":return this.config.mapGeodataBinaryLoad;case"mapPackLoaderEvents":return this.config.mapPackLoaderEvents;case"mapParseMeshInWorker":return this.config.mapParseMeshInWorker;case"mapPackGeodataEvents":return this.config.mapPackGeodataEvents;case"mapSortHysteresis":return this.config.mapSortHysteresis;case"mapHysteresisWait":return this.config.mapHysteresisWait;case"mapBenevolentMargins":return this.config.mapBenevolentMargins;case"mapDMapSize":return this.config.mapDMapSize;case"mapDMapMode":return this.config.mapDMapMode;case"mario":return this.config.mario}},pr.prototype.click=function(e,t,i){this.clickEvent=[e,t,i]},pr.prototype.hover=function(e,t,i,r){this.hoverEvent=[e,t,i,r]},pr.prototype.markDirty=function(){this.dirty=!0,this.hitMapDirty=!0,this.geoHitMapDirty=!0},pr.prototype.getScreenRay=function(e,t){return this.renderer.getScreenRay(e,t)},pr.prototype.renderToImage=function(e){var t=this.renderer.gpu.canvas,i=t.width,r=t.height,s=Yi.fitToPowerOfTwo(i),a=Yi.fitToPowerOfTwo(r),n=new Uint8Array(s*a*4);(e=new dr(this.renderer.gpu)).createFromData(s,a,n),e.createFramebuffer(s,a),this.draw.drawToTexture(e),n=e.readFramebufferPixels(0,0,i,r),e.kill();for(var o=new Uint8Array(i*r*4),h=0;h<r;h++)for(var l=h*i*4,u=(r-h-1)*i*4,c=0;c<i;c++)o[u]=n[l],o[u+1]=n[l+1],o[u+2]=n[l+2],o[u+3]=n[l+3],l+=4,u+=4;return{width:i,height:r,data:o}},pr.prototype.getScreenDepth=function(e,t,i){if(i){var r,s,a=this.camera.position,n=this.renderer.getScreenRay(e,t);if(this.getNavigationSrs().isProjected()){var o=[0,0,Math.min(-1e3,this.referenceFrame.getGlobalHeightRange()[0])],h=[0,0,1];return s=Zi.dot(h,n),r=[o[0]-a[0],o[1]-a[1],o[2]-a[2]],(f=Zi.dot(r,h)/s)>=0?[!0,f]:[!1,1]}var l=this.getNavigationSrs().getSrsInfo().b+this.referenceFrame.getGlobalHeightRange()[0],u=[a[0],a[1],a[2]];r=Zi.dot(n,n);var c=2*Zi.dot(n,u);if((s=c*c-4*r*(Zi.dot(u,u)-l*l))>0){var d=(-c-(s=Math.sqrt(s)))/(2*r),p=(-c+s)/(2*r),f=d<p?d:p;return[!0,f]}return[!1,1]}if(this.hitMapDirty){var g=this.draw.ndcToScreenPixel;this.draw.drawHitmap(),this.draw.ndcToScreenPixel=g;var m=this.renderer.curSize[0],v=this.renderer.curSize[1],y=new Float32Array(16);y[0]=2/m,y[1]=0,y[2]=0,y[3]=0,y[4]=0,y[5]=-2/v,y[6]=0,y[7]=0,y[8]=0,y[9]=0,y[10]=1,y[11]=0,y[12]=.5*-m*y[0],y[13]=.5*-v*y[5],y[14]=0,y[15]=1,this.renderer.imageProjectionMatrix=y,this.renderer.camera.update()}return this.renderer.getDepth(e,t)},pr.prototype.getHitCoords=function(e,t,i,r){this.hitMapDirty&&this.draw.drawHitmap();var s,a,n,o=this.renderer.hitTest(e,t),h=!1,l=this.camera.position,u=o[4];if(this.getNavigationSrs().isProjected()){var c=[0,0,Math.min(-1e3,this.referenceFrame.getGlobalHeightRange()[0])],d=[0,0,1];n=Zi.dot(d,u),a=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],(y=Zi.dot(a,d)/n)>=0&&(!o[3]||y<o[5])&&(s=[u[0]*y+l[0],u[1]*y+l[1],u[2]*y+l[2]],h=!0)}else{var p=this.getNavigationSrs().getSrsInfo().b+this.referenceFrame.getGlobalHeightRange()[0],f=[l[0],l[1],l[2]];a=Zi.dot(u,u);var g=2*Zi.dot(u,f);if((n=g*g-4*a*(Zi.dot(f,f)-p*p))>0){var m=(-g-(n=Math.sqrt(n)))/(2*a),v=(-g+n)/(2*a),y=m<v?m:v;(!o[3]||y<o[5])&&(s=[u[0]*y+l[0],u[1]*y+l[1],u[2]*y+l[2]],h=!0)}}if(!o[3]&&!h)return null;h||(s=[o[0]+l[0],o[1]+l[1],o[2]+l[2]]);var b=this.convert.convertCoords(s,"physical","navigation");if(this.renderer.useSuperElevation&&(b[2]=this.renderer.getUnsuperElevatedHeight(b[2])),"float"==i){r=null!=r?r:this.measure.getOptimalHeightLod(b,100,this.config.mapNavSamplesPerViewExtent);var x=this.measure.getSurfaceHeight(b,r);b[2]-=x[0]}return b},pr.prototype.hitTestGeoLayers=function(e,t,i){if(this.geoHitMapDirty&&this.freeLayersHaveGeodata&&this.draw.drawGeodataHitmap(),!this.freeLayersHaveGeodata)return this.lastHoverFeature=null,this.lastHoverFeatureId=null,this.hoverFeature=null,this.hoverFeatureId=null,[null,!1,[]];var r,s,a=this.renderer.hitTestGeoLayers(e,t);if(!a[0])return r=[],"hover"==i&&(this.lastHoverFeature=this.hoverFeature,this.lastHoverFeatureId=this.hoverFeatureId,this.hoverFeature=null,this.hoverFeatureId=null,null!=this.lastHoverFeatureId&&(null!=this.lastHoverFeatureId&&r.push(["leave",this.lastHoverFeature,this.lastHoverFeatureId]),this.dirty=!0)),[null,!1,r,s];var n=a[1]+(a[2]<<8),o=this.hoverFeatureList[n];return o?(o[6]&&(a=this.renderer.hitTestGeoLayers(e,t,!0))[0]&&(s=a[1]+(a[2]<<8)),"hover"==i?(this.lastHoverFeature=this.hoverFeature,this.lastHoverFeatureId=this.hoverFeatureId,o&&o[3]?(this.hoverFeature=o,this.hoverFeatureId=null!=o?o[0]["#id"]:null):(this.hoverFeature=null,this.hoverFeatureId=null),r=[],this.hoverFeatureId!=this.lastHoverFeatureId&&(null!=this.lastHoverFeatureId&&r.push(["leave",this.lastHoverFeature,this.lastHoverFeatureId]),null!=this.hoverFeatureId&&r.push(["enter",this.hoverFeature,this.hoverFeatureId]),this.dirty=!0),null!=this.hoverFeature&&this.hoverFeature[3]?[this.hoverFeature,!0,r,s]:[null,!1,r,s]):"click"==i?null!=o&&o[2]?[o,!0,[],s]:[null,!1,[],s]:void 0):[null,!1,[],s]},pr.prototype.getCurrentGeometry=function(){if(this.draw.tree.surfaceSequence.length>0){this.draw.tree.draw(!0);var e=this.storedTilesRes;return this.storedTilesRes=[],e}return e},pr.prototype.applyCredits=function(e){var t,i;for(var r in e.imageryCredits)t=e.imageryCredits[r],i=this.visibleCredits.imagery[r],this.visibleCredits.imagery[r]=i?t>i?t:i:t;for(r in e.glueImageryCredits)t=e.glueImageryCredits[r],i=this.visibleCredits.imagery[r],this.visibleCredits.glueImagery[r]=i?t>i?t:i:t;for(r in e.mapdataCredits)t=e.mapdataCredits[r],i=this.visibleCredits.mapdata[r],this.visibleCredits.mapdata[r]=i?t>i?t:i:t},pr.prototype.drawMap=function(){this.draw.drawMap(null)},pr.prototype.processProcessingTasks=function(){for(;this.processingTasks.length>0;){if(this.stats.renderBuild>this.config.mapMaxProcessingTime)return void this.markDirty();this.processingTasks[0](),this.processingTasks.shift()}for(;this.processingTasks2.length>0&&-123!=this.processingTasks2[0]();)this.processingTasks2.shift()},pr.prototype.addProcessingTask=function(e){this.processingTasks.push(e)},pr.prototype.addProcessingTask2=function(e){this.processingTasks2.push(e)},pr.prototype.update=function(){if(!this.killed)if(this.core.tokenExpiration&&Date.now()>this.core.tokenExpiration-6e4&&this.core.tokenExpirationCallback(),this.srsReady){if(!this.div||"hidden"!=this.div.style.visibility){this.position.isSame(this.lastPosition)||this.core.callListener("map-position-changed",{position:this.position.toArray(),"last-position":this.lastPosition.toArray()}),this.camera.lastTerrainHeight!=this.camera.terrainHeight&&this.core.callListener("map-position-fixed-height-changed",{height:this.camera.terrainHeight,"last-height":this.camera.lastTerrainHeight}),this.lastPosition=this.position.clone(),this.camera.lastTerrainHeight=this.camera.terrainHeight,this.drawFog=this.config.mapFog;var e,t=this.renderer.div.getBoundingClientRect(),i=this.renderer,r=i.cameraPosition;i.curSize[0]==t.width&&i.curSize[1]==t.height||(i.onResize(),this.dirty=!0);var s,a=this.dirty||this.dirtyCountdown>0;if(this.stats.begin(a),this.loader.update(),this.processProcessingTasks(),a&&(this.dirty?this.dirtyCountdown=this.config.mapRefreshCycles:this.dirtyCountdown--,this.dirty=!1,this.bestMeshTexelSize=0,this.bestGeodataTexelSize=0,this.renderSlots.processRenderSlots(),this.loader.update(),this.core.callListener("map-update",{})),null!=this.clickEvent||null!=this.hoverEvent){if(null!=this.hoverEvent){var n=(s=this.hitTestGeoLayers(this.hoverEvent[0],this.hoverEvent[1],"hover"))[2];if(null!=n)for(var o=0,h=n.length;o<h;o++){var l=n[o];switch(l[0]){case"enter":e=l[1][1],this.core.callListener("geo-feature-enter",{feature:l[1][0],"canvas-coords":i.project2(l[1][1],i.camera.mvp,r),"physical-coords":[e[0]+r[0],e[1]+r[1],e[2]+r[2]],state:this.hoverEvent[3],element:s[3]});break;case"leave":e=l[1][1],this.core.callListener("geo-feature-leave",{feature:l[1][0],"canvas-coords":i.project2(l[1][1],i.camera.mvp,r),"physical-coords":[e[0]+r[0],e[1]+r[1],e[2]+r[2]],state:this.hoverEvent[3],element:s[3]})}}s[1]&&null!=s[0]&&(e=s[0][1],this.core.callListener("geo-feature-hover",{feature:s[0][0],"canvas-coords":i.project2(s[0][1],i.camera.mvp,r),"physical-coords":[e[0]+r[0],e[1]+r[1],e[2]+r[2]],state:this.hoverEvent[3],element:s[3]})),!0!==this.hoverEvent[2]&&(this.hoverEvent=null)}null!=this.clickEvent&&((s=this.hitTestGeoLayers(this.clickEvent[0],this.clickEvent[1],"click"))[1]&&null!=s[0]&&(e=s[0][1],this.core.callListener("geo-feature-click",{feature:s[0][0],"canvas-coords":i.project2(s[0][1],i.camera.mvp,r),"physical-coords":[e[0]+r[0],e[1]+r[1],e[2]+r[2]],state:this.clickEvent[2],element:s[3]})),this.clickEvent=null)}this.stats.end(a)}}else this.loader.update()};var fr=pr,gr=function(e){this.inspector=e,this.core=e.core};gr.prototype.init=function(){document.addEventListener("keyup",this.onKeyUp.bind(this),!1),document.addEventListener("keypress",this.onKeyPress.bind(this),!1),document.addEventListener("keydown",this.onKeyDown.bind(this),!1)},gr.prototype.onKeyDown=function(e){void 0===e&&(e=window.event),this.altDown=e.altKey,this.ctrlDown=e.ctrlKey,this.shiftDown=e.shiftKey,this.onKeyUp(e,!0)},gr.prototype.onKeyPress=function(e){this.onKeyUp(e,!0)},gr.prototype.onKeyUp=function(e,t){void 0===e&&(e=window.event);var i=this.core.getMap(),r=this.inspector;if(i){var s=i.draw.debug;this.altDown=e.altKey,this.ctrlDown=e.ctrlKey,this.shiftDown=e.shiftKey;var a=!1,n=!0;if(e){var o;if(o=window.event?window.event.keyCode:e.which?e.which:e.charCode,this.shiftDown&&this.ctrlDown)switch(o){case 68:case 100:r.preventDefault(e)}if(this.shiftDown&&!0!==t){if(this.ctrlDown)switch(o){case 68:case 100:r.enableInspector(),this.diagnosticMode=!0,a=!0}if(this.diagnosticMode){switch(n=!0,o){case 67:case 99:r.shakeCamera=!r.shakeCamera;break;case 49:case 50:case 51:case 48:break;case 72:case 104:s.heightmapOnly=!s.heightmapOnly;break;case 81:case 113:var h=i.getPosition();console.log("pos-before: "+JSON.stringify(h.pos)),i.convert.convertPositionViewMode(h,"obj"==h.getViewMode()?"subj":"obj"),console.log("new mode: "+h.getViewMode()),console.log("pos-after: "+JSON.stringify(h.pos)),i.setPosition(h),this.altDown&&"obj"!=h.getViewMode()?i.camera.near=.1:i.camera.near=2,r.preventDefault(e);break;case 80:case 112:i.renderer.saveScreenshot("file","vts-screenshot.png","png");break;case 83:case 115:r.stats.switchPanel();break;case 86:case 118:r.layers.switchPanel();break;case 69:case 101:r.stylesheets.switchPanel();break;case 84:case 116:r.replay.switchPanel();break;case 66:case 98:s.drawBBoxes=!s.drawBBoxes;break;case 65:case 97:s.drawLabelBoxes=!s.drawLabelBoxes;break;case 75:case 107:s.drawAllLabels=!s.drawAllLabels;break;case 73:case 105:s.drawHiddenLabels=!s.drawHiddenLabels;break;case 87:case 119:if(3==s.drawWireframe)s.drawWireframe=1;else{var l=s.drawWireframe+1;s.drawWireframe=l>2?0:l}break;case 70:case 102:s.drawWireframe=3!=s.drawWireframe?3:0;break;case 85:case 117:i.renderer.setSuperElevationState(!i.renderer.useSuperElevation);break;case 71:case 103:s.meshStats=!s.meshStats,a=!0;break;case 77:case 109:i.loaderSuspended=!i.loaderSuspended,console.log("loader state "+i.loaderSuspended);break;case 74:case 106:s.drawEarth=!s.drawEarth,a=!0;break;case 88:case 120:s.drawFog=!s.drawFog,a=!0;break;case 89:case 120:i.config.mapSplitLods=!i.config.mapSplitLods,a=!0;break;case 82:case 114:r.graphs.switchPanel();break;case 79:case 111:i.camera.camera.setOrtho(!i.camera.camera.getOrtho());break;case 76:case 108:r.drawRadar=!r.drawRadar;break;case 90:case 122:s.maxZoom=!s.maxZoom;break;case 78:case 110:s.drawNBBoxes=!s.drawNBBoxes;break;default:n=!1}n&&(a=!0)}}if(this.diagnosticMode&&s.drawWireframe&&!t&&o>=96&&o<=105&&(this.altDown?(s.drawTestData=o-96,this.ctrlDown&&(s.drawTestData+=10)):s.drawTestMode=o-96,a=!0),this.diagnosticMode&&r.drawRadar&&!this.shiftDown&&!t){switch(n=!0,o){case 43:case 107:null==r.radarLod&&(r.radarLod=8),r.radarLod++;break;case 45:case 109:null==r.radarLod&&(r.radarLod=8),r.radarLod=Math.max(0,r.radarLod-1);break;case 42:case 106:r.radarLod=null;break;default:n=!1}n&&(a=!0)}if(this.diagnosticMode&&(s.drawBBoxes||s.drawNBBoxes)&&!this.shiftDown&&!t){switch(n=!0,o){case 76:case 108:s.drawLods=!s.drawLods;break;case 80:case 112:s.drawPositions=!s.drawPositions;break;case 85:case 117:s.drawOctants=!s.drawOctants;break;case 84:case 116:s.drawTextureSize=!s.drawTextureSize;break;case 70:case 102:s.drawFaceCount=!s.drawFaceCount;break;case 71:case 103:s.drawGeodataOnly=!s.drawGeodataOnly;break;case 68:case 100:s.drawDistance=!s.drawDistance;break;case 86:case 118:s.drawSpaceBBox=!s.drawSpaceBBox;break;case 78:case 110:s.drawNodeInfo=!s.drawNodeInfo;break;case 77:case 109:s.drawMeshBBox=!s.drawMeshBBox;break;case 73:case 105:s.drawIndices=!s.drawIndices;break;case 66:case 98:s.drawBoundLayers=!s.drawBoundLayers;break;case 82:case 114:s.drawResources=!s.drawResources;break;case 83:case 115:s.drawSurfaces=!s.drawSurfaces;break;case 90:case 122:s.drawSurfaces2=!s.drawSurfaces2;break;case 67:case 99:s.drawCredits=!s.drawCredits;break;case 79:case 111:s.drawOrder=!s.drawOrder;break;case 69:case 101:s.debugTextSize=2==s.debugTextSize?3:2;break;case 88:case 120:i.config.mapPreciseBBoxTest=!i.config.mapPreciseBBoxTest;break;case 87:case 119:s.drawPolyWires=!s.drawPolyWires;break;case 90:case 122:i.config.mapPreciseDistanceTest=!i.config.mapPreciseDistanceTest;break;case 75:case 107:s.drawGPixelSize=!s.drawGPixelSize;break;default:n=!1}n&&(a=!0)}}a&&(i.markDirty(),r.preventDefault(e))}},gr.prototype.setParameter=function(e,t){var i=this.core.getMap(),r=this.inspector;if(i){var s=i.draw.debug,a=function(e){return!0===t||"true"==t||"1"==t};switch(e){case"debugMode":this.diagnosticMode=!0;break;case"debugBBox":s.drawBBoxes=!0;case"debugNBBox":"debugNBBox"==e&&(s.drawNBBoxes=!0);var n=function(e){return-1!=t.indexOf(e)};n("L")&&(s.drawLods=!0),n("P")&&(s.drawPositions=!0),n("T")&&(s.drawTextureSize=!0),n("F")&&(s.drawFaceCount=!0),n("G")&&(s.drawGeodataOnly=!0),n("D")&&(s.drawDistance=!0),n("N")&&(s.drawNodeInfo=!0),n("V")&&(s.drawSpaceBBox=!0),n("M")&&(s.drawMeshBBox=!0),n("I")&&(s.drawIndices=!0),n("U")&&(s.drawOctants=!0),n("B")&&(s.drawBoundLayers=!0),n("S")&&(s.drawSurfaces=!0),n("Z")&&(s.drawSurfaces2=!0),n("C")&&(s.drawCredits=!0),n("O")&&(s.drawOrder=!0),n("E")&&(s.debugTextSize=3),n("K")&&(s.drawGPixelSize=!0);break;case"debugLBox":s.drawLabelBoxes=a();break;case"debugNoEarth":s.drawEarth=!a();break;case"debugShader":s.drawWireframe=parseInt(t);break;case"debugHeightmap":s.heightmapOnly=a();break;case"debugGridCells":s.drawGridCells=a();break;case"debugRadar":r.enableInspector(),r.drawRadar=!0,r.radarLod=parseInt(t),isNaN(r.radarLod)&&(r.radarLod=null)}i.markDirty()}};var mr=gr,vr=function(e){this.inspector=e,this.core=e.core};vr.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-stats-panel {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;display: none;padding:15px;width: 305px;font-size: 14px;position: absolute;right: 10px;top: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-stats-panel-info {margin-top: 5px;margin-bottom: 3px;overflow: hidden;}#vts-stats-panel-info table {color:#000000;text-align: left;font-size: 12px;}#vts-stats-panel-info table td {vertical-align: top;}#vts-stats-panel-pos {width: 100%;}'),this.element=document.createElement("div"),this.element.id="vts-stats-panel",this.element.innerHTML='<span id="vts-stats-panel-title">Render statistics &nbsp;&nbsp;&nbsp;v'+wa()+'</h3><p id="vts-stats-panel-info"></p><input id="vts-stats-panel-pos" type="text">',this.core.element.appendChild(this.element),this.infoElement=document.getElementById("vts-stats-panel-info"),this.posElement=document.getElementById("vts-stats-panel-pos"),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.panelVisible=!1},vr.prototype.showPanel=function(){this.element.style.display="block",this.panelVisible=!0},vr.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},vr.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},vr.prototype.updateStatsPanel=function(e){if(this.infoElement&&this.panelVisible){var t=this.inspector,i="FPS: "+Math.round(e.fps)+"<br/>Render time: "+Math.round(1e3*e.renderTime)+"<br/> - resources: "+Math.round(e.gpuRenderUsed/1048576)+"MB<br/> - topdown: "+Math.round(e.gpuNeeded/1048576)+"MB<br/>GPU Cache: "+Math.round(e.gpuUsed/1048576)+"MB<br/> - textures: "+Math.round(e.gpuTextures/1048576)+"MB<br/> - meshes: "+Math.round(e.gpuMeshes/1048576)+"MB<br/> - geodata: "+Math.round(e.gpuGeodata/1048576)+"MB<br/>CPU Cache: "+Math.round(e.resourcesUsed/1048576)+"MB<br/>Metatile Cache: "+Math.round(e.metaUsed/1048576)+"MB<br/>Draw calls: "+e.drawCalls+"<br/>Polygons: "+e.drawnFaces+"<br/><br/>Terrain Height: "+e.heightTerrain.toFixed(2)+"<br/>- float: "+e.heightDelta.toFixed(2)+"<br/>- desired lod: "+e.heightLod.toFixed(2)+"<br/>- used lod: "+e.heightNode.toFixed(2)+"<br/>- used source: "+(2==e.heightClass?"navtile":1==e.heightClass?"node":"---")+"<br/>Terrain Radar Lod: "+t.radarLod+"<br/><br/>Loaded/Errors: "+e.loadedCount+" / "+e.loadErrorCount+"<br/>Load time: "+(.001*(e.loadLast-e.loadFirst)).toFixed(2)+"s <br/>",r=this.core.renderer;r&&(i+="<br/>Render jobs: "+r.totalJobs+"<br/>Drawn jobs: "+r.drawnJobs+"<br/>Jobs total time: "+Math.round(1e3*(r.jobsTimer2-r.jobsTimer1))+"<br/>Jobs reduce time: "+Math.round(1e3*r.jobsTimer4)+"<br/>"),e.debugStr&&(i+=e.debugStr+"<br/>");var s="PixelRatio: "+(window.devicePixelRatio||1).toFixed(3)+"<br/>BFRate: "+Math.round(1e3/(e.frameTime+1e-5))+"<br/><br/>",a=this.core.getMap();a&&(s+="ReduceMode: <br/>"+a.config.mapFeaturesReduceMode+"<br/>ReduceParams: <br/>"+JSON.stringify(a.config.mapFeaturesReduceParams)+"<br/><br/>",a.draw.debug.meshStats&&(s+="TexelsPerPoly: "+(e.meshesUVArea/Math.max(1,e.meshesFaces)).toFixed(2)+"<br/><br/>")),s+="Metatiles: "+e.processedMetatiles+"<br/>Metanodes: "+e.processedNodes+" / "+e.usedNodes+"<br/>GeodataTiles: "+e.drawnGeodataTiles+"<br/>",e.octoNodes&&(s+="OctoNodes: "+e.octoNodes+"<br/>OctoNodesMem: "+Math.round(e.octoNodesMemSize/1048576)+"MB<br/>"),s+="<br/>",r&&(s+="Nodes: "+r.drawnNodes+"<br/><br/>"),s+="Tiles: "+e.drawnTiles+"<br/>";for(var n=0,o=e.renderedLods.length;n<o;n++)e.renderedLods[n]&&(s+="LOD "+n+": "+e.renderedLods[n]+"<br/>");var h='<table style="width:305px"><tr><td>'+i+"</td><td>"+s+"</td></tr></table>";if(this.infoElement.innerHTML=h,a){var l=a.getPosition(),u="";u+=l.getViewMode()+",";var c=l.getCoords();u+=c[0]+","+c[1]+","+l.getHeightMode()+","+c[2].toFixed(2)+",";var d=l.getOrientation();u+=d[0].toFixed(2)+","+d[1].toFixed(2)+","+d[2].toFixed(2)+",",u+=l.getViewExtent().toFixed(2)+","+l.getFov().toFixed(2),this.posElement.value!=u&&(this.posElement.value=u)}}};var yr=vr,br=function(e){this.inspector=e,this.core=e.core};br.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-graphs-panel {position:absolute;left:10px;top:10px;z-index: 7;background-color: #FFFFFF;padding: 5px;border-radius: 4px;font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;color:#000000;text-align: left;font-size: 12px;display:none;}.vts-graphs-canvas {border: solid 1px #bbb;image-rendering : pixelated;}.vts-graphs-info {padding: 5px 2px;font-size: 10px;}.vts-graphs-button {padding: 2px 5px;display:inline-block;margin-right: 4px;border-radius: 4px;cursor:pointer;}.vts-graphs-button:hover {box-shadow: 0 0 1px #0066ff;}'),this.element=document.createElement("div"),this.element.id="vts-graphs-panel",this.element.innerHTML='<canvas id="vts-graphs-render" class="vts-graphs-canvas" width="900" height="100" ></canvas><div id="vts-graphs-info" class="vts-graphs-info" >&FilledSmallSquare; Frame: 1234 &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Render: 1234 &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: 1234 &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Mesh: 1234 &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> GpuMesh: 1234</div><canvas id="vts-graphs-cache" class="vts-graphs-canvas" width="900" height="100" ></canvas><div id="vts-graphs-info2" class="vts-graphs-info" >&FilledSmallSquare; Cache: 1234 &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Used: 123 &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: 1234 &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> Mesh: &nbsp 1234</div><div id="vts-graphs-rec" class="vts-graphs-button" >Recording On</div><div id="vts-graphs-ref" class="vts-graphs-button" >Refresh On</div><div id="vts-graphs-res" class="vts-graphs-button" >Reset</div><div id="vts-graphs-zoom" class="vts-graphs-button" >Scale: Max value</div><div id="vts-graphs-magnify" class="vts-graphs-button" >Magnify Off</div><div id="vts-graphs-graph" class="vts-graphs-button" >Graph: Cache</div>',this.core.element.appendChild(this.element),this.canvasRender=document.getElementById("vts-graphs-render"),this.canvasCache=document.getElementById("vts-graphs-cache"),this.canvasRenderCtx=this.canvasRender.getContext("2d"),this.canvasCacheCtx=this.canvasCache.getContext("2d"),document.getElementById("vts-graphs-rec").onclick=this.recordingPressed.bind(this),document.getElementById("vts-graphs-rec").onclick=this.recordingPressed.bind(this),document.getElementById("vts-graphs-ref").onclick=this.refreshPressed.bind(this),document.getElementById("vts-graphs-res").onclick=this.resetPressed.bind(this),document.getElementById("vts-graphs-zoom").onclick=this.zoomPressed.bind(this),document.getElementById("vts-graphs-magnify").onclick=this.magnifyPressed.bind(this),document.getElementById("vts-graphs-graph").onclick=this.graphPressed.bind(this),document.getElementById("vts-graphs-render").onmousemove=this.onMouseMove.bind(this),document.getElementById("vts-graphs-render").onmouseout=this.onMouseOut.bind(this),document.getElementById("vts-graphs-cache").onmousemove=this.onMouseMove.bind(this),document.getElementById("vts-graphs-cache").onmouseout=this.onMouseOut.bind(this),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.zoom="max",this.graph="Cache",this.refresh=!0,this.panelVisible=!1},br.prototype.showPanel=function(){this.element.style.display="block",this.panelVisible=!0,this.recordingPressed(!0)},br.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1,this.recordingPressed(!0)},br.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},br.prototype.recordingPressed=function(e){var t=this.core.getMap();t&&(t.stats.recordGraphs=null==e?e:!t.stats.recordGraphs,this.updateGraphsPanel(),this.updateGraphs(null,!0))},br.prototype.refreshPressed=function(){this.refresh=!this.refresh,this.updateGraphsPanel(),this.updateGraphs()},br.prototype.resetPressed=function(){var e=this.core.getMap();e&&(e.stats.resetGraphs(),this.updateGraphs(null,!0))},br.prototype.zoomPressed=function(){switch(this.zoom){case"max":this.zoom="120avrg";break;case"120avrg":this.zoom="180avrg";break;case"180avrg":this.zoom="max"}this.updateGraphsPanel(),this.updateGraphs()},br.prototype.graphPressed=function(){switch(this.graph){case"Cache":this.graph="Polygons";break;case"Polygons":this.graph="Processing";break;case"Processing":this.graph="LODs";break;case"LODs":this.graph="Flux";break;case"Flux":this.graph="Cache"}this.updateGraphsPanel(),this.updateGraphs()},br.prototype.magnifyPressed=function(){this.magnify=!this.magnify,this.magnify?(this.canvasRender.style.width="1400px",this.canvasRender.style.height="200px",this.canvasCache.style.width="1400px",this.canvasCache.style.height="200px",document.getElementById("vts-graphs-magnify").innerHTML="Magnify On"):(this.canvasRender.style.width="900px",this.canvasRender.style.height="100px",this.canvasCache.style.width="900px",this.canvasCache.style.height="100px",document.getElementById("vts-graphs-magnify").innerHTML="Magnify Off"),this.updateGraphsPanel(),this.updateGraphs()},br.prototype.updateGraphsPanel=function(){var e=this.core.getMap();if(e){switch(e.stats.recordGraphs?document.getElementById("vts-graphs-rec").innerHTML="Recording On":document.getElementById("vts-graphs-rec").innerHTML="Recording Off",this.refresh?document.getElementById("vts-graphs-ref").innerHTML="Refresh On":document.getElementById("vts-graphs-ref").innerHTML="Refresh Off",this.zoom){case"max":document.getElementById("vts-graphs-zoom").innerHTML="Scale: Max value";break;case"120avrg":document.getElementById("vts-graphs-zoom").innerHTML="Scale: 100% Avrg";break;case"180avrg":document.getElementById("vts-graphs-zoom").innerHTML="Scale: 50% Avrg"}document.getElementById("vts-graphs-graph").innerHTML="Graph: "+this.graph}},br.prototype.onMouseMove=function(e){var t=e.clientX-this.canvasRender.getBoundingClientRect().left;this.showCursor=!0,this.magnify&&(t=Math.floor(900*t/1400)),this.cursorIndex=t;var i=this.core.getMap();i&&(i.stats.recordGraphs||this.updateGraphs(null))},br.prototype.onMouseOut=function(){this.showCursor=!1,this.updateGraphs(null)},br.prototype.updateGraphs=function(e,t){var i=this.core.getMap();if(i&&(this.refresh||t)&&this.panelVisible){e=e||i.stats;var r=this.canvasRender.width,s=this.canvasRender.height,a=this.canvasRenderCtx,n=e.graphsTimeSamples,o=e.graphsTimeIndex,h=r/n;a.clearRect(0,0,r,s);var l,u,c,d,p,f,g,m,v,y,b,x,w=0,M=0,S=0,A=0,C=0,T=0,P=0,F=e.graphsFrameTimes,L=e.graphsRenderTimes,E=e.graphsCreateTextureTimes,k=e.graphsCreateMeshTimes,N=e.graphsCreateGpuMeshTimes;for(l=0;l<n;l++){M+=F[l],S+=L[l],A+=E[l],C+=k[l],T+=N[l];var I=F[l];I>w&&(w=I),I>0&&P++}for("120avrg"==this.zoom&&(w=M/P*1),"180avrg"==this.zoom&&(w=M/P*.5),v=s/w,l=0;l<n;l++)d=o+l,d%=n,a.fillStyle="#000000",a.fillRect(l*h,s,1,-F[d]*v),a.fillStyle="#ff0000",a.fillRect(l*h,s,1,-L[d]*v),a.fillStyle="#0000ff",a.fillRect(l*h,s,1,-E[d]*v),m=s-E[d]*v,a.fillStyle="#007700",a.fillRect(l*h,m,1,-k[d]*v),m-=k[d]*v,a.fillStyle="#00ff00",a.fillRect(l*h,m,1,-N[d]*v);switch(this.showCursor?(a.fillStyle="#aa00aa",d=this.cursorIndex%n,a.fillRect(Math.floor(d*h)-1,0,1,s),a.fillRect(Math.floor(d*h)+1,0,1,s),g="&FilledSmallSquare; Frame: "+F[d=(this.cursorIndex+o)%n].toFixed(2)+' &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Render: '+L[d].toFixed(2)+' &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: '+E[d].toFixed(2)+' &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Meshes: '+k[d].toFixed(2)+' &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> GpuMeshes: '+N[d].toFixed(2)+"</div>"):g="&FilledSmallSquare; Frame: "+Math.round(M)+' &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Render: '+Math.round(S)+' &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Textures: '+Math.round(A)+' &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Meshes: '+Math.round(C)+' &nbsp <span style="color:#00bb00">&FilledSmallSquare;</span> GpuMeshes: '+Math.round(T)+"</div>",document.getElementById("vts-graphs-info").innerHTML=g,r=this.canvasCache.width,s=this.canvasCache.height,h=r/n,(a=this.canvasCacheCtx).clearRect(0,0,r,s),this.graph){case"Cache":v=s/(i.gpuCache.maxCost+i.resourcesCache.maxCost+i.metatileCache.maxCost);var B=0,R=0,z=0,U=0,D=0,_=0,O=e.graphsCpuMemoryMetatiles,G=e.graphsCpuMemoryUsed,V=e.graphsGpuMemoryRender;for(x=e.graphsGpuMemoryGeodata,E=e.graphsGpuMemoryTextures,k=e.graphsGpuMemoryMeshes,l=0;l<n;l++)B=O[l]>B?O[l]:B,R=G[l]>R?G[l]:R,z=E[l]>z?E[l]:z,U=k[l]>U?k[l]:U,D=x[l]>D?x[l]:D,_=V[l]>_?V[l]:_;for(l=0;l<n;l++)d=o+l,p=O[d%=n]+k[d]+E[d]+x[d]+G[d],a.fillStyle="#000000",a.fillRect(l*h,s,1,-p*v),p-=G[d],a.fillStyle="#0000ff",a.fillRect(l*h,s,1,-p*v),p-=E[d],a.fillStyle="#009999",a.fillRect(l*h,s,1,-p*v),p-=x[d],a.fillStyle="#007700",a.fillRect(l*h,s,1,-p*v),p-=k[d],a.fillStyle="#ff0000",a.fillRect(l*h,s,1,-p*v),p=V[d],a.fillStyle="#ffff00",a.fillRect(l*h,s-p*v,1,1);this.showCursor?(d=(this.cursorIndex+o)%n,g='<span style="color:#555">&FilledSmallSquare;</span> Total: '+Math.ceil((O[d]+G[d]+E[d]+k[d])/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> CPU: '+Math.ceil(G[d]/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> GPU: '+Math.ceil((E[d]+k[d])/1048576)+'MB &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Te: '+Math.ceil(E[d]/1048576)+'MB &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Me: '+Math.ceil(k[d]/1048576)+'MB &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Ge: '+Math.ceil(x[d]/1048576)+'MB &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Met: '+Math.ceil(O[d]/1048576)+'MB &nbsp <span style="color:#ffff00">&FilledSmallSquare;</span> Render: '+Math.ceil(V[d]/1048576)+"MB</div>"):g='<span style="color:#555">&FilledSmallSquare;</span> Total: '+Math.round((B+R+z+U)/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> CPU: '+Math.ceil(R/1048576)+'MB &nbsp <span style="color:#000000">&FilledSmallSquare;</span> GPU: '+Math.ceil((z+U)/1048576)+'MB &nbsp <span style="color:#0000ff">&FilledSmallSquare;</span> Te '+Math.ceil(z/1048576)+'MB &nbsp <span style="color:#005500">&FilledSmallSquare;</span> Me: '+Math.ceil(U/1048576)+'MB &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Ge: '+Math.ceil(D/1048576)+'MB &nbsp <span style="color:#ff0000">&FilledSmallSquare;</span> Met: '+Math.ceil(B/1048576)+'MB &nbsp <span style="color:#ffff00">&FilledSmallSquare;</span> Render: '+Math.ceil(_/1048576)+"MB</div>";break;case"Polygons":case"Processing":y=0,b=99999999999,P=0,f="Polygons"==this.graph?e.graphsPolygons:e.graphsBuild;var j=0;for(l=0;l<n;l++)y=f[l]>y?f[l]:y,f[l]>0&&(b=f[l]<b?f[l]:b,j+=f[l],P++);for(v=s/y,l=0;l<n;l++)d=o+l,d%=n,a.fillStyle="#007700",a.fillRect(l*h,s,1,-f[d]*v);this.showCursor?(d=(this.cursorIndex+o)%n,g='<span style="color:#007700">&FilledSmallSquare;</span> '+this.graph+" Max: "+Math.round(f[d])+"</div>"):(g='<span style="color:#007700">&FilledSmallSquare;</span> '+this.graph+" Max: "+y+"</div>",g+=" &nbsp Min: "+b,g+=" &nbsp Avrg: "+Math.round(j/P)+"</div>");break;case"LODs":for(y=0,f=e.graphsLODs,l=0;l<n;l++)y=f[l][0]>y?f[l][0]:y;var H;for(v=s/y,a.fillStyle="#000000",a.fillRect(0,0,r,s),l=0;l<n;l++)for(d=o+l,m=s,u=0,c=(H=f[d%=n][1]).length;u<c;u++)H[u]&&(a.fillStyle="hsl("+23*u%360+",100%,50%)",p=Math.round(H[u]*v),a.fillRect(l*h,m,1,-p),m-=p);if(this.showCursor)for(g="LODs:"+f[d=(this.cursorIndex+o)%n][0],u=0,c=(H=f[d][1]).length;u<c;u++)H[u]&&(g+='<span style="color:hsl('+23*u%360+',100%,50%)">&FilledSmallSquare;</span>'+u+":"+H[u]);else g="LODs:"+f[d][0];g+="</div>";break;case"Flux":var W=0,q=0,Z=0,Y=0,J=0,K=0,Q=0,X=0,$=0,ee=0,te=0,ie=0,re=0,se=0;for(E=e.graphsFluxTextures,k=e.graphsFluxMeshes,x=e.graphsFluxGeodatas,l=0;l<n;l++){var ae=E[l][0][0]+k[l][0][0];W=ae>W?ae:W,W=(ae=E[l][1][0]+k[l][1][0])>W?ae:W,q=(ae=E[l][0][1]+k[l][0][1])>q?ae:q,q=(ae=E[l][1][1]+k[l][1][1])>q?ae:q,Z=E[l][0][0]>Z?E[l][0][0]:Z,Y=E[l][0][1]>Y?E[l][0][1]:Y,J=E[l][1][0]>J?E[l][1][0]:J,K=E[l][1][1]?E[l][1][1]:K,Q=k[l][0][0]>Q?k[l][0][0]:Q,X=k[l][0][1]>X?k[l][0][1]:X,$=k[l][1][0]>$?k[l][1][0]:$,ee=k[l][1][1]>ee?k[l][1][1]:ee,te=x[l][0][0]>te?x[l][0][0]:te,ie=x[l][0][1]>ie?x[l][0][1]:ie,re=x[l][1][0]>re?x[l][1][0]:re,se=x[l][1][1]>se?x[l][1][1]:se}v=(.25*s-2)/W;var ne=(.25*s-2)/q,oe=Math.floor(.25*s),he=Math.floor(.75*s);for(l=0;l<n;l++){d=o+l,d%=n;var le=oe,ue=oe+1,ce=he,de=he+1;a.fillStyle="#0000aa",a.fillRect(l*h,le,1,-E[d][0][0]*v),a.fillRect(l*h,ue,1,E[d][1][0]*v),a.fillRect(l*h,ce,1,-E[d][0][1]*ne),a.fillRect(l*h,de,1,E[d][1][1]*ne),le-=E[d][0][0]*v,ue+=E[d][1][0]*v,ce-=E[d][0][1]*ne,de+=E[d][1][1]*ne,a.fillStyle="#007700",a.fillRect(l*h,le,1,-k[d][0][0]*v),a.fillRect(l*h,ue,1,k[d][1][0]*v),a.fillRect(l*h,ce,1,-k[d][0][1]*ne),a.fillRect(l*h,de,1,k[d][1][1]*ne),le-=k[d][0][0]*v,ue+=k[d][1][0]*v,ce-=k[d][0][1]*ne,de+=k[d][1][1]*ne,a.fillStyle="#009999",a.fillRect(l*h,le,1,-x[d][0][0]*v),a.fillRect(l*h,ue,1,x[d][1][0]*v),a.fillRect(l*h,ce,1,-x[d][0][1]*ne),a.fillRect(l*h,de,1,x[d][1][1]*ne),a.fillStyle="#aaaaaa",a.fillRect(0,Math.floor(.5*s),r,1),a.fillStyle="#dddddd",a.fillRect(0,oe,r,1),a.fillRect(0,he,r,1)}this.showCursor?(g='<span style="color:#007700">&FilledSmallSquare;</span> Textures Count +/-: '+E[d=(this.cursorIndex+o)%n][0][0]+"/"+E[d][1][0],g+=" &nbsp Size +/-: "+(E[d][0][1]/1024/1024).toFixed(2)+"/"+(E[d][1][1]/1024/1024).toFixed(2),g+=' &nbsp <span style="color:#0000aa">&FilledSmallSquare;</span> Meshes Count +/-: '+k[d][0][0]+"/"+k[d][1][0],g+=" &nbsp Size +/-: "+(k[d][0][1]/1024/1024).toFixed(2)+"/"+(k[d][1][1]/1024/1024).toFixed(2),g+=' &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Geodata Count +/-: '+x[d][0][0]+"/"+x[d][1][0],g+=" &nbsp Size +/-: "+(x[d][0][1]/1024/1024).toFixed(2)+"/"+(x[d][1][1]/1024/1024).toFixed(2),g+="</div>"):(g='<span style="color:#007700">&FilledSmallSquare;</span> Textures Count +/-: '+Z+"/"+J,g+=" &nbsp Size +/-: "+(Y/1024/1024).toFixed(2)+"/"+(K/1024/1024).toFixed(2),g+=' &nbsp <span style="color:#0000aa">&FilledSmallSquare;</span> Meshes Count +/-: '+Q+"/"+$,g+=" &nbsp Size +/-: "+(X/1024/1024).toFixed(2)+"/"+(ee/1024/1024).toFixed(2),g+=' &nbsp <span style="color:#009999">&FilledSmallSquare;</span> Geodata Count +/-: '+te+"/"+re,g+=" &nbsp Size +/-: "+(ie/1024/1024).toFixed(2)+"/"+(se/1024/1024).toFixed(2),g+="</div>")}this.showCursor&&(a.fillStyle="#aa00aa",d=this.cursorIndex%n,a.fillRect(Math.floor(d*h)-1,0,1,s),a.fillRect(Math.floor(d*h)+1,0,1,s)),document.getElementById("vts-graphs-info2").innerHTML=g}};var xr=br,wr=function(e){this.inspector=e,this.core=e.core};wr.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-layers-panel {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;display: none;padding:15px;font-size: 14px;position: absolute;right: 10px;bottom: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-layers-panel button {max-width: 23px;max-height: 21px;}#vts-layers-panel-title {margin-bottom: 3px;}#vts-layers-views-panel {margin-top: 5px;float: left;}#vts-layers-views-items {width: 191px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;}#vts-layers-surfaces-panel {margin-top: 5px;float: left;}#vts-layers-surfaces-items {width: 150px;overflow-y: scroll;overflow-x: hidden;height: 200px;border-top: 1px solid #ddd;border-bottom: 1px solid #ddd;}#vts-layers-boundlayers-panel {margin-top: 5px;float: left;}#vts-layers-boundlayers-items {width: 275px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;border-right: none;}#vts-layers-freelayers-panel {margin-top: 5px;float: left;}#vts-layers-freelayers-items {width: 150px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;}#vts-layers-fl-properties-panel {margin-top: 5px;float: left;}#vts-layers-fl-properties-items {width: 250px;overflow-y: scroll;overflow-x: hidden;height: 200px;border: 1px solid #ddd;border-right: none;}#vts-layers-json-panel {margin-top: 5px;float: right;}#vts-layers-json-text {width: 200px;resize: none;height: 180px;border: 1px solid #ddd;white-space: pre;padding: 0px;}#vts-layers-json-text2 {width: 200px;height: 21px;border: 1px solid #ddd;}.vts-layers-panel-title {margin: 0px;margin-bottom: 5px;}.vts-layers-item {width: 100%;}.vts-layers-item input[type=number]{width: 43px;}.vts-layers-name {width: 120px;display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}.vts-layers-name2 {width: 126px;display: inline-block;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}#vts-layers-fl-properties-style {width: 175px;height: 21px;}.vts-surface-item {width: 100%;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}'),this.element=document.createElement("div"),this.element.id="vts-layers-panel",this.element.innerHTML='<div id="vts-layers-views-panel"><p class="vts-layers-panel-title">Named Views:</p><div id="vts-layers-views-items"></div></div><div id="vts-layers-surfaces-panel"><p class="vts-layers-panel-title">Surfaces:</p><div id="vts-layers-surfaces-items"></div></div><div id="vts-layers-boundlayers-panel"><p class="vts-layers-panel-title">Surface Bound Layers:</p><div id="vts-layers-boundlayers-items"></div></div><div id="vts-layers-freelayers-panel"><p class="vts-layers-panel-title">Free Layers:</p><div id="vts-layers-freelayers-items"></div></div><div id="vts-layers-fl-properties-panel"><p class="vts-layers-panel-title">Free Layer Properties:</p><div id="vts-layers-fl-properties-items"></div></div><div id="vts-layers-json-panel"><p class="vts-layers-panel-title">Definition:</p><textarea id="vts-layers-json-text" cols="48"></textarea><br/><input id="vts-layers-json-text2" type="text"></div>',this.core.element.appendChild(this.element),this.viewItems=document.getElementById("vts-layers-views-items"),this.surfacesItems=document.getElementById("vts-layers-surfaces-items"),this.boundLayersItems=document.getElementById("vts-layers-boundlayers-items"),this.freeLayersItems=document.getElementById("vts-layers-freelayers-items"),this.freeLayersPropertiesItems=document.getElementById("vts-layers-fl-properties-items"),this.jsonText=document.getElementById("vts-layers-json-text"),this.jsonText2=document.getElementById("vts-layers-json-text2"),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.views=[],this.panelVisible=!1,this.panelInitialized=!1,this.currentView="",this.currentSurface="",this.currentFreeLayer=""},wr.prototype.initViews=function(){var e=this.core.getMap();if(e){var t,i,r,s,a,n,o,h,l,u,c,d=e.getNamedViews(),p="--initial--";for(this.views[p]={surfaces:{},freeLayers:{},options:{},original:JSON.parse(JSON.stringify(e.getView()))},i=0,r=d.length;i<r;i++)l=d[i],this.views[l]={surfaces:{},freeLayers:{},options:{},original:JSON.parse(JSON.stringify(e.getNamedView(l).getInfo()))};for(var f in this.currentView=p,d=this.views){for(l=d[f],i=0,r=(u=e.getSurfaces()).length;i<r;i++){for(p=u[i],y=e.getSurface(p),o=[],s=0,a=(n=e.getBoundLayers()).length;s<a;s++)o.push({id:n[s],alpha:100,options:"{}",enabled:!1});l.surfaces[p]={enabled:!1,layers:o}}var g=e.getFreeLayers();for(i=0,r=g.length;i<r;i++){for(p=g[i],o=[],s=0,a=(n=e.getBoundLayers()).length;s<a;s++)o.push({id:n[s],alpha:100,options:"{}",enabled:!1});var m=(t=e.getFreeLayer(p)).getInfo();l.freeLayers[p]={enabled:!1,style:null,originalStyle:m.style,depthShift:0,depthShift2:0,depthShift3:0,layers:o}}var v=l.original.surfaces;for(c in v)if(n=v[c],l.surfaces[c]){var y=l.surfaces[c];for(y.enabled=!0,i=0,r=n.length;i<r;i++)"string"==typeof n[i]?-1!=(h=this.findIdInArray(y.layers,n[i]))&&y.layers[h]&&(y.layers[h].enabled=!0,y.layers.splice(i,0,y.layers.splice(h,1)[0])):(p=n[i].id,-1!=(h=this.findIdInArray(y.layers,p))&&y.layers[h]&&(y.layers[h].enabled=!0,y.layers[h].alpha=n[i].alpha?100*parseFloat(n[i].alpha):100,y.layers[h].options=n[i].options?JSON.stringify(n[i].options):"{}",y.layers.splice(i,0,y.layers.splice(h,1)[0])))}var b=l.original.freeLayers;for(c in b){var x=b[c];if(l.freeLayers[c]){(t=l.freeLayers[c]).enabled=!0;var w=x.depthOffset||[0,0,0];for(t.depthShift=w[0],t.depthShift2=w[1],t.depthShift3=w[2],t.style=x.style,i=0,r=(n=x.boundLayers||[]).length;i<r;i++)"string"==typeof n[i]?-1!=(h=this.findIdInArray(t.layers,n[i]))&&t.layers[h]&&(t.layers[h].enabled=!0,t.layers.splice(i,0,t.layers.splice(h,1)[0])):(p=n[i].id,-1!=(h=this.findIdInArray(t.layers,p))&&y.layers[h]&&(t.layers[h].enabled=!0,t.layers[h].alpha=n[i].alpha?100*parseFloat(n[i].alpha):100,t.layers[h].options=n[i].options?JSON.stringify(n[i].options):"{}",t.layers.splice(i,0,y.layers.splice(h,1)[0])))}}}}},wr.prototype.findIdInArray=function(e,t){for(var i=0,r=e.length;i<r;i++)if(e[i].id==t)return i;return-1},wr.prototype.buildViews=function(){if(this.core.getMap()){var e=this.views,t="";for(var i in e)t+='<div class="vts-views-item" id="vts-views-item-'+i+'"><div class="vts-layers-name2">'+i+'</div><button id="vts-views-cbutton-'+i+'" type="button" title="Clone">C</button><button id="vts-views-xbutton-'+i+'" type="button" title="Remove">X</button></div>';for(i in this.viewItems.innerHTML=t,e){r="vts-views-cbutton-"+i,document.getElementById(r).onclick=this.switchView.bind(this,i,r,"clone"),r="vts-views-xbutton-"+i,document.getElementById(r).onclick=this.switchView.bind(this,i,r,"remove");var r="vts-views-item-"+i;document.getElementById(r).onclick=this.selectView.bind(this,i)}}},wr.prototype.buildSurfaces=function(){var e,t,i=this.views[this.currentView].surfaces,r="",s=null;for(t in i)r+='<div id="vts-surface-item-'+t+'" class="vts-surface-item"><input id="vts-surface-checkbox-'+t+'" type="checkbox"/><span title='+t+">"+t+"</span></div>",null===s&&(s=t);for(t in this.surfacesItems.innerHTML=r,this.currentSurface=s,i)i[t].enabled&&(e="vts-surface-checkbox-"+t,document.getElementById(e).checked=!0);for(t in i)e="vts-surface-checkbox-"+t,document.getElementById(e).onchange=this.switchSurface.bind(this,t,e),e="vts-surface-item-"+t,document.getElementById(e).onclick=this.selectSurface.bind(this,t)},wr.prototype.buildBoundLayers=function(e){var t=this.views[this.currentView],i="";if(t.surfaces[e])for(var r=t.surfaces[e].layers,s=0,a=r.length;s<a;s++){var n=r[s];i+='<div class="vts-layers-item"><input id="vts-boundlayer-checkbox-'+n.id+'" type="checkbox" '+(n.enabled?"checked":"")+'/><div class="vts-layers-name">'+n.id+'</div><input id="vts-boundlayer-spinner-'+n.id+'" type="number" title="Alpha" min="0" max="100" step="10" value="'+n.alpha+'"><button id="vts-boundlayer-obutton-'+n.id+'" type="button" title="Options">O</button><button id="vts-boundlayer-ubutton-'+n.id+'" type="button" title="Move Above">&uarr;</button><button id="vts-boundlayer-dbutton-'+n.id+'" type="button" title="Move Bellow">&darr;</button></div>'}if(this.boundLayersItems.innerHTML=i,t.surfaces[e])for(s=0,a=r.length;s<a;s++){var o="vts-boundlayer-checkbox-"+r[s].id;document.getElementById(o).onchange=this.switchBoundLayer.bind(this,r[s].id,o,"enable"),o="vts-boundlayer-spinner-"+r[s].id,document.getElementById(o).onchange=this.switchBoundLayer.bind(this,r[s].id,o,"alpha"),o="vts-boundlayer-obutton-"+r[s].id,document.getElementById(o).onclick=this.switchBoundLayer.bind(this,r[s].id,o,"options"),o="vts-boundlayer-ubutton-"+r[s].id,document.getElementById(o).onclick=this.switchBoundLayer.bind(this,r[s].id,o,"up"),o="vts-boundlayer-dbutton-"+r[s].id,document.getElementById(o).onclick=this.switchBoundLayer.bind(this,r[s].id,o,"down")}},wr.prototype.buildFreeLayers=function(){var e=this.views[this.currentView].freeLayers,t="";for(var i in e)t+='<div class="vts-surface-item" id="vts-freelayer-item-'+i+'"><input id="vts-freelayer-checkbox-'+i+'" type="checkbox" '+(e[i].enabled?"checked":"")+"/><span title="+i+">"+i+"</span></div>";for(i in this.freeLayersItems.innerHTML=t,e){var r="vts-freelayer-checkbox-"+i;document.getElementById(r).onchange=this.switchFreeLayer.bind(this,i,r),r="vts-freelayer-item-"+i,document.getElementById(r).onclick=this.selectFreeLayer.bind(this,i)}},wr.prototype.buildFreeLayerProperties=function(e){var t,i,r,s=this.core.getMap(),a=this.views[this.currentView],n=a.freeLayers[e].layers,o="";if(s&&s.getFreeLayer(e))switch(s.getFreeLayer(e).getInfo().type){case"mesh":case"mesh-tiles":for(o+='<div class="vts-layers-item"><div class="vts-layers-name" style="width:90px">DepthOffset:</div><input id="vts-fl-properties-depth-shift" type="number" min="-100" max="100" step="1" value="'+a.freeLayers[e].depthShift+'"><input id="vts-fl-properties-depth-shift2" type="number" min="-100" max="100" step="1" value="'+a.freeLayers[e].depthShift2+'"><input id="vts-fl-properties-depth-shift3" type="number" min="-100" max="100" step="1" value="'+a.freeLayers[e].depthShift3+'"></div>',o+='<div class="vts-layers-item"><div class="vts-layers-name">BoundLayers:</div></div>',t=0,i=n.length;t<i;t++){var h=n[t];o+='<div class="vts-layers-item"><input id="vts-fl-properties-checkbox-'+h.id+'" type="checkbox" '+(h.enabled?"checked":"")+'/><div class="vts-layers-name">'+h.id+'</div><input id="vts-fl-properties-spinner-'+h.id+'" type="number" title="Alpha" min="0" max="100" step="10" value="'+h.alpha+'"><button id="vts-fl-properties-ubutton-'+h.id+'" type="button" title="Move Above">&uarr;</button><button id="vts-fl-properties-dbutton-'+h.id+'" type="button" title="Move Bellow">&darr;</button></div>'}for(this.freeLayersPropertiesItems.innerHTML=o,r="vts-fl-properties-depth-shift",document.getElementById(r).onchange=this.switchFreeLayerProperty.bind(this,r,"depthShift"),r="vts-fl-properties-depth-shift2",document.getElementById(r).onchange=this.switchFreeLayerProperty.bind(this,r,"depthShift2"),r="vts-fl-properties-depth-shift3",document.getElementById(r).onchange=this.switchFreeLayerProperty.bind(this,r,"depthShift3"),t=0,i=n.length;t<i;t++)r="vts-fl-properties-checkbox-"+n[t].id,document.getElementById(r).onchange=this.switchFreeLayerBoundLayer.bind(this,n[t].id,r,"enable"),r="vts-fl-properties-spinner-"+n[t].id,document.getElementById(r).onchange=this.switchFreeLayerBoundLayer.bind(this,n[t].id,r,"alpha"),r="vts-fl-properties-ubutton-"+n[t].id,document.getElementById(r).onclick=this.switchFreeLayerBoundLayer.bind(this,n[t].id,r,"up"),r="vts-fl-properties-dbutton-"+n[t].id,document.getElementById(r).onclick=this.switchFreeLayerBoundLayer.bind(this,n[t].id,r,"down");break;case"geodata":case"geodata-tiles":o+='<div class="vts-layers-item"><div class="vts-layers-name" style="width:50px">Style:</div><select id="vts-layers-fl-properties-style">';var l=s.getStylesheets(),u=l.indexOf(a.freeLayers[e].style||a.freeLayers[e].originalStyle);for(t=0,i=l.length;t<i;t++)o+='<option value="'+l[t]+'" '+(t==u?"selected":"")+">"+l[t]+"</option>";o+="</select></div>",this.freeLayersPropertiesItems.innerHTML=o,r="vts-layers-fl-properties-style",document.getElementById(r).onchange=this.switchFreeLayerProperty.bind(this,r,"style")}},wr.prototype.selectView=function(e){var t;this.views[e]&&(this.currentView&&(t=document.getElementById("vts-views-item-"+this.currentView))&&(t.style.backgroundColor="initial"),(t=document.getElementById("vts-views-item-"+e)).style.backgroundColor="#ddd",this.currentView=e,this.buildSurfaces(),this.selectSurface(this.currentSurface),this.buildFreeLayers(),this.applyMapView())},wr.prototype.switchView=function(e,t,i){var r=this.views;for(var s in this.views)if(s==e){switch(i){case"clone":for(var a=2;;){if(!r[e+" #"+a]){r[e+" #"+a]=JSON.parse(JSON.stringify(r[e]));break}a++}this.buildViews();break;case"remove":var n=0;for(s in r)n++;if(n>1)if(delete r[e],this.buildViews(),this.currentView==e)for(s in r){this.selectView(s);break}else this.selectView(this.currentView)}break}},wr.prototype.switchSurface=function(e,t){var i=document.getElementById(t);this.views[this.currentView].surfaces[e].enabled=i.checked,this.applyMapView()},wr.prototype.selectSurface=function(e){var t;this.currentSurface&&((t=document.getElementById("vts-surface-item-"+this.currentSurface)).style.backgroundColor="initial"),(t=document.getElementById("vts-surface-item-"+e))&&(t.style.backgroundColor="#ddd"),this.currentSurface=e,this.buildBoundLayers(this.currentSurface)},wr.prototype.switchBoundLayer=function(e,t,i){for(var r=document.getElementById(t),s=this.views[this.currentView].surfaces[this.currentSurface].layers,a=0,n=s.length;a<n;a++)if(s[a].id==e){switch(i){case"enable":s[a].enabled=r.checked;break;case"alpha":s[a].alpha=parseInt(r.value,10);break;case"options":break;case"up":s.splice(Math.max(0,a-1),0,s.splice(a,1)[0]),this.selectSurface(this.currentSurface);break;case"down":s.splice(Math.max(0,a+1),0,s.splice(a,1)[0]),this.selectSurface(this.currentSurface)}break}this.applyMapView()},wr.prototype.switchFreeLayer=function(e,t){var i=document.getElementById(t);this.views[this.currentView].freeLayers[e].enabled=i.checked,this.applyMapView()},wr.prototype.selectFreeLayer=function(e){this.currentFreeLayer&&(document.getElementById("vts-freelayer-item-"+this.currentFreeLayer).style.backgroundColor="initial"),document.getElementById("vts-freelayer-item-"+e).style.backgroundColor="#ddd",this.currentFreeLayer=e,this.buildFreeLayerProperties(this.currentFreeLayer)},wr.prototype.switchFreeLayerBoundLayer=function(e,t,i){for(var r=document.getElementById(t),s=this.views[this.currentView].freeLayers[this.currentFreeLayer].layers,a=0,n=s.length;a<n;a++)if(s[a].id==e){switch(i){case"enable":s[a].enabled=r.checked;break;case"alpha":s[a].alpha=parseInt(r.value,10);break;case"up":s.splice(Math.max(0,a-1),0,s.splice(a,1)[0]),this.selectFreeLayer(this.currentFreeLayer);break;case"down":s.splice(Math.max(0,a+1),0,s.splice(a,1)[0]),this.selectFreeLayer(this.currentFreeLayer)}break}this.applyMapView()},wr.prototype.switchFreeLayerProperty=function(e,t){var i=document.getElementById(e),r=this.views[this.currentView].freeLayers[this.currentFreeLayer];switch(t){case"depthShift":r.depthShift=parseInt(i.value,10);break;case"depthShift2":r.depthShift2=parseInt(i.value,10);break;case"depthShift3":r.depthShift3=parseInt(i.value,10);break;case"style":r.style=i.value}this.applyMapView()},wr.prototype.applyMapView=function(e){var t,i,r,s={surfaces:{},freeLayers:{},options:{}},a=this.views[this.currentView],n=a.surfaces;for(var o in s.options=JSON.parse(JSON.stringify(a.options)),n)if(n[o].enabled){var h=[];for(t=0,i=(r=n[o].layers).length;t<i;t++)if(r[t].enabled){var l=JSON.parse(JSON.stringify(r[t].options)),u=JSON.stringify(l);if(r[t].alpha<100){var c={id:r[t].id,alpha:(.01*r[t].alpha).toFixed(2)};"{}"!=u&&(c.options=l),h.push(c)}else h.push(r[t].id)}s.surfaces[o]=h}var d=a.freeLayers;for(o in d)if(d[o].enabled){var p=[];for(t=0,i=(r=d[o].layers).length;t<i;t++)if(r[t].enabled)if(r[t].alpha<100){c={id:r[t].id,alpha:(.01*r[t].alpha).toFixed(2)};"{}"!=u&&(c.options=l),p.push(c)}else p.push(r[t].id);s.freeLayers[o]={},p.length>0&&(s.freeLayers[o].boundLayers=p),d[o].style&&d[o].style!=d[o].originalStyle&&(s.freeLayers[o].style=d[o].style),0==d[o].depthShift&&0==d[o].depthShift2&&0==d[o].depthShift3||(s.freeLayers[o].depthOffset=[parseFloat(d[o].depthShift.toFixed(2)),parseFloat(d[o].depthShift2.toFixed(2)),parseFloat(d[o].depthShift3.toFixed(2))])}if(this.jsonText.value=JSON.stringify(s,null,"  "),this.jsonText2.value=encodeURIComponent(JSON.stringify(s)),!e){var f=this.core.getMap();if(!f)return;f.setView(s,null,!0)}},wr.prototype.showPanel=function(){this.element.style.display="block",this.panelVisible=!0,this.updatePanel()},wr.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},wr.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},wr.prototype.updatePanel=function(){this.panelInitialized||(this.panelInitialized=!1,this.initViews(),this.buildViews(),this.selectView(this.currentView))};var Mr=wr,Sr=p.a,Ar=c,Cr=s.d,Tr=s.b,Pr=function(e){this.inspector=e,this.core=e.core};Pr.prototype.init=function(){var e=this.inspector;e.addStyle("#vts-replay-panel {font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;display: none;padding:15px;width: 618px;font-size: 14px;position: absolute;right: 10px;top: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-replay-panel-left {width: 253px;height: 100%;float: left;}#vts-replay-panel-right {width: 340px;height: 100%;float: right;}#vts-replay-items {width: 240px;overflow-x: hidden;border: 1px solid #ddd;padding-right: 5px;}.vts-replay-item {width: 100%;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}#vts-replay-lod-slider {width: 240px;}#vts-replay-lod-text {width: 60px;margin-left: 10px;margin-right: 10px;}#vts-replay-lod-single {margin-left: 10px;}#vts-replay-time-slider {width: 330px;}#vts-replay-time-text {width: 60px;margin-left: 10px;margin-right: 10px;}#vts-replay-time-single {margin-left: 10px;}#vts-replay-panel-gtime canvas{border: 1px solid #555;}#vts-replay-panel-gtime span{font-size: 10px;}#vts-replay-info {width: 240px;height: 140px;overflow-x: hidden;border: 1px solid #ddd;padding-right: 5px;margin-top: 10px;font-size: 12px;word-wrap: break-word;}"),this.element=document.createElement("div"),this.element.id="vts-replay-panel",this.element.innerHTML='<div id="vts-replay-panel-left"><div id="vts-replay-items"></div><div id="vts-replay-panel-lod"><input id="vts-replay-lod-slider" type="range" min="0" max="30" step="1" value="30" /><br/><span>LOD:</span><input id="vts-replay-lod-text" type="text" value="30"/><input id="vts-replay-lod-up" type="button" value="<"/><input id="vts-replay-lod-down" type="button" value=">"/><input id="vts-replay-lod-single" type="checkbox"/><span>Single</span></div><div id="vts-replay-info"></div></div><div id="vts-replay-panel-right"><div id="vts-replay-panel-gtime"><span id="vts-replay-info-meshes">Meshes Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-meshes" width=340 height=30></canvas><br/><span id="vts-replay-info-textures">Internal Textures Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-textures" width=340 height=30></canvas><br/><span id="vts-replay-info-textures2">External Textures Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-textures2" width=340 height=30></canvas><br/><span id="vts-replay-info-geodata">Geodata Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-geodata" width=340 height=30></canvas><br/><span id="vts-replay-info-metatiles">Metatiles Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-metatiles" width=340 height=30></canvas><br/><span id="vts-replay-info-intervals">Interval Count: 0 Min/Max: 0/0 Avg. 0</span><br/><canvas id="vts-replay-canvas-intervals" width=340 height=30></canvas><br/><span id="vts-replay-info-threads">Threads Min/Max: 0/0 Avg. 0 </span><br/><canvas id="vts-replay-canvas-threads" width=340 height=30></canvas><br/></div><div id="vts-replay-panel-time"><input id="vts-replay-time-slider" type="range" min="0" max="2000" value="0" /><br/><span>File:</span><input id="vts-replay-time-text" type="text" value="0"/><input id="vts-replay-time-up" type="button" value="<"/><input id="vts-replay-time-down" type="button" value=">"/><input id="vts-replay-time-single" type="checkbox"/><span>Single</span></div></div>',this.core.element.appendChild(this.element),this.items=document.getElementById("vts-replay-items"),this.lodSlider=document.getElementById("vts-replay-lod-slider"),this.lodSlider.onchange=this.onSliderChange.bind(this,"lod"),this.lodSlider.oninput=this.onSliderChange.bind(this,"lod"),this.lodText=document.getElementById("vts-replay-lod-text"),this.lodText.onchange=this.onTextChange.bind(this,"lod"),document.getElementById("vts-replay-lod-up").onclick=this.onSliderChange.bind(this,"lod","down"),document.getElementById("vts-replay-lod-down").onclick=this.onSliderChange.bind(this,"lod","up"),document.getElementById("vts-replay-lod-single").onclick=this.onSliderChange.bind(this,"lod","single"),this.timeSlider=document.getElementById("vts-replay-time-slider"),this.timeSlider.onchange=this.onSliderChange.bind(this,"time"),this.timeSlider.oninput=this.onSliderChange.bind(this,"time"),this.timeText=document.getElementById("vts-replay-time-text"),this.timeText.onchange=this.onTextChange.bind(this,"time"),this.timeInfo=document.getElementById("vts-replay-info"),document.getElementById("vts-replay-time-up").onclick=this.onSliderChange.bind(this,"time","down"),document.getElementById("vts-replay-time-down").onclick=this.onSliderChange.bind(this,"time","up"),document.getElementById("vts-replay-time-single").onclick=this.onSliderChange.bind(this,"time","single"),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.infoMeshes=document.getElementById("vts-replay-info-meshes"),this.ctxMeshes=document.getElementById("vts-replay-canvas-meshes").getContext("2d"),this.infoTextures=document.getElementById("vts-replay-info-textures"),this.ctxTextures=document.getElementById("vts-replay-canvas-textures").getContext("2d"),this.infoTextures2=document.getElementById("vts-replay-info-textures2"),this.ctxTextures2=document.getElementById("vts-replay-canvas-textures2").getContext("2d"),this.infoGeodata=document.getElementById("vts-replay-info-geodata"),this.ctxGeodata=document.getElementById("vts-replay-canvas-geodata").getContext("2d"),this.infoMetatiles=document.getElementById("vts-replay-info-metatiles"),this.ctxMetatiles=document.getElementById("vts-replay-canvas-metatiles").getContext("2d"),this.infoIntervals=document.getElementById("vts-replay-info-intervals"),this.ctxIntervals=document.getElementById("vts-replay-canvas-intervals").getContext("2d"),this.infoThreads=document.getElementById("vts-replay-info-threads"),this.ctxThreads=document.getElementById("vts-replay-canvas-threads").getContext("2d"),this.cameraLines=[],this.cameraLines2=[],this.cameraLines3=[],this.cameraGenarated=!1,this.panelVisible=!1},Pr.prototype.showPanel=function(){this.buildReplayCombo(),this.element.style.display="block",this.panelVisible=!0;var e=this.core.getMap();if(e){var t=e.draw.replay;this.updateFileInfo(t.loadedIndex),this.updateLoadGraphs()}},Pr.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},Pr.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},Pr.prototype.onSliderChange=function(e,t){if("lod"==e)switch(t){case"up":this.lodSlider.stepUp(),this.lodText.value=this.lodSlider.value;break;case"down":this.lodSlider.stepDown(),this.lodText.value=this.lodSlider.value;break;default:this.lodText.value=this.lodSlider.value}else switch(t){case"up":this.timeSlider.stepUp(),this.timeText.value=this.timeSlider.value;break;case"down":this.timeSlider.stepDown(),this.timeText.value=this.timeSlider.value;break;default:this.timeText.value=this.timeSlider.value}var i=this.core.getMap();if(i){var r=i.draw.replay;"lod"==e?(r.lod=parseFloat(this.lodText.value),r.singleLod=document.getElementById("vts-replay-lod-single").checked):(r.loadedIndex=parseFloat(this.timeText.value),r.singleLodedIndex=document.getElementById("vts-replay-time-single").checked,this.updateFileInfo(r.loadedIndex),this.updateLoadGraphs()),i.markDirty()}},Pr.prototype.onTextChange=function(e){"lod"==e?this.lodSlider.value=this.lodText.value:this.timeSlider.value=this.timeText.value;var t=this.core.getMap();if(t){var i=t.draw.replay;"lod"==e?i.lod=parseFloat(this.lodText.value):(i.loadedIndex=parseFloat(this.timeText.value),this.updateFileInfo(i.loadedIndex),this.updateLoadGraphs()),t.markDirty()}},Pr.prototype.generateCameraLines=function(e){var t=this.core.getRendererInterface(),i=e.position,r=e.center;this.cameraLines=[i,r],this.cameraLines2=[[i],[i],[i],[i]];var s=16,a=this.core.getMap(),n=a.camera.getRotationviewMatrix(),o=Tr.create();Tr.inverse(n,o),this.cameraMatrix=o;for(var h,l,u,c,d=Math.tan(Sr.radians(a.camera.getFov())),p=d*a.camera.getAspect(),f=Math.sqrt(d*d+p*p),g=Math.atan(f/1),m=e.cameraDistance/s,v=.5*m*Math.tan(g),y=v*a.camera.getAspect(),b=0;b<s;b++)h=[-y,-v,-m],l=[y,-v,-m],u=[y,v,-m],c=[-y,v,-m],Cr.scale(h,b+1),Cr.scale(l,b+1),Cr.scale(u,b+1),Cr.scale(c,b+1),Tr.multiplyVec3(o,h),Tr.multiplyVec3(o,l),Tr.multiplyVec3(o,u),Tr.multiplyVec3(o,c),Cr.add(h,i),Cr.add(l,i),Cr.add(u,i),Cr.add(c,i),this.cameraLines2[0].push(h),this.cameraLines2[1].push(l),this.cameraLines2[2].push(u),this.cameraLines2[3].push(c);for(this.cameraLines3=[[i],[i],[i],[i]],s=256,y=(v=.5*(m=(e.distance+12742e3*1.1)/s)*Math.tan(g))*a.camera.getAspect(),b=0;b<s;b++)h=[-y,-v,-m],l=[y,-v,-m],u=[y,v,-m],c=[-y,v,-m],Cr.scale(h,b+1),Cr.scale(l,b+1),Cr.scale(u,b+1),Cr.scale(c,b+1),Tr.multiplyVec3(o,h),Tr.multiplyVec3(o,l),Tr.multiplyVec3(o,u),Tr.multiplyVec3(o,c),Cr.add(h,i),Cr.add(l,i),Cr.add(u,i),Cr.add(c,i),this.cameraLines3[0].push(h),this.cameraLines3[1].push(l),this.cameraLines3[2].push(u),this.cameraLines3[3].push(c);h=[-y,-v,-m],l=[y,-v,-m],u=[y,v,-m],c=[-y,v,-m],Cr.scale(h,s),Cr.scale(l,s),Cr.scale(u,s),Cr.scale(c,s);var x=[(i=[0,0,0])[0],i[1],i[2],h[0],h[1],h[2],l[0],l[1],l[2],i[0],i[1],i[2],l[0],l[1],l[2],u[0],u[1],u[2],i[0],i[1],i[2],u[0],u[1],u[2],c[0],c[1],c[2],i[0],i[1],i[2],c[0],c[1],c[2],h[0],h[1],h[2]];this.frustumState=t.createState({blend:!0,zwrite:!1,ztest:!0,culling:!1}),this.frustumMesh=t.createMesh({vertices:x,uvs:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1]}),this.cameraGenarated=!0},Pr.prototype.itemButton=function(e,t){var i=this.core.getMap();if(i){var r=i.draw.replay;switch(e){case"DrawnTiles":r.storeTiles=!0;break;case"DrawnTilesFreeLayers":r.storeFreeTiles=!0;break;case"TracedNodes":r.storeNodes=!0;break;case"TracedNodesFreeLayers":r.storeFreeNodes=!0;break;case"LoadSequence":r.storeLoaded="S"==t,"S"==t?(r.loadedIndex=0,r.loaded=[]):(this.updateFileInfo(r.loadedIndex),this.updateLoadGraphs());break;case"Camera":if("S"==t){var s=r.camera={distance:i.camera.distance,position:i.camera.position.slice(),vector:i.camera.vector.slice(),center:i.camera.center.slice(),height:i.camera.height};r.cameraPos=i.getPosition(),this.generateCameraLines(s)}else r.cameraPos&&i.setPosition(r.cameraPos)}i.markDirty()}},Pr.prototype.switchItem=function(e,t){var i=document.getElementById(t),r=this.core.getMap();if(r){var s=r.draw.replay;switch(e){case"DrawnTiles":s.drawTiles=i.checked;break;case"DrawnTilesFreeLayers":s.drawFreeTiles=i.checked;break;case"TracedNodes":s.drawNodes=i.checked;break;case"TracedNodesFreeLayers":s.drawFreeNodes=i.checked;break;case"LoadSequence":s.drawLoaded=i.checked;break;case"Camera":this.cameraGenarated||this.itemButton("Camera"),this.drawCamera=i.checked;break;case"Globe":var a=this.core.getRenderer();if(!this.globeTexture){this.globeTexture=new Ar(a.gpu,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAEACAMAAADyTj5VAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0Mzk4RkVFMzlGNjUxMUU2OTBDM0I0OEM1NjU0RURBMyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo0Mzk4RkVFNDlGNjUxMUU2OTBDM0I0OEM1NjU0RURBMyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQzOThGRUUxOUY2NTExRTY5MEMzQjQ4QzU2NTRFREEzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjQzOThGRUUyOUY2NTExRTY5MEMzQjQ4QzU2NTRFREEzIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+5rvbhAAAAAZQTFRFwcHBLS0tMDfv/wAAAiZJREFUeNrs2LENAEEIA0HTf9ME5DTgIZn8ta+TnLjymzuW6kMIwIcQgA8hAAqAAmBdAM4O4E/wBPgQAqAAKAAKgAKgHcDZAegJoAAoAAqAAqAAaAdwdgB6AigACoACoAAoANoBnB2AngAKgAKgACgACoB2AGcHoCeAAqAAKAAKgAKgHcDZAegJoAAoAAqAAqAAaAdwdgB6AigACoACoAAoANoBnB2AngAKgAKgACgACoB2AGcHoCeAAqAAKAAKgAKgHcDZAegJoAAoAAqAAqAAaAdwdgB6AigACoACEIAPIQAfwg7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABSAAH0IAPoQAfAgB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQALQDODsAPQEUAAVAAVAAFADtAM4OQE8ABUABUAAUAAVAO4CzA9ATQAFQABQABUAB0A7g7AD0BFAAFAAFQAFQAPxcAQYAZt2IEFFJhxsAAAAASUVORK5CYII=",this.core,null,!0)}this.drawGlobe=i.checked,this.drawGlobe=this.drawGlobe}r.markDirty()}},Pr.prototype.updateLoadGraphs=function(){var e=this.core.getMap();if(e){var t,i=e.draw.replay,r=i.loaded,s=i.loadedIndex;this.timeSlider.max=r.length;var a=340;this.ctxMeshes.fillStyle="#000000",this.ctxMeshes.fillRect(0,0,a,30),this.ctxTextures.fillStyle="#000000",this.ctxTextures.fillRect(0,0,a,30),this.ctxTextures2.fillStyle="#000000",this.ctxTextures2.fillRect(0,0,a,30),this.ctxGeodata.fillStyle="#000000",this.ctxGeodata.fillRect(0,0,a,30),this.ctxMetatiles.fillStyle="#000000",this.ctxMetatiles.fillRect(0,0,a,30),this.ctxIntervals.fillStyle="#000000",this.ctxIntervals.fillRect(0,0,a,30),this.ctxThreads.fillStyle="#000000",this.ctxThreads.fillRect(0,0,a,30);var n,o=Math.floor(i.loadedIndex/a)*a,h=339,l=o;for(o=0;o<h;o++)if(n=r[o+l]){switch(n.kind){case"mesh":t=this.ctxMeshes;break;case"texture-in":t=this.ctxTextures;break;case"texture-ex":t=this.ctxTextures2;break;case"geodata":t=this.ctxGeodata;break;case"metatile":t=this.ctxMetatiles;break;default:continue}var u=Math.round(Math.min(255,60+20*Math.max(1,n.duration/300)));t.fillStyle="rgb("+u+","+u+","+u+")";var c=n.duration/300*30;t.fillRect(o,30,1,-c),u=Math.round(Math.min(255,60+20*Math.max(1,n.interval/300))),this.ctxIntervals.fillStyle="rgb("+u+","+u+","+u+")",c=n.interval/300*30,this.ctxIntervals.fillRect(o,30,1,-c),this.ctxThreads.fillStyle="rgb(80,80,80)",c=n.threads/e.config.mapDownloadThreads*30,this.ctxThreads.fillRect(o,30,1,-c)}var d=Number.MAX_VALUE,p=0,f=0,g=0,m=Number.MAX_VALUE,v=0,y=0,b=0,x=Number.MAX_VALUE,w=0,M=0,S=0,A=Number.MAX_VALUE,C=0,T=0,P=0,F=Number.MAX_VALUE,L=0,E=0,k=0,N=Number.MAX_VALUE,I=0,B=0,R=0,z=Number.MAX_VALUE,U=0,D=0,_=0;for(h=r.length,o=0;o<h;o++)if(n=r[o]){switch(n.kind){case"mesh":n.duration<d&&(d=n.duration),n.duration>p&&(p=n.duration),f+=n.duration,g++;break;case"texture-in":n.duration<m&&(m=n.duration),n.duration>v&&(v=n.duration),y+=n.duration,b++;break;case"texture-ex":n.duration<x&&(x=n.duration),n.duration>w&&(w=n.duration),M+=n.duration,S++;break;case"geodata":n.duration<A&&(A=n.duration),n.duration>C&&(C=n.duration),T+=n.duration,P++;break;case"metatile":n.duration<F&&(F=n.duration),n.duration>L&&(L=n.duration),E+=n.duration,k++;break;default:continue}n.threads<N&&(N=n.threads),n.threads>I&&(I=n.threads),B+=n.threads,R++,n.threads<z&&(z=n.threads),n.threads>U&&(U=n.threads),D+=n.threads,_++}s-=l,this.ctxMeshes.fillStyle="#ff0000",this.ctxMeshes.fillRect(s-1,0,1,30),this.ctxMeshes.fillRect(s+1,0,1,30),this.ctxTextures.fillStyle="#ff0000",this.ctxTextures.fillRect(s-1,0,1,30),this.ctxTextures.fillRect(s+1,0,1,30),this.ctxTextures2.fillStyle="#ff0000",this.ctxTextures2.fillRect(s-1,0,1,30),this.ctxTextures2.fillRect(s+1,0,1,30),this.ctxGeodata.fillStyle="#ff0000",this.ctxGeodata.fillRect(s-1,0,1,30),this.ctxGeodata.fillRect(s+1,0,1,30),this.ctxMetatiles.fillStyle="#ff0000",this.ctxMetatiles.fillRect(s-1,0,1,30),this.ctxMetatiles.fillRect(s+1,0,1,30),this.ctxIntervals.fillStyle="#ff0000",this.ctxIntervals.fillRect(s-1,0,1,30),this.ctxIntervals.fillRect(s+1,0,1,30),this.ctxThreads.fillStyle="#ff0000",this.ctxThreads.fillRect(s-1,0,1,30),this.ctxThreads.fillRect(s+1,0,1,30),g||(d=0,p=0),b||(m=0,v=0),S||(x=0,w=0),P||(A=0,C=0),k||(F=0,L=0),R||(N=0,I=0),_||(z=0,U=0),f=g?f/g:0,y=b?y/b:0,M=S?M/S:0,T=P?T/P:0,E=k?E/k:0,D=_?D/_:0,B=R?B/R:0,this.infoMeshes.innerHTML="Meshes Min/Max/Avg/Count: "+d.toFixed(0)+"/"+p.toFixed(0)+"/"+f.toFixed(1)+"/"+g,this.infoTextures.innerHTML="Internal Textures Min/Max/Avg/Count: "+m.toFixed(0)+"/"+v.toFixed(0)+"/"+y.toFixed(1)+"/"+b,this.infoTextures2.innerHTML="External Textures Min/Max/Avg/Count: "+x.toFixed(0)+"/"+w.toFixed(0)+"/"+M.toFixed(1)+"/"+S,this.infoGeodata.innerHTML="Geodata Min/Max/Avg/Count: "+A.toFixed(0)+"/"+C.toFixed(0)+"/"+T.toFixed(1)+"/"+P,this.infoMetatiles.innerHTML="Metatiles Min/Max/Avg/Count: "+F.toFixed(0)+"/"+L.toFixed(0)+"/"+E.toFixed(1)+"/"+k,this.infoIntervals.innerHTML="Intervals Min/Max/Avg: "+z.toFixed(0)+"/"+U.toFixed(0)+"/"+D.toFixed(1),this.infoThreads.innerHTML="Threads Min/Max/Avg: "+N+"/"+I+"/"+B.toFixed(1)}},Pr.prototype.updateFileInfo=function(e){var t=this.core.getMap();if(t){var i=t.draw.replay.loaded[e];this.timeInfo.innerHTML=i?"Resource Kind: "+i.kind+"<br/>Time: "+i.time.toFixed(2)+"<br/>Duration: "+i.duration.toFixed(2)+"<br/>Interval: "+i.interval.toFixed(2)+"<br/>Priority: "+i.priority.toFixed(2)+"<br/>Threads: "+i.threads+"<br/>"+i.url:""}},Pr.prototype.buildReplayCombo=function(){if(this.core.getMap()){var e,t,i,r=[["Drawn Tiles",1],["Drawn Tiles - Free Layers",1],["Traced Nodes",1],["Traced Nodes - Free Layers",1],["Load Sequence",2],["Camera",2],["Globe",0]],s=["DrawnTiles","DrawnTilesFreeLayers","TracedNodes","TracedNodesFreeLayers","LoadSequence","Camera","Globe"],a="";for(e=0,t=r.length;e<t;e++)a+='<div id="vts-replay-item-'+s[e]+'" class="vts-replay-item"><input id="vts-replay-checkbox-'+s[e]+'" type="checkbox"/><span title='+r[e][0]+">"+r[e][0]+"&nbsp;&nbsp;</span>",r[e][1]>0&&(a+='<input id="vts-replay-sbutton-'+s[e]+'" type="button" value="S"/>'),r[e][1]>1&&(a+='<input id="vts-replay-fbutton-'+s[e]+'" type="button" value="'+("Camera"==s[e]?"R":"F")+'"/>'),a+="</div>";for(this.items.innerHTML=a,e=0,t=r.length;e<t;e++)i="vts-replay-checkbox-"+s[e],document.getElementById(i).onchange=this.switchItem.bind(this,s[e],i),r[e][1]>0&&(i="vts-replay-sbutton-"+s[e],document.getElementById(i).onclick=this.itemButton.bind(this,s[e],"S")),r[e][1]>1&&(i="vts-replay-fbutton-"+s[e],document.getElementById(i).onclick=this.itemButton.bind(this,s[e],"Camera"==s[e]?"R":"F"))}};var Fr=Pr,Lr=function(e){this.inspector=e,this.core=e.core};Lr.prototype.init=function(){var e=this.inspector;e.addStyle('#vts-stylesheets-panel * {all: initial;}#vts-stylesheets-panel {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;display: none;padding:15px;width: 1200px;height: 350px;font-size: 14px;position: absolute;right: 10px;bottom: 10px;cursor: default;background-color: rgba(255,255,255,0.95);border-radius: 5px;border: solid 1px #ccc;text-align: left;z-index: 7;padding: 10px;}#vts-stylesheets-panel-header {width: 100%;height: 28px;}#vts-stylesheets-panel-combo {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 13px;border: 1px solid #a9a9a9;width: 1070px;height: 17px;padding: 2px;margin-bottom: 5px;-webkit-appearance: menulist;-moz-appearance: menulist;}#vts-stylesheets-panel-combo option {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 13px;}#vts-stylesheets-panel-update-button {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 14px;float: right;background-color: #dedede;padding: 3px 2px 2px 2px;border: 1px solid #a0a0a0;border-radius: 2px;margin-right: 5px;}#vts-stylesheets-panel-hide-button {font-family: Arial, "Helvetica Neue", Helvetica, sans-serif;font-size: 14px;float: right;background-color: #dedede;padding: 3px 2px 2px 2px;border: 1px solid #a0a0a0;border-radius: 2px;}#vts-stylesheets-panel-text {font-family: monospace;border: 1px solid #a9a9a9;padding: 2px 0px 0px 2px;width: 100%;height: 300px;resize: none;white-space: pre;}'),this.element=document.createElement("div"),this.element.id="vts-stylesheets-panel",this.element.innerHTML='<div id="vts-stylesheets-panel-header"><select id="vts-stylesheets-panel-combo"></select><button id="vts-stylesheets-panel-hide-button" type="button" title="Hide">Hide</button><button id="vts-stylesheets-panel-update-button" type="button" title="Update">Update</button></div><textarea id="vts-stylesheets-panel-text" rows="4" cols="50">aa\naa\n</textarea>',this.core.element.appendChild(this.element),this.optionsElement=document.getElementById("vts-stylesheets-panel-combo"),this.optionsElement.onchange=this.onComboSwitched.bind(this),this.textElement=document.getElementById("vts-stylesheets-panel-text"),document.getElementById("vts-stylesheets-panel-update-button").onclick=this.onUpdate.bind(this),document.getElementById("vts-stylesheets-panel-hide-button").onclick=this.hidePanel.bind(this),this.element.addEventListener("mouseup",e.doNothing.bind(this),!0),this.element.addEventListener("mousedown",e.doNothing.bind(this),!0),this.element.addEventListener("mousewheel",e.doNothing.bind(this),!1),this.element.addEventListener("dblclick",e.doNothing.bind(this),!1),this.textElement.addEventListener("keyup",e.doNothing.bind(this),!1),this.textElement.addEventListener("keydown",e.doNothing.bind(this),!1),this.panelVisible=!1},Lr.prototype.showPanel=function(){this.buildStylesheetsCombo(),this.element.style.display="block",this.panelVisible=!0},Lr.prototype.hidePanel=function(){this.element.style.display="none",this.panelVisible=!1},Lr.prototype.switchPanel=function(){this.panelVisible?this.hidePanel():this.showPanel()},Lr.prototype.onComboSwitched=function(){var e=this.core.getMap();if(e){var t=e.getStylesheet(this.optionsElement.value);this.textElement.value=this.niceStyleFormat(t)}},Lr.prototype.onUpdate=function(){var e=this.core.getMap();e&&e.setStylesheetData(this.optionsElement.value,JSON.parse(this.textElement.value))},Lr.prototype.niceStyleFormat=function(e){if(!e||!e.data)return"";var t="";t+="{\n";var i=[];(e=e.data).constants&&i.push("constants"),e.bitmaps&&i.push("bitmaps"),e.fonts&&i.push("fonts"),e.layers&&i.push("layers");for(var r=0,s=i.length;r<s;r++){var a=i[r];t+='  "'+a+'": {\n';var n=e[a],o=[];for(var h in n)o.push(h);for(var l=0,u=o.length;l<u;l++)if("layers"==a){var c=n[o[l]],d=[];for(var p in c)d.push(p);t+='    "'+o[l]+'": {\n';for(var f=0,g=d.length;f<g;f++)t+='      "'+d[f]+'": '+JSON.stringify(c[d[f]])+(f==g-1?"":",")+"\n";t+="    }"+(l==u-1?"":",\n")}else t+='    "'+o[l]+'": '+JSON.stringify(n[o[l]])+(l==u-1?"":",")+"\n";t+="\n  }"+(r==s-1?"":",\n")}return t+="\n}"},Lr.prototype.buildStylesheetsCombo=function(){var e=this.core.getMap();if(e){for(var t="",i=e.getStylesheets(),r=0,s=i.length;r<s;r++)t+='<option value="'+i[r]+'">'+i[r]+"</option>";this.optionsElement.innerHTML=t;var a=e.getStylesheet(i[0]);this.textElement.value=this.niceStyleFormat(a)}};var Er=Lr,kr=s.b,Nr=p.a,Ir=a.a,Br=mr,Rr=yr,zr=xr,Ur=Mr,Dr=Fr,_r=Er,Or=function(e){this.core=e,this.enabled=!1,this.input=new Br(this),this.stats=new Rr(this),this.graphs=new zr(this),this.layers=new Ur(this),this.replay=new Dr(this),this.stylesheets=new _r(this),this.core.config.inspector&&this.input.init(),this.shakeCamera=!1,this.drawReplayCamera=!1,this.drawRadar=!1,this.radarLod=null,this.debugValue=0,this.measureMode=!1,this.measurePoints=[]};Or.prototype.enableInspector=function(){this.enabled||(this.stats.init(),this.graphs.init(),this.layers.init(),this.replay.init(),this.stylesheets.init(),this.circleImage||(this.circleImage=Ir.loadImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAAAAAAAD5Q7t/AAAACW9GRnMAAAAgAAAA4ACD+EAUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVRYw+2VPwqDMBTG3dz1Am56EnH2XLroETxGuwc3Z7cOdhY8QJpfSUBspUvStJAPPggvD973/uQligICAgL+DKViqygUV02hbaXLwJlio7gpyhNu2idzEXwwgfI8H+u6vnZdN/V9P3EuimLcCRlsiyArGcfxjWDLsmzyAGzc4aNFNDZ7/iw7AeQH4LNrh5WZYLgkJTaZCyHuVVVdkiSZ0zSdOWMzlaBFWkRrQ4A4Zk/A4wBie1MFYUMAz0wybCYAmR8FUAlzj6+2r18TgM2VAO8tOB1Cyk7mrofQ+zP0voheVjHtIBjDxjrmvCu7k1Xs/TP6ie84ICDAGR5uCYdPo0MWiAAAAABJRU5ErkJggg==",function(){this.circleTexture=this.core.getRendererInterface().createTexture({source:this.circleImage})}.bind(this))),this.core.on("map-update",this.onMapUpdate.bind(this)),this.enabled=!0)},Or.prototype.setParameter=function(e,t){this.input.setParameter(e,t)},Or.prototype.addStyle=function(e){var t=document.createElement("style");t.type="text/css",t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)},Or.prototype.doNothing=function(e){return e.stopPropagation(),!1},Or.prototype.preventDefault=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},Or.prototype.onMapUpdate=function(){var e=this.core.getMapInterface();if(e){this.shakeCamera&&e.redraw();var t,i,r,s,a,n,o,h=this.core.getRendererInterface();if(this.replay.drawGlobe){o=e.convertCoordsFromPhysToCameraSpace([0,0,0]);var l=this.core.getRenderer();l.draw.drawTBall(o,6371e3,l.progStardome,this.replay.globeTexture,6371e3,!0)}if(this.replay.drawCamera){for(a=this.replay.cameraLines,n=[],h.drawLineString({points:a,size:2,color:[0,128,255,255],depthTest:!1,screenSpace:!1,blend:!1}),t=0,i=(a=this.replay.cameraLines3).length;t<i;t++){for(n=[],r=0,s=a[t].length;r<s;r++)n.push(a[t][r]);h.drawLineString({points:n,size:2,color:[0,255,128,255],depthTest:!1,screenSpace:!1,blend:!1})}for(t=0,i=(a=this.replay.cameraLines2).length;t<i;t++){for(n=[],r=0,s=a[t].length;r<s;r++)n.push(a[t][r]);h.drawLineString({points:n,size:2,color:[0,255,255,255],depthTest:!1,screenSpace:!1,blend:!1})}var u=e.getCameraInfo(),c=e.convertCoordsFromPhysToCameraSpace(this.replay.cameraLines[0]),d=kr.create(this.replay.cameraMatrix);d[12]=c[0],d[13]=c[1],d[14]=c[2];kr.multiply(u.viewMatrix,d,d);var p=[0,0,0,0,0,0,0,0,0];kr.toInverseMat3(d,p),h.setState(this.replay.frustumState),h.drawMesh({mesh:this.replay.frustumMesh,texture:null,shader:"shaded",shaderVariables:{uMV:["mat4",d],uNorm:["mat3",p],uMaterial:["mat4",[255,128,128,0,0,0,0,0,0,0,0,0,0,.5,0,0]]}})}if(this.drawRadar&&this.circleTexture){var f=e.getPosition(),g=f.getViewExtent()/64,m=new Array(256);for(r=0;r<16;r++)for(t=0;t<16;t++){var v=t*g-8*g,y=r*g-8*g,b=Math.atan2(y,v),x=Math.sqrt(v*v+y*y),w=e.movePositionCoordsTo(f,Nr.degrees(b),x).getCoords(),M=e.convertCoordsFromNavToCanvas([w[0],w[1],0],"float",this.radarLod);m[16*r+t]=M}var S=new Array(16);for(r=0;r<16;r++){for(t=0;t<16;t++)S[t]=m[16*r+t];h.drawLineString({points:S,size:2,screenSpace:!0,color:[0,255,255,255],depthTest:!1,blend:!1})}for(t=0;t<16;t++){for(r=0;r<16;r++)S[r]=m[16*r+t];h.drawLineString({points:S,size:2,screenSpace:!0,color:[0,255,255,255],depthTest:!1,blend:!1})}for(t=0,i=m.length;t<i;t++)o=m[t],h.drawImage({rect:[o[0]-10,o[1]-10,20,20],texture:this.circleTexture,color:[255,0,255,255],depth:o[2],depthTest:!1,blend:!0})}}};var Gr=Or,Vr=function(e,t,i,r,s,a){this.renderer=e,this.div=t,this.canvas=null,this.curSize=i,this.currentProgram=null,this.maxAttributesCount=8,this.newAttributes=new Uint8Array(this.maxAttributesCount),this.enabledAttributes=new Uint8Array(this.maxAttributesCount),this.noTextures=!1,this.barycentricBuffer=null,this.defaultState=this.createState({blend:!1,stencil:!1,zequal:!1,ztest:!1,zwrite:!1,culling:!1}),this.currentState=this.defaultState,this.currentOffset=0,this.keepFrameBuffer=null!=r&&r,this.antialias=!!s,this.anisoLevel=a};Vr.prototype.init=function(){var e=document.createElement("canvas");if(null!=e&&(this.canvas=e,e.width=this.curSize[0],e.height=this.curSize[1],e.style.display="block",null!=e.getContext)){var t;e.addEventListener("webglcontextlost",this.contextLost.bind(this),!1),e.addEventListener("webglcontextrestored",this.contextRestored.bind(this),!1);try{t=e.getContext("webgl",{preserveDrawingBuffer:this.keepFrameBuffer,antialias:this.antialias,stencil:!0})||e.getContext("experimental-webgl",{preserveDrawingBuffer:this.keepFrameBuffer})}catch(e){}t&&(this.gl=t,t.getExtension("OES_standard_derivatives"),this.anisoExt=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.anisoExt?(this.maxAniso=t.getParameter(this.anisoExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT),this.anisoLevel&&(-1==this.anisoLevel?this.anisoLevel=this.maxAniso:this.anisoLevel=Math.min(this.anisoLevel,this.maxAniso))):(this.maxAniso=0,this.anisoLevel=0),this.div.appendChild(e),t.viewportWidth=e.width,t.viewportHeight=e.height,t.clearColor(0,0,0,1),t.disable(t.BLEND),t.disable(t.STENCIL_TEST),t.depthMask(!1),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.disable(t.CULL_FACE),t.viewport(0,0,t.viewportWidth,t.viewportHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))}},Vr.prototype.kill=function(){this.div.removeChild(this.canvas),delete this.canvas,this.canvas=null},Vr.prototype.contextLost=function(e){e.preventDefault(),this.renderer.core.contextLost=!0,this.renderer.core.callListener("gpu-context-lost",{})},Vr.prototype.contextRestored=function(){this.renderer.core.callListener("gpu-context-restored",{})},Vr.prototype.resize=function(e,t){this.curSize=e;var i=this.canvas,r=this.gl;null!=i&&!0!==t&&(i.width=this.curSize[0],i.height=this.curSize[1]),null!=r&&(r.viewportWidth=i.width,r.viewportHeight=i.height)},Vr.prototype.setAniso=function(e){this.anisoExt&&this.anisoLevel&&(this.anisoLevel=-1==e?this.maxAniso:Math.min(e,this.maxAniso))},Vr.prototype.getCanvas=function(){return this.canvas},Vr.prototype.setViewport=function(){this.gl.viewport(0,0,this.gl.viewportWidth,this.gl.viewportHeight)},Vr.prototype.clear=function(e,t,i){null!=i&&this.gl.clearColor(i[0]/255,i[1]/255,i[2]/255,i[3]/255),this.gl.clear((t?this.gl.COLOR_BUFFER_BIT:0)|(e?this.gl.DEPTH_BUFFER_BIT:0))},Vr.prototype.useProgram=function(e,t,i){if(this.currentProgram!=e){this.gl.useProgram(e.program),this.currentProgram=e,e.setSampler("uSampler",0),i&&e.setSampler("uSampler2",1);for(var r=this.newAttributes,s=this.enabledAttributes,a=0,n=r.length;a<n;a++)r[a]=0;for(a=0,n=t.length;a<n;a++){var o=e.getAttribute(t[a]);-1!=o&&(r[o]=1)}for(a=0,n=r.length;a<n;a++)s[a]!=r[a]&&(r[a]?(this.gl.enableVertexAttribArray(a),s[a]=1):(this.gl.disableVertexAttribArray(a),s[a]=0))}},Vr.prototype.bindTexture=function(e,t){e.loaded&&(this.gl.activeTexture(t?this.gl.TEXTURE1:this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e.texture))},Vr.prototype.setFramebuffer=function(e){null!=e?this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,e.framebuffer):(this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null))},Vr.prototype.createState=function(e){return null==e.blend&&(e.blend=!1),null==e.stencil&&(e.stencil=!1),null==e.zwrite&&(e.zwrite=!0),null==e.ztest&&(e.ztest=!0),null==e.zequal&&(e.zequal=!1),null==e.culling&&(e.culling=!0),e},Vr.prototype.setState=function(e){if(e){var t=this.gl,i=this.currentState;i.blend!=e.blend&&(e.blend?(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.BLEND)):t.disable(t.BLEND)),i.stencil!=e.stencil&&(e.stencil?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST)),i.zwrite!=e.zwrite&&(e.zwrite?t.depthMask(!0):t.depthMask(!1)),i.ztest!=e.ztest&&(0!=e.ztest?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST)),i.zequal!=e.zequal&&(0!=e.zequal?t.depthFunc(t.LEQUAL):t.depthFunc(t.LESS)),i.culling!=e.culling&&(e.culling?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE)),this.currentState=e}};var jr=Vr,Hr=c,Wr=a.a,qr=function(e,t,i,r,s){this.bbox=null,this.gpu=e,this.gl=e.gl,this.core=t,this.data=null,this.path=s,this.texture={width:256,height:256},this.textures=[],this.images=[],this.ready=!1,this.version=1,this.load(s)};qr.prototype.kill=function(){},qr.prototype.getSize=function(){return this.size},qr.prototype.load=function(e){Wr.loadBinary(e,this.onLoaded.bind(this),this.onError.bind(this))},qr.prototype.onLoaded=function(e){this.data=e,this.ready=!0,this.core.markDirty()},qr.prototype.isReady=function(){return this.ready},qr.prototype.onError=function(){},qr.prototype.onFileLoaded=function(e,t){this.core.markDirty(),this.textures[e].createFromData(256,256,new Uint8Array(t),"linear")},qr.prototype.onFileLoadError=function(){},qr.prototype.areTexturesReady=function(e){for(var t=!0,i=0,r=e.length;i<r;i++){var s=e[i];this.textures[s]?t=t&&this.textures[s].loaded:(Wr.loadBinary(this.path+(s+2),this.onFileLoaded.bind(this,s),this.onFileLoadError.bind(this)),this.textures[s]=new Hr(this.gpu,null,this.core),t=!1)}return t},qr.prototype.getTexture=function(e){return this.textures[e]};var Zr=qr,Yr=s.d,Jr=s.e,Kr=s.b,Qr=p.a,Xr=function(e,t,i,r){this.parent=e,this.position=[0,0,0],this.orientation=[0,0,0],this.aspect=1,this.fov=t,this.fovTan=Math.tan(t*Math.PI/180),this.fovDist=1,this.near=i,this.far=r,this.rotationByMatrix=!1,this.modelview=Kr.create(),this.rotationview=Kr.create(),this.projection=Kr.create(),this.mvp=Kr.create(),this.mvp32=new Float32Array(16),this.modelview32=new Float32Array(16),this.rotationview32=new Float32Array(16),this.projection32=new Float32Array(16),this.frustumPlanes=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],this.bboxPoints=[[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1],[0,0,0,1]],this.scaleFactorVec=[0,0,0,0],this.dirty=!0};Xr.prototype.setPosition=function(e){this.position=e,this.dirty=!0},Xr.prototype.setOrientation=function(e){this.rotationByMatrix=!1,this.orientation=e,this.dirty=!0},Xr.prototype.setRotationMatrix=function(e){this.rotationByMatrix=!0,this.rotationview=e.slice(),this.dirty=!0},Xr.prototype.setAspect=function(e){this.aspect=e,this.dirty=!0},Xr.prototype.setViewHeight=function(e){this.viewHeight=e,this.dirty=!0},Xr.prototype.setOrtho=function(e){this.ortho=e,this.dirty=!0},Xr.prototype.setParams=function(e,t,i){this.fov=e,this.near=t,this.far=i,this.dirty=!0},Xr.prototype.clone=function(e){var t=new Xr(this.parent,null!=e?e:this.getFov(),this.getNear(),this.getFar());return t.setPosition(this.getPosition()),t.setOrientation(this.getOrientation()),t.setAspect(this.getAspect()),t.update(),t},Xr.prototype.getPosition=function(){return[this.position[0],this.position[1],this.position[2]]},Xr.prototype.getOrientation=function(){return[this.orientation[0],this.orientation[1],this.orientation[2]]},Xr.prototype.getAspect=function(){return this.aspect},Xr.prototype.getFov=function(){return this.fov},Xr.prototype.getNear=function(){return this.near},Xr.prototype.getFar=function(){return this.far},Xr.prototype.getViewHeight=function(){return this.viewHeight},Xr.prototype.getOrtho=function(){return this.ortho},Xr.prototype.getRotationviewMatrix=function(){return this.dirty&&this.update(),this.rotationview},Xr.prototype.getRotationviewFMatrix=function(){return this.dirty&&this.update(),this.rotationview32},Xr.prototype.getModelviewMatrix=function(){return this.dirty&&this.update(),this.modelview},Xr.prototype.getModelviewFMatrix=function(){return this.dirty&&this.update(),this.modelview32},Xr.prototype.getProjectionMatrix=function(){return this.dirty&&this.update(),this.projection},Xr.prototype.getProjectionFMatrix=function(){return this.dirty&&this.update(),this.projection32},Xr.prototype.getMvpMatrix=function(){return this.dirty&&this.update(),this.mvp},Xr.prototype.getMvpFMatrix=function(){return this.dirty&&this.update(),this.mvp32},Xr.prototype.scaleFactor=function(e,t){this.dirty&&this.update(),Kr.multiplyVec3(this.modelview,e,this.scaleFactorVec);var i=Yr.length(this.scaleFactorVec);return t?i<this.near?[Number.POSITIVE_INFINITY,i]:[this.projection[0]/i,i]:i<this.near?Number.POSITIVE_INFINITY:this.projection[0]/i},Xr.prototype.scaleFactor2=function(e){return this.dirty&&this.update(),e<this.near?Number.POSITIVE_INFINITY:this.projection[0]/e},Xr.prototype.distance=function(e){var t=Yr.create();return Yr.subtract(this.position,e,t),Yr.length(t)},Xr.prototype.pointVisible=function(e,t){var i;this.dirty&&this.update(),i=t?[e[0]-t[0],e[1]-t[1],e[2]-t[2],1]:[e[0],e[1],e[2],1];for(var r=0;r<6;r++)if(Jr.dot(this.frustumPlanes[r],i)<0)return!1;return!0},Xr.prototype.pointsVisible=function(e,t){this.dirty&&this.update();var i,r,s,a=this.frustumPlanes,n=e.length;t?(i=t[0],r=t[1],s=t[2]):(i=0,r=0,s=0);for(var o=Jr.dot3,h=0;h<6;h++){for(var l=!0,u=a[h],c=0;c<n;c+=3)if(o(u,e,c,i,r,s)>=0){l=!1;break}if(l)return!1}return!0},Xr.prototype.pointsVisible2=function(e,t){this.dirty&&this.update();var i,r,s,a=this.frustumPlanes,n=e.length;t?(i=t[0],r=t[1],s=t[2]):(i=0,r=0,s=0);for(var o=Jr.dot3,h=0;h<6;h++){for(var l=!0,u=a[h],c=0;c<n;c++)if(o(u,e[c],0,i,r,s)>=0){l=!1;break}if(l)return!1}return!0},Xr.prototype.bboxVisible=function(e,t){this.dirty&&this.update();var i,r,s,a,n,o,h,l=e.min,u=e.max,c=this.bboxPoints;t?(r=l[0]-t[0],s=l[1]-t[1],a=l[2]-t[2],n=u[0]-t[0],o=u[1]-t[1],h=u[2]-t[2]):(r=l[0],s=l[1],a=l[2],n=u[0],o=u[1],h=u[2]),(i=c[0])[0]=r,i[1]=s,i[2]=a,(i=c[1])[0]=r,i[1]=s,i[2]=h,(i=c[2])[0]=r,i[1]=o,i[2]=a,(i=c[3])[0]=r,i[1]=o,i[2]=h,(i=c[4])[0]=n,i[1]=s,i[2]=a,(i=c[5])[0]=n,i[1]=s,i[2]=h,(i=c[6])[0]=n,i[1]=o,i[2]=a,(i=c[7])[0]=n,i[1]=o,i[2]=h;for(var d=Jr.dot2,p=this.frustumPlanes,f=0;f<6;f++){for(var g=!0,m=p[f],v=0;v<8;v++)if(d(m,c[v])>=0){g=!1;break}if(g)return!1}return!0},Xr.prototype.update=function(e){this.rotationByMatrix||(Kr.multiply(Qr.rotationMatrix(2,Qr.radians(-this.orientation[2])),Qr.rotationMatrix(0,Qr.radians(-this.orientation[1]-90)),this.rotationview),Kr.multiply(this.rotationview,Qr.rotationMatrix(2,Qr.radians(-this.orientation[0])),this.rotationview)),Kr.multiply(this.rotationview,Qr.translationMatrix(-this.position[0],-this.position[1],-this.position[2]),this.modelview),this.ortho?this.projection=Qr.orthographicMatrix(this.viewHeight,this.aspect,this.near,this.far):this.projection=Qr.perspectiveMatrix(this.fov,this.aspect,this.near,this.far),Kr.multiply(this.projection,this.modelview,this.mvp),this.frustumPlanes[0]=[0,0,1,1],this.frustumPlanes[1]=[0,0,-1,1],this.frustumPlanes[2]=[1,0,0,1],this.frustumPlanes[3]=[-1,0,0,1],this.frustumPlanes[4]=[0,1,0,1],this.frustumPlanes[5]=[0,-1,0,1];var t=Kr.create();Kr.transpose(this.mvp,t);for(var i=0;i<6;i++)this.frustumPlanes[i]=Kr.multiplyVec4(t,this.frustumPlanes[i]);this.mvp32.set(this.mvp),this.projection32.set(this.projection),this.modelview32.set(this.modelview),this.rotationview32.set(this.rotationview),this.fovDist=.5*this.parent.curSize[1]/this.fovTan,this.dirty=!1};var $r=Xr,es=I,ts={setFaceVertices:function(e,t,i,r,s){e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=i[0],e[s+4]=i[1],e[s+5]=i[2],e[s+6]=r[0],e[s+7]=r[1],e[s+8]=r[2]},setFaceUVs:function(e,t,i,r,s){e[s]=t[0],e[s+1]=t[1],e[s+2]=i[0],e[s+3]=i[1],e[s+4]=r[0],e[s+5]=r[1]},buildHeightmap:function(e,t){e--;for(var i=ts,r=e*e*2,s=new Float32Array(3*r*3),a=new Float32Array(3*r*2),n=1*e,o=0,h=0,l=0;l<e;l++)for(var u=0;u<e;u++){var c=u*n,d=(u+1)*n,p=l*n,f=(l+1)*n;i.setFaceVertices(s,[c,p,0],[d,p,0],[d,f,0],o),i.setFaceUVs(a,[c,p],[d,p],[d,f],h),o+=9,h+=6,i.setFaceVertices(s,[d,f,0],[c,f,0],[c,p,0],o),i.setFaceUVs(a,[d,f],[c,f],[c,p],h),o+=9,h+=6}var g=new es(0,0,0,1,1,1);return t?{bbox:g,vertices:this.covnetTo16Bit(s),uvs:this.covnetTo16Bit(a)}:{bbox:g,vertices:s,uvs:a}},buildPlane:function(e,t){e--;for(var i,r,s,a,n,o,h,l,u=ts,c=e*e*2,d=t?new Uint16Array(3*c*3):new Float32Array(3*c*3),p=new Float32Array(3*c*2),f=1/e,g=0,m=0,v=0;v<e;v++)for(var y=0;y<e;y++)i=y,s=y+1,r=v,a=v+1,n=y*f,o=(y+1)*f,h=v*f,l=(v+1)*f,u.setFaceVertices(d,[i,r,0],[i,a,0],[s,a,0],g),u.setFaceUVs(p,[n,h],[n,l],[o,l],m),g+=9,m+=6,u.setFaceVertices(d,[s,a,0],[s,r,0],[i,r,0],g),u.setFaceUVs(p,[o,l],[o,h],[n,h],m),g+=9,m+=6;var b=new es(0,0,0,1,1,1);return t?{bbox:b,vertices:d,uvs:this.covnetTo16Bit(p)}:{bbox:b,vertices:d,uvs:p}},spherePos:function(e,t){return t*=Math.PI,e*=2*Math.PI,[Math.cos(e)*Math.sin(t)*.5+.5,Math.sin(e)*Math.sin(t)*.5+.5,.5*Math.cos(t)+.5]},buildSkydome:function(e,t,i,r){var s,a,n,o=ts,h=e*t*2,l=e*t*(r?1:3),u=new Float32Array(3*l),c=new Float32Array(2*l),d=r?new Uint16Array(3*h):null,p=0,f=0;o=ts;if(r){for(g=0;g<e;g++)for(m=0;m<t;m++)a=m/t,n=g/e,s=o.spherePos(a,n),u[p]=s[0],u[p+1]=s[1],u[p+2]=s[2],c[f]=a,c[f+1]=n,p+=3,f+=2;for(p=0,g=0;g<e-1;g++)for(m=0;m<t;m++)x=g+1,(y=m+1)>=t&&(y=0),d[p]=x*t+m,d[p+1]=g*t+m,d[p+2]=g*t+y,d[p+3]=g*t+y,d[p+4]=x*t+y,d[p+5]=x*t+m,p+=6}else for(var g=0;g<e;g++)for(var m=0;m<t;m++){var v=m/t,y=(m+1)/t,b=g/e,x=(g+1)/e;o.makeQuad(v,b,y,x,u,p,c,f),p+=18,f+=12}var w=new es(0,0,0,1,1,1);return i?{bbox:w,vertices:this.covnetTo16Bit(u),uvs:this.covnetTo16Bit(c),indices:d}:{bbox:w,vertices:u,uvs:c,indices:d}},covnetTo16Bit:function(e){for(var t,i=new Uint16Array(e.length),r=0,s=e.length;r<s;r++)(t=65535*e[r])<0&&(t=0),t>65535&&(t=65535),i[r]=t;return i},makeQuad:function(e,t,i,r,s,a,n,o){var h=ts,l=h.spherePos(e,t),u=[e,t],c=h.spherePos(e,r),d=[e,r],p=h.spherePos(i,t),f=[i,t],g=h.spherePos(i,r),m=[i,r];h.setFaceVertices(s,c,l,p,a),h.setFaceUVs(n,d,u,f,o),h.setFaceVertices(s,p,g,c,a+9),h.setFaceUVs(n,f,m,d,o+6)}},is=ts,rs=function(e,t){this.gl=e.gl;var i,r=this.gl;null!=r&&(this.free=t,this.vertexPositionBuffer=null,this.vertexPositionBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.vertexPositionBuffer),i=t?[0,0,0,0,0,1,0,0,1,0,0,2,0,0,2,0,0,3,0,0,3,0,0,0,0,0,4,0,0,5,0,0,5,0,0,6,0,0,6,0,0,7,0,0,7,0,0,4,0,0,0,0,0,4,0,0,1,0,0,5,0,0,2,0,0,6,0,0,3,0,0,7]:[0,0,0,1,0,0,1,0,0,1,1,0,1,1,0,0,1,0,0,1,0,0,0,0,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,0,1,1,0,1,1,0,0,1,0,0,0,0,0,1,1,0,0,1,0,1,1,1,0,1,1,1,0,1,0,0,1,1],r.bufferData(r.ARRAY_BUFFER,new Float32Array(i),r.STATIC_DRAW),this.vertexPositionBuffer.itemSize=3,this.vertexPositionBuffer.numItems=i.length/3,this.size=36,this.lines=this.vertexPositionBuffer.numItems/3)};rs.prototype.kill=function(){this.gl.deleteBuffer(this.vertexPositionBuffer)},rs.prototype.draw=function(e,t){var i=this.gl;if(null!=i){var r=e.getAttribute(t);i.bindBuffer(i.ARRAY_BUFFER,this.vertexPositionBuffer),i.vertexAttribPointer(r,this.vertexPositionBuffer.itemSize,i.FLOAT,!1,0,0),i.drawArrays(i.LINES,0,this.vertexPositionBuffer.numItems)}};var ss=rs,as=function(e,t,i,r,s,a){this.bbox=null,this.gpu=e,this.gl=e.gl,this.core=t,null!=this.gl&&(this.vertices=[],this.normals=[],this.vertexBuffer=null,this.lines=i,this.joins=s,this.joinSides=a,this.maxLines=r,this.init())};as.prototype.kill=function(){this.gl.deleteBuffer(this.vertexBuffer)},as.prototype.init=function(){var e;if(this.lines)for(this.joins&&this.addCircle(0,this.joinSides),e=0;e<this.maxLines;e++)this.addLine(e,e+1),this.joins&&this.addCircle(e+1,this.joinSides);else if(this.joins)for(e=0;e<=this.maxLines;e++)this.addCircle(e,this.joinSides);this.compile()},as.prototype.addLine=function(e,t){var i=this.vertices.length;this.vertices[i]=e,this.vertices[i+1]=t,this.vertices[i+2]=1,this.vertices[i+3]=e,this.vertices[i+4]=t,this.vertices[i+5]=-1,this.vertices[i+6]=t,this.vertices[i+7]=e,this.vertices[i+8]=1,this.vertices[i+9]=e,this.vertices[i+10]=t,this.vertices[i+11]=1,this.vertices[i+12]=t,this.vertices[i+13]=e,this.vertices[i+14]=1,this.vertices[i+15]=t,this.vertices[i+16]=e,this.vertices[i+17]=-1,this.polygons+=2},as.prototype.addCircle=function(e,t){for(var i=this.vertices.length,r=2*Math.PI/t,s=0;s<t;s++)this.vertices[i]=e,this.vertices[i+1]=-1,this.vertices[i+2]=0,this.vertices[i+3]=e,this.vertices[i+4]=-2,this.vertices[i+5]=r*s,this.vertices[i+6]=e,this.vertices[i+7]=-2,this.vertices[i+8]=r*(s+1),i+=9;this.polygons+=t},as.prototype.compile=function(){var e=this.gl;this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),this.vertexBuffer.itemSize=3,this.vertexBuffer.numItems=this.vertices.length/3,this.size=3*this.vertexBuffer.numItems*4*2,this.polygons=this.vertexBuffer.numItems/3},as.prototype.draw=function(e,t,i){var r=this.gl;if(!(null==r||null==this.vertexBuffer||i>this.maxLines)){var s=e.getAttribute(t);r.bindBuffer(r.ARRAY_BUFFER,this.vertexBuffer),r.vertexAttribPointer(s,this.vertexBuffer.itemSize,r.FLOAT,!1,0,0);var a=0;this.lines&&(a+=3*(i-1)*2),this.joins&&(a+=i*(3*this.joinSides)),r.drawArrays(r.TRIANGLES,0,a)}},as.prototype.getSize=function(){return this.size},as.prototype.getBbox=function(){return this.bbox},as.prototype.getPolygons=function(){return this.polygons};var ns=is,os=ss,hs=W,ls=as,us=$,cs=te,ds=c,ps=function(e){this.renderer=e,this.core=e.core,this.gpu=e.gpu,this.initShaders(),this.initHeightmap(),this.initSkydome(),this.initHitmap(),this.initTextMap(),this.initImage(),this.initTestMap(),this.initBBox(),this.initLines(),this.initBaricentricBuffer()};ps.prototype.initShaders=function(){var e=cs,t=this.renderer,i=this.gpu;t.progTile=[new us(i,"#define variants\n"+e.tileVertexShader,"#define variants\n"+e.tileFragmentShader)],t.progTile2=[new us(i,"#define variants\n#define externalTex\n"+e.tileVertexShader,"#define variants\n#define externalTex\n"+e.tileFragmentShader.replace("__FILTER__",""))],t.progTile3=[new us(i,"#define variants\n#define externalTex\n"+e.tileVertexShader,"#define variants\n#define externalTex\n#define mask\n"+e.tileFragmentShader.replace("__FILTER__",""))],t.progFogTile=[new us(i,"#define variants\n#define onlyFog\n"+e.tileVertexShader,"#define variants\n#define onlyFog\n"+e.tileFragmentShader)];var r="#extension GL_OES_standard_derivatives : enable\n";t.progFlatShadeTile=[new us(i,"#define variants\n#define flatShadeVar\n"+e.tileVertexShader,r+"#define variants\n#define flatShadeVar\n#define flatShade\n"+e.tileFragmentShader)],t.progFlatShadeTileSE=[new us(i,"#define variants\n#define applySE\n#define flatShadeVar\n"+e.tileVertexShader,r+"#define variants\n#define flatShadeVar\n#define flatShade\n"+e.tileFragmentShader)],t.progCFlatShadeTile=new us(i,"#define flatShadeVar\n"+e.tileVertexShader,(r+"#define flatShadeVar\n#define flatShade\n#define fogAndColor\n"+e.tileFragmentShader).replace("mediump","highp")),t.progCFlatShadeTileSE=new us(i,"#define applySE\n#define flatShadeVar\n"+e.tileVertexShader,(r+"#define flatShadeVar\n#define flatShade\n#define fogAndColor\n"+e.tileFragmentShader).replace("mediump","highp")),t.progDepthTile=[new us(i,"#define variants\n#define depth\n"+e.tileVertexShader,("#define variants\n#define depth\n"+e.tileFragmentShader).replace("mediump","highp"))],t.progDepthHeightmap=new us(i,e.heightmapDepthVertexShader,e.heightmapDepthFragmentShader.replace("mediump","highp")),t.progWireFrameBasic=[new us(i,"#define variants\n"+e.tileVertexShader,"#define variants\n"+e.tileWireFrameBasicShader)],t.progShadedTile=new us(i,e.shadedMeshVertexShader,e.shadedMeshFragmentShader),t.progTShadedTile=new us(i,e.shadedMeshVertexShader,"#define textured\n"+e.shadedMeshFragmentShader),t.progHeightmap=new us(i,e.heightmapVertexShader,e.heightmapFragmentShader),t.progPlane=new us(i,"#define flat\n"+e.planeVertexShader,e.planeFragmentShader),t.progPlane2=new us(i,"#define poles\n"+e.planeVertexShader,"#define poles\n"+e.planeFragmentShader),t.progPlane3=new us(i,e.planeVertexShader,e.planeFragmentShader),t.progPlaneD=new us(i,"#define depth\n#define flat\n"+e.planeVertexShader,"#define depth\n"+e.planeFragmentShader),t.progPlane2D=new us(i,"#define depth\n#define poles\n"+e.planeVertexShader,"#define depth\n#define poles\n"+e.planeFragmentShader),t.progPlane3D=new us(i,"#define depth\n"+e.planeVertexShader,"#define depth\n"+e.planeFragmentShader),t.progSkydome=new us(i,e.skydomeVertexShader,e.skydomeFragmentShader),t.progStardome=new us(i,e.skydomeVertexShader,e.stardomeFragmentShader),t.progAtmo2=new us(i,e.atmoVertexShader,e.atmoFragmentShader),t.progAtmo=new us(i,e.atmoVertexShader3,e.atmoFragmentShader3),t.progPCloud=new us(i,e.pointsVertexShader,e.pointsFragmentShader),t.progBBox=new us(i,e.bboxVertexShader,e.bboxFragmentShader),t.progBBox2=new us(i,e.bbox2VertexShader,e.bboxFragmentShader),t.progLine=new us(i,e.lineVertexShader,e.lineFragmentShader),t.progLineSE=new us(i,"#define applySE\n"+e.lineVertexShader,e.lineFragmentShader),t.progELine=new us(i,"#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progELineSE=new us(i,"#define applySE\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progLine3=new us(i,"#define pixelLine\n"+e.lineVertexShader,e.lineFragmentShader),t.progELine3=new us(i,"#define pixelLine\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progLine3SE=new us(i,"#define applySE\n#define pixelLine\n"+e.lineVertexShader,e.lineFragmentShader),t.progELine3SE=new us(i,"#define applySE\n#define pixelLine\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progLine4=new us(i,"#define pixelLine\n#define dataPoints\n"+e.lineVertexShader,e.lineFragmentShader),t.progLine5=new us(i,"#define pixelLine\n#define dataPoints\n#define dataPoints2\n"+e.lineVertexShader,e.lineFragmentShader),t.progRLine=new us(i,"#define dynamicWidth\n"+e.lineVertexShader,e.lineFragmentShader),t.progRLineSE=new us(i,"#define applySE\n#define dynamicWidth\n"+e.lineVertexShader,e.lineFragmentShader),t.progERLine=new us(i,"#define dynamicWidth\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progERLineSE=new us(i,"#define applySE\n#define dynamicWidth\n#define withElements\n"+e.lineVertexShader,"#define withElements\n"+e.lineFragmentShader),t.progTLine=new us(i,e.tlineVertexShader,e.tlineFragmentShader),t.progTPLine=new us(i,e.tplineVertexShader,e.tlineFragmentShader),t.progTBLine=new us(i,e.tlineVertexShader,e.tblineFragmentShader),t.progTPBLine=new us(i,e.tplineVertexShader,e.tblineFragmentShader),t.progETLine=new us(i,e.etlineVertexShader,e.elineFragmentShader),t.progETPLine=new us(i,e.etplineVertexShader,e.elineFragmentShader),t.progText2=new us(i,"#define lineLabel\n"+e.lineVertexShader,e.text2FragmentShader),t.progText2SE=new us(i,"#define applySE\n#define lineLabel\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel16=new us(i,"#define DSIZE 16\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel32=new us(i,"#define DSIZE 32\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel48=new us(i,"#define DSIZE 48\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel64=new us(i,"#define DSIZE 64\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel96=new us(i,"#define DSIZE 96\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progLineLabel128=new us(i,"#define DSIZE 128\n#define lineLabel2\n"+e.lineVertexShader,e.text2FragmentShader),t.progPolygon=new us(i,e.polygonVertexShader,e.polygonFragmentShader),t.progImage=new us(i,e.imageVertexShader,e.imageFragmentShader),t.progIcon=new us(i,e.iconVertexShader,e.textFragmentShader),t.progIcon2=new us(i,e.icon2VertexShader,e.text2FragmentShader),t.progLabel16=new us(i,"#define DSIZE 16\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel32=new us(i,"#define DSIZE 32\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel48=new us(i,"#define DSIZE 48\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel64=new us(i,"#define DSIZE 64\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel96=new us(i,"#define DSIZE 96\n"+e.icon3VertexShader,e.text2FragmentShader),t.progLabel128=new us(i,"#define DSIZE 128\n"+e.icon3VertexShader,e.text2FragmentShader)},ps.prototype.initProceduralShaders=function(){var e=cs,t=this.renderer,i=this.gpu;t.progHmapPlane=new us(i,e.planeVertex4Shader,e.planeFragmentShader2),t.progHmapPlane2=new us(i,e.planeVertex4Shader,"#define grid\n"+e.planeFragmentShader2),t.progHmapPlane3=new us(i,e.planeVertex4Shader,"#define exmap\n"+e.planeFragmentShader2),t.progHmapPlane4=new us(i,e.planeVertex4Shader,"#define flat\n"+e.planeFragmentShader2),t.progHmapPlane5=new us(i,e.planeVertex4Shader,"#define normals\n"+e.planeFragmentShader2),t.progHmapPlane6=new us(i,e.planeVertex4Shader,"#define nmix\n#define normals\n"+e.planeFragmentShader2),t.progHmapPlane7=new us(i,e.planeVertex4Shader,"#define nmix\n"+e.planeFragmentShader2),t.progHmapPlane8=new us(i,e.planeVertex4Shader,"#define exmap\n#define classmap\n"+e.planeFragmentShader2)},ps.prototype.initHeightmap=function(){var e=this.renderer,t=e.core.config.map16bitMeshes,i=this.gpu,r=ns.buildHeightmap(5,!0);r=ns.buildPlane(16,!0),e.planeMesh=new hs(i,r,null,this.core,!0,t,!0),r=ns.buildPlane(128,!0),e.planeMesh2=new hs(i,r,null,this.core,!0,t,!0);for(var s=new Uint8Array(16384),a=0;a<64;a++)for(var n=0;n<64;n++){var o=4*(64*a+n);a<1||a>=63||n<1||n>=63?(s[o]=255,s[o+1]=255,s[o+2]=255):(s[o]=32,s[o+1]=32,s[o+2]=32),s[o+3]=255}e.heightmapTexture=new ds(i),e.heightmapTexture.createFromData(64,64,s,"trilinear",!0)},ps.prototype.initHitmap=function(){var e=this.renderer,t=e.hitmapSize,i=new Uint8Array(t*t*4);e.hitmapMode>2&&(e.hitmapData=i),e.hitmapTexture=new ds(this.gpu),e.hitmapTexture.createFromData(t,t,i),e.hitmapTexture.createFramebuffer(t,t),e.geoHitmapTexture=new ds(this.gpu),e.geoHitmapTexture.createFromData(t,t,i),e.geoHitmapTexture.createFramebuffer(t,t),e.geoHitmapTexture2=new ds(this.gpu),e.geoHitmapTexture2.createFromData(t,t,i),e.geoHitmapTexture2.createFramebuffer(t,t)},ps.prototype.initTestMap=function(){var e,t,i,r=this.renderer,s=this.gpu,a=new Uint8Array(1024);for(e=0;e<16;e++)for(t=0;t<16;t++)a[i=4*(16*e+t)]=255,a[i+1]=0,a[i+2]=0,a[i+3]=255;for(r.redTexture=new ds(s),r.redTexture.createFromData(16,16,a),a=new Uint8Array(1024),e=0;e<16;e++)for(t=0;t<16;t++)a[i=4*(16*e+t)]=255,a[i+1]=255,a[i+2]=255,a[i+3]=255;for(r.whiteTexture=new ds(s),r.whiteTexture.createFromData(16,16,a),a=new Uint8Array(1024),e=0;e<16;e++)for(t=0;t<16;t++)a[i=4*(16*e+t)]=0,a[i+1]=0,a[i+2]=0,a[i+3]=255;r.blackTexture=new ds(s),r.blackTexture.createFromData(16,16,a)},ps.prototype.initTextMap=function(){this.renderer.textTexture2=new ds(this.gpu,"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAACACAMAAADTa0c4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAAAA////pdmf3QAABIFJREFUeNrsnNuyqzAIhsP7v/Se6Yxra0L4OUVNCzetVqP5DAQItrVOiLg95739NnfOaR99RDj6esBw+CKZXiMK4PiuBkAcANoHAP3J5fzzAV2jePQIt6f4Ndb/MIChlVcCEFpAACZPfN4KUAF0/ufboDW3AuBMFgBwHTCfg2ftYgDUKBuA1ABuHKvA2P+5XdONIEt7BO2o2MdlAJoTQOsV6GEAswt0Zq/bsBhdeQQkqEDMwmIAnJHzA8i3ASkWRFKBbADyLGB3mlYD6DyhA4DfBlgsBDtirUPcBgC5woStYMgVtgKATWcB6DskKUEkGFLYrGw3+l3ydR16wKbbPDlWp4Xfo9vZwR1jtOMA6GkABrdvNmt1Vluy6pyvxu4Xt62fquyTggCTsIkCoIuv8gAA08w+ATBXAdSRY56xPDFPx/VPWFZp5v65kFMPgFjP70YASMfRsDn01xLPcwkRq1HLMoK647hR8v+nId74MQBjvIbUQePra42ZVXVcBCR3mIY89mYAlNGLflqA0V1seosCQNMg80B0bsLGAIDNwvFyiqu66ngVGGMGVBwyWwIwpty2DqEr/qf0Bq+DbjYkkcr4VUoOxiRjrYn3YY5SC4BQB/cF0Lq4kD1RCJ+tN4g6Jps5zfWu+QmSz9sUABkA0BIAXocmBwCJ99MDIASATkmtLQAIft4IgE/ZDStZ59yQbOQQAGZWYMbZ3FFCAGRHnwHQznegGAE+zwxNi8kALCOgS9tzAC4jYG1Qo0myRm0Ae/z8eleqewBoZLwfUswCsbT1KgBZD6QAzAEoXUe3K+xxVf2uLf5U3nBeMPRyACW/LtrwVX989id3PRQOG5Io6vh9XwC6stHIdGdJozun03lxNlwvH4u6UgDM8/LmJyx7ak12feEebaXmUwCOYJWk1JcYKsl74HL74wAaH93NqkE1FSKXc4cv0AjaPEEPgE4ru/ieWdvzVq/4psG3AYDFHlEAioQCuEgMgPjK1VDrqlkbTABAiQBGK38B0BlBSf9xtiAJQDM4NtDqMlaeyduTtkDjHgAtEQBj5ZGK2QE0aCcMAIxLSw0WVYlGDgOQXWE+afouAM0S398O4Nej3wIQf4cIHSfz9pbWugyep4MFIAFARvspbm8BcE2DOdvWnCJQAWFhJ/hKzh4AaB2A7NxedKmLPc+6PN4cL2S8GYC1QMIEQJvmFsJfxdvkEQAoLV4AogBS8/kNvdXlWe5GKhABvQUAZASDALJffY1XfsrToFXFbvYD1gBo6wC8LR7/uvj9CwHcfWuoUJItsVl5nwWAnhxxqsXatUq0OYCcaS/fkbK61u5H8jwAuUIEZXHNL1Jmub5oSKZWiDR9FttM4HEAigqRpn8TeB2AuWNiByAXSHCGbB7/3qYCfgCgPgADEEskbjCCaJDB/+kR6wP4P1Obl8jsBwDUB4yAxqKkthaATjX0KmCtDyCxm+yIMLjCbwBgrg94FYC3h8vLPPmfAVBSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlJSUlLy9fJPgAEAvWMULbGsSjwAAAAASUVORK5CYII=",this.core,null,!0)},ps.prototype.initImage=function(){var e=this.renderer,t=this.gpu.gl;e.rectVerticesBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.rectVerticesBuffer);t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,0,1,2,0,0,1,3,0,0,1]),t.STATIC_DRAW),e.rectVerticesBuffer.itemSize=4,e.rectVerticesBuffer.numItems=4,e.rectIndicesBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.rectIndicesBuffer);t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,2,1,0,3,2]),t.STATIC_DRAW),e.rectIndicesBuffer.itemSize=1,e.rectIndicesBuffer.numItems=6,e.textBuff16=new Float32Array(64),e.textBuff32=new Float32Array(128),e.textBuff48=new Float32Array(192),e.textBuff64=new Float32Array(256),e.textQuads16=this.generateTextQuads(16),e.textQuads32=this.generateTextQuads(32),e.textQuads48=this.generateTextQuads(48),e.textQuads64=this.generateTextQuads(64),e.textQuads96=this.generateTextQuads(96),e.textQuads128=this.generateTextQuads(128)},ps.prototype.generateTextQuads=function(e){this.renderer;for(var t,i,r=this.gpu.gl,s=new Float32Array(2*e*6),a=0;a<e;a++)i=0,s[t=6*a*2]=a,s[t+1]=i,i=1,s[t+2]=a,s[t+3]=i,i=2,s[t+4]=a,s[t+5]=i,i=2,s[t+6]=a,s[t+7]=i,i=3,s[t+8]=a,s[t+9]=i,i=0,s[t+10]=a,s[t+11]=i;var n=r.createBuffer();return r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,s,r.STATIC_DRAW),n.itemSize=2,n.numItems=6*e,n},ps.prototype.initSkydome=function(){var e=this.renderer,t=e.core.config.map16bitMeshes,i=ns.buildSkydome(32,64,t);e.skydomeMesh=new hs(this.gpu,i,null,this.core,!0,t),i=ns.buildSkydome(128,256,t,!0),e.atmoMesh=new hs(this.gpu,i,null,this.core,!0,t)},ps.prototype.initBBox=function(){var e=this.renderer,t=this.gpu;e.bboxMesh=new os(t),e.bboxMesh2=new os(t,!0)},ps.prototype.initLines=function(){var e=this.gpu,t=this.renderer;t.plineBuffer=new Float32Array(96),t.plines=new ls(e,this.core,!0,64,!0,8),t.plineJoints=new ls(e,this.core,!1,64,!0,8),t.stencilLineState=e.createState({blend:!0,stencil:!0,culling:!1}),t.lineLabelState=e.createState({blend:!0,culling:!1,zequal:!0,zwrite:!1}),t.labelState=e.createState({blend:!0,culling:!1,zequal:!0}),t.stencilLineHitState=e.createState({blend:!1,stencil:!0,culling:!1}),t.lineLabelHitState=e.createState({blend:!1,culling:!1}),t.polygonB1S1C1tate=e.createState({blend:!0,stencil:!0,culling:!0,zequal:!0}),t.polygonB1S0C1tate=e.createState({blend:!0,stencil:!1,culling:!0,zequal:!0}),t.polygonB1S1C0tate=e.createState({blend:!0,stencil:!0,culling:!1,zequal:!0}),t.polygonB1S0C0tate=e.createState({blend:!0,stencil:!1,culling:!1,zequal:!0}),t.polygonB0S1C1tate=e.createState({blend:!1,stencil:!0,culling:!0,zequal:!0}),t.polygonB0S0C1tate=e.createState({blend:!1,stencil:!1,culling:!0,zequal:!0}),t.polygonB0S1C0tate=e.createState({blend:!1,stencil:!0,culling:!1,zequal:!0}),t.polygonB0S0C0tate=e.createState({blend:!1,stencil:!1,culling:!1,zequal:!0})},ps.prototype.initBaricentricBuffer=function(){for(var e=this.gpu,t=new Array(196605),i=0;i<196605;i+=9)t[i]=1,t[i+1]=0,t[i+2]=0,t[i+3]=0,t[i+4]=1,t[i+5]=0,t[i+6]=0,t[i+7]=0,t[i+8]=1;var r=e.gl;e.barycentricBuffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,e.barycentricBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array(t),r.STATIC_DRAW),e.barycentricBuffer.itemSize=3,e.barycentricBuffer.numItems=t.length/3};var fs=ps;function gs(e,t,i,r){var s,a,n=0,o=t?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY,h=r.gmapTop,l=0,u=0,c=r.gmap;do{var d=t?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;u=l;for(var p=0,f=e.length;p<f;p++)s=c[a=e[p]][0].reduce[1],(t&&s>=d&&s<o||s<=d&&s>o)&&(d!=s&&(l=u),h[l]=a,l++,d=s);o=d,n++}while(n<i)}function ms(e,t,i,r,s,a,n,o,h){var l,u,c=i-1,d=r-1,p=i+1,f=r+1;for(c<0&&(c=0),d<0&&(d=0),p>s&&(p=s),f>a&&(f=a);d<=f;d++)for(l=c;l<=p;l++)n[u=2*(d*s+l)],n[u]?(o[n[u+1]]=h,n[u+1]=h+1,o[h]=t,o[h+1]=0,h+=2):(n[u]=h,n[u+1]=h+1,o[h]=t,o[h+1]=0,h+=2);return h}function vs(e,t,i,r,s){var a,n,o,h,l=i<65536?e.radixCountBuffer16:e.radixCountBuffer32,u=e.buffUint32,c=e.buffFloat32,d=e.config.mapFeaturesReduceFactor;e.curSize[0],e.curSize[1];if(l.fill)l.fill(0);else for(o=0;o<1024;o++)l[o]=0;for(o=0;o<i;o++)n=(h=(a=t[o])[0].reduce)[3]-d*Math.log(h[4]),h[6]=n,(n+=1e4)<0&&(n=0),c[0]=n,n=u[0],h[5]=n,l[255&n]++,l[256+(n>>8&255)]++,l[512+(n>>16&255)]++,l[768+(n>>24&255)]++;for(var p=0;p<4;p++){var f=0,g=0,m=256*p;for(o=0;o<256;o++)f=l[o+m],l[o+m]=g,g+=f}for(o=0;o<i;o++)r[l[255&(n=(a=t[o])[0].reduce[5])]++]=a;for(o=0;o<i;o++)t[l[256+((n=(a=r[o])[0].reduce[5])>>8&255)]++]=a;for(o=0;o<i;o++)r[l[512+((n=(a=t[o])[0].reduce[5])>>16&255)]++]=a;for(o=0;o<i;o++)t[l[768+((n=(a=r[o])[0].reduce[5])>>24&255)]++]=a;if(-123==o)for(o=0;o<i;o++)n=t[o][0].reduce[5],console.log(n+" "+t[o][0].id);return t}function ys(e,t,i,r,s){var a=r-1,n=s-1;(t-=.5)<0&&(t=0),(i-=.5)<0&&(i=0),t>a&&(t=a),i>n&&(i=n);var o=Math.floor(t),h=Math.floor(i),l=t-o,u=i-h,c=h*r,d=h==n?c:c+r,p=o==a?o:o+1,f=e[c+o],g=e[c+p],m=e[d+o],v=f+(g-f)*l;return v+(m+(e[d+p]-m)*l-v)*u}var bs=s.d,xs=s.a,ws=s.b,Ms=p.a,Ss=function(e,t,i,r,s){if(i.config.mapFeaturesReduceParams){var a,n,o=i.config.mapFeaturesReduceParams[1],h=i.config.mapFeaturesReduceParams[0],l=96*(window.devicePixelRatio||1),u=i.curSize[0],c=i.curSize[1],d=Math.ceil(u/l*(c/l)*h),p=i.config.mapFeaturesSortByTop;o=o<=0?2*d:o;var f=i.gmap,g=i.gmapIndex,m=i.gmapTop,v=d;d>g&&(v=g);var y,b,x,w,M=Math.floor(Math.sqrt(u*c/o)),S=i.gmapHit,A=0,C=i.drawAllLabels,T=[[0,0,255,255],[128,0,255,255],[255,0,0,255],[255,128,0,255],[0,255,0,255],[0,255,128,255],[128,255,128,255]],P=0;do{var F,L,E,k,N,I,B,R,z,U,D,_,O,G,V;F=1/(B=(N=u/M)*(I=c/M)),L=(N-=D=Math.floor(N))/B,E=(I-=_=Math.floor(I))/B,k=N*I/B,F=Math.floor(F*d),L=Math.floor(L*d),E=Math.floor(E*d),k=Math.floor(k*d);S=i.gmapStore;var j=i.gmapHit;if(i.drawGridCells){e.setState(i.lineLabelState);var H,W,q=0,Z=0;for(H=0,W=_+1;H<W;H++)for(a=0,n=D+1;a<n;a++)q=M*a,Z=M*H,O=F,a>=D?O=H>=_?k:L:H>=_&&(O=L),s.drawLineString([[q,Z,.5],[q+M,Z,.5],[q+M,Z+M,.5],[q,Z+M,.5]],!0,1,T[P],null,!0,null,null,null),s.drawText(Math.round(q+5),Math.round(Z+5+15*P),10,""+O,T[P],.5)}for(a=0,n=(D+1)*(_+1);a<n;a++)S[a]=null;for(a=0,n=g;a<n;a++)(x=f[a])&&((R=x[5])[0]<30||R[0]>=u-30||R[1]<30||R[1]>=c-30?f[a]=null:(z=R[0]/M,U=R[1]/M,(O=z>D?U>_?k:L:U>_?E:F)>0&&((y=S[G=Math.floor(z)+Math.floor(U)*(D+1)])?S[G].push(a):(S[G]=[a],j[G]=O))));for(a=0,n=(D+1)*(_+1);a<n;a++)if((y=S[a])&&y.length)for((b=j[a])>y.length&&(b=y.length),gs(y,p,b,i),H=0;H<b;H++)x=f[G=m[H]],m[H]=null,f[G]=null,w=x[0],!C&&x[6]?(R=x[5],V=x[8],i.rmap.addRectangle(R[0]+V[0],R[1]+V[1],R[0]+V[2],R[1]+V[3],x[7],x[0].lastSubJob),6==w.type?i.rmap.addLineLabel(w.lastSubJob,depthParams):i.rmap.addRectangle(R[0]+V[0],R[1]+V[1],R[0]+V[2],R[1]+V[3],x[7],w.lastSubJob,!0,depthParams)&&i.rmap.storeRemovedRectangle(R[0]+V[0],R[1]+V[1],R[0]+V[2],R[1]+V[3],x[7],x[0].lastSubJob)):w.hysteresis?i.jobHBuffer[w.id]=w:(i.drawnJobs++,6==w.type?s.drawGpuSubJobLineLabel(e,t,i,r,w.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,w.lastSubJob,null));A+=(F*=D*_)+(L*=D)+(E*=_)+k,d-=F+L+E+k,M*=2,P++}while(A<v)}},As=function(e,t,i,r,s){if(i.config.mapFeaturesReduceParams){var a,n,o,h,l,u,c,d,p,f=96*(window.devicePixelRatio||1),g=i.config.mapFeaturesReduceParams[0]*f,m=i.config.mapFeaturesReduceParams[1],v=i.curSize[0],y=i.curSize[1],b=(i.config.mapFeaturesSortByTop,i.drawAllLabels),x=i.gmap,w=i.gmapIndex,M=i.gmap2,S=1,A=i.gmap3,C=i.gmap3Size,T=(A=i.gmap3,1e4),P=0,F=i.config.mapFeaturesReduceFactor>=1;if(F){if(i.fmaxDist==Number.NEGATIVE_INFINITY||i.fminDist==Number.POSITIVE_INFINITY)return;var L=1-Math.log(i.fminDist)/Math.log(101),E=-Math.log(i.fmaxDist)/Math.log(101)}for(a=0,n=w;a<n;a++)(o=x[a])&&(h=o[5],F?(p=o[0].reduce,d=Math.round(((Math.log(p[1]+1)-Math.log(p[4]))/Math.log(101)-E)/(L-E)*1e4-5e3)+5e3,p[5]=d):d=Math.round(o[0].reduce[1]),d<0&&(d=0),d>=1e4&&(d=9999),d<T&&(T=d),d>P&&(P=d),A[d][C[d]++]=o);var k,N,I,B=1/g,R=Math.floor(v*B),z=Math.floor(y*B),U=i.gmapStore;i.gmapHit;for(a=0,n=(R+1)*(z+1)*2;a<n;a+=2)U[a]=0;var D,_,O,G,V,j=0;for(g*=g,a=P,n=T;a>=0;a--)if(C[a]>0){var H=A[a];for(D=0,_=C[a];D<_;D++){if(c=(o=H[D])[0],O=0,h=o[5],N=Math.floor(h[0]*B),U[k=2*((I=Math.floor(h[1]*B))*R+N)]){k=U[k];do{if(l=M[k][5],(G=h[0]-l[0])*G+(V=h[1]-l[1])*V<g&&++O>m)break;k=M[k+1]}while(k)}O<=m&&(k=j,!b&&o[6]?(h=o[5],u=o[8],6==c.type?i.rmap.addLineLabel(c.lastSubJob,null)&&j++:i.rmap.addRectangle(h[0]+u[0],h[1]+u[1],h[0]+u[2],h[1]+u[3],o[7],c.lastSubJob,!0,null)&&j++):(c.hysteresis?i.jobHBuffer[c.id]=c:(i.drawnJobs++,6==c.type?s.drawGpuSubJobLineLabel(e,t,i,r,c.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,c.lastSubJob,null)),j++),k!=j&&(S=ms(0,o,N,I,R,z,U,M,S)))}C[a]=0}}},Cs=function(e,t,i,r,s){if(i.config.mapFeaturesReduceParams){window.devicePixelRatio,i.curSize[0],i.curSize[1],i.config.mapFeaturesSortByTop;var a,n,o,h,l,u,c,d,p,f,g=i.drawAllLabels,m=i.gmap,v=i.gmapIndex,y=(i.gmap2,i.gmap3),b=i.gmap3Size,x=(y=i.gmap3,1e4),w=0,M=i.config.mapFeaturesReduceFactor>=1;if(M){if(i.fmaxDist==Number.NEGATIVE_INFINITY||i.fminDist==Number.POSITIVE_INFINITY)return;var S=1-Math.log(i.fminDist)/Math.log(101),A=-Math.log(i.fmaxDist)/Math.log(101)}for(a=0,n=v;a<n;a++)(o=m[a])&&(h=o[5],M?(d=o[0].reduce,c=Math.round(((Math.log(d[1]+1)-Math.log(d[4]))/Math.log(101)-A)/(S-A)*1e4-5e3)+5e3,d[5]=c):c=Math.round(o[0].reduce[1]),c<0&&(c=0),c>=1e4&&(c=9999),c<x&&(x=c),c>w&&(w=c),y[c][b[c]++]=o);for(a=w,n=x;a>=0;a--)if(b[a]>0){var C=y[a];for(p=0,f=b[a];p<f;p++)u=(o=C[p])[0],h=o[5],!g&&o[6]?(h=o[5],l=o[8],6==u.type?i.rmap.addLineLabel(u.lastSubJob,null):i.rmap.addRectangle(h[0]+l[0],h[1]+l[1],h[0]+l[2],h[1]+l[3],o[7],u.lastSubJob,!0,null)):u.hysteresis?i.jobHBuffer[u.id]=u:(i.drawnJobs++,6==u.type?s.drawGpuSubJobLineLabel(e,t,i,r,u.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,u.lastSubJob,null));b[a]=0}}},Ts=function(e,t,i,r,s){if(i.config.mapFeaturesReduceParams){var a,n,o,h,l,u=i.config.mapFeaturesReduceParams[1],c=96*(window.devicePixelRatio||1),d=i.curSize[0],p=i.curSize[1],f=Math.ceil(d/c*(p/c)*u),g=(i.config.mapFeaturesSortByTop,0),m=i.drawAllLabels,v=0!=i.config.mapFeaturesReduceFactor2,y=-i.config.mapFeaturesReduceFactor3,b=null;i.debugStr="<br>featuresPerScr: "+f;var x=i.gmap,w=i.gmapIndex;for(m&&(f=w),vs(i,x,w,i.gmap2),a=w-1;a>=0;a--)if(n=(o=x[a])[0],!m&&o[6]){if(h=o[5],l=o[8],b=v?[h[0],h[1]+o[1],n.reduce,y]:null,6==n.type?i.rmap.addLineLabel(n.lastSubJob,b)&&g++:i.rmap.addRectangle(h[0]+l[0],h[1]+l[1],h[0]+l[2],h[1]+l[3],o[7],n.lastSubJob,!0,b)&&g++,g>=f)return}else n.hysteresis?i.jobHBuffer[n.id]=n:(i.drawnJobs++,6==n.type?s.drawGpuSubJobLineLabel(e,t,i,r,n.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,n.lastSubJob,null))}},Ps=function(e,t,i,r,s){if(i.config.mapFeaturesReduceParams){var a=i.config.mapFeaturesReduceParams[5],n=i.config.mapFeaturesReduceParams[1],o=96*(window.devicePixelRatio||1),h=i.curSize[0],l=i.curSize[1],u=Math.ceil(h/o*(l/o)*n),c=u/(a*a),d=Math.floor(c),p=c-d,f=h/a,g=l/a;i.debugStr="<br>featuresPerScr: "+u+"<br>featuresPerTile: "+c.toFixed(2);i.config.mapFeaturesSortByTop;var m,v,y,b=0,x=0!=i.config.mapFeaturesReduceFactor2,w=-i.config.mapFeaturesReduceFactor3,M=null,S=i.gmap,A=i.gmapIndex,C=i.gmap2,T=0,P=i.gmap4,F=i.drawAllLabels;if(F&&(u=A),A>0)if(vs(i,S,A,C),F)for(m=A-1;m>=0;m--)y=(k=S[m])[0],k[0].hysteresis?i.jobHBuffer[k[0].id]=y:(i.drawnJobs++,6==(y=k[0]).type?s.drawGpuSubJobLineLabel(e,t,i,r,y.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,y.lastSubJob,null));else{var L,E,k,N,I,B,R,z,U,D,_,O,G=i.gmapHit;N=h/f,I=l/g,U=Math.round(N),D=Math.round(I);G=i.gmapStore,i.gmapHit;for(m=0,v=U*D;m<v;m++)G[m]=null,P[m]=null;for(m=A-1;m>=0;m--)(k=S[m])&&((B=k[5])[0]<30||B[0]>=h-30||B[1]<30||B[1]>=l-30?S[m]=null:(R=B[0]/f,z=B[1]/g,(L=G[_=Math.floor(R)+Math.floor(z)*U])?G[_].push(m):G[_]=[m]));for(m=0,v=U*D;m<v;m++)(L=G[m])&&L.length&&(0==(E=L.length)?P[m]=null:(E>d?(Z=(k=S[_=L[E=d]])[0].reduce[6],L.length>E+1&&(Z+=((k=S[_=L[E+1]])[0].reduce[6]-Z)*p)):Z=(k=S[_=L[E-1]])[0].reduce[6],P[m]=Z));for(function e(t,i,r){for(var s,a,n,o,h,l,u=0,c=i-1,d=r-1,p=0,f=r;p<f;p++)for(var g=0,m=i;g<m;g++)if(null===t[p*i+g]){n=g,o=p,(s=g-1)<0&&(s=0),(a=p-1)<0&&(a=0),(h=g+1)>c&&(h=c),(l=p+1)>d&&(l=d);for(var v=[t[a*i+s],t[a*i+n],t[a*i+h],t[o*i+s],t[o*i+h],t[l*i+s],t[l*i+n],t[l*i+h]],y=0,b=0,x=0;x<8;x++)null!==v[x]&&(y++,b+=v[x]);0!=y?t[p*i+g]=b/y:u++}0!=u&&u!=i*r&&e(t,i,r)}(P,U,D),m=A-1;m>=0;m--)if(k=S[m]){Z=(y=k[0]).reduce[6];var V=ys(P,(B=k[5])[0]/f,B[1]/g,U,D);Z>=V?/*!drawAllLabels &&*/k[6]?(B=k[5],O=k[8],M=x?[B[0],B[1]+k[1],y.reduce,w]:null,6==y.type?i.rmap.addLineLabel(y.lastSubJob,M)&&b++:i.rmap.addRectangle(B[0]+O[0],B[1]+O[1],B[0]+O[2],B[1]+O[3],k[7],y.lastSubJob,!0,M)&&b++):y.hysteresis?i.jobHBuffer[y.id]=y:(i.drawnJobs++,6==y.type?s.drawGpuSubJobLineLabel(e,t,i,r,y.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,y.lastSubJob,null)):(k[0].delta=Math.abs(V-Z),C[T]=k,T++)}if(b<u&&T>0)for(function(e,t,i,r){var s,a,n,o=i<65536?e.radixCountBuffer16:e.radixCountBuffer32,h=e.buffUint32,l=e.buffFloat32;if(o.fill)o.fill(0);else for(n=0;n<1024;n++)o[n]=0;for(n=0;n<i;n++)s=t[n],l[0]=s[0].delta,a=h[0],s[0].delta=a,o[255&a]++,o[256+(a>>8&255)]++,o[512+(a>>16&255)]++,o[768+(a>>24&255)]++;for(var u=0;u<4;u++){var c=0,d=0,p=256*u;for(n=0;n<256;n++)c=o[n+p],o[n+p]=d,d+=c}for(n=0;n<i;n++)r[o[255&(a=(s=t[n])[0].delta)]++]=s;for(n=0;n<i;n++)t[o[256+((a=(s=r[n])[0].delta)>>8&255)]++]=s;for(n=0;n<i;n++)r[o[512+((a=(s=t[n])[0].delta)>>16&255)]++]=s;for(n=0;n<i;n++)t[o[768+((a=(s=r[n])[0].delta)>>24&255)]++]=s}(i,C,T,S),m=T-1;m>=0&&(y=(k=C[m])[0],/*!drawAllLabels &&*/k[6]?(B=k[5],O=k[8],M=x?[B[0],B[1]+k[1],y.reduce,w]:null,6==y.type?i.rmap.addLineLabel(y.lastSubJob,M)&&b++:i.rmap.addRectangle(B[0]+O[0],B[1]+O[1],B[0]+O[2],B[1]+O[3],k[7],y.lastSubJob,!0,M)&&b++):y.hysteresis?i.jobHBuffer[y.id]=y:(i.drawnJobs++,6==y.type?s.drawGpuSubJobLineLabel(e,t,i,r,y.lastSubJob,null):s.drawGpuSubJob(e,t,i,r,y.lastSubJob,null)),!(b>=u));m--);}if(i.drawGridCells){e.setState(i.lineLabelState);var j,H,W=0,q=0;for(j=0,H=D;j<H;j++)for(m=0,v=U;m<v;m++){W=f*m,q=g*j;var Z=P[j*U+m];s.drawLineString([[W,q,.5],[W+f,q,.5],[W+f,q+g,.5],[W,q+g,.5]],!0,1,[0,0,255,255],null,!0,null,null,null),Z&&s.drawText(Math.round(W+5),Math.round(q+5),11,""+Z.toFixed(2),[255,255,255,255],.5)}}}},Fs=function(e,t,i,r){var s,a,n,o=i<65536?e.radixCountBuffer16:e.radixCountBuffer32,h=e.buffUint32,l=e.buffFloat32;if(e.config.mapFeaturesReduceFactor,o.fill)o.fill(0);else for(n=0;n<1024;n++)o[n]=0;for(n=0;n<i;n++)a=1-(s=t[n]).lastSubJob[5][2],l[0]=a,a=h[0],s.depth=a,o[255&a]++,o[256+(a>>8&255)]++,o[512+(a>>16&255)]++,o[768+(a>>24&255)]++;for(var u=0;u<4;u++){var c=0,d=0,p=256*u;for(n=0;n<256;n++)c=o[n+p],o[n+p]=d,d+=c}for(n=0;n<i;n++)r[o[255&(a=(s=t[n]).depth)]++]=s;for(n=0;n<i;n++)t[o[256+((a=(s=r[n]).depth)>>8&255)]++]=s;for(n=0;n<i;n++)r[o[512+((a=(s=t[n]).depth)>>16&255)]++]=s;for(n=0;n<i;n++)t[o[768+((a=(s=r[n]).depth)>>24&255)]++]=s;return t},Ls=function(e){this.renderer=e,this.core=e.core,this.gpu=e.gpu,this.gl=e.gpu.gl,this.rmap=e.rmap,this.mBuffer=new Float32Array(16),this.mBuffer2=new Float32Array(16),this.vBuffer=new Float32Array(4)};function Es(e,t,i,r){var s,a,n,o,h,l=e[0],u=e[1],c=e[2],d=e[3],p=t[0],f=t[1],g=t[2],m=t[3];return(a=l*p+u*f+c*g+d*m)<0&&(a=-a,p=-p,f=-f,g=-g,m=-m),1-a>1e-6?(s=Math.acos(a),n=Math.sin(s),o=Math.sin((1-i)*s)/n,h=Math.sin(i*s)/n):(o=1-i,h=i),r[0]=o*l+h*p,r[1]=o*u+h*f,r[2]=o*c+h*g,r[3]=o*d+h*m,r}Ls.prototype.drawSkydome=function(e,t){if(e){var i=this.gpu,r=this.gl,s=this.renderer,a=ws.create();ws.multiply(Ms.scaleMatrix(2,2,2),Ms.translationMatrix(-.5,-.5,-.5),a);var n=ws.create(),o=s.camera.getPosition();ws.multiply(Ms.translationMatrix(o[0],o[1],o[2]-400),Ms.scaleMatrixf(Math.min(.9*s.camera.getFar(),6e5)),n);var h=ws.create();ws.multiply(s.camera.getMvpMatrix(),n,h),ws.multiply(h,a,h),i.useProgram(t,["aPosition","aTexCoord"]),i.bindTexture(e),t.setSampler("uSampler",0),t.setMat4("uMVP",h),r.depthMask(!1),s.skydomeMesh.draw(t,"aPosition","aTexCoord"),r.depthMask(!0),r.enable(r.CULL_FACE),s.renderedPolygons+=s.skydomeMesh.getPolygons()}},Ls.prototype.drawTBall=function(e,t,i,r,s,a){var n=this.gpu,o=(this.gl,this.renderer),h=ws.create();ws.multiply(Ms.scaleMatrix(2,2,2),Ms.translationMatrix(-.5,-.5,-.5),h);var l=[e[0],e[1],e[2]];t=null!=t?t:1.5;var u=ws.create();ws.multiply(Ms.translationMatrix(l[0],l[1],l[2]),Ms.scaleMatrix(t,t,s||t),u);var c=ws.create();ws.multiply(o.camera.getMvpMatrix(),u,c),ws.multiply(c,h,c),n.useProgram(i,["aPosition","aTexCoord"]),n.bindTexture(r||o.redTexture),i.setSampler("uSampler",0),i.setMat4("uMVP",c),o.skydomeMesh.draw(i,"aPosition","aTexCoord"),o.renderedPolygons+=o.skydomeMesh.getPolygons()},Ls.prototype.drawBall=function(e,t,i,r,s,a,n,o,h,l){var u=this.gpu,c=this.gl,d=this.renderer,p=ws.create();ws.multiply(Ms.scaleMatrix(2,2,2),Ms.translationMatrix(-.5,-.5,-.5),p);var f=[e[0],e[1],e[2]],g=ws.create();t=t||1.5,i=i||1.5,ws.multiply(Ms.translationMatrix(f[0],f[1],f[2]),Ms.scaleMatrix(t,t,i),g);var m=ws.create();ws.multiply(d.camera.getModelviewMatrix(),g,m),ws.multiply(m,p,m);var v=d.camera.getProjectionMatrix(),y=[0,0,0,0,0,0,0,0,0];ws.toInverseMat3(m,y),xs.transpose(y),u.useProgram(r,["aPosition"]),r.setMat4("uProj",v),r.setMat4("uMV",m),l&&(r.setMat3("uNorm",y),c.cullFace(c.FRONT)),s&&r.setVec4("uParams",s),a&&r.setVec4("uParams2",a),a&&r.setVec4("uParams3",n),o&&r.setVec4("uFogColor",o),h&&r.setVec4("uFogColor2",h),d.atmoMesh.draw(r,"aPosition",null),d.renderedPolygons+=d.skydomeMesh.getPolygons(),l&&c.cullFace(c.BACK)},Ls.prototype.drawBall2=function(e,t,i,r,s,a){var n=this.gpu,o=this.renderer,h=ws.create();ws.multiply(Ms.scaleMatrix(2,2,2),Ms.translationMatrix(-.5,-.5,-.5),h);var l=[e[0],e[1],e[2]],u=ws.create();ws.multiply(Ms.translationMatrix(l[0],l[1],l[2]),Ms.scaleMatrixf(null!=t?t:1.5),u);var c=ws.create();ws.multiply(o.camera.getModelviewMatrix(),u,c),ws.multiply(c,h,c);var d=o.camera.getProjectionMatrix(),p=[0,0,0,0,0,0,0,0,0];ws.toInverseMat3(c,p),xs.transpose(p),n.useProgram(i,["aPosition"]),n.bindTexture(o.redTexture),i.setSampler("uSampler",0),i.setMat4("uProj",d),i.setMat4("uMV",c),i.setMat3("uNorm",p),i.setFloat("uNFactor",r),i.setVec3("uCenter",e),i.setVec2("uRadius",[t,a]),o.atmoMesh.draw(i,"aPosition",null),o.renderedPolygons+=o.skydomeMesh.getPolygons()},Ls.prototype.drawLineString=function(e,t,i,r,s,a,n,o,h){var l,u,c=this.gpu,d=(this.gl,this.renderer),p=0,f=e.length;if(f>32)for(u=0;u<f;u+=31)l=e.slice(u,u+32),this.drawLineString(l,t,i,r,s,a,n,o,h);else{var g=d.plineBuffer;if(t)for(u=0;u<f;u++)l=e[u],g[p]=l[0],g[p+1]=l[1],g[p+2]=l[2]||0,p+=3;else{d.camera.getMvpMatrix(),d.curSize;var m=d.cameraPosition;for(u=0;u<f;u++)l=e[u],g[p]=l[0]-m[0],g[p+1]=l[1]-m[1],g[p+2]=l[2]-m[2],p+=3}if(!0!==h){var v=c.currentState;c.setState({ztest:!(!0!==a),blend:!0===n,zwrite:!(!1===o),stencil:!1,culling:!1,zequal:!1})}var y=t?d.progLine4:d.progLine5;c.useProgram(y,["aPosition"]),t?y.setMat4("uMVP",d.imageProjectionMatrix,s?d.getZoffsetFactor(s):null):(y.setMat4("uMV",d.camera.getModelviewFMatrix(),null),y.setMat4("uProj",d.camera.getProjectionFMatrix(),null)),y.setVec3("uScale",[2/d.curSize[0],2/d.curSize[1],.5*i]),y.setVec4("uColor",null!=r?r:[1,1,1,1]),y.setVec3("uPoints",g),d.plines.draw(y,"aPosition",f),!0!==h&&c.setState(v)}},Ls.prototype.drawCircle=function(e,t,i,r,s,a,n,o,h){for(var l=[],u=0,c=2*Math.PI/16,d=0;d<16;d++)l[d]=[-Math.sin(u)*t+e[0],Math.cos(u)*t+e[1],e[2]],u+=c;l[16]=[e[0],t+e[1],e[2]],this.drawLineString(l,!0,i,r,s,a,n,o,h)},Ls.prototype.drawImage=function(e,t,i,r,s,a,n,o,h,l,u,c){var d=this.gpu,p=this.gl,f=this.renderer;if(null!=s&&null!=f.imageProjectionMatrix){if(!0!==c){var g=d.currentState;d.setState({ztest:!(!0!==h),blend:!0===l,zwrite:!(!1===u),stencil:!1,culling:!1,zequal:!1})}var m=f.progImage;d.useProgram(m,["aPosition"]),d.bindTexture(s);var v=f.rectVerticesBuffer;p.bindBuffer(p.ARRAY_BUFFER,v),p.vertexAttribPointer(m.getAttribute("aPosition"),v.itemSize,p.FLOAT,!1,0,0);var y=f.rectIndicesBuffer;p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,y),m.setMat4("uProjectionMatrix",f.imageProjectionMatrix),m.setMat4("uData",[e,t,0,0,e+i,t,1,0,e+i,t+r,1,1,e,t+r,0,1]),o&&(n*=1+2*f.getZoffsetFactor(o)),m.setVec4("uColor",null!=a?a:[1,1,1,1]),m.setFloat("uDepth",n),p.drawElements(p.TRIANGLES,y.numItems,p.UNSIGNED_SHORT,0),!0!==c&&d.setState(g)}},Ls.prototype.drawBillboard=function(e,t,i,r,s,a,n,o){var h=this.gpu,l=this.gl,u=this.renderer;if(!0!==o){var c=h.currentState;h.setState({ztest:!(!0!==s),blend:!0===a,zwrite:!(!1===n),stencil:!1,culling:!1,zequal:!1})}var d=u.progImage;h.useProgram(d,["aPosition","aTexCoord"]),h.bindTexture(t),d.setSampler("uSampler",0);var p=u.rectVerticesBuffer;l.bindBuffer(l.ARRAY_BUFFER,p),l.vertexAttribPointer(d.getAttribute("aPosition"),p.itemSize,l.FLOAT,!1,0,0);var f=u.rectIndicesBuffer;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,f),d.setMat4("uProjectionMatrix",e,r?u.getZoffsetFactor(r):null);d.setMat4("uData",[0,0,0,0,1,0,1,0,1,1,1,1,0,1,0,1]),d.setVec4("uColor",null!=i?i:[1,1,1,1]),d.setFloat("uDepth",0),l.drawElements(l.TRIANGLES,f.numItems,l.UNSIGNED_SHORT,0),!0!==o&&h.setState(c)},Ls.prototype.drawFlatImage=function(e,t,i,r,s,a,n,o){var h=this.gpu,l=this.gl,u=this.renderer;if(null!=s&&null!=u.imageProjectionMatrix){var c=u.progImage;h.useProgram(c,["aPosition"]),h.bindTexture(s);var d=u.rectVerticesBuffer;l.bindBuffer(l.ARRAY_BUFFER,d),l.vertexAttribPointer(c.getAttribute("aPosition"),d.itemSize,l.FLOAT,!1,0,0);var p=u.rectIndicesBuffer;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,p),c.setMat4("uProjectionMatrix",u.imageProjectionMatrix),c.setMat4("uData",[e,t,0,0,e+i,t,1,0,e+i,t+r,1,1,e,t+r,0,1]),c.setVec4("uColor",null!=a?a:[1,1,1,1]),c.setFloat("uDepth",null!=n?n:0),l.drawElements(l.TRIANGLES,p.numItems,l.UNSIGNED_SHORT,0)}},Ls.prototype.drawText=function(e,t,i,r,s,a,n){var o=this.gpu,h=this.gl,l=this.renderer;if(null!=l.imageProjectionMatrix){if(!0!==n){var u=o.currentState;o.setState({ztest:!(null==a),blend:!1,zwrite:!(null==a),stencil:!1,culling:!1,zequal:!(null==a)})}var c=l.progImage;o.useProgram(c,["aPosition"]),o.bindTexture(l.textTexture2);var d=l.rectVerticesBuffer;h.bindBuffer(h.ARRAY_BUFFER,d),h.vertexAttribPointer(c.getAttribute("aPosition"),d.itemSize,h.FLOAT,!1,0,0);var p=l.rectIndicesBuffer;h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,p),c.setMat4("uProjectionMatrix",l.imageProjectionMatrix),c.setVec4("uColor",s),c.setFloat("uDepth",null!=a?a:0);var f=i-1,g=i,m=Math.round(.5*i),v=this.getTextSize(i,r)+2,y=0,b=(15&y)<<4,x=y>>4<<4;c.setMat4("uData",[e-2,t-2,b*(1/256),x*(1/128),e-2+v,t-2,(b+15)*(1/256),x*(1/128),e-2+v,t+g+1,(b+15)*(1/256),(x+15)*(1/128),e-2,t+g+1,b*(1/256),(x+15)*(1/128)]),h.drawElements(h.TRIANGLES,p.numItems,h.UNSIGNED_SHORT,0);for(var w=0,M=r.length;w<M;w++){switch(b=(15&(y=r.charCodeAt(w)-32))<<4,x=y>>4<<4,y){case 12:case 14:case 27:case 28:case 64:case 73:case 76:case 84:c.setMat4("uData",[e,t,b*(1/256),x*(1/128),e+m,t,(b+8)*(1/256),x*(1/128),e+m,t+g,(b+8)*(1/256),(x+16)*(1/128),e,t+g,b*(1/256),(x+16)*(1/128)]),e+=m;break;default:c.setMat4("uData",[e,t,b*(1/256),x*(1/128),e+f,t,(b+15)*(1/256),x*(1/128),e+f,t+g,(b+15)*(1/256),(x+16)*(1/128),e,t+g,b*(1/256),(x+16)*(1/128)]),e+=f}h.drawElements(h.TRIANGLES,p.numItems,h.UNSIGNED_SHORT,0)}!0!==n&&o.setState(u)}},Ls.prototype.getTextSize=function(e,t){for(var i=e-1,r=Math.round(.5*e),s=0,a=0,n=t.length;a<n;a++){switch(t.charCodeAt(a)-32){case 12:case 14:case 27:case 28:case 64:case 73:case 76:case 84:s+=r;break;default:s+=i}}return s},Ls.prototype.drawGpuJobs=function(){var e=this.gpu,t=this.gl,i=this.renderer,r=i.config.mapSortHysteresis,s=i.config.mapHysteresisWait;i.geoRenderCounter++,i.totalJobs=0,i.drawnJobs=0,i.jobsTimer4=0,i.jobsTimer3=0,i.jobsTimer2=0,i.jobsTimer1=performance.now(),t.stencilMask(255),t.clear(t.STENCIL_BUFFER_BIT),t.stencilFunc(t.EQUAL,0,255),t.stencilOp(t.KEEP,t.KEEP,t.INCR);var a,n=[1/i.curSize[0],1/i.curSize[1]],o=this.rmap,h=513,l=0,u=i.clearStencilPasses,c=i.jobZBuffer,d=i.jobZBufferSize,p=i.jobZBuffer2,f=i.jobZBuffer2Size,g=i.onlyHitLayers,m=i.onlyAdvancedHitLayers,v=i.geoRenderCounter,y=i.onlyHitLayers,b=i.jobHSortBuffer,x=0;u.length>0&&(h=u[0],l++),this.rmap.counter!=this.renderer.geoRenderCounter&&this.rmap.clear(),i.gmapIndex=0,i.gmapUseVersion=1;for(var w=!1,M=i.frameTime,S=0,A=c.length;S<A;S++){var C,T=d[S],P=f[S],F=c[S],L=p[S];if(i.jobHBuffer={},i.totalJobs+=T,T>0&&S>=h&&(t.clear(t.STENCIL_BUFFER_BIT),u.length>l?(h=u[l],l++):h=513),g)if(m)for(C=0;C<T;C++)F[C].advancedHit&&this.drawGpuJob(e,t,i,F[C],n,!0);else for(C=0;C<T;C++){var E;(E=F[C]).hitable&&(this.drawGpuJob(e,t,i,E,n),E.advancedHit&&(i.advancedPassNeeded=!0))}else for(C=0;C<T;C++)E=F[C],this.drawGpuJob(e,t,i,E,n);if(i.jobsTimer3=performance.now(),i.gmapIndex>0){switch(i.gmapUseVersion){case 1:Ss(e,t,i,n,this);break;case 2:As(e,t,i,n,this);break;case 3:Cs(e,t,i,n,this);break;case 4:Ts(e,t,i,n,this);break;case 5:Ps(e,t,i,n,this)}i.gmapIndex=0}(o.rectanglesCount>0||o.rectangles2Count>0)&&o.processRectangles(e,t,i,n),i.jobsTimer4+=performance.now()-i.jobsTimer3,P=!1;var k=i.jobHBuffer;for(a in k){P=!0;break}for(a in L){P=!0;break}if(P){if(!y)for(a in k)if((E=k[a]).hysteresis&&E.id){var N=L[E.id];N?E==N?N.hysteresisCounter=i.geoRenderCounter:N.hysteresisBackup=E:(E.timerShow=0,E.timerHide=0,E.draw=!1,E.hysteresisCounter=i.geoRenderCounter,L[E.id]=E,f[S]++,w=!0),!0}for(a in L){E=L[a],N=k[a],i.drawnJobs++,y||(N?(isNaN(E.timerShow)&&(E.timerShow=0,E.timerHide=0,E.draw=!1),E.draw?E.timerHide&&(E.draw=!1,E.timerShow=s+E.hysteresis[0]*(1-E.timerHide/E.hysteresis[1])):(E.timerShow+=M,E.timerShow-s>E.hysteresis[0]?(E.draw=!0,E.timerShow=0):w=!0),E.timerHide=0):(E.draw?(E.timerHide+=M,E.timerHide>E.hysteresis[1]?(delete L[a],f[S]--,E.draw=!1,E.timerHide=0):w=!0):E.timerShow&&(E.draw=!0,E.timerHide=E.hysteresis[1]*(1-(E.timerShow-s)/E.hysteresis[0])),E.timerShow=0));var I=E.draw,B=null;if(y||!0!==E.hysteresis[3]||(I?0!=E.timerHide&&(B=E.timerHide/(E.hysteresis[1]+1),B=1-Math.min(1,B)):0!=E.timerShow&&E.timerShow-s>0&&(B=(E.timerShow-s)/(E.hysteresis[0]+1),B=Math.min(1,B),I=!0)),I){if(E.hysteresisCounter!=i.geoRenderCounter&&E.hysteresisBackup){var R=E.hysteresisBackup;L[a]=R,R.timerShow=E.timerShow,R.timerHide=E.timerHide,R.draw=E.draw,E=R}if(E.renderCounter[0][0]!==v&&null!==E.renderCounter[0][0]){E.updatePos=!0;var z=E.renderCounter[0],U=ws.create(),D=ws.create(),_=z[3].bbox,O=i.cameraPosition,G=Ms.translationMatrix(_.min[0]-O[0],_.min[1]-O[1],_.min[2]-O[2]);ws.multiply(i.camera.getModelviewMatrix(),G,D);var V=i.camera.getProjectionMatrix();ws.multiply(V,D,U),E.mv=D,E.mvp=U}if(r)E.fade=B,b[x]=E,x++;else{switch(E.type){case 10:i.viewExtent;if(W=E.vswitch[E.vswitchIndex])for(var j=0,H=(W=W[1]).length;j<H;j++){(q=W[j]).updatePos=E.updatePos,q.mvp=E.mvp,q.mv=E.mv,this.drawGpuSubJob(e,t,i,n,q.lastSubJob,B)}break;case 6:this.drawGpuSubJobLineLabel(e,t,i,n,E.lastSubJob,B);break;default:this.drawGpuSubJob(e,t,i,n,E.lastSubJob,B)}E.updatePos=!1}}E.hysteresisBackup=null}}}if(r&&x)for(Fs(i,b,x,i.gmap2),S=0;S<x;S++){switch((E=b[S]).type){case 10:var W;i.viewExtent;if(W=E.vswitch[E.vswitchIndex])for(j=0,H=(W=W[1]).length;j<H;j++){var q;(q=W[j]).updatePos=E.updatePos,q.mvp=E.mvp,q.mv=E.mv,this.drawGpuSubJob(e,t,i,n,q.lastSubJob,E.fade)}break;case 6:this.drawGpuSubJobLineLabel(e,t,i,n,E.lastSubJob,E.fade);break;default:this.drawGpuSubJob(e,t,i,n,E.lastSubJob,E.fade)}E.updatePos=!1}w&&this.core.markDirty(),i.jobsTimer2=performance.now()},Ls.prototype.clearJobBuffer=function(){for(var e=this.renderer,t=e.jobZBuffer,i=e.jobZBufferSize,r=0,s=t.length;r<s;r++){for(var a=i[r],n=t[r],o=0;o<a;o++)n[o]=null;i[r]=0}},Ls.prototype.clearJobHBuffer=function(){for(var e=this.renderer,t=e.jobZBuffer2,i=e.jobZBuffer2Size,r=0,s=t.length;r<s;r++)t[r]={},i[r]=0},Ls.prototype.paintGL=function(){var e=this.renderer;this.gpu.clear(!0,!1),e.onlyLayers||e.onlyDepth||e.onlyHitLayers||this.drawSkydome()},Ls.prototype.processNoOverlap=function(e,t,i,r,s,a,n,o,h,l,u){var c={exit:!0},d=t.reduce&&t.reduce[0]>=7&&t.reduce[0]<=11;if(!e.drawAllLabels&&t.noOverlap){i||(i=e.project2(t.center2,e.camera.mvp,e.cameraPosition,!0)),c.pp=i;var p=t.noOverlap,f=i[2];if(f<0||f>1)return c;if(6==t.type){if(e.benevolentMargins){if(!e.rmap.checkRectangle(i[0]-200,i[1]-200,i[0]+200,i[1]+200,0))return c}else if(!e.rmap.checkRectangle(i[0],i[1],i[0],i[1],0))return c}else if(!e.rmap.checkRectangle(i[0]+p[0],i[1]+p[1],i[0]+p[2],i[1]+p[3],o))return c;if(null!==p[4]&&(0===p[4]?f=p[5]:(null===n&&(s=t.center2,r=e.cameraPosition,a=[s[0]-r[0],s[1]-r[1],s[2]-r[2]],n=bs.length(a)+1e-4),t.reduce&&(!t.reduce||t.reduce[0]>=8&&t.reduce[0]<=11)||(f=p[5]/n))),t.lastSubJob=[t,o,h,l,u,i,!0,f,p],d)return e.gmapUseVersion=t.reduce[0]>=8&&t.reduce[0]<=11?t.reduce[0]-6:1,e.gmap[e.gmapIndex]=t.lastSubJob,e.gmapIndex++,e.config.mapFeaturesReduceFactor>=1&&(null===n&&(s=t.center2,r=e.cameraPosition,a=[s[0]-r[0],s[1]-r[1],s[2]-r[2]],n=bs.length(a)+1e-4),n>e.fmaxDist&&(e.fmaxDist=n),n<e.fminDist&&(e.fminDist=n),t.reduce[1]=t.reduce[2],t.reduce[4]=n),c;if(6==t.type){if(!e.rmap.addLineLabel(t.lastSubJob))return c}else if(!e.rmap.addRectangle(i[0]+p[0],i[1]+p[1],i[0]+p[2],i[1]+p[3],f,t.lastSubJob))return e.rmap.storeRemovedRectangle(i[0]+p[0],i[1]+p[1],i[0]+p[2],i[1]+p[3],f,t.lastSubJob),c;return c}return d?(i||(i=e.project2(t.center2,e.camera.mvp,e.cameraPosition,!0)),t.lastSubJob=[t,o,h,l,u,i,!1],e.gmapUseVersion=t.reduce[0]>=8&&t.reduce[0]<=11?t.reduce[0]-6:1,e.gmap[e.gmapIndex]=t.lastSubJob,e.gmapIndex++,e.config.mapFeaturesReduceFactor>=1&&(null===n&&(s=t.center2,r=e.cameraPosition,a=[s[0]-r[0],s[1]-r[1],s[2]-r[2]],n=bs.length(a)+1e-4),n>e.fmaxDist&&(e.fmaxDist=n),n<e.fminDist&&(e.fminDist=n),t.reduce[1]=t.reduce[2],t.reduce[4]=n),c.pp=i,c):t.hysteresis&&t.id?(i||(i=e.project2(t.center2,e.camera.mvp,e.cameraPosition,!0)),t.lastSubJob=[t,o,h,l,u,i],e.jobHBuffer[t.id]=t,c.pp=i,c):(c.pp=i,c.exit=!1,c)},Ls.prototype.drawGpuJob=function(e,t,i,r,s,a,n){if(r.ready&&r.eventInfo){var o=255&r.state,h=r.eventInfo["#id"];if(null!=h){if(512&r.state){if(-1!=i.geodataSelection.indexOf(h)){if(768&r.state)if(i.hoverFeature&&i.hoverFeature[0]["#id"]==h){if(3!=o)return}else if(2!=o)return}else if(256&r.state){if(i.hoverFeature&&i.hoverFeature[0]["#id"]==h){if(1!=o)return}else if(0!=o)return}else if(0!=o)return}else if(256&r.state){if(i.hoverFeature&&i.hoverFeature[0]["#id"]==h){if(1!=o)return}else if(0!=o)return}else if(0!=o)return}else if(0!=o)return;var l,u,c,d,p,f,g,m,v=r.mvp,y=r.hitable&&i.onlyHitLayers,b=r.color,x=i.useSuperElevation;if(y){var w=i.hoverFeatureCounter;b=[(255&w)/255,(w>>8&255)/255,0,0],i.hoverFeatureList[w]=[r.eventInfo,r.center,r.clickEvent,r.hoverEvent,r.enterEvent,r.leaveEvent,a],i.hoverFeatureCounter++}switch(r.type){case 1:case 11:11==r.type?y?r.stencil?e.setState(r.culling?i.polygonB0S1C1tate:i.polygonB0S1C0tate):e.setState(r.culling?i.polygonB0S0C1tate:i.polygonB0S0C0tate):r.stencil?e.setState(r.culling?i.polygonB1S1C1tate:i.polygonB1S1C0tate):e.setState(r.culling?i.polygonB1S0C1tate:i.polygonB1S0C0tate):e.setState(y?i.stencilLineHitState:i.stencilLineState);var M=0===e;l=x?a?r.program2:i.progLineSE:a?r.program2:M?i.progLineWireframe:r.program;var S=!a&&11==r.type&&1==r.style;if(S&&(l=x?i.progCFlatShadeTileSE:i.progCFlatShadeTile),e.useProgram(l,a?["aPosition","aElement"]:M?["aPosition","aBarycentric"]:["aPosition"]),x){var A=this.mBuffer,C=i.superElevation;A[0]=r.bbox.min[0],A[1]=r.bbox.min[1],A[2]=r.bbox.min[2],A[3]=1,A[4]=1,A[5]=1,A[9]=C[0],A[10]=C[1],A[11]=C[2],A[12]=C[6],A[13]=C[5],A[14]=i.earthRadius,A[15]=i.earthERatio,l.setMat4("uParamsSE",A)}if(S?(l.setMat4("uMV",r.mv),l.setMat4("uProj",i.camera.getProjectionFMatrix(),i.getZoffsetFactor(r.zbufferOffset)),l.setVec4("uColor",b)):(l.setMat4("uMVP",v,i.getZoffsetFactor(r.zbufferOffset)),l.setVec4("uColor",b)),xe=l.getAttribute("aPosition"),t.bindBuffer(t.ARRAY_BUFFER,r.vertexPositionBuffer),t.vertexAttribPointer(xe,r.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),a&&(g=l.getAttribute("aElement"),t.bindBuffer(t.ARRAY_BUFFER,r.vertexElementBuffer),t.vertexAttribPointer(g,r.vertexElementBuffer.itemSize,t.FLOAT,!1,0,0)),M){var T=l.getAttribute("aBarycentric");t.bindBuffer(t.ARRAY_BUFFER,e.barycentricBuffer),t.vertexAttribPointer(T,e.barycentricBuffer.itemSize,t.FLOAT,!1,0,0)}if(t.drawArrays(t.TRIANGLES,0,r.vertexPositionBuffer.numItems),i.debug.drawPolyWires){var P=x?i.progWireFrameBasicSE:i.progWireFrameBasic;i.gpu.useProgram(P,["aPosition"]),x&&P.setMat4("uParamsSE",A),P.setMat4("uMV",r.mv),P.setVec4("uColor",[0,0,0,1]),P.setMat4("uProj",i.camera.getProjectionFMatrix(),i.getZoffsetFactor(r.zbufferOffset));for(var F=0,L=2*r.vertexPositionBuffer.numItems;F<L;F+=3)t.drawArrays(t.LINE_LOOP,F,3)}break;case 2:case 3:case 4:case 5:e.setState(y?i.stencilLineHitState:i.stencilLineState),l=a?r.program2:r.program,u=null;var E=[0,0,0,0];if(m=s,y&&5==r.type&&(r.widthByRatio&&(m=[s[0]*i.curSize[1],s[1]*i.curSize[1]]),!(l=a?this.renderer.progELine3:this.renderer.progLine3).isReady()))return;if(4!=r.type)if(2==r.type)E=[0,0,0,r.widthByRatio?i.cameraViewExtent:1];else{if(y)u=i.whiteTexture,3!=r.type&&2!=r.type||(E=[0,0,0,r.widthByRatio?i.cameraViewExtent:1]);else{var k=r.texture;if(null==k||null==k[0])return;u=k[0],E=[0,k[1]/k[0].height,(k[1]+k[2])/k[0].height,r.widthByRatio?i.cameraViewExtent:1],3==r.type||2==r.type?r.widthByRatio?E[0]=1/(i.cameraViewExtent2*r.lineWidth)/(u.width/k[2]):E[0]=1/r.lineWidth/(u.width/k[2]):r.widthByRatio?(E[0]=1/(i.cameraViewExtent2/i.curSize[1])/(u.width/k[2]),E[0]/=i.curSize[1]*r.lineWidth*.5,E[3]=i.curSize[1]):(E[0]=1/(i.cameraViewExtent2/i.curSize[1])/(u.width/k[2]),E[0]/=.5*r.lineWidth,E[3]=1)}if(!u.loaded)return;e.bindTexture(u)}else r.widthByRatio&&(m=[s[0]*i.curSize[1],s[1]*i.curSize[1]]);if(x){l=a?r.program2:i.progLine3SE;A=this.mBuffer,C=i.superElevation;A[0]=r.bbox.min[0],A[1]=r.bbox.min[1],A[2]=r.bbox.min[2],A[3]=1,A[4]=1,A[5]=1,A[9]=C[0],A[10]=C[1],A[11]=C[2],A[12]=C[6],A[13]=C[5],A[14]=i.earthRadius,A[15]=i.earthERatio,e.useProgram(l,a?["aPosition","aNormal","aElement"]:["aPosition","aNormal"]),l.setMat4("uParamsSE",A)}else e.useProgram(l,a?["aPosition","aNormal","aElement"]:["aPosition","aNormal"]);l.setVec4("uColor",b),l.setVec2("uScale",m),l.setMat4("uMVP",v,i.getZoffsetFactor(r.zbufferOffset)),4!=r.type&&(null!=r.background&&l.setVec4("uColor2",y?[0,0,0,0]:r.background),l.setVec4("uParams",E),l.setSampler("uSampler",0)),xe=l.getAttribute("aPosition"),p=l.getAttribute("aNormal"),t.bindBuffer(t.ARRAY_BUFFER,r.vertexPositionBuffer),t.vertexAttribPointer(xe,r.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,r.vertexNormalBuffer),t.vertexAttribPointer(p,r.vertexNormalBuffer.itemSize,t.FLOAT,!1,0,0),a&&(g=l.getAttribute("aElement"),t.bindBuffer(t.ARRAY_BUFFER,r.vertexElementBuffer),t.vertexAttribPointer(g,r.vertexElementBuffer.itemSize,t.FLOAT,!1,0,0)),t.drawArrays(t.TRIANGLES,0,r.vertexPositionBuffer.numItems);break;case 6:if((V=r.files).length>0)for(F=0,L=V.length;F<L;F++){if(V[F].length>0)if((q=r.fonts[F])&&!q.areTexturesReady(V[F]))return}else{if(!y)return;u=i.whiteTexture}i.useSuperElevation?r.seCounter!=i.seCounter&&(r.seCounter=i.seCounter,r.labelPointsBuffer.id=-1,r.center2=i.transformPointBySE(r.center)):r.center2=r.center;var N=1.4142*r.outline[2]/20,I=1.4142*r.outline[3]/20;if(r.singleBuffer){var B=null;if(180!=r.culling){if(Y=r.center2,Z=i.cameraPosition,J=[Y[0]-Z[0],Y[1]-Z[1],Y[2]-Z[2]],r.visibility){switch(B=bs.length(J),r.visibility.length){case 1:if(B>r.visibility[0])return;break;case 2:if((K=B*i.localViewExtentFactor)<r.visibility[0]||K>r.visibility[1])return;break;case 4:if(K=B*i.localViewExtentFactor,(X=r.visibility[0]*r.visibility[1])<r.visibility[2]*K||X>r.visibility[3]*K)return}B=1/B,J[0]*=B,J[1]*=B,J[2]*=B}else bs.normalize(J);if(r.normal=[0,0,0],bs.normalize(r.center2,r.normal),(Q=-bs.dot(J,r.normal))<Math.cos(Ms.radians(r.culling)))return}else if(r.visibility)switch(Y=r.center2,Z=i.cameraPosition,J=[Y[0]-Z[0],Y[1]-Z[1],Y[2]-Z[2]],B=bs.length(J),r.visibility.length){case 1:if(B>r.visibility[0])return;break;case 2:if((B*=i.localViewExtentFactor)<r.visibility[0]||B>r.visibility[1])return;break;case 4:if(B*=i.localViewExtentFactor,(X=r.visibility[0]*r.visibility[1])<r.visibility[2]*B||X>r.visibility[3]*B)return}if((c=this.processNoOverlap(i,r,re,Z,Y,J,B,he,u,V,b)).exit)return;return void this.drawGpuSubJobLineLabel(e,t,i,s,[r,0,u,V,b,re])}if(e.setState(y?i.lineLabelHitState:i.lineLabelState),l=i.useSuperElevation?i.progText2SE:r.program,e.useProgram(l,["aPosition","aTexCoord"]),x){A=this.mBuffer,C=i.superElevation;A[0]=r.bbox.min[0],A[1]=r.bbox.min[1],A[2]=r.bbox.min[2],A[3]=1,A[4]=1,A[5]=1,A[9]=C[0],A[10]=C[1],A[11]=C[2],A[12]=C[6],A[13]=C[5],A[14]=i.earthRadius,A[15]=i.earthERatio,l.setMat4("uParamsSE",A)}l.setSampler("uSampler",0),l.setMat4("uMVP",v,i.getZoffsetFactor(r.zbufferOffset)),l.setVec4("uVec",i.labelVector),l.setVec4("uColor",y?b:r.color2),l.setVec2("uParams",[r.outline[0],I]),xe=l.getAttribute("aPosition"),d=l.getAttribute("aTexCoord"),t.bindBuffer(t.ARRAY_BUFFER,r.vertexPositionBuffer),t.vertexAttribPointer(xe,r.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,r.vertexTexcoordBuffer),t.vertexAttribPointer(d,r.vertexTexcoordBuffer.itemSize,t.FLOAT,!1,0,0);for(var R=0;R<(y?1:2);R++)if(1==R&&(l.setVec4("uColor",b),l.setVec2("uParams",[r.outline[1],N])),V.length>0)for(F=0,L=V.length;F<L;F++)for(var z=0,U=(we=V[F]).length;z<U;z++){var D=we[z];l.setFloat("uFile",Math.round(D+1e3*F)),e.bindTexture(r.fonts[F].getTexture(D)),t.drawArrays(t.TRIANGLES,0,r.vertexPositionBuffer.numItems)}else e.bindTexture(u),t.drawArrays(t.TRIANGLES,0,r.vertexPositionBuffer.numItems);break;case 7:case 8:case 9:case 10:if(r.reduce&&!(r.reduce[0]>=7&&r.reduce[0]<=11)){var _,O=r.reduce;if(O[0]>4)if(4==O[0]){if(_=Math.max(O[1],Math.floor(O[2]/Math.max(1,i.drawnGeodataTiles))),r.index>=_)return;O[5]=_}else{if(_=Math.pow(r.texelSize*r.tiltAngle,.5),_=Math.max(O[1],Math.round(O[2]*(_/Math.max(1e-5,this.renderer.drawnGeodataTilesFactor)))),r.index>=_)return;O[5]=_}else{_=r.tiltAngle,1==O[0]?_=1-Math.acos(_)*(1/(.5*Math.PI)):3==O[0]&&(_=.5*(Math.cos(2*Math.acos(_))+1));var G=Math.round(O[1]+_*O[2])-1;if(r.index>G)return;O[5]=G}}var V=r.files;if(10!=r.type)if(9==r.type){for(var j=!1,H=(R=0,r.subjobs.length);R<H;R++){var W=r.subjobs[R];if((V=W.files).length>0)for(F=0,L=V.length;F<L;F++){if(V[F].length>0)(q=W.fonts[F])&&!q.areTexturesReady(V[F])&&(j=!0)}else(u=y?i.whiteTexture:W.texture).loaded||(j=!0)}if(j)return}else if((V=r.files).length>0)for(F=0,L=V.length;F<L;F++){var q;if(V[F].length>0)if((q=r.fonts[F])&&!q.areTexturesReady(V[F]))return}else if(!(u=y?i.whiteTexture:r.texture).loaded)return;var Z,Y,J,K,Q;B=null;if(i.useSuperElevation?r.seCounter!=i.seCounter&&(r.seCounter=i.seCounter,r.center2=i.transformPointBySE(r.center)):r.center2=r.center,180!=r.culling){if(Y=r.center2,Z=i.cameraPosition,J=[Y[0]-Z[0],Y[1]-Z[1],Y[2]-Z[2]],r.visibility){switch(B=bs.length(J),r.visibility.length){case 1:if(B>r.visibility[0])return;break;case 2:if((K=B*i.localViewExtentFactor)<r.visibility[0]||K>r.visibility[1])return;break;case 4:if(K=B*i.localViewExtentFactor,(X=r.visibility[0]*r.visibility[1])<r.visibility[2]*K||X>r.visibility[3]*K)return}B=1/B,J[0]*=B,J[1]*=B,J[2]*=B}else bs.normalize(J);if(r.normal=[0,0,0],bs.normalize(r.center2,r.normal),(Q=-bs.dot(J,r.normal))<Math.cos(Ms.radians(r.culling)))return}else if(r.visibility)switch(Y=r.center2,Z=i.cameraPosition,J=[Y[0]-Z[0],Y[1]-Z[1],Y[2]-Z[2]],B=bs.length(J),r.visibility.length){case 1:if(B>r.visibility[0])return;break;case 2:if((B*=i.localViewExtentFactor)<r.visibility[0]||B>r.visibility[1])return;break;case 4:var X;if(B*=i.localViewExtentFactor,(X=r.visibility[0]*r.visibility[1])<r.visibility[2]*B||X>r.visibility[3]*B)return}if(10==r.type){var $=i.viewExtent,ee=r.vswitch;for(r.vswitchIndex=0,F=0,L=ee.length;F<L;F++)if($<=ee[F][0]||F==L-1){r.vswitchIndex=F;var te=r.vswitch[F];if(te)for(R=0,H=(te=te[1]).length;R<H;R++){var ie=te[R];ie.mv=r.mv,ie.mvp=r.mvp,ie.updatePos=r.updatePos,ie.hysteresis=r.hysteresis,ie.vswitchIndex=F,ie.renderCounter=r.renderCounter,ie.localTilt=Q,ie.id=r.id,this.drawGpuJob(e,t,i,ie,s,a,n)}return}return}var re,se,ae,ne,oe=r.stick,he=0;if(0!=oe[0]){if(ae=i.config.mapFeatureStickMode,ne=oe[0],ae[0]){if(Q||(Q=r.localTilt)||(Y=r.center2,Z=i.cameraPosition,J=[Y[0]-Z[0],Y[1]-Z[1],Y[2]-Z[2]],bs.normalize(J),r.normal=[0,0,0],bs.normalize(r.center2,r.normal),Q=-bs.dot(J,r.normal)),2==ae[0]){var le=i.gridHmax-i.gridHmin;le<0&&(le=0),le<ne&&(ne=le)}Q<0&&(Q=0),he=Math.pow(1-Q,ae[1])*ne*i.cameraTiltFator}else he=i.cameraTiltFator*oe[0];he<oe[1]&&(he=0),0!=oe[0]&&0!=oe[2]&&he>=4&&(he+=oe[7]),(re=i.project2(r.center2,i.camera.mvp,i.cameraPosition))[0]=Math.round(re[0]),re[1]-=he}if((c=this.processNoOverlap(i,r,re,Z,Y,J,B,he,u,V,b)).exit)return;if(re=c.pp,Z=c.p1,Y=c.p2,J=c.camVec,B=c.l,9==r.type)return;if(i.drawLabelBoxes&&(se=r.noOverlap)&&(re||(re=i.project2(r.center2,i.camera.mvp,i.cameraPosition)),e.setState(y?i.lineLabelHitState:i.lineLabelState),this.drawLineString([[re[0]+se[0],re[1]+se[1],.5],[re[0]+se[2],re[1]+se[1],.5],[re[0]+se[2],re[1]+se[3],.5],[re[0]+se[0],re[1]+se[3],.5],[re[0]+se[0],re[1]+se[1],.5]],!0,1,[255,0,0,255],null,!0,null,null,null),r.reduce&&(r.reduce[0]>=10?this.drawText(re[0]+se[0],re[1]+se[3]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,r.reduce[6].toFixed(3)+" "+r.reduce[1].toFixed(2)+" "+r.reduce[3].toFixed(2)+" "+r.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(re[0]+se[0],re[1]+se[3]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,r.reduce[1].toFixed(0)+" "+r.reduce[5].toFixed(0),[1,0,0,1],.5))),e.setState(y?i.lineLabelHitState:i.labelState),0!=oe[0]&&0!=oe[2]&&(re||(re=i.project2(r.center2,i.camera.mvp,i.cameraPosition)),this.drawLineString([[re[0],re[1]+he+oe[7],re[2]],[re[0],re[1]+oe[7],re[2]]],!0,oe[2],[oe[3],oe[4],oe[5],oe[6]],null,null,null,null,!0)),l=r.program,r.singleBuffer){if(re||(re=i.project2(r.center2,i.camera.mvp,i.cameraPosition)),l==i.progIcon){var ue=r.singleBuffer;if(l=i.progImage,!r.singleBuffer2){r.singleBuffer2=new Float32Array(ue);var ce=1/u.width,de=1/u.height;ue[2]*=ce,ue[3]*=de,ue[6]*=ce,ue[7]*=de,ue[10]*=ce,ue[11]*=de,ue[14]*=ce,ue[15]*=de}r.updatePos&&((re=i.project2(r.center2,i.camera.mvp,i.cameraPosition))[1]-=he);var pe=r.singleBuffer2;ue[0]=re[0]+pe[0],ue[1]=re[1]+pe[1],ue[4]=re[0]+pe[4],ue[5]=re[1]+pe[5],ue[8]=re[0]+pe[8],ue[9]=re[1]+pe[9],ue[12]=re[0]+pe[12],ue[13]=re[1]+pe[13],e.useProgram(l,["aPosition"]),e.bindTexture(u);var fe=i.rectVerticesBuffer;t.bindBuffer(t.ARRAY_BUFFER,fe),t.vertexAttribPointer(l.getAttribute("aPosition"),fe.itemSize,t.FLOAT,!1,0,0);var ge=i.rectIndicesBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,ge),l.setMat4("uProjectionMatrix",i.imageProjectionMatrix),l.setMat4("uData",r.singleBuffer),l.setVec4("uColor",b),l.setFloat("uDepth",re[2]*(1+2*i.getZoffsetFactor(r.zbufferOffset))),t.drawElements(t.TRIANGLES,ge.numItems,t.UNSIGNED_SHORT,0)}else{var me,ve=(ue=r.singleBuffer).length,ye=ue.length/4*6,be=r.color2;R=0;ve>384?(me=i.textQuads128,l=i.progLabel128):ve>256?(me=i.textQuads96,l=i.progLabel96):ve>192?(me=i.textQuads64,l=i.progLabel64):ve>128?(me=i.textQuads48,l=i.progLabel48):ve>64?(me=i.textQuads32,l=i.progLabel32):(me=i.textQuads16,l=i.progLabel16),r.updatePos&&((re=i.project2(r.center2,i.camera.mvp,i.cameraPosition))[1]-=he),e.useProgram(l,["aPosition"]),l.setSampler("uSampler",0),l.setMat4("uProjectionMatrix",i.imageProjectionMatrix),l.setVec4("uScale",[s[0],s[1],1,2*he]),l.setVec3("uOrigin",[re[0],re[1],re[2]*(1+2*i.getZoffsetFactor(r.zbufferOffset))]),l.setVec4("uColor",y?b:be),l.setVec2("uParams",[r.outline[0],r.gamma[1]]),H=y?1:2;var xe=l.getAttribute("aPosition");for(l.setVec4("uData",ue),t.bindBuffer(t.ARRAY_BUFFER,me),t.vertexAttribPointer(xe,me.itemSize,t.FLOAT,!1,0,0);R<H;R++){1==R&&(l.setVec4("uColor",b),l.setVec2("uParams",[r.outline[1],r.gamma[0]]));for(F=0,L=V.length;F<L;F++)for(z=0,U=(we=V[F]).length;z<U;z++){D=we[z];l.setFloat("uFile",Math.round(D+1e3*F)),e.bindTexture(r.fonts[F].getTexture(D)),t.drawArrays(t.TRIANGLES,0,ye)}}}return}e.useProgram(l,["aPosition","aTexCoord","aOrigin"]),l.setSampler("uSampler",0),l.setMat4("uMVP",v,i.getZoffsetFactor(r.zbufferOffset)),l.setVec4("uScale",[s[0],s[1],8==r.type?1:1/u.width,2*he]);R=0,H=1;for(l!=i.progIcon?(l.setVec4("uColor",y?b:r.color2),l.setVec2("uParams",[r.outline[0],r.gamma[1]]),H=y?1:2):l.setVec4("uColor",b),xe=l.getAttribute("aPosition"),d=l.getAttribute("aTexCoord"),f=l.getAttribute("aOrigin"),t.bindBuffer(t.ARRAY_BUFFER,r.vertexPositionBuffer),t.vertexAttribPointer(xe,r.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,r.vertexTexcoordBuffer),t.vertexAttribPointer(d,r.vertexTexcoordBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,r.vertexOriginBuffer),t.vertexAttribPointer(f,r.vertexOriginBuffer.itemSize,t.FLOAT,!1,0,0);R<H;R++)if(1==R&&(l.setVec4("uColor",b),l.setVec2("uParams",[r.outline[1],r.gamma[0]])),V.length>0)for(F=0,L=V.length;F<L;F++){var we;for(z=0,U=(we=V[F]).length;z<U;z++){D=we[z];l.setFloat("uFile",Math.round(D+1e3*F)),e.bindTexture(r.fonts[F].getTexture(D)),t.drawArrays(t.TRIANGLES,0,r.vertexPositionBuffer.numItems)}}else e.bindTexture(u),t.drawArrays(t.TRIANGLES,0,r.vertexPositionBuffer.numItems)}}},Ls.prototype.drawGpuSubJob=function(e,t,i,r,s,a){if(s){var n,o,h,l,u=s[0],c=s[1],d=s[2],p=s[3],f=s[4],g=s[5],m=u.stick,v=u.noOverlap;if(i.useSuperElevation?u.seCounter!=i.seCounter&&(u.seCounter=i.seCounter,u.center2=i.transformPointBySE(u.center)):u.center2=u.center,u.hysteresis&&u.id&&0!=m[0]){var y=i.config.mapFeatureStickMode,b=m[0];if(y[0]){if(n||(n=u.localTilt)||(o=u.center2,h=i.cameraPosition,l=[o[0]-h[0],o[1]-h[1],o[2]-h[2]],bs.normalize(l),u.normal=[0,0,0],bs.normalize(u.center2,u.normal),n=-bs.dot(l,u.normal)),2==y[0]){var x=i.gridHmax-i.gridHmin;x<0&&(x=0),x<b&&(b=x)}n<0&&(n=0),c=Math.pow(1-n,y[1])*b*i.cameraTiltFator}else c=i.cameraTiltFator*m[0];c<m[1]&&(c=0),0!=m[0]&&0!=m[2]&&c>=4&&(c+=m[7]),(g=i.project2(u.center2,i.camera.mvp,i.cameraPosition))[0]=Math.round(g[0]),g[1]-=c}var w=u.hitable&&i.onlyHitLayers;if(9!=u.type){i.drawLabelBoxes&&v&&(e.setState(w?i.lineLabelHitState:i.lineLabelState),this.drawLineString([[g[0]+v[0],g[1]+v[1],.5],[g[0]+v[2],g[1]+v[1],.5],[g[0]+v[2],g[1]+v[3],.5],[g[0]+v[0],g[1]+v[3],.5],[g[0]+v[0],g[1]+v[1],.5]],!0,1,[255,0,0,255],null,!0,null,null,null),u.reduce&&(u.reduce[0]>=10?this.drawText(g[0]+v[0],g[1]+v[3]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,u.reduce[6].toFixed(3)+" "+u.reduce[1].toFixed(2)+" "+u.reduce[3].toFixed(2)+" "+u.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(g[0]+v[0],g[1]+v[3]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,u.reduce[1].toFixed(0)+" "+u.reduce[5].toFixed(0),[1,0,0,1],.5))),e.setState(w?i.lineLabelHitState:i.labelState);var M=0,S=1,A=u.color2;null!==a&&(f=[f[0],f[1],f[2],f[3]*a],A&&(A=[A[0],A[1],A[2],A[3]*a])),0!=m[0]&&0!=m[2]&&c>=4&&this.drawLineString([[g[0],g[1]+c+m[7],g[2]],[g[0],g[1]+m[7],g[2]]],!0,m[2],[m[3],m[4],m[5],null!==a?m[6]*a:m[6]],null,null,null,null,!0);var C=u.program;if(u.singleBuffer)if(C==i.progIcon){var T=u.singleBuffer;if(C=i.progImage,!u.singleBuffer2){u.singleBuffer2=new Float32Array(T);var P=1/d.width,F=1/d.height;T[2]*=P,T[3]*=F,T[6]*=P,T[7]*=F,T[10]*=P,T[11]*=F,T[14]*=P,T[15]*=F}u.updatePos&&((g=i.project2(u.center2,i.camera.mvp,i.cameraPosition))[1]-=c);var L=u.singleBuffer2;T[0]=g[0]+L[0],T[1]=g[1]+L[1],T[4]=g[0]+L[4],T[5]=g[1]+L[5],T[8]=g[0]+L[8],T[9]=g[1]+L[9],T[12]=g[0]+L[12],T[13]=g[1]+L[13],e.useProgram(C,["aPosition"]),e.bindTexture(d);var E=i.rectVerticesBuffer;t.bindBuffer(t.ARRAY_BUFFER,E),t.vertexAttribPointer(C.getAttribute("aPosition"),E.itemSize,t.FLOAT,!1,0,0);var k=i.rectIndicesBuffer;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,k),C.setMat4("uProjectionMatrix",i.imageProjectionMatrix),C.setMat4("uData",u.singleBuffer),C.setVec4("uColor",f),C.setFloat("uDepth",g[2]*(1+2*i.getZoffsetFactor(u.zbufferOffset))),t.drawElements(t.TRIANGLES,k.numItems,t.UNSIGNED_SHORT,0)}else{var N,I=(T=u.singleBuffer).length,B=T.length/4*6;I>384?(N=i.textQuads128,C=i.progLabel128):I>256?(N=i.textQuads96,C=i.progLabel96):I>192?(N=i.textQuads64,C=i.progLabel64):I>128?(N=i.textQuads48,C=i.progLabel48):I>64?(N=i.textQuads32,C=i.progLabel32):(N=i.textQuads16,C=i.progLabel16),u.updatePos&&((g=i.project2(u.center2,i.camera.mvp,i.cameraPosition))[1]-=c),e.useProgram(C,["aPosition"]),C.setSampler("uSampler",0),C.setMat4("uProjectionMatrix",i.imageProjectionMatrix),C.setVec4("uScale",[r[0],r[1],1,2*c]),C.setVec3("uOrigin",[g[0],g[1],g[2]*(1+2*i.getZoffsetFactor(u.zbufferOffset))]),C.setVec4("uColor",w?f:A),C.setVec2("uParams",[u.outline[0],u.gamma[1]]),S=w?1:2;var R=C.getAttribute("aPosition");for(C.setVec4("uData",T),t.bindBuffer(t.ARRAY_BUFFER,N),t.vertexAttribPointer(R,N.itemSize,t.FLOAT,!1,0,0);M<S;M++){1==M&&(C.setVec4("uColor",f),C.setVec2("uParams",[u.outline[1],u.gamma[0]]));for(V=0,j=p.length;V<j;V++)for(var z=0,U=(G=p[V]).length;z<U;z++){var D=G[z];C.setFloat("uFile",Math.round(D+1e3*V)),e.bindTexture(u.fonts[V].getTexture(D)),t.drawArrays(t.TRIANGLES,0,B)}}}else{e.useProgram(C,["aPosition","aTexCoord","aOrigin"]),C.setSampler("uSampler",0),C.setMat4("uMVP",u.mvp,i.getZoffsetFactor(u.zbufferOffset)),C.setVec4("uScale",[r[0],r[1],8==u.type?1:1/d.width,2*c]),C!=i.progIcon?(C.setVec4("uColor",w?f:A),C.setVec2("uParams",[u.outline[0],u.gamma[1]]),S=w?1:2):C.setVec4("uColor",f);R=C.getAttribute("aPosition");var _=C.getAttribute("aTexCoord"),O=C.getAttribute("aOrigin");for(t.bindBuffer(t.ARRAY_BUFFER,u.vertexPositionBuffer),t.vertexAttribPointer(R,u.vertexPositionBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,u.vertexTexcoordBuffer),t.vertexAttribPointer(_,u.vertexTexcoordBuffer.itemSize,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,u.vertexOriginBuffer),t.vertexAttribPointer(O,u.vertexOriginBuffer.itemSize,t.FLOAT,!1,0,0);M<S;M++)if(1==M&&(C.setVec4("uColor",f),C.setVec2("uParams",[u.outline[1],u.gamma[0]])),p.length>0)for(V=0,j=p.length;V<j;V++){var G;for(z=0,U=(G=p[V]).length;z<U;z++){D=G[z];C.setFloat("uFile",Math.round(D+1e3*V)),e.bindTexture(u.fonts[V].getTexture(D)),t.drawArrays(t.TRIANGLES,0,u.vertexPositionBuffer.numItems)}}else e.bindTexture(d),t.drawArrays(t.TRIANGLES,0,u.vertexPositionBuffer.numItems)}}else{i.drawLabelBoxes&&v&&(e.setState(w?i.lineLabelHitState:i.lineLabelState),this.drawLineString([[g[0]+v[0],g[1]+v[1],.5],[g[0]+v[2],g[1]+v[1],.5],[g[0]+v[2],g[1]+v[3],.5],[g[0]+v[0],g[1]+v[3],.5],[g[0]+v[0],g[1]+v[1],.5]],!0,1,[255,0,0,255],null,!0,null,null,null),u.reduce&&(u.reduce[0]>=10?this.drawText(g[0]+v[0],g[1]+v[3]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,u.reduce[6].toFixed(3)+" "+u.reduce[1].toFixed(2)+" "+u.reduce[3].toFixed(2)+" "+u.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(g[0]+v[0],g[1]+v[3]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,u.reduce[1].toFixed(0)+" "+u.reduce[5].toFixed(0),[1,0,0,1],.5))),e.setState(w?i.lineLabelHitState:i.labelState),0!=m[0]&&0!=m[2]&&c>=4&&this.drawLineString([[g[0],g[1]+c+m[7],g[2]],[g[0],g[1]+m[7],g[2]]],!0,m[2],[m[3],m[4],m[5],null!==a?m[6]*a:m[6]],null,null,null,null,!0);for(var V=0,j=u.subjobs.length;V<j;V++){var H=u.subjobs[V];H.mvp=u.mvp,H.updatePos=u.updatePos;var W=s[7];v=null,p=H.files,w?(f=s[4],d=i.whiteTexture):(f=H.color,d=H.texture),this.drawGpuSubJob(e,t,i,r,[H,c,d,p,f,g,!0,W,v],a)}}}},Ls.prototype.drawGpuSubJobLineLabel=function(e,t,i,r,s,a){if(s){var n,o=s[0],h=(s[2],s[3]),l=s[4],u=s[5],c=o.noOverlap,d=i.useSuperElevation;d?o.seCounter!=i.seCounter&&(o.seCounter=i.seCounter,o.labelPointsBuffer.id=-1,o.center2=i.transformPointBySE(o.center)):o.center2=o.center;var p,f,g,m=o.hitable&&i.onlyHitLayers,v=1.4142*o.outline[2]/20,y=1.4142*o.outline[3]/20;if(o.singleBuffer){e.setState(m?i.lineLabelHitState:i.lineLabelState),(u=s[5])&&!o.updatePos||(u=i.project2(o.center2,i.camera.mvp,i.cameraPosition,!0));var b=.5*o.labelSize,x=.5*i.camera.scaleFactor2(u[3])*i.curSize[1]*(i.curSize[0]/i.curSize[1]),w=o.labelPoints,M=o.labelIndex,S=0;if((_=w.length)<=1||w[_-1][0]*x<b)return;for(_--,p=0;p<_;p++){var A=w[p+1][0]*x;if(A>b){var C=w[p][0]*x;M=p,S=(b-C)/(A-C);break}}var T,P,F=bs.dot(w[M][1],i.labelVector)>=0?3:2,L=3==F?o.singleBuffer2:o.singleBuffer,E=L.length,k=L.length/4*6,N=w[M][F],I=0,B=w[M+1]?w[M+1][F]:N,R=[0,0,0,0];if(d)if((P=o.labelPointsBuffer).id!=1024*M+F){P.id=1024*M+F,P.points.length!=N.length&&(P.points=new Array(N.length),P.points2=new Array(N.length));var z=P.points,U=P.points2;for(p=0,_=N.length;p<_;p++)z[p]=i.transformPointBySE2(N[p]),U[p]=i.transformPointBySE2(B[p]);N=z,B=U}else N=P.points,B=P.points2;if(!N.length||!B.length)return;for(p=0,_=N.length;p<_;p++)f=N[p],g=B[p],d?(L[I]=f[4]+f[13]+(g[4]+g[13]-(f[4]+f[13]))*S,L[I+1]=f[5]+f[14]+(g[5]+g[14]-(f[5]+f[14]))*S,L[I+2]=f[6]+f[15]+(g[6]+g[15]-(f[6]+f[15]))*S):(L[I]=f[4]+(g[4]-f[4])*S,L[I+1]=f[5]+(g[5]-f[5])*S,L[I+2]=f[6]+(g[6]-f[6])*S),Es([f[7],f[8],f[9],f[10]],[g[7],g[8],g[9],g[10]],S,R),L[I+3]=R[0],L[I+4]=R[1],L[I+5]=R[2],L[I+6]=R[3],L[I+7]=f[11]+(g[11]-f[11])*S,L[I+8]=f[12]+(g[12]-f[12])*S,I+=12;E>384?(T=i.textQuads128,n=i.progLineLabel128):E>256?(T=i.textQuads96,n=i.progLineLabel96):E>192?(T=i.textQuads64,n=i.progLineLabel64):E>128?(T=i.textQuads48,n=i.progLineLabel48):E>64?(T=i.textQuads32,n=i.progLineLabel32):(T=i.textQuads16,n=i.progLineLabel16);var D=o.color2;null!==a&&(l=[l[0],l[1],l[2],l[3]*a],D&&(D=[D[0],D[1],D[2],D[3]*a])),e.useProgram(n,["aPosition"]),n.setSampler("uSampler",0),n.setMat4("uMVP",o.mvp,i.getZoffsetFactor(o.zbufferOffset)),n.setVec4("uColor",m?l:D),n.setVec2("uParams",[o.outline[0],y]);var _=m?1:2,O=n.getAttribute("aPosition");for(n.setVec4("uData",L),t.bindBuffer(t.ARRAY_BUFFER,T),t.vertexAttribPointer(O,T.itemSize,t.FLOAT,!1,0,0),p=0,_=m?1:2;p<_;p++){1==p&&(n.setVec4("uColor",l),n.setVec2("uParams",[o.outline[1],v]));for(var G=0,V=h.length;G<V;G++)for(var j=h[G],H=0,W=j.length;H<W;H++){var q=j[H];n.setFloat("uFile",Math.round(q+1e3*G)),e.bindTexture(o.fonts[G].getTexture(q)),t.drawArrays(t.TRIANGLES,0,k/3)}}if(i.drawLabelBoxes){var Z,Y=c?c[0]:1;u=[0,0,0];for(p=0,_=N.length;p<_;p++)f=N[p],g=B[p],u[0]=f[0]+(g[0]-f[0])*S,u[1]=f[1]+(g[1]-f[1])*S,u[2]=f[2]+(g[2]-f[2])*S,Z=f[3]+(g[3]-f[3])*S,u=i.project2(u,i.camera.mvp,i.cameraPosition,!0),this.drawCircle(u,Z*x*Y,1,[255,0,255,255],null,null,null,null,null);(u=s[5])||(u=i.project2(o.center2,i.camera.mvp,i.cameraPosition,!0)),this.drawCircle(u,8,1,[255,255,0,255],null,null,null,null,null),o.reduce&&(o.reduce[0]>=10?this.drawText(u[0],u[1]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,o.reduce[6].toFixed(3)+" "+o.reduce[1].toFixed(2)+" "+o.reduce[3].toFixed(2)+" "+o.reduce[7].toFixed(0),[1,0,0,1],.5):this.drawText(u[0],u[1]-4*i.debug.debugTextSize,4*i.debug.debugTextSize,o.reduce[1].toFixed(0)+" "+o.reduce[5].toFixed(0),[1,0,0,1],.5))}}else;}};var ks=Ls,Ns=s.d,Is=function(e,t,i){this.renderer=e,this.drawAllLabels=!1,this.maxBlockRectangles=i||500,this.blockSize=t,this.blockSizeFactor=1/t,this.blocks=[],this.blocks2=[],this.blocksRCount=[],this.blocks2RCount=[],this.allocatedBlocks=0,this.lx=1,this.ly=1,this.counter=0,this.rectangles=null,this.rectanglesCount=0,this.rectangles2=null,this.rectangles2Count=0,this.rectanglesR=null,this.rectanglesRCount=0,this.benevolentMargins=!1,this.positionsBuffer=new Float64Array(1024)};Is.prototype.clear=function(){var e=this.renderer;this.sx2=e.curSize[0],this.sy2=e.curSize[1],this.sy2=Math.max(1,this.sy2-55),this.sy1=1,this.sx1=1,this.cx2=135,this.cy1=e.curSize[1]-145,this.bx2=245,this.by2=45,this.lx=Math.floor(e.curSize[0]*this.blockSizeFactor)+1,this.ly=Math.floor(e.curSize[1]*this.blockSizeFactor)+1,4096&e.marginFlags&&(this.sx1=Math.min(34,this.sx2),this.sx2=Math.max(1,e.curSize[0]-34),this.sy1=Math.min(50,this.sy2),this.sy2=Math.max(1,e.curSize[1]-68));var t=this.ly*this.lx;if(this.rectangles||(this.rectangles=new Array(t*this.maxBlockRectangles*6)),this.rectangles2||(this.rectangles2=new Array(t*this.maxBlockRectangles*6)),this.rectanglesR||(this.rectanglesR=new Array(t*this.maxBlockRectangles*6)),this.rectanglesCount>0||this.allocatedBlocks!=t)for(var i=0;i<t;i++)this.blocks[i]||(this.blocks[i]=[]),this.blocksRCount[i]=0;if(this.rectangles2Count>0||this.allocatedBlocks!=t)for(i=0;i<t;i++)this.blocks2[i]||(this.blocks2[i]=[]),this.blocks2RCount[i]=0;this.allocatedBlocks=t,this.drawAllLabels=e.debug.drawAllLabels,this.benevolentMargins=e.benevolentMargins,this.rectanglesCount=0,this.rectangles2Count=0,this.rectanglesRCount=0,this.counter=e.geoRenderCounter},Is.prototype.storeRemovedRectangle=function(e,t,i,r,s,a){var n=this.rectanglesR,o=this.rectanglesRCount;n[o]=e,n[o+1]=t,n[o+2]=i,n[o+3]=r,n[o+4]=s,n[o+5]=a,this.rectanglesRCount+=6},Is.prototype.circleAABBoxCollide=function(e,t,i,r,s,a,n){var o=.5*(i-e),h=.5*(r-t),l=Math.abs(s-e-o),u=Math.abs(a-r-h);if(l>o+n||u>h+n)return!1;if(l<=o||u<=h)return!0;var c=l-o,d=u-h;return c*c+d*d<=n*n},Is.prototype.lineAABBoxCollide=function(e,t,i,r,s,a,n,o){var h=1/(n!=s?n-s:1e-5),l=(e-s)*h,u=(i-s)*h,c=Math.min(l,u),d=Math.max(l,u),p=1/(o!=a?o-a:1e-5),f=(t-a)*p,g=(r-a)*p;return c=Math.max(c,Math.min(f,g)),(d=Math.min(d,Math.max(f,g)))>=c},Is.prototype.checkRectangle=function(e,t,i,r,s){var a;return e>i&&(a=e,e=i,i=a),t>r&&(a=t,t=r,r=a),s+=r,this.benevolentMargins?!(i<this.sx1||e>this.sx2||s<this.sy1||t>this.sy2):!(e<this.sx1||i>this.sx2||t<this.sy1||s>this.sy2)&&(!(1&this.renderer.marginFlags&&e<this.cx2&&i>0&&t<=this.sx2&&s>this.cy1)&&!(2&this.renderer.marginFlags&&e<this.bx2&&i>0&&t<=this.by2&&s>0))},Is.prototype.addRectangle=function(e,t,i,r,s,a,n,o){var h,l,u,c,d,p,f,g,m=this.renderer;if(this.drawAllLabels)return!0;e>i&&(g=e,e=i,i=g),t>r&&(g=t,t=r,r=g);var v=r+a[1];if(this.benevolentMargins){if(i<this.sx1||e>this.sx2||v<this.sy1||t>this.sy2)return!1}else{if(e<this.sx1||i>this.sx2||t<this.sy1||v>this.sy2)return!1;if(1&m.marginFlags&&e<this.cx2&&i>0&&t<=this.sx2&&v>this.cy1)return!1;if(2&m.marginFlags&&e<this.bx2&&i>0&&t<=this.by2&&v>0)return!1}var y=Math.floor(e*this.blockSizeFactor),b=Math.floor(t*this.blockSizeFactor),x=Math.floor(i*this.blockSizeFactor),w=Math.floor(r*this.blockSizeFactor);if(x<0||w<0||y>=this.lx||b>=this.ly)return!1;y<0&&(y=0),x>=this.lx&&(x=this.lx-1),b<0&&(b=0),w>=this.ly&&(w=this.ly-1);var M=x-y+1,S=w-b+1,A={},C=m.config.mapFeaturesSortByTop,T=this.rectangles,P=this.rectangles2;for(l=0;l<S;l++)for(h=0;h<M;h++){for(c=(b+l)*this.lx+(y+h),d=this.blocks[c],p=this.blocksRCount[c],u=0;u<p;u++)if(e<T[(f=d[u])+2]&&i>T[f+0]&&t<T[f+3]&&r>T[f+1]){if(n)return!1;if(C){if(s<T[f+4])return!1}else if(s>T[f+4])return!1;A[f]=!0}if(p+1>=this.maxBlockRectangles)return!1;for(d=this.blocks2[c],p=this.blocks2RCount[c],u=0;u<p;u++)if(f=d[u],this.circleAABBoxCollide(e,t,i,r,P[f+0],P[f+1],T[f+3]))return!1}for(var F in A)this.removeRectangle(parseInt(F));if(o){var L=o[2],E=m.mapHack.getScreenDepth(o[0],o[1],L[4]>1e7);if(E[0]){var k=E[1]-L[4];if(L[7]=k,!m.drawHiddenLabels&&k<o[3])return!1}}for(T[f=this.rectanglesCount]=e,T[f+1]=t,T[f+2]=i,T[f+3]=r,T[f+4]=s,T[f+5]=a,this.rectanglesCount+=6,l=0;l<S;l++)for(h=0;h<M;h++)c=(b+l)*this.lx+(y+h),this.blocks[c][this.blocksRCount[c]]=f,this.blocksRCount[c]++;return!0},Is.prototype.addLineLabel=function(e,t){var i,r,s,a,n,o,h,l,u,c,d=e[0],p=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,g=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,v=0,y=this.renderer,b=[0,0,0,0],x=this.positionsBuffer,w=0,M=0,S=d.noOverlap?d.noOverlap[0]:1,A=.5*d.labelSize,C=.5*y.camera.scaleFactor2(e[5][3])*y.curSize[1]*(y.curSize[0]/y.curSize[1]),T=e[9],P=d.labelPoints,F=d.labelIndex,L=0;if(!((c=P.length)<=1||P[c-1][0]*C<A)){for(c--,u=0;u<c;u++){var E=P[u+1][0]*C;if(E>A){var k=P[u][0]*C;F=u,L=(A-k)/(E-k);break}}T=Ns.dot(P[F][1],y.labelVector)>=0?3:2;var N,I,B,R=P[F][T],z=P[F+1]?P[F+1][T]:R,U=this.benevolentMargins;if(y.useSuperElevation)if((B=d.labelPointsBuffer).id!=1024*F+T){B.id=1024*F+T,B.points.length!=R.length&&(B.points=new Array(R.length),B.points2=new Array(R.length));var D=B.points,_=B.points2;for(u=0,c=R.length;u<c;u++)D[u]=y.transformPointBySE2(R[u]),_[u]=y.transformPointBySE2(z[u]);R=D,z=_}else R=B.points,z=B.points2;if(!R.length||!z.length)return!1;for(u=0,c=R.length;u<c;u++)N=R[u],I=z[u],b[0]=N[0]+(I[0]-N[0])*L,b[1]=N[1]+(I[1]-N[1])*L,b[2]=N[2]+(I[2]-N[2])*L,o=(N[3]+(I[3]-N[3])*L)*C*S,(b=y.project2(b,y.camera.mvp,y.cameraPosition,!0))[0]>f&&(f=b[0]),b[1]>m&&(m=b[1]),b[0]<p&&(p=b[0]),b[1]<g&&(g=b[1]),x[M]=b[0],x[M+1]=b[1],x[M+2]=b[2],x[M+3]=o,o>v&&(v=o),M+=4;if(p-=v,f+=v,g-=v,m+=v,U){if(f<this.sx1||p>this.sx2||m<this.sy1||g>this.sy2)return!1}else{if(p<this.sx1||f>this.sx2||g<this.sy1||m>this.sy2)return!1;if(1&y.marginFlags&&p<this.cx2&&f>0&&g<=this.sx2&&m>this.cy1)return!1;if(2&y.marginFlags&&p<this.bx2&&f>0&&g<=this.by2&&m>0)return!1}var O,G,V,j,H,W,q,Z=this.blockSizeFactor,Y=this.lx,J=this.ly,K=(y.config.mapFeaturesSortByTop,this.rectangles),Q=this.rectangles2;for(M=0,u=0,c=R.length;u<c;u++){if(h=x[M],l=x[M+1],o=x[M+3],O=Math.floor((h-o)*Z),G=Math.floor((l-o)*Z),V=Math.floor((h+o)*Z),j=Math.floor((l+o)*Z),U){if(V<0||O>=Y||j<0||G>=J){M+=4;continue}O<0&&(O=0),G<0&&(G=0),V>=Y&&(V=Y-1),j>=J&&(j=J-1)}var X=V-O+1,$=j-G+1;for(n=0;n<$;n++)for(a=0;a<X;a++){for(w=(G+n)*Y+(O+a),i=this.blocks[w],r=this.blocksRCount[w],q=0;q<r;q++)if(s=i[q],this.circleAABBoxCollide(p,g,f,m,K[s+0],K[s+1],K[s+2]))return!1;for(i=this.blocks2[w],r=this.blocks2RCount[w],q=0;q<r;q++)if((H=h-Q[(s=i[q])+0])*H+(W=l-Q[s+1])*W<(v=Q[s+2]+o)*v)return!1}M+=4}for(M=0,u=0,c=R.length;u<c;u++){if(h=x[M],l=x[M+1],o=x[M+3],O=Math.floor((h-o)*Z),G=Math.floor((l-o)*Z),V=Math.floor((h+o)*Z),j=Math.floor((l+o)*Z),U){if(V<0||O>=Y||j<0||G>=J){M+=4;continue}O<0&&(O=0),G<0&&(G=0),V>=Y&&(V=Y-1),j>=J&&(j=J-1)}X=V-O+1,$=j-G+1;for(Q[s=this.rectangles2Count]=h,Q[s+1]=l,Q[s+2]=o,Q[s+3]=e,this.rectangles2Count+=4,n=0;n<$;n++)for(a=0;a<X;a++)w=(G+n)*this.lx+(O+a),this.blocks2[w][this.blocks2RCount[w]]=s,this.blocks2RCount[w]++;M+=4}return!0}},Is.prototype.removeRectangle=function(e){var t,i,r,s,a,n,o,h,l,u,c=this.rectangles;t=c[e],i=c[e+1],r=c[e+2],s=c[e+3];var d=this.rectanglesR,p=this.rectanglesRCount;d[p]=t,d[p+1]=i,d[p+2]=r,d[p+3]=s,d[p+4]=c[e+4],d[p+5]=c[e+5],this.rectanglesRCount+=6,c[e+5]=null;var f=Math.floor(t*this.blockSizeFactor),g=Math.floor(i*this.blockSizeFactor),m=Math.floor(r*this.blockSizeFactor),v=Math.floor(s*this.blockSizeFactor);f<0&&(f=0),m>=this.lx&&(m=this.lx-1),g<0&&(g=0),v>=this.ly&&(v=this.ly-1);var y=m-f+1,b=v-g+1;for(n=0;n<b;n++)for(a=0;a<y;a++)for(h=(g+n)*this.lx+(f+a),l=this.blocks[h],u=this.blocksRCount[h],o=0;o<u;o++)if(l[o]==e){l[o]=l[u-1],this.blocksRCount[h]--;break}},Is.prototype.processRectangles=function(e,t,i,r){for(var s=this.rectangles,a=this.rectangles2,n=this.rectanglesR,o=i.draw,h=0,l=this.rectanglesRCount;h<l;h+=6){var u=n[h],c=n[h+1],d=n[h+2],p=n[h+3],f=n[h+4],g=n[h+5];this.addRectangle(u,c,d,p,f,g)}for(this.rectanglesRCount=0,h=0,l=this.rectanglesCount;h<l;h+=6){(g=s[h+5])&&(g[0].hysteresis?i.jobHBuffer[g[0].id]=g[0]:(i.drawnJobs++,o.drawGpuSubJob(e,t,i,r,g,null)))}for(h=0,l=this.rectangles2Count;h<l;h+=4){if(g=a[h+3]){var m=g[0];m.hysteresis?i.jobHBuffer[m.id]=m:(i.drawnJobs++,o.drawGpuSubJobLineLabel(e,t,i,r,g,null));var v=m.labelPoints[0][2].length;v>0&&(h+=4*(v-1))}}this.clear()};var Bs=Is,Rs=s.d,zs=s.b,Us=jr,Ds=c,_s=Zr,Os=$r,Gs=fs,Vs=ks,js=Bs,Hs=function(e,t,i,r,s){this.config=s||{},this.core=e,this.marginFlags=0,this.progTile=null,this.progHeightmap=null,this.progSkydome=null,this.progWireframeTile=null,this.progWireframeTile2=null,this.progText=null,this.div=t,this.onUpdate=i,this.killed=!1,this.onlyDepth=!1,this.onlyLayers=!1,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1,this.hitmapCounter=0,this.geoRenderCounter=0,this.geoHitmapCounter=0,this.frameTime=0,this.geometries={},this.clearStencilPasses=[],this.onResizeCall=r,this.stencilLineState=null,this.drawLabelBoxes=!1,this.drawGridCells=!1,this.drawAllLabels=!1,this.debug={},this.mapHack=null,this.geodataSelection=[],this.hoverFeatureCounter=0,this.hoverFeatureList=[],this.touchSurfaceEvent=[];var a=this.div.getBoundingClientRect();this.winSize=[a.width,a.height],this.curSize=[a.width,a.height],this.oldSize=[a.width,a.height],this.dirty=!0,this.cameraVector=[0,1,0],this.viewExtent=1,this.gpu=new Us(this,t,this.curSize,this.config.rendererAllowScreenshots,this.config.rendererAntialiasing,this.config.rendererAnisotropic),this.camera=new Os(this,45,2,12e5),this.drawTileMatrix=zs.create(),this.drawTileMatrix2=zs.create(),this.drawTileVec=[0,0,0],this.drawTileWorldMatrix=zs.create(),this.pixelTileSizeMatrix=zs.create(),this.heightmapMesh=null,this.heightmapTexture=null,this.skydomeMesh=null,this.skydomeTexture=null,this.hitmapTexture=null,this.geoHitmapTexture=null,this.hitmapSize=this.config.mapDMapSize,this.hitmapMode=this.config.mapDMapMode,this.updateHitmap=!0,this.updateGeoHitmap=!0,this.redTexture=null,this.rectVerticesBuffer=null,this.rectIndicesBuffer=null,this.imageProjectionMatrix=null,this.font=null,this.fonts={},this.fogDensity=0,this.gmap=new Array(2048),this.gmap2=new Array(2048),this.gmap3=new Array(1e4),this.gmap3Size=new Array(1e4),this.gmap4=new Array(1e4),this.gmapIndex=0,this.gmapTop=new Array(512),this.gmapHit=new Array(512),this.gmapStore=new Array(512),this.fmaxDist=0,this.fminDist=0,this.jobZBuffer=new Array(512),this.jobZBufferSize=new Array(512),this.jobZBuffer2=new Array(512),this.jobZBuffer2Size=new Array(512),this.jobHBuffer={},this.jobHBufferSize=0,this.jobHSortBuffer=new Array(2048);for(var n=0,o=this.jobZBuffer.length;n<o;n++)this.jobZBuffer[n]=[],this.jobZBufferSize[n]=0,this.jobZBuffer2[n]={},this.jobZBuffer2Size[n]=0;for(n=0,o=this.gmap3.length;n<o;n++)this.gmap3[n]=[],this.gmap3Size[n]=0;this.radixCountBuffer16=new Uint16Array(1024),this.radixCountBuffer32=new Uint32Array(1024),this.buffFloat32=new Float32Array(1),this.buffUint32=new Uint32Array(this.buffFloat32.buffer),this.layerGroupVisible=[],this.bitmaps={},this.cameraPosition=[0,0,0],this.cameraOrientation=[0,0,0],this.cameraTiltFator=1,this.cameraViewExtent=1,this.distanceFactor=1,this.tiltFactor=1,this.localViewExtentFactor=1,this.cameraVector=[0,0,0],this.labelVector=[0,0,0],this.drawnGeodataTiles=0,this.drawnGeodataTilesFactor=0,this.drawnGeodataTilesUsed=!1,this.progMap={},this.gridHmax=0,this.gridHmin=0,this.seCounter=0,this.updateCameraMatrix=zs.create(),this.seTmpVec=[0,0,0],this.seTmpVec2=[0,0,0],this.seTmpVec3=[0,0,0],this.lastHitPosition=[0,0,100],this.logTilePos=null,this.setSuperElevation(0,2,4e3,1.5),window.addEventListener("resize",this.onResize.bind(this),!1),this.gpu.init(),this.init=new Gs(this),this.rmap=new js(this,50),this.draw=new Vs(this);this.resizeGL(Math.floor(1*this.curSize[0]),Math.floor(1*this.curSize[1]))};Hs.prototype.initProceduralShaders=function(){this.init.initProceduralShaders()},Hs.prototype.onResize=function(){if(!this.killed){var e=this.div.getBoundingClientRect();this.resizeGL(Math.floor(e.width),Math.floor(e.height)),this.onResizeCall&&this.onResizeCall()}},Hs.prototype.kill=function(){this.killed||(this.killed=!0,this.heightmapMesh&&this.heightmapMesh.kill(),this.heightmapTexture&&this.heightmapTexture.kill(),this.skydomeMesh&&this.skydomeMesh.kill(),this.skydomeTexture&&this.skydomeTexture.kill(),this.hitmapTexture&&this.hitmapTexture.kill(),this.geoHitmapTexture&&this.geoHitmapTexture.kill(),this.redTexture&&this.redTexture.kill(),this.whiteTexture&&this.whiteTexture.kill(),this.blackTexture&&this.blackTexture.kill(),this.lineTexture&&this.lineTexture.kill(),this.textTexture2&&this.textTexture2.kill(),this.atmoMesh&&this.atmoMesh.kill(),this.bboxMesh&&this.bboxMesh.kill(),this.font&&this.font.kill(),this.plines&&this.plines.kill(),this.plineJoints&&this.plineJoints.kill(),this.gpu.kill())},Hs.prototype.resizeGL=function(e,t,i,r){this.camera.setAspect(e/t),this.curSize=[e,t],this.oldSize=[e,t],this.gpu.resize(this.curSize,i);var s=new Float32Array(16);s[0]=2/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2/t,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=.5*-e*s[0],s[13]=.5*-t*s[5],s[14]=0,s[15]=1,this.imageProjectionMatrix=s},Hs.prototype.project2=function(e,t,i,r){var s=[0,0,0,1];if(0!=(s=i?zs.multiplyVec4(t,[e[0]-i[0],e[1]-i[1],e[2]-i[2],1]):zs.multiplyVec4(t,[e[0],e[1],e[2],1]))[3]){var a=[0,0,0];return a[0]=.5*(s[0]/s[3]+1)*this.curSize[0],a[1]=.5*(-s[1]/s[3]+1)*this.curSize[1],a[2]=s[2]/s[3],r&&(a[3]=s[2]),a}return[0,0,0]},Hs.prototype.setSuperElevationState=function(e){this.useSuperElevation!=e&&(this.useSuperElevation=e,this.seCounter++)},Hs.prototype.getSuperElevationState=function(){return this.useSuperElevation},Hs.prototype.setSuperElevation=function(e,t,i,r){if(1==t&&1==r)return 0!=this.useSuperElevation&&(this.useSuperElevation=!1,this.seCounter++),e==i&&(i=e+1),void(this.superElevation=[e,t,i,r,i-e,r-t,1/(i-e)]);e==i&&(i=e+1),this.superElevation=[e,t,i,r,i-e,r-t,1/(i-e)],this.seCounter++},Hs.prototype.getSuperElevation=function(){return this.superElevation.slice()},Hs.prototype.getSuperElevatedHeight=function(e){var t=this.superElevation,i=e;return i<t[0]&&(i=t[0]),i>t[2]&&(i=t[2]),e*(t[1]+(i-t[0])*t[6]*t[5])},Hs.prototype.getUnsuperElevatedHeight=function(e){var t=this.superElevation,i=e;if(t[1]==t[3])return i/t[1];if(i<=t[0]*t[1])return i/t[1];if(i>=t[2]*t[3])return i/t[3];var r=t[0],s=t[1],a=t[2],n=t[3];return-(Math.sqrt(-2*n*(s*r*a+2*r*i-2*a*i)+s*(s*a*a+4*r*i-4*a*i)+n*n*r*r)-s*a+n*r)/(2*(s-n))},Hs.prototype.getEllipsoidHeight=function(e,t){var i,r;return this.seTmpVec3=[0,0,0],t?(i=this.seTmpVec,r=[e[0]+t[0],e[1]+t[1],(e[2]+t[2])*this.earthERatio]):r=[(i=e)[0],i[1],i[2]*this.earthERatio],Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2])-this.earthRadius},Hs.prototype.transformPointBySE=function(e,t){var i,r=e;this.seTmpVec3=[0,0,0],i=t?[e[0]+t[0],e[1]+t[1],(e[2]+t[2])*this.earthERatio]:[r[0],r[1],r[2]*this.earthERatio];var s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),a=this.seTmpVec2,n=1/(s+1e-4);a[0]=i[0]*n,a[1]=i[1]*n,a[2]=i[2]*n;var o=s-this.earthRadius;return n=this.getSuperElevatedHeight(o)-o,i[0]=r[0]+a[0]*n,i[1]=r[1]+a[1]*n,i[2]=r[2]+a[2]*n,i},Hs.prototype.transformPointBySE2=function(e,t){var i,r=e;this.seTmpVec3=[0,0,0],i=t?[e[0]+t[0],e[1]+t[1],(e[2]+t[2])*this.earthERatio]:[r[0],r[1],r[2]*this.earthERatio];var s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),a=this.seTmpVec2,n=1/(s+1e-4);a[0]=i[0]*n,a[1]=i[1]*n,a[2]=i[2]*n;var o=s-this.earthRadius;return n=this.getSuperElevatedHeight(o)-o,(e=e.slice())[0]=r[0]+a[0]*n,e[1]=r[1]+a[1]*n,e[2]=r[2]+a[2]*n,e[13]=a[0]*n,e[14]=a[1]*n,e[15]=a[2]*n,e},Hs.prototype.project=function(e){var t,i=this.camera.getMvpMatrix(),r=this.camera.getPosition(),s=this.cameraPosition(),a=[e[0]-s[0]+r[0],e[1]-s[1]+r[1],e[2]-s[2]+r[2],1];if(0!=(t=zs.multiplyVec4(i,a))[3]){var n=[0,0,0];return n[0]=.5*(t[0]/t[3]+1)*this.curSize[0],n[1]=.5*(-t[1]/t[3]+1)*this.curSize[1],n[2]=t[2]/t[3],n}return[0,0,0]},Hs.prototype.getScreenRay=function(e,t){if(null==this.camera)return[0,0,1];this.camera.dirty=!0;var i=[2*e/this.curSize[0]-1,1-2*t/this.curSize[1],1],r=[i[0],i[1],-1,1],s=zs.create();s=zs.inverse(this.camera.getProjectionMatrix());var a=[0,0,0,0];zs.multiplyVec4(s,r,a),a[2]=-1,a[3]=0;var n=zs.create();n=zs.inverse(this.camera.getModelviewMatrix());var o=[0,0,0,0];return zs.multiplyVec4(n,a,o),o=Rs.normalize([o[0],o[1],o[2]])},Hs.prototype.hitTestGeoLayers=function(e,t,i){this.gpu.gl;var r,s=!1;if(e>=0&&e<this.curSize[0]&&t>=0&&t<this.curSize[1]){var a,n;a=Math.floor(e*(this.hitmapSize/this.curSize[0])),n=Math.floor(t*(this.hitmapSize/this.curSize[1])),s=!(255==(r=i?this.geoHitmapTexture2.readFramebufferPixels(a,this.hitmapSize-n-1,1,1):this.geoHitmapTexture.readFramebufferPixels(a,this.hitmapSize-n-1,1,1))[0]&&255==r[1]&&255==r[2]&&255==r[3])}return s?[!0,r[0],r[1],r[2],r[3]]:[!1,0,0,0,0]},Hs.prototype.switchToFramebuffer=function(e,t){var i,r,s,a=this.gpu.gl;switch(e){case"base":r=this.oldSize[0],s=this.oldSize[1],a.clearColor(0,0,0,1),a.viewport(0,0,r,s),this.gpu.setFramebuffer(null),this.camera.setAspect(r/s),this.curSize=[r,s],this.gpu.resize(this.curSize,!0),this.camera.update(),this.onlyDepth=!1,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1;break;case"depth":this.gpu.setFramebuffer(this.hitmapTexture),this.oldSize=[this.curSize[0],this.curSize[1]],a.clearColor(1,1,1,1),a.enable(a.DEPTH_TEST),i=this.hitmapSize,a.viewport(0,0,i,i),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.curSize=[i,i],this.camera.update(),this.onlyDepth=!0,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1;break;case"geo":case"geo2":this.hoverFeatureCounter=0,i=this.hitmapSize,this.gpu.setFramebuffer("geo"==e?this.geoHitmapTexture:this.geoHitmapTexture2),r=i,s=i,a.clearColor(1,1,1,1),a.enable(a.DEPTH_TEST),a.viewport(0,0,i,i),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.curSize=[r,s],this.onlyHitLayers=!0,this.advancedPassNeeded=!1,this.onlyAdvancedHitLayers="geo2"==e,this.camera.update();break;case"texture":this.gpu.setFramebuffer(t),this.oldSize=[this.curSize[0],this.curSize[1]],a.clearColor(0,0,0,1),a.enable(a.DEPTH_TEST),a.viewport(0,0,this.gpu.canvas.width,this.gpu.canvas.height),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),this.curSize=[this.gpu.canvas.width,this.gpu.canvas.height],this.camera.update(),this.onlyDepth=!1,this.onlyHitLayers=!1,this.onlyAdvancedHitLayers=!1,this.advancedPassNeeded=!1}},Hs.prototype.hitTest=function(e,t){this.gpu.gl;var i,r,s=this.getScreenRay(e,t),a=this.camera.getPosition();i=Math.floor(e*(this.hitmapSize/this.curSize[0])),r=Math.floor(t*(this.hitmapSize/this.curSize[1]));var n=this.hitmapTexture.readFramebufferPixels(i,this.hitmapSize-r-1,1,1),o=n[0]*(1/255)+n[1]+255*n[2]+65025*n[3],h=!(255==n[0]&&255==n[1]&&255==n[2]&&255==n[3]);return this.lastHitPosition=[a[0]+s[0]*o,a[1]+s[1]*o,a[2]+s[2]*o],[this.lastHitPosition[0],this.lastHitPosition[1],this.lastHitPosition[2],h,s,o,a]},Hs.prototype.copyHitmap=function(){this.hitmapTexture.readFramebufferPixels(0,0,this.hitmapSize,this.hitmapSize,!1,this.hitmapData)},Hs.prototype.getDepth=function(e,t){var i=Math.floor(e*(this.hitmapSize/this.curSize[0])),r=Math.floor(t*(this.hitmapSize/this.curSize[1]));if(this.hitmapMode<=2)var s=this.hitmapTexture.readFramebufferPixels(i,this.hitmapSize-r-1,1,1,2==this.hitmapMode),a=s[0]*(1/255)+s[1]+255*s[2]+65025*s[3],n=!(255==s[0]&&255==s[1]&&255==s[2]&&255==s[3]);else{var o=this.hitmapData,h=4*(i+(this.hitmapSize-r-1)*this.hitmapSize),l=o[h],u=o[h+1],c=o[h+2],d=o[h+3];a=l*(1/255)+u+255*c+65025*d,n=!(255==l&&255==u&&255==c&&255==d)}return[n,a]},Hs.prototype.getZoffsetFactor=function(e){return 1e-4*(e[0]+e[1]*this.distanceFactor+e[2]*this.tiltFactor)},Hs.prototype.saveScreenshot=function(e,t,i){var r=this.gpu.gl,s=this.curSize[0],a=this.curSize[1],n=new Uint8Array(s*a*4);r.readPixels(0,0,s,a,r.RGBA,r.UNSIGNED_BYTE,n);for(var o=new Uint8Array(s*a*4),h=0,l=0;l<a;l++)for(var u=(a-1-l)*s*4,c=0;c<s;c++)o[h]=n[u],o[h+1]=n[u+1],o[h+2]=n[u+2],o[h+3]=n[u+3],h+=4,u+=4;var d=document.createElement("canvas");d.width=s,d.height=a;var p=d.getContext("2d"),f=p.createImageData(s,a);if(f.data.set(o),p.putImageData(f,0,0),i=i||"jpg","file"==e){for(var g=document.createElement("a"),m=d.toDataURL("image/"+i),v=atob(m.split(",")[1]),y=new ArrayBuffer(v.length),b=new Uint8Array(y),x=0;x<v.length;x++)b[x]=v.charCodeAt(x);var w=new Blob([y],{type:i}),M=URL.createObjectURL(w);g.href=M,g.download=t,document.body.appendChild(g),g.click(),setTimeout((function(){document.body.removeChild(g),window.URL.revokeObjectURL(M)}),0)}return"tab"==e&&window.open(d.toDataURL("image/"+i)),f},Hs.prototype.getBitmap=function(e,t,i,r,s){var a=(s?r:e)+"*"+t+"*"+i,n=this.bitmaps[a];return!n&&e&&(n=new Ds(this.gpu,e,this.core,null,null,i,t),this.bitmaps[a]=n),n},Hs.prototype.getFont=function(e){var t=this.fonts[e];return t||(t=new _s(this.gpu,this.core,null,null,e),this.fonts[e]=t),t};var Ws=Hs,qs=s.d,Zs=function(){this.root=null,this.maxItemsPerNode=20,this.maxDepth=20,this.depthCount=[];for(var e=0;e<1e3;e++)this.depthCount[e]=0;this.pattern=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])]};Zs.prototype.clear=function(){},Zs.prototype.buildFromGeometry=function(e){if(e){var t,i,r,s,a,n,o,h,l,u,c,d,p,f,g,m,v,y;for(c=d=p=Number.POSITIVE_INFINITY,f=g=m=Number.NEGATIVE_INFINITY,t=0,i=e.length;t<i;t++)if("mesh"==(v=e[t]).type)for(r=0,s=(h=v.submeshes).length;r<s;r++)(l=h[r].bbox)[0][0]<c&&(c=l[0][0]),l[0][1]<d&&(d=l[0][1]),l[0][2]<p&&(p=l[0][2]),l[1][0]>f&&(f=l[1][0]),l[1][1]>g&&(g=l[1][1]),l[1][2]>m&&(m=l[1][2]);for(this.root=new Ys([c,d,p],[f,g,m]),t=0,i=e.length;t<i;t++)if("mesh"==(v=e[t]).type)for(r=0,s=(h=v.submeshes).length;r<s;r++)for(a=0,n=(y=h[r].vertices).length;a<n;a+=9){for(c=d=p=Number.POSITIVE_INFINITY,f=g=m=Number.NEGATIVE_INFINITY,o=0;o<3;o++)y[u=a+3*o]<c&&(c=y[u]),y[u+1]<d&&(d=y[u+1]),y[u+2]<p&&(p=y[u+2]),y[u]>f&&(f=y[u]),y[u+1]>g&&(g=y[u+1]),y[u+2]>m&&(m=y[u+2]);this.root.add([c,d,p,f,g,m,y,a],this)}}};var Ys=function(e,t){this.min=e,this.max=t,this.children=null,this.items=null};Ys.prototype.add=function(e,t,i){if(this.children){i||(i=0);for(var r=0;r<8;r++){var s=this.children[r],a=s.min,n=s.max;e[0]<n[0]&&e[3]>a[0]&&e[1]<n[1]&&e[4]>a[1]&&e[2]<n[2]&&e[5]>a[2]&&s.add(e,t,i+1)}}else this.items||(this.items=[]),this.items.push(e),i<t.maxDepth&&this.items.length>=t.maxItemsPerNode&&this.split(t,i+1)},Ys.prototype.split=function(e,t){var i,r,s,a=this.min,n=this.max,o=[.5*(n[0]+a[0]),.5*(n[1]+a[1]),.5*(n[2]+a[2])];for(this.children=[null,null,null,null,null,null,null,null],this.depthCount[t]++,i=0;i<8;i++){var h=e.pattern[i];this.children[i]=new Ys([0===h[0]?a[0]:o[0],0===h[1]?a[1]:o[1],0===h[2]?a[2]:o[2]],[0===h[0]?o[0]:n[0],0===h[1]?o[1]:n[1],0===h[2]?o[2]:n[2]])}var l=this.items;if(l)for(i=0,r=l.length;i<r;i++){var u=l[i];for(s=0;s<8;s++){var c=this.children[s];a=c.min,n=c.max,u[0]<n[0]&&u[3]>a[0]&&u[1]<n[1]&&u[4]>a[1]&&u[2]<n[2]&&u[5]>a[2]&&c.add(u,e)}}this.items=null};var Js=function(){this.octantTable=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],this.flags=0};Js.prototype.findEntryOctant=function(e,t,i,r,s,a){var n=0;return e>t&&e>i?(s<e&&(n|=2),a<e&&(n|=1)):t>i?(r<t&&(n|=4),a<t&&(n|=1)):(r<i&&(n|=4),s<i&&(n|=2)),n},Js.prototype.findNextOctant=function(e,t,i,r){var s,a=0;return t<i?(s=t,a=0):(s=i,a=1),r<s&&(a=2),this.octantTable[e][a]},Js.prototype.raycastOctant=function(e,t,i,r,s,a,n,o){var h,l,u,c,d=e.children;if(s>=0&&a>=0&&n>=0)if(d){l=.5*(t+s),u=.5*(i+a),c=.5*(r+n),h=this.findEntryOctant(t,i,r,l,u,c);do{switch(h){case 0:this.raycastOctant(d[this.flags],t,i,r,l,u,c,o),h=this.findNextOctant(h,l,u,c);break;case 1:this.raycastOctant(d[1^this.flags],t,i,c,l,u,n,o),h=this.findNextOctant(h,l,u,n);break;case 2:this.raycastOctant(d[2^this.flags],t,u,r,l,a,c,o),h=this.findNextOctant(h,l,a,c);break;case 3:this.raycastOctant(d[3^this.flags],t,u,c,l,a,n,o),h=this.findNextOctant(h,l,a,n);break;case 4:this.raycastOctant(d[4^this.flags],l,i,r,s,u,c,o),h=this.findNextOctant(h,s,u,c);break;case 5:this.raycastOctant(d[5^this.flags],l,i,c,s,u,n,o),h=this.findNextOctant(h,s,u,n);break;case 6:this.raycastOctant(d[6^this.flags],l,u,r,s,a,c,o),h=this.findNextOctant(h,s,a,c);break;case 7:this.raycastOctant(d[7^this.flags],l,u,c,s,a,n,o),h=8}}while(h<8)}else e.items&&o.push(e)},Js.prototype.hitFace=function(e,t,i,r){var s,a,n,o,h,l,u=[r[i],r[i+1],r[i+2]],c=[r[i+3],r[i+4],r[i+5]],d=[r[i+6],r[i+7],r[i+8]],p=[0,0,0],f=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],g=[d[0]-u[0],d[1]-u[1],d[2]-u[2]];return qs.cross(t,g,p),(n=qs.dot(f,p))>-1e-7&&n<1e-7?[!1]:(o=1/n,a=[e[0]-u[0],e[1]-u[1],e[2]-u[2]],(h=o*qs.dot(a,p))<0||h>1?[!1]:(s=qs.cross(a,f),(l=o*qs.dot(t,s))<0||h+l>1?[!1]:[!0,o*qs.dot(g,s)]))},Js.prototype.intersectOctree=function(e,t,i,r){var s,a,n,o,h,l,u,c,d,p=[0,0,0],f=[i.root.max[0]-i.root.min[0],i.root.max[1]-i.root.min[1],i.root.max[2]-i.root.min[2]],g=[f[0],f[1],f[2]],m=[.5*g[0],.5*g[1],.5*g[2]],v=[e[0],e[1],e[2]],y=[t[0],t[1],t[2]],b=[.5*(i.root.max[0]+i.root.min[0]),.5*(i.root.max[1]+i.root.min[1]),.5*(i.root.max[2]+i.root.min[2])];v[0]=v[0]-b[0]+m[0],v[1]=v[1]-b[1]+m[1],v[2]=v[2]-b[2]+m[2],this.flags=0,y[0]<0&&(v[0]=g[0]-v[0],y[0]=-y[0],this.flags|=4),y[1]<0&&(v[1]=g[1]-v[1],y[1]=-y[1],this.flags|=2),y[2]<0&&(v[2]=g[2]-v[2],y[2]=-y[2],this.flags|=1),s=1/y[0],a=1/y[1],n=1/y[2],o=(p[0]-v[0])*s,h=(f[0]-v[0])*s,l=(p[1]-v[1])*a,u=(f[1]-v[1])*a,c=(p[2]-v[2])*n,d=(f[2]-v[2])*n,Math.max(Math.max(o,l),c)<Math.min(Math.min(h,u),d)&&this.raycastOctant(i.root,o,l,c,h,u,d,r)},Js.prototype.intersectOctants=function(e,t,i){for(var r=[],s=Number.POSITIVE_INFINITY,a=0,n=i.length;a<n;a++)for(var o=i[a].items,h=0,l=o.length;h<l;h++){var u=o[h],c=this.hitFace(e,t,u[7],u[6]);c[0]&&c[1]<s&&(s=c[1])}return s!==Number.POSITIVE_INFINITY&&(r=[s]),r};var Ks=c,Qs=W,Xs=$,$s=Zs,ea=Js,ta=function(e){this.renderer=e,this.gpu=e.gpu};ta.prototype.clear=function(e){return null!=e&&this.gpu.clear(e.clearDepth||!0,e.clearColor||!1,e.color||[255,255,255,255],null!=e.depth?e.depth:1),this},ta.prototype.createState=function(e){if(null==e||"object"!=typeof e)return this;var t={blend:null!=e.blend&&e.blend,stencil:null!=e.stencil&&e.stencil,zoffset:null!=e.zoffset?e.zoffset:0,zwrite:null==e.zwrite||e.zwrite,ztest:null==e.ztest||e.ztest,zequal:null==e.zequal||e.zequal,culling:null==e.culling||e.culling};return this.gpu.createState(t)},ta.prototype.setState=function(e){return null!=e&&this.gpu.setState(e),this},ta.prototype.createTexture=function(e){if(null==e||"object"!=typeof e)return null;var t=e.source;if(null==t)return null;var i,r=e.filter||"linear",s=e.repeat||!1;if(t instanceof Uint8Array){var a=e.width,n=e.height;if(a&&n)return(i=new Ks(this.gpu)).createFromData(a,n,t,r,s),i}return t instanceof Image?((i=new Ks(this.gpu)).createFromImage(t,r,s),i):null},ta.prototype.removeTexture=function(e){return e&&e.kill(),this},ta.prototype.createMesh=function(e){if(null==e||"object"!=typeof e)return null;var t={vertices:e.vertices,uvs:e.uvs,uvs2:e.normals,vertexSize:e.vertexSize,uvSize:e.uvSize,uv2Size:e.normalSize||3,vertexAttr:e.vertexAttr,uvAttr:e.uvAttr,uv2Attr:e.normalAttr,bbox:e.bbox};return new Qs(this.gpu,t,0,this.renderer.core)},ta.prototype.removeMesh=function(e){return e&&e.kill(),this},ta.prototype.createShader=function(e){if(null==e||"object"!=typeof e)return null;var t=e.vertexShader,i=e.fragmentShader;return null!=t&&i?new Xs(this.gpu,t,i):void 0},ta.prototype.removeResource=function(e){return null!=e&&null!=e.kill&&e.kill(),this},ta.prototype.addJob=function(){return this},ta.prototype.clearJobs=function(){return this},ta.prototype.drawMesh=function(e){if(null==e||"object"!=typeof e)return this;if(null==!e.mesh||!e.shaderVariables)return this;var t=e.vertex||"aPosition",i=e.uv||"aTexCoord",r=e.normal||"aNormal",s=null!=e.depthOffset?e.depthOffset:null,a=e.shaderVariables,n=e.shader||"textured",o=this.renderer,h=e.mesh,l=e.texture,u=o.camera.getModelviewMatrix(),c=o.camera.getProjectionMatrix(),d=o.fogDensity;if("string"==typeof n)switch(n){case"hit":a.uMV||(a.uMV=["mat4",u]),a.uProj||(a.uProj=["mat4",c]),i=null,r=null,l=null,n=o.progDepthTile[0];break;case"shaded":i=null;case"textured":case"textured-and-shaded":a.uMV||(a.uMV=["mat4",u]),a.uProj||(a.uProj=["mat4",c]),a.uFogDensity||(a.uFogDensity=["float",d]),r="textured"==n?null:"aNormal",n="textured"==n?o.progTile[0]:"shaded"==n?o.progShadedTile:o.progTShadedTile}if(n&&n.isReady()){var p=[t];for(var f in i&&p.push(i),r&&p.push(r),o.gpu.useProgram(n,p),a){var g=a[f];if(2==g.length)switch(g[0]){case"floatArray":n.setFloatArray(f,g[1]);break;case"float":n.setFloat(f,g[1]);break;case"mat3":n.setMat3(f,g[1]);break;case"mat4":s&&"uProj"==f?n.setMat4(f,g[1],o.getZoffsetFactor(s)):n.setMat4(f,g[1]);break;case"vec2":n.setVec2(f,g[1]);break;case"vec3":n.setVec3(f,g[1]);break;case"vec4":n.setVec4(f,g[1]);break;case"sampler":n.setSampler(f,g[1])}}return l&&o.gpu.bindTexture(l),h.draw(n,t,i,r,null),this}},ta.prototype.drawImage=function(e){if(null==e||"object"!=typeof e)return this;if(null==e.texture||null==e.rect)return this;var t=e.rect,i=e.color||[255,255,255,255],r=null!=e.depth?e.depth:0,s=null!=e.depthOffset?e.depthOffset:null,a=null!=e.depthTest&&e.depthTest,n=null!=e.blend&&e.blend,o=null!=e.writeDepth&&e.writeDepth,h=null!=e.useState&&e.useState;return i=[i[0]*(1/255),i[1]*(1/255),i[2]*(1/255),i[3]*(1/255)],this.renderer.draw.drawImage(t[0],t[1],t[2],t[3],e.texture,i,r,s,a,n,o,h),this},ta.prototype.drawBillboard=function(e){if(null==e||"object"!=typeof e)return this;if(null==e.texture||null==e.mvp)return this;var t=e.mvp,i=e.color||[255,255,255,255],r=null!=e.depthOffset?e.depthOffset:null,s=null!=e.depthTest&&e.depthTest,a=null!=e.blend&&e.blend,n=null!=e.writeDepth&&e.writeDepth,o=null!=e.useState&&e.useState;return i[0]*=1/255,i[1]*=1/255,i[2]*=1/255,i[3]*=1/255,this.renderer.draw.drawBillboard(t,e.texture,i,r,s,a,n,o),this},ta.prototype.drawLineString=function(e){if(null==e||"object"!=typeof e)return this;if(null==e.points)return this;var t=e.points,i=e.color||[255,255,255,255],r=null!=e.depthOffset?e.depthOffset:null,s=e.size||2,a=null==e.screenSpace||e.screenSpace,n=null!=e.depthTest&&e.depthTest,o=null!=e.blend&&e.blend,h=null!=e.writeDepth&&e.writeDepth,l=null!=e.useState&&e.useState;return i[0]*=1/255,i[1]*=1/255,i[2]*=1/255,i[3]*=1/255,this.renderer.draw.drawLineString(t,a,s,i,r,n,o,h,l),this},ta.prototype.drawJobs=function(){return this},ta.prototype.drawBBox=function(){return this},ta.prototype.drawDebugText=function(e){if(null==e||"object"!=typeof e)return this;var t=e.text,i=e.coords;if(!t||!i)return this;var r=e.color||[255,255,255,255],s=e.size||16,a=e.depth,n=e.useState||!1;r[0]*=1/255,r[1]*=1/255,r[2]*=1/255,r[3]*=1/255;var o=this.renderer.draw.getTextSize(s,t);return this.renderer.draw.drawText(i[0]-.5*o,i[1],s,t,r,a,n),this},ta.prototype.buildOctreeFromGeometry=function(e){var t=new $s;return t.buildFromGeometry(e),t},ta.prototype.raycastOctreeGeometry=function(e,t,i){var r=new ea,s=[];return r.intersectOctree(t,i,e,s),r.intersectOctants(t,i,s)},ta.prototype.saveScreenshot=function(e,t,i){return this.renderer.saveScreenshot(e,t,i)},ta.prototype.getCanvasCoords=function(e,t){return this.renderer.project2(e,t)},ta.prototype.getCanvasSize=function(){return this.renderer.curSize.slice()},ta.prototype.setConfigParams=function(e){return this.renderer.setConfigParams(e),this},ta.prototype.setConfigParam=function(e,t){return this.renderer.setConfigParam(e,t),this},ta.prototype.getConfigParam=function(e){return this.renderer.getConfigParam(e)},ta.prototype.getGLInterface=function(){return{canvas:this.gpu.canvas,gl:this.gpu.gl}},ta.prototype.setSuperElevation=function(e,t,i,r){return this.renderer.setSuperElevation(e,t,i,r)},ta.prototype.setMarginFlags=function(e){return this.renderer.marginFlags=e},ta.prototype.getMarginFlags=function(){return this.renderer.marginFlags};var ia=ta,ra=p.a,sa=function(e,t,i,r){this.map=e,this.p1=t.clone(),this.p2=i.clone(),this.op2=i.clone();var s=this.p1.getHeightMode(),a=this.p2.getHeightMode();"fix"==s&&"float"==a?this.p1=this.map.convert.convertPositionHeightMode(this.p1,"float",!0):"float"==s&&"fix"==a&&(this.p1=this.map.convert.convertPositionHeightMode(this.p1,"fix",!0));var n=this.p1.getViewMode(),o=this.p2.getViewMode();if("subj"==n&&"obj"==o?this.p2=this.map.convert.convertPositionViewMode(this.p2,"subj"):"obj"==n&&"subj"==o&&(this.p1=this.map.convert.convertPositionViewMode(this.p1,"subj")),this.p1.pos[5]=this.p1.pos[5]<0?360+this.p1.pos[5]%360:this.p1.pos[5]%360,this.p2.pos[5]=this.p2.pos[5]<0?360+this.p2.pos[5]%360:this.p2.pos[5]%360,this.pp1=this.p1.clone(),this.mode=r.mode||"auto",this.submode=r.submode||"none",this.submode="none",this.maxHeight=r.maxHeight||1e9,this.minDuration=r.minDuration||0,this.maxDuration=r.maxDuration||1e4,this.samplePeriod=r.samplePeriod||10,this.fade=r.fade||"none",this.fadePower=r.fadePower||1,this.yawInterpolation=r.yawInterpolation||"shortest",this.pv=r.pv||.15,this.map.getNavigationSrs().isProjected()||(this.geodesic=this.map.measure.getGeodesic()),r.distanceAzimuth)this.distanceAzimuth=!0,this.pp2=this.p1.clone(),r.destHeight&&this.pp2.setHeight(r.destHeight),r.destOrientation&&this.pp2.setHeight(r.destOrientation),r.destFov&&this.pp2.setHeight(r.destFov),this.geoAzimuth=r.azimuth||0,this.geoDistance=r.distance||100,this.distance=this.geoDistance,this.azimuth=this.geoAzimuth%360,this.azimuth=this.azimuth<0?360+this.azimuth:this.azimuth;else{this.distanceAzimuth=!1,this.pp2=this.p2.clone();var h=this.map.measure.getDistance(this.pp1.getCoords(),this.pp2.getCoords());this.distance=h[0],this.azimuth=(h[1]+90)%360,this.azimuth=this.azimuth<0?360+this.azimuth:this.azimuth,this.map.getNavigationSrs().isProjected()||(h=this.geodesic.Inverse(this.pp1.pos[2],this.pp1.pos[1],this.pp2.pos[2],this.pp2.pos[1]),this.geoAzimuth=h.azi1,this.geoDistance=h.s12,this.azimuth=this.geoAzimuth%360,this.azimuth=this.azimuth<0?360+this.azimuth:this.azimuth)}this.detectMode(),this.detectDuration(),this.detectFlightHeight(r.height)};sa.prototype.detectFlightHeight=function(e){"ballistic"==this.mode&&(this.flightHeight=Math.max(this.pp1.getHeight(),this.pp2.getHeight()),this.flightHeight+=e||.5*this.distance,this.flightHeight=Math.min(this.flightHeight,this.maxHeight),this.flightHeight-=Math.max(this.pp1.getHeight(),this.pp2.getHeight()))},sa.prototype.detectMode=function(){"auto"==this.mode&&(this.mode=this.distance>2e3?"ballistic":"direct")},sa.prototype.detectDuration=function(){if(this.duration=0,this.headingDuration=1e3,this.distance<500?this.duration=1e3:this.distance<2e3?this.duration=2e3:(this.duration=this.distance/100,this.duration<300?this.duration=3e3:this.headingDuration=1500,this.duration<6e3&&(this.duration=6e3),this.duration>1e4&&(this.duration=1e4),"direct"!=this.mode&&(this.duration*=1.8,this.headingDuration*=1.8)),"direct"!=this.mode){var e=3*this.headingDuration;this.duration=Math.max(this.duration,e),this.maxDuration<e&&(this.duration=this.maxDuration,this.headingDuration=this.maxDuration/3)}this.duration=Math.min(this.duration,this.maxDuration),this.duration=Math.max(this.duration,this.minDuration)},sa.prototype.generate=function(){for(var e=new Array(Math.ceil(this.duration/this.samplePeriod)+(this.distanceAzimuth?0:1)),t=0,i=0;i<=this.duration;i+=this.samplePeriod){var r,s,a=i/this.duration,n=this.pp1.clone();if("direct"==this.mode){switch(r=a,this.fade){case"in":switch(this.fadePower){case 1:a=r*r;break;case 2:a=r*r*r;break;case 3:a=r*r*r*r;break;case 4:a=r*r*r*r*r;break;case 5:a=r*r*r*r*r*r;break;case 6:a=r*r*r*r*r*r*r}break;case"out":switch(r=1-r,this.fadePower){case 1:a=1-r*r;break;case 2:a=1-r*r*r;break;case 3:a=1-r*r*r*r;break;case 4:a=1-r*r*r*r*r;break;case 5:a=1-r*r*r*r*r*r;break;case 6:a=1-r*r*r*r*r*r*r}break;case"inout":switch(this.fadePower){case 1:a=r*r*(3-2*r);break;case 2:a=r*r*r*(r*(6*r-15)+10);break;case 3:a=(r=a=r*r*(3-2*r))*r*(3-2*r);break;case 4:a=(r=a=r*r*r*(r*(6*r-15)+10))*r*r*(r*(6*r-15)+10);break;case 5:a=(r=a=(r=a=r*r*(3-2*r))*r*(3-2*r))*r*(3-2*r);break;case 6:a=(r=a=(r=a=r*r*r*(r*(6*r-15)+10))*r*r*(r*(6*r-15)+10))*r*r*(r*(6*r-15)+10)}}n.setCoords(this.getInterpolatedCoords(a)),n.setHeight(this.getInterpolatedHeight(a));var o=this.pp1.getOrientation(),h=this.pp2.getOrientation();n.setOrientation(this.getInterpolatedOrinetation(o,h,a)),n.setFov(this.getInterpolatedFov(a)),n.setViewExtent(this.getInterpolatedViewExtent(a)),e[t]=n.pos,t++}else{a=(r=a=(r=a)*r*(3-2*r))*r*(3-2*r);var l=this.getSmoothFactor(i);if("piha"==this.submode){var u=this.distance/this.duration*(i-this.duration/(2*Math.PI)*Math.sin(2*Math.PI/this.duration*i))/this.distance,c=this.pv,d=this.pp1.getCoords()[2],p=this.pp2.getCoords()[2],f=this.distance/(.001*this.duration*c*Math.tan(.5*ra.radians(this.pp1.getFov())))*(1-Math.cos(2*Math.PI*i/this.duration))+d+(p-d)*i/this.duration;s=this.getInterpolatedCoords(u),n.setCoords(s),n.setHeight(f)}else s=this.getInterpolatedCoords(l),n.setCoords(s),n.setHeight(this.getSineHeight(a));null!=s[3]&&(this.azimuth=-s[3]),n.setOrientation(this.getFlightOrienation(i)),n.setFov(this.getInterpolatedFov(a)),n.setViewExtent(this.getInterpolatedViewExtent(a)),e[t]=n.pos,e[t]=n.pos,t++}}return this.distanceAzimuth||(e[t]=this.op2.clone().pos),e},sa.prototype.getInterpolatedCoords=function(e){var t=this.pp1.getCoords(),i=this.pp2.getCoords();if(this.map.getNavigationSrs().isProjected())return[t[0]+(i[0]-t[0])*e,t[1]+(i[1]-t[1])*e,t[2]+(i[2]-t[2])*e];var r=this.geodesic.Direct(t[1],t[0],this.geoAzimuth,this.geoDistance*e),s=r.azi1-r.azi2;return s=this.azimuth<0?360+s:s,[r.lon2,r.lat2,t[2]+(i[2]-t[2])*e,s]},sa.prototype.getInterpolatedOrinetation=function(e,t,i){var r=t[0]-e[0],s=t[1]-e[1],a=t[2]-e[2];return"shortest"!=this.yawInterpolation&&"longest"!=this.yawInterpolation||Math.abs(r)>180&&(r=r>0?-(360-r):360-Math.abs(r)),"longest"==this.yawInterpolation&&(r=r<0?360+r:-360+r),[e[0]+r*i,e[1]+s*i,e[2]+a*i]},sa.prototype.getInterpolatedFov=function(e){var t=this.pp1.getFov();return t+(this.pp2.getFov()-t)*e},sa.prototype.getInterpolatedViewExtent=function(e){var t=this.pp1.getViewExtent();return t+(this.pp2.getViewExtent()-t)*e},sa.prototype.getInterpolatedHeight=function(e){var t=this.pp1.getHeight();return t+(this.pp2.getHeight()-t)*e},sa.prototype.getSineHeight=function(e){var t=this.pp1.getCoords(),i=this.pp2.getCoords();return t[2]+(i[2]-t[2])*e+Math.sin(Math.PI*e)*this.flightHeight},sa.prototype.getSmoothFactor=function(e){var t=0;return(t=(t=e<this.headingDuration?0:e>this.duration-this.headingDuration?1:Math.min(1,(e-this.headingDuration)/(this.duration-2*this.headingDuration)))*t*(3-2*t))*t*(3-2*t)},sa.prototype.getFlightOrienation=function(e){var t=null,i=null,r=[0,-90,0],s=0;return r[0]=this.azimuth%360,r[0]<0&&(r[0]=360-Math.abs(r[0])),e<=this.headingDuration?(s=e/this.headingDuration,t=this.pp1.getOrientation(),i=r):e>=this.duration-this.headingDuration?(s=(e-(this.duration-this.headingDuration))/this.headingDuration,t=r,i=this.pp2.getOrientation()):(s=0,t=r,i=r),this.getInterpolatedOrinetation(t,i,s)};var aa=sa,na=ut,oa=Pt,ha=_i,la=xe,ua=function(e){this.map=e,this.config=e.config};ua.prototype.setPosition=function(e){return this.map.setPosition(e),this},ua.prototype.getPosition=function(){return this.map.getPosition()},ua.prototype.setView=function(e,t,i){return this.map.setView(e,t,i),this},ua.prototype.getView=function(){return this.map.getView()},ua.prototype.getCredits=function(){return this.map.getCredits()},ua.prototype.getCurrentCredits=function(){return this.map.getVisibleCredits()},ua.prototype.getCreditInfo=function(e){var t=this.map.getCreditById(e);return t?t.getInfo():{}},ua.prototype.getViews=function(){return this.map.getNamedViews()},ua.prototype.getViewInfo=function(e){var t=this.map.getNamedView(e);return t?t.getInfo():{}},ua.prototype.getBoundLayers=function(){return this.map.getBoundLayers()},ua.prototype.getBoundLayerInfo=function(e){return this.map.getBoundLayerInfo(e)},ua.prototype.getFreeLayers=function(){return this.map.getFreeLayers()},ua.prototype.getFreeLayerInfo=function(e){var t=this.map.getFreeLayer(e);return t?t.getInfo():{}},ua.prototype.getSurfaces=function(){return this.map.getSurfaces()},ua.prototype.getSurfaceInfo=function(e){var t=this.map.getFreeLayer(e);return t?t.getInfo():{}},ua.prototype.getSrses=function(){return this.map.getSrses()},ua.prototype.getSrsInfo=function(e){var t=this.map.getSrs(e);return t?t.getInfo():{}},ua.prototype.getReferenceFrame=function(){return this.map.referenceFrame.getInfo()},ua.prototype.addFreeLayer=function(e,t){var i=new oa(this.map,t,"free");this.map.addFreeLayer(e,i)},ua.prototype.removeFreeLayer=function(e){this.map.removeFreeLayer(e)},ua.prototype.addBoundLayer=function(e,t){var i=new na(this.map,t,e);this.map.addBoundLayer(e,i)},ua.prototype.removeBoundLayer=function(e){this.map.removeBoundLayer(e)},ua.prototype.convertPositionViewMode=function(e,t){return this.map.convert.convertPositionViewMode(new ha(e),t)},ua.prototype.convertPositionHeightMode=function(e,t,i){return this.map.convert.convertPositionHeightMode(new ha(e),t,i)},ua.prototype.convertCoords=function(e,t,i){var r=this.map.getSrs(e),s=this.map.getSrs(t);return r&&s?s.convertCoordsFrom(i,r):null},ua.prototype.convertCoordsFromNavToPublic=function(e,t,i){var r=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionPublicCoords(new ha(r),i)},ua.prototype.convertCoordsFromPublicToNav=function(e,t,i){var r=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionNavCoordsFromPublic(new ha(r),i)},ua.prototype.convertCoordsFromPhysToPublic=function(e,t){if(t&&this.map.renderer.useSuperElevation){var i=this.map.renderer.transformPointBySE(e);return this.map.convert.convertCoords(i,"physical","public")}return this.map.convert.convertCoords(e,"physical","public")},ua.prototype.convertCoordsFromNavToPhys=function(e,t,i,r){var s=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionPhysCoords(new ha(s),i,r)},ua.prototype.convertCoordsFromPhysToNav=function(e,t,i,r){return this.map.convert.convertCoordsFromPhysToNav(e,t,i,r)},ua.prototype.convertCoordsFromNavToCanvas=function(e,t,i){var r=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionCanvasCoords(new ha(r),i)},ua.prototype.convertCoordsFromPhysToCanvas=function(e,t){var i=["obj",e[0],e[1],"fix",e[2],0,0,0,10,45];return this.map.convert.getPositionCanvasCoords(new ha(i),null,!0,t)},ua.prototype.convertCoordsFromNavToCameraSpace=function(e,t,i){var r=["obj",e[0],e[1],t,e[2],0,0,0,10,45];return this.map.convert.getPositionCameraSpaceCoords(new ha(r),i)},ua.prototype.convertCoordsFromPhysToCameraSpace=function(e){var t=this.map.camera.position;return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},ua.prototype.transformPhysCoordsBySE=function(e){return this.map.convert.transformPhysCoordsBySE(e)},ua.prototype.getPositionCanvasCoords=function(e,t){return this.map.convert.getPositionCanvasCoords(new ha(e),t)},ua.prototype.getPositionCameraCoords=function(e,t){return this.map.convert.getPositionCameraCoords(new ha(e),t)},ua.prototype.movePositionCoordsTo=function(e,t,i,r){return this.map.convert.movePositionCoordsTo(new ha(e),t,i,r)},ua.prototype.getGeodesicLinePoints=function(e,t,i,r){return this.map.convert.getGeodesicLinePoints(e,t,i,r)},ua.prototype.getSurfaceHeight=function(e,t){return this.map.measure.getSurfaceHeight(e,this.map.measure.getOptimalHeightLodBySampleSize(e,t))},ua.prototype.getSurfaceAreaGeometry=function(e,t,i,r,s,a){var n=this.map.measure.getSurfaceAreaGeometry(e,t,i,r,!0,a);if(n[0]){var o=n[1],h=[],l=this.map;return l.tree&&(l.storedTilesRes=[],l.tree.storeGeometry(o,o.length),h=l.storedTilesRes,l.storedTilesRes=[]),s(h),function(){}}return this.map.core.once("map-update",this.getSurfaceAreaGeometry.bind(this,e,t,i,r,s,a),1)},ua.prototype.getDistance=function(e,t,i,r){return this.map.measure.getDistance(e,t,i,r)},ua.prototype.getAzimuthCorrection=function(e,t){return this.map.measure.getAzimuthCorrection(e,t)},ua.prototype.getNED=function(e,t){return this.map.measure.getNewNED(e,!1!==t)},ua.prototype.getCameraInfo=function(){var e=this.map.camera;return{projectionMatrix:e.camera.projection.slice(),viewMatrix:e.camera.modelview.slice(),viewProjectionMatrix:e.camera.mvp.slice(),rotationMatrix:e.camera.rotationview.slice(),position:this.map.camera.position.slice(),vector:this.map.camera.vector.slice(),distance:this.map.camera.distance,height:this.map.camera.height}},ua.prototype.isPointInsideCameraFrustum=function(e){return this.map.camera.camera.pointVisible(e,this.map.camera.position)},ua.prototype.isBBoxInsideCameraFrustum=function(e){return this.map.camera.camera.bboxVisible({min:e[0],max:e[1]},this.map.camera.position)},ua.prototype.generateTrajectory=function(e,t,i){return e=new ha(e),t=new ha(t),new aa(this.map,e,t,i).generate()},ua.prototype.generatePIHTrajectory=function(e,t,i,r){var s=new ha(e);return r.distance=i,r.azimuth=t,r.distanceAzimuth=!0,new aa(this.map,s,s,r).generate()},ua.prototype.setConfigParams=function(e){return this.map.setConfigParams(e),this},ua.prototype.setConfigParam=function(e,t){return this.map.setConfigParam(e,t),this},ua.prototype.getConfigParam=function(e){return this.map.getConfigParam(e)},ua.prototype.redraw=function(){return this.map.markDirty(),this},ua.prototype.addRenderSlot=function(e,t,i){return this.map.renderSlots.addRenderSlot(e,t,i),this},ua.prototype.moveRenderSlotBefore=function(e,t){return this.map.renderSlots.moveRenderSlotBefore(e,t),this},ua.prototype.moveRenderSlotAfter=function(e,t){return this.map.renderSlots.moveRenderSlotAfter(e,t),this},ua.prototype.removeRenderSlot=function(e){return this.map.renderSlots.removeRenderSlot(e),this},ua.prototype.setRenderSlotEnabled=function(e,t){return this.map.renderSlots.setRenderSlotEnabled(e,t),this},ua.prototype.getRenderSlotEnabled=function(e){return this.map.renderSlots.getRenderSlotEnabled(e)},ua.prototype.setLoaderSuspended=function(e){return this.map.loaderSuspended=e,this},ua.prototype.getLoaderSuspended=function(){return this.map.loaderSuspended},ua.prototype.getGpuCache=function(){return this.map.gpuCache},ua.prototype.getHitCoords=function(e,t,i,r){return this.map.getHitCoords(e,t,i,r)},ua.prototype.getScreenRay=function(e,t){return this.map.getScreenRay(e,t)},ua.prototype.renderToImage=function(){return this.map.renderToImage()},ua.prototype.getCurrentGeometry=function(){return this.map.getCurrentGeometry()},ua.prototype.getStats=function(e){if(e)return{maxZoom:this.map.draw.debug.maxZoom};for(var t=0,i=0,r=this.map.geodataProcessors;i<r;i++)this.map.geodataProcessors[i].busy&&t++;return{bestMeshTexelSize:this.map.bestMeshTexelSize,bestGeodataTexelSize:this.map.bestGeodataTexelSize,downloading:this.map.loader.downloading.length,lastDownload:this.map.loader.lastDownloadTime,surfaces:this.map.tree.surfaceSequence.length,freeLayers:this.map.freeLayerSequence.length,texelSizeFit:this.map.texelSizeFit,loadMode:this.map.config.mapLoadMode,processingTasks:this.map.processingTasks.length,busyWorkers:t,dirty:this.map.dirty,drawnTiles:this.map.stats.drawnTiles,drawnGeodataTiles:this.map.stats.drawnGeodataTiles,renderTime:this.map.stats.rendererTime,frameTime:this.map.stats.frameTime}},ua.prototype.click=function(e,t,i){this.map.click(e,t,i)},ua.prototype.hover=function(e,t,i,r){this.map.hover(e,t,i,r)},ua.prototype.createGeodata=function(){return new la(this.map)},ua.prototype.getGeodataGeometry=function(e){return this.map.renderer.geometries[e]},ua.prototype.setGeodataSelection=function(e){return this.map.renderer.geodataSelection=e,this.map.markDirty(),this},ua.prototype.getGeodataSelection=function(){return this.map.renderer.geodataSelection};var ca=fr,da=Gr,pa=Ws,fa=ia,ga=_i,ma=ua,va=a.a,ya=at.a,ba=n.a,xa=function(e,t,i){var s=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;this.killed=!1,this.config={map:null,mapCache:1100,mapGPUCache:600,mapMetatileCache:60,mapTexelSizeFit:1.1,mapMaxHiresLodLevels:2,mapDownloadThreads:20,mapMaxProcessingTime:10,mapMaxGeodataProcessingTime:10,mapMobileMode:!1,mapMobileModeAutodect:!0,mapMobileDetailDegradation:1,mapNavSamplesPerViewExtent:4,mapIgnoreNavtiles:!1,mapVirtualSurfaces:!0,mapAllowHires:!0,mapAllowLowres:!0,mapAllowSmartSwitching:!0,mapDisableCulling:!1,mapPreciseCulling:!0,mapHeightLodBlend:!0,mapHeightNodeBlend:!0,mapBasicTileSequence:!1,mapPreciseBBoxTest:!1,mapPreciseDistanceTest:!1,mapHeightfiledWhenUnloaded:!0,mapForceMetatileV3:!1,mapSmartNodeParsing:!0,mapLoadErrorRetryTime:3e3,mapLoadErrorMaxRetryCount:3,mapLoadMode:"topdown",mapGeodataLoadMode:"fit",mapSplitMeshes:!0,mapSplitMargin:.0025,mapSplitSpace:null,mapSplitLods:!1,mapGridMode:"linear",mapGridSurrogatez:!1,mapGridUnderSurface:0,mapGridTextureLevel:-1,mapGridTextureLayer:null,mapXhrImageLoad:!0,mapStoreLoadStats:!1,mapRefreshCycles:3,mapSoftViewSwitch:!0,mapSortHysteresis:!0,mapHysteresisWait:0,mapSeparateLoader:!0,mapGeodataBinaryLoad:!0,mapPackLoaderEvents:!0,mapParseMeshInWorker:!0,mapPackGeodataEvents:!0,mapCheckTextureSize:!1,mapTraverseToMeshNode:!0,mapNormalizeOctantTexelSize:!0,mapFeatureStickMode:[1,1],map16bitMeshes:!0,mapOnlyOneUVs:!1,mapIndexBuffers:!0,mapAsyncImageDecode:!0,mapFeatureGridCells:31,mapFeaturesPerSquareInch:.25,mapFeaturesSortByTop:!1,mapFeaturesReduceMode:"scr-count1",mapFeaturesReduceParams:null,mapFeaturesReduceFactor:1,mapFeaturesReduceFactor2:1,mapDMapSize:1024,mapDMapMode:1,mapDegradeHorizon:!1,mapDegradeHorizonParams:[1,1500,97500,3500],mapDefaultFont:"//cdn.melown.com/libs/vtsjs/fonts/noto-basic/1.0.0/noto.fnt",mapFog:!0,mapNoTextures:!1,mapMetricUnits:!("en"==s||0==s.indexOf("en-")),mapLanguage:s,mapForceFrameTime:0,mapForcePipeline:0,mapLogGeodataStyles:!0,mapBenevolentMargins:!1,rendererAnisotropic:0,rendererAntialiasing:!0,rendererAllowScreenshots:!1,inspector:!0,authorization:null,mario:!1},this.configStorage={},this.element=e,this.coreInterface=i,this.ready=!1,this.listeners=[],this.listenerCounter=0,this.tokenCookieHost=null,this.tokenIFrame=null,this.xhrParams={},this.inspector=null!=da?new da(this):null,this.setConfigParams(t),this.map=null,this.mapInterface=null,this.renderer=new pa(this,this.element,null,this.onResize.bind(this),this.config),this.rendererInterface=new fa(this.renderer),this.proj4=r.a,this.contextLost=!1,ba.init(),this.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},window.performance=window.performance||{},performance.now=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()},this.loadMap(this.config.map),this.requestAnimFrame.call(window,this.onUpdate.bind(this))};function wa(e){return(e?"Core: ":"")+"2.23.12"}function Ma(){ba.init();var e=document.createElement("canvas");if(null==e)return!1;if(e.width=1024,e.height=768,null==e.getContext)return!1;var t=null;try{t=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(e){return!1}return!!t}xa.prototype.onResize=function(){null!=this.map&&this.map.markDirty()},xa.prototype.loadMap=function(e){if(null!=this.map&&this.destroyMap(),null!=e){e=ya.getProcessUrl(e,window.location.href),this.tokenCookieLoaded=!0,this.mapConfigData=null,this.tokenExpiration=null,this.tokenExpirationCallback=null,this.tokenExpirationLoop=!1,this.tokenCanBeSkiped=!0,this.mapRunnig=!1;var t=function(){if((this.tokenCookieLoaded||this.tokenCanBeSkiped)&&this.mapConfigData&&!this.mapRunnig){this.mapRunnig=!0;var t=this.mapConfigData;this.callListener("map-mapconfig-loaded",t),this.map=new ca(this,t,e,this.config,this.configStorage),this.mapInterface=new ma(this.map),this.setConfigParams(this.map.browserOptions,!0),this.setConfigParams(this.configStorage),this.config.position&&(this.map.setPosition(this.config.position),this.config.position=null),this.config.view&&(this.map.setView(this.config.view),this.config.view=null)}}.bind(this),i=function(e){this.mapConfigData=e,t()}.bind(this),r=function(){}.bind(this),s=function(t){!t||t&&t.status?this.tokenCanBeSkiped&&o(e):(this.tokenLoaded=!0,this.xhrParams.token=t.token,this.xhrParams.tokenHeader=t.header,this.tokenExpiration=1e3*t.expires,this.tokenExpirationCallback=function(){this.tokenExpiration=null,this.tokenExpirationLoop=!0,"string"==typeof this.config.authorization?va.loadJSON(this.config.authorization,s,a,null,va.useCredentials,this.xhrParams):this.config.authorization(s)}.bind(this),this.tokenExpirationLoop||o(e),"string"==typeof this.config.authorization?h(t.cookieInjector,this.config.authorization):h(t.cookieInjector,e))}.bind(this),a=function(){console.log("auth token not loaded"),this.tokenCanBeSkiped&&o(e)}.bind(this),n=function(){document.body.removeChild(this.tokenIFrame),this.tokenIFrame=null,this.tokenCookieLoaded=!0,t()}.bind(this),o=function(e){va.loadJSON(e,i,r,null,va.useCredentials,this.xhrParams)}.bind(this),h=function(e,t){e=ya.getProcessUrl(e,t),this.tokenCookieHost=ya.getHost(e);var i=document.createElement("iframe");this.tokenIFrame=i,i.onload=n,i.src=e,i.style.display="none",document.body.appendChild(i)}.bind(this);this.config.authorization?(this.tokenCookieLoaded=!1,"string"==typeof this.config.authorization?va.loadJSON(this.config.authorization,s,a,null,va.useCredentials,this.xhrParams):this.config.authorization(s)):o(e)}},xa.prototype.destroy=function(){this.killed||(this.destroyMap(),this.renderer&&this.renderer.kill(),this.element=null,this.killed=!0)},xa.prototype.destroyMap=function(){this.map&&(this.map.kill(),this.map=null,this.mapInterface=null,this.callListener("map-unloaded",{}))},xa.prototype.getMap=function(){return this.map},xa.prototype.getMapInterface=function(){return this.mapInterface},xa.prototype.getRenderer=function(){return this.renderer},xa.prototype.getRendererInterface=function(){return this.rendererInterface},xa.prototype.getProj4=function(){return this.proj4},xa.prototype.getOption=function(){},xa.prototype.setOption=function(){},xa.prototype.on=function(e,t,i,r){if(!this.killed&&null!=t)return this.listenerCounter++,this.listeners.push({name:e,listener:t,id:this.listenerCounter,once:r,wait:i||0}),function(e){this.removeListener(e)}.bind(this,this.listenerCounter)},xa.prototype.once=function(e,t,i){this.on(e,t,i,!0)},xa.prototype.callListener=function(e,t,i){for(var r=0;r<this.listeners.length;r++)if(this.listeners[r].name==e){var s=this.listeners[r];s.wait>0?s.wait--:(s.listener(t),s.once&&(this.listeners.splice(r,1),r--))}i&&console.log("event "+e+": "+JSON.stringify(t))},xa.prototype.removeListener=function(e){for(var t=0;t<this.listeners.length;t++)if(this.listeners[t].id==e)return void this.listeners.splice(t,1)},xa.prototype.markDirty=function(){null!=this.map&&this.map.markDirty()},xa.prototype.onUpdate=function(){this.killed||this.contextLost||(null!=this.map&&(!this.map.srsReady&&this.map.isReferenceFrameReady()&&(this.map.srsReady=!0,this.callListener("map-loaded",{browserOptions:this.map.browserOptions})),this.map.update()),this.callListener("tick",{}),this.requestAnimFrame.call(window,this.onUpdate.bind(this)))},xa.prototype.setConfigParams=function(e,t){if("object"==typeof e&&null!==e)for(var i in e)this.setConfigParam(i,e[i],t)},xa.prototype.setConfigParam=function(e,t,i){switch(e){case"pos":case"position":case"view":this.getMap()?("view"==e?this.getMap().setView(t):this.getMap().setPosition(new ga(t)),this.configStorage[e]&&delete this.configStorage[e]):this.configStorage[e]=t;break;case"map":this.config.map=va.validateString(t,null);break;case"mapVirtualSurfaces":this.config.mapVirtualSurfaces=va.validateBool(t,!0);break;case"mapForcePipeline":this.config.mapForcePipeline=va.validateNumber(t,-1,Number.MAXINTEGER,0);break;case"mapDMapSize":this.config.mapDMapSize=va.validateNumber(t,16,Number.MAXINTEGER,512);break;case"mapDMapMode":this.config.mapDMapMode=va.validateNumber(t,1,Number.MAXINTEGER,1);break;case"map16bitMeshes":this.config.map16bitMeshes=va.validateBool(t,!1);break;case"inspector":this.config.inspector=va.validateBool(t,!0);break;case"authorization":this.config.authorization="string"==typeof t||"function"==typeof t?t:null;break;default:0!=e.indexOf("map")&&"mario"!=e||(i&&void 0!==this.configStorage[e]||(this.configStorage[e]=t),null!=this.getMap()&&this.getMap().setConfigParam(e,t)),0==e.indexOf("renderer")&&(i&&void 0!==this.configStorage[e]||(this.configStorage[e]=t),this.setRendererConfigParam(e,t)),0==e.indexOf("debug")&&(this.configStorage[e]=t,null!=this.getMap()&&this.inspector.setParameter(e,t))}},xa.prototype.getConfigParam=function(e){return"map"==e?this.config.map:"inspector"==e?this.config.inspector:0==e.indexOf("map")&&null!=this.getMap()?this.getMap().getConfigParam(e):0==e.indexOf("renderer")?this.getRendererConfigParam(e):void 0},xa.prototype.setRendererConfigParam=function(e,t){switch(e){case"rendererAnisotropic":this.config.rendererAnisotropic=va.validateNumber(t,-1,2048,0),this.rederer&&this.rederer.gpu.setAniso(this.config.rendererAnisotropic);break;case"rendererAntialiasing":this.config.rendererAntialiasing=va.validateBool(t,!0);break;case"rendererAllowScreenshots":this.config.rendererAllowScreenshots=va.validateBool(t,!1)}},xa.prototype.getRendererConfigParam=function(e){switch(e){case"rendererAnisotropic":return this.config.rendererAnisotropic;case"rendererAntialiasing":return this.config.rendererAntialiasing;case"rendererAllowScreenshots":return this.config.rendererAllowScreenshots}}},function(e,t,i){"use strict";function r(e,t,i){i=i||2;var r,o,h,l,u,p,f,m=t&&t.length,v=m?t[0]*i:e.length,y=s(e,0,v,i,!0),b=[];if(!y||y.next===y.prev)return b;if(m&&(y=function(e,t,i,r){var n,o,h,l,u,p=[];for(n=0,o=t.length;n<o;n++)h=t[n]*r,l=n<o-1?t[n+1]*r:e.length,(u=s(e,h,l,r,!1))===u.next&&(u.steiner=!0),p.push(g(u));for(p.sort(c),n=0;n<p.length;n++)d(p[n],i),i=a(i,i.next);return i}(e,t,y,i)),e.length>80*i){r=h=e[0],o=l=e[1];for(var x=i;x<v;x+=i)(u=e[x])<r&&(r=u),(p=e[x+1])<o&&(o=p),u>h&&(h=u),p>l&&(l=p);f=0!==(f=Math.max(h-r,l-o))?1/f:0}return n(y,b,i,r,o,f),b}function s(e,t,i,r,s){var a,n;if(s===F(e,t,i,r)>0)for(a=t;a<i;a+=r)n=C(a,e[a],e[a+1],n);else for(a=i-r;a>=t;a-=r)n=C(a,e[a],e[a+1],n);return n&&b(n,n.next)&&(T(n),n=n.next),n}function a(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!b(r,r.next)&&0!==y(r.prev,r,r.next))r=r.next;else{if(T(r),(r=t=r.prev)===r.next)break;i=!0}}while(i||r!==t);return t}function n(e,t,i,r,s,c,d){if(e){!d&&c&&function(e,t,i,r){var s=e;do{null===s.z&&(s.z=f(s.x,s.y,t,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,i,r,s,a,n,o,h,l=1;do{for(i=e,e=null,a=null,n=0;i;){for(n++,r=i,o=0,t=0;t<l&&(o++,r=r.nextZ);t++);for(h=l;o>0||h>0&&r;)0!==o&&(0===h||!r||i.z<=r.z)?(s=i,i=i.nextZ,o--):(s=r,r=r.nextZ,h--),a?a.nextZ=s:e=s,s.prevZ=a,a=s;i=r}a.nextZ=null,l*=2}while(n>1)}(s)}(e,r,s,c);for(var p,g,m=e;e.prev!==e.next;)if(p=e.prev,g=e.next,c?h(e,r,s,c):o(e))t.push(p.i/i),t.push(e.i/i),t.push(g.i/i),T(e),e=g.next,m=g.next;else if((e=g)===m){d?1===d?n(e=l(a(e),t,i),t,i,r,s,c,2):2===d&&u(e,t,i,r,s,c):n(a(e),t,i,r,s,c,1);break}}}function o(e){var t=e.prev,i=e,r=e.next;if(y(t,i,r)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if(m(t.x,t.y,i.x,i.y,r.x,r.y,s.x,s.y)&&y(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function h(e,t,i,r){var s=e.prev,a=e,n=e.next;if(y(s,a,n)>=0)return!1;for(var o=s.x<a.x?s.x<n.x?s.x:n.x:a.x<n.x?a.x:n.x,h=s.y<a.y?s.y<n.y?s.y:n.y:a.y<n.y?a.y:n.y,l=s.x>a.x?s.x>n.x?s.x:n.x:a.x>n.x?a.x:n.x,u=s.y>a.y?s.y>n.y?s.y:n.y:a.y>n.y?a.y:n.y,c=f(o,h,t,i,r),d=f(l,u,t,i,r),p=e.prevZ,g=e.nextZ;p&&p.z>=c&&g&&g.z<=d;){if(p!==e.prev&&p!==e.next&&m(s.x,s.y,a.x,a.y,n.x,n.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,g!==e.prev&&g!==e.next&&m(s.x,s.y,a.x,a.y,n.x,n.y,g.x,g.y)&&y(g.prev,g,g.next)>=0)return!1;g=g.nextZ}for(;p&&p.z>=c;){if(p!==e.prev&&p!==e.next&&m(s.x,s.y,a.x,a.y,n.x,n.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;g&&g.z<=d;){if(g!==e.prev&&g!==e.next&&m(s.x,s.y,a.x,a.y,n.x,n.y,g.x,g.y)&&y(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function l(e,t,i){var r=e;do{var s=r.prev,n=r.next.next;!b(s,n)&&x(s,r,r.next,n)&&S(s,n)&&S(n,s)&&(t.push(s.i/i),t.push(r.i/i),t.push(n.i/i),T(r),T(r.next),r=e=n),r=r.next}while(r!==e);return a(r)}function u(e,t,i,r,s,o){var h=e;do{for(var l=h.next.next;l!==h.prev;){if(h.i!==l.i&&v(h,l)){var u=A(h,l);return h=a(h,h.next),u=a(u,u.next),n(h,t,i,r,s,o),void n(u,t,i,r,s,o)}l=l.next}h=h.next}while(h!==e)}function c(e,t){return e.x-t.x}function d(e,t){if(t=function(e,t){var i,r=t,s=e.x,a=e.y,n=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var o=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=s&&o>n){if(n=o,o===s){if(a===r.y)return r;if(a===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(s===n)return i;var h,l=i,u=i.x,c=i.y,d=1/0;r=i;do{s>=r.x&&r.x>=u&&s!==r.x&&m(a<c?s:n,a,u,c,a<c?n:s,a,r.x,r.y)&&(h=Math.abs(a-r.y)/(s-r.x),S(r,e)&&(h<d||h===d&&(r.x>i.x||r.x===i.x&&p(i,r)))&&(i=r,d=h)),r=r.next}while(r!==l);return i}(e,t)){var i=A(t,e);a(t,t.next),a(i,i.next)}}function p(e,t){return y(e.prev,e,t.prev)<0&&y(t.next,e,e.next)<0}function f(e,t,i,r,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function g(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function m(e,t,i,r,s,a,n,o){return(s-n)*(t-o)-(e-n)*(a-o)>=0&&(e-n)*(r-o)-(i-n)*(t-o)>=0&&(i-n)*(a-o)-(s-n)*(r-o)>=0}function v(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&x(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(S(e,t)&&S(t,e)&&function(e,t){var i=e,r=!1,s=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&s<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)&&(y(e.prev,e,t.prev)||y(e,t.prev,t))||b(e,t)&&y(e.prev,e,e.next)>0&&y(t.prev,t,t.next)>0)}function y(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function b(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,i,r){var s=M(y(e,t,i)),a=M(y(e,t,r)),n=M(y(i,r,e)),o=M(y(i,r,t));return s!==a&&n!==o||(!(0!==s||!w(e,i,t))||(!(0!==a||!w(e,r,t))||(!(0!==n||!w(i,e,r))||!(0!==o||!w(i,t,r)))))}function w(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function M(e){return e>0?1:e<0?-1:0}function S(e,t){return y(e.prev,e,e.next)<0?y(e,t,e.next)>=0&&y(e,e.prev,t)>=0:y(e,t,e.prev)<0||y(e,e.next,t)<0}function A(e,t){var i=new P(e.i,e.x,e.y),r=new P(t.i,t.x,t.y),s=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=s,s.prev=i,r.next=i,i.prev=r,a.next=r,r.prev=a,r}function C(e,t,i,r){var s=new P(e,t,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function T(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function P(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function F(e,t,i,r){for(var s=0,a=t,n=i-r;a<i;a+=r)s+=(e[n]-e[a])*(e[a+1]+e[n+1]),n=a;return s}e.exports=r,e.exports.default=r,r.deviation=function(e,t,i,r){var s=t&&t.length,a=s?t[0]*i:e.length,n=Math.abs(F(e,0,a,i));if(s)for(var o=0,h=t.length;o<h;o++){var l=t[o]*i,u=o<h-1?t[o+1]*i:e.length;n-=Math.abs(F(e,l,u,i))}var c=0;for(o=0;o<r.length;o+=3){var d=r[o]*i,p=r[o+1]*i,f=r[o+2]*i;c+=Math.abs((e[d]-e[f])*(e[p+1]-e[d+1])-(e[d]-e[p])*(e[f+1]-e[d+1]))}return 0===n&&0===c?0:Math.abs((c-n)/n)},r.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,s=0;s<e.length;s++){for(var a=0;a<e[s].length;a++)for(var n=0;n<t;n++)i.vertices.push(e[s][a][n]);s>0&&(r+=e[s-1].length,i.holes.push(r))}return i}},function(e){e.exports=JSON.parse('{"a":"2.4.5"}')},function(e,t,i){"use strict";var r=window.URL||window.webkitURL;e.exports=function(e,t){try{try{var i;try{(i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(e),i=i.getBlob()}catch(t){i=new Blob([e])}return new Worker(r.createObjectURL(i))}catch(t){return new Worker("data:application/javascript,"+encodeURIComponent(e))}}catch(e){if(!t)throw Error("Inline worker is not supported");return new Worker(t)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";var _utils_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_utils_url__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(3),utilsUrl=_utils_url__WEBPACK_IMPORTED_MODULE_1__.a,utils=_utils_utils__WEBPACK_IMPORTED_MODULE_0__.a,MapUrl=function(e,t){this.map=e,t=t.trim(),this.baseUrl=utilsUrl.getBase(t),this.baseUrlSchema=utilsUrl.getSchema(t),this.baseUrlOrigin=utilsUrl.getOrigin(t),this.urlCounter=0};MapUrl.prototype.quad=function(e,t,i){for(var r="",s=e;s>0;s--){var a=0,n=1<<s-1;0!=(t&n)&&(a+=1),0!=(i&n)&&(a+=2),r+=a}return r},MapUrl.prototype.msDigit=function(e,t){return((3&e)<<1)+(1&t)},MapUrl.prototype.hex=function(e){for(var t=e.toString(16);t.length<8;)t="0"+t;return t},MapUrl.prototype.ppx=function(e,t){return this.hex(t<<28-e,7)},MapUrl.prototype.ppy=function(e,t){return this.hex((1<<28)-(t+1<<28-e),7)},MapUrl.prototype.processUrlFunction=function(id,counter,string){var string2,fc;if("string"!=typeof string)return string;if(-1!=string.indexOf("quad")){string2="(function(lod,x,y,loclod,locx,locy){"+string.replace("quad","return this.quad")+"})";try{return fc=eval(string2).bind(this),fc(id.lod,id.ix,id.iy,id.loclod,id.locx,id.locy)}catch(e){return string}}else if(-1!=string.indexOf("msdigit")){string2="(function(x,y,loclod,locx,locy){"+string.replace("msdigit","return this.msDigit")+"})";try{return fc=eval(string2).bind(this),fc(id.ix,id.iy,id.loclod,id.locx,id.locy)}catch(e){return string}}else{if(-1!=string.indexOf("alt")){var result=/\(([^)]*)\)/.exec(string);if(result&&result[1]){var strings=result[1].match(/([^,]+)/g);if(strings.length>0)return strings[counter%strings.length]}return string}if(-1!=string.indexOf("ppx")){string2="(function(lod,x,loclod,locx){"+string.replace("ppx","return this.ppx")+"})";try{return fc=eval(string2).bind(this),fc(id.lod,id.ix,id.loclod,id.locx)}catch(e){return string}}else{if(-1==string.indexOf("ppy"))return string;string2="(function(lod,y,loclod,locy){"+string.replace("ppy","return this.ppy")+"})";try{return fc=eval(string2).bind(this),fc(id.lod,id.iy,id.loclod,id.locy)}catch(e){return string}}}},MapUrl.prototype.findLocalRoot=function(e){for(var t=this.map.referenceFrame.getSpatialDivisionNodes(),i=[],r=0,s=t.length;r<s;r++){var a=t[r],n=e[0]-a.id[0],o=e[1]>>n,h=e[2]>>n;o==a.id[1]&&h==a.id[2]&&i.push(a)}var l=null;for(r=0,s=i.length;r<s;r++)i[r].id[0]>-1&&(l=i[r]);return l?l.id.slice():[0,0,0]},MapUrl.prototype.makeUrl=function(e,t,i,r){var s=0,a=0,n=0;if(t.lod){var o=this.findLocalRoot([t.lod,t.ix,t.iy]),h=(1<<(n=t.lod-o[0]))-1;s=t.ix&h,a=t.iy&h}var l={lod:t.lod,ix:t.ix,iy:t.iy,loclod:n,locx:s,locy:a};e=e.replace(/ /g,"");var u=utils.simpleFmtObjOrCall(e,{lod:t.lod,x:t.ix,y:t.iy,sub:i,locx:s,locy:a,loclod:n,geonavtile:i,hereappid:"abcde",hereappcode:"12345"},this.processUrlFunction.bind(this,l,this.urlCounter));return this.urlCounter++,-1!=u.indexOf("//")?0==u.indexOf("//")?this.baseUrlSchema+u:u:this.baseUrl+u},MapUrl.prototype.processUrl=function(e,t){return e?-1!=(e=e.trim()).indexOf("://")?e:0==e.indexOf("//")?this.baseUrlSchema+e:0==e.indexOf("/")?this.baseUrlOrigin+e:this.baseUrl+e:t},__webpack_exports__.a=MapUrl},function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i(6),s=i(8),a=i.n(s),n=i(7).a,o=r.a,h=function(e,t){this.core=new n(e,t,this),Object.defineProperty(this,"map",{get:function(){return this.core?this.core.getMapInterface():null}}),Object.defineProperty(this,"renderer",{get:function(){return this.core?this.core.getRendererInterface():null}}),Object.defineProperty(this,"proj4",{get:function(){return this.core?o:null}}),Object.defineProperty(this,"earcut",{get:function(){return this.core?a.a:null}})};h.prototype.destroy=function(){this.core.destroy(),this.core=null},h.prototype.loadMap=function(e){return this.core?this.core.loadMap(e):null},h.prototype.destroyMap=function(){return this.core?this.core.destroyMap():null},h.prototype.on=function(e,t){return this.core?this.core.on(e,t):null},h.prototype.once=function(e,t,i){return this.core?this.core.once(e,t,i):null},h.prototype.callListener=function(e,t){if(!this.core)return null;this.core.callListener(e,t)}},function(e,t,i){e.exports=function(){return i(10)('/*!\n * Copyright (c) 2020 Melown Technologies SE\n *  *  For terms of use, see accompanying main file.\n *  *  For 3rd party libraries licenses, see 3rdpartylicenses.txt.\n * \n */!function(e){var r={};function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var a in e)t.d(n,a,function(r){return e[r]}.bind(null,a));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=0)}([function(e,r,t){"use strict";t.r(r);var n={stylesheetData:{},stylesheetLayers:{},stylesheetBitmaps:{},stylesheetFonts:{},stylesheetConstants:{},stylesheetVariables:{},insidePack:!1,directPoints:[],directPoint:null,fonts:{},fontsMap:{},fontsStorage:{},forceOrigin:!1,forceScale:[1,1,1],bboxMin:[0,0,0],bboxMax:[1,1,1],geocent:!1,tileX:0,tileY:0,tileLod:0,tileIX:0,tileIY:0,tileSize:1,hitState:0,pixelFactor:1,alwaysEventInfo:!0,metricUnits:!0,language:"en",groupOptimize:!0,groupOrigin:[0,0,0],messageBuffer:new Array(65536),messageBufferIndex:0,messageBufferSize:65536,messagePackSize:0,signatureCounter:0,autoLod:!1,featureType:null,groupId:null,disableLog:!1,reduceMode:"scr-count4",reduceParams:null,processLineLabel:!1,useLineLabel2:!0,lineLabelPass:0};function a(e,r,t){return e<r&&(e=r),e>t&&(e=t),e}function s(e,r){r||(r=e);var t=e[0],n=e[1],a=e[2],s=Math.sqrt(t*t+n*n+a*a);return s?1==s?(r[0]=t,r[1]=n,r[2]=a,r):(s=1/s,r[0]=t*s,r[1]=n*s,r[2]=a*s,r):(r[0]=0,r[1]=0,r[2]=0,r)}function i(e,r,t){t||(t=e);var n=e[0],a=e[1];e=e[2];var s=r[0],i=r[1];return r=r[2],t[0]=a*r-e*i,t[1]=e*s-n*r,t[2]=n*i-a*s,t}var o="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):null;var l="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;var u=["BN","BN","BN","BN","BN","BN","BN","BN","BN","S","B","S","WS","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","B","B","B","S","WS","ON","ON","ET","ET","ET","ON","ON","ON","ON","ON","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","ON","ON","ON","ON","ON","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","ON","ON","ON","ON","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","ON","ON","ON","BN","BN","BN","BN","BN","BN","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","CS","ON","ET","ET","ET","ET","ON","ON","ON","ON","L","ON","ON","BN","ON","ON","ET","ET","EN","EN","ON","L","ON","ON","ON","EN","L","ON","ON","ON","ON","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","ON","L","L","L","L","L","L","L","L"],c=["AN","AN","AN","AN","AN","AN","ON","ON","AL","ET","ET","AL","CS","AL","ON","ON","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","AN","AN","AN","AN","AN","AN","AN","AN","AN","ET","AN","AN","AL","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","ON","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","NSM","NSM","ON","NSM","NSM","NSM","NSM","AL","AL","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","AL","AL","AL","AL","AL","AL"];function f(e){return 0!=(1&e)}function h(e){return 0==(1&e)}function v(e,r,t){for(var n=r,a=e.length;n<a;++n)if(e[n]!==t)return n;return n}function d(e,r,t,n){for(var a=r;a<t;++a)e[a]=n}function b(e,r,t,n){for(var a=t,s=n-1;a<s;++a,--s){var i=e[a];e[a]=e[s],e[s]=i,i=r[a],r[a]=r[s],r[s]=i}}function g(e,r,t){return{str:e,indices:L,types:y,dir:t?"ttb":r?"ltr":"rtl"}}var p=[],y=[],L=[];var A=function(e,r,t){var n=!0,a=e.length;if(0===a||t)return g(e,n,t);p.length=a,y.length=a;var s,i,o=0;for(s=0;s<a;++s){p[s]=e.charAt(s),L[s]=s;var l=e.charCodeAt(s),A="L";l<=255?A=u[l]:1424<=l&&l<=1524?A="R":1536<=l&&l<=1791?A=c[255&l]:1792<=l&&l<=2220&&(A="AL"),"R"!==A&&"AL"!==A&&"AN"!==A||o++,y[s]=A}if(0===o)return g(e,n=!0);-1===r&&(o/a<.3?(n=!0,r=0):(n=!1,r=1));var m=[];for(s=0;s<a;++s)m[s]=r;var N,U=f(r)?"R":"L",w=U,x=w,S=w;for(s=0;s<a;++s)"NSM"===y[s]?y[s]=S:S=y[s];for(S=w,s=0;s<a;++s)"EN"===(N=y[s])?y[s]="AL"===S?"AN":"EN":"R"!==N&&"L"!==N&&"AL"!==N||(S=N);for(s=0;s<a;++s)"AL"===(N=y[s])&&(y[s]="R");for(s=1;s<a-1;++s)"ES"===y[s]&&"EN"===y[s-1]&&"EN"===y[s+1]&&(y[s]="EN"),"CS"!==y[s]||"EN"!==y[s-1]&&"AN"!==y[s-1]||y[s+1]!==y[s-1]||(y[s]=y[s-1]);for(s=0;s<a;++s)if("EN"===y[s]){var M;for(M=s-1;M>=0&&"ET"===y[M];--M)y[M]="EN";for(M=s+1;M<a&&"ET"===y[M];++M)y[M]="EN"}for(s=0;s<a;++s)"WS"!==(N=y[s])&&"ES"!==N&&"ET"!==N&&"CS"!==N||(y[s]="ON");for(S=w,s=0;s<a;++s)"EN"===(N=y[s])?y[s]="L"===S?"L":"EN":"R"!==N&&"L"!==N||(S=N);for(s=0;s<a;++s)if("ON"===y[s]){var B=v(y,s+1,"ON"),O=w;s>0&&(O=y[s-1]);var _=x;B+1<a&&(_=y[B+1]),"L"!==O&&(O="R"),"L"!==_&&(_="R"),O===_&&d(y,s,B,O),s=B-1}for(s=0;s<a;++s)"ON"===y[s]&&(y[s]=U);for(s=0;s<a;++s)N=y[s],h(m[s])?"R"===N?m[s]+=1:"AN"!==N&&"EN"!==N||(m[s]+=2):"L"!==N&&"AN"!==N&&"EN"!==N||(m[s]+=1);var k,I=-1,E=99;for(s=0,i=m.length;s<i;++s)I<(k=m[s])&&(I=k),E>k&&f(k)&&(E=k);for(k=I;k>=E;--k){var C=-1;for(s=0,i=m.length;s<i;++s)m[s]<k?C>=0&&(b(p,L,C,s),C=-1):C<0&&(C=s);C>=0&&b(p,L,C,m.length)}for(s=0,i=p.length;s<i;++s){var F=p[s];"<"!==F&&">"!==F||(p[s]="")}return g(p.join(""),n)},m={parse:function(e){var r=m._bin,t=new Uint8Array(e),n=0;r.readFixed(t,n);n+=4;var a=r.readUshort(t,n);n+=2;r.readUshort(t,n);n+=2;r.readUshort(t,n);n+=2;r.readUshort(t,n);n+=2;for(var s=["cmap","head","hhea","maxp","hmtx","kern","GPOS","GSUB"],i={_data:t},o={},l=0,u=0;u<a;u++){var c=r.readASCII(t,n,4);n+=4;r.readUint(t,n);n+=4;var f=r.readUint(t,n);n+=4;var h=r.readUint(t,n);n+=4,o[c]={offset:f,length:h},l=f+h}for(u=0;u<s.length;u++){var v=s[u];o[v]&&(i[v.trim()]=m[v.trim()].parse(t,o[v].offset,o[v].length,i))}i._tabs=o,m._processGlyphs(t,l,o,i);var d=i.GSUB;if(d){var b=d.lookupList,g=d.featureList;i.gsubIsolTable=[],i.gsubInitTable=[],i.gsubFinaTable=[],i.gsubMediTable=[],i.gsubRligLigaTable=[];for(var p=0;p<g.length;p++){switch(c=g[p].tag){case"isol":case"init":case"fina":case"medi":for(var y=0;y<g[p].tab.length;y++){if(1==(L=b[g[p].tab[y]]).ltype)switch(c){case"isol":i.gsubIsolTable.push(L.tabs);break;case"init":i.gsubInitTable.push(L.tabs);break;case"fina":i.gsubFinaTable.push(L.tabs);break;case"medi":i.gsubMediTable.push(L.tabs)}}break;case"rlig":case"liga":for(y=0;y<g[p].tab.length;y++){var L;4==(L=b[g[p].tab[y]]).ltype&&i.gsubRligLigaTable.push(L.tabs)}}}}return i},_processGlyphs:function(e,r,t,n){var a=e[r],s=e[r+=1]<<8|e[r+1],i=e[r+=2]<<8|e[r+1],o=e[r+=2],l=e[r+=1];r+=1,n.version=a,n.textureLX=s,n.textureLY=i,n.size=o,n.cly=1.5*o,n.flags=l;var u=new Array(n.maxp.numGlyphs),c=1/s,f=1/i,h=s>256?7:6,v=r+n.maxp.numGlyphs*h,d=e[v]<<8|e[v+1],b=new Array(d);v+=2;for(var g=0,p=d;g<p;g++)b[g]=e[v+2*g]<<8|e[v+2*g+1];var y=0;for(g=0,p=n.maxp.numGlyphs;g<p;g++)g==b[y]&&y++,u[g]=m._processGlyph(e,r,c,f,s,n,g,y),r+=h;n.glyphs=u},_processGlyph:function(e,r,t,n,a,s,i,o){var l=e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3],u=l>>22&63,c=l>>16&63,f=(l>>9&63)*(l>>15&1?-1:1),h=-(l>>2&63)*(l>>8&1?-1:1),v=(3&l)+4*o;l=a>256?e[r+4]<<16|e[r+5]<<8|e[r+6]:e[r+4]<<8|e[r+5];var d,b,g=s.size/.75/s.head.unitsPerEm*.75,p=s.hmtx.aWidth[i]*g;switch(a){case 2048:d=l>>11&2047,b=2047&l;break;case 1024:d=l>>10&1023,b=1023&l;break;case 512:d=l>>9&511,b=511&l;break;default:d=l>>8&255,b=255&l}return{u1:d*t,v1:b*n+v,u2:(d+u)*t,v2:(b+c)*n+v,lx:u,ly:c,sx:f,sy:h,step:p,plane:v}},_tabOffset:function(e,r){for(var t=m._bin,n=t.readUshort(e,4),a=12,s=0;s<n;s++){var i=t.readASCII(e,a,4);a+=4;t.readUint(e,a);a+=4;var o=t.readUint(e,a);a+=4;t.readUint(e,a);if(a+=4,i==r)return o}return 0}};m._bin={readFixed:function(e,r){return(e[r]<<8|e[r+1])+(e[r+2]<<8|e[r+3])/65540},readF2dot14:function(e,r){var t=m._bin.readShort(e,r);return t/16384},readInt:function(e,r){var t=m._bin.t.uint8;return t[0]=e[r+3],t[1]=e[r+2],t[2]=e[r+1],t[3]=e[r],m._bin.t.int32[0]},readInt8:function(e,r){return m._bin.t.uint8[0]=e[r],m._bin.t.int8[0]},readShort:function(e,r){var t=m._bin.t.uint8;return t[1]=e[r],t[0]=e[r+1],m._bin.t.int16[0]},readUshort:function(e,r){return e[r]<<8|e[r+1]},readUshorts:function(e,r,t){for(var n=[],a=0;a<t;a++)n.push(m._bin.readUshort(e,r+2*a));return n},readUint:function(e,r){var t=m._bin.t.uint8;return t[3]=e[r],t[2]=e[r+1],t[1]=e[r+2],t[0]=e[r+3],m._bin.t.uint32[0]},readUint64:function(e,r){return 4294967296*m._bin.readUint(e,r)+m._bin.readUint(e,r+4)},readASCII:function(e,r,t){for(var n="",a=0;a<t;a++)n+=String.fromCharCode(e[r+a]);return n},readUnicode:function(e,r,t){for(var n="",a=0;a<t;a++){var s=e[r++]<<8|e[r++];n+=String.fromCharCode(s)}return n},readBytes:function(e,r,t){for(var n=[],a=0;a<t;a++)n.push(e[r+a]);return n},readASCIIArray:function(e,r,t){for(var n=[],a=0;a<t;a++)n.push(String.fromCharCode(e[r+a]));return n}},m._bin.t={buff:new ArrayBuffer(8)},m._bin.t.int8=new Int8Array(m._bin.t.buff),m._bin.t.uint8=new Uint8Array(m._bin.t.buff),m._bin.t.int16=new Int16Array(m._bin.t.buff),m._bin.t.uint16=new Uint16Array(m._bin.t.buff),m._bin.t.int32=new Int32Array(m._bin.t.buff),m._bin.t.uint32=new Uint32Array(m._bin.t.buff),m._lctf={},m._lctf.parse=function(e,r,t,n,a){var s=m._bin,i={},o=r;s.readFixed(e,r);r+=4;var l=s.readUshort(e,r);r+=2;var u=s.readUshort(e,r);r+=2;var c=s.readUshort(e,r);return r+=2,i.scriptList=m._lctf.readScriptList(e,o+l),i.featureList=m._lctf.readFeatureList(e,o+u),i.lookupList=m._lctf.readLookupList(e,o+c,a),i},m._lctf.readLookupList=function(e,r,t){var n=m._bin,a=r,s=[],i=n.readUshort(e,r);r+=2;for(var o=0;o<i;o++){var l=n.readUshort(e,r);r+=2;var u=m._lctf.readLookupTable(e,a+l,t);s.push(u)}return s},m._lctf.readLookupTable=function(e,r,t){var n=m._bin,a=r,s={tabs:[]};s.ltype=n.readUshort(e,r),r+=2,s.flag=n.readUshort(e,r),r+=2;var i=n.readUshort(e,r);r+=2;for(var o=0;o<i;o++){var l=n.readUshort(e,r);r+=2;var u=t(e,s.ltype,a+l);s.tabs.push(u)}return s},m._lctf.numOfOnes=function(e){for(var r=0,t=0;t<32;t++)0!=(e>>>t&1)&&r++;return r},m._lctf.readClassDef=function(e,r){var t=m._bin,n={start:[],end:[],class:[]},a=t.readUshort(e,r);if(r+=2,1==a){var s=t.readUshort(e,r);r+=2;var i=t.readUshort(e,r);r+=2;for(var o=0;o<i;o++)n.start.push(s+o),n.end.push(s+o),n.class.push(t.readUshort(e,r)),r+=2}if(2==a){var l=t.readUshort(e,r);r+=2;for(o=0;o<l;o++)n.start.push(t.readUshort(e,r)),r+=2,n.end.push(t.readUshort(e,r)),r+=2,n.class.push(t.readUshort(e,r)),r+=2}return n},m._lctf.readValueRecord=function(e,r,t){var n=m._bin,a=[];return a.push(1&t?n.readShort(e,r):0),r+=1&t?2:0,a.push(2&t?n.readShort(e,r):0),r+=2&t?2:0,a.push(4&t?n.readShort(e,r):0),r+=4&t?2:0,a.push(8&t?n.readShort(e,r):0),r+=8&t?2:0,a},m._lctf.readCoverage=function(e,r){var t=m._bin,n={};n.fmt=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2,1==n.fmt&&(n.tab=t.readUshorts(e,r,a)),2==n.fmt&&(n.tab=t.readUshorts(e,r,3*a));var s=Number.POSITIVE_INFINITY,i=0,o=n.tab;if(1==n.fmt)for(var l=0;l<o.length;l++){var u=o[l];u>i&&(i=u),u<s&&(s=u)}if(2==n.fmt)for(l=0;l<o.length;l+=3){var c=o[l],f=o[l+1];c>i&&(i=c),c<s&&(s=c),f>i&&(i=f),f<s&&(s=f)}return n.min=s,n.max=i,n},m._lctf.coverageIndex=function(e,r){if(r<e.min||r>e.max)return-1;var t=e.tab;if(1==e.fmt)return t.indexOf(r);for(var n=0;n<t.length;n+=3){var a=t[n],s=t[n+1],i=t[n+2];if(a<=r&&r<=s)return i+(r-a)}return-1},m._lctf.readFeatureList=function(e,r){var t=m._bin,n=r,a=[],s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readASCII(e,r,4);r+=4;var l=t.readUshort(e,r);r+=2,a.push({tag:o.trim(),tab:m._lctf.readFeatureTable(e,n+l)})}return a},m._lctf.readFeatureTable=function(e,r){var t=m._bin;t.readUshort(e,r);r+=2;var n=t.readUshort(e,r);r+=2;for(var a=[],s=0;s<n;s++)a.push(t.readUshort(e,r+2*s));return a},m._lctf.readScriptList=function(e,r){var t=m._bin,n=r,a={},s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readASCII(e,r,4);r+=4;var l=t.readUshort(e,r);r+=2,a[o.trim()]=m._lctf.readScriptTable(e,n+l)}return a},m._lctf.readScriptTable=function(e,r){var t=m._bin,n=r,a={},s=t.readUshort(e,r);r+=2,a.default=m._lctf.readLangSysTable(e,n+s);var i=t.readUshort(e,r);r+=2;for(var o=0;o<i;o++){var l=t.readASCII(e,r,4);r+=4;var u=t.readUshort(e,r);r+=2,a[l.trim()]=m._lctf.readLangSysTable(e,n+u)}return a},m._lctf.readLangSysTable=function(e,r){var t=m._bin,n={};t.readUshort(e,r);r+=2,n.reqFeature=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);return r+=2,n.features=t.readUshorts(e,r,a),n},m.cmap={},m.cmap.parse=function(e,r,t){e=new Uint8Array(e.buffer,r,t);r=0;var n=m._bin,a={};n.readUshort(e,r);r+=2;var s=n.readUshort(e,r);r+=2;var i=[];a.tables=[];for(var o=0;o<s;o++){var l=n.readUshort(e,r);r+=2;var u=n.readUshort(e,r);r+=2;var c=n.readUint(e,r);r+=4;var f="p"+l+"e"+u,h=i.indexOf(c);if(-1==h){var v;h=a.tables.length,i.push(c);var d=n.readUshort(e,c);0==d?v=m.cmap.parse0(e,c):4==d?v=m.cmap.parse4(e,c):6==d?v=m.cmap.parse6(e,c):12==d?v=m.cmap.parse12(e,c):console.log("unknown format: "+d,l,u,c),a.tables.push(v)}if(null!=a[f])throw"multiple tables for one platform+encoding";a[f]=h}return a},m.cmap.parse0=function(e,r){var t=m._bin,n={};n.format=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2;t.readUshort(e,r);r+=2,n.map=[];for(var s=0;s<a-6;s++)n.map.push(e[r+s]);return n},m.cmap.parse4=function(e,r){var t=m._bin,n=r,a={};a.format=t.readUshort(e,r),r+=2;var s=t.readUshort(e,r);r+=2;t.readUshort(e,r);r+=2;var i=t.readUshort(e,r);r+=2;var o=i/2;a.searchRange=t.readUshort(e,r),r+=2,a.entrySelector=t.readUshort(e,r),r+=2,a.rangeShift=t.readUshort(e,r),r+=2,a.endCount=t.readUshorts(e,r,o),r+=2*o,r+=2,a.startCount=t.readUshorts(e,r,o),r+=2*o,a.idDelta=[];for(var l=0;l<o;l++)a.idDelta.push(t.readShort(e,r)),r+=2;for(a.idRangeOffset=t.readUshorts(e,r,o),r+=2*o,a.glyphIdArray=[];r<n+s;)a.glyphIdArray.push(t.readUshort(e,r)),r+=2;return a},m.cmap.parse6=function(e,r){var t=m._bin,n={};n.format=t.readUshort(e,r),r+=2;t.readUshort(e,r);r+=2;t.readUshort(e,r);r+=2,n.firstCode=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2,n.glyphIdArray=[];for(var s=0;s<a;s++)n.glyphIdArray.push(t.readUshort(e,r)),r+=2;return n},m.cmap.parse12=function(e,r){var t=m._bin,n={};n.format=t.readUshort(e,r),r+=2,r+=2;t.readUint(e,r);r+=4;t.readUint(e,r);r+=4;var a=t.readUint(e,r);r+=4,n.groups=[];for(var s=0;s<a;s++){var i=r+12*s,o=t.readUint(e,i+0),l=t.readUint(e,i+4),u=t.readUint(e,i+8);n.groups.push([o,l,u])}return n},m.GPOS={},m.GPOS.parse=function(e,r,t,n){return m._lctf.parse(e,r,t,n,m.GPOS.subt)},m.GPOS.subt=function(e,r,t){if(2!=r)return null;var n=m._bin,a=t,s={};s.format=n.readUshort(e,t),t+=2;var i=n.readUshort(e,t);t+=2,s.coverage=m._lctf.readCoverage(e,i+a),s.valFmt1=n.readUshort(e,t),t+=2,s.valFmt2=n.readUshort(e,t),t+=2;var o=m._lctf.numOfOnes(s.valFmt1),l=m._lctf.numOfOnes(s.valFmt2);if(1==s.format){s.pairsets=[];var u=n.readUshort(e,t);t+=2;for(var c=0;c<u;c++){var f=n.readUshort(e,t);t+=2,f+=a;var h=n.readUshort(e,f);f+=2;for(var v=[],d=0;d<h;d++){var b=n.readUshort(e,f);f+=2,0!=s.valFmt1&&(N=m._lctf.readValueRecord(e,f,s.valFmt1),f+=2*o),0!=s.valFmt2&&(U=m._lctf.readValueRecord(e,f,s.valFmt2),f+=2*l),v.push({gid2:b,val1:N,val2:U})}s.pairsets.push(v)}}if(2==s.format){var g=n.readUshort(e,t);t+=2;var p=n.readUshort(e,t);t+=2;var y=n.readUshort(e,t);t+=2;var L=n.readUshort(e,t);t+=2,s.classDef1=m._lctf.readClassDef(e,a+g),s.classDef2=m._lctf.readClassDef(e,a+p),s.matrix=[];for(c=0;c<y;c++){var A=[];for(d=0;d<L;d++){var N=null,U=null;0!=s.valFmt1&&(N=m._lctf.readValueRecord(e,t,s.valFmt1),t+=2*o),0!=s.valFmt2&&(U=m._lctf.readValueRecord(e,t,s.valFmt2),t+=2*l),A.push({val1:N,val2:U})}s.matrix.push(A)}}return s},m.GSUB={},m.GSUB.parse=function(e,r,t,n){return m._lctf.parse(e,r,t,n,m.GSUB.subt)},m.GSUB.subt=function(e,r,t){var n=m._bin,a=t,s={};if(1!=r&&4!=r)return null;s.fmt=n.readUshort(e,t),t+=2;var i=n.readUshort(e,t);if(t+=2,s.coverage=m._lctf.readCoverage(e,i+a),1==r){if(1==s.fmt)s.delta=n.readShort(e,t),t+=2;else if(2==s.fmt){var o=n.readUshort(e,t);t+=2,s.newg=n.readUshorts(e,t,o),t+=2*s.newg.length}}else if(4==r){s.vals=[];o=n.readUshort(e,t);t+=2;for(var l=0;l<o;l++){var u=n.readUshort(e,t);t+=2,s.vals.push(m.GSUB.readLigatureSet(e,a+u))}}return s},m.GSUB.readChainSubClassSet=function(e,r){var t=m._bin,n=r,a=[],s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readUshort(e,r);r+=2,a.push(m.GSUB.readChainSubClassRule(e,n+o))}return a},m.GSUB.readChainSubClassRule=function(e,r){for(var t=m._bin,n={},a=["backtrack","input","lookahead"],s=0;s<a.length;s++){var i=t.readUshort(e,r);r+=2,1==s&&i--,n[a[s]]=t.readUshorts(e,r,i),r+=2*n[a[s]].length}i=t.readUshort(e,r);return r+=2,n.subst=t.readUshorts(e,r,2*i),r+=2*n.subst.length,n},m.GSUB.readLigatureSet=function(e,r){var t=m._bin,n=r,a=[],s=t.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=t.readUshort(e,r);r+=2,a.push(m.GSUB.readLigature(e,n+o))}return a},m.GSUB.readLigature=function(e,r){var t=m._bin,n={chain:[]};n.nglyph=t.readUshort(e,r),r+=2;var a=t.readUshort(e,r);r+=2;for(var s=0;s<a-1;s++)n.chain.push(t.readUshort(e,r)),r+=2;return n},m.head={},m.head.parse=function(e,r,t){var n=m._bin,a={};n.readFixed(e,r);r+=4,a.fontRevision=n.readFixed(e,r),r+=4;n.readUint(e,r);r+=4;n.readUint(e,r);return r+=4,a.flags=n.readUshort(e,r),r+=2,a.unitsPerEm=n.readUshort(e,r),r+=2,a.created=n.readUint64(e,r),r+=8,a.modified=n.readUint64(e,r),r+=8,a.xMin=n.readShort(e,r),r+=2,a.yMin=n.readShort(e,r),r+=2,a.xMax=n.readShort(e,r),r+=2,a.yMax=n.readShort(e,r),r+=2,a.macStyle=n.readUshort(e,r),r+=2,a.lowestRecPPEM=n.readUshort(e,r),r+=2,a.fontDirectionHint=n.readShort(e,r),r+=2,a.indexToLocFormat=n.readShort(e,r),r+=2,a.glyphDataFormat=n.readShort(e,r),r+=2,a},m.hhea={},m.hhea.parse=function(e,r,t){var n=m._bin,a={};n.readFixed(e,r);return r+=4,a.ascender=n.readShort(e,r),r+=2,a.descender=n.readShort(e,r),r+=2,a.lineGap=n.readShort(e,r),r+=2,a.advanceWidthMax=n.readUshort(e,r),r+=2,a.minLeftSideBearing=n.readShort(e,r),r+=2,a.minRightSideBearing=n.readShort(e,r),r+=2,a.xMaxExtent=n.readShort(e,r),r+=2,a.caretSlopeRise=n.readShort(e,r),r+=2,a.caretSlopeRun=n.readShort(e,r),r+=2,a.caretOffset=n.readShort(e,r),r+=2,r+=8,a.metricDataFormat=n.readShort(e,r),r+=2,a.numberOfHMetrics=n.readUshort(e,r),r+=2,a},m.hmtx={},m.hmtx.parse=function(e,r,t,n){for(var a=m._bin,s={aWidth:[],lsBearing:[]},i=0,o=0,l=0;l<n.maxp.numGlyphs;l++)l<n.hhea.numberOfHMetrics&&(i=a.readUshort(e,r),r+=2,o=a.readShort(e,r),r+=2),s.aWidth.push(i),s.lsBearing.push(o);return s},m.kern={},m.kern.parse=function(e,r,t,n){var a=m._bin,s=a.readUshort(e,r);if(r+=2,1==s)return m.kern.parseV1(e,r-2,t,n);var i=a.readUshort(e,r);r+=2;for(var o={glyph1:[],rval:[]},l=0;l<i;l++){r+=2;t=a.readUshort(e,r);r+=2;var u=a.readUshort(e,r);r+=2;var c=u>>>8;if(0!=(c&=15))throw"unknown kern table format: "+c;r=m.kern.readFormat0(e,r,o)}return o},m.kern.parseV1=function(e,r,t,n){var a=m._bin;a.readFixed(e,r);r+=4;var s=a.readUint(e,r);r+=4;for(var i={glyph1:[],rval:[]},o=0;o<s;o++){a.readUint(e,r);r+=4;var l=a.readUshort(e,r);r+=2;a.readUshort(e,r);r+=2;var u=l>>>8;if(0!=(u&=15))throw"unknown kern table format: "+u;r=m.kern.readFormat0(e,r,i)}return i},m.kern.readFormat0=function(e,r,t){var n=m._bin,a=-1,s=n.readUshort(e,r);r+=2;n.readUshort(e,r);r+=2;n.readUshort(e,r);r+=2;n.readUshort(e,r);r+=2;for(var i=0;i<s;i++){var o=n.readUshort(e,r);r+=2;var l=n.readUshort(e,r);r+=2;var u=n.readShort(e,r);r+=2,o!=a&&(t.glyph1.push(o),t.rval.push({glyph2:[],vals:[]}));var c=t.rval[t.rval.length-1];c.glyph2.push(l),c.vals.push(u),a=o}return r},m.maxp={},m.maxp.parse=function(e,r,t){var n=m._bin,a={},s=n.readUint(e,r);return r+=4,a.numGlyphs=n.readUshort(e,r),r+=2,65536==s&&(a.maxPoints=n.readUshort(e,r),r+=2,a.maxContours=n.readUshort(e,r),r+=2,a.maxCompositePoints=n.readUshort(e,r),r+=2,a.maxCompositeContours=n.readUshort(e,r),r+=2,a.maxZones=n.readUshort(e,r),r+=2,a.maxTwilightPoints=n.readUshort(e,r),r+=2,a.maxStorage=n.readUshort(e,r),r+=2,a.maxFunctionDefs=n.readUshort(e,r),r+=2,a.maxInstructionDefs=n.readUshort(e,r),r+=2,a.maxStackElements=n.readUshort(e,r),r+=2,a.maxSizeOfInstructions=n.readUshort(e,r),r+=2,a.maxComponentElements=n.readUshort(e,r),r+=2,a.maxComponentDepth=n.readUshort(e,r),r+=2),a},m.U={},m.U.codeToGlyph=function(e,r){var t=e.cmap,n=-1;if(null!=t.p0e4?n=t.p0e4:null!=t.p3e1?n=t.p3e1:null!=t.p1e0&&(n=t.p1e0),-1==n)throw"no familiar platform and encoding!";var a=t.tables[n];if(0==a.format)return r>=a.map.length?0:a.map[r];if(4==a.format){for(var s=-1,i=0;i<a.endCount.length;i++)if(r<=a.endCount[i]){s=i;break}if(-1==s)return 0;if(a.startCount[s]>r)return 0;return 65535&(0!=a.idRangeOffset[s]?a.glyphIdArray[r-a.startCount[s]+(a.idRangeOffset[s]>>1)-(a.idRangeOffset.length-s)]:r+a.idDelta[s])}if(12==a.format){if(r>a.groups[a.groups.length-1][1])return 0;for(i=0;i<a.groups.length;i++){var o=a.groups[i];if(o[0]<=r&&r<=o[1])return o[2]+(r-o[0])}return 0}throw"unknown cmap table format "+a.format},m.U._getGlyphClass=function(e,r){for(var t=0;t<r.start.length;t++)if(r.start[t]<=e&&r.end[t]>=e)return r.class[t];return 0},m.U.getPairAdjustment=function(e,r,t){if(e.GPOS){for(var n=null,a=0;a<e.GPOS.featureList.length;a++){var s=e.GPOS.featureList[a];if("kern"==s.tag)for(var i=0;i<s.tab.length;i++)2==e.GPOS.lookupList[s.tab[i]].ltype&&(n=e.GPOS.lookupList[s.tab[i]])}if(n)for(a=0;a<n.tabs.length;a++){var o=n.tabs[a],l=m._lctf.coverageIndex(o.coverage,r);if(-1!=l){var u=0;if(1==o.format){var c=o.pairsets[l];for(i=0;i<c.length;i++)c[i].gid2==t&&(u=c[i]);if(null==u)continue}else if(2==o.format){var f=m.U._getGlyphClass(r,o.classDef1),h=m.U._getGlyphClass(t,o.classDef2);u=o.matrix[f][h]}return u.val1[2]}}}if(e.kern){var v=e.kern.glyph1.indexOf(r);if(-1!=v){var d=e.kern.rval[v].glyph2.indexOf(t);if(-1!=d)return e.kern.rval[v].vals[d]}}return 0},m.U.RTable=[1570,1571,1572,1573,1575,1577,1583,1584,1585,1586,1608,1649,1650,1651,1653,1654,1655,1672,1673,1674,1675,1676,1677,1678,1679,1680,1681,1682,1683,1684,1685,1686,1687,1688,1689,1728,1731,1732,1733,1734,1735,1736,1737,1738,1739,1741,1743,1746,1747,1749,1774,1775,1808,1813,1814,1815,1816,1817,1822,1832,1834,1836,1839,1869,1881,1882,1883,1899,1900,1905,1907,1908,1912,1913,2112,2118,2119,2121,2132,2151,2153,2154,2218,2219,2220,2222,2225,2226,2233,2757,2759,2761,2762,2766,2767,2768,2769,2770,2781,2785,2788,2799,2945,2947,2948,2949,2953,2956,2958,2959,2961,2985,2986,2987,2988],m.U.stringToGlyphs=function(e,r){var t,n,a,s,i,o,l,u,c,f,h,v,d,b=[],g=[],p=[],y=[],L=[],N=A(r,-1,!1),U=m.U.RTable;for(n=0,a=r.length;n<a;n++)u=r.charCodeAt(n),y.push(u),L.push(0),2765==u||2775==u||43122==u?L[n]=2:1548==u?L[n]=1:u<=63?9!=u&&10!=u&&32!=u&&33!=u&&34!=u&&40!=u&&41!=u&&44!=u&&46!=u&&58!=u&&59!=u&&63!=u||(L[n]=1):u>=1570&&u<=2988&&-1!=U.indexOf(u)&&(L[n]=3);for(n=0,a=r.length;n<a;n++)u=y[n],1!=L[n]&&n<a-2&&4156==(c=y[n+1])&&(y[n]=c,y[n+1]=u,n++);for(n=0,a=r.length;n<a;n++){for(u=y[n],s=0,i=e.length;s<i&&(h=e[s],!(t=m.U.codeToGlyph(h,u)));s++);b.push(t),g.push(t?s:0)}p=y,h=null;for(var w=0;w<b.length;w++)if(d=b[w],h!=g[w]&&(f=(h=e[g[w]]).GSUB),f){var x=L[w-1],S=L[w],M=L[w+1],B=0==w||1==x,O=w==b.length-1||1==M;if(B||3!=x||(B=!0),O||3!=S||(O=!0),O||2!=M||(O=!0),B||2!=S||(B=!0),v=null,v=B?O?h.gsubIsolTable:h.gsubInitTable:O?h.gsubFinaTable:h.gsubMediTable)for(l=0;l<v.length;l++){var _=v[l];for(s=0;s<_.length;s++){var k=_[s];-1!=(E=m._lctf.coverageIndex(k.coverage,d))&&(0==k.fmt?b[w]=E+k.delta:k.newg?b[w]=k.newg[E]:(b[w]=d,console.log(w,d,"subst-error"," original:",r)))}}}h=null;for(w=0;w<b.length;w++)if(d=b[w],h!=g[w]&&(f=(h=e[g[w]]).GSUB),f&&(v=h.gsubRligLigaTable)){var I=Math.min(3,b.length-w-1);for(l=0;l<v.length;l++){_=v[l];for(s=0;s<_.length;s++){var E;k=_[s];if(-1!=(E=m._lctf.coverageIndex(k.coverage,d))){var C=k.vals[E];for(o=0;o<C.length;o++){var F=C[o],z=F.chain.length;if(!(z>I)){for(var P=!0,j=0;j<z;j++)F.chain[j]!=b[w+(1+j)]&&(P=!1);if(P){b[w]=F.nglyph;for(j=0;j<z;j++)b[w+j+1]=-1}}}}}}}var T=N.indices,V=b.slice(),G=p.slice(),X=g.slice();for(n=0,a=b.length;n<a;n++)u=T[n],V[n]=b[u],G[n]=p[u],X[n]=g[u];return[V,X,G]};var N=n,U=s,w=function(e){var r=e[0],t=e[1];return e=e[2],Math.sqrt(r*r+t*t+e*e)},x=i,S=m,M=function(e,r,t,n,a,s,i,o,l,u,c,f,h,v,d,b){var g,p=u[d],y=[0,0,0];N.geocent&&!h?(g=[0,0,0],U(N.bboxMin,y),x(y,r,g)):g=[-r[1],r[0],0],x(r,g,y);var L=[e[0],e[1],e[2]],A=[L[0],L[1],L[2]],m=p.glyphs[n];if(n=0,!m)return[e,i,o,0];var w=0,S=l[0],M=l[1],B=l[2];if(9==n||32==n)(m=chars[32])&&(e[0]+=r[0]*m.step*a*s,e[1]+=r[1]*m.step*a*s,w=m.lx*a);else if(0==m.lx)e[0]=e[0]+r[0]*m.step*a*s,e[1]=e[1]+r[1]*m.step*a*s,w=m.lx*a;else{var O=4e3*d,_=m.plane+O;v&&(v[d]||(v[d]={}),v[d][_]=!0);var k=m.lx*a,I=m.ly*a;if(b)if(N.processLineLabel&&N.useLineLabel2){L[0]=L[0]+r[0]*m.sx*a,L[1]=L[1]+r[1]*m.sx*a,L[2]=L[2]+r[2]*m.sx*a,L[0]=L[0]+g[0]*(m.sy-p.size)*a,L[1]=L[1]+g[1]*(m.sy-p.size)*a,L[2]=L[2]+g[2]*(m.sy-p.size)*a;var E=[(V=[g[0]*t,g[1]*t,g[2]*t])[0]+g[0]*I,V[1]+g[1]*I,V[2]+g[2]*I];b[i]=L[0]-V[0],b[i+1]=L[1]-V[1],b[i+2]=L[2]-V[2];var C=function(e){var r,t,n,a,s,i=e[0][0]+e[1][1]+e[2][2];return i>0?(a=.25*(s=2*Math.sqrt(i+1)),r=(e[2][1]-e[1][2])/s,t=(e[0][2]-e[2][0])/s,n=(e[1][0]-e[0][1])/s):e[0][0]>e[1][1]&e[0][0]>e[2][2]?(s=2*Math.sqrt(1+e[0][0]-e[1][1]-e[2][2]),a=(e[2][1]-e[1][2])/s,r=.25*s,t=(e[0][1]+e[1][0])/s,n=(e[0][2]+e[2][0])/s):e[1][1]>e[2][2]?(s=2*Math.sqrt(1+e[1][1]-e[0][0]-e[2][2]),a=(e[0][2]-e[2][0])/s,r=(e[0][1]+e[1][0])/s,t=.25*s,n=(e[1][2]+e[2][1])/s):(s=2*Math.sqrt(1+e[2][2]-e[0][0]-e[1][1]),a=(e[1][0]-e[0][1])/s,r=(e[0][2]+e[2][0])/s,t=(e[1][2]+e[2][1])/s,n=.25*s),[r,t,n,a]}([[r[0],r[1],r[2]],[g[0],g[1],g[2]],[y[0],y[1],y[2]]]);b[i+3]=C[0],b[i+4]=C[1],b[i+5]=C[2],b[i+6]=C[3],N.lineLabelPass||(b[i+7]=k,b[i+8]=I),b[i+9]=m.u1,b[i+10]=m.v1+O;var F=1024*(m.u2-m.u1),z=m.v2-m.v1;b[i+11]=F+z;var P=.5*r[0]*k-.5*g[0]*I-V[0],j=.5*r[1]*k-.5*g[1]*I-V[1],T=.5*r[2]*k-.5*g[2]*I-V[2];N.lineLabelPoints.push([L[0]+P,L[1]+j,L[2]+T,.5*Math.sqrt(k*k+I*I),b[i],b[i+1],b[i+2],b[i+3],b[i+4],b[i+5],b[i+6],k,I]),i+=12}else b[i]=L[0]+m.sx*a,b[i+1]=L[1]+(m.sy-p.size)*a,b[i+2]=b[i]+k,b[i+3]=b[i+1]-I,b[i+4]=m.u1,b[i+5]=m.v1+O,b[i+6]=m.u2,b[i+7]=m.v2+O,i+=8;else{var V;E=[(V=[g[0]*t,g[1]*t,g[2]*t])[0]+g[0]*I,V[1]+g[1]*I,V[2]+g[2]*I];L[0]=L[0]+r[0]*m.sx*a,L[1]=L[1]+r[1]*m.sx*a,L[2]=L[2]+r[2]*m.sx*a,L[0]=L[0]+g[0]*(m.sy-p.size)*a,L[1]=L[1]+g[1]*(m.sy-p.size)*a,L[2]=L[2]+g[2]*(m.sy-p.size)*a,A[0]=L[0]+r[0]*k,A[1]=L[1]+r[1]*k,A[2]=L[2]+r[2]*k,c[i]=L[0]-V[0],c[i+1]=L[1]-V[1],c[i+2]=L[2]-V[2],c[i+3]=B,f[o]=m.u1,f[o+1]=m.v1+O,f[o+2]=S,f[o+3]=M,c[i+4]=L[0]-E[0],c[i+5]=L[1]-E[1],c[i+6]=L[2]-E[2],c[i+7]=B,f[o+4]=m.u1,f[o+5]=m.v2+O,f[o+6]=S,f[o+7]=M,c[i+8]=A[0]-V[0],c[i+9]=A[1]-V[1],c[i+10]=A[2]-V[2],c[i+11]=B,f[o+8]=m.u2,f[o+9]=m.v1+O,f[o+10]=S,f[o+11]=M,c[i+12]=L[0]-E[0],c[i+13]=L[1]-E[1],c[i+14]=L[2]-E[2],c[i+15]=B,f[o+12]=m.u1,f[o+13]=m.v2+O,f[o+14]=S,f[o+15]=M,c[i+16]=A[0]-E[0],c[i+17]=A[1]-E[1],c[i+18]=A[2]-E[2],c[i+19]=B,f[o+16]=m.u2,f[o+17]=m.v2+O,f[o+18]=S,f[o+19]=M,c[i+20]=A[0]-V[0],c[i+21]=A[1]-V[1],c[i+22]=A[2]-V[2],c[i+23]=B,f[o+20]=m.u2,f[o+21]=m.v1+O,f[o+22]=S,f[o+23]=M,i+=24,o+=24}e[0]=e[0]+r[0]*m.step*a*s,e[1]=e[1]+r[1]*m.step*a*s,w=m.lx*a}return[e,i,o,w*s]},B=function(e){return 3*(e?3:4)*2},O=function(e,r){return r?e/r.size*1.52:1},_=function(e,r,t,n,a){for(var s=0,i=a||S.U.stringToGlyphs(n,e),o=i[0],l=i[1],u=0,c=o.length;u<c;u++){var f=o[u],h=n[l[u]];if(h){var v=O(r,h)*t,d=h.glyphs[f];d&&(s+=u==c-1?d.lx*v:d.step*v)}}return s},k=function(e){for(var r=0,t=0,n=e.length-1;t<n;t++){var a=e[t],s=e[t+1],i=[s[0]-a[0],s[1]-a[1],s[2]-a[2]];r+=w(i)}return r},I=function(e,r){for(var t=0,n=[0,0,0],a=[1,0,0],s=0,i=e.length-1;s<i;s++){n=e[s];var o=e[s+1];a=[o[0]-n[0],o[1]-n[1],o[2]-n[2]];var l=w(a);if(t+l>r){var u=(r-t)/l,c=[n[0]+a[0]*u,n[1]+a[1]*u,n[2]+a[2]*u];return U(a),[c,a]}t+=l}return[n,a]},E=function(e,r,t,n,a,s,i){for(var o=0,l=[0,0,0],u=[1,0,0],c=[0,0,0],f=r,h=r+_(t,n,a,s,i),v=N.bboxMin,d=N.geocent,b=0,g=e.length-1;b<g;b++){l=e[b];var p=e[b+1];if(u=[p[0]-l[0],p[1]-l[1],p[2]-l[2]],(o+=w(u))>f&&(U(u),c[0]+=u[0],c[1]+=u[1],c[2]+=u[2]),o>h){if(U(c),d){var y=[0,0,0];return U(v,y),x(y,c,y),y}return[-c[1],c[0],0]}}return c},C=function(e,r,t){return!(!e||""==e)&&-1==(t||S.U.stringToGlyphs(r,e))[0].indexOf(0)},F=function(e){for(var r=[],t=0,n=e.length;t<n;t++)r.push(N.fonts[e[t]]);return r},z=function(e){for(var r=[],t=0,n=e.length;t<n;t++)r.push(N.fontsMap[e[t]]);return r},P=function(e,r){return S.U.stringToGlyphs(r,e)},j=n,T=a,V=function(e,r){if(!e||""==e)return"";var t,n,a=e.indexOf("{");if(-1==a)return e;n=a>0?e.substring(0,a):"";var s=0,i=-1;for(t=e.length;a<t;a++){var o=e.charAt(a);"{"==o?(0==s&&(i=a),s++):"}"==o?0==--s&&(n+=r(e.substring(i+1,a))):0==s&&(n+=o)}return n},G=function(e){if(!e||0===e.length)return 0;for(var r=0,t=0,n=e.length;t<n;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return r},X=function(e){for(var r=0,t=e.length;r<t;r++){var n=e.charCodeAt(r);if(n>=65&&n<=90||n>=97&&n<=122||n>=192&&n<=255&&215!=n&&247!=n||n>=256&&n<=383)return!0}return!1},D=function(e){for(var r=0,t=e.length;r<t;r++){var n=e.charCodeAt(r);if(!(n>=19968&&n<=25343||n>=25344&&n<=30719||n>=30720&&n<=36095||n>=36096&&n<=40959||n>=13312&&n<=19903||n>=131072&&n<=136703||n>=136704&&n<=143615||n>=143616&&n<=148991||n>=148992&&n<=155903||n>=155904&&n<=161279||n>=161280&&n<=168191||n>=168192&&n<=173791||n>=173824&&n<=177983||n>=177984&&n<=178207||n>=178208&&n<=183983||n>=183984&&n<=191471||n>=63744&&n<=64255||n>=13056&&n<=13311||n>=65072&&n<=65103||n>=63744&&n<=64255||n>=194560&&n<=195103||n>=0&&n<=64||n>=160&&n<=191))return!1}return!0},R=C,$=function(e,r,t,n,a,s){var i;if(s||(s=0),!(s>100)){switch(typeof r){case"string":if(r.length>0){switch(r.charAt(0)){case"#":case"$":case"@":case"&":case"%":return void 0===(i=Y(e,a,t,n,r,s+1))&&W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),i}return V(r,(function(o){if(o.length>0){switch(o.charAt(0)){case"#":case"$":case"@":case"&":case"%":return void 0===(i=Y(e,a,t,n,o,s+1))&&W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),i}if(-1!=o.indexOf("{")){try{o=o.replace(/\'/g,\'"\'),i=JSON.parse(o)}catch(t){return W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),""}return void 0===i?(W("wrong-expresion",e["$$layer-id"],r,r,null,"feature-property"),""):H(e,a,t,n,i,s+1)}return o}}))}}return r}},q=function(e,r,t,n){var a=H(e,r,t,n);return K(e["$$layer-id"],r,a)},Y=function(e,r,t,n,a,s){var i=a;switch(a.charAt(0)){case"$":i=t.properties[a.substr(1)];break;case"@":i=j.stylesheetConstants[a];break;case"%":i=j.stylesheetVariables[a.substr(1)];break;case"&":i=j.stylesheetLocals[a];break;case"#":switch(a){case"#id":return t.id;case"#type":return j.featureType;case"#group":return j.groupId;case"#lod":return j.tileLod;case"#ix":return j.tileIX;case"#iy":return j.tileIY;case"#tileSize":return j.tileSize;case"#pixelSize":return j.pixelSize;case"#metric":return j.metricUnits;case"#dpr":return j.pixelFactor;case"#language":return j.language}}return"&"==a.charAt(0)?void 0===i&&void 0!==(i=e[a])&&("string"==typeof i?i=$(e,i,t,n,r,s+1):void 0!==i&&(i=H(e,r,t,n,i,s+1)),j.stylesheetLocals[a]=i):"string"==typeof i?i=$(e,i,t,n,r,s+1):void 0!==i&&"@"==a.charAt(0)&&(i=H(e,r,t,n,i,s+1)),i},H=function(e,r,t,n,a,s){var i,o,l,u,c,f;if(void 0===a)a=e[r],i=!0,s=0;else if(s>100)return;switch(typeof a){case"string":return a.length>0?void 0!==(d=Y(e,r,t,n,a,s))?d:(W("wrong-object",e["$$layer-id"],r,a,null,"feature-property"),i?Q(r):void 0):a;case"object":if(null==a)return i?Q(r):void 0;if(Array.isArray(a)){if("icon-source"==r&&null==j.stylesheetBitmaps[a[0]])return W("wrong-object",e["$$layer-id"],r,a,null,"bitmap"),i?Q(r):void 0;if("filter"!=r){for(f=new Array(a.length),_=0,k=a.length;_<k;_++)f[_]=H(e,r,t,n,a[_],s+1);return f}return a}var h,v,d;for(h in a)break;if(!h)return i?Q(r):void 0;switch(N=a[h],h){case"if":if(Array.isArray(N)&&3==N.length){if(void 0!==(d=ee(N[0],t,j.featureType,j.groupId,e,r,n,0)?H(e,r,t,n,N[1],s+1):H(e,r,t,n,N[2],s+1)))return d;v=!0}else v=!0;break;case"add":case"sub":case"mul":case"div":case"mod":case"pow":case"tofixed":case"atan2":case"random":if(Array.isArray(N)&&2==N.length)if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),"number"!=typeof o||"number"!=typeof l)v=!0;else switch(h){case"add":return o+l;case"sub":return o-l;case"mul":return o*l;case"div":return o/l;case"mod":return o%l;case"pow":return Math.pow(o,l);case"atan2":return Math.atan2(o,l);case"tofixed":return o.tofixed(l);case"random":return o+Math.random()*(l-o)}else v=!0;break;case"clamp":if(Array.isArray(N)&&3==N.length){if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),u=H(e,r,t,n,N[2],s+1),"number"==typeof o&&"number"==typeof l&&"number"==typeof u)return T(o,l,u);v=!0}else v=!0;break;case"logScale":case"log-scale":if(!Array.isArray(N)||N.length<2)v=!0;else{if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),u=0,c=100,N.length>2&&"number"!=typeof(u=H(e,r,t,n,N[2],s+1))&&(v=!0),N.length>3&&"number"!=typeof(c=H(e,r,t,n,N[3],s+1))&&(v=!0),!v&&"number"==typeof o&&"number"==typeof l){var b=u,g=l,p=o;return p>g&&(p=g),_=(c-b)/Math.log(g+1)*Math.log(p+1)+b}v=!0}break;case"sgn":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"sqrt":case"abs":case"log":case"round":case"floor":case"ceil":case"deg2rad":case"rad2deg":if("number"!=typeof(N=H(e,r,t,n,N,s+1)))v=!0;else switch(h){case"sgn":return N<0?-1:1;case"sin":return Math.sin(N);case"cos":return Math.cos(N);case"tan":return Math.tan(N);case"asin":return Math.asin(N);case"acos":return Math.acos(N);case"atan":return Math.atan(N);case"sqrt":return Math.sqrt(N);case"abs":return Math.abs(N);case"log":return Math.log(N);case"round":return Math.round(N);case"floor":return Math.floor(N);case"ceil":return Math.ceil(N);case"deg2rad":return N/180*Math.PI;case"rad2deg":return N/Math.PI*180}break;case"strlen":case"trim":case"str2num":case"lowercase":case"uppercase":case"capitalize":case"has-fonts":case"has-latin":case"is-cjk":if("string"!=typeof(N=H(e,r,t,n,N,s+1))){if("number"==typeof N)return N;v=!0}else switch(h){case"strlen":return N.length;case"trim":return N.trim();case"str2num":return parseFloat(N);case"lowercase":return N.toLowerCase();case"uppercase":return N.toUpperCase();case"capitalize":return N.replace(/(?:^|\\s)\\S/g,(function(e){return e.toUpperCase()}));case"has-fonts":return R(N);case"has-latin":return X(N);case"is-cjk":return D(N)}break;case"find":case"replace":case"substr":if(Array.isArray(N)&&N.length>=2){if(o=H(e,r,t,n,N[0],s+1),l=H(e,r,t,n,N[1],s+1),"find"==h&&"string"==typeof o&&"string"==typeof l)return o.indexOf(l);if("replace"==h&&3==N.length&&(u=H(e,r,t,n,N[2],s+1),"string"==typeof o&&"string"==typeof l&&"string"==typeof u))return o.replace(l,u);if("substr"==h)if(2==N.length){if("string"==typeof o&&"number"==typeof l)return o.substr(l)}else if(u=H(e,r,t,n,N[2],s+1),"string"==typeof o&&"number"==typeof l&&"number"==typeof u)return o.substr(l,u)}v=!0;break;case"min":case"max":if(Array.isArray(N)){for(d=H(e,r,t,n,N[0],s+1),_=0,k=N.length;_<k;_++){if("number"!=typeof(f=H(e,r,t,n,N[_],s+1))){v=!0;break}d="max"==h?Math.max(d,f):Math.min(d,f)}return d}v=!0;break;case"map":if(Array.isArray(N)){d=H(e,r,t,n,N[0],s+1);var y=N[1];if(Array.isArray(y))for(_=0,k=y.length;_<k;_++){var L=y[_];if(!Array.isArray(L)){v=!0;break}if(d==H(e,r,t,n,L[0],s+1))return H(e,r,t,n,L[1],s+1)}else v=!0;return H(e,r,t,n,N[2],s+1)}v=!0;break;case"linear":case"linear2":case"discrete":case"discrete2":case"lod-scaled":var A=null,m=null,N=n;if(null!=a["lod-scaled"]){var U;if("number"==typeof(U=a["lod-scaled"])[1])return U[1]*Math.pow(2*U[2],U[0]-n);A=U[1],m=U}if(null!=a.discrete2||null!=a.linear2)A=(U=a.discrete2||a.linear2)[1],N=H(e,r,t,n,U[0],s+1);else A=a.discrete||a.linear;for(var w,x,S=A[0][0],M=A[0][1],B=typeof M,O=M,_=0,k=A.length;_<=k;_++){if(_==k){O=M;break}if(A[_][0]>N){if(null!=a.discrete||null!=a.discrete2||null!=m){O=M;break}if(w=A[_][0],x=A[_][1],w==S)break;switch(B){case"boolean":O=(O=(M=M?1:0)+(N-S)/(w-S)*((x=M?1:0)-M))>.5;break;case"number":O=M+(N-S)/(w-S)*(x-M);break;case"object":O=[];for(var I=0,E=M.length;I<E;I++)O[I]=M[I]+(x[I]-M[I])*((N-S)/(w-S))}break}S=A[_][0],M=A[_][1]}return null!=m&&(O*=Math.pow(2*m[2],m[0]-N)),O;default:v=!0}if(v)return i?Q(r):void 0;case"number":case"boolean":return a}return i?Q(r):void 0},J=function(e,r,t,n,a){if(a>100)W("custom","infinite inherit loop in Layer: "+e);else if(null!=t.inherit){var s=n.layers[t.inherit];if(null==s)return W("wrong-object",e,"inherit",s,"Layer"),Q(i);for(var i in null!=s.inherit&&J(t.inherit,r,s,n,a++),s)r[i]=s[i]}},W=function(e,r,t,n,a,s){if(!j.disableLog){"object"==typeof n&&(n=JSON.stringify(n));var i=null;switch(e){case"wrong-property-value":i="Error: wrong layer property "+(s?"\'"+s+"\'":"")+": "+r+"."+t+" = "+n;break;case"wrong-property-value[]":i="Error: wrong layer property "+(s?"\'"+s+"\'":"")+"["+a+"]: "+r+"."+t+" = "+n;break;case"wrong-object":i="Error: reffered "+s+" does not exist: "+r+"."+t+" = "+n;break;case"wrong-object[]":i="Error: reffered "+s+" does not exist: "+r+"."+t+"["+a+"] = "+n;break;case"wrong-Layer":i="Error: reffered "+s+" Layer does not exist: "+s+"["+a+"].Layer = "+r;break;case"wrong-bitmap":i="Error: wrong definition of bitmap: "+r;break;case"custom":i="Error: "+r}i&&j.log&&console.log(i)}},Z=function(e,r,t,n,a,s,i,o){var l,u;if(null!=t&&"object"==typeof t&&!Array.isArray(t))return W("wrong-property-value",e,r,t),Q(r);if(typeof t!=n&&(null!==t||"icon-source"!=r&&"visibility"!=r&&"label-no-overlap-factor"!=r))return W("wrong-property-value",e,r,t),Q(r);switch(typeof t){case"object":if(null===t)return t;if("reduce"==r||"dynamic-reduce"==r||"label-no-overlap-factor"==r||"line-points"==r){if(!(Array.isArray(t)&&t.length>0&&"string"==typeof t[0]))return W("wrong-property-value",e,r,t),Q(r);if("line-points"==r){if("vertices"!=t[0]&&"by-length"!=t[0]&&"by-ratio"!=t[0]&&"endpoints"!=t[0]&&"start"!=t[0]&&"end"!=t[0]&&"middle"!=t[0]&&"midpoint"!=t[0])return W("wrong-property-value",e,r,t),Q(r)}else if("dynamic-reduce"==r){if("by-extenal-param"==t[0]&&(t[0]=j.reduceMode),"tilt"!=t[0]&&"tilt-cos"!=t[0]&&"tilt-cos2"!=t[0]&&"scr-count"!=t[0]&&"scr-count2"!=t[0]&&"scr-count3"!=t[0]&&"scr-count4"!=t[0]&&"scr-count5"!=t[0]&&"scr-count6"!=t[0]&&"scr-count7"!=t[0]&&"scr-count8"!=t[0]||"number"!=typeof t[1]||"number"!=typeof t[2]&&"scr-count4"!=t[0]&&"scr-count5"!=t[0]&&"scr-count6"!=t[0]&&"scr-count7"!=t[0]&&"scr-count8"!=t[0])return W("wrong-property-value",e,r,t),Q(r)}else if("reduce"==r){if("odd"!=t[0]&&"even"!=t&&("number"!=typeof t[1]||("top"!=t[0]||"bottom"!=t)&&"string"!=typeof t[2]))return W("wrong-property-value",e,r,t),Q(r)}else if("label-no-overlap-factor"==r&&"direct"!=t[0]&&"div-by-dist"!=t[0])return W("wrong-property-value",e,r,t),Q(r)}if("next-pass"==r||"visibility-switch"==r){var c="visibility-switch"==r;if(!(Array.isArray(t)&&t.length>0))return W("wrong-property-value",e,r,t),Q(r);for(l=0;l<u;l++){var f=t[l];if("object"!=typeof f||!Array.isArray(f)||2!=f.length||"number"!=typeof f[0]||!("string"==typeof f[1]||c&&null===f[1]))return W("wrong-property-value[]",e,r,t,l),Q(r);if("string"==typeof f[1]&&"@"==f[1].charAt(0)){if(void 0===j.stylesheetConstants[f[1]])return W("wrong-property-value[]",e,r,t,l),Q(r);f[1]=j.stylesheetConstants[f[1]]}}}if("label-font"==r||"line-label-font"==r){if(!Array.isArray(t)||t.length<1)return W("wrong-property-value[]",e,r,t,0),Q(r);for(l=0,u=t.length;l<u;l++)if("string"!=typeof t[l]||!j.fonts[t[l]])return W("wrong-property-value[]",e,r,t,0),Q(r);return t}if(null!=a){if(Array.isArray(t)&&(t.length==a||t.length>=7)){if(l=0,"icon-source"==r||"line-style-texture"==r){if("string"!=typeof t[0])return W("wrong-property-value[]",e,r,t,0),Q(r);if(null==j.stylesheetBitmaps[t[0]])return W("wrong-object",e,r,t,null,"bitmap"),Q(r);l=1}for(u=t.length;l<u;l++)if("number"!=typeof t[l])return W("wrong-property-value[]",e,r,t,l),Q(r);return 7==t.length&&(t[7]=0),t}return W("wrong-property-value",e,r,t),Q(r)}return t;case"string":if("line-type"==r||"point-type"==r)switch(t){case"screen":case"flat":case"screen-flat":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("line-label-type"==r)switch(t){case"flat":case"screen-flat":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("line-style"==r)switch(t){case"solid":case"texture":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("label-size-units"==r)switch(t){case"pixels":case"points":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("line-width-units"==r)switch(t){case"pixels":case"points":case"meters":case"ratio":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("label-origin"==r||"icon-origin"==r)switch(t){case"top-left":case"top-right":case"top-center":case"center-left":case"center-right":case"center-center":case"bottom-left":case"bottom-right":case"bottom-center":return t;default:return W("wrong-property-value",e,r,t),Q(r)}if("label-align"==r)switch(t){case"left":case"right":case"center":return t;default:return W("wrong-property-value",e,r,t),Q(r)}return t;case"number":return t>i||t<s?(W("wrong-property-value",e,r,t),Q(r)):t;case"boolean":return t}},K=function(e,r,t){switch(r){case"inherit":return Z(e,r,t,"string");case"reduce":case"dynamic-reduce":case"line-points":return Z(e,r,t,"object");case"line":return Z(e,r,t,"boolean");case"line-type":return Z(e,r,t,"string");case"line-flat":return Z(e,r,t,"boolean");case"line-width":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"line-width-units":return Z(e,r,t,"string");case"line-color":return Z(e,r,t,"object",4,0,255);case"line-style":return Z(e,r,t,"string");case"line-style-texture":return Z(e,r,t,"object",3,-Number.MAX_VALUE,Number.MAX_VALUE);case"line-style-background":return Z(e,r,t,"object",4,0,255);case"line-label":return Z(e,r,t,"boolean");case"line-label-type":case"line-label-source":return Z(e,r,t,"string");case"line-label-color":case"line-label-color2":return Z(e,r,t,"object",4,0,255);case"line-label-size":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"line-label-offset":return Z(e,r,t,"number",null,-Number.MAX_VALUE,Number.MAX_VALUE);case"line-label-spacing":case"line-label-line-height":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"line-label-no-overlap":return Z(e,r,t,"boolean");case"line-label-no-overlap-factor":return Z(e,r,t,"object");case"line-label-no-overlap-margin":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"point":return Z(e,r,t,"boolean");case"point-type":return Z(e,r,t,"string");case"point-flat":return Z(e,r,t,"boolean");case"point-radius":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"point-Layer":return Z(e,r,t,"string");case"point-color":return Z(e,r,t,"object",4,0,255);case"icon":return Z(e,r,t,"boolean");case"icon-source":return Z(e,r,t,"object",5,-Number.MAX_VALUE,Number.MAX_VALUE);case"icon-scale":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"icon-offset":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"icon-origin":return Z(e,r,t,"string");case"icon-stick":return Z(e,r,t,"object",8,-Number.MAX_VALUE,Number.MAX_VALUE);case"icon-color":return Z(e,r,t,"object",4,0,255);case"icon-no-overlap":return Z(e,r,t,"boolean");case"icon-no-overlap-factor":return Z(e,r,t,"object");case"icon-no-overlap-margin":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"label":return Z(e,r,t,"boolean");case"label-color":case"label-color2":return Z(e,r,t,"object",4,0,255);case"label-source":return Z(e,r,t,"string");case"label-size":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"label-size-units":return Z(e,r,t,"string");case"label-spacing":case"label-line-height":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"label-offset":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"label-origin":case"label-align":return Z(e,r,t,"string");case"label-stick":return Z(e,r,t,"object",8,-Number.MAX_VALUE,Number.MAX_VALUE);case"label-width":return Z(e,r,t,"number",null,1e-4,Number.MAX_VALUE);case"label-no-overlap":return Z(e,r,t,"boolean");case"label-no-overlap-factor":return Z(e,r,t,"object");case"label-no-overlap-margin":return Z(e,r,t,"object",2,-Number.MAX_VALUE,Number.MAX_VALUE);case"polygon":return Z(e,r,t,"boolean");case"polygon-style":return Z(e,r,t,"string");case"polygon-use-stencil":return Z(e,r,t,"boolean");case"polygon-culling":return Z(e,r,t,"string");case"polygon-color":return Z(e,r,t,"object",4,0,255);case"polygon-extrude":return Z(e,r,t,"number",0,-Number.MAX_VALUE,Number.MAX_VALUE);case"z-index":return Z(e,r,t,"number",null,-Number.MAX_VALUE,Number.MAX_VALUE);case"zbuffer-offset":return Z(e,r,t,"object",3,0,Number.MAX_VALUE);case"selected-hover-layer":case"selected-layer":return Z(e,r,t,"string");case"hover-event":return Z(e,r,t,"boolean");case"hover-layer":return Z(e,r,t,"string");case"enter-event":case"leave-event":case"click-event":case"draw-event":case"advanced-hit":case"export-geometry":case"pack":case"visible":return Z(e,r,t,"boolean");case"visibility":return Z(e,r,t,"number",null,1e-5,Number.MAX_VALUE);case"visibility-abs":return Z(e,r,t,"object",2,1e-5,Number.MAX_VALUE);case"visibility-rel":return Z(e,r,t,"object",4,1e-5,Number.MAX_VALUE);case"visibility-switch":case"hysteresis":return Z(e,r,t,"object");case"culling":return Z(e,r,t,"number",180,1e-4,180);case"next-pass":return Z(e,r,t,"object");case"importance-source":return Z(e,r,t,"string");case"importance-weight":return Z(e,r,t,"number",null,0,Number.MAX_VALUE)}return t},Q=function(e){switch(e){case"inherit":return"";case"filter":case"reduce":case"dynamic-reduce":return null;case"line-points":return["vertices",0,0];case"line":return!1;case"line-type":return"screen";case"line-flat":return!1;case"line-width":return 1;case"line-width-units":return"meters";case"line-color":return[255,255,255,255];case"line-style":return"solid";case"line-style-texture":return null;case"line-style-background":return[0,0,0,0];case"line-label":return!1;case"line-label-type":return"flat";case"line-label-font":return["#default"];case"line-label-color":return[255,255,255,255];case"line-label-color2":return[0,0,0,255];case"line-label-outline":return[.27,.75,2.2,2.2];case"line-label-source":return"$name";case"line-label-size":return 1;case"line-label-offset":return 0;case"line-label-spacing":case"line-label-line-height":return 1;case"line-label-no-overlap":return!0;case"line-label-no-overlap-factor":return null;case"line-label-no-overlap-margin":return 1.1;case"point":return!1;case"point-type":return"screen";case"point-flat":return!1;case"point-radius":return 1;case"point-Layer":return"solid";case"point-color":return[255,255,255,255];case"icon":return!1;case"icon-source":return null;case"icon-scale":return 1;case"icon-offset":return[0,0];case"icon-origin":return"bottom-center";case"icon-stick":return[0,0,0,255,255,255,255,0];case"icon-color":return[255,255,255,255];case"icon-no-overlap":return!1;case"icon-no-overlap-factor":return null;case"icon-no-overlap-margin":return[5,5];case"label":return!1;case"label-font":return["#default"];case"label-color":return[255,255,255,255];case"label-color2":return[0,0,0,255];case"label-outline":return[.27,.75,2.2,2.2];case"label-source":return"$name";case"label-size":return 10;case"label-size-units":return"pixels";case"label-spacing":case"label-line-height":return 1;case"label-offset":return[0,0];case"label-origin":return"bottom-center";case"label-align":return"center";case"label-stick":return[0,0,0,255,255,255,255,0];case"label-width":return 200;case"label-no-overlap":return!0;case"label-no-overlap-factor":return null;case"label-no-overlap-margin":return[5,5];case"polygon":return!1;case"polygon-style":return"solid";case"polygon-use-stencil":return!0;case"polygon-culling":return"none";case"polygon-color":return[255,255,255,255];case"polygon-extrude":case"z-index":return 0;case"zbuffer-offset":return[0,0,0];case"selected-hover-layer":case"selected-layer":return"";case"hover-event":return!1;case"hover-layer":return"";case"enter-event":case"leave-event":case"click-event":case"draw-event":case"advanced-hit":case"export-geometry":case"pack":return!1;case"visible":return!0;case"visibility":case"visibility-abs":case"visibility-rel":case"visibility-switch":case"hysteresis":return null;case"culling":return 180;case"next-pass":case"importance-source":return null;case"importance-weight":return 1}};function ee(e,r,t,n,a,s,i,o,l){var u,c,f,h;if(!e||!Array.isArray(e))return!1;if(o>100)return!1;switch(e[0]){case"all":for(u=1,c=e.length;u<c;u++)if(!ee(e[u],r,t,n,a,s,i,o+1,l))return!1;return!0;case"any":for(u=1,c=e.length;u<c;u++)if(ee(e[u],r,t,n,s,i,o+1,l))return!0;return!1;case"none":for(u=1,c=e.length;u<c;u++)if(ee(e[u],r,t,n,s,i,o+1,l))return!1;return!0;case"skip":return!1}switch(l&&e[2]?f=e[1]:(j.disableLog="has"==e[0]||"!has"==e[0],f=H(a,s,r,i,e[1],0),j.disableLog=!1),e[0]){case"==":case"!=":case">=":case"<=":case">":case"<":if(void 0===(h=e[l?3:2]))return!1;l&&e[4]||(h=H(a,s,r,i,h,0))}switch(e[0]){case"==":return f==h;case"!=":return f!=h;case">=":return f>=h;case"<=":return f<=h;case">":return f>h;case"<":return f<h;case"has":return void 0!==f;case"!has":return void 0===f;case"in":for(u=l?3:2,c=e.length;u<c;u++)if(e[u]==f)return!0;return!1;case"!in":for(u=l?3:2,c=e.length;u<c;u++)if(e[u]==f)return!1;return!0}return!1}function re(e){switch(typeof e){case"number":return!0;case"string":if(!(e.length>0))return!0;switch(e.charAt(0)){case"#":case"$":case"@":case"&":break;default:if(-1==e.indexOf("{"))return!0}}return!1}var te=function(e,r,t){var n,a,s={};for(n in function(e,r,t,n){for(var a in null!=t.inherit&&J(e,r,t,n,0),t)r[a]=t[a];r["$$layer-id"]=e}(e,s,r,t),s){if("string"==typeof(a=s[n])&&a.length>0)switch(a.charAt(0)){case"@":null!=j.stylesheetConstants[a]?s[n]=j.stylesheetConstants[a]:(W("wrong-object",e,n,a,null,"constant"),s[n]=Q(n));break;case"%":null!=j.stylesheetLocals[a]?(s["$$layer-variables"]||(s["$$layer-variables"]={}),s["$$layer-variables"][n]=a,s[n]=j.stylesheetLocals[a]):(W("wrong-object",e,n,a,null,"variable"),s[n]=Q(n))}if("visibility-switch"==n){if(!(Array.isArray(a)&&a.length>0))return W("wrong-property-value",e,n,a),Q(n);for(var i=0,o=a.length;i<o;i++){var l=a[i],u=!1;"object"==typeof l&&Array.isArray(l)&&2==l.length?("string"==typeof l[0]&&"@"==l[0].charAt(0)&&(void 0===j.stylesheetConstants[l[0]]?u=!0:l[0]=j.stylesheetConstants[l[0]]),("number"!=typeof l[0]||"string"!=typeof l[1]&&null!==l[1])&&(u=!0)):u=!0,u&&W("wrong-property-value[]",e,n,a,i)}}}return s},ne=n,ae=function(e){if(o)return o.encode(e);for(var r=String(e),t=r.length,n=0,a=[];n<t;){var s=r.charCodeAt(n);if(s<55296||s>57343)a.push(s);else if(56320<=s&&s<=57343)a.push(65533);else if(55296<=s&&s<=56319)if(n===t-1)a.push(65533);else{var i=r.charCodeAt(n+1);if(56320<=i&&i<=57343){var l=1023&s,u=1023&i;a.push(65536+(l<<10)+u),n+=1}else a.push(65533)}n+=1}return new Uint8Array(new Uint32Array(a).buffer)},se=new Uint8Array(16777216),ie=new Uint8Array(16777216),oe=[],le=[];function ue(e,r){ne.config.mapPackLoaderEvents?(oe.push(e),r&&(le=le.concat(r))):r?postMessage(e,r):postMessage(e)}function ce(e,r,t,n,a){var s,i,o=ae(JSON.stringify(t)),l=6+o.byteLength;for(s=0,i=n.length;s<i;s++)l+=4+n[s].byteLength;var u,c=new Uint8Array(l),f=new DataView(c.buffer),h=0;for(f.setUint8(h,e),h+=1,f.setUint8(h,r),h+=1,f.setUint32(h,o.byteLength),h+=4,c.set(o,h),u=h+=o.byteLength,s=0,i=n.length;s<i;s++)f.setUint32(h,n[s].length),h+=4,c.set(new Uint8Array(n[s].buffer),h),h+=n[s].byteLength;fe(e,r,c.buffer,u,a,t.hitable,t.totalPoints,11==r?t:null)}function fe(e,r,t,n,a,s,i,o){if(ne.messageBufferIndex>=ne.messageBufferSize){var l=ne.messageBuffer;ne.messageBufferSize+=65536,ne.messageBuffer=new Array(ne.messageBufferSize);for(var u=0,c=ne.messageBufferIndex;u<c;u++)ne.messageBuffer[u]=l[u]}ne.messageBuffer[ne.messageBufferIndex]={command:e,type:r,job:t,buffersIndex:n,signature:a,hitable:s,totalPoints:i,job2:o},ne.messageBufferIndex++,ne.messagePackSize+=t.byteLength}function he(e,r,t){var n=1==e?ie:se;if(n.byteLength<=r.byteLength+t){var a=new Uint8Array(2*n.byteLength);a.set(n,0),n=a,1==e?ie=n:se=n}n.set(r,t)}var ve=n,de=a,be=q,ge=$,pe=function(e,r,t,n,a,s,i,o,l,u,c,f,h){for(var v=[0,1,0],d=[e[0],e[1],e[2]],b=f||S.U.stringToGlyphs(s,t),g=b[0],p=b[1],y=0,L=g.length;y<L;y++){var A=g[y],m=s[p[y]];if(m){var N=O(n,m),U=M(d,r,0,A,N,a,u,u,v,s,i,o,l,c,p[y],h);d=U[0],u=U[1]}}return u},ye=function(e,r,t,n,a,s){for(var i=0,o=s||S.U.stringToGlyphs(a,e),l=o[0],u=o[1],c=o[2],f=0,h=l.length;f<h;f++){var v=l[f],d=c[f];if(i>r&&(10==d||9==d||32==d))return f;if(10!=d){var b=a[u[f]];if(b){var g=O(t,b)*n,p=b.glyphs[v];p&&(i+=f==h-1?p.lx*g:p.step*g)}}}return h},Le=P,Ae=_,me=F,Ne=z,Ue=C,we=B,xe=function(e,r,t){var n=O(e,t[0]);return t[0].cly*n*r},Se=ce,Me=function(e){var r,t,n,a,s,i,o,l=[];if(e["d-points"]||e["d-lines"]){if(l=e["d-points"]||e["d-lines"],Array.isArray(l)&&s.length>0)for(n=0,a=l;n<a;n++)if(s=l[n],Array.isArray(s)&&s.length>0)for((i=s[0])[0]=i[0]>>1^-(1&i[0]),i[1]=i[1]>>1^-(1&i[1]),i[2]=i[2]>>1^-(1&i[2]),r=1,t=s.length;r<t;r++)i=s[r-1],(o=s[r])[0]=(o[0]>>1^-(1&o[0]))+i[0],o[1]=(o[1]>>1^-(1&o[1]))+i[1],o[2]=(o[2]>>1^-(1&o[2]))+i[2];e["d-points"]?(e.points=e["d-points"],delete e["d-points"]):(e.lines=e["d-lines"],delete e["d-lines"])}},Be=function(e,r,t,n,a,s){var i,o,l,u,c,f=[];if(Me(e),(f=e.lines?e.lines:[e.points])&&0!=f.length){var h,v,d,b,g=be(t,"visibility-rel",e,r)||be(t,"visibility-abs",e,r)||be(t,"visibility",e,r),p=be(t,"culling",e,r),y=be(t,"hover-event",e,r),L=be(t,"click-event",e,r),A=be(t,"draw-event",e,r),m=be(t,"enter-event",e,r),N=be(t,"leave-event",e,r),U=be(t,"advanced-event",e,r),w=be(t,"line-points",e,r),x=be(t,"zbuffer-offset",e,r),S=be(t,"point",e,r),M=be(t,"point-flat",e,r),B=be(t,"point-color",e,r),O=.5*be(t,"point-radius",e,r),_=0;for(l=0,u=f.length;l<u;l++)c=f[l],Array.isArray(c)&&c.length>0&&(_+=c.length);var k=be(t,"icon",e,r);if(k)if(h=be(t,"icon-source",e,r)){v=we()*_,d=we(!0)*_;var I={color:be(t,"icon-color",e,r),scale:be(t,"icon-scale",e,r),offset:be(t,"icon-offset",e,r),stick:be(t,"icon-stick",e,r),reduce:be(t,"dynamic-reduce",e,r),origin:be(t,"icon-origin",e,r),source:be(t,"icon-source",e,r),noOverlap:be(t,"icon-no-overlap",e,r),noOverlapMargin:be(t,"icon-no-overlap-margin",e,r),noOverlapFactor:be(t,"icon-no-overlap-factor",e,r),index:0,index2:0};_>1?(I.vertexBuffer=new Float32Array(v),I.originBuffer=new Float32Array(d),I.texcoordsBuffer=new Float32Array(v)):I.singleBuffer=new Float32Array(16)}else k=!1;var E=be(t,"label",e,r);if(E){h=be(t,"label-source",e,r);var C=ge(t,h,e,r,h);C=C?C.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var F=be(t,"label-size",e,r),z=be(t,"label-font",e,r),P=me(z),j=Le(C,P);if("$name"==h&&!Ue(C,P,j)){var T=ge(t,"$name:en",e,r,h);T=T?T.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var V=Le(T,P);Ue(T,P)&&(C=T,j=V)}if(C&&""!=C&&Math.abs(F)>1e-4){b=be(t,"label-no-overlap",e,r),v=we()*C.length*(b?1:_),d=we(!0)*C.length*(b?1:_);var G=1==_,X=1;"points"==be(t,"label-size-units",e,r)&&(X=ve.pixelFactor/(1/72*96));var D={color:be(t,"label-color",e,r),color2:be(t,"label-color2",e,r),outline:be(t,"label-outline",e,r),reduce:be(t,"dynamic-reduce",e,r),size:F*X,spacing:be(t,"label-spacing",e,r),lineHeight:be(t,"label-line-height",e,r),offset:be(t,"label-offset",e,r),stick:be(t,"label-stick",e,r),origin:be(t,"label-origin",e,r),align:be(t,"label-align",e,r),fonts:P,fontsStorage:Ne(z),text:C,hysteresis:be(t,"hysteresis",e,r),width:X*be(t,"label-width",e,r),noOverlap:b,noOverlapMargin:be(t,"label-no-overlap-margin",e,r),noOverlapFactor:be(t,"label-no-overlap-factor",e,r),vertexBuffer:G?null:new Float32Array(v),originBuffer:G?null:new Float32Array(d),texcoordsBuffer:G?null:new Float32Array(v),singleBuffer:G?new Float32Array(4*C.length*2):null,index:0,index2:0,glyphsRes:j};D.stick&&(D.stick=D.stick.slice(),D.stick[2]*=X)}else E=!1}var R,$,q,Y,H,J,W,Z=0,K=0,Q=[0,0,0],ee=ve.forceOrigin,re=ve.bboxMin,te=ve.tileX,ne=ve.tileY,ae=ve.forceScale,se=function(e){if(k&&!I.noOverlap&&($=_e(J,I)),E&&!D.noOverlap&&(R=ke(J,D)),S)for(var r=0;r<Fe;r++)M?(Oe[Z]=J[0],Oe[Z+1]=J[1],Oe[Z+2]=J[2],Oe[Z+3]=J[0]+Ce[r][0]*O,Oe[Z+4]=J[1]+Ce[r][1]*O,Oe[Z+5]=J[2],Oe[Z+6]=J[0]+Ce[r+1][0]*O,Oe[Z+7]=J[1]+Ce[r+1][1]*O,Oe[Z+8]=J[2],Z+=9):(Oe[Z]=J[0],Oe[Z+1]=J[1],Oe[Z+2]=J[2],Oe[Z+3]=0,Ie[K]=0,Ie[K+1]=0,Ie[K+2]=0,Ie[K+3]=0,Oe[Z+4]=J[0],Oe[Z+5]=J[1],Oe[Z+6]=J[2],Oe[Z+7]=0,Ie[K+4]=Ce[r][0]*O,Ie[K+5]=Ce[r][1]*O,Ie[K+6]=0,Ie[K+7]=0,Oe[Z+8]=J[0],Oe[Z+9]=J[1],Oe[Z+10]=J[2],Oe[Z+11]=0,Ie[K+8]=Ce[r+1][0]*O,Ie[K+9]=Ce[r+1][1]*O,Ie[K+10]=0,Ie[K+11]=0,Z+=12,K+=12)},ie=function(e){var r=0,t=0;if(q=c[0],Y=[q[0],q[1],q[2]],ee&&(Y=[Y[0]-te,Y[1]-ne,Y[2]]),null!=ae&&(Y=[Y[0]*ae[0],Y[1]*ae[1],Y[2]*ae[2]]),0==e)return Y;for(var n=0,a=c.length-1;n<a;n++){q=c[n+1],H=[q[0],q[1],q[2]],ee&&(H=[H[0]-te,H[1]-ne,H[2]]),null!=ae&&(H=[H[0]*ae[0],H[1]*ae[1],H[2]*ae[2]]);var s=H[0]-Y[0],i=H[1]-Y[1],o=H[2]-Y[2],l=Math.sqrt(s*s+i*i+o*o);if(r=t,t+=l,e>=r&&e<=t){var u=(e-r)/l;return[Y[0]+s*u,Y[1]+i*u,Y[2]+o*u]}Y=H}},oe=new Array(2048),le=0;for(l=0,u=f.length;l<u;l++)if(c=f[l],Array.isArray(c)&&c.length>0){var ue=0,ce=null;for("vertices"!=w[0]&&((ce=new Array(c.length))[0]=0),i=0,o=c.length;i<o;i++){if(q=c[i],Y=[q[0],q[1],q[2]],ee&&(Y=[Y[0]-te,Y[1]-ne,Y[2]]),null!=ae&&(Y=[Y[0]*ae[0],Y[1]*ae[1],Y[2]*ae[2]]),i+1<o){q=c[i+1],H=[q[0],q[1],q[2]],ee&&(H=[H[0]-te,H[1]-ne,H[2]]),null!=ae&&(H=[H[0]*ae[0],H[1]*ae[1],H[2]*ae[2]]);var fe=H[0]-Y[0],he=H[1]-Y[1],pe=H[2]-Y[2],ye=Math.sqrt(fe*fe+he*he+pe*pe);ce&&(ce[i]=ye),ue+=ye}Q[0]+=Y[0],Q[1]+=Y[1],Q[2]+=Y[2],"vertices"==w[0]&&(oe[le]=Y,le++)}if("by-length"==w[0]||"by-ratio"==w[0]){var Ae=w[1],xe=w[2]||0;if("by-ratio"==w[0]&&(Ae*=ue,xe*=ue),Ae<=0)oe[le]=ie(xe),oe[le]&&le++;else for(i=xe;i<ue;i+=Ae)oe[le]=ie(i),oe[le]&&le++}"start"==w[0]&&(oe[le]=ie(0),le++),"end"==w[0]&&(oe[le]=ie(ue),le++),"endpoints"==w[0]&&(oe[le]=ie(0),oe[++le]=ie(ue),le++),"middle"!=w[0]&&"midpoint"!=w[0]||(oe[le]=ie(.5*ue),le++)}var Be,Oe,Ie,Ee=le;if(S){var Ce=[],Fe=de(8*O*.5,8,32),ze=0,Pe=2*Math.PI/Fe;for(i=0;i<Fe;i++)Ce[i]=[-Math.sin(ze),Math.cos(ze)],ze+=Pe;Ce[Fe]=[0,1],M?(Be=3*Fe*3,Oe=new Float32Array(Ee*Be)):(Be=3*Fe*4,Oe=new Float32Array(Ee*Be),Ie=new Float32Array(Ee*(3*Fe*4)))}if(le){for(ve.directPoints=oe.slice(0,le),i=0;i<le;i++)J=oe[i],se();_>0&&(Q[0]/=_,Q[1]/=_,Q[2]/=_),Q[0]+=re[0],Q[1]+=re[1],Q[2]+=re[2];var je=y||L||m||N;ve.signatureCounter++;var Te=""+ve.signatureCounter;g&&!Array.isArray(g)&&(g=[g]),S&&(M?Se(5,6,{color:B,"z-index":a,visibility:g,center:Q,"hover-event":y,"click-event":L,"draw-event":A,advancedHit:U,"enter-event":m,"leave-event":N,"zbuffer-offset":x,hitable:je,state:ve.hitState,eventInfo:ve.alwaysEventInfo||je||A?s:{},lod:ve.autoLod?null:ve.tileLod},[Oe],Te):Se(5,9,{color:B,"z-index":a,visibility:g,center:Q,"hover-event":y,"click-event":L,"draw-event":A,"enter-event":m,"leave-event":N,"zbuffer-offset":x,hitable:je,state:ve.hitState,eventInfo:ve.alwaysEventInfo||je||A?s:{},lod:ve.autoLod?null:ve.tileLod},[Oe,Ie],Te));var Ve=function(){if(k){if(ve.signatureCounter++,Te=""+ve.signatureCounter,I.noOverlap){var e=I.noOverlapMargin,r=null,t=null;if(null!==I.noOverlapFactor){switch(I.noOverlapFactor[0]){case"direct":r=0;break;case"div-by-dist":r=1}t=I.noOverlapFactor[1]}var i=[$[0]-e[0],$[1]-e[1],$[2]+e[0],$[3]+e[1],r,t]}(I.singleBuffer&&I.singleBuffer.length>0||I.vertexBuffer&&I.vertexBuffer.length>0)&&Se(5,I.singleBuffer?3:4,{icon:ve.stylesheetBitmaps[I.source[0]],color:I.color,"z-index":a,visibility:g,culling:p,center:W,stick:I.stick,"hover-event":y,"click-event":L,"draw-event":A,advancedHit:U,"enter-event":m,"leave-event":N,"zbuffer-offset":x,noOverlap:I.noOverlap?i:null,hitable:je,state:ve.hitState,eventInfo:ve.alwaysEventInfo||je||A?s:{},index:n,reduce:I.reduce,lod:ve.autoLod?null:ve.tileLod},I.singleBuffer?[I.singleBuffer]:[I.vertexBuffer,I.originBuffer,I.texcoordsBuffer],Te)}},Ge=function(){if(E){if(ve.signatureCounter++,Te=""+ve.signatureCounter,D.noOverlap){var e=D.noOverlapMargin,r=null,t=null;if(null!==D.noOverlapFactor){switch(D.noOverlapFactor[0]){case"direct":r=0;break;case"div-by-dist":r=1}t=D.noOverlapFactor[1]}var i=[R[0]-e[0],R[1]-e[1],R[2]+e[0],R[3]+e[1],r,t]}(D.singleBuffer&&D.singleBuffer.length>0||D.vertexBuffer&&D.vertexBuffer.length>0)&&Se(5,D.singleBuffer?1:2,{size:D.size,origin:D.pos,color:D.color,color2:D.color2,outline:D.outline,"z-index":a,visibility:g,culling:p,center:W,stick:D.stick,noOverlap:D.noOverlap?i:null,"hover-event":y,"click-event":L,"draw-event":A,files:D.files,index:n,"enter-event":m,"leave-event":N,"zbuffer-offset":x,fonts:D.fontsStorage,hitable:je,state:ve.hitState,advancedHit:U,reduce:D.reduce,hysteresis:D.hysteresis,eventInfo:ve.alwaysEventInfo||je||A?s:{},lod:ve.autoLod?null:ve.tileLod},D.singleBuffer?[D.singleBuffer]:[D.vertexBuffer,D.originBuffer,D.texcoordsBuffer],Te)}};for(k&&!I.noOverlap&&(W=Q,Ve()),E&&!D.noOverlap&&(W=Q,Ge()),i=0,o=ve.insidePack?1:ve.directPoints.length;i<o;i++)J=ve.directPoints[i],W=[J[0]+re[0],J[1]+re[1],J[2]+re[2]],k&&I.noOverlap&&($=_e(J,I,$),Ve()),E&&D.noOverlap&&(R=ke(J,D,R),Ge())}}},Oe=function(e,r,t){switch(e){case"top-left":return[0,0];case"top-right":return[-r,0];case"top-center":return[.5*-r,0];case"center-left":return[0,.5*-t];case"center-right":return[-r,.5*-t];case"center-center":return[.5*-r,.5*-t];case"bottom-left":return[0,-t];case"bottom-right":return[-r,-t];case"bottom-center":return[.5*-r,-t]}},_e=function(e,r,t){t&&(r.index=0,r.index2=0,r.vertexBuffer=r.vertexBuffer?new Float32Array(r.vertexBuffer.length):null,r.originBuffer=r.originBuffer?new Float32Array(r.originBuffer.length):null,r.singleBuffer=r.singleBuffer?new Float32Array(r.singleBuffer.length):null);var n=r.source,a=r.index,s=r.index2,i=a,o=Math.abs(n[3]*r.scale*.5),l=Math.abs(n[4]*r.scale*.5),u=Oe(r.origin,o,l),c=u[0]+r.offset[0],f=u[1]+r.offset[1];if(r.singleBuffer){var h=r.singleBuffer;return h[0]=c,h[1]=f,h[2]=n[1],h[3]=n[2],h[4]=o+c,h[5]=f,h[6]=n[1]+n[3],h[7]=n[2],h[8]=o+c,h[9]=l+f,h[10]=n[1]+n[3],h[11]=n[2]+n[4],h[12]=c,h[13]=l+f,h[14]=n[1],h[15]=n[2]+n[4],[.5*c,.5*f,.5*(c+o)+1,.5*(f+l)]}var v=r.vertexBuffer,d=r.texcoordsBuffer,b=r.originBuffer;v[a]=0,v[a+1]=0,v[a+2]=0,v[a+3]=0,v[a+4]=o,v[a+5]=0,v[a+6]=0,v[a+7]=0,v[a+8]=o,v[a+9]=-l,v[a+10]=0,v[a+11]=0,d[a]=n[1],d[a+1]=n[2],d[a+2]=0,d[a+3]=0,d[a+4]=n[1]+n[3],d[a+5]=n[2],d[a+6]=0,d[a+7]=0,d[a+8]=n[1]+n[3],d[a+9]=n[2]+n[4],d[a+10]=0,d[a+11]=0,v[a+=12]=0,v[a+1]=0,v[a+2]=0,v[a+3]=0,v[a+4]=0,v[a+5]=-l,v[a+6]=0,v[a+7]=0,v[a+8]=o,v[a+9]=-l,v[a+10]=0,v[a+11]=0,d[a]=n[1],d[a+1]=n[2],d[a+2]=0,d[a+3]=0,d[a+4]=n[1],d[a+5]=n[2]+n[4],d[a+6]=0,d[a+7]=0,d[a+8]=n[1]+n[3],d[a+9]=n[2]+n[4],d[a+10]=0,d[a+11]=0,a+=12;for(var g=e[0],p=e[1],y=e[2],L=i;L<a;L+=4)v[L]+=c,v[L+1]-=f,b[s]=g,b[s+1]=p,b[s+2]=y,s+=3;return r.index=a,r.index2=s,[.5*c,.5*f,.5*(c+o)+1,.5*(f+l)]},ke=function(e,r,t){t&&(r.index=0,r.index2=0,r.vertexBuffer=r.vertexBuffer?new Float32Array(r.vertexBuffer.length):null,r.originBuffer=r.originBuffer?new Float32Array(r.originBuffer.length):null,r.singleBuffer=r.singleBuffer?new Float32Array(r.singleBuffer.length):null);var n=r.vertexBuffer,a=r.texcoordsBuffer,s=r.originBuffer,i=r.singleBuffer,o=r.index,l=r.index2,u=o,c=(r.text,r.fonts),f={},h=r.glyphsRes,v=[],d=[];do{var b=h[2].indexOf(10);-1!=b?(v.push([h[0].slice(0,b),h[1].slice(0,b),h[2].slice(0,b)]),h=[h[0].slice(b+1),h[1].slice(b+1),h[2].slice(b+1)]):v.push(h)}while(-1!=b);for(var g=0,p=v.length;g<p;g++)for(h=v[g];;){var y=ye(null,r.width,r.size,r.spacing,c,h);if(h[2].length==y){d.push(h);break}d.push([h[0].slice(0,y),h[1].slice(0,y),h[2].slice(0,y)]),h=[h[0].slice(y+1),h[1].slice(y+1),h[2].slice(y+1)]}var L=0,A=0,m=xe(r.size,r.lineHeight,c),N=0,U=[];for(g=0,p=d.length;g<p;g++)U[g]=Ae(null,r.size,r.spacing,c,d[g]),N=Math.max(U[g],N);for(g=0,p=d.length;g<p;g++){var w=U[g];switch(r.align){case"left":L=0;break;case"right":L=N-w;break;case"center":L=.5*(N-w)}o=pe([L,A,0],[1,0,0],null,r.size,r.spacing,c,n,a,!0,o,f,d[g],i),A-=m}var x=Oe(r.origin,N,-A),S=x[0]+r.offset[0],M=x[1]+r.offset[1],B=e[0],O=e[1],_=e[2];if(i){for(g=u;g<o;g+=8)i[g]+=S,i[g+1]-=M,i[g+2]+=S,i[g+3]-=M;r.pos=[B,O,_],i=new Float32Array(i.buffer,0,o)}else for(g=u;g<o;g+=4)n[g]+=S,n[g+1]-=M,s[l]=B,s[l+1]=O,s[l+2]=_,l+=3;c=r.fonts;for(r.files=new Array(c.length),g=0,p=c.length;g<p;g++)r.files[g]=[];for(var k in f){var I=parseInt(k),E=f[k],C=[];for(var F in E){var z=parseInt(F)-4e3*I,P=Math.round((z-z%4)/4);-1==C.indexOf(P)&&C.push(P)}r.files[I]=C}return r.index=o,r.index2=l,[.5*S,.5*M,.5*(S+N)+1,.5*(M+Math.abs(A))]},Ie=n,Ee=s,Ce=i,Fe=q,ze=$,Pe=function(e,r){return void 0!==e[r]},je=function(e,r,t,n,a,s,i,o,l,u,c,f){var h=_(r,t,n,a,c),v=k(e),d=.5*(v-h);if(d<0&&(d=0),!(h>v)){var b=E(e,d,r,t,n,a,c);return N.textVector=b,N.textCenter=I(e,.5*v)[0],N.textLength=h,function(e,r,t,n,a,s,i,o,l,u,c,f,h,v){null==s&&(s=[0,1,0]);var d=e[0];d=[d[0],d[1],d[2]];var b=r,g=h||S.U.stringToGlyphs(i,t),p=g[0],y=g[1];N.processLineLabel=!0;for(var L=0,A=p.length;L<A;L++){var m=p[L],w=i[y[L]];if(w){var x=O(n,w),B=.01,_=w.glyphs[m];_&&(B=_.step*x*a);var k=I(e,b),E=I(e,b+B),C=[.5*(E[1][0]+k[1][0]),.5*(E[1][1]+k[1][1]),.5*(E[1][2]+k[1][2])];U(C);var F=M(k[0],C,-x*w.size*.7+o,m,x,a,c,c,s,i,l,u,null,f,y[L],v);d=F[0],c=F[1],b+=B}}return N.processLineLabel=!1,c}(e,d,r,t,n,b,a,s,i,o,l,u,c,f)}},Te=C,Ve=B,Ge=F,Xe=z,De=ce,Re=P,$e=Me,qe=function(e,r,t,n,a,s){$e(e);var i=e.lines;if(i&&0!=i.length){var o=Fe(t,"line",e,r),l=Fe(t,"line-label",e,r);if(o||l){var u=Fe(t,"hover-event",e,r),c=Fe(t,"click-event",e,r),f=Fe(t,"draw-event",e,r),h=Fe(t,"enter-event",e,r),v=Fe(t,"leave-event",e,r),d=Fe(t,"advanced-hit",e,r),b=Fe(t,"zbuffer-offset",e,r);if(Pe(t,"line-type"));else var g=Fe(t,"line-flat",e,r);var p=Fe(t,"line-color",e,r),y=.5*Fe(t,"line-width",e,r),L=Fe(t,"line-width-units",e,r),A=Fe(t,"line-style",e,r),m=Fe(t,"line-style-texture",e,r),N=Fe(t,"line-style-background",e,r),U=Fe(t,"line-label-size",e,r),w="solid"!=A,x="ratio"==L;"points"==L&&(y*=Ie.pixelFactor/(1/72*96));var S,M,B,O,_,k,I,E,C,F,z,P,j=0,T=0,V=0,G=!1,X=1;if(!(G=x?!g&&1080*y<2.1:!g&&y<2.1)){var D=[],R=[],$=8,q=0,Y=2*Math.PI/$;for(M=0;M<$;M++)D[M]=[-Math.sin(q),Math.cos(q)],R[M]=q,q+=Y;D[$]=[0,1],R[$]=0}var H=0;for(S=0;S<i.length;S++)Array.isArray(i[S])&&(H+=i[S].length);if(!(H<=1)){g&&($=2);var J=3*(w||x||!g?4:3)*2,W=new Float32Array((H-1)*J+H*(G?0:$*(w||x||!g?4:3)*3));if(d)var Z=new Float32Array(6*(H-1)+H*(G?0:$)*3);if(!g||w||x)var K=new Float32Array(24*(H-1)+H*(G?0:3*$*4));var Q=[0,0,0],ee=[],re=Ie.forceOrigin,te=Ie.bboxMin,ne=Ie.geocent,ae=Ie.tileX,se=Ie.tileY,ie=Ie.forceScale,oe=[1,0,0],le=[-1,0,0];for(S=0;S<i.length;S++)if(Array.isArray(i[S])&&i[S].length){var ue=i[S];if(l){var ce=new Array(ue.length),fe=new Array(ue.length);ee.push({points:ce,points2:fe})}F=[(z=ue[0])[0],z[1],z[2]],re&&(F=[F[0]-ae,F[1]-se,F[2]]),null!=ie&&(F=[F[0]*ie[0],F[1]*ie[1],F[2]*ie[2]]);var he=.001,ve=.001,de=j,be=T;for(M=0,B=ue.length-1;M<B;M++)F=ue[M],O=ue[M+1],re&&(F=[F[0]-ae,F[1]-se,F[2]],O=[O[0]-ae,O[1]-se,O[2]]),null!=ie&&(F=[F[0]*ie[0],F[1]*ie[1],F[2]*ie[2]],O=[O[0]*ie[0],O[1]*ie[1],O[2]*ie[2]]),d&&(P=X+M,Z[V]=P,Z[V+1]=P,Z[V+2]=P,Z[V+3]=P,Z[V+4]=P,Z[V+5]=P,V+=6),!g||w||x?g?(ne?(_=[O[0]-F[0],O[1]-F[1],O[2]-F[2]],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]+_[2]*_[2]),I=0!=I?1/I:0,k=[_[0]*I,_[1]*I,_[2]*I],E=[0,0,0],0==M&&(oe=k),M==B-1&&(le=k),Ee(te,C=[0,0,0]),Ce(C,k,E),E=[E[0],E[1],E[2]]):(_=[O[0]-F[0],O[1]-F[1],0],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]),I=0!=I?y/I:0,E=[-_[1],_[0],0],0==M&&(oe=[_[0]*I,_[1]*I,0]),M==B-1&&(le=[_[0]*I,_[1]*I,0])),W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,K[T]=E[0],K[T+1]=E[1],K[T+2]=E[2],K[T+3]=y,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=-he,K[T+4]=-E[0],K[T+5]=-E[1],K[T+6]=-E[2],K[T+7]=y,W[j+8]=O[0],W[j+9]=O[1],W[j+10]=O[2],W[j+11]=ve,K[T+8]=E[0],K[T+9]=E[1],K[T+10]=E[2],K[T+11]=y,W[j+12]=F[0],W[j+13]=F[1],W[j+14]=F[2],W[j+15]=-he,K[T+12]=-E[0],K[T+13]=-E[1],K[T+14]=-E[2],K[T+15]=y,W[j+16]=O[0],W[j+17]=O[1],W[j+18]=O[2],W[j+19]=-ve,K[T+16]=-E[0],K[T+17]=-E[1],K[T+18]=-E[2],K[T+19]=y,W[j+20]=O[0],W[j+21]=O[1],W[j+22]=O[2],W[j+23]=ve,K[T+20]=E[0],K[T+21]=E[1],K[T+22]=E[2],K[T+23]=y,j+=24,T+=24):(_=[O[0]-F[0],O[1]-F[1],0],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]),W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,K[T]=O[0],K[T+1]=O[1],K[T+2]=O[2],K[T+3]=y,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=-he,K[T+4]=O[0],K[T+5]=O[1],K[T+6]=O[2],K[T+7]=-y,W[j+8]=O[0],W[j+9]=O[1],W[j+10]=O[2],W[j+11]=-ve,K[T+8]=F[0],K[T+9]=F[1],K[T+10]=F[2],K[T+11]=y,W[j+12]=F[0],W[j+13]=F[1],W[j+14]=F[2],W[j+15]=he,K[T+12]=O[0],K[T+13]=O[1],K[T+14]=O[2],K[T+15]=y,W[j+16]=O[0],W[j+17]=O[1],W[j+18]=O[2],W[j+19]=-ve,K[T+16]=F[0],K[T+17]=F[1],K[T+18]=F[2],K[T+19]=y,W[j+20]=O[0],W[j+21]=O[1],W[j+22]=O[2],W[j+23]=ve,K[T+20]=F[0],K[T+21]=F[1],K[T+22]=F[2],K[T+23]=-y,j+=24,T+=24):(ne?(_=[O[0]-F[0],O[1]-F[1],O[2]-F[2]],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]+_[2]*_[2]),I=0!=I?1/I:0,k=[_[0]*I,_[1]*I,_[2]*I],E=[0,0,0],Ee(te,C=[0,0,0]),Ce(C,k,E),0==M&&(oe=k),M==B-1&&(le=k),E=[E[0]*y,E[1]*y,E[2]*y]):(_=[O[0]-F[0],O[1]-F[1],0],ve+=I=Math.sqrt(_[0]*_[0]+_[1]*_[1]),I=0!=I?y/I:0,E=[-_[1]*I,_[0]*I,0],0==M&&(oe=[_[0]*I,_[1]*I,0]),M==B-1&&(le=[_[0]*I,_[1]*I,0])),W[j]=F[0]+E[0],W[j+1]=F[1]+E[1],W[j+2]=F[2]+E[2],W[j+3]=F[0]-E[0],W[j+4]=F[1]-E[1],W[j+5]=F[2]-E[2],W[j+6]=O[0]+E[0],W[j+7]=O[1]+E[1],W[j+8]=O[2]+E[2],W[j+9]=F[0]-E[0],W[j+10]=F[1]-E[1],W[j+11]=F[2]-E[2],W[j+12]=O[0]-E[0],W[j+13]=O[1]-E[1],W[j+14]=O[2]-E[2],W[j+15]=O[0]+E[0],W[j+16]=O[1]+E[1],W[j+17]=O[2]+E[2],j+=18),he=ve,F=O;for(F=[z[0],z[1],z[2]],M=0,B=ue.length;M<B;M++){if(re&&(F=[F[0]-ae,F[1]-se,F[2]]),null!=ie&&(F=[F[0]*ie[0],F[1]*ie[1],F[2]*ie[2]]),Q[0]+=F[0],Q[1]+=F[1],Q[2]+=F[2],!G){var ge,pe;if(g)d&&(P=X+(M!=B-1?M:M-1),Z[V]=P,Z[V+1]=P,Z[V+2]=P,Z[V+3]=P,Z[V+4]=P,Z[V+5]=P,V+=6),w||x?(he=M!=B-1?W[M*J+3]:W[(M-1)*J+11],ge=M!=B-1?be+M*J:be+(M-1)*J+8,pe=M>0?be+(M-1)*J+8:be+ge,W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=he,W[j+8]=F[0],W[j+9]=F[1],W[j+10]=F[2],W[j+11]=he,W[j+12]=F[0],W[j+1+12]=F[1],W[j+2+12]=F[2],W[j+3+12]=he,W[j+4+12]=F[0],W[j+5+12]=F[1],W[j+6+12]=F[2],W[j+7+12]=-he,W[j+8+12]=F[0],W[j+9+12]=F[1],W[j+10+12]=F[2],W[j+11+12]=-he,0==M?(K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=-y,K[T+4]=K[ge],K[T+5]=K[ge+1],K[T+6]=K[ge+2],K[T+7]=y,K[T+8]=-oe[0],K[T+9]=-oe[1],K[T+10]=-oe[2],K[T+11]=-y,K[T+12]=0,K[T+1+12]=0,K[T+2+12]=0,K[T+3+12]=-y,K[T+4+12]=-K[ge],K[T+5+12]=-K[ge+1],K[T+6+12]=-K[ge+2],K[T+7+12]=y,K[T+8+12]=-oe[0],K[T+9+12]=-oe[1],K[T+10+12]=-oe[2],K[T+11+12]=-y):M==B-1?(K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=-y,K[T+4]=K[pe],K[T+5]=K[pe+1],K[T+6]=K[pe+2],K[T+7]=y,K[T+8]=le[0],K[T+9]=le[1],K[T+10]=le[2],K[T+11]=-y,K[T+12]=0,K[T+1+12]=0,K[T+2+12]=0,K[T+3+12]=-y,K[T+4+12]=-K[pe],K[T+5+12]=-K[pe+1],K[T+6+12]=-K[pe+2],K[T+7+12]=y,K[T+8+12]=le[0],K[T+9+12]=le[1],K[T+10+12]=le[2],K[T+11+12]=-y):(K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=-y,K[T+4]=K[ge],K[T+5]=K[ge+1],K[T+6]=K[ge+2],K[T+7]=y,K[T+8]=K[pe],K[T+9]=K[pe+1],K[T+10]=K[pe+2],K[T+11]=y,K[T+12]=0,K[T+1+12]=0,K[T+2+12]=0,K[T+3+12]=-y,K[T+4+12]=-K[ge],K[T+5+12]=-K[ge+1],K[T+6+12]=-K[ge+2],K[T+7+12]=y,K[T+8+12]=-K[pe],K[T+9+12]=-K[pe+1],K[T+10+12]=-K[pe+2],K[T+11+12]=y),j+=24,T+=24):(ge=M!=B-1?de+M*J:de+(M-1)*J,pe=M>0?de+(M-1)*J:de+ge,0==M?(W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=W[ge],W[j+4]=W[ge+1],W[j+5]=W[ge+2],W[j+6]=F[0]-oe[0]*y,W[j+7]=F[1]-oe[1]*y,W[j+8]=F[2]-oe[2]*y,W[j+9]=F[0],W[j+9+1]=F[1],W[j+9+2]=F[2],W[j+9+3]=W[ge+3],W[j+9+4]=W[ge+4],W[j+9+5]=W[ge+5],W[j+9+6]=F[0]-oe[0]*y,W[j+9+7]=F[1]-oe[1]*y,W[j+9+8]=F[2]-oe[2]*y):M==B-1?(W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=W[ge+15],W[j+4]=W[ge+16],W[j+5]=W[ge+17],W[j+6]=F[0]+le[0]*y,W[j+7]=F[1]+le[1]*y,W[j+8]=F[2]+le[2]*y,W[j+9]=F[0],W[j+9+1]=F[1],W[j+9+2]=F[2],W[j+9+3]=W[ge+12],W[j+9+4]=W[ge+13],W[j+9+5]=W[ge+14],W[j+9+6]=F[0]+le[0]*y,W[j+9+7]=F[1]+le[1]*y,W[j+9+8]=F[2]+le[2]*y):(W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=W[ge],W[j+4]=W[ge+1],W[j+5]=W[ge+2],W[j+6]=W[pe+15],W[j+7]=W[pe+16],W[j+8]=W[pe+17],W[j+9]=F[0],W[j+9+1]=F[1],W[j+9+2]=F[2],W[j+9+3]=W[ge+3],W[j+9+4]=W[ge+4],W[j+9+5]=W[ge+5],W[j+9+6]=W[pe+12],W[j+9+7]=W[pe+13],W[j+9+8]=W[pe+14]),j+=18);else for(var ye=M!=B-1?M:M-1,Le=0;Le<$;Le++)d&&(P=X+ye,Z[V]=P,Z[V+1]=P,Z[V+2]=P,V+=3),he=W[ye*J+3],W[j]=F[0],W[j+1]=F[1],W[j+2]=F[2],W[j+3]=he,K[T]=0,K[T+1]=0,K[T+2]=0,K[T+3]=0,W[j+4]=F[0],W[j+5]=F[1],W[j+6]=F[2],W[j+7]=he,K[T+4]=D[Le][0]*y,K[T+5]=D[Le][1]*y,K[T+6]=R[Le]+0,K[T+7]=0,W[j+8]=F[0],W[j+9]=F[1],W[j+10]=F[2],W[j+11]=he,K[T+8]=D[Le+1][0]*y,K[T+9]=D[Le+1][1]*y,K[T+10]=R[Le+1]+0,K[T+11]=0,j+=12,T+=12}l&&(z=[F[0],F[1],F[2]+.1*U],ce[M]=z,fe[B-M-1]=z),M+1<B&&(F=ue[M+1])}X+=ue.length}H>0&&(Q[0]/=H,Q[1]/=H,Q[2]/=H),Q[0]+=Ie.groupOrigin[0],Q[1]+=Ie.groupOrigin[1],Q[2]+=Ie.groupOrigin[2];var Ae,me=u||c||h||v;if(o){var Ne={color:p,"z-index":a,center:Q,advancedHit:d,totalPoints:H,"hover-event":u,"click-event":c,"draw-event":f,"width-units":L,hitable:me,state:Ie.hitState,eventInfo:Ie.alwaysEventInfo||me||f?s:{},"enter-event":h,"leave-event":v,"zbuffer-offset":b,"line-width":2*y,lod:Ie.autoLod?null:Ie.tileLod};Ae=g?w?8:x?7:6:w?10:9,w&&null!=m&&(Ne.texture=[Ie.stylesheetBitmaps[m[0]],m[1],m[2]],Ne.background=N);var Ue=JSON.stringify({type:"T"+Ae,color:p,zIndex:a,zOffset:b,state:Ie.hitState}),we=K?[W,K]:[W];d&&we.push(Z),De(5,Ae,Ne,we,Ue)}if(l)for(M=0,B=ee.length;M<B;M++)Ye(ee[M].points,ee[M].points2,e,Q,r,t,n,a,s)}}}},Ye=function(e,r,t,n,a,s,i,o,l){var u=Fe(s,"line-label-type",t,a),c=Fe(s,"line-label-color",t,a),f=Fe(s,"line-label-color2",t,a),h=Fe(s,"line-label-outline",t,a),v=Fe(s,"line-label-source",t,a),d=Fe(s,"line-label-size",t,a),b=Fe(s,"line-label-spacing",t,a),g=(Fe(s,"line-label-line-height",t,a),Fe(s,"line-label-offset",t,a)),p=Fe(s,"dynamic-reduce",t,a),y=Fe(s,"line-label-no-overlap",t,a),L=Fe(s,"line-label-no-overlap-factor",t,a),A=Fe(s,"line-label-no-overlap-margin",t,a);if(!(Math.abs(d)<1e-4)){var m=ze(s,v,t,a,v);m=m?m.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var N=Fe(s,"line-label-font",t,a),U=Ge(N),w=Xe(N),x=Re(m,U);if("$name"==v&&!Te(m,U,x)){var S=ze(s,"$name:en",t,a,v);S=S?S.replace("\\r\\n","\\n").replace("\\r","\\n"):"";var M=Re(m,U);Te(S,U,M)&&(m=S,x=M)}if(m&&""!=m){var B,O,_,k,I,E=Fe(s,"hover-event",t,a),C=Fe(s,"click-event",t,a),F=Fe(s,"draw-event",t,a),z=Fe(s,"enter-event",t,a),P=Fe(s,"leave-event",t,a),j=Fe(s,"advanced-hit",t,a),T=Fe(s,"zbuffer-offset",t,a);Ie.useLineLabel2="flat"!=u,Ie.useLineLabel2?(B=12*m.length,k=new Float32Array(B),I=new Float32Array(B)):(B=Ve()*m.length*2,O=new Float32Array(B),_=new Float32Array(B));var V={},G=E||C||z||P,X=d;Ie.lineLabelPass=0,Ie.lineLabelPoints=[];var D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints;Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,Ie.useLineLabel2?0:D,null,x,I);var $=Ie.lineLabelPoints;if(!D){if(Ie.useLineLabel2)for(;;){d*=.5,Ie.lineLabelPass=0,Ie.lineLabelPoints=[];D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints;Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,Ie.useLineLabel2?0:D,null,x,I);$=Ie.lineLabelPoints;if(D||d<.05)break}if(!D)return}var q,Y,H,J=Fe(s,"visibility-rel",t,a)||Fe(s,"visibility-abs",t,a)||Fe(s,"visibility",t,a),W=Fe(s,"culling",t,a),Z=Fe(s,"hysteresis",t,a),K=Ie.bboxMin,Q=[],ee=0;if(Ie.useLineLabel2){for(Y=0,H=R.length;Y<H;Y++)(q=R[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2],(q=$[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2];for(Q.push([d,Ie.textVector,R,$]),Ie.lineLabelPass=1;d*=2,Ie.lineLabelPoints=[],D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints,D;){for(Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,Ie.useLineLabel2?0:D,null,x,I),$=Ie.lineLabelPoints,Y=0,H=R.length;Y<H;Y++)(q=R[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2],(q=$[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2];Q.push([d,Ie.textVector,R,$])}for(d=X;d*=.5,Ie.lineLabelPoints=[],D=je(e,m,d,b,U,g,O,_,0,V,x,k),R=Ie.lineLabelPoints,!(Ie.textLength<2);){for(Ie.lineLabelPoints=[],D=je(r,m,d,b,U,g,O,_,0,null,x,I),$=Ie.lineLabelPoints,Y=0,H=R.length;Y<H;Y++)(q=R[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2],(q=$[Y])[0]+=K[0],q[1]+=K[1],q[2]+=K[2];Q.unshift([d,Ie.textVector,R,$]),ee++}(n=Ie.textCenter)[0]+=K[0],n[1]+=K[1],n[2]+=K[2]}var re=new Array(U.length);for(Y=0,H=U.length;Y<H;Y++)re[Y]=[];for(var te in V){var ne=parseInt(te),ae=V[te],se=[];for(var ie in ae){var oe=parseInt(ie)-4e3*ne,le=Math.round((oe-oe%4)/4);-1==se.indexOf(le)&&se.push(le)}re[ne]=se}var ue=JSON.stringify({type:"line-label",color:c,color2:f,outline:h,fonts:N,zIndex:o,zOffset:T});if(y){var ce=null,fe=null;if(null!==L){switch(L[0]){case"direct":ce=0;break;case"div-by-dist":ce=1}fe=L[1]}var he=[A,ce,fe]}De(5,Ie.useLineLabel2?12:11,{color:c,color2:f,outline:h,textVector:Ie.textVector,labelPoints:Ie.useLineLabel2?Q:[],visibility:J,culling:W,hysteresis:Z,"z-index":o,center:n,"hover-event":E,"click-event":C,"draw-event":F,reduce:p,noOverlap:y?he:null,files:re,"enter-event":z,"leave-event":P,"zbuffer-offset":T,advancedHit:j,labelIndex:ee,labelSize:X,fonts:w,hitable:G,state:Ie.hitState,eventInfo:Ie.alwaysEventInfo||G||F?l:{},lod:Ie.autoLod?null:Ie.tileLod},Ie.useLineLabel2?[k,I]:[O,_],ue)}}},He=n,Je=s,We=q,Ze=ce,Ke=qe,Qe=Be,er=function(e,r,t,n,a,s,i,o){var l=e.borders||[];if(0!=l.length){for(var u,c,f=We(n,"polygon-extrude",e,t),h=function(e){var r={};for(var t in e)"surface"!=t&&"vertices"!=t&&"borders"!=t&&(r[t]=e[t]);return r}(e),v=l.length,d=[],b=[],g=[0,0,0],p=He.tileX,y=He.tileY,L=He.forceOrigin,A=He.forceScale,m=[1/A[0],1/A[1],1/A[2]],N=He.geocent,U=He.bboxMin,w=0;w<v;w++){var x,S=l[w],M=S.length,B=0;if(M>0){var O,_,k;for(o?(O=new Array(M+1),_=new Array(M+1)):(O=new Array(M),_=new Array(M)),k=0;k<M;k++)S[k]>=0?(x=3*S[k],B++):x=3*-S[k],f?(c=(u=[r[x],r[x+1],r[x+2]]).slice(),L&&(c=[c[0]-p,c[1]-y,c[2]]),null!=A&&(c=[c[0]*A[0],c[1]*A[1],c[2]*A[2]]),N?(Je([c[0]+U[0],c[1]+U[1],c[2]+U[2]],g),c=[u[0]+g[0]*f*m[0],u[1]+g[1]*f*m[1],u[2]+g[2]*f*m[2]]):c[2]+=f,O[k]=u,_[k]=c,S[k]>=0&&d.push([u,c])):O[k]=[r[x],r[x+1],r[x+2]],o&&0==k&&(O[M]=O[0],_[M]=_[0]);var I=new Array(B),E=new Array(B),C=0;for(k=0;k<M;k++)S[k]>=0&&(I[C]=O[k].slice(),f&&(E[C]=_[k].slice()),C++);d.push(O),b=b.concat(I),f&&(d.push(_),b=b.concat(E))}}o&&d.length>0?(h.lines=d,Ke(h,t,n,a,s,i)):b.length>0&&(h.points=b,Qe(h,t,n,a,s,i))}},rr=n,tr=function(e){var r=S.parse(e.data);N.fontsStorage[e.url]=r},nr=function(e,r){if(l&&!r)return l.decode(e);var t,n,a,s,i,o;for(t="",a=(e=new Uint8Array(e)).length,n=0;n<a;)switch((s=e[n++])>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCharCode(s);break;case 12:case 13:i=e[n++],t+=String.fromCharCode((31&s)<<6|63&i);break;case 14:i=e[n++],o=e[n++],t+=String.fromCharCode((15&s)<<12|(63&i)<<6|(63&o)<<0)}return t},ar=function(e){var r=e.map;for(var t in r)N.fonts[t]=N.fontsStorage[r[t]];N.fontsMap=r},sr=function e(r){if(!r||!Array.isArray(r))return r;var t,n,a=[r[0]];switch(r[0]){case"all":case"any":case"none":case"skip":for(t=1,n=r.length;t<n;t++)a[t]=e(r[t]);return a}switch(a[1]=r[1],a[2]=re(r[1]),r[0]){case"==":case"!=":case">=":case"<=":case">":case"<":a[3]=r[2],a[4]=re(r[2]);break;case"in":case"!in":for(t=2,n=r.length;t<n;t++)a[t+1]=r[t]}return a},ir=function(e,r,t){var n=j.stylesheetData.layers[e];return null==n?(W("wrong-Layer",e,null,null,t,r),{}):n},or=q,lr=function(e){var r;j.stylesheetBitmaps={},j.stylesheetFonts={},j.stylesheetConstants=e.constants||{},j.stylesheetVariables=e.variables||{},j.stylesheetLocals={};var t=e.bitmaps||{};for(r in t){var n=t[r];"string"==typeof n?n={url:n,hash:G(n)}:"object"==typeof n?null==n.url?(n.hash="null",W("wrong-bitmap",r)):n.hash=G(n.url):W("wrong-bitmap",r),j.stylesheetBitmaps[r]=n}for(r in postMessage({command:"loadBitmaps",bitmaps:j.stylesheetBitmaps}),t=j.stylesheetBitmaps)(n=t[r]).url=null;var a=e.fonts||{};for(r in a){var s=a[r];"string"==typeof s?s={url:s}:"object"==typeof s?null==s.url&&W("wrong-font",r):W("wrong-font",r),j.stylesheetFonts[r]=s}postMessage({command:"loadFonts",fonts:j.stylesheetFonts}),j.stylesheetData={layers:{}};var i=e.layers||{};for(r in j.stylesheetLayers=j.stylesheetData.layers,i)j.stylesheetData.layers[r]=te(r,i[r],e)},ur=ee,cr=qe,fr=Be,hr=function(e,r,t,n,a,s){var i,o,l=[];if(Me(e),(l=e.lines?e.lines:[e.points])&&0!=l.length){var u,c,f,h=be(t,"visibility-rel",e,r)||be(t,"visibility-abs",e,r)||be(t,"visibility",e,r),v=be(t,"culling",e,r),d=be(t,"hysteresis",e,r),b=0;for(c=0,f=l.length;c<f;c++)u=l[c],Array.isArray(u)&&u.length>0&&(b+=u.length);var g,p,y=[0,0,0],L=ve.forceOrigin,A=ve.bboxMin,m=ve.tileX,N=ve.tileY,U=ve.forceScale;for(c=0,f=l.length;c<f;c++)if(u=l[c],Array.isArray(u)&&u.length>0)for(i=0,o=u.length;i<o;i++)p=[(g=u[i])[0],g[1],g[2]],L&&(p=[p[0]-m,p[1]-N,p[2]]),null!=U&&(p=[p[0]*U[0],p[1]*U[1],p[2]*U[2]]),y[0]+=p[0],y[1]+=p[1],y[2]+=p[2];b>0&&(y[0]/=b,y[1]/=b,y[2]/=b),y[0]+=A[0],y[1]+=A[1],y[2]+=A[2],ve.signatureCounter++;var w=""+ve.signatureCounter;Se(5,20,{"z-index":a,hysteresis:d,visibility:h,culling:v,center:y,eventInfo:{},index:n,lod:ve.autoLod?null:ve.tileLod},[],w)}},vr=function(e,r,t,n,a,s){var i=e.vertices||[];if(0!=i.length&&((We(t,"point",e,r)||We(t,"label",e,r))&&er(e,i,r,t,n,a,s,!1),(We(t,"line",e,r)||We(t,"line-label",e,r))&&er(e,i,r,t,n,a,s,!0),We(t,"polygon",e,r))){var o=e.surface||[];if(0!=o.length){var l=We(t,"hover-event",e,r),u=We(t,"click-event",e,r),c=We(t,"draw-event",e,r),f=We(t,"enter-event",e,r),h=We(t,"leave-event",e,r),v=We(t,"advanced-hit",e,r),d=We(t,"zbuffer-offset",e,r),b=We(t,"polygon-color",e,r),g=We(t,"polygon-style",e,r),p=We(t,"polygon-use-stencil",e,r),y=We(t,"polygon-culling",e,r),L=We(t,"polygon-extrude",e,r);g="flatshade"==g?1:0,y="back"==y?1:0;for(var A,m,N,U,w=He.geocent,x=[0,0,0],S=[0,0,0],M=He.bboxMin,B=3*(o.length/3),O=new Float32Array(3*B),_=0,k=0,I=[0,0,0],E=[0,0,0],C=[0,0,0],F=[0,0,0],z=He.tileX,P=He.tileY,j=He.forceOrigin,T=He.forceScale,V=0;V<B;V++)I=[i[A=3*o[_++]],i[A+1],i[A+2]],j&&(I=[I[0]-z,I[1]-P,I[2]]),null!=T&&(I=[I[0]*T[0],I[1]*T[1],I[2]*T[2]]),L&&(w?(Je([I[0]+M[0],I[1]+M[1],I[2]+M[2]],S),I[0]+=S[0]*L,I[1]+=S[1]*L,I[2]+=S[2]*L):I[2]+=L),x[0]+=I[0],x[1]+=I[1],x[2]+=I[2],O[k++]=I[0],O[k++]=I[1],O[k++]=I[2];if(B>0){var G=1/B;x[0]*=G,x[1]*=G,x[2]*=G}x[0]+=He.groupOrigin[0],x[1]+=He.groupOrigin[1],x[2]+=He.groupOrigin[2];var X=e.borders||[];if(X.length>0){var D=0;for(V=0,m=X.length;V<m;V++){D+=2*(($=X[V]).length+1)}var R=O;for((O=new Float32Array(O.length+3*D*3)).set(R),V=0,m=X.length;V<m;V++){var $,q;for(N=0,U=($=X[V]).length;N<U;N++)q=$[N]>=0?3*$[N]:3*-$[N],I[0]=i[q],I[1]=i[q+1],I[2]=i[q+2],C[0]=i[q],C[1]=i[q+1],C[2]=i[q+2],q=N<U-1?$[N+1]>=0?3*$[N+1]:3*-$[N+1]:$[0]>=0?3*$[0]:3*-$[0],E[0]=i[q],E[1]=i[q+1],E[2]=i[q+2],F[0]=i[q],F[1]=i[q+1],F[2]=i[q+2],j&&(I=[I[0]-z,I[1]-P,I[2]],E=[E[0]-z,E[1]-P,E[2]],C=[C[0]-z,C[1]-P,C[2]],F=[F[0]-z,F[1]-P,F[2]]),null!=T&&(I=[I[0]*T[0],I[1]*T[1],I[2]*T[2]],E=[E[0]*T[0],E[1]*T[1],E[2]*T[2]],C=[C[0]*T[0],C[1]*T[1],C[2]*T[2]],F=[F[0]*T[0],F[1]*T[1],F[2]*T[2]]),L&&(w?(Je([I[0]+M[0],I[1]+M[1],I[2]+M[2]],S),I=[I[0]+S[0]*L,I[1]+S[1]*L,I[2]+S[2]*L],Je([E[0]+M[0],E[1]+M[1],E[2]+M[2]],S),E=[E[0]+S[0]*L,E[1]+S[1]*L,E[2]+S[2]*L]):(I[2]+=L,E[2]+=L)),O[k]=F[0],O[k+1]=F[1],O[k+2]=F[2],O[k+3]=E[0],O[k+4]=E[1],O[k+5]=E[2],O[k+6]=I[0],O[k+7]=I[1],O[k+8]=I[2],O[k+9]=I[0],O[k+10]=I[1],O[k+11]=I[2],O[k+12]=C[0],O[k+13]=C[1],O[k+14]=C[2],O[k+15]=F[0],O[k+16]=F[1],O[k+17]=F[2],k+=18}}var Y=l||u||f||h,H=JSON.stringify({style:g,culling:y,stencil:p,color:b,zIndex:a,zOffset:d,state:He.hitState});Ze(5,13,{color:b,"z-index":a,center:x,advancedHit:v,culling:y,"hover-event":l,"click-event":u,"draw-event":c,style:g,stencil:p,hitable:Y,state:He.hitState,eventInfo:He.alwaysEventInfo||Y||c?s:{},"enter-event":f,"leave-event":h,"zbuffer-offset":d,lod:He.autoLod?null:He.tileLod},[O],H)}}},dr=function(e){$e(e);var r=e.lines;if(!r&&0!=r.length){var t=0,n=new Uint32Array(r.length);for(c=0;c<r.length;c++)n[c]=t,Array.isArray(r[c])&&(t+=r[c].length);for(var a,s,i,o=new Float64Array(3*t),l=Ie.forceScale,u=0,c=0;c<r.length;c++)if(Array.isArray(r[c])&&r[c].length){var f=r[c];a=[(i=f[0])[0],i[1],i[2]];for(var h=0,v=f.length;h<v&&(null!=l&&(s=[a[0]*l[0],a[1]*l[1],a[2]*l[2]]),o[u]=s[0],o[u+1]=s[1],o[u+2]=s[2],u+=3,h!=v-1);h++)a=f[h+1]}Ie.signatureCounter++,De(5,14,{id:e.id},[o,n],""+Ie.signatureCounter)}},br=function(e){if(Me(e),e.lines?pointsGroups=e.lines:pointsGroups=[e.points],pointsGroups&&0!=pointsGroups.length){var r=0,t=new Uint32Array(pointsGroups.length);for(u=0;u<pointsGroups.length;u++)t[u]=r,Array.isArray(pointsGroups[u])&&(r+=pointsGroups[u].length);for(var n,a,s,i=new Float64Array(3*r),o=ve.forceScale,l=0,u=0;u<pointsGroups.length;u++)if(Array.isArray(pointsGroups[u])&&pointsGroups[u].length){var c=pointsGroups[u];n=[(s=c[0])[0],s[1],s[2]];for(var f=0,h=c.length;f<h&&(null!=o&&(a=[n[0]*o[0],n[1]*o[1],n[2]*o[2]]),i[l]=a[0],i[l+1]=a[1],i[l+2]=a[2],l+=3,f!=h-1);f++)n=c[f+1]}ve.signatureCounter++,Se(5,5,{id:e.id},[i,t],""+ve.signatureCounter)}},gr=function(e,r,t){var n=0,a=new ArrayBuffer(6),s=new DataView(a);n=0,s.setUint8(n,e),n+=1,s.setUint8(n,r),n+=1,s.setUint32(n,t||0),fe(e,r,a,n+=4,"")},pr=function(){for(var e,r,t,n,a,s,i,o,l=ne.messageBuffer,u=0,c=ne.messageBufferIndex;u<c;u++){(A=l[u]).job;var f=A.type,h=A.signature;if(!A.hitable&&!A.reduced&&f>=6&&f<=13)switch(f){case 13:case 6:for(o=0,i=4*new DataView(A.job).getUint32(A.buffersIndex),he(0,new Uint8Array(A.job,A.buffersIndex+4,i),0),a=i,e=u+1;e<c;e++)(n=l[e]).signature==h&&(n.reduced=!0,o++,i=4*new DataView(n.job).getUint32(n.buffersIndex),he(0,new Uint8Array(n.job,n.buffersIndex+4,i),a),a+=i);o>0&&(y=new Uint8Array(A.buffersIndex+2*(4+a)),s=new DataView(y.buffer),y.set(new Uint8Array(A.job,0,A.buffersIndex),0),s.setUint32(A.buffersIndex,a/4),y.set(new Uint8Array(se.buffer,0,a),A.buffersIndex+4),ne.messagePackSize-=A.job.byteLength,ne.messagePackSize+=y.byteLength,A.job=y.buffer);break;case 9:case 11:case 7:for(o=0,0,i=new DataView(A.job).getUint32(A.buffersIndex),i*=4,he(0,new Uint8Array(A.job,A.buffersIndex+4,i),0),he(1,new Uint8Array(A.job,A.buffersIndex+4+i+4,i),0),a=i,e=u+1;e<c;e++)if((n=l[e]).signature==h&&(n.reduced=!0,ne.messagePackSize-=n.job.byteLength,o++,i=new DataView(n.job).getUint32(n.buffersIndex),i*=4,he(0,new Uint8Array(n.job,n.buffersIndex+4,i),a),he(1,new Uint8Array(n.job,n.buffersIndex+4+i+4,i),a),a+=i,11==f)){var v=A.job2.files,d=n.job2.files;for(t=0,r=d.length;t<r;t++){v[t]||(v[t]=[]);for(var b=0,g=d[t].length;b<g;b++)-1==v[t].indexOf(d[t][b])&&v[t].push(d[t][b])}}if(o>0){if(11==f){var p=ae(JSON.stringify(A.job2));y=new Uint8Array(6+p.byteLength+2*(4+a)),L=0,(s=new DataView(y.buffer)).setUint8(L,A.command),L+=1,s.setUint8(L,f),L+=1,s.setUint32(L,p.byteLength),L+=4,y.set(p,L),L+=p.byteLength,A.buffersIndex=L}else y=new Uint8Array(A.buffersIndex+2*(4+a)),s=new DataView(y.buffer),y.set(new Uint8Array(A.job,0,A.buffersIndex),0);s.setUint32(A.buffersIndex,a/4),y.set(new Uint8Array(se.buffer,0,a),A.buffersIndex+4),s.setUint32(A.buffersIndex+4+a,a/4),y.set(new Uint8Array(ie.buffer,0,a),A.buffersIndex+4+a+4),ne.messagePackSize-=A.job.byteLength,ne.messagePackSize+=y.byteLength,A.job=y.buffer}}}var y=new Uint8Array(ne.messagePackSize),L=0;for(u=0,c=ne.messageBufferIndex;u<c;u++){var A;(A=ne.messageBuffer[u]).reduced||(y.set(new Uint8Array(A.job),L),L+=ne.messageBuffer[u].job.byteLength)}ue({command:"addPackedCommands",buffer:y},[y.buffer]),ne.messageBufferIndex=0,ne.messagePackSize=0},yr=ce,Lr=ue,Ar=function(){oe.length>0&&(le.length>0?postMessage({command:"packed-events",messages:oe},le):postMessage({command:"packed-events",messages:oe}),oe=[],le=[])},mr=H,Nr=[],Ur=new Array(1024),wr=0,xr=new Array(1024),Sr=0,Mr=0;function Br(e,r,t,n,a,s,i){switch(rr.stylesheetLocals={},e){case"line-string":(or(n,"point",r,t)||or(n,"label",r,t))&&fr(r,t,n,a,s,i),cr(r,t,n,a,s,i);break;case"point-array":fr(r,t,n,a,s,i);break;case"polygon":vr(r,t,n,a,s,i)}}function Or(e,r,t,n,a){var s=rr.reduceParams;for(var i in rr.stylesheetLayers){var o=rr.stylesheetLayers[i];if("point-array"==e){var l=o["importance-source"];if(null==l&&r[0]&&r[0].importance&&(l="$importance"),null!=l)switch(rr.reduceMode){case"scr-count1":case"scr-count2":o.reduce=["top",100,l],o["dynamic-reduce"]=["scr-count2",s[0],s[1]];break;case"scr-count4":o["dynamic-reduce"]=["scr-count4",l];break;case"scr-count5":o["dynamic-reduce"]=["scr-count5",l];break;case"scr-count6":case"scr-count7":case"scr-count8":var u="scr-count8"==rr.reduceMode?s[6]:s[5];o["dynamic-reduce"]=[rr.reduceMode,l,void 0!==o["importance-weight"]?o["importance-weight"]:1],o["label-no-overlap-margin"]=[s[0]*u,s[0]*u],o["icon-no-overlap-margin"]=[s[0]*u,s[0]*u],o["label-no-overlap-factor"]=["div-by-dist",l]}}var c,f,h=o.filter,v=o.reduce;for(h&&((h=o["#filter"])||(o["#filter"]=sr(o.filter),h=o["#filter"])),wr=0,Sr=0,Mr=0,c=0,f=r.length;c<f;c++){var d=r[c];d.properties=d.properties||{},d.id&&(d.properties["#id"]=d.id),h&&!ur(h,d,n,a,o,"filter",t,0,!0)||(v?(Ur[wr]=d,wr++):kr(e,d,t,o,c))}if(v){var b=v[1],g=v[2];switch(v[0]){case"top":case"bottom":if("string"==typeof g&&"@"==g.charAt(0)&&void 0===(g=rr.stylesheetConstants[g]))break;if("string"==typeof g&&"$"==g.charAt(0)||"object"==typeof g){var p="object"==typeof g;p||(g=g.substr(1)),b>wr&&(b=wr);var y,L="top"==v[0],A=0,m=L?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;do{var N=L?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;for(Mr=Sr,c=0,f=wr;c<f;c++)d=Ur[c],A?y=d.tmp:(y=p?mr(o,null,d,t,g,0):parseFloat(d.properties[g]),d.tmp=y),!isNaN(y)&&(L&&y>=N&&y<m||y<=N&&y>m)&&(N!=y&&(Sr=Mr),xr[Sr]=d,Sr++,N=y);m=N,A++}while(A<b)}break;case"odd":case"even":for(c="odd"==v[0]?1:0,f=wr;c<f;c+=2)d=Ur[c],xr[Sr]=d,Sr++;case"every":for(b>wr&&(b=wr),c=0,f=wr;c<f;c+=b)d=Ur[c],xr[Sr]=d,Sr++}for(c=0,f=Sr;c<f;c++)d=xr[c],kr(e,xr[c],t,o,c)}}}function _r(e,r,t,n,a,s){var i,o=or(n,"next-pass",r,t);if(null!=o)for(var l=0,u=o.length;l<u;l++){var c=o[l][0];if(i=ir(o[l][1],e,a),or(i,"visible",r,t)){var f=or(i,"selected-layer",r,t),h=""!=f?ir(f,e,a):null,v=or(i,"selected-hover-layer",r,t),d=""!=v?ir(v,e,a):null,b=or(i,"hover-layer",r,t),g=""!=b?ir(b,e,a):null,p=(null!=g?256:0)|(null!=h?512:0)|(null!=d?1024:0),y=rr.hitState;null!=h&&(rr.hitState=2|p,Br(e,r,t,h,a,c,s)),null!=d&&(rr.hitState=3|p,Br(e,r,t,d,a,c,s)),null!=g&&(rr.hitState=1|p,Br(e,r,t,g,a,c,s)),Br(e,r,t,i,a,c,s),rr.hitState=y}}}function kr(e,r,t,n,a,s){if(or(n,"visible",r,t))if("point-array"==e&&n["visibility-switch"]){gr(5,17);var i=or(n,"z-index",r,t),o=r.properties;hr(r,t,n,a,i,o);for(var l=n["visibility-switch"],u=0,c=l.length;u<c;u++){if(l[u][1])kr(e,r,t,ir(l[u][1],e,a),a);gr(5,18,l[u][0])}gr(5,19)}else if(s||1!=n.pack||(rr.directPoints=[],gr(5,15),kr(e,r,t,n,a,!0),gr(5,16),!rr.directPoints)){i=or(n,"z-index",r,t);if(or(n,"export-geometry",r,t)&&void 0!==r.id&&!Nr[r]){switch(e){case"line-string":dr(r);break;case"point-array":br(r)}Nr[r]=!0}o=r.properties;var f=or(n,"selected-layer",r,t),h=""!=f?ir(f,e,a):null,v=or(n,"selected-hover-layer",r,t),d=""!=v?ir(v,e,a):null,b=or(n,"hover-layer",r,t),g=""!=b?ir(b,e,a):null,p=(null!=g?256:0)|(null!=h?512:0)|(null!=d?1024:0);null!=h&&(rr.hitState=2|p,Br(e,r,t,h,a,i,o),_r(e,r,t,h,a,o)),null!=d&&(rr.hitState=3|p,Br(e,r,t,d,a,i,o),_r(e,r,t,d,a,o)),null!=g&&(rr.hitState=1|p,Br(e,r,t,g,a,i,o),_r(e,r,t,g,a,o)),rr.hitState=0|p,Br(e,r,t,n,a,i,o),_r(e,r,t,n,a,o)}}function Ir(e,r){var t=e.id||"";rr.groupId=t;var n=e.bbox;if(n){var a=n[0],s=n[1];rr.bboxMin=a,rr.bboxMax=s;var i=[n[1][0]-n[0][0],n[1][1]-n[0][1],n[1][2]-n[0][2]],o=e.resolution||4096;rr.groupOrigin=[0,0,0],rr.forceScale=[i[0]/o,i[1]/o,i[2]/o],yr(9,0,{id:e.id,bbox:[a,s],origin:a},[],"");var l=e.points||[];rr.featureType="point",Or("point-array",l,r,"point",t);var u=e.lines||[];rr.featureType="line",Or("line-string",u,r,"line",t);var c=e.polygons||[];rr.featureType="polygon",Or("polygon",c,r,"polygon",t),gr(10,0),rr.groupOptimize&&pr()}}function Er(e,r){var t,n;yr(5,21,{volume:e.volume,precision:e.precision,tileset:e.tileset},[],"");var a=e.meshes||[];for(t=0,n=a.length;t<n;t++){var s=a[t];yr(5,23,{path:a[t]},[],s)}var i=e.nodes||[];for(t=0,n=i.length;t<n;t++)Er(i[t],r);yr(5,22,{},[],"")}self.onmessage=function(e){var r=e.data,t=r.command,n=r.data,a=null,s=!1;switch(t){case"config":rr.config=n;break;case"setStylesheet":n&&(rr.geocent=n.geocent,rr.metricUnits=n.metric,rr.reduceMode=n.reduceMode,rr.reduceParams=n.reduceParams,rr.log=n.log,rr.language=n.language,lr(n.data));break;case"setFont":tr(n);break;case"setFontMap":ar(n),postMessage({command:"styleDone"}),postMessage({command:"ready"});break;case"processGeodataRaw":if(a=n,n.length>2){var i=new DataView(n),o="";o+=String.fromCharCode(i.getUint8(0,!0)),"GE"!=(o+=String.fromCharCode(i.getUint8(1,!0)))&&(s=!0)}n=nr(n);case"processGeodata":rr.tileLod=r.lod||0,rr.tileIX=r.ix||0,rr.tileIY=r.iy||0,rr.tileSize=r.tileSize||1,rr.pixelSize=r.pixelSize||1,rr.pixelFactor=r.dpr||1,rr.invPixelFactor=1/rr.pixelFactor,rr.pixelsPerMM=rr.pixelFactor/96/2.54,rr.invPixelsPerMM=1/rr.pixelsPerMM,Nr=[],s?processGeodata2(i,rr.tileLod):function(e,r){if("string"==typeof e)try{var t=JSON.parse(e)}catch(e){t=null}else t=e;if(t){for(var n=t.groups||[],a=0,s=n.length;a<s;a++)Ir(n[a],r);var i=t.nodes||[];for(a=0,s=i.length;a<s;a++)yr(9,0,{},[],""),Er(i[a],r),gr(10,0)}}(n=JSON.parse(n),rr.tileLod),gr(7,0),rr.groupOptimize&&pr(),a?Lr({command:"ready",geodata:a},[a]):Lr({command:"ready"}),rr.config.mapPackLoaderEvents&&Ar()}}}]);\n//# sourceMappingURL=613b72349d2ca54e7f86.worker.js.map',null)}},function(e,t,i){e.exports=function(){return i(10)('/*!\n * Copyright (c) 2020 Melown Technologies SE\n *  *  For terms of use, see accompanying main file.\n *  *  For 3rd party libraries licenses, see 3rdpartylicenses.txt.\n * \n */!function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);var r={},a=r;function i(e,t){var n={valid:!0};return function(e,t,n){var r=n.data;t.flags=r.getUint8(n.index,!0),n.index+=1,e.version>1?(t.surfaceReference=r.getUint8(n.index,!0),n.index+=1):t.surfaceReference=0;t.textureLayer=r.getUint16(n.index,!0),n.index+=2,t.textureLayer2=t.textureLayer;var a=[],i=[];a[0]=r.getFloat64(n.index,!0),n.index+=8,a[1]=r.getFloat64(n.index,!0),n.index+=8,a[2]=r.getFloat64(n.index,!0),n.index+=8,i[0]=r.getFloat64(n.index,!0),n.index+=8,i[1]=r.getFloat64(n.index,!0),n.index+=8,i[2]=r.getFloat64(n.index,!0),n.index+=8,t.bboxMin=a,t.bboxMax=i}(e,n,t),e.version>=3?function(e,t,n){var r,i,u,c=n.data,f=n.index,l=n.uint8Data,h=a.config.map16bitMeshes,d=a.config.mapOnlyOneUVs&&1&t.flags,p=c.getUint16(f,!0);f+=2;var g=c.getUint16(f,!0);f+=2,p||(t.valid=!1);var v,m,b,y,x=t.bboxMin,M=t.bboxMax,w=[.5*(x[0]+M[0]),.5*(x[1]+M[1]),.5*(x[2]+M[2])],U=Math.abs(Math.max(M[0]-x[0],M[1]-x[1],M[2]-x[2])),S=1/g,A=null,z=h?new Uint16Array(3*p):new Float32Array(3*p),O=0,T=0,k=0,N=w[0],C=w[1],V=w[2],F=x[0],L=x[1],R=x[2],P=1/(M[0]-x[0]),q=1/(M[1]-x[1]),H=1/(M[2]-x[2]),j=[0,f];if(h)for(m=0;m<p;m++)s(l,j),O+=j[0],s(l,j),T+=j[0],s(l,j),k+=j[0],(y=(O*S*U+N-F)*P)<0&&(y=0),y>1&&(y=1),z[v=3*m]=65535*y,(y=(T*S*U+C-L)*q)<0&&(y=0),y>1&&(y=1),z[v+1]=65535*y,(y=(k*S*U+V-R)*H)<0&&(y=0),y>1&&(y=1),z[v+2]=65535*y;else for(m=0;m<p;m++)s(l,j),O+=j[0],s(l,j),T+=j[0],s(l,j),k+=j[0],z[v=3*m]=(O*S*U+N-F)*P,z[v+1]=(T*S*U+C-L)*q,z[v+2]=(k*S*U+V-R)*H;if(f=j[1],2&t.flags)if(g=c.getUint16(f,!0),f+=2,j[1]=f,d)for(m=0;m<p;m++)s(l,j),s(l,j);else if(S=h?65535/g:1/g,A=h?new Uint16Array(2*p):new Float32Array(2*p),O=0,T=0,h)for(m=0;m<p;m++){s(l,j),O+=j[0],s(l,j),T+=j[0],(y=O*S)<0&&(y=0),y>65535&&(y=65535),A[I=2*m]=y,(y=T*S)<0&&(y=0),y>65535&&(y=65535),A[I+1]=65535-y}else for(m=0;m<p;m++){var I;s(l,j),O+=j[0],s(l,j),T+=j[0],A[I=2*m]=O*S,A[I+1]=1-T*S}if(f=j[1],r=z,i=A,1&t.flags){var B=c.getUint16(f,!0);f+=2;var E=c.getUint16(f,!0);f+=2;var J=c.getUint16(f,!0);f+=2;var D=h?65536/E:1/E,G=h?65536/J:1/J;O=0,T=0;var Y=h?new Uint16Array(2*B):new Float32Array(2*B);if(j[1]=f,h)for(m=0,b=2*B;m<b;m+=2)s(l,j),O+=j[0],s(l,j),T+=j[0],(y=O*D)<0&&(y=0),y>65535&&(y=65535),Y[m]=y,(y=T*G)<0&&(y=0),y>65535&&(y=65535),Y[m+1]=65535-y;else for(m=0,b=2*B;m<b;m+=2)s(l,j),O+=j[0],s(l,j),T+=j[0],Y[m]=O*D,Y[m+1]=1-T*G;f=j[1],u=Y}var X=c.getUint16(f,!0);f+=2;var _=null;Y=null,A=null;var Z=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&!(1&t.flags),$=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&1&t.flags,W=Z||$;W?_=new Uint16Array(3*X):(z=h?new Uint16Array(3*X*3):new Float32Array(3*X*3),1&t.flags&&(Y=h?new Uint16Array(3*X*2):new Float32Array(3*X*2)),!d&&2&t.flags&&(A=h?new Uint16Array(3*X*2):new Float32Array(3*X*2)));var K,Q,ee,te,ne,re,ae=r,ie=i,oe=u,se=0;for(j[1]=f,m=0;m<X;m++)if(o(l,j),K=se-j[0],j[0]||se++,o(l,j),Q=se-j[0],j[0]||se++,o(l,j),ee=se-j[0],j[0]||se++,W)_[v=3*m]=K,_[v+1]=Q,_[v+2]=ee;else{var ue=3*K;z[v=9*m]=ae[ue],z[v+1]=ae[ue+1],z[v+2]=ae[ue+2],ue=3*Q,z[v+3]=ae[ue],z[v+4]=ae[ue+1],z[v+5]=ae[ue+2],ue=3*ee,z[v+6]=ae[ue],z[v+7]=ae[ue+1],z[v+8]=ae[ue+2],null!=A&&(A[v=6*m]=ie[2*K],A[v+1]=ie[2*K+1],A[v+2]=ie[2*Q],A[v+3]=ie[2*Q+1],A[v+4]=ie[2*ee],A[v+5]=ie[2*ee+1])}Z&&(z=r,A=i);$&&(z=h?new Uint16Array(oe.length/2*3):new Float32Array(oe.length/2*3),Y=u);if(se=0,null!=Y)for(m=0;m<X;m++)o(l,j),K=se-j[0],j[0]||se++,o(l,j),Q=se-j[0],j[0]||se++,o(l,j),ee=se-j[0],j[0]||se++,$?(te=3*_[v=3*m],ne=3*_[v+1],re=3*_[v+2],z[3*K]=ae[te],z[3*K+1]=ae[te+1],z[3*K+2]=ae[te+2],z[3*Q]=ae[ne],z[3*Q+1]=ae[ne+1],z[3*Q+2]=ae[ne+2],z[3*ee]=ae[re],z[3*ee+1]=ae[re+1],z[3*ee+2]=ae[re+2],_[v]=K,_[v+1]=Q,_[v+2]=ee):(Y[v=6*m]=oe[2*K],Y[v+1]=oe[2*K+1],Y[v+2]=oe[2*Q],Y[v+3]=oe[2*Q+1],Y[v+4]=oe[2*ee],Y[v+5]=oe[2*ee+1]);f=j[1],t.vertices=z,t.internalUVs=Y,t.externalUVs=A,t.indices=_,n.index=f,t.size=t.vertices.byteLength,t.internalUVs&&(t.size+=t.internalUVs.byteLength);t.externalUVs&&(t.size+=t.externalUVs.byteLength);t.indices&&(t.size+=t.indices.byteLength);t.faces=X}(0,n,t):function(e,t,n){var r=n.data,i=n.index,o=n.uint8Data,s=a.config.map16bitMeshes,u=r.getUint16(i,!0);i+=2,u||(t.valid=!1);var c,f,l,h=null,d=null,p=a.config.mapOnlyOneUVs&&1&t.flags,g=s?new Uint16Array(3*u):new Float32Array(3*u);2&t.flags&&(d=!!p||(s?new Uint16Array(2*u):new Float32Array(2*u)));var v,m,b=s?1:1/65535,y=0,x=0;for(v=0;v<u;v++)g[y]=(o[i]+(o[i+1]<<8))*b,g[y+1]=(o[i+2]+(o[i+3]<<8))*b,g[y+2]=(o[i+4]+(o[i+5]<<8))*b,y+=3,d?(p||(d[x]=(o[i+6]+(o[i+7]<<8))*b,d[x+1]=(65535-(o[i+8]+(o[i+9]<<8)))*b,x+=2),i+=10):i+=6;if(c=g,f=d,1&t.flags){var M=r.getUint16(i,!0);for(i+=2,h=s?new Uint16Array(2*M):new Float32Array(2*M),v=0,m=2*M;v<m;v+=2)h[v]=(o[i]+(o[i+1]<<8))*b,h[v+1]=(65535-(o[i+2]+(o[i+3]<<8)))*b,i+=4;l=h}var w=r.getUint16(i,!0);i+=2;var U=null;h=null,d=null;var S=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&!(1&t.flags),A=a.config.mapIndexBuffers&&a.config.mapOnlyOneUVs&&1&t.flags,z=S||A;z?U=new Uint16Array(3*w):(g=s?new Uint16Array(3*w*3):new Float32Array(3*w*3),1&t.flags&&(h=s?new Uint16Array(3*w*2):new Float32Array(3*w*2)),!p&&2&t.flags&&(d=s?new Uint16Array(3*w*2):new Float32Array(3*w*2)));var O,T,k,N,C,V,F,L=c,R=f,P=l;S&&(g=c,d=f);A&&(g=s?new Uint16Array(P.length/2*3):new Float32Array(P.length/2*3),h=l);for(v=0;v<w;v++)O=o[i]+(o[i+1]<<8),T=o[i+2]+(o[i+3]<<8),k=o[i+4]+(o[i+5]<<8),z?(y=3*v,null!=h?(N=o[i+6]+(o[i+7]<<8),C=o[i+8]+(o[i+9]<<8),V=o[i+10]+(o[i+11]<<8),g[3*N]=L[3*O],g[3*N+1]=L[3*O+1],g[3*N+2]=L[3*O+2],g[3*C]=L[3*T],g[3*C+1]=L[3*T+1],g[3*C+2]=L[3*T+2],g[3*V]=L[3*k],g[3*V+1]=L[3*k+1],g[3*V+2]=L[3*k+2],U[y]=N,U[y+1]=C,U[y+2]=V,i+=12):(U[y]=O,U[y+1]=T,U[y+2]=k,i+=6)):(F=3*O,g[y=9*v]=L[F],g[y+1]=L[F+1],g[y+2]=L[F+2],F=3*T,g[y+3]=L[F],g[y+4]=L[F+1],g[y+5]=L[F+2],F=3*k,g[y+6]=L[F],g[y+7]=L[F+1],g[y+8]=L[F+2],null!=d&&(d[y=6*v]=R[2*O],d[y+1]=R[2*O+1],d[y+2]=R[2*T],d[y+3]=R[2*T+1],d[y+4]=R[2*k],d[y+5]=R[2*k+1]),null!=h?(O=o[i+6]+(o[i+7]<<8),T=o[i+8]+(o[i+9]<<8),k=o[i+10]+(o[i+11]<<8),i+=12,h[y=6*v]=P[2*O],h[y+1]=P[2*O+1],h[y+2]=P[2*T],h[y+3]=P[2*T+1],h[y+4]=P[2*k],h[y+5]=P[2*k+1]):i+=6);t.vertices=g,t.internalUVs=h,t.externalUVs=d,t.indices=U,c=null,l=null,f=null,n.index=i,t.size=t.vertices.byteLength,t.internalUVs&&(t.size+=t.internalUVs.byteLength);t.externalUVs&&(t.size+=t.externalUVs.byteLength);t.indices&&(t.size+=t.indices.byteLength);t.faces=w}(0,n,t),n}function o(e,t){var n=e[t[1]];128&n?(t[0]=127&n|e[t[1]+1]<<7,t[1]+=2):(t[0]=n,t[1]++)}function s(e,t){var n=e[t[1]];128&n?1&(n=127&n|e[t[1]+1]<<7)?(t[0]=-(1+(n>>1)),t[1]+=2):(t[0]=n>>1,t[1]+=2):1&n?(t[0]=-(1+(n>>1)),t[1]++):(t[0]=n>>1,t[1]++)}var u={create:function(e){var t=new Array(3);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},add:function(e,t,n){return n&&e!=n?(n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n):(e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e)},subtract:function(e,t,n){return n&&e!=n?(n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n):(e[0]-=t[0],e[1]-=t[1],e[2]-=t[2],e)},negate:function(e,t){return t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},scale:function(e,t,n){return n&&e!=n?(n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n):(e[0]*=t,e[1]*=t,e[2]*=t,e)},normalize:function(e,t){t||(t=e);var n=e[0],r=e[1],a=e[2],i=Math.sqrt(n*n+r*r+a*a);return i?1==i?(t[0]=n,t[1]=r,t[2]=a,t):(i=1/i,t[0]=n*i,t[1]=r*i,t[2]=a*i,t):(t[0]=0,t[1]=0,t[2]=0,t)},normalize2:function(e,t,n){var r=e[t],a=e[t+1],i=e[t+2],o=Math.sqrt(r*r+a*a+i*i);return o?1==o?(n[0]=r,n[1]=a,n[2]=i,n):(o=1/o,n[0]=r*o,n[1]=a*o,void(n[2]=i*o)):(n[0]=0,n[1]=0,n[2]=0,n)},normalize3:function(e,t,n,r){var a=e[t],i=e[t+1],o=e[t+2],s=Math.sqrt(a*a+i*i+o*o);return s?1==s?(n[r]=a,n[r+1]=i,n[r+2]=o,n):(s=1/s,n[r]=a*s,n[r+1]=i*s,void(n[r+2]=o*s)):(n[r]=0,n[r+1]=0,n[r+2]=0,n)},normalize4:function(e,t){t||(t=e);var n=e[0],r=e[1],a=e[2],i=Math.sqrt(n*n+r*r+a*a);if(!i)return t[0]=0,t[1]=0,t[2]=0,t;if(1==i)return t[0]=n,t[1]=r,t[2]=a,t;var o=i;return i=1/i,t[0]=n*i,t[1]=r*i,t[2]=a*i,o},cross:function(e,t,n){n||(n=e);var r=e[0],a=e[1];e=e[2];var i=t[0],o=t[1];return t=t[2],n[0]=a*t-e*o,n[1]=e*i-r*t,n[2]=r*o-a*i,n},length:function(e){var t=e[0],n=e[1];return e=e[2],Math.sqrt(t*t+n*n+e*e)},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},dot2:function(e,t,n){return e[0]*t[n]+e[1]*t[n+1]+e[2]*t[n+2]},dot3:function(e,t,n,r){return e[t]*n[r]+e[t+1]*n[r+1]+e[t+2]*n[r+2]},distance:function(e,t){var n=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return Math.sqrt(n*n+r*r+a*a)},distance2:function(e,t,n,r){var a=n[r]-e[t],i=n[r+1]-e[t+1],o=n[r+2]-e[t+2];return Math.sqrt(a*a+i*i+o*o)},squareDistance:function(e,t){var n=t[0]-e[0],r=t[1]-e[1],a=t[2]-e[2];return n*n+r*r+a*a},direction:function(e,t,n){n||(n=e);var r=e[0]-t[0],a=e[1]-t[1];return e=e[2]-t[2],(t=Math.sqrt(r*r+a*a+e*e))?(t=1/t,n[0]=r*t,n[1]=a*t,n[2]=e*t,n):(n[0]=0,n[1]=0,n[2]=0,n)},lerp:function(e,t,n,r){return r||(r=e),r[0]=e[0]+n*(t[0]-e[0]),r[1]=e[1]+n*(t[1]-e[1]),r[2]=e[2]+n*(t[2]-e[2]),r},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+"]"}},c={create:function(e){var t=new Array(9);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},transpose:function(e,t){if(!t||e==t){var n=e[1],r=e[2],a=e[5];return e[1]=e[3],e[2]=e[6],e[3]=n,e[5]=e[7],e[6]=r,e[7]=a,e}return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},toMat4:function(e,t){return t||(t=f.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},multiplyVec3:function(e,t,n){n||(n=t);var r=t[0],a=t[1];return t=t[2],n[0]=e[0]*r+e[3]*a+e[6]*t,n[1]=e[1]*r+e[4]*a+e[7]*t,n[2]=e[2]*r+e[5]*a+e[8]*t,n},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+"]"}},f={create:function(e){var t=new Array(16);return e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t},set:function(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},transpose:function(e,t){if(!t||e==t){var n=e[1],r=e[2],a=e[3],i=e[6],o=e[7],s=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=n,e[6]=e[9],e[7]=e[13],e[8]=r,e[9]=i,e[11]=e[14],e[12]=a,e[13]=o,e[14]=s,e}return t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},determinant:function(e){var t=e[0],n=e[1],r=e[2],a=e[3],i=e[4],o=e[5],s=e[6],u=e[7],c=e[8],f=e[9],l=e[10],h=e[11],d=e[12],p=e[13],g=e[14];return d*f*s*a-c*p*s*a-d*o*l*a+i*p*l*a+c*o*g*a-i*f*g*a-d*f*r*u+c*p*r*u+d*n*l*u-t*p*l*u-c*n*g*u+t*f*g*u+d*o*r*h-i*p*r*h-d*n*s*h+t*p*s*h+i*n*g*h-t*o*g*h-c*o*r*(e=e[15])+i*f*r*e+c*n*s*e-t*f*s*e-i*n*l*e+t*o*l*e},inverse:function(e,t){t||(t=e);var n=e[0],r=e[1],a=e[2],i=e[3],o=e[4],s=e[5],u=e[6],c=e[7],f=e[8],l=e[9],h=e[10],d=e[11],p=e[12],g=e[13],v=e[14],m=e[15],b=n*s-r*o,y=n*u-a*o,x=n*c-i*o,M=r*u-a*s,w=r*c-i*s,U=a*c-i*u,S=f*g-l*p,A=f*v-h*p,z=f*m-d*p,O=l*v-h*g,T=l*m-d*g,k=h*m-d*v,N=1/(b*k-y*T+x*O+M*z-w*A+U*S);return t[0]=(s*k-u*T+c*O)*N,t[1]=(-r*k+a*T-i*O)*N,t[2]=(g*U-v*w+m*M)*N,t[3]=(-l*U+h*w-d*M)*N,t[4]=(-o*k+u*z-c*A)*N,t[5]=(n*k-a*z+i*A)*N,t[6]=(-p*U+v*x-m*y)*N,t[7]=(f*U-h*x+d*y)*N,t[8]=(o*T-s*z+c*S)*N,t[9]=(-n*T+r*z-i*S)*N,t[10]=(p*w-g*x+m*b)*N,t[11]=(-f*w+l*x-d*b)*N,t[12]=(-o*O+s*A-u*S)*N,t[13]=(n*O-r*A+a*S)*N,t[14]=(-p*M+g*y-v*b)*N,t[15]=(f*M-l*y+h*b)*N,t},toRotationMat:function(e,t){return t||(t=f.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},toMat3:function(e,t){return t||(t=c.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},toInverseMat3:function(e,t){var n=e[0],r=e[1],a=e[2],i=e[4],o=e[5],s=e[6],u=e[8],f=e[9],l=e[10],h=l*o-s*f,d=-l*i+s*u,p=f*i-o*u,g=n*h+r*d+a*p;return g?(g=1/g,t||(t=c.create()),t[0]=h*g,t[1]=(-l*r+a*f)*g,t[2]=(s*r-a*o)*g,t[3]=d*g,t[4]=(l*n-a*u)*g,t[5]=(-s*n+a*i)*g,t[6]=p*g,t[7]=(-f*n+r*u)*g,t[8]=(o*n-r*i)*g,t):null},multiply:function(e,t,n){n||(n=e);var r=e[0],a=e[1],i=e[2],o=e[3],s=e[4],u=e[5],c=e[6],f=e[7],l=e[8],h=e[9],d=e[10],p=e[11],g=e[12],v=e[13],m=e[14];e=e[15];var b=t[0],y=t[1],x=t[2],M=t[3],w=t[4],U=t[5],S=t[6],A=t[7],z=t[8],O=t[9],T=t[10],k=t[11],N=t[12],C=t[13],V=t[14];return t=t[15],n[0]=b*r+y*s+x*l+M*g,n[1]=b*a+y*u+x*h+M*v,n[2]=b*i+y*c+x*d+M*m,n[3]=b*o+y*f+x*p+M*e,n[4]=w*r+U*s+S*l+A*g,n[5]=w*a+U*u+S*h+A*v,n[6]=w*i+U*c+S*d+A*m,n[7]=w*o+U*f+S*p+A*e,n[8]=z*r+O*s+T*l+k*g,n[9]=z*a+O*u+T*h+k*v,n[10]=z*i+O*c+T*d+k*m,n[11]=z*o+O*f+T*p+k*e,n[12]=N*r+C*s+V*l+t*g,n[13]=N*a+C*u+V*h+t*v,n[14]=N*i+C*c+V*d+t*m,n[15]=N*o+C*f+V*p+t*e,n},multiplyVec3:function(e,t,n){n||(n=t);var r=t[0],a=t[1];return t=t[2],n[0]=e[0]*r+e[4]*a+e[8]*t+e[12],n[1]=e[1]*r+e[5]*a+e[9]*t+e[13],n[2]=e[2]*r+e[6]*a+e[10]*t+e[14],n},multiplyVec4:function(e,t,n){n||(n=t);var r=t[0],a=t[1],i=t[2];return t=t[3],n[0]=e[0]*r+e[4]*a+e[8]*i+e[12]*t,n[1]=e[1]*r+e[5]*a+e[9]*i+e[13]*t,n[2]=e[2]*r+e[6]*a+e[10]*i+e[14]*t,n[3]=e[3]*r+e[7]*a+e[11]*i+e[15]*t,n},translate:function(e,t,n){var r=t[0],a=t[1];if(t=t[2],!n||e==n)return e[12]=e[0]*r+e[4]*a+e[8]*t+e[12],e[13]=e[1]*r+e[5]*a+e[9]*t+e[13],e[14]=e[2]*r+e[6]*a+e[10]*t+e[14],e[15]=e[3]*r+e[7]*a+e[11]*t+e[15],e;var i=e[0],o=e[1],s=e[2],u=e[3],c=e[4],f=e[5],l=e[6],h=e[7],d=e[8],p=e[9],g=e[10],v=e[11];return n[0]=i,n[1]=o,n[2]=s,n[3]=u,n[4]=c,n[5]=f,n[6]=l,n[7]=h,n[8]=d,n[9]=p,n[10]=g,n[11]=v,n[12]=i*r+c*a+d*t+e[12],n[13]=o*r+f*a+p*t+e[13],n[14]=s*r+l*a+g*t+e[14],n[15]=u*r+h*a+v*t+e[15],n},scale:function(e,t,n){var r=t[0],a=t[1];return t=t[2],n&&e!=n?(n[0]=e[0]*r,n[1]=e[1]*r,n[2]=e[2]*r,n[3]=e[3]*r,n[4]=e[4]*a,n[5]=e[5]*a,n[6]=e[6]*a,n[7]=e[7]*a,n[8]=e[8]*t,n[9]=e[9]*t,n[10]=e[10]*t,n[11]=e[11]*t,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n):(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=a,e[5]*=a,e[6]*=a,e[7]*=a,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e)},rotate:function(e,t,n,r){var a=n[0],i=n[1];n=n[2];var o=Math.sqrt(a*a+i*i+n*n);if(!o)return null;1!=o&&(a*=o=1/o,i*=o,n*=o);var s=Math.sin(t),u=Math.cos(t),c=1-u;t=e[0],o=e[1];var f=e[2],l=e[3],h=e[4],d=e[5],p=e[6],g=e[7],v=e[8],m=e[9],b=e[10],y=e[11],x=a*a*c+u,M=i*a*c+n*s,w=n*a*c-i*s,U=a*i*c-n*s,S=i*i*c+u,A=n*i*c+a*s,z=a*n*c+i*s;return a=i*n*c-a*s,i=n*n*c+u,r?e!=r&&(r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]):r=e,r[0]=t*x+h*M+v*w,r[1]=o*x+d*M+m*w,r[2]=f*x+p*M+b*w,r[3]=l*x+g*M+y*w,r[4]=t*U+h*S+v*A,r[5]=o*U+d*S+m*A,r[6]=f*U+p*S+b*A,r[7]=l*U+g*S+y*A,r[8]=t*z+h*a+v*i,r[9]=o*z+d*a+m*i,r[10]=f*z+p*a+b*i,r[11]=l*z+g*a+y*i,r},rotateX:function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var a=e[4],i=e[5],o=e[6],s=e[7],u=e[8],c=e[9],f=e[10],l=e[11];return n?e!=n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[4]=a*t+u*r,n[5]=i*t+c*r,n[6]=o*t+f*r,n[7]=s*t+l*r,n[8]=a*-r+u*t,n[9]=i*-r+c*t,n[10]=o*-r+f*t,n[11]=s*-r+l*t,n},rotateY:function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var a=e[0],i=e[1],o=e[2],s=e[3],u=e[8],c=e[9],f=e[10],l=e[11];return n?e!=n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=a*t+u*-r,n[1]=i*t+c*-r,n[2]=o*t+f*-r,n[3]=s*t+l*-r,n[8]=a*r+u*t,n[9]=i*r+c*t,n[10]=o*r+f*t,n[11]=s*r+l*t,n},rotateZ:function(e,t,n){var r=Math.sin(t);t=Math.cos(t);var a=e[0],i=e[1],o=e[2],s=e[3],u=e[4],c=e[5],f=e[6],l=e[7];return n?e!=n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]):n=e,n[0]=a*t+u*r,n[1]=i*t+c*r,n[2]=o*t+f*r,n[3]=s*t+l*r,n[4]=a*-r+u*t,n[5]=i*-r+c*t,n[6]=o*-r+f*t,n[7]=s*-r+l*t,n},frustum:function(e,t,n,r,a,i,o){o||(o=f.create());var s=t-e,u=r-n,c=i-a;return o[0]=2*a/s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*a/u,o[6]=0,o[7]=0,o[8]=(t+e)/s,o[9]=(r+n)/u,o[10]=-(i+a)/c,o[11]=-1,o[12]=0,o[13]=0,o[14]=-i*a*2/c,o[15]=0,o},perspective:function(e,t,n,r,a){return t*=e=n*Math.tan(e*Math.PI/360),f.frustum(-t,t,-e,e,n,r,a)},ortho:function(e,t,n,r,a,i,o){o||(o=f.create());var s=t-e,u=r-n,c=i-a;return o[0]=2/s,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2/u,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=-2/c,o[11]=0,o[12]=-(e+t)/s,o[13]=-(r+n)/u,o[14]=-(i+a)/c,o[15]=1,o},lookAt:function(e,t,n,r){r||(r=f.create());var a=e[0],i=e[1];e=e[2];var o=n[0],s=n[1],u=n[2];n=t[1];var c,l,h,d,p=t[2];return a==t[0]&&i==n&&e==p?f.identity(r):(n=a-t[0],p=i-t[1],t=e-t[2],c=s*(t*=d=1/Math.sqrt(n*n+p*p+t*t))-u*(p*=d),u=u*(n*=d)-o*t,o=o*p-s*n,(d=Math.sqrt(c*c+u*u+o*o))?(c*=d=1/d,u*=d,o*=d):o=u=c=0,s=p*o-t*u,l=t*c-n*o,h=n*u-p*c,(d=Math.sqrt(s*s+l*l+h*h))?(s*=d=1/d,l*=d,h*=d):h=l=s=0,r[0]=c,r[1]=s,r[2]=n,r[3]=0,r[4]=u,r[5]=l,r[6]=p,r[7]=0,r[8]=o,r[9]=h,r[10]=t,r[11]=0,r[12]=-(c*a+u*i+o*e),r[13]=-(s*a+l*i+h*e),r[14]=-(n*a+p*i+t*e),r[15]=1,r)},str:function(e){return"["+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+"]"}},l=f,h={isEqual:function(e,t,n){return Math.abs(e-t)<n},clamp:function(e,t,n){return e<t?e=t:e>n&&(e=n),e},radians:function(e){return e*Math.PI/180},degrees:function(e){return e/Math.PI*180},mix:function(e,t,n){return e+(t-e)*n},frustumMatrix:function(e,t,n,r,a,i){var o=t-e,s=r-n,u=i-a,c=l.create([2*a/o,0,(t+e)/o,0,0,2*a/s,(r+n)/s,0,0,0,-(i+a)/u,-2*i*a/u,0,0,-1,0]);return l.transpose(c),c},perspectiveMatrix:function(e,t,n,r){var a=n*Math.tan(e*Math.PI/180),i=a*t;return h.frustumMatrix(-i,i,-a,a,n,r)},orthographicMatrix:function(e,t,n,r){var a=.5*e*t,i=.5*e,o=r-n,s=l.create([1/a,0,0,0,0,1/i,0,0,0,0,-2/o,-(r+n)/o,0,0,0,1]);return l.transpose(s),s},rotationMatrix:function(e,t){var n=Math.cos(t),r=Math.sin(t);switch(e){case 0:return[1,0,0,0,0,n,r,0,0,-r,n,0,0,0,0,1];case 1:return[n,0,r,0,0,1,0,0,-r,0,n,0,0,0,0,1];default:return[n,r,0,0,-r,n,0,0,0,0,1,0,0,0,0,1]}},scaleMatrix:function(e,t,n){return[e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1]},scaleMatrixf:function(e){return h.scaleMatrix(e,e,e)},translationMatrix:function(e,t,n){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,n,1]},translationMatrix2f:function(e){return h.translationMatrix(e[0],e[1],0)},translationMatrix3f:function(e){return h.translationMatrix(e[0],e[1],e[2])}},d={isSameOrigin:function(e){if("string"!=typeof e)return!1;var t=document.location.hostname;return d.parse(e).hostname===t},parse:function(e){if("string"!=typeof e)return null;var t=document.createElement("a");return t.href=e,t},getParamsFromUrl:function(e){var t={},n=d.parse(e).search.substring(1).split("&");if(1!=n.length||""!=n[0])for(var r=0;r<n.length;r++){var a=n[r].split("=");if(void 0===t[a[0]])t[a[0]]=a[1];else if("string"==typeof t[a[0]]){var i=[t[a[0]],a[1]];t[a[0]]=i}else t[a[0]].push(a[1])}return t},getHost:function(e){var t=document.createElement("a");return t.href=e,t.hostname},getSchema:function(e){if(-1!=e.indexOf("http://"))return"http:";if(-1!=e.indexOf("https://"))return"https:";var t=document.createElement("a");return t.href=e,t.protocol},getOrigin:function(e){var t=document.createElement("a");return t.href=e,t.origin?t.origin:t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")},getBase:function(e){return e.split("?")[0].split("/").slice(0,-1).join("/")+"/"},makeAbsolute:function(e){var t=document.createElement("a");return t.href=e,t.href},getProcessUrl:function(e,t){if(!e||!t)return e;e=e.trim(),t=t.trim();var n=d.getBase(t),r=d.getSchema(t),a=d.getOrigin(t);return-1!=e.indexOf("://")?e:0==e.indexOf("//")?r+e:0==e.indexOf("/")?a+e:n+e}},p=h,g=d,v={useCredentials:!1,instanceCounter:0,validateBool:function(e,t){return"boolean"==typeof e?e:t},validateNumber:function(e,t,n,r){return"number"==typeof e?p.clamp(e,t,n):r},validateNumberArray:function(e,t,n,r,a){if(Array.isArray(e)&&e.length==t){for(var i=0;i<t;i++)e[i]=p.clamp(e[i],n[i],r[i]);return e}return a},validateString:function(e,t){return"string"==typeof e?e:t},padNumber:function(e,t){return e<0?(t--,(e=-e+"").length>=t?"-"+e:"-"+(new Array(t-e.length+1).join("0")+e)):(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e},decodeFloat16:function(e){var t=(31744&e)>>10,n=1023&e;return(e>>15?-1:1)*(t?31===t?n?NaN:1/0:Math.pow(2,t-15)*(1+n/1024):n/1024*6103515625e-14)},simpleFmtObj:function(e,t){return e&&""!=e?e.replace(/\\{([$a-zA-Z0-9][$a-zA-Z0-9]*)\\}/g,(function(e,n){return n in t?t[n]:e})):""},simpleWikiLinks:function(e,t){return e&&""!=e?v.simpleFmtObj(e,{copy:"&copy;",Y:(new Date).getFullYear()}).replace(/\\[([^\\]]*)\\]/g,(function(e,n){var r=(n=n.trim()).split(" ");return-1!=r[0].indexOf("//")?t?r.length>1?""+n.substring(r[0].length):""+r[0]:r.length>1?"<a href="+r[0]+\' target="blank">\'+n.substring(r[0].length)+"</a>":"<a href="+r[0]+\' target="blank">\'+r[0]+"</a>":n})):""},simpleFmtObjOrCall:function(e,t,n){return e&&""!=e?e.replace(/\\{([$a-zA-Z(-9][$a-zA-Z(-9]*)\\}/g,(function(e,r){return r in t?t[r]:n(r)})):""},getABGRFromHexaCode:function(e){var t=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(e);return t?[parseInt(t[4],16),parseInt(t[3],16),parseInt(t[2],16),parseInt(t[1],16)]:[0,0,0,255]},stringifyFunction:function(e){return"("+e+").call(self);"},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},fitToPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},getHash:function(e){if(!e||0===e.length)return 0;for(var t=0,n=0,r=e.length;n<r;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t},convertRGB2YCbCr:function(e,t,n){return[.299*e+.587*t+.114*n+0,-.169*e+-.331*t+.5*n+128,.5*e+-.419*t+-.081*n+128]},convertYCbCr2RGB:function(e,t,n){return[1*e+0*(t-128)+1.4*(n-128),1*e+-.343*(t-128)+-.711*(n-128),1*e+1.765*(t-128)+0*(n-128)]},convertHSL2RGB:function(e,t,n){var r,a,i,o,s,u;return(e/=60)<0&&(e=6- -e%6),e%=6,t=Math.max(0,Math.min(1,t/100)),n=Math.max(0,Math.min(1,n/100)),u=(s=(1-Math.abs(2*n-1))*t)*(1-Math.abs(e%2-1)),e<1?(r=s,a=u,i=0):e<2?(r=u,a=s,i=0):e<3?(r=0,a=s,i=u):e<4?(r=0,a=u,i=s):e<5?(r=u,a=0,i=s):(r=s,a=0,i=u),[r+(o=n-s/2),a+o,i+o]},getHashColor:function(e){var t=v.getHash(e),n=v.convertRGB2YCbCr(255&t,t>>8&255,t>>16&255);return n[0]=p.clamp(n[0],50,200),v.convertRGB2YCbCr(n[0],n[1],n[2])},getHashColor2:function(e){var t=Math.floor(e/18),n=50;return t>=1&&(n=t%2?50+10*n%30:50-10*(n-1)%30),t=e%18*20,v.convertHSL2RGB(t,100,n)},loadText:function(e,t,n,r,a){v.loadJSON(e,t,n,!0,r,a)},loadXML:function(e,t,n,r,a){v.loadJSON(e,(function(e){e=(new DOMParser).parseFromString(e,"text/xml"),t&&t(e)}),n,!0,r,a)},loadJSON:function(e,t,n,r,a,i){var o=new XMLHttpRequest;o.onreadystatechange=function(){switch(o.readyState){case 0:case 1:case 2:case 3:break;case 4:if(o.status>=400||0==o.status){n&&n(o.status);break}var a=o.response,i=a;if(!r)try{i=JSON.parse(a)}catch(t){return console.log("JSON Parse Error ("+e+"): "+(t.message?t.message:"")),void(n&&n(o.status))}t&&t(i)}}.bind(this),o.open("GET",e,!0),o.withCredentials=a,i&&i.token&&o.setRequestHeader("Accept","token/"+i.token+", */*"),i&&i.charset&&o.overrideMimeType("text/xml; charset="+i.charset),o.send("")},loadBinary:function(e,t,n,r,a,i){var o=new XMLHttpRequest;o.onreadystatechange=function(){switch(o.readyState){case 0:case 1:case 2:case 3:break;case 4:if(o.status>=400||0==o.status){n&&n(o.status);break}var e=o.response;if(!e){n&&n();break}t&&t(e);break;default:n&&n()}}.bind(this),o.open("GET",e,!0),o.responseType=i||"arraybuffer",o.withCredentials=r,a&&a.token&&o.setRequestHeader("Accept","token/"+a.token+", */*"),o.send("")},headRequest:function(e,t,n,r,a){var i=new XMLHttpRequest;i.onreadystatechange=function(){switch(i.readyState){case 0:case 1:case 2:case 3:break;case 4:null!=t&&t(i.getAllResponseHeaders(),i.status);break;default:null!=n&&n()}}.bind(this),i.onerror=function(){null!=n&&n()}.bind(this),i.open("HEAD",e,!0),i.withCredentials=r,a&&a.token&&i.setRequestHeader("Accept","token/"+a.token+", */*"),i.send("")},loadImage:function(e,t,n,r,a){var i=new Image;return i.onerror=n,i.onload=t,a||(i.crossOrigin=r?"use-credentials":"anonymous"),i.src=e,i},getParamsFromUrl:function(e){return g.getParamsFromUrl(e)}},m="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;v.unint8ArrayToString=function(e){if(m)return m.decode(e);var t="",n=new Uint8Array(e.byteLength);n.set(e);for(var r=new Uint32Array(n.buffer),a=0,i=r.length;a<i;++a){var o=r[a];o<=65535?t+=String.fromCharCode(o):(o-=65536,t+=String.fromCharCode(55296+(o>>10),56320+(1023&o)))}return t};var b=u,y=v,x=function(){this.bintree=null,this.pathTable=null,this.totalNodes=0,this.pathTableSize=1,this.nodesIndex=0,this.rootSize=1};x.prototype.countNode=function(e,t){this.totalNodes++;var n=e.content;if(n&&n.uri){var r=n.uri.split(".");if(r.length>1){var a=r[r.length-1];r.pop();var i=r.join(".");"json"==a?this.pathTableSize+=i.length+1+4:"mesh"==a&&(this.pathTableSize+=i.length+1)}}var o=e.children;if(o)for(var s=0,u=o.length;s<u;s++)this.countNode(o[s])},x.prototype.processNode=function(e,t,n,r){var a=9*t,i=e.content;if(i&&i.uri){var o=i.uri.split(".");if(o.length>1){var s=o[o.length-1];o.pop();var u=o.join(".");"json"==s?(this.bintree[a]=this.pathTableSize|1<<31,this.pathTableSize+=4):"mesh"==s&&(this.bintree[a]=this.pathTableSize);for(var c=0,f=u.length;c<f;c++)this.pathTable[this.pathTableSize++]=u.charCodeAt(c);this.pathTable[this.pathTableSize++]=0}}var l=e.children;if(l)for(c=0,f=l.length;c<f;c++){var h=l[c],d=h.boundingVolume;if(d){var p=h.extras,g=0;p&&(g=p.ci);if(d.region){this.totalNodes++;var v=this.totalNodes;this.bintree[a+1+g]=v,this.processNode(h,v,n+1)}}}},x.prototype.processJSON=function(e,t){if(e){if(this.rootPath="",this.countNode(e.root),this.bintree=new Uint32Array(9*this.totalNodes),this.pathTable=new Uint8Array(this.pathTableSize+1),this.totalNodes=0,this.pathTableSize=1,t.root){var n=e.extras,r=n.extents,a=[(r[0][0]+r[1][0]+r[2][0]+r[3][0]+r[4][0]+r[5][0]+r[6][0]+r[7][0])/8,(r[0][1]+r[1][1]+r[2][1]+r[3][1]+r[4][1]+r[5][1]+r[6][1]+r[7][1])/8,(r[0][2]+r[1][2]+r[2][2]+r[3][2]+r[4][2]+r[5][2]+r[6][2]+r[7][2])/8],i=[r[1][0]-r[0][0],r[1][1]-r[0][1],r[1][2]-r[0][2]],o=[r[1][0]-r[2][0],r[1][1]-r[2][1],r[1][2]-r[2][2]],s=[r[4][0]-r[0][0],r[4][1]-r[0][1],r[4][2]-r[0][2]];i[0]=-i[0],i[1]=-i[1],i[2]=-i[2],o[0]=-o[0],o[1]=-o[1],o[2]=-o[2];var u=r[1];this.rootPoints=[[u[0],u[1],u[2]],[u[0]+o[0],u[1]+o[1],u[2]+o[2]],[u[0]+o[0]+i[0],u[1]+o[1]+i[1],u[2]+o[2]+i[2]],[u[0]+i[0],u[1]+i[1],u[2]+i[2]],[u[0]+s[0],u[1]+s[1],u[2]+s[2]],[u[0]+o[0]+s[0],u[1]+o[1]+s[1],u[2]+o[2]+s[2]],[u[0]+o[0]+i[0]+s[0],u[1]+o[1]+i[1]+s[1],u[2]+o[2]+i[2]+s[2]],[u[0]+i[0]+s[0],u[1]+i[1]+s[1],u[2]+i[2]+s[2]]],this.rootCenter=a,this.rootRadius=b.distance(a,r[0]),this.rootTexelSize=n.nominalResolution*Math.pow(2,n.depth)}else this.rootPoints=[],this.rootCenter=[],this.rootRadius=1,this.rootTexelSize=1;this.processNode(e.root,0,0),this.totalNodes++}},x.prototype.loadJSON=function(e,t,n){y.loadJSON(e,this.onLoaded.bind(this,t,n),null)},x.prototype.onLoaded=function(e,t,n){this.processJSON(n,e),t&&t(e,{bintree:this.bintree,pathTable:this.pathTable,totalNodes:this.totalNodes,rootSize:this.rootSize,points:this.rootPoints,center:this.rootCenter,radius:this.rootRadius,texelSize:this.rootTexelSize})};var M=r,w=function(e){var t,n,r={},o=e.data,s="";if(o.length<2)return!1;if(s+=String.fromCharCode(o.getUint8(e.index,!0)),e.index+=1,s+=String.fromCharCode(o.getUint8(e.index,!0)),e.index+=1,"ME"!=s)return!1;if(r.version=o.getUint16(e.index,!0),e.index+=2,r.version>3)return!1;for(e.uint8Data=new Uint8Array(e.data.buffer),r.meanUndulation=o.getFloat64(e.index,!0),e.index+=8,r.numSubmeshes=o.getUint16(e.index,!0),e.index+=2,r.submeshes=[],r.gpuSize=0,r.faces=0,r.size=0,a.config.map16bitMeshes,t=0,n=r.numSubmeshes;t<n;t++){var u;(u=i(r,e)).valid&&(r.submeshes.push(u),r.size+=u.size,r.faces+=u.faces,r.gpuSize+=u.size)}r.numSubmeshes=r.submeshes.length;var c=[],f=[];for(t=0,n=r.numSubmeshes;t<n;t++)u=r.submeshes[t],c.push({bboxMax:u.bboxMax,bboxMin:u.bboxMin,externalUVs:u.externalUVs?u.externalUVs.buffer:null,faces:u.faces,flags:u.flags,gpuSize:u.gpuSize,indices:u.indices?u.indices.buffer:null,internalUVs:u.internalUVs?u.internalUVs.buffer:null,size:u.size,surfaceReference:u.surfaceReference,textureLayer:u.textureLayer,textureLayer2:u.textureLayer2,vertices:u.vertices.buffer}),u.externalUVs&&f.push(u.externalUVs.buffer),u.internalUVs&&f.push(u.internalUVs.buffer),u.vertices&&f.push(u.vertices.buffer),u.indices&&f.push(u.indices.buffer);return{mesh:{faces:r.faces,gpuSize:r.gpuSize,meanUndulation:r.meanUndulation,numSubmeshes:r.numSubmeshes,size:r.size,submeshes:r.submeshes,version:r.version},transferables:f}},U=x,S=[],A=[];function z(e,t){M.config.mapPackLoaderEvents?(S.push(e),t&&(A=A.concat(t))):t?postMessage(e,t):postMessage(e)}function O(e,t,n,r,a,i,o,s){var u=new XMLHttpRequest;u.onreadystatechange=function(){switch(u.readyState){case 0:case 1:case 2:case 3:break;case 4:if(u.status>=400||0==u.status){n&&z({command:"on-error",path:e,status:u.status});break}var r=u.response;if(!r){n&&z({command:"on-error",path:e});break}if(t)if("direct-texture"==o)createImageBitmap(r).then(function(t){z({command:"on-loaded",path:e,data:t,filesize:r.size},[t])}.bind(this));else if("direct-mesh"==o){var a=w({data:new DataView(r),index:0});z({command:"on-loaded",path:e,data:a.mesh},a.transferables)}else if("direct-3dtiles"==o){a=function(e,t){var n=new U;return n.processJSON(e,t),{geodata:{bintree:n.bintree,pathTable:n.pathTable,totalNodes:n.totalNodes,rootSize:n.rootSize,points:n.rootPoints,center:n.rootCenter,radius:n.rootRadius,texelSize:n.rootTexelSize},transferables:[n.bintree.buffer,n.pathTable.buffer]}}(JSON.parse(r),s);postMessage({command:"on-loaded",path:e,data:a.geodata},a.transferables)}else z({command:"on-loaded",path:e,data:r},[r]);break;default:n&&z({command:"on-error",path:e})}}.bind(this),u.open("GET",e,!0),u.responseType=i||"arraybuffer",u.withCredentials=r,s&&s.size&&u.setRequestHeader("Range","bytes="+s.offset+"-"+(s.offset+s.size)),a&&a.token&&u.setRequestHeader("Accept","token/"+a.token+", */*"),u.send("")}self.onmessage=function(e){var t=e.data;switch(t.command){case"config":M.config=t.data;break;case"tick":S.length>0&&(A.length>0?postMessage({command:"packed-events",messages:S},A):postMessage({command:"packed-events",messages:S})),S=[],A=[];break;case"load-binary":O(t.path,!0,!0,t.withCredentials,t.xhrParams,t.responseType,t.kind,t.options)}}}]);\n//# sourceMappingURL=3c12688b980e7623d21f.worker.js.map',null)}},,function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){},function(e,t,i){"use strict";i.r(t),i.d(t,"vec2",(function(){return vt})),i.d(t,"vec3",(function(){return yt})),i.d(t,"vec4",(function(){return bt})),i.d(t,"mat3",(function(){return xt})),i.d(t,"mat4",(function(){return wt})),i.d(t,"math",(function(){return At})),i.d(t,"utils",(function(){return Mt})),i.d(t,"getCoreVersion",(function(){return gt})),i.d(t,"checkSupport",(function(){return mt})),i.d(t,"browser",(function(){return Ft})),i.d(t,"getBrowserVersion",(function(){return Lt})),i.d(t,"proj4",(function(){return Tt})),i.d(t,"earcut",(function(){return a.a})),i.d(t,"platform",(function(){return Pt})),i.d(t,"dom",(function(){return St}));var r=i(6),s=i(8),a=i.n(s),n=i(7),o=i(0),h=i(1),l=i(2),u=i(4),c=(i(16),i(17),i(18),i(19),i(12)),d=function(e,t,i){this.type=e,this.event=i,this.element=t};d.prototype.getMouseButton=function(){switch(this.type){case"touchstart":case"touchend":case"touchmove":var e=this.event.touches;if(e)switch(e.length){case 1:return"left";case 2:return"right";case 3:return"middle"}return"";default:if(this.event.which)switch(this.event.which){case 1:return"left";case 2:return"middle";case 3:return"right"}else if(this.event.button)switch(this.event.button){case 1:return"left";case 2:return"right";case 3:return"middle"}}return""},d.prototype.getMouseCoords=function(e){var t=[0,0];switch(this.type){case"touchstart":case"touchend":case"touchmove":var i=this.event.touches;if(!i||0==i.length)break;for(var r=0,s=i.length;r<s;r++){var a=this.getEventCoords(this.event.touches[r],e);t[0]+=a[0],t[1]+=a[1]}t[0]/=s,t[1]/=s;break;case"mousedown":case"mouseup":case"mousemove":case"mouseenter":case"mouseover":case"mouseleave":case"click":case"dblclick":case"dragstart":case"dragend":case"drag":t=this.getEventCoords(this.event,e)}return t},d.prototype.getEventCoords=function(e,t){if(null==this.element.getPageRect||t)return[e.clientX,e.clientY];var i=this.element.getPageRect();return[e.pageX-i.left,e.pageY-i.top]},d.prototype.getDragDelta=function(){switch(this.type){case"drag":return[this.event.deltaX,this.event.deltaY]}return[0,0]},d.prototype.getDragZoom=function(){switch(this.type){case"drag":return this.event.zoom}return 1},d.prototype.getDragTouches=function(){switch(this.type){case"drag":return this.event.touches}return 0},d.prototype.getModifierKey=function(e){switch(this.type){case"mouseup":case"mousedown":case"dblclick":case"keyup":case"keydown":case"keypress":switch(e){case"alt":return this.event.altKey;case"ctrl":return this.event.ctrlKey;case"shift":return this.event.shiftKey}}return!1},d.prototype.getKeyCode=function(){switch(this.type){case"keyup":case"keydown":case"keypress":return this.event.keyCode?this.event.keyCode:this.event.which?this.event.which:this.event.charCode}return null},d.prototype.getDragButton=function(e){switch(e){case"left":case"right":case"middle":switch(this.getTouchesCount()){case-1:return this.event[e];case 0:return!1;case 1:return"left"==e;case 2:return"right"==e;case 3:return"middle"==e}}return!1},d.prototype.getWheelDelta=function(){switch(this.type){case"mousewheel":var e=0;return this.event.wheelDelta&&(e=this.event.wheelDelta/120),this.event.detail&&(e=-this.event.detail/3),e}return 0},d.prototype.getTouchesCount=function(){switch(this.type){case"touchstart":case"touchend":case"touchmove":if(!this.event.touches)break;return this.event.touches.length}return-1},d.prototype.getTouchParameter=function(e){switch(this.type){case"drag":return this.event[e]}return null},d.prototype.getTouchCoords=function(e,t){switch(this.type){case"touchstart":case"touchend":case"touchmove":if(!this.event.touches)break;var i=this.event.touches[e];if(!i)break;if(null==this.element.getPageRect||t)return[i.clientX,i.clientY];var r=this.element.getPageRect();return[i.pageX-r.left,i.pageY-r.top]}return[0,0]},d.prototype.getType=function(){return this.type};var p=d,f=p,g={hasClass:function(e,t){if(void 0!==e.classList)return e.classList.contains(t);var i=g.getClass(e);return i.length>0&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(i)},addClass:function(e,t){if(void 0!==e.classList)for(var i=g.splitWords(t),r=0,s=i.length;r<s;r++)e.classList.add(i[r]);else if(!g.hasClass(e,t)){var a=g.getClass(e);g.setClass(e,(a?a+" ":"")+t)}},removeClass:function(e,t){void 0!==e.classList?e.classList.remove(t):g.setClass(e,(" "+g.getClass(e)+" ").replace(" "+t+" "," ").trim())},setClass:function(e,t){void 0===e.className.baseVal?e.className=t:e.className.baseVal=t},getClass:function(e){return void 0===e.className.baseVal?e.className:e.className.baseVal},preventDefault:function(e){(e=e instanceof f?e.event:e).preventDefault?e.preventDefault():e.returnValue=!1},stopPropagation:function(e){(e=e instanceof f?e.event:e).stopPropagation()},disableTextSelection:function(){window.addEventListener("selectstart",g.preventDefault)},enableTextSelection:function(){window.removeEventListener("selectstart",g.preventDefault)},disableImageDrag:function(){window.addEventListener("dragstart",g.preventDefault)},enableImageDrag:function(){window.removeEventListener("dragstart",g.preventDefault)},disableContexMenu:function(e){e.addEventListener("contextmenu",g.preventDefault)},enableContexMenu:function(e){e.removeEventListener("contextmenu",g.preventDefault)},getSupportedProperty:function(e){for(var t=document.documentElement.style,i=0,r=e.length;i<r;i++)if(e[i]in t)return e[i];return!1},stampCounter:0,stamp:function(e){return e.vtsStamp=e.vtsStamp||++g.stampCounter,e.vtsStamp}};g.TRANSFORM=g.getSupportedProperty(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]);var m=g,v=p,y=m,b=u.a,x=function(e,t){this.control=e,this.ui=this.control.ui,this.element=t,this.events=[],this.dragBeginCall=this.onDragBegin.bind(this,!1),this.dragBeginCallTouch=this.onDragBegin.bind(this,!0),this.dragMoveCall=this.onDragMove.bind(this,!1),this.dragMoveCallTouch=this.onDragMove.bind(this,!0),this.dragEndCall=this.onDragEnd.bind(this,!1),this.dragEndCallTouch=this.onDragEnd.bind(this,!0),this.firstDragDistance=0,this.lastDragDistance=0,this.lastWheelTimer=0,this.lastWheelTimer2=0,this.dragStartPos=[0,0],this.dragCurrentPos=[0,0],this.dragLastPos=[0,0],this.dragAbsMoved=[0,0],this.zoomDrag=!1,this.wheelTimes=[],this.id=this.ui.elementIdCounter++};x.prototype.setStyle=function(e,t){this.element.style[e]=t},x.prototype.getStyle=function(e){return this.element.style[e]},x.prototype.setClass=function(e){return y.setClass(this.element,e),this},x.prototype.getClass=function(){return y.getClass(this.element),this},x.prototype.hasClass=function(e){return y.hasClass(this.element,e)},x.prototype.addClass=function(e){return y.addClass(this.element,e),this},x.prototype.removeClass=function(e){return y.removeClass(this.element,e),this},x.prototype.getRect=function(){var e=this.element.getBoundingClientRect(),t=this.ui.map.getMapElement().element.getBoundingClientRect(),i=window.pageXOffset||0,r=window.pageYOffset||0;return{left:e.left+i-(t.left+i),top:e.top+r-(t.top+r),fromRight:t.right-(e.left+i-(t.left+i)),fromBottom:t.height-(e.top+r-(t.top+r)),width:e.width,height:e.height}},x.prototype.getPageRect=function(){var e=this.element.getBoundingClientRect(),t=window.pageXOffset||0,i=window.pageYOffset||0;return{left:e.left+t,top:e.top+i,width:e.width,height:e.height}},x.prototype.setHtml=function(e){this.element.innerHTML=e;for(var t=this.element.getElementsByTagName("*"),i=0,r=t.length;i<r;i++){var s=t[i].getAttribute("id");null!==s&&(this.control.elementsById[s]=new x(this,t[i]))}},x.prototype.getHtml=function(){return this.element.innerHTML},x.prototype.getElement=function(){return this.element},x.prototype.on=function(e,t,i){this.addEvent(e,t,i)},x.prototype.once=function(e,t,i){var r=function(){this.removeEvent(e,t,i)}.bind(this);this.addEvent(e,(function(e){t(e),r()}),i)},x.prototype.off=function(e,t,i){this.removeEvent(e,t,i)},x.prototype.fire=function(e,t){var i=this.events[e];if(null!=i)for(var r in i)i[r](t)},x.prototype.addEvent=function(e,t,i){var r=e+"-"+y.stamp(t)+(i?"-"+y.stamp(i):""),s=function(i){if(!this.ui.killed){if("mousewheel"==e&&-1!=b.getOS().toLowerCase().indexOf("mac")){var r=Date.now(),s=r-this.lastWheelTimer2;this.wheelTimes.push(r);for(var a=0,n=0;n<this.wheelTimes.length;)r-this.wheelTimes[n]>500?this.wheelTimes.splice(n,1):(a+=r-this.wheelTimes[n],n++);a=this.wheelTimes.length?a/this.wheelTimes.length:0,s>500&&(this.lastWheelTimer2=r,s=0);var o=Math.min(this.wheelTimes.length*this.ui.browser.config.wheelInputLag[1],this.ui.browser.config.wheelInputLag[0]);if(r-this.lastWheelTimer<o)return;this.lastWheelTimer=r}t(new v(e,this,i||window.event))}}.bind(this),a=i||this.element;a.addEventListener(this.getEventName(e),s,!1),"mousewheel"==e&&a.addEventListener("DOMMouseScroll",s,!1),this.events[e]=this.events[e]||[],this.events[e][r]=s},x.prototype.removeEvent=function(e,t,i){var r=e+"-"+y.stamp(t)+(i?"-"+y.stamp(i):""),s=this.events[e]&&this.events[e][r];null!=s&&(delete this.events[e][r],(i||this.element).removeEventListener(this.getEventName(e),s,!1))},x.prototype.getEventName=function(e){return e},x.prototype.setDraggableState=function(e){e?(this.on("mousedown",this.dragBeginCall),this.on("touchstart",this.dragBeginCallTouch)):this.dragable&&(this.off("mousedown",this.dragBeginCall),this.off("mousemove",this.dragMoveCall,document),this.off("mouseup",this.dragEndCall,document),this.off("touchstart",this.dragBeginCallTouch),this.off("touchmove",this.dragMoveCallTouch,document),this.off("touchend",this.dragEndCallTouch,document),this.dragging=!1),this.dragStartPos=[0,0],this.dragCurrentPos=[0,0],this.dragLastPos=[0,0],this.dragAbsMoved=[0,0],this.dragTouchCount=0,this.dragTouches=[],this.dragTouches2=[],this.resetPos=!1,this.dragable=e,this.dragButtons={left:!1,right:!1,middle:!1}},x.prototype.getDraggableState=function(){return this.dragable},x.prototype.getDraggingState=function(){return{dragging:this.dragging,buttonLeft:this.dragButtons.left,buttonRight:this.dragButtons.right,buttonMiddle:this.dragButtons.middle,startPos:this.dragStartPos.slice(),lastPos:this.dragLastPos.slice(),currentPos:this.dragCurrentPos.slice(),absMoved:this.dragAbsMoved.slice()}},x.prototype.onDragBegin=function(e,t){if(this.dragButtons[t.getMouseButton()]=!0,this.dragTouches=[],this.dragTouches2=[],this.dragTouches.push(t.getTouchCoords(0)),this.dragTouches2.push(t.getTouchCoords(1)),e&&(this.resetPos=!0,this.firstDragDistance=0,this.lastDragDistance=0,this.zoomDrag=!1),this.dragging)this.dragLastPos=t.getMouseCoords();else{this.dragging=!0;var i=t.getMouseCoords();this.dragStartPos=[i[0],i[1]],this.dragCurrentPos=[i[0],i[1]],this.dragLastPos=[i[0],i[1]],this.dragAbsMoved=[0,0],this.on("mousemove",this.dragMoveCall,document),this.on("mouseup",this.dragEndCall,document),this.on("touchmove",this.dragMoveCallTouch,document),this.on("touchend",this.dragEndCallTouch,document),y.disableTextSelection(),y.disableImageDrag(),y.preventDefault(t),this.dragLastPos[0]=i[0],this.dragLastPos[1]=i[1],this.fire("dragstart",{clientX:i[0],clientY:i[1],pageX:i[0],pageY:i[1]})}},x.prototype.onDragMove=function(e,t){var i=t.getMouseCoords();-1!=t.getTouchesCount()&&this.updateDragButtonsState(t,!0),y.preventDefault(t);var r="",s=0,a=[0,0],n=0;if(e){var o=t.getTouchesCount();if(o!=this.dragTouchCount&&(this.dragLastPos[0]=i[0],this.dragLastPos[1]=i[1],this.dragTouchCount=o),this.resetPos&&(this.dragCurrentPos=[i[0],i[1]],this.dragLastPos[0]=i[0],this.dragLastPos[1]=i[1],this.resetPos=!1),2==o&&(this.dragTouches.push(t.getTouchCoords(0)),this.dragTouches2.push(t.getTouchCoords(1)),this.dragTouches.length>=7&&(this.dragTouches.shift(),this.dragTouches2.shift()),6==this.dragTouches.length)){var h,l,u=this.dragTouches,c=u[5][0]-u[4][0]+(u[4][0]-u[3][0])+(u[3][0]-u[2][0])+(u[2][0]-u[1][0])+(u[1][0]-u[0][0]),d=u[5][1]-u[4][1]+(u[4][1]-u[3][1])+(u[3][1]-u[2][1])+(u[2][1]-u[1][1])+(u[1][1]-u[0][1]),p=this.dragTouches2,f=p[5][0]-p[4][0]+(p[4][0]-p[3][0])+(p[3][0]-p[2][0])+(p[2][0]-p[1][0])+(p[1][0]-p[0][0]),g=p[5][1]-p[4][1]+(p[4][1]-p[3][1])+(p[3][1]-p[2][1])+(p[2][1]-p[1][1])+(p[1][1]-p[0][1]),m=Math.sqrt(c*c+d*d),v=Math.sqrt(f*f+g*g);if(r="pan",m>5*v||v>5*m){var b,x,w;m>5*v?(b=p[0],x=u[0],w=u[5]):(b=u[0],x=p[0],w=p[5]);var M=[x[0]-b[0],x[1]-b[1]],S=[w[0]-b[0],w[1]-b[1]],A=Math.sqrt(M[0]*M[0]+M[1]*M[1]);M[0]/=A,M[1]/=A,A=Math.sqrt(S[0]*S[0]+S[1]*S[1]),S[0]/=A,S[1]/=A,h=M[0]*S[0]+M[1]*S[1],l=-M[1]*S[0]+M[0]*S[1],s=Math.acos(l)*(180/Math.PI)-90,h>.9999?r="zoom":a=[.5*(c+f),.5*(d+g)]}else if(m>1&&v>1){(h=c/m*(f/v)+d/m*(g/v))<.2?r="zoom":a=[.5*(c+f),.5*(d+g)]}u=this.dragTouches;var C=(p=this.dragTouches2)[0][0]-u[0][0],T=p[0][1]-u[0][1];m=Math.sqrt(C*C+T*T),n=0;for(var P=1;P<6;P++)C=p[P][0]-u[P][0],T=p[P][1]-u[P][1],n+=(v=Math.sqrt(C*C+T*T))-m,m=v}}this.fire("drag",{clientX:i[0],clientY:i[1],pageX:i[0],pageY:i[1],deltaX:i[0]-this.dragLastPos[0],deltaY:i[1]-this.dragLastPos[1],left:this.dragButtons.left,right:this.dragButtons.right,middle:this.dragButtons.middle,zoom:0,touchMode:r,touchPanDelta:a,touchRotateDelta:s,touchDistanceDelta:n,touches:e?o:0}),this.dragLastPos=this.dragCurrentPos,this.dragCurrentPos=[i[0],i[1]],this.dragAbsMoved[0]+=Math.abs(i[0]-this.dragLastPos[0]),this.dragAbsMoved[1]+=Math.abs(i[1]-this.dragLastPos[1])},x.prototype.onDragEnd=function(e,t){var i=this.dragButtons.left,r=this.dragButtons.right,s=this.dragButtons.middle;if(this.updateDragButtonsState(t,!1),this.dragTouches=[],this.dragTouches2=[],this.dragTouches.push(t.getTouchCoords(0)),this.dragTouches2.push(t.getTouchCoords(1)),e&&(this.resetPos=!0,this.firstDragDistance=0,this.lastDragDistance=0,this.zoomDrag=!1),this.dragging){var a=t.getMouseCoords();this.dragLastPos=a,this.dragButtons.left||this.dragButtons.right||this.dragButtons.middle||(this.dragging=!1,a=this.dragCurrentPos,this.off("mousemove",this.dragMoveCall,document),this.off("mouseup",this.dragEndCall,document),this.off("touchmove",this.dragMoveCallTouch,document),this.off("touchend",this.dragEndCallTouch,document),y.enableTextSelection(),y.enableImageDrag(),y.preventDefault(t),this.fire("dragend",{clientX:a[0],clientY:a[1],pageX:a[0],pageY:a[1],left:i,right:r,middle:s}))}},x.prototype.updateDragButtonsState=function(e,t){switch(e.getTouchesCount()){case-1:this.dragButtons[e.getMouseButton()]=t;break;case 0:this.dragButtons={left:!1,right:!1,middle:!1};break;case 1:this.dragButtons={left:!0,right:!1,middle:!1};break;case 2:this.dragButtons={left:!1,right:!0,middle:!1};break;case 3:this.dragButtons={left:!1,right:!1,middle:!0}}};var w=x,M=function(e,t,i,r,s){this.ui=e,this.html=t,this.elementsById=[],this.visible=null==i||i,this.element=document.createElement("div"),this.setVisible(this.visible),this.visibleLock=!!r,this.setVisibleLock(this.visibleLock),this.setHtml(t),s?s.appendChild(this.element):this.ui.element.appendChild(this.element)};M.prototype.setHtml=function(e){this.element.innerHTML=e;for(var t=this.element.getElementsByTagName("*"),i=0,r=t.length;i<r;i++){var s=t[i].getAttribute("id");null!==s&&(this.elementsById[s]=new w(this,t[i]))}},M.prototype.getElement=function(e){return this.elementsById[e]},M.prototype.setVisible=function(e){this.visibleLock||(this.element.style.display=e?"block":"none",this.visible=e)},M.prototype.getVisible=function(){return this.visible},M.prototype.setVisibleLock=function(e){this.visibleLock=e},M.prototype.getVisibleLock=function(){return this.visibleLock};var S=M,A=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("map",'<div id="vts-map" class="vts-map"> </div>',t,i),this.getMapElement().setDraggableState(!0)};A.prototype.getMapElement=function(){return this.control.getElement("vts-map")};var C=A,T=m,P=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("compass",'<div id="vts-compass"><div id="vts-compass-frame"><img id="vts-compass-compass" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGMAAABjCAYAAACPO76VAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODRDNjZFNDJCQjNCMTFFM0IyN0ZCQTZFQTAwNzEzNDUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODRDNjZFNDNCQjNCMTFFM0IyN0ZCQTZFQTAwNzEzNDUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4NEM2NkU0MEJCM0IxMUUzQjI3RkJBNkVBMDA3MTM0NSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4NEM2NkU0MUJCM0IxMUUzQjI3RkJBNkVBMDA3MTM0NSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pgg3VBcAAAzUSURBVHja7F1bbBTXGf7tNdiAbTAXYxscMJe04GDLwVwKNDgNhaogRB+4qKgtzUMrISEhIXjiLsT9gQd4oQ8lPFRtEdACoWCCuASRBCelJBASEnM1xsbgGwYbg03PN/4PHI93vTO7s7tnxv6kX7Pe9Y7H/zf/5fxnzn/iXr16Rd3QA3HdZHST0Q2XktFTSLKQNCGpQlKEJLL4WFqFvGRp5uMTIfVCaoQ08PvdZNgEFJ8uZIiQQQ6fu0rIfSEPmaBuMvygv5CRQrJN78cLyeLPQc4AIX2ZsB5Cegn5qZBqIff47oc8F1In5DErH5+XswWpwHdK+fMuTQYUOUrIaJPy3xLyEyYnV0iGQ3+vQsg1Vv73Qu6ayPlByI9CGrsSGf34bs5SCMgRksfKL4jSdVxmcr4WckshBhb0nZBaL5ORysrO5J+ThExmmRBjD3FJyBdCPhfSxO89YLLqvUQGsp18IcP5Z2RD04X8jC1EJ8AiPhNyjrMx4LaQK0Ja3E7GGBaZon4gZCbHBZ2BeHJKyCdKSnydxXVk+Nj1ZHFMeEfIbCGFLhuHfSnkYyFXOaYgnpREykoiQQbSz2lMCFLS+WwNbkaxkAOcAoOIC5w2a03GOCVVRXa0UMO4EE48+QdnXzIV/kZXMibwoA0WMU/Ib8mb+JuQf7GF3GO3pQ0Z8ZwZDeZMaYmQIvI2zgrZxxlXJWdgrbEmA0T8nOMEyPijBmOGaAEW8VcmA/Hj03AJCYeMOA7UKOYNFfJ7IeOpa+ErIfuFlFFbERKB/VU4d3aomMhEoID3oVUijhw5QqWlpV4hYzz/77LCPDFcNxMK3uULQJ3pdzzCtoSmpiaqqanxknXksw7SWCfvRpOMd7i0gTL2n63EiKqqKrp+vW3w2qtXL3r27JnX3BV08CfWyXDWUcTJgCW8zenrEqtmWVlZSSUlbRlg7969qbGxkTyIiawTH+soLZJk4Hen8OtfC3nfikuSBMjXHrUMifdZN8Tpvq2bPcEm8yh7j7E6oNu8eTNt3LjRIEMS0LdvXzp27BhdvnyZfD6f8RkIeu+99ygvL88LhEA3mKS6zjr73GkyQICc/kStqaedq+vTp89ry8jNzTVIAl68eEFPnz41iEpOTvaKdfRkHe1WdHfdKTJ8fMJ4/iP5wVJX3OX9+vVrRwaC+KFDhwwrgMAiBg4cSCNGjGj3ux7KsKCrv7DubpCFSm+8xRMDKAIGrb6WlZXRkydt8zJwQy9fvqT4+HhasmQJZWVlUWJiIjU0NNCdO3fo1q1brtEuLLi52dbTPjMV3eU7YRmpnKolKoGpUyQlJb2OD7AAKD09Pd1wTyDFjbh48SJduHCBVq1aZfervxLyLesQcaQ+HDJy+TiDLE4Mwf3gLgLGjh1LR48epefPnxvpbGtrK8XFxdH69euNoxusYefOnXTu3Dk6cOBAKKcoZN19zLr8LFQy4Mjx8EAKn9AS1NR1zpw5rnX6sIZNmzbRw4cPacOGDTRgwIBQTwXdnVd0WhsKGXJSqIhszFmDjOPHj9OlS5deB2vI9OnTKSMjwzXWAIsGpk2bRrNnzw7nlG+xDo+yTgOmuoGqtkkcI3DcSG0PlFkGLEOmrPL1yJEjKS0tzTXWYATM1FTDPYVhFRKojK6ltseA/kMBHpQLZBly6nSyXSJk3IC4KVNSrUFixYoVThBBrEPo8iy1PUX5jZ3UdjR/Nok8DgTn+fPndyDCAfdkxiTW6Wg7MaM/H3MozPq8zsBYaNu2bXTixImO+bxwT2vWrHH6T05knZayjqutWIZ0S3letwZ/RADLly93yj2ZkWfScVDLyGaScruSNUhMnjyZ5s6dG6lLgE7/zTouCUaGrNZhxFjgNWvYsmULPXr0KODvoFi5du3aSF5GAev2Juu6oTMy0k3ZVJewBtU9oXQTYbzNZKQHI2NIZz7Ni9aguqd58+ZF47JGKLq+2RkZeMLB5/Z4YccaouSezHHDR37WK6pkyAkj1KMyuoI1RNk9SWSwjstY583+yEg2jTNchbq6OsMaiouLbX0viu7JPJYrY51X+xtnpJnihmtw+vRpY9xgl4gouycVQ00672AZqXwc4CZr2Lp1K506dSqk70fZPfmrcqQGIiOFj33dYg1wS9XVoS3hjpF7IpOOUwKRkWSKHdoCAfrgwYMhfz+G7skcn5PUN+P9ZFM9dLcISUSoU7cxdE8SiSaddyDDx8deumdMAOZLMAeBCqsdTJo0KZbuyWwZvmBkaLsGD8Faxohly5YZU7l79uyxTAgIXL16tQ7/yshgZMhVN9U6EgH3JLOmCRMmGKksMGbMGMuEgMDMzExtXbBKxks+3tPdPZmDrxVCVAI1gFwt1BKMDO2aZG3fvr2de/J3d3dGiD8CY4yGYGRIEl7odNWoNZ08edLS3R2IEA3d03N/N75KhiRBm5UsqL5iTGHn7gYhixYt0tU9mS2jKdCgD8+BDtIpgCNOyOqrlbvbXB7R0D1JyFYXdYHIkKseH+ninuR8hJW721weARF4wkPT7OmRSecdyJD9lcrd5J78FQtBHr6jcRpbbtJ5BzKkH6t1i3vyZw34fQ1jhBm1Jp13IEMGcLRfQHPFjFi7p8LCQr+Kdak1SFSwjjtkruY58CoO4tdiQYbqnvDkur/ShYutQeIajy+qzB+YybjPZGCE+EEs3dPSpUtp6NChnVoD5iQQpAcPHkwuwk1F152S8ZCPP8TSPRUUFLQbK5itAfMRKINrUH0NBTdMug5Ihgwot6mt72tBLNzTunXrjLkKKB8kgAzVGhAbYjwfESous247BG9/ZAAoFGazbyuIlXtCCWTHjh1UW1vrBWuQwGLLVgpQjPVHRimT8XU0ru78+fPt3NOsWbNo5cqVdObMGa9Yg4orio4tkSHLIVikjU7IEVujgRVDCMrSPU2dOpUWLFjgNWuQuMQ6pUAlp0DLyBDA8fDzF5EkA9Omcv0csHv3bi9ag0QJu6iAyVEgMn5kMrAyEwstHX8QGosZ1aVbsu2RbtaARmXoHIeWG3KtonxtA3BLFxXd2iKjkesnaN7yqdNkwD1hVakZOloDGgqADNwsUpBsFBUV0cyZlnsnQ4dNrNNGu2QA3zEZZ4X8ghzsX252T5gMgjVEcMVQyMDa9YULF7Z7D60rHj+23PD5LusQ+L6zX0wIUsx6wK/RoP3DSLgnrCrFKDpCa+hCAtbGo6UGjuh3guQCDWhGjRpldH2Ai0LDGouA7p6wLmtCJUPWUTL5hFgcWOiUe4I1YJ21w8t7HQEGnGhRAaDfCa4bloyH50AGYobFbnJfsu6kLikcMup5xDhcyIlwyZDuSUdrkGUXjPplPywZrMeNG2e8J5MMtc1fEEBnmO++QxY2RbHSc+iKciwOxz2h/oQ7bteuXdoRAeTk5NCwYcOMjA6Bu7y8nPbt22dYR0JCArW0tD3MkZKS0q6IGQDFiu7+Z+XvW+nEhitAWzd0FEOfH5RI8+26JwQ9h/pwOIr6+nqjGRnu9uzsbKMznIobN24Y1w8CJNA5LkiycYV11cq6a3GKDOITysfYDzAxlvsU9ujRI5TGWVHB7du3jZIMXBDiAO5+dI9bvHix0bAMzczMZARBM73Za6OcbOxGY6cXOlwaOovhMXbcFn8gj+Lw4cPGHMmUKVNo7969NGPGDMNiECdAThB8JOQIjytOkI1m9Xb61OGkspMYOoud8SoZaiNktc2fBSLOsG6IQtjGwW7TQOTJshPlPnJwIw+doHaTw9y6xZnEEtZJC+vIdsP3hBCu9SrHi+FskiB0vNcso6KiwniNJxQt4CvWRQMPBa6G8ncTQrze/9KbRTX7+Tz5XiEDHeMsuCQ1c9rPI+xK1k1og80wNjOBRWAzk4HUvZkJaiOYqrxAYewu4+Q2P5mcYXWlbX4+YouI+TY/KiFdbQOsc0xEHWm0AZYKuTUc4sdvhCzyKBF/x1CE2hYXabc1nIruTRM1IoOo43aiC4T80uVE4DHGf5LLthOVMG+0C4vBXLobN9o9zhbgyo12VahbUKMrwAwWN2xB/QmLXH/n2i2ozVZi3py9iFNi3drvlXKKepY8uDm7CixBzeXxCIAhLjbUmqjB2ASuBw+Z4XEaOYWH8QOmSuujdRHRJON1tYEzrExlnJLD1jOWotfCFQ8hf8t3/S1lnPCAM6eo7+wYCzIkUNsaRe3btsZzPAFZI9iSnFq0U8F3+k1W9l3TQA2pKh4wi9nS61iSoaI/x49sP6N7uQvaEE6bMeOYzAlBmpIM3OW7GQG3gUfHSD/v05tZN/Mo+R6T81gHJehChopkLq2AhEEOn7uKSakkP+sjuskIjp5MUBonASkc/HtypibbBLWwNHMQfsLBt4YV36z7P+oGMroMusnQCP8XYACgtQtbAKLiKwAAAABJRU5ErkJggg=="></div><div id="vts-compass-frame2"><img id="vts-compass-compass2" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGMAAABjCAYAAACPO76VAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABG9JREFUeNrtnM9LFGEcxkeEPCQVmbkh7EXoEgW6noIQzQwKoQ5Lkgh7SA8iddlCQfAQFApdghAxooJCsEMe9JAEek8i81YQCIEYQvgHZM9L37Fpmpl9Z3d+rs8DDw7unuaz3+ddX+d9DIOiKIqiKIqiKIqiKIqiKIqiKIqiKMpTQ0NDyqNwTq7/MRUNAKsfwL2EER+MLHxBru/BA4QR3zR0wY/lWmmEMKKHcVh+tsEv5PoGPE4Y0cP4LD9b4AW57oC/whvwB3gZfgN3886FG1EmjAZ41WEa6uAm+DTcyLsXPAz11fWkDUYtvAVPwHfgAnwdbmVMhQtjDj4jN3gNPiTXF+E8fAsuwvfhQScIuVwuMusK762H69IGYwY+LwDew+3wcZkOQ2fhThoMvK8TnkrjZEzCV+RGF2XhXoE/wuvwJ7jGK5aSAkOm4Qm8DTemEcYYfNNtCnTWiCTAkGn4Bu/B+bSuGcPwF3gJfg1Pww/l661uLMQGwzINe+L5tH+1PSpbIOdkG0TtRWWSDsM2Dco/UhlPQSpqGA7TsJfqeEorDLjHNg3pj6cUwjgCzzpAYDxFDENNw6YLCOU+Uggfhtc0mH5LAuHDKDUNyjtwhgTCg6EzDab7effDg6EzDYynkGH4mQbGU4gw/EwD4ykkGMfgZz4hMJ5CgHEV/l4GCMZTgDDUNDwvAwLjKeD1odxp2I8nP/92JQx3P6oAwn48EUYw64N5U3+VG09+H0ggDOc1woymn/Bl2WH1A2KhnKdDCON/WxfrgvzurA8gCmAzYVQOwxpPi7bXdIEUyn1uijDc46nZ4T2lgCxW8hAbYfz1U69PtwYQN4AE4BNGT6lPtwaQQqWPdxLGn93XzVKfbgff1QVI6cOY1Ywnt+2RkgApPRh+48m+PaJA9Ab1FPpBhuEnnpw2Cxd1I40qDUM3npymoRDG+YyDCsMaT0thTANh6MGwxtMunA1jGghDD4Y1ngY1pkH9T+JUFMfIDhoMazy9g2s8pmHHug1OGMHCcIunBvilwzRkoj5geZBgOMXTNXgrjGkgDHcYl2zxdAJ+FeY0EIYziHrLQRUVT7ejmAbCcIZhPbq1G9U06MIo97RuGkF0ejy50Z9LwDlwuekZOSB6QQ6MZuUAaVXGU+TT4BNGixydnpaj1EtytHq4GuPJPEPXF/HBSkcYOmUCUjowVo3xNK8OM8YBwgNGjdRqrEvNxorUbhTldVXHMVlN8aSmIR8XBDsMjymolSKadimmMaSoZqZa4mnePNqbMBiDUr1UlCqmvFQzGVLVtCbXqsJpLu3xtG1vHYgThMMUtEopWUFKyiaktKzWVmamys1G0xxPU04H3RMAo1Fq+Zqkps8OaFVq/aww0vt3hleDWQJgdEth5bIUWG5IoWWHvL5gNgJZYVABy2PRHpfKV0MqYNts1bC8eRHCGJEyZEPKkbvYwRsfjAGpCTdkGyRLAPHB6JUCfU5DAmDkpJ+XN4miKIqiKIqiKIqiKIqiKIqiKIpKpn4DKrVAiBFUfdUAAAAASUVORK5CYII="></div><div id="vts-compass-frame3"><img id="vts-compass-compass3" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGMAAABjCAYAAACPO76VAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABG9JREFUeNrtnM9LFGEcxkeEPCQVmbkh7EXoEgW6noIQzQwKoQ5Lkgh7SA8iddlCQfAQFApdghAxooJCsEMe9JAEek8i81YQCIEYQvgHZM9L37Fpmpl9Z3d+rs8DDw7unuaz3+ddX+d9DIOiKIqiKIqiKIqiKIqiKIqiKIqiKMpTQ0NDyqNwTq7/MRUNAKsfwL2EER+MLHxBru/BA4QR3zR0wY/lWmmEMKKHcVh+tsEv5PoGPE4Y0cP4LD9b4AW57oC/whvwB3gZfgN3886FG1EmjAZ41WEa6uAm+DTcyLsXPAz11fWkDUYtvAVPwHfgAnwdbmVMhQtjDj4jN3gNPiTXF+E8fAsuwvfhQScIuVwuMusK762H69IGYwY+LwDew+3wcZkOQ2fhThoMvK8TnkrjZEzCV+RGF2XhXoE/wuvwJ7jGK5aSAkOm4Qm8DTemEcYYfNNtCnTWiCTAkGn4Bu/B+bSuGcPwF3gJfg1Pww/l661uLMQGwzINe+L5tH+1PSpbIOdkG0TtRWWSDsM2Dco/UhlPQSpqGA7TsJfqeEorDLjHNg3pj6cUwjgCzzpAYDxFDENNw6YLCOU+Uggfhtc0mH5LAuHDKDUNyjtwhgTCg6EzDab7effDg6EzDYynkGH4mQbGU4gw/EwD4ykkGMfgZz4hMJ5CgHEV/l4GCMZTgDDUNDwvAwLjKeD1odxp2I8nP/92JQx3P6oAwn48EUYw64N5U3+VG09+H0ggDOc1woymn/Bl2WH1A2KhnKdDCON/WxfrgvzurA8gCmAzYVQOwxpPi7bXdIEUyn1uijDc46nZ4T2lgCxW8hAbYfz1U69PtwYQN4AE4BNGT6lPtwaQQqWPdxLGn93XzVKfbgff1QVI6cOY1Ywnt+2RkgApPRh+48m+PaJA9Ab1FPpBhuEnnpw2Cxd1I40qDUM3npymoRDG+YyDCsMaT0thTANh6MGwxtMunA1jGghDD4Y1ngY1pkH9T+JUFMfIDhoMazy9g2s8pmHHug1OGMHCcIunBvilwzRkoj5geZBgOMXTNXgrjGkgDHcYl2zxdAJ+FeY0EIYziHrLQRUVT7ejmAbCcIZhPbq1G9U06MIo97RuGkF0ejy50Z9LwDlwuekZOSB6QQ6MZuUAaVXGU+TT4BNGixydnpaj1EtytHq4GuPJPEPXF/HBSkcYOmUCUjowVo3xNK8OM8YBwgNGjdRqrEvNxorUbhTldVXHMVlN8aSmIR8XBDsMjymolSKadimmMaSoZqZa4mnePNqbMBiDUr1UlCqmvFQzGVLVtCbXqsJpLu3xtG1vHYgThMMUtEopWUFKyiaktKzWVmamys1G0xxPU04H3RMAo1Fq+Zqkps8OaFVq/aww0vt3hleDWQJgdEth5bIUWG5IoWWHvL5gNgJZYVABy2PRHpfKV0MqYNts1bC8eRHCGJEyZEPKkbvYwRsfjAGpCTdkGyRLAPHB6JUCfU5DAmDkpJ+XN4miKIqiKIqiKIqiKIqiKIqiKIpKpn4DKrVAiBFUfdUAAAAASUVORK5CYII="></div> </div>',t,i);var r=this.control.getElement("vts-compass");r.setDraggableState(!0),r.on("drag",this.onDrag.bind(this)),r.on("dblclick",this.onDoubleClick.bind(this)),this.image=this.control.getElement("vts-compass-compass"),this.image2=this.control.getElement("vts-compass-compass2"),this.image3=this.control.getElement("vts-compass-compass3"),this.lastStyle=""};P.prototype.update=function(){var e=this.browser.getMap();if(e){var t=e.getPosition().getOrientation(),i="rotateX("+.7*Math.round(t[1]+90)+"deg) rotateZ("+Math.round(-t[0]-45)+"deg)";i!=this.lastStyle&&(this.lastStyle=i,this.image.setStyle(T.TRANSFORM,i),this.image2.setStyle(T.TRANSFORM,i),this.image3.setStyle(T.TRANSFORM,i))}},P.prototype.onDrag=function(e){if(this.browser.getMap()){this.browser.autopilot&&(this.browser.autopilot.setAutorotate(0),this.browser.autopilot.setAutopan(0,0));var t=e.getDragDelta(),i=this.browser.controlMode.getCurrentController();i.orientationDeltas&&i.orientationDeltas.push([.4*t[0],.4*-t[1],0])}},P.prototype.onDoubleClick=function(e){var t=this.browser.getMap();if(t){this.browser.autopilot&&(this.browser.autopilot.setAutorotate(0),this.browser.autopilot.setAutopan(0,0));var i=t.getPosition(),r=i.getOrientation();r[0]=0,r[1]=-90,i.setOrientation(r),t.setPosition(i),"azimuthal2"==this.browser.config.navigationMode&&(this.browser.config.navigationMode="azimuthal"),T.stopPropagation(e)}};var F=P,L=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("credits",'<div id="vts-credits" class="vts-credits"> </div>',t,i),this.lastHTML="",this.lastHTML2="",this.lastHTML3="",this.credits=this.control.getElement("vts-credits")};L.prototype.getCreditsString=function(e,t,i){for(var r,s=this.browser.getMap(),a="",n=e.length,o="",h=!1,l=0;l<n;l++)(r=s.getCreditInfo(e[l])).plain&&(o+=r.plain);if(o&&o.length>30&&n>1&&!i){for(l=0;l<n;l++)if(""!=(r=s.getCreditInfo(e[l])).html.trim()){n=l+1;break}n<e.length?h=!0:n=e.length}for(l=0;l<n;l++)(r=s.getCreditInfo(e[l])).html&&""!=r.html.trim()&&(a+=r.html,l+1<n&&(a+=t));return[a,h]},L.prototype.update=function(){var e=this.browser.getMap();if(e){var t,i="",r="",s="",a=e.getCurrentCredits();if(a.imagery.length>0&&""!=(t=this.getCreditsString(a.imagery,", "))[0]&&(i+='<div class="vts-credits-supercell">',i+='<div class="vts-credits-cell">Imagery: '+t[0]+"</div>",i+=t[1]?'<div class="vts-credits-cell-button" id="vts-credits-imagery-more">and others</div>':"",i+='<div class="vts-credits-separator"></div>',i+="</div>",r='<div class="vts-credits-list">',r+=this.getCreditsString(a.imagery,"<br/>",!0)[0]+"</div>"),a.mapdata.length>0&&""!=(t=this.getCreditsString(a.mapdata,", "))[0]&&(i+='<div class="vts-credits-supercell">',i+='<div class="vts-credits-cell">Map Data: '+t[0]+"</div>",i+=t[1]?'<div class="vts-credits-cell-button" id="vts-credits-mapdata-more">and others</div>':"",i+='<div class="vts-credits-separator"></div>',i+="</div>",s='<div class="vts-credits-list">',s+=this.getCreditsString(a.mapdata,"<br/>",!0)[0]+"</div>"),i+='<div class="vts-credits-supercell">',i+='<div class="vts-credits-cell">Powered by <a class="vts-logo" href="https://www.melown.com/products/vts/" target="blank">VTS 3D Geospatial Software Stack</a></div>',i+='<div class="vts-credits-separator"></div>',i+="</div>",this.lastHTML!=i){this.lastHTML=i,this.credits.setHtml(i);var n=this.control.getElement("vts-credits-imagery-more");n&&n.on("click",this.onMoreButton.bind(this,n,"2")),(n=this.control.getElement("vts-credits-mapdata-more"))&&n.on("click",this.onMoreButton.bind(this,n,"3"))}this.lastHTML2=r,this.lastHTML3=s}},L.prototype.onMoreButton=function(e,t){var i=e.getRect();t="2"==t?this.lastHTML2:this.lastHTML3,this.ui.popup.show({right:Math.max(0,i.fromRight-i.width)+"px",bottom:i.fromBottom+7+"px"},t)};var E=L,k=m,N=function(e,t,i){this.ui=e,this.control=this.ui.addControl("fullscreen",'<img id="vts-fullscreen" class="vts-fullscreen" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAwUlEQVRo3u2YwRWDIBBEIc+SLMKmckpTFkFPePKQQ57DsitR/z/D6KgMDikBAMCTycKYxai9Bul8MYkic+NFS7BOs4FUa/1IrzTn9xk6O6+rrwEMjGayTlS/UXWeujbcDKgpEZRObgYOc1oYt7CIMXCFFLKmTrS+aqAEP8iSAGBYI1s776FLv7eReaWHWd/cyLz3Bas+vxIYGNXIhBTxOhcKNdCaHvPfGPjVYb3OhVjEGLhrI/Pewc9uZDQvAABwZQMKFi+DmFdLbgAAAABJRU5ErkJggg==">',t,i);var r=this.control.getElement("vts-fullscreen");r.on("click",this.onClick.bind(this)),r.on("dblclick",this.onDoNothing.bind(this)),this.enabled=!1};N.prototype.onDoNothing=function(e){k.preventDefault(e),k.stopPropagation(e)},N.prototype.requestFullscreen=function(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},N.prototype.exitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()},N.prototype.fullscreenEnabled=function(){return document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled},N.prototype.onClick=function(){var e=this.ui.element;this.enabled?(this.enabled=!1,this.exitFullscreen()):(this.enabled=!0,this.requestFullscreen(e))};var I=N,B=m,R=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("zoom",'<div id="vts-zoom" class="vts-zoom"><div id="vts-zoom-plus" class="vts-zoom-plus"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAASUlEQVRIx+2Tyw0AIAhDq0d2KsMzFFddQBO9+En6rqR5kFBAiBVINpJtJ1NPLCbJe5IyG7j78IMyEwBgZsNcRJQrl6gnkgjxIx12Cg3wDaLBUAAAAABJRU5ErkJggg=="></div><div id="vts-zoom-minus" class="vts-zoom-minus"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAALUlEQVRIx2NgGAWjYBSMAqoCRlwSdnZ2/8kx8NChQxhmMo2G8ygYBaNgFGAHAElYBARpOBYqAAAAAElFTkSuQmCC"></div> </div>',t,i);var r=this.control.getElement("vts-zoom-plus");r.on("click",this.onZoomIn.bind(this)),r.on("dblclick",this.onDoNothing.bind(this));var s=this.control.getElement("vts-zoom-minus");s.on("click",this.onZoomOut.bind(this)),s.on("dblclick",this.onDoNothing.bind(this))};R.prototype.onDoNothing=function(e){B.preventDefault(e),B.stopPropagation(e)},R.prototype.onZoomIn=function(){this.repeat(7,.96,50)},R.prototype.onZoomOut=function(){this.repeat(7,1.04,50)},R.prototype.repeat=function(e,t,i){if(!(e<=0)&&this.browser.getMap()){this.browser.autopilot&&(this.browser.autopilot.setAutorotate(0),this.browser.autopilot.setAutopan(0,0));var r=this.browser.controlMode.getCurrentController();r.viewExtentDeltas&&r.viewExtentDeltas.push(t),setTimeout(this.repeat.bind(this,--e,t,i),i)}};var z=R,U=m,D=l.a,_=function(e){this.browser=e,this.config=e.config,this.coordsDeltas=[],this.orientationDeltas=[],this.viewExtentDeltas=[],this.northResetAnimation=!1,this.drag=this.drag,this.wheel=this.wheel,this.tick=this.tick,this.reset=this.reset,this.keyup=this.keyup,this.keydown=this.keydown,this.keypress=this.keypress,this.doubleclick=this.doubleclick,this.retinaFactor=1/Math.max(1,(window.devicePixelRatio||1)-1)};function O(e,t){if(!e.config.constrainCamera)return t;var i,r=e.config.minViewExtent,s=e.config.maxViewExtent,a=e.getMap(),n=D.clamp(t.getViewExtent(),r,s);t.setViewExtent(n);var o=.5*n/Math.tan(D.radians(.5*t.getFov()));if("obj"==t.getViewMode()){var h=a.getReferenceFrame(),l=a.getSrsInfo(h.navigationSrs);if(l.a){var u,c=Math.asin(l.a/(o+l.a)),d=Math.tan(D.radians(.5*t.getFov()))/Math.tan(c),p=e.config.tiltConstrainThreshold,f=p[0],g=p[1];u=f>g||f==g?20:20+-110*(d=((d=D.clamp(d,f,g))-f)/(g-f)),(i=t.getOrientation())[1]=D.clamp(i[1],-90,u),t.setOrientation(i)}var m=a.getPositionCameraCoords(t,"float"),v=.5*r/Math.tan(D.radians(.5*t.getFov()));v*=.5;var y=Math.max(v,o*Math.tan(D.radians(3)));if(m[2]<y){i=t.getOrientation();var b=function(e,r,s){var n=.5*(e+r);return s>20?n:(i[1]=n,t.setOrientation(i),a.getPositionCameraCoords(t,"float")[2]<y?b(e,n,s+1):b(n,r,s+1))};i[1]=b(-90,Math.min(20,i[1]),0),t.setOrientation(i)}}return t}_.prototype.drag=function(e){var t=this.browser.getMap();if(t){var i,r=t.getPosition(),s=r.getCoords(),a=e.getDragDelta(),n=e.getDragTouches(),o=this.getAzimuthAndDistance(a[0],a[1]),h=this.config,l=this.browser.controlMode.altKey||this.browser.controlMode.shiftKey||this.browser.controlMode.ctrlKey;if(2==n){if("obj"!=r.getViewMode())return;if("pan"==e.getTouchParameter("touchMode")&&h.rotationAllowed)i=h.sensitivity[1]*this.retinaFactor,this.orientationDeltas.push([a[0]*i,-a[1]*i,0]),this.browser.callListener("map-position-rotated",{});else if("zoom"==e.getTouchParameter("touchMode")&&h.zoomAllowed){a=e.getTouchParameter("touchDistanceDelta");if(Math.abs(a)>=1){var u=1+.01*(a>0?-1:1);this.viewExtentDeltas.push(u),this.reduceFloatingHeight(.8),h.legacyInertia&&this.updateDeltas(!1,!1,!0),this.browser.callListener("map-position-zoomed",{})}}}else if(e.getDragButton("left")&&!l&&h.panAllowed)if("fix"==r.getHeightMode()){var c=t.convertPositionHeightMode(r,"float",!0);null!=c&&(r=c,this.setPosition(r))}else{i=h.sensitivity[0]*this.retinaFactor;var d=r.getFov(),p=d>.01&&d<179?1/Math.tan(D.radians(.5*d)):1,f=D.radians(o[0]),g=[Math.sin(f),Math.cos(f),o[1]*p*i,o[0],s[0],s[1]];this.coordsDeltas.push(g),this.reduceFloatingHeight(.9),h.legacyInertia&&this.updateDeltas(!0),this.browser.callListener("map-position-panned",{})}else(n<=1&&e.getDragButton("right")||e.getDragButton("middle")||l)&&h.rotationAllowed&&(i=h.sensitivity[1]*this.retinaFactor*("obj"!=r.getViewMode()?.5:1),this.orientationDeltas.push([a[0]*i,-a[1]*i,0]),h.legacyInertia&&this.updateDeltas(!1,!0),this.browser.callListener("map-position-rotated",{}))}},_.prototype.wheel=function(e){U.preventDefault(e);var t=this.browser.getMap();if(t&&this.config.zoomAllowed){t.getStats(!0).maxZoom&&(this.browser.config.minViewExtent=.5);var i=t.getPosition(),r=e.getWheelDelta(),s=this.config.sensitivity[2];this.browser.controlMode.shiftKey&&(s*=.1);var a=1+(r>0?-1:1)*s;if(this.browser.controlMode.altKey&&this.browser.controlMode.shiftKey&&this.browser.controlMode.ctrltKey){var n=D.clamp(i.getFov()*a,1,179);i.setFov(n),t.setPosition(i)}else{if("obj"!=i.getViewMode()){var o=i.getCoords(),h=t.getCameraInfo(),l=h.vector,u=h.height,c=Math.max(100,u)*(this.browser.controlMode.shiftKey?25e-5:.0025)*(r>0?1:-1);return(o=t.convertCoordsFromNavToPhys(o,"float"))[0]+=l[0]*c,o[1]+=l[1]*c,o[2]+=l[2]*c,o=t.convertCoordsFromPhysToNav(o,"float"),i.setCoords(o),void t.setPosition(i)}this.viewExtentDeltas.push(a),this.reduceFloatingHeight(.8),this.browser.callListener("map-position-zoomed",{})}}},_.prototype.doubleclick=function(e){U.preventDefault(e);var t=this.browser.getMap();if(t&&this.config.jumpAllowed)if(this.browser.controlMode.altKey&&this.browser.controlMode.shiftKey&&this.browser.controlMode.ctrlKey)this.browser.config.minViewExtent=.5;else{var i=e.getMouseCoords(),r=this.browser.getRenderer().getCanvasSize();if(!(i[0]<0||i[1]<0||i[0]>=r[0]||i[1]>=r[1])){var s=t.getHitCoords(i[0],i[1],"fix");if(s){var a=t.getPosition();a.setCoords(s),(a=t.convertPositionHeightMode(a,"fix")).setHeight(s[2]),this.browser.controlMode.shiftKey?t.setPosition(a):this.browser.autopilot.flyTo(a,{mode:"direct",maxDuration:2e3})}}}},_.prototype.keyup=function(){},_.prototype.keydown=function(){},_.prototype.keypress=function(){},_.prototype.setPosition=function(e){this.config.walkMode||(e=O(this.browser,e)),this.config.fixedHeight&&e.setHeight(this.config.fixedHeight),this.browser.getMap().setPosition(e)},_.prototype.reduceFloatingHeight=function(e){var t=this.browser.getMap().getPosition(),i=t.getCoords();"float"==t.getHeightMode()&&"obj"==t.getViewMode()&&0!=i[2]&&(i[2]*=e,Math.abs(i[2])<.1&&(i[2]=0),t.setCoords(i),this.setPosition(t))},_.prototype.isNavigationSRSProjected=function(){var e=this.browser.getMap(),t=e.getReferenceFrame(),i=e.getSrsInfo(t.navigationSrs);return!!i&&"projected"==i.type},_.prototype.getAzimuthAndDistance=function(e,t){var i=this.browser.getMap().getPosition(),r=i.getViewExtent(),s=.5*i.getFov();this.config.walkMode&&(r+=5);var a=.5*r*Math.tan(D.radians(s))/800;e*=a,t*=a;var n=Math.sqrt(e*e+t*t);return[-D.degrees(Math.atan2(e,t))+i.getOrientation()[0],n]},_.prototype.updateDeltas=function(e,t,i){var r=this.browser.getMap();if(r){var s,a,n,o,h,l=r.getPosition(),u=!1,c=this.config.inertia,d=(r.getStats(),1),p=1;if(this.config.timeNormalizedInertia){var f=1e3/(r.getStats().frameTime+1e-6);f<1&&(f=60),p=1/(d=f/60)}if(!t&&!i&&this.coordsDeltas.length>0){a=this.coordsDeltas;var g=[0,0],m=l.getCoords();for(h=e?a.length-1:0;h<a.length;h++)n=(s=a[h])[3],n=D.radians(n),g[0]+=Math.sin(n)*(s[2]*p),g[1]+=Math.cos(n)*(s[2]*p),s[2]*=c[0]*d,s[2]<.01&&(a.splice(h,1),h--);var v=Math.sqrt(g[0]*g[0]+g[1]*g[1]);for(n=D.degrees(Math.atan2(g[0],g[1])),this.isNavigationSRSProjected()||!this.northResetAnimation&&"azimuthal"==this.config.navigationMode&&(Math.abs(m[1])>75||Math.abs(l.getOrientation()[0])>1)&&(this.config.navigationMode="azimuthal2"),o=l.getOrientation()[0],o=(l=r.movePositionCoordsTo(l,(this.isNavigationSRSProjected()?-1:1)*n,v,"free"!=this.config.navigationMode&&"azimuthal2"!=this.config.navigationMode?0:1)).getOrientation()[0]-o,h=0;h<a.length;h++)(s=a[h])[3]+=o;u=!0}if(!e&&!i&&this.orientationDeltas.length>0){a=this.orientationDeltas;var y=l.getOrientation();for(h=t?a.length-1:0;h<a.length;h++)s=a[h],y[0]+=s[0]*p,y[1]+=s[1]*p,y[2]+=s[2]*p,s[0]*=c[1]*d,s[1]*=c[1]*d,s[2]*=c[1]*d,s[0]*s[0]+s[1]*s[1]+s[2]*s[2]<.1&&(a.splice(h,1),h--);l.setOrientation(y),u=!0}if(!t&&!e&&this.viewExtentDeltas.length>0){a=this.viewExtentDeltas;var b=l.getViewExtent();for(h=i?a.length-1:0;h<a.length;h++)b*=Math.pow(a[h],p),a[h]+=(1-a[h])*(1-c[2]*d),Math.abs(1-a[h])<.001&&(a.splice(h,1),h--);b=Math.max(1,b),l.setViewExtent(b),u=!0}u&&this.setPosition(l)}},_.prototype.tick=function(){this.updateDeltas()},_.prototype.reset=function(){this.coordsDeltas=[],this.orientationDeltas=[],this.viewExtentDeltas=[]};var G=m,V=O,j=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("space",'<div id="vts-space" class="vts-space"><img id="vts-space-2d" class="vts-space-button" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAABqElEQVRIx+2UsWoUURSGv3Nn1sIiaKMBSbD0AdRBdmbdB7DMA0gaSSVRbFRYiGAaUWJhEAQVEey10yacO/gAwqZNSKWwhShs4ew9NtewTDI6sRCE/at7h8P/nfnvuRdmmum/lkxvut1u5pwbAOfNrAMMzWy9LMt3v2qKorCaRwC+A9vApqq+bITkeX4Z+CAiab3IzJa9988bIPXaR977G9Pf3NT6joikZvYmSZL5JElOAPcBRORu3UxVRVVlNBodCyEsmtkAMBFZjQ3va79rETluZl+rqrrpvf8c41t3zt0GFpo6Hw6HP4A9YK0oinlgRUSuAVsHIKqaH8hSJIsR7LQ54KqqNtI0XTGzS01xURuCBeBZhD1pAzGz3Vh/+o+QXq93zjnnReSsmb1W1Y0jTm3yW0ie5xdDCB5YNLMX4/H4KmAtzc/EP/py6MHH8bwAvAfmgDXv/eAo7Xc6nSsxro+HQrIsO2Vmb0VkDrilqg9aert+v39yMpksAfciZLPpMj4UkdUmJ1WVNpcReKyq15viWvrLp8mAb8CnEMLTsixfzV7rmf6dfgKmzKAWE7bqxgAAAABJRU5ErkJggg=="><img id="vts-space-3d" class="vts-space-button" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAB8klEQVRIx+1Uv4sTQRT+3mRygyDInYXFabaxsRNOIiG7mEPQxsJCLQVF8AeiaCNWigrWiniCVfA/0Eo4ONnZ4P4FURAL9yyCEMQfRMzs7LOZk2HZxNgIQr7qzbw373t838wAc8zxX4P8RbvdPimEuMLM+4loAcAmM3eTJLkHgAEgiiIu9SgAfAfwBsCa1rpbJqltBWEYXhBCdAE0HEENwBIRrQZBQFmWvQKAIAhuVwyqAOwGcLzRaOzIsuylXyB+VxKdc+FTY8yyMWZbURSn3N7l8nRaa9Ja03A4XCiKosHMtwAwEV0Lw/BQJYnW+oAxZu9oNLqUpulASrmdiPa49GCS3v1+3/R6vc0kSe4AeOIGPu/XSH+Rpul7J906ER0GAGYeADgzi8F5nj+QUl5k5tZEEk+6fV6sfO+mgZk/uDO7KuUqYcUYswTgGYBFAPf/8tbW/kiitR6kafqZma+7CVdmbL7s6j9VyhVF0QtmbuV5fnDLm/F4rJRSICKehaFerx9zcr2uJGHmn0S0U0r5uNlsnlVKWQCPXG5jSm/R6XQWrbUnANx1JGuTjL/JzEeJ6IhS6qNH/kUIcaPc2X/51lo/9TCO441KT5IkeWetXQWwDuAHgG/M/BxAK47jt9MuFYCvAHpFUZzWWl+d/9Zz/Dv8ApJPyD0fWCwOAAAAAElFTkSuQmCC"> </div>',t,i),this.button2D=this.control.getElement("vts-space-2d"),this.button2D.on("click",this.onSwitch.bind(this)),this.button2D.on("dblclick",this.onDoNothing.bind(this)),this.button3D=this.control.getElement("vts-space-3d"),this.button3D.on("click",this.onSwitch.bind(this)),this.button3D.on("dblclick",this.onDoNothing.bind(this)),this.space3D=!0,this.display3D=this.space3D,this.space3D?(this.button2D.setStyle("display","block"),this.button3D.setStyle("display","none")):(this.button2D.setStyle("display","none"),this.button3D.setStyle("display","block"))};j.prototype.onDoNothing=function(e){G.stopPropagation(e)},j.prototype.onSwitch=function(){this.space3D=!this.space3D;var e=this.browser.getMap();if(e){this.browser.autopilot&&(this.browser.autopilot.setAutorotate(0),this.browser.autopilot.setAutopan(0,0));var t=e.getPosition(),i=t.getOrientation();this.space3D?(i[0]=45,i[1]=-60,t.setOrientation(i)):(i[0]=0,i[1]=-90,t.setOrientation(i)),t=V(this.browser,t),e.setPosition(t),this.update()}},j.prototype.update=function(){var e=this.browser.getMap();if(e){var t=e.getPosition().getOrientation(),i=Math.abs(t[1]+90)>.1;i!=this.display3D&&(i?(this.button2D.setStyle("display","block"),this.button3D.setStyle("display","none")):(this.button2D.setStyle("display","none"),this.button3D.setStyle("display","block")),this.space3D=i,this.display3D=i)}};var H=j,W=l.a;function q(e,t,i,r){var s=W.radians(t),a=W.radians(r),n=W.radians(r-t),o=W.radians(i-e),h=Math.sin(n/2)*Math.sin(n/2)+Math.cos(s)*Math.cos(a)*Math.sin(o/2)*Math.sin(o/2);return 6371e3*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))}var Z=m,Y=o.d,J=l.a,K=h.a,Q=function(e,t,i){var r,s,a,n,o,h,l,u,c,d=[],p=i&&t,f=e;f.length>1&&(f=function(e){for(var t,i=[],r=[],s=function(e){for(var t=0;t<e.length;t++)switch(e[t].type){case"hamlet":case"village":case"town":case"city":return e[t]}return e[0]},a=0;a<e.length-1;a++)(t=e[a]).display_name===e[a+1].display_name?r.push(t):r.length>0?(r.push(t),i.push(s(r)),r.length=0):i.push(t);return r.length&&i.push(s(r)),i}(f));for(var g=0;g<f.length;g++)l=(s=f[g]).boundingbox,a=s.address,h=s.display_name.replace(/,.*/,""),n=a.state&&a.state||a.state_district&&a.state_district||a.county&&a.county||"",(o=a.county&&a.county||a.state_district&&a.state_district||n)===h&&(o=a.state_district&&a.state_district||n),r&&(u=r,+(c=s).lat>+u.lat-.1&&+c.lat<+u.lat+.1&&+c.lon>+u.lon-.1&&+c.lon<+u.lon+.1)||s.importance<.01&&g>5||(new RegExp(/ - /).test(n)&&(n=n.replace(/ -.*/,"")),"archipelago"===s.type||"administrative"===s.type&&(h===a.country||h===n)?"-180"===l[2]&&(l[2]=l[3]=s.lon):l=null,h===a.house_number&&a.road&&(h=a.road),r={lat:+s.lat,lon:+s.lon,title:h,rank:s.importance,country:"us"===a.country_code?n:a.country&&a.country.replace(/,.*/,""),display:s.display_name,region:o||"",state:n||"",cc:a.country_code,type:s.type,bounds:l,polygon:s.polygonpoints||[],bbox:s.boundingbox},p&&(r.distance=q(t,i,r.lon,r.lat)),d.push(r));return p&&function(e){var t,i;do{i=!0;for(var r=0;r<e.length-1;r++){var s=e[r],a=e[r+1];s.rank<.4&&a.rank<.4&&Math.abs(s.rank-a.rank)<.06&&s.distance>a.distance&&(s.note="reshaked-down",a.note="reshaked-up",t=s,e[r]=a,e[r+1]=t,i=!1)}}while(!i)}(d),d},X=function(e,t,i){for(var r,s,a=[],n=e,o=i&&t,h=0;h<n.length;h++)r={lat:+(s=n[h]).lat,lon:+s.lon,title:s.title,rank:1,country:s.country,region:s.region,state:s.state,cc:"",type:"",bounds:null,polygon:[],bbox:null},o&&(r.distance=q(t,i,r.lon,r.lat)),a.push(r);return a},$=function(e,t,i){this.ui=e,this.browser=e.browser;var r=this.browser.config.controlSearchElement;r&&"string"==typeof r&&(r=document.getElementById(r)),this.control=this.ui.addControl("search",'<div class="vts-search"><div class="vts-search-input"><input type="text" id="vts-search-input" autocomplete="off" spellcheck="false" placeholder="Search location..."></div><div id="vts-search-list" class="vts-search-list"></div></div>',t,i,r),this.input=this.control.getElement("vts-search-input"),this.input.on("input",this.onChange.bind(this)),this.input.on("keydown",this.onKeyUp.bind(this)),this.input.on("focus",this.onFocus.bind(this)),this.input.on("mousedown",this.onDrag2.bind(this)),this.input.on("mousewheel",this.onDrag.bind(this)),this.input.on("dblclick",this.onDoNothing.bind(this)),this.list=this.control.getElement("vts-search-list"),this.list.on("mousedown",this.onDrag2.bind(this)),this.list.on("mousewheel",this.onDrag.bind(this)),this.mapControl=this.ui.getMapControl(),this.mapElement=this.mapControl.getMapElement(),this.mapElement.on("mousedown",this.onDrag.bind(this),window),this.mapElement.on("mousewheel",this.onDrag.bind(this),window),this.ignoreDrag=!1,this.urlTemplate="//cdn.melown.com/vtsapi/geocode/v3.0/{lat}/{long}/{value}",this.urlTemplate2=this.urlTemplate,this.data=[],this.lastSearch="",this.itemIndex=-1,this.searchCounter=0,this.coordsSrs="+proj=longlat +datum=WGS84 +nodefs",this.initialValueUsed=!1,this.browser.config.controlSearchValue&&(this.initialValueUsed=!0,this.input.getElement().value=this.browser.config.controlSearchValue,this.onChange())};$.prototype.onDoNothing=function(e){Z.preventDefault(e),Z.stopPropagation(e)},$.prototype.processTemplate=function(e,t){return e.replace(/\{([$a-zA-Z0-9][$a-zA-Z0-9]*)\}/g,(function(e,i){return i in t?t[i]:e}))},$.prototype.showList=function(){this.list.setStyle("display","block")},$.prototype.hideList=function(){this.list.setStyle("display","none")},$.prototype.moveSelector=function(e){this.itemIndex+=e,this.itemIndex>=this.data.length&&(this.itemIndex=this.data.length-1),this.itemIndex<0&&(this.itemIndex=0),this.updateList(this.data)},$.prototype.updateList=function(e){if(Array.isArray(e)){var t,i=e,r="";i=i.slice(0,10),this.data=i;for(var s=0,a=i.length;s<a;s++){t=i[s];var n="";this.coords&&0==s&&(n="location: "),n+=t.title+"<small>",t.region&&t.title!=t.region&&(n+=", "+t.region),t.country&&t.title!=t.country&&t.region!=t.country&&(n+=(t.region?", ":"")+t.country),n+="</small>",this.itemIndex==s?r+='<div id="vts-search-item'+s+'" class="vts-search-listitem-selected">'+n+"</div>":r+='<div id="vts-search-item'+s+'" class="vts-search-listitem">'+n+"</div>"}for(this.list.setHtml(r),s=0,a=i.length;s<a;s++){var o="vts-search-item"+s;(t=this.control.getElement(o))&&(t.on("click",this.onSelectItem.bind(this,s)),t.on("mouseenter",this.onHoverItem.bind(this,s)))}this.initialValueUsed||this.showList()}else this.hideList()},$.prototype.solveSRS=function(e){return-1==e.indexOf("+proj=")&&(e=(e=map.getSrsInfo(e))&&e.srsDef?e.srsDef:this.coordsSrs),e},$.prototype.onSelectItem=function(e){var t=this.browser.getMap();if(t){var i=t.getPosition(),r=t.getReferenceFrame(),s=r.navigationSrs,a=t.getSrsInfo(s),n=r.physicalSrs,o=t.getSrsInfo(n),h=this.browser.getProj4(),l=this.browser.config.controlSearchSrs||this.coordsSrs;l=this.solveSRS(l);var u=h(a.srsDef,l,i.getCoords());i=t.convertPositionHeightMode(i,"float",!0);var c=this.data[e];if(c){u=[c.lon,c.lat];(u=h(l,a.srsDef,u))[2]=0,i.setCoords(u);var d=6667;if(c.bbox){var p=parseFloat(c.bbox[0]),f=parseFloat(c.bbox[1]),g=parseFloat(c.bbox[2]),m=parseFloat(c.bbox[3]);c.polygon=[[g,p],[.5*(m+g),p],[m,p],[g,.5*(f+p)],[m,.5*(f+p)],[g,f],[.5*(m+g),f],[m,f]]}if(c.polygon&&"continent"!=c.type){var v=c.polygon,y=h(l,o.srsDef,u),b=[-y[0],-y[1],-y[2]];Y.normalize(b);for(var x=0,w=v.length;x<w;x++){var M=b,S=[(u=h(l,o.srsDef,[v[x][0],v[x][1],0]))[0]-y[0],u[1]-y[1],u[2]-y[2]],A=[y[0]+b[0],y[1]+b[1],y[2]+b[2]],C=[u[0]-A[0],u[1]-A[1],u[2]-A[2]];Y.cross(M,S,[0,0,0]);var T=Y.length(C)/Y.length(M)*2;T>d&&(d=T)}"projected"!=a.type&&d>1.4*a.a&&(d=1.4*a.a)}else switch(c.type){case"peak":d=2e4;break;case"city":d=3e4;break;case"street":d=4e3;break;case"residential":d=3e3;break;case"continent":d=855e4;break;case"pos":d=15e4}i.setViewExtent(d);var P=[0,-60,0];if("obj"==i.getViewMode()&&a.a){var F=.5*i.getViewExtent()/Math.tan(J.radians(.5*i.getFov())),L=20+-110*Math.min(F/(.5*a.a),1);P[1]>L&&(P[1]=L),P[1]<-90&&(P[1]=-90)}i.setOrientation(P),t.setPosition(i),this.itemIndex=e,this.lastSearch=c.title;var E=this.input.getElement();E.value=this.lastSearch,E.blur()}this.hideList()}},$.prototype.onHoverItem=function(e){this.itemIndex!=e&&(this.itemIndex=e,this.updateList(this.data))},$.prototype.onListLoaded=function(e,t){var i=this.browser.getMap();if(i&&this.searchCounter==e){var r=i.getPosition(),s=i.getReferenceFrame().navigationSrs,a=i.getSrsInfo(s),n=this.browser.getProj4(),o=this.browser.config.controlSearchSrs||this.coordsSrs;o=this.solveSRS(o);var h=n(a.srsDef,o,r.getCoords());if(!(t.data&&Array.isArray(t.data)&&t.header&&"search"==t.header.type))return;t=this.browser.config.controlSearchFilter?Q(t.data,h[0],h[1]):X(t.data,h[0],h[1]),this.coords&&t.unshift({title:this.coords[0].toFixed(6)+" "+this.coords[1].toFixed(6),lat:this.coords[0],lon:this.coords[1],type:"pos"}),this.updateList(t)}},$.prototype.onListLoadError=function(){},$.prototype.onFocus=function(){this.lastSearch="",this.input.getElement().value=this.lastSearch,this.hideList()},$.prototype.onKeyPress=function(e){this.onKeyUp(e)},$.prototype.onKeyUp=function(e){switch(e.getKeyCode()){case 38:this.moveSelector(-1),Z.preventDefault(e),Z.stopPropagation(e);break;case 40:this.moveSelector(1),Z.preventDefault(e),Z.stopPropagation(e);break;case 9:case 13:this.onSelectItem(Math.max(0,this.itemIndex),null)}},$.prototype.parseLatLon=function(e){if(e.replace(/\d+/,"")==e)return null;var t,i,r,s,a,n,o,h=(e=(e=e.replace(","," ")).replace(/  +/g," ").trim().toLowerCase()).split(" ");if(2==h.length&&-1==e.indexOf("n")&&-1==e.indexOf("s")&&-1==e.indexOf("w")&&-1==e.indexOf("e"))return s=h[0].charAt(h[0].length-1),a=h[1].charAt(h[1].length-1),!1,"°"!=s&&"'"!=s&&'"'!=s||"°"!=a&&"'"!=a&&'"'!=a||(h[0]=h[0]+"n",h[1]=h[1]+"e",e=h.join()),isNaN(h[0])||isNaN(h[1])||(t=parseFloat(h[0]),i=parseFloat(h[1]),isNaN(t)||isNaN(i))||t>90||t<-90||i>360||i<-360?null:[t,i];var l=e.split(/[°'"]+/).join(" ").split(/[^\w\S]+/);t=0,i=0;var u=!1;for(r in l)n=l[r],isNaN(n)?(o=parseFloat(n),u=!0,s=n.charAt(n.length-1),isNaN(o)||(u=!1),u&&1!=n.length||("w"!=s&&"e"!=s||t++,"n"!=s&&"s"!=s||i++)):0;if(1!=t||1!=i)return null;var c=[],d=[],p=0,f=0,g=0;for(r in l)if(isNaN(l[r])){var m=l[r];o=parseFloat(l[r]),isNaN(o)||(p+=o/Math.pow(60,f++),m=l[r].replace(o,""),g++),"s"!=(m=m[0])&&"w"!=m||(p*=-1),c[c.length]=m,d[d.length]=p,p=f=0}else o=parseFloat(l[r]),isNaN(o)||(p+=o/Math.pow(60,f++),g++);if(2!=d.length||g<2||isNaN(d[0])||isNaN(d[1]))return null;if("w"==c[0]||"e"==c[0]){var v=d[0];d[0]=d[1],d[1]=v}return d[0]>90||d[0]<-90||d[1]>360||d[1]<-360?null:d},$.prototype.onChange=function(){var e=this.input.getElement().value;if((e=e.trim())!=this.lastSearch){this.lastSearch=e,""==e&&this.hideList();var t=this.browser.getMap();if(t){var i=t.getPosition(),r=t.getReferenceFrame().navigationSrs,s=t.getSrsInfo(r),a=this.browser.getProj4(),n=this.browser.config.controlSearchSrs||this.coordsSrs;n=this.solveSRS(n);var o=a(s.srsDef,n,i.getCoords());this.coords=this.parseLatLon(e);var h=this.processTemplate(this.browser.config.controlSearchUrl||this.urlTemplate,{value:e,lat:o[1],long:o[0]});this.searchCounter++,this.itemIndex=-1,K.loadJSON(h,this.onListLoaded.bind(this,this.searchCounter),this.onListLoadError.bind(this))}}},$.prototype.onDrag2=function(){this.ignoreDrag=!0},$.prototype.onDrag=function(){if(this.ignoreDrag)this.ignoreDrag=!1;else{var e=this.input.getElement();e.value=this.lastSearch,e.blur(),this.hideList()}},$.prototype.update=function(){this.initialValueUsed&&this.browser.mapLoaded&&(this.initialValueUsed=!1,this.onSelectItem(0))};var ee=$,te=m,ie=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("link",'<div id="vts-link" class="vts-link"><div id="vts-link-button" class="vts-link-button"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAABrUlEQVRIx+2VMWtUQRSFz5nZjVrpD9gNVhpLQbZZ5vWaIoUECayNRSpbo9UiJI1pBRs7DVjYGBC1ntm3yHaiwgYsZP+EmMe7x8K3YJEH+xYLwT3NcGe483HvnJkBVvovxWWSsiy7BeAxgGuSpmY2zPP8/V+DhBAekDysQgPgAMDMbo5Gow9n5bgmgF6vd47kAYBC0t0Y45qkPQAguV+X1wgymUx+ShqUZZmllI4AlEVRPJckkht1ea1FNu/3+1ve+31JV0h+dc49mq+12+0dkpQ0XfpMQgh7JJ9U4SmANf3WZUnXvfevAbQBbMYY3zVu1x+Awsx2YoznzewOgKcke3OApId1AADwCwIGJG90u12f5/nx+vr6Jefc0RyQUjpsfE9CCJsk3wIoyrLcljRttVrznv8AcAEAFgHUtovksNrkXp7nx+Px+ETSbQBfKrN8NrOtRQC17pK0QbJMKb2az5nZd+fc/ZRSBKAm1q+r5ASADyHsVuPAe/+R5JtlnqEzIWY2rGDPsiw7JfmysulB0ypq3TWbzb51Op0JyaskLwL4BGA3xvhi9aes9G/pF4AdwlhUZ8RfAAAAAElFTkSuQmCC"></div><div id="vts-link-text-holder" class="vts-link-text-holder"><div class="vts-link-text"><textarea id="vts-link-text-input" rows="4" cols="50" wrap="hard"></textarea></div></div> </div>',t,i),this.div=this.control.getElement("vts-link");var r=this.control.getElement("vts-link-button");r.on("click",this.onSwitch.bind(this)),r.on("dblclick",this.onDoNothing.bind(this)),this.linkPanel=this.control.getElement("vts-link-text-holder"),this.link=this.control.getElement("vts-link-text-input"),this.linkVisible=!1,this.update()};ie.prototype.onDoNothing=function(e){te.stopPropagation(e)},ie.prototype.onSwitch=function(){this.linkVisible=!this.linkVisible,this.updateLink(),this.update()},ie.prototype.update=function(){var e=10+(this.ui.config.controlZoom?70:0)+(this.ui.config.controlSpace?35:0);this.div.setStyle("left",e+"px"),this.linkPanel.setStyle("display",this.linkVisible?"block":"none")},ie.prototype.updateLink=function(){var e=this.browser.getLinkWithCurrentPos();this.link.getElement().value!=e&&(this.link.getElement().value=e)};var re=ie,se=function(e,t,i){this.ui=e,this.control=this.ui.addControl("github",'<a target="_blank" href="https://github.com/Melown/vts-browser-js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/52760788cde945287fbb584134c4cbc2bc36f904/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png"></a>',t,i)},ae=function(e,t,i){this.ui=e,this.control=this.ui.addControl("layers",'<div class="vts-layers"</div>',t,i)},ne=function(e,t,i){this.ui=e,this.control=this.ui.addControl("fallback",'<div class="vts-fallback"><div class="vts-fallback-text"><p>VTS Browser needs <a href="http://get.webgl.org/">WebGL</a> capable web browser.</p></div> </div>',t,i)},oe=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("popup",'<div class="vts-popup-background" id="vts-popup-background"><div id="vts-popup"</div></div>',t,i),this.lastHTML="",this.popup=this.control.getElement("vts-popup"),this.background=this.control.getElement("vts-popup-background"),this.background.on("click",this.hide.bind(this))};oe.prototype.show=function(e,t){for(var i in this.control.setVisible(!0),e)this.popup.setStyle(i,e[i]);this.popup.setHtml(t)},oe.prototype.hide=function(){this.control.setVisible(!1)};var he=oe,le=function(e,t){this.ui=e,this.control=this.ui.addControl("loading",'<div id="vts-loading" class="vts-loading"><div class="vts-loading-progress"><div id="vts-loading-dot1" class="vts-loading-dot"></div><div id="vts-loading-dot2" class="vts-loading-dot"></div><div id="vts-loading-dot3" class="vts-loading-dot"></div><div id="vts-loading-dot4" class="vts-loading-dot"></div><div id="vts-loading-dot5" class="vts-loading-dot"></div></div> </div>',t),this.loading=this.control.getElement("vts-loading"),this.dots=[this.control.getElement("vts-loading-dot1"),this.control.getElement("vts-loading-dot2"),this.control.getElement("vts-loading-dot3"),this.control.getElement("vts-loading-dot4"),this.control.getElement("vts-loading-dot5")],this.time=Date.now(),this.hiding=null};le.prototype.show=function(){this.hiding=null,this.ui.setControlVisible("compass",!1),this.ui.setControlVisible("zoom",!1),this.ui.setControlVisible("space",!1),this.ui.setControlVisible("search",!1),this.ui.setControlVisible("link",!1),this.ui.setControlVisible("github",!1),this.ui.setControlVisible("measure",!1),this.ui.setControlVisible("measure2",!1),this.ui.setControlVisible("fullscreen",!1),this.ui.setControlVisible("credits",!1),this.ui.setControlVisible("loading",!0),this.time=Date.now()},le.prototype.hide=function(){this.hiding=Date.now();var e=this.ui.config.controlSearch;if(e&&!this.ui.browser.config.controlSearchUrl){var t=this.ui.browser.getMap();if(t){var i=t.getSrsInfo(t.getReferenceFrame().physicalSrs).a;e=i<6428137&&i>6328137}}this.ui.setControlVisible("compass",this.ui.config.controlCompass,!1),this.ui.setControlVisible("zoom",this.ui.config.controlZoom,!1),this.ui.setControlVisible("space",this.ui.config.controlSpace,!1),this.ui.setControlVisible("search",e,!1),this.ui.setControlVisible("link",this.ui.config.controlLink,!1),this.ui.setControlVisible("github",this.ui.config.controlGithub,!1),this.ui.setControlVisible("measure",this.ui.config.controlMeasure,!1),this.ui.setControlVisible("measure2",this.ui.config.controlMeasureLite,!1),this.ui.setControlVisible("fullscreen",this.ui.config.controlFullscreen,!1),this.ui.setControlVisible("credits",this.ui.config.controlCredits,!1),this.ui.setControlVisible("loading",!1)},le.prototype.update=function(){var e,t=Date.now();this.hiding&&(e=.001*(t-this.hiding),this.loading.setStyle("opacity",1-Math.min(1,2*e)+""),e>.5&&this.control.setVisible(!1)),e=.001*(t-this.time);for(var i=0;i<5;i++)this.dots[i].setStyle("opacity",.6*Math.sin(1.5*Math.PI/5*i-e*Math.PI*2)+.2);var r=this.ui.browser.getMap();if(r){var s=r.getStats();(0==s.surfaces&&0==s.freeLayers||t-this.time>7e3||0==s.downloading&&s.lastDownload>0&&t-s.lastDownload>1e3||0!=s.bestMeshTexelSize&&s.bestMeshTexelSize<=3*s.texelSizeFit||("fit"==s.loadMode||"fitonly"==s.loadMode)&&s.drawnTiles-s.drawnGeodataTiles>1)&&(this.hide(),this.ui.browser.callListener("loading-screen-hidden",{}))}};var ue=le,ce=m,de=h.a,pe=o.d,fe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2lpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkNjI1MjFjMi1mYzE5LTcyNDUtOTI5My1kNTU3MmE5N2E1MjgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODJGRUI2NzE2NzkwMTFFN0EzRUZFNzQ1NEFCMkVFQUQiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODJGRUI2NzA2NzkwMTFFN0EzRUZFNzQ1NEFCMkVFQUQiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjRBMjkwN0JENjc4QzExRTc5QTQwRjk4NjQzOEI4RDczIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRBMjkwN0JFNjc4QzExRTc5QTQwRjk4NjQzOEI4RDczIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+k3ySjQAAAdJJREFUeNrclk0oBGEYgHemjZOLm8tSyt9BqT2I1O7JSdSSkpsDxZGLi5MTjn5K4SDh4OfiaPfkIDebOPiPUqKUiLKet96pzzT7MztxMPX0le+b95n3Z2ZZmUwm9NuXHfqLK1smsVhsED5hKkhswc4mYJmHVxgNIvIslyE4hnLYDSqycwiaoCGVSnUFFdk5BH2wKHtBRbYKqlVwbQhGoNU5GETkZHKpggjMqaBFhaGgIltv/mKphRuQss1oZkPuG4oRWTLHlmU5fSlhOYNKSEK7xIUugj+6hmSHpROm2RvL9Q7arqf80IykdDEdgll4IWi/Bm+ECT8Z2R7l+DBKV6N/PoRnEbBuwIKf0nm+8S7RGuzDLaxLMuw/5OuR+bn60ROPt9/pUUQnUEa6A56SyeSWeTYejzs9GkC8ZIpySjxEy1APbdCM6MAlGmeZdIahYIlLVAU9kIA7KZFxrJrA5+bU8RBjBf+eGD26gk0oI4AItiU4dMOqHh+GTylbQT3JU7oj2IMLmNBJrIATKIUoD5L2LfEQJbRPvXAP0iPZj5J92vNl9Fk6mSCZsBV4dwuyflb8XJrRqX6C3iDsFhSdiXOzZlSnwxD2yuBHJv/iX6JvAQYAPSICqA82OnoAAAAASUVORK5CYII=",ge="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo2Nzg3NzczMzY3OEMxMUU3QjU2QUUxNTNCNzc4MzVBQiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo2Nzg3NzczNDY3OEMxMUU3QjU2QUUxNTNCNzc4MzVBQiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjY3ODc3NzMxNjc4QzExRTdCNTZBRTE1M0I3NzgzNUFCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjY3ODc3NzMyNjc4QzExRTdCNTZBRTE1M0I3NzgzNUFCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+owD8TQAAAepJREFUeNrcls8rBGEYx993lIMfxR4kF/+AKMqBg7K1ajelLEWK025tKOTnjVykuAklNgcHuzmQg4MiTtz4Aza3TeGActDr+45nZt41s7tmBwdbn2l35933M9/3eead5UII9tsvjf3FK2uSiGgBKdDtZW6JllXA2DG4A3teRM7LZQl2QRuY9irScghGQRXb5KteRVoOQSMY0895FGkk8JHgSBH0gllzpAeRkeSRBAEwQIIZUJMxukARly3GOZdpivA5DnpAM2iQ5zFx3KE55DIugT6cT+a7PTTlKt9xHAT74AzU6vWJiEVQ4iWR9uXHhkgu3QhYB/JK3zBZE6WoBkE3Ivt9YolOQBd9uwJedQFjC+A8XyJ1J3G+4zNFV+CCmmMejINnY8sQG0wVzZnFlnW2Fd55ezGaIUAtPgzqwAsmv8mYMCLW8DaqdyY1g73w+RMFQRh0glse1RtDHRvDcdJp6XInsScKU3u3gnukSfCoOcoH0YPa3jif/P7zxEqUoPqUkWBZ398YqwdTNHqLdu+YuyTONToEl+AaTIAhUE61qwTtuJC0e4klkssQAn7QTy3+BA5AhRQgfdoovHvJp6iYli5EdTqlBKZA7a7CJFaiHdABUqBUFfyMxBJt06PBrwpskn/xl+hDgAEAH0j0b9rsgVUAAAAASUVORK5CYII=",me=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("measure",'<div id="vts-measure" class="vts-measure"><img id="vts-measure-button" class="vts-measure-button" src="'+fe+'"><img id="vts-measure-button2" class="vts-measure-button" src="'+ge+'"><div id="vts-measure-text-holder" class="vts-measure-text-holder"><div class="vts-measure-text-holder2"><div class="vts-measure-text"><textarea id="vts-measure-text-input" rows="10" cols="67" wrap="hard"></textarea></div><div class="vts-measure-tools"><div id="vts-measure-position" class="vts-measure-tools-button">Position</div><div id="vts-measure-length" class="vts-measure-tools-button">Length</div><div id="vts-measure-track" class="vts-measure-tools-button">Track Length</div><div id="vts-measure-area" class="vts-measure-tools-button">Area</div><div id="vts-measure-volume" class="vts-measure-tools-button">Volume</div><div id="vts-measure-clear" class="vts-measure-tools-button">Clear Log</div><div id="vts-measure-metric" class="vts-measure-tools-button">Units: Meters</div></div></div></div><div id="vts-measure-info" class="vts-measure-info"></div><div id="vts-measure-buttons" class="vts-measure-compute"><div id="vts-measure-undo" class="vts-measure-tools-button">Undo</div><div id="vts-measure-compute" class="vts-measure-tools-button">Compute</div></div> </div>',t,i),this.div=this.control.getElement("vts-measure"),this.buttonOff=this.control.getElement("vts-measure-button"),this.buttonOff.on("click",this.onSwitch.bind(this)),this.buttonOff.on("dblclick",this.onDoNothing.bind(this)),this.buttonOn=this.control.getElement("vts-measure-button2"),this.buttonOn.on("click",this.onSwitch.bind(this)),this.buttonOn.on("dblclick",this.onDoNothing.bind(this)),this.info=this.control.getElement("vts-measure-info"),this.compute=this.control.getElement("vts-measure-buttons");var r=this.control.getElement("vts-measure-undo");r.on("click",this.onCompute.bind(this,0)),r.on("dblclick",this.onDoNothing.bind(this)),(r=this.control.getElement("vts-measure-compute")).on("click",this.onCompute.bind(this,1)),r.on("dblclick",this.onDoNothing.bind(this));var s=this.control.getElement("vts-measure-clear");s.on("click",this.onClear.bind(this)),s.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons=[];var a=this.control.getElement("vts-measure-position");a.on("click",this.onTool.bind(this,0)),a.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons.push(a),(a=this.control.getElement("vts-measure-length")).on("click",this.onTool.bind(this,1)),a.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons.push(a),(a=this.control.getElement("vts-measure-track")).on("click",this.onTool.bind(this,2)),a.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons.push(a),(a=this.control.getElement("vts-measure-area")).on("click",this.onTool.bind(this,3)),a.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons.push(a),(a=this.control.getElement("vts-measure-volume")).on("click",this.onTool.bind(this,4)),a.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons.push(a),(a=this.control.getElement("vts-measure-metric")).on("click",this.onTool.bind(this,5)),a.on("dblclick",this.onDoNothing.bind(this)),this.toolButtons.push(a),this.metricButton=a,this.measuring=!1,this.counter=1,this.renderCounter=1,this.lastCoords=null,this.navCoords=null,this.tool=0,this.metric=!0,this.mapUpdateDestructor=null,this.listPanel=this.control.getElement("vts-measure-text-holder"),this.list=this.control.getElement("vts-measure-text-input"),this.measuring?(this.buttonOn.setStyle("display","block"),this.buttonOff.setStyle("display","none")):(this.buttonOn.setStyle("display","none"),this.buttonOff.setStyle("display","block")),this.onMouseMoveCall=this.onMouseMove.bind(this),this.onMouseLeaveCall=this.onMouseLeave.bind(this),this.onMouseClickCall=this.onMouseClick.bind(this),this.onMapUpdateCall=this.onMapUpdate.bind(this),this.update()};me.prototype.onDoNothing=function(e){ce.stopPropagation(e)},me.prototype.onMouseLeave=function(e){this.info.setStyle("display","none")},me.prototype.onMouseClick=function(e){var t=this.browser.getMap();if(t){var i=this.ui.getMapElement().getDraggingState().absMoved;if(!(i[0]+i[1]>0)){var r=e.getMouseCoords(),s=t.getHitCoords(r[0],r[1],"fix");if(t.redraw(),s){var a,n,o,h,l="  ";for(a=0,n=(""+this.counter).length;a<n;a++)l+=" ";if(0==this.tool?(this.navCoords=s,s=t.convertCoordsFromNavToPublic(s,"fix"),h="------------------------------------------------------\n",h+="#"+this.counter+" Position: ",h+="\n"+l+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2]),this.counter++):1==this.tool?this.navCoords&&2!=this.navCoords.length?(this.navCoords.push(s),h=l+"p2: "+(s=t.convertCoordsFromNavToPublic(s,"fix"))[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2]),h+="\n"+l+"------------------------",o=t.getDistance(this.lastCoords,s,!1,!0),h+="\n"+l+"great-circle distance: "+this.getTextNumber(o[0]),h+="\n"+l+"euclidean distance: "+this.getTextNumber(o[2]),h+="\n"+l+"elevation difference: "+this.getTextNumber(s[2]-this.lastCoords[2]),h+="\n"+l+"azimuth: "+o[1].toFixed(2)+" deg",this.counter++):(this.navCoords=[s],s=t.convertCoordsFromNavToPublic(s,"fix"),h="------------------------------------------------------\n",h+="#"+this.counter+" Length: ",h+="\n"+l+"p1: "+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2])):2==this.tool?(this.renderCounter!=this.counter&&(this.renderCounter=this.counter,this.onTool(2)),this.navCoords?(this.navCoords.push(s),s=t.convertCoordsFromNavToPublic(s,"fix"),h=l+"p"+this.navCoords.length+": "+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2])):(this.navCoords=[s],s=t.convertCoordsFromNavToPublic(s,"fix"),h="------------------------------------------------------\n",h+="#"+this.counter+" Track Length: ",h+="\n"+l+"p1: "+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2]))):3!=this.tool&&4!=this.tool||(this.renderCounter!=this.counter&&(this.renderCounter=this.counter,this.onTool(this.tool)),this.navCoords?(this.navCoords.push(s),s=t.convertCoordsFromNavToPublic(s,"fix"),h=l+"p"+this.navCoords.length+": "+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2])):(this.navCoords=[s],s=t.convertCoordsFromNavToPublic(s,"fix"),h="------------------------------------------------------\n",h+="#"+this.counter+(3==this.tool?" Area: ":" Volume: "),h+="\n"+l+"p1: "+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+this.getTextNumber(s[2]))),this.lastCoords=s,h){var u=this.list.getElement();u.value+=h+"\n",u.scrollTop=u.scrollHeight}}}}},me.prototype.onMouseMove=function(e){var t=this.browser.getMap();if(t){var i=e.getMouseCoords(),r=t.getHitCoords(i[0],i[1],"fix");if(r){var s=(r=t.convertCoordsFromNavToPublic(r,"fix"))[0].toFixed(7)+", "+r[1].toFixed(7)+", "+this.getTextNumber(r[2]);i[0]-=this.divRect.left,i[1]-=this.divRect.top,this.info.setStyle("display","block"),this.info.setStyle("left",i[0]+20+"px"),this.info.setStyle("top",i[1]+10+"px"),this.info.setHtml(s)}else this.info.setStyle("display","none")}},me.prototype.onSwitch=function(){this.measuring=!this.measuring;var e=this.ui.getMapElement();this.measuring?(this.buttonOn.setStyle("display","block"),this.buttonOff.setStyle("display","none"),this.divRect=this.div.getRect(),e.on("mousemove",this.onMouseMoveCall),e.on("mouseleave",this.onMouseLeaveCall),e.on("click",this.onMouseClickCall),this.mapUpdateDestructor=this.browser.on("map-update",this.onMapUpdateCall)):(this.buttonOn.setStyle("display","none"),this.buttonOff.setStyle("display","block"),e.off("mousemove",this.onMouseMoveCall),e.off("mouseleave",this.onMouseLeaveCall),e.off("click",this.onMouseClickCall),this.mapUpdateDestructor&&this.mapUpdateDestructor()),this.onTool(this.tool),this.compute.setStyle("display","none");var t=this.browser.getMap();t&&t.redraw(),this.update()},me.prototype.onTool=function(e){if(5==e)return this.metric=!this.metric,void this.metricButton.setHtml(this.metric?"Units: Meters":"Units: Feets");this.tool=e,this.navCoords=null,this.compute.setStyle("display","none");for(var t=0;t<5;t++)this.toolButtons[t].setClass("vts-measure-tools-button");this.toolButtons[e].setClass("vts-measure-tools-button-selected");var i=this.browser.getMap();i&&i.redraw()},me.prototype.onCompute=function(e){if(this.navCoords){var t=this.browser.getMap();if(t){var i,r,s,a,n=this.list.getElement();if(0==e)this.navCoords.pop();else{if(2==this.tool){var o,h,l,u=0,c=0,d=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY;for(a="  ",r=0,s=(""+this.counter).length;r<s;r++)a+=" ";for(i=a+"------------------------",r=0,s=this.navCoords.length;r<s;r++)(o=t.convertCoordsFromNavToPublic(this.navCoords[r],"fix"))[2]>p&&(p=o[2]),o[2]<d&&(d=o[2]);for(r=0,s=this.navCoords.length-1;r<s;r++)o=t.convertCoordsFromNavToPublic(this.navCoords[r],"fix"),h=t.convertCoordsFromNavToPublic(this.navCoords[r+1],"fix"),u+=(l=t.getDistance(o,h,!1,!0))[0],c+=l[2];i+="\n"+a+"great-circle distance: "+this.getTextNumber(u),i+="\n"+a+"euclidean distance: "+this.getTextNumber(c),i+="\n"+a+"max elevation: "+this.getTextNumber(p),i+="\n"+a+"min elevation: "+this.getTextNumber(d),i+="\n"+a+"elevation difference: "+this.getTextNumber(p-d),this.counter++}if(3==this.tool)console.log(JSON.stringify(this.navCoords)),(b=t.createGeodata()).addPolygon3(this.navCoords,[],null,"fix",{},"tmp-polygon"),b.processHeights("node-by-lod",62,function(){for(a="  ",r=0,s=(""+this.counter).length;r<s;r++)a+=" ";i=a+"------------------------";var e=b.extractGeometry("tmp-polygon").getSurfaceArea();this.metric?(i+="\n"+a+"area: "+e.toFixed(2)+" m²",e>100&&(i+="\n"+a+"      "+(e/100).toFixed(2)+" ares"),e>1e4&&(i+="\n"+a+"      "+(e/1e4).toFixed(2)+" hectares"),e>1e6&&(i+="\n"+a+"      "+(e/1e6).toFixed(2)+" km²")):(i+="\n"+a+"area: "+(e/.83612736).toFixed(2)+" yd²",e/4046.8564224>=1&&(i+="\n"+a+"      "+(e/4046.8564224).toFixed(2)+" acres"),e/2589988.110346>=1&&(i+="\n"+a+"      "+(e/2589988.110346).toFixed(2)+" mi²")),this.counter++}.bind(this));if(4==this.tool){var f=[0,0,0];for(r=0,s=this.navCoords.length;r<s;r++)o=t.convertCoordsFromNavToPhys(this.navCoords[r],"fix"),f[0]+=o[0],f[1]+=o[1],f[2]+=o[2];f[0]/=s,f[1]/=s,f[2]/=s;var g,m,v,y=0;for(r=0,s=this.navCoords.length;r<s;r++)o=t.convertCoordsFromNavToPhys(this.navCoords[r],"fix"),g=f[0]-o[0],m=f[1]-o[1],v=f[2]-o[2],(u=Math.sqrt(g*g+m*m+v*v))>y&&(y=u);var b=t.createGeodata();y>3e4?b.addPolygon3(this.navCoords,[],null,"fix",{},"tmp-polygon"):b.addPolygon(this.navCoords,[],null,"fix",{},"tmp-polygon"),b.processHeights("node-by-lod",62,function(){if(this.navCoords.length){for(a="  ",r=0,s=(""+this.counter).length;r<s;r++)a+=" ";i=a+"------------------------";var e=b.extractGeometry("tmp-polygon"),h=new Array(e.getElements());for(r=0,s=h.length;r<s;r++)h[r]=e.getElement(r);var u,c,d,p=this.browser.getRenderer();o=t.convertCoordsFromPhysToNav(f,"fix");var g=.003*y,m=this.browser.getCore(),v=function(e){if(i=(i=n.value).substr(0,i.lastIndexOf("loading data ...")),i+="computation progress: 0%",e){var r=p.buildOctreeFromGeometry(e),s=t.getNED(o,!1);c=s.direction,d=s.east;var g,v,b,x,w=[0,0,0],M=.04*y,S=0,A=0;M*=M;var C=-25,T=function(){for(u=-25;u<=25;u++)g=.04*u*y,v=.04*C*y,o[0]=1.0001*f[0]+c[0]*v+d[0]*g,o[1]=1.0001*f[1]+c[1]*v+d[1]*g,o[2]=1.0001*f[2]+c[2]*v+d[2]*g,pe.normalize(o,w),w[0]=-w[0],w[1]=-w[1],w[2]=-w[2],(l=this.hitFaces(o,w,h))[0]&&(b=p.raycastOctreeGeometry(r,o,w)).length>0&&((x=(l[1]-b[0])*M)>=0?S+=x:A+=-x);if(C<25)i=i.substr(0,i.lastIndexOf("computation progress:")),i+="computation progress: "+((C+25)/50*100).toFixed(1)+" %";else if(i=i.substr(0,i.lastIndexOf("computation progress:")),this.metric)i+="volume above: "+S.toFixed(2)+" m³",i+="\n"+a+"volume below: "+A.toFixed(2)+" m³",i+="\n"+a+"volume combined: "+(S+A).toFixed(2)+" m³\n";else{var e=.764554857984;i+="volume above: "+(S/e).toFixed(2)+" yd³",i+="\n"+a+"volume below: "+(A/e).toFixed(2)+" yd³",i+="\n"+a+"volume combined: "+((S+A)/e).toFixed(2)+" yd³\n"}i&&(n.value=i,n.scrollTop=n.scrollHeight),C<25&&m.once("tick",T,1),C++}.bind(this);m.once("tick",T,1)}else i+="\n some error ocurred. Try it again."}.bind(this);i+="\n"+a+"loading data ...",n.value+=i,n.scrollTop=n.scrollHeight,i=null;t.getSurfaceAreaGeometry(o,y,"texelSize",g,v,!1)}}.bind(this)),this.counter++}}i&&(n.value+=i+"\n",n.scrollTop=n.scrollHeight),t.redraw()}}},me.prototype.hitFace=function(e,t,i){var r,s,a,n,o,h,l=i[0],u=i[1],c=i[2],d=[0,0,0],p=[u[0]-l[0],u[1]-l[1],u[2]-l[2]],f=[c[0]-l[0],c[1]-l[1],c[2]-l[2]];return pe.cross(t,f,d),(a=pe.dot(p,d))>-1e-7&&a<1e-7?[!1]:(n=1/a,s=[e[0]-l[0],e[1]-l[1],e[2]-l[2]],(o=n*pe.dot(s,d))<0||o>1?[!1]:(r=pe.cross(s,p),(h=n*pe.dot(t,r))<0||o+h>1?[!1]:[!0,n*pe.dot(f,r)]))},me.prototype.hitFaces=function(e,t,i){for(var r=!1,s=Number.POSITIVE_INFINITY,a=0,n=i.length;a<n;a++){var o=this.hitFace(e,t,i[a]);o[0]&&(r=!0,o[1]<s&&(s=o[1]))}return[r,s]},me.prototype.onClear=function(){this.counter=1,this.lastCoords=null,this.navCoords=null;var e=this.list.getElement();e.value="",e.scrollTop=0,this.compute.setStyle("display","none");var t=this.browser.getMap();t&&t.redraw()},me.prototype.update=function(){var e=10+(this.ui.config.controlZoom?70:0)+(this.ui.config.controlSpace?35:0);this.div.setStyle("left",e+"px"),this.listPanel.setStyle("display",this.measuring?"block":"none")},me.prototype.onMapUpdate=function(){var e=this.browser.getMap();if(e){var t=this.browser.getRenderer();if(this.circleImage||(this.circleImage=de.loadImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAAAAAAAD5Q7t/AAAACW9GRnMAAAAgAAAA4ACD+EAUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA/UlEQVRYw+2VPwqDMBTG3dz1Am56EnH2XLroETxGuwc3Z7cOdhY8QJpfSUBspUvStJAPPggvD973/uQligICAgL+DKViqygUV02hbaXLwJlio7gpyhNu2idzEXwwgfI8H+u6vnZdN/V9P3EuimLcCRlsiyArGcfxjWDLsmzyAGzc4aNFNDZ7/iw7AeQH4LNrh5WZYLgkJTaZCyHuVVVdkiSZ0zSdOWMzlaBFWkRrQ4A4Zk/A4wBie1MFYUMAz0wybCYAmR8FUAlzj6+2r18TgM2VAO8tOB1Cyk7mrofQ+zP0voheVjHtIBjDxjrmvCu7k1Xs/TP6ie84ICDAGR5uCYdPo0MWiAAAAABJRU5ErkJggg==",function(){this.circleTexture=t.createTexture({source:this.circleImage})}.bind(this))),this.circleTexture){var i,r,s,a;switch(this.tool){case 0:this.navCoords&&(s=e.convertCoordsFromNavToCanvas(this.navCoords,"fix"))[2]<=1&&t.drawImage({rect:[s[0]-12,s[1]-12,24,24],texture:this.circleTexture,color:[255,0,0,255],depth:s[2],depthTest:!1,blend:!0});break;case 1:case 2:case 3:case 4:if(this.navCoords){for(a=[],i=0,r=this.navCoords.length;i<r;i++)a.push(e.convertCoordsFromNavToCanvas(this.navCoords[i],"fix"));if(r>1){var n,o=[],h=[];for(i=0,r=this.navCoords.length-1;i<r;i++)n=e.getGeodesicLinePoints(this.navCoords[i],this.navCoords[i+1]),o=o.concat(n);for(3!=this.tool&&4!=this.tool||(n=e.getGeodesicLinePoints(this.navCoords[r],this.navCoords[0]),o=o.concat(n)),i=0,r=o.length;i<r;i++)h.push(e.convertCoordsFromNavToPhys(o[i],"fix",null,!0));t.drawLineString({points:h,size:5,color:[0,0,0,255],depthTest:!1,screenSpace:!1,blend:!1}),t.drawLineString({points:h,size:2,color:[255,0,0,255],depthTest:!1,screenSpace:!1,blend:!1})}for(i=0,r=a.length;i<r;i++)(s=a[i])[2]<=1&&t.drawImage({rect:[s[0]-12,s[1]-12,24,24],texture:this.circleTexture,color:[255,0,0,255],depth:s[2],depthTest:!1,blend:!0})}}if((2==this.tool||3==this.tool||4==this.tool)&&a){if(a.length<2||this.renderCounter!=this.counter)return void this.compute.setStyle("display","none");(s=a[a.length-1])[0]-=this.divRect.left,s[1]-=this.divRect.top,this.compute.setStyle("display","block"),this.compute.setStyle("left",s[0]+20+"px"),this.compute.setStyle("top",s[1]+10+"px")}}}},me.prototype.getTextNumber=function(e){return e>=1e5?this.metric?(.001*e).toFixed(2)+"km":(.001*e*.621371).toFixed(2)+"mi":this.metric?e.toFixed(2)+"m":(3.28084*e).toFixed(2)+"ft"};var ve=m,ye=function(e,t,i){this.ui=e,this.browser=e.browser,this.control=this.ui.addControl("measure2",'<div id="vts-measure" class="vts-measure"><img id="vts-measure-button" class="vts-measure-button" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2lpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkNjI1MjFjMi1mYzE5LTcyNDUtOTI5My1kNTU3MmE5N2E1MjgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6ODJGRUI2NzE2NzkwMTFFN0EzRUZFNzQ1NEFCMkVFQUQiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ODJGRUI2NzA2NzkwMTFFN0EzRUZFNzQ1NEFCMkVFQUQiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjRBMjkwN0JENjc4QzExRTc5QTQwRjk4NjQzOEI4RDczIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjRBMjkwN0JFNjc4QzExRTc5QTQwRjk4NjQzOEI4RDczIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+k3ySjQAAAdJJREFUeNrclk0oBGEYgHemjZOLm8tSyt9BqT2I1O7JSdSSkpsDxZGLi5MTjn5K4SDh4OfiaPfkIDebOPiPUqKUiLKet96pzzT7MztxMPX0le+b95n3Z2ZZmUwm9NuXHfqLK1smsVhsED5hKkhswc4mYJmHVxgNIvIslyE4hnLYDSqycwiaoCGVSnUFFdk5BH2wKHtBRbYKqlVwbQhGoNU5GETkZHKpggjMqaBFhaGgIltv/mKphRuQss1oZkPuG4oRWTLHlmU5fSlhOYNKSEK7xIUugj+6hmSHpROm2RvL9Q7arqf80IykdDEdgll4IWi/Bm+ECT8Z2R7l+DBKV6N/PoRnEbBuwIKf0nm+8S7RGuzDLaxLMuw/5OuR+bn60ROPt9/pUUQnUEa6A56SyeSWeTYejzs9GkC8ZIpySjxEy1APbdCM6MAlGmeZdIahYIlLVAU9kIA7KZFxrJrA5+bU8RBjBf+eGD26gk0oI4AItiU4dMOqHh+GTylbQT3JU7oj2IMLmNBJrIATKIUoD5L2LfEQJbRPvXAP0iPZj5J92vNl9Fk6mSCZsBV4dwuyflb8XJrRqX6C3iDsFhSdiXOzZlSnwxD2yuBHJv/iX6JvAQYAPSICqA82OnoAAAAASUVORK5CYII="><img id="vts-measure-button2" class="vts-measure-button" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyFpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDIxIDc5LjE1NDkxMSwgMjAxMy8xMC8yOS0xMTo0NzoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo2Nzg3NzczMzY3OEMxMUU3QjU2QUUxNTNCNzc4MzVBQiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo2Nzg3NzczNDY3OEMxMUU3QjU2QUUxNTNCNzc4MzVBQiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjY3ODc3NzMxNjc4QzExRTdCNTZBRTE1M0I3NzgzNUFCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjY3ODc3NzMyNjc4QzExRTdCNTZBRTE1M0I3NzgzNUFCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+owD8TQAAAepJREFUeNrcls8rBGEYx993lIMfxR4kF/+AKMqBg7K1ajelLEWK025tKOTnjVykuAklNgcHuzmQg4MiTtz4Aza3TeGActDr+45nZt41s7tmBwdbn2l35933M9/3eead5UII9tsvjf3FK2uSiGgBKdDtZW6JllXA2DG4A3teRM7LZQl2QRuY9irScghGQRXb5KteRVoOQSMY0895FGkk8JHgSBH0gllzpAeRkeSRBAEwQIIZUJMxukARly3GOZdpivA5DnpAM2iQ5zFx3KE55DIugT6cT+a7PTTlKt9xHAT74AzU6vWJiEVQ4iWR9uXHhkgu3QhYB/JK3zBZE6WoBkE3Ivt9YolOQBd9uwJedQFjC+A8XyJ1J3G+4zNFV+CCmmMejINnY8sQG0wVzZnFlnW2Fd55ezGaIUAtPgzqwAsmv8mYMCLW8DaqdyY1g73w+RMFQRh0glse1RtDHRvDcdJp6XInsScKU3u3gnukSfCoOcoH0YPa3jif/P7zxEqUoPqUkWBZ398YqwdTNHqLdu+YuyTONToEl+AaTIAhUE61qwTtuJC0e4klkssQAn7QTy3+BA5AhRQgfdoovHvJp6iYli5EdTqlBKZA7a7CJFaiHdABUqBUFfyMxBJt06PBrwpskn/xl+hDgAEAH0j0b9rsgVUAAAAASUVORK5CYII="><div id="vts-measure-text-holder" class="vts-measure-text-holder"><div class="vts-measure-text-holder2"><div class="vts-measure-text"><textarea id="vts-measure-text-input" rows="6" cols="50" wrap="hard"></textarea></div><div class="vts-measure-tools"><div id="vts-measure-clear" class="vts-measure-tools-button">Clear</div></div></div></div><div id="vts-measure-info" class="vts-measure-info"></div> </div>',t,i),this.div=this.control.getElement("vts-measure"),this.buttonOff=this.control.getElement("vts-measure-button"),this.buttonOff.on("click",this.onSwitch.bind(this)),this.buttonOff.on("dblclick",this.onDoNothing.bind(this)),this.buttonOn=this.control.getElement("vts-measure-button2"),this.buttonOn.on("click",this.onSwitch.bind(this)),this.buttonOn.on("dblclick",this.onDoNothing.bind(this)),this.info=this.control.getElement("vts-measure-info");var r=this.control.getElement("vts-measure-clear");r.on("click",this.onClear.bind(this)),r.on("dblclick",this.onDoNothing.bind(this)),this.measuring=!1,this.counter=1,this.lastCoords=null,this.listPanel=this.control.getElement("vts-measure-text-holder"),this.list=this.control.getElement("vts-measure-text-input"),this.measuring?(this.buttonOn.setStyle("display","block"),this.buttonOff.setStyle("display","none")):(this.buttonOn.setStyle("display","none"),this.buttonOff.setStyle("display","block")),this.onMouseMoveCall=this.onMouseMove.bind(this),this.onMouseLeaveCall=this.onMouseLeave.bind(this),this.onMouseClickCall=this.onMouseClick.bind(this),this.update()};ye.prototype.onDoNothing=function(e){ve.stopPropagation(e)},ye.prototype.onMouseLeave=function(e){this.info.setStyle("display","none")},ye.prototype.onMouseClick=function(e){var t=this.browser.getMap();if(t){var i=this.ui.getMapElement().getDraggingState().absMoved;if(!(i[0]+i[1]>0)){var r=e.getMouseCoords(),s=t.getHitCoords(r[0],r[1],"fix");if(s){s=t.convertCoordsFromNavToPublic(s,"fix");var a="#"+this.counter+"  "+s[0].toFixed(7)+", "+s[1].toFixed(7)+", "+s[2].toFixed(2)+"m";if(this.lastCoords){for(var n=t.getDistance(this.lastCoords,s,!1,!0),o="\n   ",h=0,l=(""+this.counter).length;h<l;h++)o+=" ";a+=o+"great-circle distance: ",n[0]>1e5?a+=(.001*n[0]).toFixed(2)+"km":a+=n[0].toFixed(2)+"m",a+=o+"elevation difference: "+(s[2]-this.lastCoords[2]).toFixed(2)+"m",a+=o+"euclidean distance: ",n[2]>1e5?a+=(.001*n[2]).toFixed(2)+"km":a+=n[2].toFixed(2)+"m"}this.counter++,this.lastCoords=s;var u=this.list.getElement();u.value+=a+"\n",u.scrollTop=u.scrollHeight}}}},ye.prototype.onMouseMove=function(e){var t=this.browser.getMap();if(t){var i=e.getMouseCoords(),r=t.getHitCoords(i[0],i[1],"fix");if(r){var s=(r=t.convertCoordsFromNavToPublic(r,"fix"))[0].toFixed(7)+", "+r[1].toFixed(7)+", "+r[2].toFixed(2)+"m";i[0]-=this.divRect.left,i[1]-=this.divRect.top,this.info.setStyle("display","block"),this.info.setStyle("left",i[0]+20+"px"),this.info.setStyle("top",i[1]+10+"px"),this.info.setHtml(s)}else this.info.setStyle("display","none")}},ye.prototype.onSwitch=function(){this.measuring=!this.measuring;var e=this.ui.getMapElement();this.measuring?(this.buttonOn.setStyle("display","block"),this.buttonOff.setStyle("display","none"),this.divRect=this.div.getRect(),e.on("mousemove",this.onMouseMoveCall),e.on("mouseleave",this.onMouseLeaveCall),e.on("click",this.onMouseClickCall)):(this.buttonOn.setStyle("display","none"),this.buttonOff.setStyle("display","block"),e.off("mousemove",this.onMouseMoveCall),e.off("mouseleave",this.onMouseLeaveCall),e.off("click",this.onMouseClickCall)),this.updateLink(),this.update()},ye.prototype.onClear=function(){this.counter=1,this.lastCoords=null;var e=this.list.getElement();e.value="",e.scrollTop=0},ye.prototype.update=function(){var e=10+(this.ui.config.controlZoom?70:0)+(this.ui.config.controlSpace?35:0);this.div.setStyle("left",e+"px"),this.listPanel.setStyle("display",this.measuring?"block":"none")},ye.prototype.updateLink=function(){};var be=ye,xe=function(e,t,i){this.ui=e,this.clinets=[];for(var r='<div class="vts-sync"',s=[0,32,96,192,224,64],a=0,n=s.length;a<n;a++)r+='<div id="vts-sync'+a+'" style="background: radial-gradient(circle, hsl('+s[a]+",100%,50%,0) 45%, hsl("+s[a]+",100%,50%,1) 50%, hsl("+s[a]+',100%,50%,-1) 55%); display: none; position: absolute; left: 0px; top: 0px;  width: 40px; height: 40px; pointer-events: none; "></div>';r+="</div>",this.control=this.ui.addControl("sync",r,t,i);var o=this.ui.getMapElement();this.onMouseMoveCall=this.onMouseMove.bind(this),this.onMouseLeaveCall=this.onMouseLeave.bind(this),o.on("mousemove",this.onMouseMoveCall),o.on("mouseleave",this.onMouseLeaveCall)};xe.prototype.onDoNothing=function(e){dom.stopPropagation(e)},xe.prototype.onMouseLeave=function(e){var t=this.ui.browser;t.getRenderer().getCanvasSize();if(t.ws&&1==t.ws.readyState){e.getMouseCoords();t.ws.send('{ "command":"hide-cursor", "id": '+t.wsId+"  }")}},xe.prototype.onMouseMove=function(e){var t=this.ui.browser,i=t.getRenderer().getCanvasSize();if(t.ws&&1==t.ws.readyState){var r=e.getMouseCoords();t.ws.send('{ "command":"cursor", "id": '+t.wsId+',  "pos":['+(r[0]-.5*i[0])/i[1]+","+r[1]/i[1]+"]  }")}},xe.prototype.updateCursor=function(e){e.color>5&&(e.color=5);var t=document.getElementById("vts-sync"+e.color);if(t)if("cursor"==e.command){var i=this.ui.browser.getRenderer().getCanvasSize();t.style.display="block",t.style.left=e.pos[0]*i[1]+.5*i[0]-20+"px",t.style.top=e.pos[1]*i[1]-20+"px"}else t.style.display="none"};var we=xe,Me=m,Se=h.a,Ae=S,Ce=C,Te=F,Pe=E,Fe=I,Le=z,Ee=H,ke=ee,Ne=re,Ie=se,Be=me,Re=be,ze=ae,Ue=ne,De=he,_e=ue,Oe=we,Ge=function(e,t){this.browser=e,this.config=e.config,this.rootElement=t,this.element=null,this.controls=[],this.killed=!1,this.init(),this.instanceId=Se.instanceCounter++,Object.defineProperty(this,"dom",{get:function(){if(!this.killed)return Me}})};Ge.prototype.init=function(){this.elementIdCounter=1,this.element=document.createElement("div"),this.element.className="vts-browser",this.rootElement.appendChild(this.element),this.map=new Ce(this);var e=this.config.controlLoading;this.compass=new Te(this,!e&&this.config.controlCompass,e),this.credits=new Pe(this,!e&&this.config.controlCredits,e),this.fullscreen=new Fe(this,!e&&this.config.controlFullscreen,e),this.zoom=new Le(this,!e&&this.config.controlZoom,e),this.space=new Ee(this,!e&&this.config.controlSpace,e),this.search=new ke(this,!e&&this.config.controlSearch,e),this.link=new Ne(this,!e&&this.config.controlLink,e),this.github=new Ie(this,!e&&this.config.controlGithub,e),this.measure=new Be(this,!e&&this.config.controlMeasure,e),this.measure2=new Re(this,!e&&this.config.controlMeasureLite,e),this.layers=new ze(this,!e&&this.config.controlLayers,e),this.fallback=new Ue(this),this.popup=new De(this,!1),this.loading=new _e(this,this.config.controlLoading),this.config.syncCursor&&(this.sync=new Oe(this,this.config.syncCursor)),Me.disableContexMenu(this.element)},Ge.prototype.kill=function(){for(var e in this.killed=!0,this.controls)delete this.controls[e];this.rootElement.removeChild(this.element),delete this.element,this.element=null},Ge.prototype.addControl=function(e,t,i,r,s){var a=new Ae(this,t,i,r,s);return this.controls[e]=a,a},Ge.prototype.removeControl=function(e){null!=this.controls[e]&&delete this.controls[e]},Ge.prototype.setControlHtml=function(e,t){null!=this.controls[e]&&this.controls[e].setHTML(t)},Ge.prototype.setControlVisible=function(e,t,i){if(null!=this.controls[e]){void 0!==i&&this.controls[e].setVisibleLock(i);var r=this.browser.getRenderer(),s=r.getMarginFlags();"compass"==e&&(s|=1),"search"==e&&(s|=2),this.config.bigScreenMargins&&(s|=4096),r.setMarginFlags(s),this.controls[e].setVisible(t)}},Ge.prototype.getControlVisible=function(e){null!=this.controls[e]&&this.controls[e].getVisible()},Ge.prototype.getControl=function(e){return this.controls[e]},Ge.prototype.getMapControl=function(){return this.map},Ge.prototype.getMapElement=function(){return this.map.getMapElement()},Ge.prototype.setParam=function(e){switch(e){case"controlCompass":this.setControlVisible("compass",this.config.controlCompass);break;case"controlZoom":this.setControlVisible("zoom",this.config.controlZoom);break;case"controlScale":this.setControlVisible("scale",this.config.controlScale);break;case"controlLayers":this.setControlVisible("layers",this.config.controlLayers);break;case"controlSpace":this.setControlVisible("space",this.config.controlSpace);break;case"controlSearch":this.setControlVisible("search",this.config.controlSearch);break;case"controlLink":this.setControlVisible("link",this.config.controlLink);break;case"controlMeasure":this.setControlVisible("measure",this.config.controlMeasure);break;case"controlLogo":this.setControlVisible("logo",this.config.controlLogo);break;case"controlFullscreen":this.setControlVisible("fullscreeen",this.config.controlFullscreen);break;case"controlCredits":this.setControlVisible("credits",this.config.controlCredits)}},Ge.prototype.tick=function(e){e&&(this.compass.update(),this.space.update(),this.credits.update(),this.link.updateLink(),this.search.update()),this.loading.control.getVisible()&&this.loading.update()};var Ve=Ge,je=function(e){this.browser=e,this.trajectory=[],this.flightDuration=1,this.flightTime=0,this.trajectoryIndex=0,this.finished=!0,this.autoMovement=!1,this.autoRotate=0,this.autoPan=0,this.autoPanAzimuth=0,this.center=[0,0,0],this.orientation=[0,0,0],this.viewHeight=0,this.fov=90,this.lastTime=0};je.prototype.setAutorotate=function(e){this.autoRotate!=e&&this.browser.callListener("autorotate-changed",{autorotate:e}),this.autoRotate=e},je.prototype.getAutorotate=function(){return this.autoRotate},je.prototype.setAutopan=function(e,t){this.autoPan=e,this.autoPanAzimuth=t},je.prototype.getAutopan=function(){return[this.autoPan,this.autoPanAzimuth]},je.prototype.flyToDAH=function(e,t,i,r){var s=this.browser.core.map;if(s){r=r||{};var a=s.generatePIHTrajectory(s.getPosition(),e,t,i,r);this.setTrajectory(a,r.samplePeriod||10,r)}},je.prototype.flyTo=function(e,t){var i=this.browser.core.map;if(i){t=t||{};var r=i.generateTrajectory(i.getPosition(),e,t);this.setTrajectory(r,t.samplePeriod||10,t)}},je.prototype.flyTrajectory=function(e,t){this.setTrajectory(e,t||10,{})},je.prototype.cancelFlight=function(){this.browser.getControlMode().setCurrentControlMode(this.lastControlMode),this.finished=!0},je.prototype.setTrajectory=function(e,t,i){null!=e&&0!=e.length&&(this.setAutorotate(0),this.setAutopan(0,0),this.speed=i.speed||1,this.finished&&(this.lastControlMode=this.browser.getControlMode().getCurrentControlMode()),this.browser.getControlMode().setCurrentControlMode("disabled"),this.trajectory=e,this.sampleDuration=t,this.browser.callListener("fly-start",{startPosition:this.trajectory[0],endPosition:this.trajectory[this.trajectory.length-1],options:i}),this.timeStart=performance.now(),this.finished=!1)},je.prototype.tick=function(){var e=this.browser.getMap();if(e){var t,i=performance.now(),r=(i-this.lastTime)/1e3;if(this.lastTime=i,!(this.browser.ui&&this.browser.ui.loading&&this.browser.ui.loading.control.getVisible())){if(0!=this.autoRotate){var s=(t=e.getPosition()).getOrientation();s[0]=(s[0]+this.autoRotate*r)%360,t.setOrientation(s),e.setPosition(t)}if(0!=this.autoPan&&(t=e.getPosition(),t=e.movePositionCoordsTo(t,this.autoPanAzimuth,t.getViewExtent()*(.01*this.autoPan)*r,0),e.setPosition(t)),!this.finished&&this.trajectory){i-=this.timeStart;var a=Math.floor(i/this.sampleDuration*this.speed),n=this.trajectory.length-1;a<n?(e.setPosition(this.trajectory[a]),this.browser.callListener("fly-progress",{position:this.trajectory[a],progress:a/n*100})):e.setPosition(this.trajectory[n]),a>=this.trajectory.length&&(this.browser.callListener("fly-end",{position:this.trajectory[n]}),this.browser.getControlMode().setCurrentControlMode(this.lastControlMode),this.finished=!0)}}}},je.prototype.generateTrajectory=function(e,t,i){var r=this.browser.core.map;if(r)return i=i||{},r.generateTrajectory(e,t,i)},je.prototype.generatePIHTrajectory=function(e,t,i,r){var s=this.browser.core.map;if(s)return r=r||{},s.generatePIHTrajectory(e,t,i,r)};var He=je,We=function(){},qe=l.a,Ze=function(e){this.browser=e,this.config=null,this.center=[0,0],this.dragging=!1,this.velocity=[0,0],this.impulse=[0,0],this.drag=this.drag,this.down=this.drag,this.up=this.drag,this.wheel=this.wheel,this.tick=this.tick,this.reset=this.reset,this.keyup=this.keyup,this.keydown=this.keydown,this.keypress=this.keypress};Ze.prototype.drag=function(e){if(this.dragging){var t=e.getMouseCoords(),i=[t[0]-this.center[0],t[1]-this.center[1]];this.velocity[0]=.008*i[0],this.velocity[1]=.008*i[1],this.impulse[0]=.008*i[0],this.impulse[1]=.008*i[1]}},Ze.prototype.down=function(e){"left"===e.getMouseButton()&&(this.center=e.getMouseCoords(),this.dragging=!0)},Ze.prototype.up=function(e){"left"===e.getMouseButton()&&(this.dragging=!1)},Ze.prototype.wheel=function(e){var t=this.browser.getMap();if(t){var i=t.getPosition(),r=1*(e.getWheelDelta()>0?-1:1);i.setViewExtent(qe.clamp(i.getViewExtent()+r,1,179)),t.setPosition(i)}},Ze.prototype.keyup=function(){},Ze.prototype.keydown=function(){},Ze.prototype.keypress=function(){},Ze.prototype.tick=function(){if(0!=this.velocity[0]||0!=this.velocity[1]){var e=this.browser.getMap();if(e){var t=e.getPosition(),i=t.getCoords();if(i[0]-=this.velocity[0],i[1]-=this.velocity[1],t.setCoords(i),e.setPosition(t),!this.dragging){Math.abs(this.velocity[0])<5e-4?this.velocity[0]=0:this.velocity[0]*=.9,Math.abs(this.velocity[1])<5e-4?this.velocity[1]=0:this.velocity[1]*=.9}}}},Ze.prototype.reset=function(e){this.config=e};var Ye=We,Je=_,Ke=Ze,Qe=function(e){this.browser=e,this.ui=e.ui,this.mapControl=this.ui.getMapControl(),this.mapElement=this.mapControl.getMapElement(),this.altKey=!1,this.shiftKey=!1,this.ctrlKey=!1,this.mapElement.on("drag",this.onDrag.bind(this)),this.mapElement.on("mousedown",this.onDown.bind(this)),this.mapElement.on("mouseup",this.onUp.bind(this)),this.mapElement.on("mousewheel",this.onWheel.bind(this)),this.mapElement.on("keyup",this.onKeyUp.bind(this),window),this.mapElement.on("keydown",this.onKeyDown.bind(this),window),this.mapElement.on("keypress",this.onKeyPress.bind(this),window),this.mapElement.on("dblclick",this.onDoubleClick.bind(this),window),this.browser.on("tick",this.onTick.bind(this)),this.controlModes={},this.currentCotnrolModeId="map-observer",this.currentControlMode=this.controlModes["map-observer"],this.addControlMode("map-observer",new Je(e)),this.addControlMode("disabled",new Ye),this.addControlMode("pano",new Ke(e)),this.setDefaultControlMode()};Qe.prototype.addControlMode=function(e,t){this.controlModes[e]=t},Qe.prototype.removeControlMode=function(e){e!==this.currentCotnrolModeId&&delete this.controlModes[e]},Qe.prototype.setCurrentControlMode=function(e,t){var i=this.controlModes[e];i&&(this.currentControlModeId=e,this.currentControlMode=i,i.reset&&i.reset(t))},Qe.prototype.setDefaultControlMode=function(){this.setCurrentControlMode("map-observer")},Qe.prototype.getCurrentControlMode=function(){return this.currentControlModeId},Qe.prototype.getCurrentController=function(){return this.currentControlMode},Qe.prototype.onDrag=function(e){this.checkAutopilot(),this.currentControlMode.drag&&this.currentControlMode.drag(e)},Qe.prototype.onDown=function(e){this.checkAutopilot(),this.updateModifierKeys(e),this.currentControlMode.down&&this.currentControlMode.down(e)},Qe.prototype.onUp=function(e){this.updateModifierKeys(e),this.currentControlMode.up&&this.currentControlMode.up(e)},Qe.prototype.onWheel=function(e){this.checkAutopilot(),this.currentControlMode.wheel&&this.currentControlMode.wheel(e)},Qe.prototype.onKeyUp=function(e){this.updateModifierKeys(e),this.currentControlMode.keyup&&this.currentControlMode.keyup(e)},Qe.prototype.onKeyDown=function(e){this.updateModifierKeys(e),this.currentControlMode.keydown&&this.currentControlMode.keydown(e)},Qe.prototype.onKeyPress=function(e){this.updateModifierKeys(e),this.currentControlMode.keypress&&this.currentControlMode.keypress(e)},Qe.prototype.onDoubleClick=function(e){this.updateModifierKeys(e),this.currentControlMode.doubleclick&&this.currentControlMode.doubleclick(e)},Qe.prototype.onTick=function(e){this.currentControlMode.tick&&(e.draggingState=this.mapElement.getDraggingState(),this.currentControlMode.tick(e))},Qe.prototype.updateModifierKeys=function(e){this.altKey=e.getModifierKey("alt"),this.shiftKey=e.getModifierKey("shift"),this.ctrlKey=e.getModifierKey("ctrl")},Qe.prototype.checkAutopilot=function(){this.browser.autopilot&&(this.browser.autopilot.setAutorotate(0),this.browser.autopilot.setAutopan(0,0))};var Xe=Qe,$e=function(e,t){this.container=null,this.aTags=null,this.sectionTags=null,this.defaultHeight=0,this.maxHeight=0,this.subtitlesHeights=[],this.firstTitleMargin=20,this.swipeOffset=60,this.actualNode=0,this.maxNodes=1,this.animTime=600,this.currentToolbox="right",this.browser=e,this.id=[],this.current=null,this.presenter=void 0!==t.presenter?JSON.parse(JSON.stringify(t.presenter)):{},this.presenterAutoplay=t.presenterAutoplay,void 0!==this.presenter&&this.playPresentation()};$e.prototype.addPresentation=function(e,t){0!==Object.keys(this.presenter).length?this.presenter[e]=t:void 0!==e&&(this.presenter={},this.presenter[e]=t)},$e.prototype.removePresentation=function(e){return void 0!==e?(this.getCurrentPresentation()==e&&(this.stopPresentation(),this.current=null),delete this.presenter[e],"Removed presentation id: "+e):(null!==this.getCurrentPresentation()&&this.stopPresentation(),this.presenter={},this.presenterAutoplay="",this.current=null,"All presentations removed.")},$e.prototype.getCurrentPresentation=function(){return this.current},$e.prototype.getCurrentPresentationType=function(){return this.currentToolbox},$e.prototype.playPresentation=function(e){if(this.stopPresentation(),void 0!==this.presenterAutoplay&&void 0===e)e=this.presenterAutoplay;else if(void 0===e&&void 0!==this.presenter&&Object.keys(this.presenter).length>0)for(var t in this.presenter){e=t;break}return void 0!==e&&-1!=Object.keys(this.presenter).indexOf(e)&&(this.current=e,this.readTextInput(e),!0)},$e.prototype.stopPresentation=function(){var e=this.getCurrentPresentation();return this.currentToolbox="right",null!==e&&(this.current=null,this.browser.ui.removeControl(e),this.container.getElementsByTagName("article")[0].parentNode.parentNode.parentNode.remove(),!0)},$e.prototype.listPresentations=function(e){if(0===Object.keys(this.presenter).length)return[];if(void 0!==e)return"undefined"!==this.presenter[e]?this.presenter[e]:null;var t=[];for(var i in this.presenter)t.push(i);return t},$e.prototype.initPresentation=function(e,t){var i=this,r='<div class="vts-presenter panelContainer"><div class="vts-presenter swipeControl top"></div><div class="vts-presenter toolboxContainer">'+t+'</div><div class="vts-presenter swipeControl"></div></div>'+('<div class="vts-presenter subtitlesContainer"><button type="button"></button><button type="button"></button><div class="vts-presenter swipeSubtitles"><div><div></div></div></div><div class="vts-presenter swipeSubtitles"><div><div></div></div></div><div class="vts-presenter innerContainer">'+t+"</div></div>"),s=this.browser.ui.addControl(e,r);this.id.push(e),this.setContainer(s),this.aTags=this.container.getElementsByTagName("a");for(var a=0;a<this.aTags.length;a++)this.aTags[a].onclick=function(){i.linksDecode(this)};setTimeout(function(){this.renderControl()}.bind(this),200)},$e.prototype.readTextInput=function(e){var t={htmlDataStorage:this.presenter[e],id:e,checkID:function(){var e=/(\.\.\/|\.\/)/g;if(/(<article)/g.test(this.htmlDataStorage))return"string";if(/^(ftp|http|https):\/\/[^ "]+$/.test(this.htmlDataStorage))return"url";if(/.*\/+.*/.test(this.htmlDataStorage)){for(var t,i=0,r="",s=window.location.href.split("/"),a="";null!==(t=e.exec(this.htmlDataStorage))&&(r+=t[0],"./"!==t[0]);)i++;i++;for(var n=0;n<s.length-i;n++)a=a+s[n]+"/";return a+=this.htmlDataStorage.split(r)[1],this.htmlDataStorage=a,"url"}return/^#.*$/.test(this.htmlDataStorage)?"hash":"string"}},i=t.checkID();if("url"==i){var r=new XMLHttpRequest;r.open("GET",t.htmlDataStorage,!1),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0==r.status){var e=r.responseText;this.html=e,this.initPresentation(t.id,this.html)}else this.file="undefined"}.bind(this),r.send(null)}else if("hash"==i){var s=document.getElementById(t.htmlDataStorage).innerHTML;this.initPresentation(t.id,s)}else"string"==i&&this.initPresentation(t.id,t.htmlDataStorage)},$e.prototype.linksDecode=function(e){var t,i=null,r=null,s=null;return null!==e.getAttribute("data-mln-navigate")&&null!==(s=e.getAttribute("data-mln-navigate"))?("prev"==s?this.nextArticle("-1"):"next"==s?this.nextArticle("+1"):"first"==s?this.nextArticle(0):"last"==s?this.nextArticle(this.maxNodes-1):this.nextArticle(s),"navigation:true"):null===e.getAttribute("data-mln-position")?"position:false":(t=this.getNumbers(e.getAttribute("data-mln-position").split(",")),null!==e.getAttribute("data-mln-autorotate")&&(i=this.getNumbers(e.getAttribute("data-mln-autorotate"))),null!==e.getAttribute("data-mln-transition")&&(r=e.getAttribute("data-mln-transition")),null===r?this.browser.autopilot.flyTo(t):"teleport"==r?this.browser.core.getMap().setPosition(t):this.browser.autopilot.flyTo(t),null!==i&&this.browser.autopilot.setAutorotate(i),"Moving to position: "+t)},$e.prototype.getNumbers=function(e){for(var t=0;t<e.length;t++){if("string"==typeof e&&parseFloat(e)){e=parseFloat(e);break}parseFloat(e[t])&&(e[t]=parseFloat(e[t]))}return e},$e.prototype.nextArticle=function(e,t,i){return"+1"===e?e=1:"-1"===e?e=-1:(this.actualNode=e,e=0),this.actualNode=this.actualNode+e,this.actualNode>=0&&this.actualNode<this.maxNodes?(t||("right"==this.currentToolbox?this.handleArticle(this.actualNode):"wide"==this.currentToolbox&&this.handleSubtitlesPosition(this.actualNode)),void 0!==i&&(this.maxNodes=i),this.linksDecode(this.container.getElementsByTagName("section")[this.actualNode]),!0):(this.actualNode=this.actualNode-e,!1)},$e.prototype.useToolbox=function(){var e=this.container.getElementsByTagName("article")[0].getAttribute("data-mln-style");null===e&&(e="right");var t,i=this.container.getElementsByClassName("vts-presenter panelContainer")[0],r=this.container.getElementsByClassName("vts-presenter subtitlesContainer")[0],s=this.container.getElementsByClassName("vts-presenter swipeControl");if(this.currentToolbox=e,r.setAttribute("style","opacity: 0;"),r.setAttribute("class","vts-presenter subtitlesContainer"),"right"==e){for(i.style.display="block",setTimeout((function(){i.style.opacity=1}),20),s[0].style.display="block",s[1].style.display="block",t=0;t<this.sectionTags.length;t++)this.sectionTags[t].style.height=this.maxHeight+"px";this.nextArticle(0)}else if("wide"==e){for(r.style.display="block",setTimeout((function(){r.style.opacity=1}),20),i.style.display="none",i.style.opacity=0,s[0].style.display="none",s[1].style.display="none",t=0;t<this.sectionTags.length;t++)this.sectionTags[t].style.height="auto";this.handleSubtitlesPosition(0,!0)}},$e.prototype.setContainer=function(e){this.container=e.element},$e.prototype.renderControl=function(){this.sectionTags=this.container.getElementsByClassName("vts-presenter toolboxContainer")[0].querySelectorAll("section");var e=this.container.getElementsByClassName("vts-presenter swipeControl")[0],t=this.container.getElementsByClassName("vts-presenter swipeControl")[1],i=document.createElement("button");i.innerHTML="<div><div></div></div>",i.setAttribute("type","button"),i.setAttribute("class","vts-presenter-btnDw"),i.onclick=function(){this.nextArticle("+1")}.bind(this);var r=document.createElement("button");r.innerHTML="<div><div></div></div>",r.setAttribute("type","button"),r.setAttribute("class","vts-presenter-btnUp"),r.onclick=function(){this.nextArticle("-1")}.bind(this),e.appendChild(r),t.appendChild(i),this.getElementsTrueHeight(this.sectionTags);var s=this.maxHeight+this.swipeOffset;this.container.getElementsByClassName("vts-presenter panelContainer")[0].style.height=s+this.swipeOffset+"px",t.style.top=s+"px",e.style.opacity="1",t.style.opacity="1",setTimeout(function(){this.useToolbox()}.bind(this),this.animTime),this.nextArticle(0,!1,this.sectionTags.length)},$e.prototype.getElementsTrueHeight=function(e){for(var t=0;t<e.length;t++)e[t].offsetHeight>this.maxHeight&&(this.maxHeight=e[t].offsetHeight);for(t=0;t<e.length;t++)e[t].style.height=this.maxHeight+"px"},$e.prototype.handleArticle=function(e){var t=this.container.getElementsByClassName("vts-presenter toolboxContainer")[0],i=this.container.getElementsByClassName("vts-presenter-btnUp")[0],r=this.container.getElementsByClassName("vts-presenter-btnDw")[0],s=function(e){this.container.getElementsByClassName("vts-presenter toolboxContainer")[0].querySelectorAll("article")[0].setAttribute("class",e)}.bind(this),a=this.maxHeight*this.actualNode*-1;return i.setAttribute("class","vts-presenter-btnUp"),r.setAttribute("class","vts-presenter-btnDw"),0===e?i.setAttribute("class","vts-presenter-btnUp vts-presenter hidden"):e===this.maxNodes-1&&r.setAttribute("class","vts-presenter-btnDw vts-presenter hidden"),this.container.getElementsByTagName("article")[0].setAttribute("style","top: "+a+"px"),0===this.actualNode?(t.style.height=this.maxHeight+this.swipeOffset+"px",t.style.top=0,s("vts-presenter"),this.container.getElementsByClassName("vts-presenter swipeControl")[0].style.height=0,this.container.getElementsByTagName("article")[0].style.top=0,this.container.getElementsByTagName("section")[0].style.height=this.maxHeight+(this.swipeOffset-this.firstTitleMargin)+"px"):(t.style.height=this.maxHeight+"px",t.style.top=this.swipeOffset+"px",s("vts-presenter nonFirst"),this.container.getElementsByClassName("vts-presenter swipeControl")[0].style.height=this.swipeOffset+"px",this.container.getElementsByTagName("section")[0].style.height=this.maxHeight+this.swipeOffset+"px"),!0},$e.prototype.handleSubtitlesPosition=function(e,t){void 0===e&&(e=0);var i=this.container.getElementsByClassName("vts-presenter subtitlesContainer")[0],r=i.childNodes[0],s=i.childNodes[1],a=i.childNodes[4].querySelectorAll("article")[0].querySelectorAll("section"),n=this.container.getElementsByClassName("vts-presenter swipeSubtitles");this.linksDecode(a[e]),a[e].removeAttribute("style"),i.setAttribute("class","vts-presenter subtitlesContainer"),i.removeAttribute("onclick"),n[0].removeAttribute("onclick"),n[1].removeAttribute("onclick"),n[0].removeAttribute("style"),n[1].removeAttribute("style"),r.removeAttribute("onclick"),s.removeAttribute("onclick"),r.setAttribute("class","vts-presenter hidden"),s.setAttribute("class","vts-presenter hidden");for(var o=0;o<a.length;o++)a[o].style.opacity=0,void 0===this.subtitlesHeights[o]&&(a[o].style.display="block",this.subtitlesHeights[o]=a[o].offsetHeight,a[o].style.display="none"),o!==e&&this.hideSections(a[o]);this.showSections(a[e]);var h=a[e].getAttribute("data-mln-style");null==h&&(h="full"),"full"==h?(n[0].style.opacity=0,n[1].style.opacity=0,n[0].style.cursor="default",n[1].style.cursor="default",0===e?(r.setAttribute("class","vts-presenter hidden"),s.setAttribute("class","vts-presenter"),s.onclick=function(){this.nextArticle(1)}.bind(this),s.innerHTML="Continue"):e===a.length-2&&(r.setAttribute("class","vts-presenter"),r.onclick=function(){this.nextArticle("-1")}.bind(this),r.innerHTML="Back",s.setAttribute("class","vts-presenter"),s.onclick=function(){this.nextArticle("+1")}.bind(this),s.innerHTML="Explore"),void 0===t&&i.setAttribute("style","display: block;"),i.setAttribute("class","vts-presenter subtitlesContainer full")):"title"==h?(n[0].style.opacity=1,n[1].style.opacity=1,n[0].onclick=function(){this.nextArticle("-1")}.bind(this),n[1].onclick=function(){this.nextArticle("+1")}.bind(this),r.setAttribute("class","vts-presenter hidden"),s.setAttribute("class","vts-presenter hidden"),i.style.height=this.subtitlesHeights[e]+"px",i.setAttribute("class","vts-presenter subtitlesContainer title")):"mini"==h&&(i.setAttribute("style","display: block;"),i.setAttribute("class","vts-presenter subtitlesContainer mini"),r.setAttribute("class","vts-presenter hidden"),s.setAttribute("class","vts-presenter hidden"))},$e.prototype.hideSections=function(e){setTimeout((function(){e.style.display="none"}),this.animTime)},$e.prototype.showSections=function(e){setTimeout((function(){e.style.display="block",setTimeout((function(){e.style.opacity=1}),50)}),this.animTime)};var et=$e,tt=function(e){this.roiServers=e};tt.prototype.roisAtPosition=function(){};var it=tt,rt=c.a,st=h.a,at=Ve,nt=He,ot=Xe,ht=et,lt=it,ut=n.b,ct=function(e,t){this.killed=!1,this.configStorage={},this.initConfig(),this.setConfigParams(t,!0),this.originalConfig=JSON.parse(JSON.stringify(t)),this.element="string"==typeof e?document.getElementById(e):e,this.ui=new at(this,this.element),e="string"!=typeof e?e:document.getElementById(e),ut()?(this.core=new rt(this.ui.getMapControl().getMapElement().getElement(),t),null!=this.core?(this.updatePosInUrl=!1,this.lastUrlUpdateTime=!1,this.mapLoaded=!1,this.mapInteracted=!1,this.autopilot=new nt(this),this.rois=new lt(this),this.controlMode=new ot(this,this.ui),this.presenter=new ht(this,t),this.wsId=Date.now(),this.lastWsPos=null,this.lastWSConnectTime=0,this.config.sync&&this.setupWS(),this.on("map-loaded",this.onMapLoaded.bind(this)),this.on("map-unloaded",this.onMapUnloaded.bind(this)),this.on("map-update",this.onMapUpdate.bind(this)),this.on("map-position-changed",this.onMapPositionChanged.bind(this)),this.on("map-position-fixed-height-changed",this.onMapPositionFixedHeightChanged.bind(this)),this.on("map-position-panned",this.onMapPositionPanned.bind(this)),this.on("map-position-rotated",this.onMapPositionRotated.bind(this)),this.on("map-position-zoomed",this.onMapPositionZoomed.bind(this)),this.on("tick",this.onTick.bind(this))):this.ui.setControlVisible("fallback",!0)):this.ui.setControlVisible("fallback",!0)};ct.prototype.kill=function(){this.ui.kill(),this.killed=!0,this.ws&&this.ws.close()},ct.prototype.getCore=function(){return this.core},ct.prototype.getMap=function(){return this.core?this.core.map:null},ct.prototype.getRenderer=function(){return this.core?this.core.renderer:null},ct.prototype.getProj4=function(){return this.core?this.core.proj4:null},ct.prototype.getUI=function(){return this.ui},ct.prototype.setControlMode=function(e){this.controlMode=e},ct.prototype.getControlMode=function(){return this.controlMode},ct.prototype.on=function(e,t){return this.core.on(e,t)},ct.prototype.callListener=function(e,t){this.core.callListener(e,t)},ct.prototype.setupWS=function(){this.ws=new WebSocket(this.config.syncServer),this.ws.onmessage=e=>{var t=this.getMap();if(t)try{var i=JSON.parse(e.data);switch(i.command){case"cursor":case"hide-cursor":this.ui&&this.ui.sync&&this.ui.sync.updateCursor(i);break;case"pos":var r=i.pos,s=t.getPosition().toArray();this.lastWsPos=r,(Math.abs(r[1]-s[1])>1e-5||Math.abs(r[2]-s[2])>1e-5||Math.abs(r[4]-s[4])>.001||Math.abs(r[5]-s[5])>.01||Math.abs(r[6]-s[6])>.01||Math.abs(r[7]-s[7])>.01||Math.abs(r[8]-s[8])>.01||Math.abs(r[9]-s[9])>.01)&&t.setPosition(i.pos)}}catch(e){console.log(e)}},this.ws.onopen=()=>{this.ws.send('{ "command": "client", "channel": "'+this.config.sync+'", "id":'+this.wsId+"  }")},this.ws.onerror=e=>{console.log("WebSocket error: "+e)}},ct.prototype.onMapLoaded=function(e){this.mapLoaded=!0;var t=e.browserOptions||{},i=this.originalConfig;for(var r in i)void 0!==t[r]&&(t[r]=i[r]);if(this.setConfigParams(t),this.config.geojson||this.config.geodata){var s=this.config.geojson||this.config.geodata;if("string"==typeof s)if("{"==(s=s.trim()).charAt(0))try{s=JSON.parse(s),this.onGeoJsonLoaded(s)}catch(e){}else st.loadJSON(s,this.onGeoJsonLoaded.bind(this))}var a=this.getMap();this.config.tiles3d&&a&&(this.tiles3d=a.createGeodata(),this.tiles3d.load3DTiles(this.config.tiles3d,{},this.on3DTilesLoaded.bind(this))),this.autopilot&&(this.autopilot.setAutorotate(this.config.autoRotate),this.autopilot.setAutopan(this.config.autoPan[0],this.config.autoPan[1]))},ct.prototype.getLinkWithCurrentPos=function(){var e=this.getMap();if(!e)return"";var t=st.getParamsFromUrl(window.location.href),i=e.getPosition(),r="";r+=(i=e.convertPositionHeightMode(i,"fix",!0)).getViewMode()+",";var s=i.getCoords();r+=s[0].toFixed(6)+","+s[1].toFixed(6)+","+i.getHeightMode()+","+s[2].toFixed(2)+",";var a=i.getOrientation();if(r+=a[0].toFixed(2)+","+a[1].toFixed(2)+","+a[2].toFixed(2)+",",r+=i.getViewExtent().toFixed(2)+","+i.getFov().toFixed(2),t.pos=r,this.mapInteracted){(t.rotate||this.getConfigParam("rotate"))&&(t.rotate="0");var n=this.getConfigParam("pan");(t.pan||n&&(n[0]||n[1]))&&(t.pan="0,0")}for(var o in r="",t)r+=(r.length>0?"&":"")+o+"="+t[o];var h=window.location.href.split("?");if(h.length>1){var l=h[1].split("#");return h[0]+"?"+r+(l[1]||"")}return h[0]+"?"+r},ct.prototype.onMapPositionChanged=function(e){if(this.config.positionInUrl&&(this.updatePosInUrl=!0),this.ws){var t=this.getPositionString(e.position);t!=(this.lastWsPos?this.getPositionString(this.lastWsPos):"")&&1==this.ws.readyState&&this.ws.send('{ "command":"pos", "pos": '+t+" }")}},ct.prototype.onMapPositionPanned=function(){this.mapInteracted=!0},ct.prototype.onMapPositionRotated=function(){this.mapInteracted=!0},ct.prototype.onMapPositionZoomed=function(){this.mapInteracted=!0},ct.prototype.onMapPositionFixedHeightChanged=function(){this.config.positionInUrl&&(this.updatePosInUrl=!0)},ct.prototype.onMapUnloaded=function(){},ct.prototype.onMapUpdate=function(){this.dirty=!0},ct.prototype.onGeoJsonLoaded=function(e){var t=this.getMap(),i=t.createGeodata(),r=function(){var e=i.makeFreeLayer(this.config.geojsonStyle);t.addFreeLayer("geojson",e);var r=t.getView();r.freeLayers.geojson={},t.setView(r)}.bind(this);this.config.geodata?(i.importVTSGeodata(e),r()):(i.importGeoJson(e),i.processHeights("node-by-precision",62,r))},ct.prototype.on3DTilesLoaded=function(){var e=this.getMap(),t=this.tiles3d.makeFreeLayer({});e.addFreeLayer("tiles3d",t);var i=e.getView();i.freeLayers.tiles3d={options:{fastParse:!0}},e.setView(i)},ct.prototype.onTick=function(){if(!this.killed){var e;if(this.autopilot.tick(),this.ui.tick(this.dirty),this.dirty=!1,this.ws)if(this.ws.readyState>1)(e=performance.now())-this.lastWSConnectTime>1e3&&(this.setupWS(),this.lastWSConnectTime=e);if(this.updatePosInUrl)(e=performance.now())-this.lastUrlUpdateTime>1e3&&(window.history.replaceState&&window.history.replaceState({},null,this.getLinkWithCurrentPos()),this.updatePosInUrl=!1,this.lastUrlUpdateTime=e)}},ct.prototype.initConfig=function(){this.config={panAllowed:!0,rotationAllowed:!0,zoomAllowed:!0,jumpAllowed:!1,sensitivity:[1,.06,.05],inertia:[.81,.9,.7],timeNormalizedInertia:!1,legacyInertia:!1,positionInUrl:!1,positionUrlHistory:!1,constrainCamera:!0,navigationMode:"azimuthal",controlCompass:!0,controlZoom:!0,controlSpace:!0,controlSearch:!0,controlSearchSrs:null,controlSearchUrl:null,controlSearchFilter:!1,controlMeasure:!1,controlMeasureLite:!1,controlLink:!1,controlGithub:!1,controlScale:!0,controlLayers:!1,controlCredits:!0,controlFullscreen:!1,controlLoading:!0,searchElement:null,searchValue:null,walkMode:!1,wheelInputLag:[70,1],fixedHeight:0,geojson:null,sync:null,syncServer:"ws://localhost:9080",syncCursor:!1,tiltConstrainThreshold:[.5,1],bigScreenMargins:!1,minViewExtent:20,maxViewExtent:Number.MAXINTEGER,autoRotate:0,autoPan:[0,0]}},ct.prototype.setConfigParams=function(e,t){if("object"==typeof e&&null!==e)for(var i in e)this.setConfigParam(i,e[i],t)},ct.prototype.getPositionString=function(e){var t="[";return t+='"'+e[0]+'",',t+=e[1].toFixed(6)+","+e[2].toFixed(6)+',"'+e[3]+'",'+e[4].toFixed(2)+",",t+=e[5].toFixed(2)+","+e[6].toFixed(2)+","+e[7].toFixed(2)+",",t+=e[8].toFixed(2)+","+e[9].toFixed(2)+"]"},ct.prototype.updateUI=function(e){null!=this.ui&&this.ui.setParam(e)},ct.prototype.setConfigParam=function(e,t,i){var r=this.getMap();switch(e){case"pos":case"position":this.config.position=t,r&&r.setPosition(this.config.position);break;case"view":this.config.view=t,r&&r.setView(this.config.view);break;case"panAllowed":this.config.panAllowed=st.validateBool(t,!0);break;case"rotationAllowed":this.config.rotationAllowed=st.validateBool(t,!0);break;case"zoomAllowed":this.config.zoomAllowed=st.validateBool(t,!0);break;case"jumpAllowed":this.config.jumpAllowed=st.validateBool(t,!1);break;case"constrainCamera":this.config.constrainCamera=st.validateBool(t,!0);break;case"navigationMode":this.config.navigationMode=t;break;case"positionInUrl":this.config.positionInUrl=st.validateBool(t,!1);break;case"positionUrlHistory":this.config.positionUrlHistory=st.validateBool(t,!1);break;case"controlCompass":this.config.controlCompass=st.validateBool(t,!0),this.updateUI(e);break;case"controlZoom":this.config.controlZoom=st.validateBool(t,!0),this.updateUI(e);break;case"controlMeasure":this.config.controlMeasure=st.validateBool(t,!1),this.updateUI(e);break;case"controlScale":this.config.controlScale=st.validateBool(t,!0),this.updateUI(e);break;case"controlLayers":this.config.controlLayers=st.validateBool(t,!1),this.updateUI(e);break;case"controlSpace":this.config.controlSpace=st.validateBool(t,!1),this.updateUI(e);break;case"controlSearch":this.config.controlSearch=st.validateBool(t,!1),this.updateUI(e);break;case"controlSearchUrl":this.config.controlSearchUrl=t;break;case"controlSearchSrs":this.config.controlSearchSrs=t;break;case"controlSearchFilter":this.config.controlSearchFilter=st.validateBool(t,!0);break;case"controlSearchElement":this.config.controlSearchElement=t,this.updateUI(e);break;case"controlSearchValue":this.config.controlSearchValue=t,this.updateUI(e);break;case"controlLink":this.config.controlLink=st.validateBool(t,!1),this.updateUI(e);break;case"controlGithub":this.config.controlGithub=st.validateBool(t,!1),this.updateUI(e);break;case"controlMeasure":this.config.controlMeasure=st.validateBool(t,!1),this.updateUI(e);break;case"controlMeasureLite":this.config.controlMeasureLite=st.validateBool(t,!1),this.updateUI(e);break;case"controlLogo":this.config.controlLogo=st.validateBool(t,!1),this.updateUI(e);break;case"controlFullscreen":this.config.controlFullscreen=st.validateBool(t,!0),this.updateUI(e);break;case"controlCredits":this.config.controlCredits=st.validateBool(t,!0),this.updateUI(e);break;case"controlLoading":this.config.controlLoading=st.validateBool(t,!0),this.updateUI(e);break;case"minViewExtent":this.config.minViewExtent=st.validateNumber(t,.01,Number.MAXINTEGER,100);break;case"maxViewExtent":this.config.maxViewExtent=st.validateNumber(t,.01,Number.MAXINTEGER,Number.MAXINTEGER);break;case"wheelInputLag":this.config.wheelInputLag=st.validateNumberArray(t,2,[0,0],[999,999],[70,1]);break;case"sensitivity":this.config.sensitivity=st.validateNumberArray(t,3,[0,0,0],[10,10,10],[1,.12,.05]);break;case"inertia":this.config.inertia=st.validateNumberArray(t,3,[0,0,0],[.99,.99,.99],[.85,.9,.7]);break;case"legacyInertia":this.config.legacyInertia=st.validateBool(t,!1);break;case"timeNormalizedInertia":this.config.timeNormalizedInertia=st.validateBool(t,!1);break;case"bigScreenMargins":this.config.bigScreenMargins=st.validateBool(t,!1);break;case"tiltConstrainThreshold":this.config.tiltConstrainThreshold=st.validateNumberArray(t,2,[.5,1],[-Number.MAXINTEGER,-Number.MAXINTEGER],[Number.MAXINTEGER,Number.MAXINTEGER]);break;case"walkMode":this.config.walkMode=st.validateBool(t,!1);break;case"fixedHeight":this.config.fixedHeight=st.validateNumber(t,-Number.MAXINTEGER,Number.MAXINTEGER,0);break;case"sync":this.config.sync=t;break;case"syncCursor":this.config.syncCursor=st.validateBool(t,!1);break;case"syncServer":this.config.syncServer=t;break;case"geodata":this.config.geodata=t;break;case"tiles3d":this.config.tiles3d=t;break;case"geojson":this.config.geojson=t;break;case"geojsonStyle":this.config.geojsonStyle=JSON.parse(t);break;case"rotate":this.config.autoRotate=st.validateNumber(t,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,0),r&&this.autopilot&&this.autopilot.setAutorotate(this.config.autoRotate);break;case"pan":Array.isArray(t)&&2==t.length&&(this.config.autoPan=[st.validateNumber(t[0],Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,0),st.validateNumber(t[1],-360,360,0)]),r&&this.autopilot&&this.autopilot.setAutorotate(this.config.autoRotate)}i&&(0!=e.indexOf("map")&&0!=e.indexOf("mario")&&0!=e.indexOf("authorization")||!r||r.setConfigParam(e,t),0==e.indexOf("renderer")&&this.getRenderer()&&this.getRenderer().setConfigParam(e,t),0==e.indexOf("debug")&&this.core&&this.core.setConfigParam(e,t))},ct.prototype.getConfigParam=function(e){var t=this.getMap();switch(e){case"pos":case"position":if(!t)return this.config.position;t.getPosition();break;case"view":return t?t.getView():this.config.view;case"panAllowed":return this.config.panAllowed;case"rotationAllowed":return this.config.rotationAllowed;case"zoomAllowed":return this.config.zoomAllowed;case"jumpAllowed":return this.config.jumpAllowed;case"sensitivity":return this.config.sensitivity;case"inertia":return this.config.inertia;case"legacyInertia":return this.config.legacyInertia;case"timeNormalizedInertia":return this.config.timeNormalizedInertia;case"bigScreenMargins":return this.config.bigScreenMargins;case"navigationMode":return this.config.navigationMode;case"constrainCamera":return this.config.constrainCamera;case"positionInUrl":return this.config.positionInUrl;case"positionUrlHistory":return this.config.positionUrlHistory;case"controlCompass":return this.config.controlCompass;case"controlZoom":return this.config.controlZoom;case"controlMeasure":return this.config.controlMeasure;case"controlScale":return this.config.controlScale;case"controlLayers":return this.config.controlLayers;case"controlSpace":return this.config.controlSpace;case"controlSearch":return this.config.controlSearch;case"controlLink":return this.config.controlLink;case"controlGithub":return this.config.controlGithub;case"controlMeasure":return this.config.controlMeasure;case"controlMeasureLite":return this.config.controlMeasureLite;case"controlLogo":return this.config.controlLogo;case"controlFullscreen":return this.config.controlFullscreen;case"controlCredits":return this.config.controlCredits;case"controlLoading":return this.config.controlLoading;case"controlSearchElement":return this.config.controlSearchElement;case"controlSearchValue":return this.config.controlSearchValue;case"controlSearchUrl":return this.config.controlSearchUrl;case"controlSearchSrs":return this.config.controlSearchSrs;case"controlSearchFilter":return this.config.controlSearchFilter;case"minViewExtent":return this.config.minViewExtent;case"maxViewExtent":return this.config.maxViewExtent;case"rotate":return this.config.autoRotate;case"pan":return this.config.autoPan}return 0==e.indexOf("map")&&t||0==e.indexOf("renderer")?t.getConfigParam(e):void 0};var dt=ct,pt=function(e,t){this.browser=new dt(e,t),this.core=this.browser.getCore(),this.killed=!1,Object.defineProperty(this,"map",{get:function(){if(!this.killed)return this.core.map}}),Object.defineProperty(this,"renderer",{get:function(){if(!this.killed)return this.core.renderer}}),Object.defineProperty(this,"autopilot",{get:function(){if(!this.killed)return this.browser.autopilot}}),Object.defineProperty(this,"presenter",{get:function(){if(!this.killed)return this.browser.presenter}}),Object.defineProperty(this,"ui",{get:function(){if(!this.killed)return this.browser.ui}})};pt.prototype.destroy=function(){if(!this.killed)return this.core.destroy(),this.browser.kill(),this.killed=!0,null},pt.prototype.setControlMode=function(e){if(!this.killed)return this.browser.setControlMode(e),this},pt.prototype.getControlMode=function(){if(!this.killed)return this.browser.getControlMode()},pt.prototype.loadMap=function(e){if(!this.killed)return this.core.loadMap(e),this},pt.prototype.destroyMap=function(){if(!this.killed)return this.core.destroyMap(),this.map=null,this},pt.prototype.on=function(e,t){if(!this.killed)return this.core.on(e,t)},pt.prototype.setParams=function(e){if(!this.killed)return this.setConfigParams(e,!0),this},pt.prototype.setParam=function(e,t){if(!this.killed)return this.browser.setConfigParam(e,t,!0),this},pt.prototype.getParam=function(e){if(!this.killed)return this.browser.getConfigParam(e)};var ft=pt,gt=n.c,mt=n.b,vt=o.c,yt=o.d,bt=o.e,xt=o.a,wt=o.b,Mt=h.a,St=m,At=l.a,Ct=ft,Tt=r.a,Pt=u.a;function Ft(e,t){var i=new Ct(e,t);return i.core?i:null}function Lt(){return""+gt()}}]);
//# sourceMappingURL=vts-browser.min.js.map